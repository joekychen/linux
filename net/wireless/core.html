<!DOCTYPE html>
<html><head><title>joekychen/linux » net › wireless › core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is the linux wireless configuration interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006-2010		Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/nl80211.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;net/genetlink.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &quot;nl80211.h&quot;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;sysfs.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;wext-compat.h&quot;</span>
<span class="cp">#include &quot;ethtool.h&quot;</span>

<span class="cm">/* name for sysfs, %d is appended */</span>
<span class="cp">#define PHY_NAME &quot;phy&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Johannes Berg&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;wireless configuration support&quot;</span><span class="p">);</span>

<span class="cm">/* RCU-protected (and cfg80211_mutex for writers) */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cfg80211_rdev_list</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">cfg80211_rdev_list_generation</span><span class="p">;</span>

<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

<span class="cm">/* for debugfs */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ieee80211_debugfs_dir</span><span class="p">;</span>

<span class="cm">/* for the cleanup, scan and event works */</span>
<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">cfg80211_wq</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">cfg80211_disable_40mhz_24ghz</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cfg80211_disable_40mhz_24ghz</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cfg80211_disable_40mhz_24ghz</span><span class="p">,</span>
		 <span class="s">&quot;Disable 40MHz support in the 2.4GHz band&quot;</span><span class="p">);</span>

<span class="cm">/* requires cfg80211_mutex to be held! */</span>
<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="nf">cfg80211_rdev_by_wiphy_idx</span><span class="p">(</span><span class="kt">int</span> <span class="n">wiphy_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy_idx_valid</span><span class="p">(</span><span class="n">wiphy_idx</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">assert_cfg80211_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg80211_rdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span> <span class="o">==</span> <span class="n">wiphy_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_wiphy_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">WIPHY_IDX_STALE</span><span class="p">;</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* requires cfg80211_rdev_mutex to be held! */</span>
<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="nf">wiphy_idx_to_wiphy</span><span class="p">(</span><span class="kt">int</span> <span class="n">wiphy_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy_idx_valid</span><span class="p">(</span><span class="n">wiphy_idx</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">assert_cfg80211_lock</span><span class="p">();</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">cfg80211_rdev_by_wiphy_idx</span><span class="p">(</span><span class="n">wiphy_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* requires cfg80211_mutex to be held! */</span>
<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span>
<span class="nf">__cfg80211_rdev_from_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">bywiphyidx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">byifidx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">assert_cfg80211_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bywiphyidx</span> <span class="o">=</span> <span class="n">cfg80211_rdev_by_wiphy_idx</span><span class="p">(</span>
				<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY</span><span class="p">]));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ifindex</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">]);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">ifindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">)</span>
				<span class="n">byifidx</span> <span class="o">=</span>
					<span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bywiphyidx</span> <span class="o">&amp;&amp;</span> <span class="n">byifidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bywiphyidx</span> <span class="o">!=</span> <span class="n">byifidx</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">bywiphyidx</span><span class="p">;</span> <span class="cm">/* == byifidx */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bywiphyidx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bywiphyidx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">byifidx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">byifidx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span>
<span class="nf">cfg80211_get_dev_from_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">__cfg80211_rdev_from_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* if it is not an error we grab the lock on</span>
<span class="cm">	 * it to assure it won&#39;t be going away while</span>
<span class="cm">	 * we operate on it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span>
<span class="nf">cfg80211_get_dev_from_ifindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* requires cfg80211_mutex to be held */</span>
<span class="kt">int</span> <span class="nf">cfg80211_dev_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">newname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wiphy_idx</span><span class="p">,</span> <span class="n">taken</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">digits</span><span class="p">;</span>

	<span class="n">assert_cfg80211_lock</span><span class="p">();</span>

	<span class="cm">/* prohibit calling the thing phy%d when %d is not its number */</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">PHY_NAME</span> <span class="s">&quot;%d%n&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wiphy_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">taken</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">taken</span> <span class="o">==</span> <span class="n">strlen</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wiphy_idx</span> <span class="o">!=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* count number of places needed to print wiphy_idx */</span>
		<span class="n">digits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">wiphy_idx</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">digits</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * deny the name if it is phy&lt;idx&gt; where &lt;idx&gt; is printed</span>
<span class="cm">		 * without leading zeroes. taken == strlen(newname) here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">taken</span> <span class="o">==</span> <span class="n">strlen</span><span class="p">(</span><span class="n">PHY_NAME</span><span class="p">)</span> <span class="o">+</span> <span class="n">digits</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Ignore nop renames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Ensure another device does not already have this name. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg80211_rdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">device_rename</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">newname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">debugfs_rename</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">,</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span><span class="p">,</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">,</span>
			    <span class="n">newname</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to rename debugfs dir to %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newname</span><span class="p">);</span>

	<span class="n">nl80211_notify_dev_rename</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cfg80211_switch_netns</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_NETNS_OK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_NETNS_LOCAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dev_change_net_namespace</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_NETNS_LOCAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* failed -- clean up to old netns */</span>
		<span class="n">net</span> <span class="o">=</span> <span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

		<span class="n">list_for_each_entry_continue_reverse</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">,</span>
						     <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_NETNS_LOCAL</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dev_change_net_namespace</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span>
							<span class="s">&quot;wlan%d&quot;</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
			<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_NETNS_LOCAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wiphy_net_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_rename</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cfg80211_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">rfkill_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfg80211_rfkill_set_block</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">dev_close</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cfg80211_rfkill_sync_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_registered_device</span><span class="p">,</span> <span class="n">rfkill_sync</span><span class="p">);</span>
	<span class="n">cfg80211_rfkill_set_block</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rfkill_blocked</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cfg80211_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_registered_device</span><span class="p">,</span>
			    <span class="n">event_work</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">cfg80211_lock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">cfg80211_process_rdev_events</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* exported functions */</span>

<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="nf">wiphy_new</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cfg80211_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sizeof_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">wiphy_counter</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alloc_size</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_key</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_key</span> <span class="o">||</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_default_key</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">auth</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">||</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">deauth</span> <span class="o">||</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disassoc</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">join_ibss</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">leave_ibss</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_virtual_intf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_virtual_intf</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_station</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_station</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_mpath</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_mpath</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">join_mesh</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">leave_mesh</span><span class="p">);</span>

	<span class="n">alloc_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_priv</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span> <span class="o">=</span> <span class="n">wiphy_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">wiphy_idx_valid</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">wiphy_counter</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
		<span class="cm">/* ugh, wrapped! */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="cm">/* give it a proper name */</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">PHY_NAME</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_done_wk</span><span class="p">,</span> <span class="n">__cfg80211_scan_done</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_results_wk</span><span class="p">,</span> <span class="n">__cfg80211_sched_scan_results</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg80211_wext_handler</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee80211_class</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CFG80211_DEFAULT_PS</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_PS_ON_BY_DEFAULT</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">wiphy_net_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill_ops</span><span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">cfg80211_rfkill_set_block</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill_ops</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill_sync</span><span class="p">,</span> <span class="n">cfg80211_rfkill_sync_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">conn_work</span><span class="p">,</span> <span class="n">cfg80211_conn_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="n">cfg80211_event_work</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize wiphy parameters to IEEE 802.11 MIB default values.</span>
<span class="cm">	 * Fragmentation and RTS threshold are disabled by default with the</span>
<span class="cm">	 * special -1 value.</span>
<span class="cm">	 */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_short</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_long</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">coverage_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_new</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wiphy_verify_combinations</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_iface_combination</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_iface_combinations</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">all_iftypes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">iface_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Combinations with just one interface aren&#39;t real */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max_interfaces</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Need at least one channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">num_different_channels</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">n_limits</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">n_limits</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">types</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">types</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * interface types shouldn&#39;t overlap, this is</span>
<span class="cm">			 * used in cfg80211_can_change_interface()</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">types</span> <span class="o">&amp;</span> <span class="n">all_iftypes</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">all_iftypes</span> <span class="o">|=</span> <span class="n">types</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="cm">/* Shouldn&#39;t list software iftypes in combinations! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">software_iftypes</span> <span class="o">&amp;</span> <span class="n">types</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t advertise an unsupported type</span>
<span class="cm">			 * in a combination.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">((</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">&amp;</span> <span class="n">types</span><span class="p">)</span> <span class="o">!=</span> <span class="n">types</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* You can&#39;t even choose that many! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_interfaces</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wiphy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">have_band</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ifmodes</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">((</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_GTK_REKEY_FAILURE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_SUPPORTS_GTK_REKEY</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">ap_sme_capa</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_HAVE_AP_SME</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">addresses</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_addresses</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">addresses</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
			   <span class="n">ETH_ALEN</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* sanity check ifmodes */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ifmodes</span><span class="p">);</span>
	<span class="n">ifmodes</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NUM_NL80211_IFTYPES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">ifmodes</span> <span class="o">!=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span><span class="p">))</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">ifmodes</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">wiphy_verify_combinations</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* sanity check supported bands/channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">||</span> <span class="o">!</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Since cfg80211_disable_40mhz_24ghz is global, we can</span>
<span class="cm">		 * modify the sband&#39;s ht data even if the driver uses a</span>
<span class="cm">		 * global structure for that.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg80211_disable_40mhz_24ghz</span> <span class="o">&amp;&amp;</span>
		    <span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">;</span>
			<span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Since we use a u32 for rate bitmaps in</span>
<span class="cm">		 * ieee80211_get_response_rate, we cannot</span>
<span class="cm">		 * have more than 32 legacy rates.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">orig_flags</span> <span class="o">=</span>
				<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">orig_mag</span> <span class="o">=</span>
				<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_antenna_gain</span><span class="p">;</span>
			<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">orig_mpwr</span> <span class="o">=</span>
				<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span><span class="p">;</span>
			<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">have_band</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_band</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_min_len</span> <span class="o">||</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_min_len</span> <span class="o">&gt;</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_max_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check and set up bitrates */</span>
	<span class="n">ieee80211_set_bitrate_flags</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up regulatory info */</span>
	<span class="n">regulatory_update</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">NL80211_REGDOM_SET_BY_CORE</span><span class="p">);</span>

	<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg80211_rdev_list</span><span class="p">);</span>
	<span class="n">cfg80211_rdev_list_generation</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* add to debugfs */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span> <span class="o">=</span>
		<span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">wiphy_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
				   <span class="n">ieee80211_debugfs_dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span><span class="p">))</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_CUSTOM_REGULATORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">regulatory_request</span> <span class="n">request</span><span class="p">;</span>

		<span class="n">request</span><span class="p">.</span><span class="n">wiphy_idx</span> <span class="o">=</span> <span class="n">get_wiphy_idx</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
		<span class="n">request</span><span class="p">.</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">NL80211_REGDOM_SET_BY_DRIVER</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span>

		<span class="n">nl80211_send_reg_change_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cfg80211_debugfs_rdev_add</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * due to a locking dependency this has to be outside of the</span>
<span class="cm">	 * cfg80211_mutex lock</span>
<span class="cm">	 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rm_dev</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_rm_dev:</span>
	<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">wiphy_rfkill_start_polling</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">rfkill_poll</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill_ops</span><span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">cfg80211_rfkill_poll</span><span class="p">;</span>
	<span class="n">rfkill_resume_polling</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_rfkill_start_polling</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">wiphy_rfkill_stop_polling</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">rfkill_pause_polling</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_rfkill_stop_polling</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">wiphy_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>

	<span class="cm">/* protect the device list */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev_wait</span><span class="p">,</span> <span class="p">({</span>
		<span class="kt">int</span> <span class="n">__count</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="n">__count</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">opencount</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="n">__count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First remove the hardware from everywhere, this makes</span>
<span class="cm">	 * it impossible to find from userspace.</span>
<span class="cm">	 */</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">debugfsdir</span><span class="p">);</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to grab rdev-&gt;mtx. If a command is still in progress,</span>
<span class="cm">	 * hopefully the driver will refuse it since it&#39;s tearing</span>
<span class="cm">	 * down the device already. We wait for this command to complete</span>
<span class="cm">	 * before unlinking the item from the list.</span>
<span class="cm">	 * Note: as codified by the BUG_ON above we cannot get here if</span>
<span class="cm">	 * a virtual interface is still present. Hence, we can only get</span>
<span class="cm">	 * to lock contention here if userspace issues a command that</span>
<span class="cm">	 * identified the hardware by wiphy index.</span>
<span class="cm">	 */</span>
	<span class="n">cfg80211_lock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="cm">/* nothing */</span>
	<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="cm">/* If this device got a regulatory hint tell core its</span>
<span class="cm">	 * free to listen now to a new shiny device regulatory hint */</span>
	<span class="n">reg_device_remove</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">cfg80211_rdev_list_generation</span><span class="o">++</span><span class="p">;</span>
	<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_done_wk</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">conn_work</span><span class="p">);</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wakeup</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">cfg80211_rdev_free_wowlan</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_unregister</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cfg80211_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_internal_bss</span> <span class="o">*</span><span class="n">scan</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wiphy_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_free</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">,</span> <span class="n">blocked</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill_sync</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_rfkill_set_hw_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wdev_cleanup_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wireless_dev</span><span class="p">,</span> <span class="n">cleanup_work</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">cfg80211_lock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">aborted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">___cfg80211_scan_done</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_req</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_req</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__cfg80211_stop_sched_scan</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">opencount</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev_wait</span><span class="p">);</span>

	<span class="n">dev_put</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">wiphy_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfg80211_netdev_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">state</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_POST_INIT</span>:
		<span class="n">SET_NETDEV_DEVTYPE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wiphy_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_REGISTER</span>:
		<span class="cm">/*</span>
<span class="cm">		 * NB: cannot take rdev-&gt;mtx here because this may be</span>
<span class="cm">		 * called within code protected by it when interfaces</span>
<span class="cm">		 * are added with nl80211.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">cleanup_work</span><span class="p">,</span> <span class="n">wdev_cleanup_work</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mgmt_registrations</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mgmt_registrations_lock</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_generation</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* can only change netns with wiphy */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_NETNS_LOCAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				      <span class="s">&quot;phy80211&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to add phy80211 symlink to netdev!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">=</span> <span class="n">CFG80211_SME_IDLE</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_key</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_mgmt_key</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">connect</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_PS_ON_BY_DEFAULT</span><span class="p">)</span>
			<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* allow mac80211 to determine the timeout */</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps_timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg80211_ethtool_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">||</span>
		     <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span> <span class="o">||</span>
		     <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">use_4addr</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_DONT_BRIDGE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_GOING_DOWN</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
			<span class="n">cfg80211_leave_ibss</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>
			<span class="n">__cfg80211_stop_sched_scan</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>

			<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">ie</span><span class="p">);</span>
			<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">connect</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">__cfg80211_disconnect</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					      <span class="n">WLAN_REASON_DEAUTH_LEAVING</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">cfg80211_mlme_down</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
			<span class="n">cfg80211_leave_mesh</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">dev_hold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">cfg80211_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">cleanup_work</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If we have a really quick DOWN/UP succession we may</span>
<span class="cm">		 * have this work still pending ... cancel it and see</span>
<span class="cm">		 * if it was pending, in which case we need to account</span>
<span class="cm">		 * for some of the work it would have done.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">cleanup_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">opencount</span><span class="o">--</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cfg80211_lock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
			<span class="n">cfg80211_ibss_wext_join</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
			<span class="n">cfg80211_mgd_wext_connect</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
			<span class="p">{</span>
				<span class="cm">/* backward compat code... */</span>
				<span class="k">struct</span> <span class="n">mesh_setup</span> <span class="n">setup</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_mesh_setup</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">setup</span><span class="p">));</span>
				 <span class="cm">/* back compat only needed for mesh_id */</span>
				<span class="n">setup</span><span class="p">.</span><span class="n">mesh_id</span> <span class="o">=</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">;</span>
				<span class="n">setup</span><span class="p">.</span><span class="n">mesh_id_len</span> <span class="o">=</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_up_len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_up_len</span><span class="p">)</span>
					<span class="n">__cfg80211_join_mesh</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">default_mesh_config</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">opencount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Configure power management to the driver here so that its</span>
<span class="cm">		 * correctly set also after interface type changes etc.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">||</span>
		     <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_power_mgmt</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_power_mgmt</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						      <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span>
						      <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps_timeout</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* assume this means it&#39;s off */</span>
				<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_UNREGISTER</span>:
		<span class="cm">/*</span>
<span class="cm">		 * NB: cannot take rdev-&gt;mtx here because this may be</span>
<span class="cm">		 * called within code protected by it when interfaces</span>
<span class="cm">		 * are removed with nl80211.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * It is possible to get NETDEV_UNREGISTER</span>
<span class="cm">		 * multiple times. To detect that, check</span>
<span class="cm">		 * that the interface is still on the list</span>
<span class="cm">		 * of registered interfaces, and only then</span>
<span class="cm">		 * remove and clean it up.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;phy80211&quot;</span><span class="p">);</span>
			<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_generation</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cfg80211_mlme_purge_registrations</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">keys</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * synchronise (so that we won&#39;t find this netdev</span>
<span class="cm">		 * from other code any more) and then clear the list</span>
<span class="cm">		 * head so that the above code can safely check for</span>
<span class="cm">		 * !list_empty() to avoid double-cleanup.</span>
<span class="cm">		 */</span>
		<span class="n">synchronize_rcu</span><span class="p">();</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_PRE_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfkill_blocked</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="o">-</span><span class="n">ERFKILL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cfg80211_can_add_interface</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">cfg80211_netdev_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">cfg80211_netdev_notifier_call</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">cfg80211_pernet_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg80211_rdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_eq</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cfg80211_switch_netns</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">cfg80211_pernet_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">cfg80211_pernet_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cfg80211_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pernet_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_pernet_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail_pernet</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">wiphy_sysfs_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail_sysfs</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_netdev_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail_notifier</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail_nl80211</span><span class="p">;</span>

	<span class="n">ieee80211_debugfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;ieee80211&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">regulatory_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail_reg</span><span class="p">;</span>

	<span class="n">cfg80211_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;cfg80211&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg80211_wq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail_wq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_fail_wq:</span>
	<span class="n">regulatory_exit</span><span class="p">();</span>
<span class="nl">out_fail_reg:</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ieee80211_debugfs_dir</span><span class="p">);</span>
<span class="nl">out_fail_nl80211:</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_netdev_notifier</span><span class="p">);</span>
<span class="nl">out_fail_notifier:</span>
	<span class="n">wiphy_sysfs_exit</span><span class="p">();</span>
<span class="nl">out_fail_sysfs:</span>
	<span class="n">unregister_pernet_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_pernet_ops</span><span class="p">);</span>
<span class="nl">out_fail_pernet:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">cfg80211_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cfg80211_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ieee80211_debugfs_dir</span><span class="p">);</span>
	<span class="n">nl80211_exit</span><span class="p">();</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_netdev_notifier</span><span class="p">);</span>
	<span class="n">wiphy_sysfs_exit</span><span class="p">();</span>
	<span class="n">regulatory_exit</span><span class="p">();</span>
	<span class="n">unregister_pernet_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_pernet_ops</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">cfg80211_wq</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cfg80211_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
