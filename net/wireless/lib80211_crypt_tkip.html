<!DOCTYPE html>
<html><head><title>joekychen/linux » net › wireless › lib80211_crypt_tkip.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>lib80211_crypt_tkip.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * lib80211 crypt: host-based TKIP encryption implementation for lib80211</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003-2004, Jouni Malinen &lt;j@w1.fi&gt;</span>
<span class="cm"> * Copyright (c) 2008, John W. Linville &lt;linville@tuxdriver.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation. See README and COPYING for</span>
<span class="cm"> * more details.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;asm/string.h&gt;</span>

<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>

<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>

<span class="cp">#include &lt;net/lib80211.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jouni Malinen&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;lib80211 crypt: TKIP&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define TKIP_HDR_LEN 8</span>

<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="p">{</span>
<span class="cp">#define TKIP_KEY_LEN 32</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="n">TKIP_KEY_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">key_set</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">tx_iv32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_iv16</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_ttak</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tx_phase1_done</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">rx_iv32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_iv16</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_ttak</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rx_phase1_done</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_iv32_new</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_iv16_new</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">dot11RSNAStatsTKIPReplays</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dot11RSNAStatsTKIPICVErrors</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dot11RSNAStatsTKIPLocalMICFailures</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">key_idx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">crypto_blkcipher</span> <span class="o">*</span><span class="n">rx_tfm_arc4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">rx_tfm_michael</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_blkcipher</span> <span class="o">*</span><span class="n">tx_tfm_arc4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tx_tfm_michael</span><span class="p">;</span>

	<span class="cm">/* scratch buffers for virt_to_page() (crypto API) */</span>
	<span class="n">u8</span> <span class="n">rx_hdr</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">tx_hdr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">lib80211_tkip_set_flags</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_flags</span> <span class="o">=</span> <span class="n">_priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">old_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">lib80211_tkip_get_flags</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">lib80211_tkip_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">key_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">key_idx</span> <span class="o">=</span> <span class="n">key_idx</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span> <span class="o">=</span> <span class="n">crypto_alloc_blkcipher</span><span class="p">(</span><span class="s">&quot;ecb(arc4)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="s">&quot;michael_mic&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span> <span class="o">=</span> <span class="n">crypto_alloc_blkcipher</span><span class="p">(</span><span class="s">&quot;ecb(arc4)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="s">&quot;michael_mic&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>

      <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span><span class="p">)</span>
			<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span><span class="p">)</span>
			<span class="n">crypto_free_blkcipher</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span><span class="p">)</span>
			<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span><span class="p">)</span>
			<span class="n">crypto_free_blkcipher</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lib80211_tkip_deinit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span><span class="p">)</span>
			<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span><span class="p">)</span>
			<span class="n">crypto_free_blkcipher</span><span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span><span class="p">)</span>
			<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span><span class="p">)</span>
			<span class="n">crypto_free_blkcipher</span><span class="p">(</span><span class="n">_priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">RotR1</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">Lo8</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">Hi8</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">Lo16</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">Hi16</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">Mk16</span><span class="p">(</span><span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lo</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u16</span><span class="p">)</span> <span class="n">hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">Mk16_le</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">Sbox</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xC6A5</span><span class="p">,</span> <span class="mh">0xF884</span><span class="p">,</span> <span class="mh">0xEE99</span><span class="p">,</span> <span class="mh">0xF68D</span><span class="p">,</span> <span class="mh">0xFF0D</span><span class="p">,</span> <span class="mh">0xD6BD</span><span class="p">,</span> <span class="mh">0xDEB1</span><span class="p">,</span> <span class="mh">0x9154</span><span class="p">,</span>
	<span class="mh">0x6050</span><span class="p">,</span> <span class="mh">0x0203</span><span class="p">,</span> <span class="mh">0xCEA9</span><span class="p">,</span> <span class="mh">0x567D</span><span class="p">,</span> <span class="mh">0xE719</span><span class="p">,</span> <span class="mh">0xB562</span><span class="p">,</span> <span class="mh">0x4DE6</span><span class="p">,</span> <span class="mh">0xEC9A</span><span class="p">,</span>
	<span class="mh">0x8F45</span><span class="p">,</span> <span class="mh">0x1F9D</span><span class="p">,</span> <span class="mh">0x8940</span><span class="p">,</span> <span class="mh">0xFA87</span><span class="p">,</span> <span class="mh">0xEF15</span><span class="p">,</span> <span class="mh">0xB2EB</span><span class="p">,</span> <span class="mh">0x8EC9</span><span class="p">,</span> <span class="mh">0xFB0B</span><span class="p">,</span>
	<span class="mh">0x41EC</span><span class="p">,</span> <span class="mh">0xB367</span><span class="p">,</span> <span class="mh">0x5FFD</span><span class="p">,</span> <span class="mh">0x45EA</span><span class="p">,</span> <span class="mh">0x23BF</span><span class="p">,</span> <span class="mh">0x53F7</span><span class="p">,</span> <span class="mh">0xE496</span><span class="p">,</span> <span class="mh">0x9B5B</span><span class="p">,</span>
	<span class="mh">0x75C2</span><span class="p">,</span> <span class="mh">0xE11C</span><span class="p">,</span> <span class="mh">0x3DAE</span><span class="p">,</span> <span class="mh">0x4C6A</span><span class="p">,</span> <span class="mh">0x6C5A</span><span class="p">,</span> <span class="mh">0x7E41</span><span class="p">,</span> <span class="mh">0xF502</span><span class="p">,</span> <span class="mh">0x834F</span><span class="p">,</span>
	<span class="mh">0x685C</span><span class="p">,</span> <span class="mh">0x51F4</span><span class="p">,</span> <span class="mh">0xD134</span><span class="p">,</span> <span class="mh">0xF908</span><span class="p">,</span> <span class="mh">0xE293</span><span class="p">,</span> <span class="mh">0xAB73</span><span class="p">,</span> <span class="mh">0x6253</span><span class="p">,</span> <span class="mh">0x2A3F</span><span class="p">,</span>
	<span class="mh">0x080C</span><span class="p">,</span> <span class="mh">0x9552</span><span class="p">,</span> <span class="mh">0x4665</span><span class="p">,</span> <span class="mh">0x9D5E</span><span class="p">,</span> <span class="mh">0x3028</span><span class="p">,</span> <span class="mh">0x37A1</span><span class="p">,</span> <span class="mh">0x0A0F</span><span class="p">,</span> <span class="mh">0x2FB5</span><span class="p">,</span>
	<span class="mh">0x0E09</span><span class="p">,</span> <span class="mh">0x2436</span><span class="p">,</span> <span class="mh">0x1B9B</span><span class="p">,</span> <span class="mh">0xDF3D</span><span class="p">,</span> <span class="mh">0xCD26</span><span class="p">,</span> <span class="mh">0x4E69</span><span class="p">,</span> <span class="mh">0x7FCD</span><span class="p">,</span> <span class="mh">0xEA9F</span><span class="p">,</span>
	<span class="mh">0x121B</span><span class="p">,</span> <span class="mh">0x1D9E</span><span class="p">,</span> <span class="mh">0x5874</span><span class="p">,</span> <span class="mh">0x342E</span><span class="p">,</span> <span class="mh">0x362D</span><span class="p">,</span> <span class="mh">0xDCB2</span><span class="p">,</span> <span class="mh">0xB4EE</span><span class="p">,</span> <span class="mh">0x5BFB</span><span class="p">,</span>
	<span class="mh">0xA4F6</span><span class="p">,</span> <span class="mh">0x764D</span><span class="p">,</span> <span class="mh">0xB761</span><span class="p">,</span> <span class="mh">0x7DCE</span><span class="p">,</span> <span class="mh">0x527B</span><span class="p">,</span> <span class="mh">0xDD3E</span><span class="p">,</span> <span class="mh">0x5E71</span><span class="p">,</span> <span class="mh">0x1397</span><span class="p">,</span>
	<span class="mh">0xA6F5</span><span class="p">,</span> <span class="mh">0xB968</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xC12C</span><span class="p">,</span> <span class="mh">0x4060</span><span class="p">,</span> <span class="mh">0xE31F</span><span class="p">,</span> <span class="mh">0x79C8</span><span class="p">,</span> <span class="mh">0xB6ED</span><span class="p">,</span>
	<span class="mh">0xD4BE</span><span class="p">,</span> <span class="mh">0x8D46</span><span class="p">,</span> <span class="mh">0x67D9</span><span class="p">,</span> <span class="mh">0x724B</span><span class="p">,</span> <span class="mh">0x94DE</span><span class="p">,</span> <span class="mh">0x98D4</span><span class="p">,</span> <span class="mh">0xB0E8</span><span class="p">,</span> <span class="mh">0x854A</span><span class="p">,</span>
	<span class="mh">0xBB6B</span><span class="p">,</span> <span class="mh">0xC52A</span><span class="p">,</span> <span class="mh">0x4FE5</span><span class="p">,</span> <span class="mh">0xED16</span><span class="p">,</span> <span class="mh">0x86C5</span><span class="p">,</span> <span class="mh">0x9AD7</span><span class="p">,</span> <span class="mh">0x6655</span><span class="p">,</span> <span class="mh">0x1194</span><span class="p">,</span>
	<span class="mh">0x8ACF</span><span class="p">,</span> <span class="mh">0xE910</span><span class="p">,</span> <span class="mh">0x0406</span><span class="p">,</span> <span class="mh">0xFE81</span><span class="p">,</span> <span class="mh">0xA0F0</span><span class="p">,</span> <span class="mh">0x7844</span><span class="p">,</span> <span class="mh">0x25BA</span><span class="p">,</span> <span class="mh">0x4BE3</span><span class="p">,</span>
	<span class="mh">0xA2F3</span><span class="p">,</span> <span class="mh">0x5DFE</span><span class="p">,</span> <span class="mh">0x80C0</span><span class="p">,</span> <span class="mh">0x058A</span><span class="p">,</span> <span class="mh">0x3FAD</span><span class="p">,</span> <span class="mh">0x21BC</span><span class="p">,</span> <span class="mh">0x7048</span><span class="p">,</span> <span class="mh">0xF104</span><span class="p">,</span>
	<span class="mh">0x63DF</span><span class="p">,</span> <span class="mh">0x77C1</span><span class="p">,</span> <span class="mh">0xAF75</span><span class="p">,</span> <span class="mh">0x4263</span><span class="p">,</span> <span class="mh">0x2030</span><span class="p">,</span> <span class="mh">0xE51A</span><span class="p">,</span> <span class="mh">0xFD0E</span><span class="p">,</span> <span class="mh">0xBF6D</span><span class="p">,</span>
	<span class="mh">0x814C</span><span class="p">,</span> <span class="mh">0x1814</span><span class="p">,</span> <span class="mh">0x2635</span><span class="p">,</span> <span class="mh">0xC32F</span><span class="p">,</span> <span class="mh">0xBEE1</span><span class="p">,</span> <span class="mh">0x35A2</span><span class="p">,</span> <span class="mh">0x88CC</span><span class="p">,</span> <span class="mh">0x2E39</span><span class="p">,</span>
	<span class="mh">0x9357</span><span class="p">,</span> <span class="mh">0x55F2</span><span class="p">,</span> <span class="mh">0xFC82</span><span class="p">,</span> <span class="mh">0x7A47</span><span class="p">,</span> <span class="mh">0xC8AC</span><span class="p">,</span> <span class="mh">0xBAE7</span><span class="p">,</span> <span class="mh">0x322B</span><span class="p">,</span> <span class="mh">0xE695</span><span class="p">,</span>
	<span class="mh">0xC0A0</span><span class="p">,</span> <span class="mh">0x1998</span><span class="p">,</span> <span class="mh">0x9ED1</span><span class="p">,</span> <span class="mh">0xA37F</span><span class="p">,</span> <span class="mh">0x4466</span><span class="p">,</span> <span class="mh">0x547E</span><span class="p">,</span> <span class="mh">0x3BAB</span><span class="p">,</span> <span class="mh">0x0B83</span><span class="p">,</span>
	<span class="mh">0x8CCA</span><span class="p">,</span> <span class="mh">0xC729</span><span class="p">,</span> <span class="mh">0x6BD3</span><span class="p">,</span> <span class="mh">0x283C</span><span class="p">,</span> <span class="mh">0xA779</span><span class="p">,</span> <span class="mh">0xBCE2</span><span class="p">,</span> <span class="mh">0x161D</span><span class="p">,</span> <span class="mh">0xAD76</span><span class="p">,</span>
	<span class="mh">0xDB3B</span><span class="p">,</span> <span class="mh">0x6456</span><span class="p">,</span> <span class="mh">0x744E</span><span class="p">,</span> <span class="mh">0x141E</span><span class="p">,</span> <span class="mh">0x92DB</span><span class="p">,</span> <span class="mh">0x0C0A</span><span class="p">,</span> <span class="mh">0x486C</span><span class="p">,</span> <span class="mh">0xB8E4</span><span class="p">,</span>
	<span class="mh">0x9F5D</span><span class="p">,</span> <span class="mh">0xBD6E</span><span class="p">,</span> <span class="mh">0x43EF</span><span class="p">,</span> <span class="mh">0xC4A6</span><span class="p">,</span> <span class="mh">0x39A8</span><span class="p">,</span> <span class="mh">0x31A4</span><span class="p">,</span> <span class="mh">0xD337</span><span class="p">,</span> <span class="mh">0xF28B</span><span class="p">,</span>
	<span class="mh">0xD532</span><span class="p">,</span> <span class="mh">0x8B43</span><span class="p">,</span> <span class="mh">0x6E59</span><span class="p">,</span> <span class="mh">0xDAB7</span><span class="p">,</span> <span class="mh">0x018C</span><span class="p">,</span> <span class="mh">0xB164</span><span class="p">,</span> <span class="mh">0x9CD2</span><span class="p">,</span> <span class="mh">0x49E0</span><span class="p">,</span>
	<span class="mh">0xD8B4</span><span class="p">,</span> <span class="mh">0xACFA</span><span class="p">,</span> <span class="mh">0xF307</span><span class="p">,</span> <span class="mh">0xCF25</span><span class="p">,</span> <span class="mh">0xCAAF</span><span class="p">,</span> <span class="mh">0xF48E</span><span class="p">,</span> <span class="mh">0x47E9</span><span class="p">,</span> <span class="mh">0x1018</span><span class="p">,</span>
	<span class="mh">0x6FD5</span><span class="p">,</span> <span class="mh">0xF088</span><span class="p">,</span> <span class="mh">0x4A6F</span><span class="p">,</span> <span class="mh">0x5C72</span><span class="p">,</span> <span class="mh">0x3824</span><span class="p">,</span> <span class="mh">0x57F1</span><span class="p">,</span> <span class="mh">0x73C7</span><span class="p">,</span> <span class="mh">0x9751</span><span class="p">,</span>
	<span class="mh">0xCB23</span><span class="p">,</span> <span class="mh">0xA17C</span><span class="p">,</span> <span class="mh">0xE89C</span><span class="p">,</span> <span class="mh">0x3E21</span><span class="p">,</span> <span class="mh">0x96DD</span><span class="p">,</span> <span class="mh">0x61DC</span><span class="p">,</span> <span class="mh">0x0D86</span><span class="p">,</span> <span class="mh">0x0F85</span><span class="p">,</span>
	<span class="mh">0xE090</span><span class="p">,</span> <span class="mh">0x7C42</span><span class="p">,</span> <span class="mh">0x71C4</span><span class="p">,</span> <span class="mh">0xCCAA</span><span class="p">,</span> <span class="mh">0x90D8</span><span class="p">,</span> <span class="mh">0x0605</span><span class="p">,</span> <span class="mh">0xF701</span><span class="p">,</span> <span class="mh">0x1C12</span><span class="p">,</span>
	<span class="mh">0xC2A3</span><span class="p">,</span> <span class="mh">0x6A5F</span><span class="p">,</span> <span class="mh">0xAEF9</span><span class="p">,</span> <span class="mh">0x69D0</span><span class="p">,</span> <span class="mh">0x1791</span><span class="p">,</span> <span class="mh">0x9958</span><span class="p">,</span> <span class="mh">0x3A27</span><span class="p">,</span> <span class="mh">0x27B9</span><span class="p">,</span>
	<span class="mh">0xD938</span><span class="p">,</span> <span class="mh">0xEB13</span><span class="p">,</span> <span class="mh">0x2BB3</span><span class="p">,</span> <span class="mh">0x2233</span><span class="p">,</span> <span class="mh">0xD2BB</span><span class="p">,</span> <span class="mh">0xA970</span><span class="p">,</span> <span class="mh">0x0789</span><span class="p">,</span> <span class="mh">0x33A7</span><span class="p">,</span>
	<span class="mh">0x2DB6</span><span class="p">,</span> <span class="mh">0x3C22</span><span class="p">,</span> <span class="mh">0x1592</span><span class="p">,</span> <span class="mh">0xC920</span><span class="p">,</span> <span class="mh">0x8749</span><span class="p">,</span> <span class="mh">0xAAFF</span><span class="p">,</span> <span class="mh">0x5078</span><span class="p">,</span> <span class="mh">0xA57A</span><span class="p">,</span>
	<span class="mh">0x038F</span><span class="p">,</span> <span class="mh">0x59F8</span><span class="p">,</span> <span class="mh">0x0980</span><span class="p">,</span> <span class="mh">0x1A17</span><span class="p">,</span> <span class="mh">0x65DA</span><span class="p">,</span> <span class="mh">0xD731</span><span class="p">,</span> <span class="mh">0x84C6</span><span class="p">,</span> <span class="mh">0xD0B8</span><span class="p">,</span>
	<span class="mh">0x82C3</span><span class="p">,</span> <span class="mh">0x29B0</span><span class="p">,</span> <span class="mh">0x5A77</span><span class="p">,</span> <span class="mh">0x1E11</span><span class="p">,</span> <span class="mh">0x7BCB</span><span class="p">,</span> <span class="mh">0xA8FC</span><span class="p">,</span> <span class="mh">0x6DD6</span><span class="p">,</span> <span class="mh">0x2C3A</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">_S_</span><span class="p">(</span><span class="n">u16</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Sbox</span><span class="p">[</span><span class="n">Hi8</span><span class="p">(</span><span class="n">v</span><span class="p">)];</span>
	<span class="k">return</span> <span class="n">Sbox</span><span class="p">[</span><span class="n">Lo8</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">^</span> <span class="p">((</span><span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define PHASE1_LOOP_COUNT 8</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tkip_mixing_phase1</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span> <span class="n">TTAK</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">TK</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">TA</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">IV32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Initialize the 80-bit TTAK from TSC (IV32) and TA[0..5] */</span>
	<span class="n">TTAK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lo16</span><span class="p">(</span><span class="n">IV32</span><span class="p">);</span>
	<span class="n">TTAK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hi16</span><span class="p">(</span><span class="n">IV32</span><span class="p">);</span>
	<span class="n">TTAK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TA</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">TTAK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TA</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">TA</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">TTAK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TA</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">TA</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHASE1_LOOP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">TTAK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">TTAK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TK</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">TK</span><span class="p">[</span><span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">]));</span>
		<span class="n">TTAK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">TTAK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TK</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">TK</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">]));</span>
		<span class="n">TTAK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">TTAK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TK</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">TK</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">]));</span>
		<span class="n">TTAK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">TTAK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TK</span><span class="p">[</span><span class="mi">13</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">TK</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">j</span><span class="p">]));</span>
		<span class="n">TTAK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">TTAK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">TK</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">TK</span><span class="p">[</span><span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">]))</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tkip_mixing_phase2</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span> <span class="n">WEPSeed</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">TK</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">TTAK</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">IV16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make temporary area overlap WEP seed so that the final copy can be</span>
<span class="cm">	 * avoided on little endian hosts. */</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">PPK</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WEPSeed</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Step 1 - make copy of TTAK and bring in TSC */</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TTAK</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TTAK</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TTAK</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">TTAK</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">TTAK</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">TTAK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">IV16</span><span class="p">;</span>

	<span class="cm">/* Step 2 - 96-bit bijective mixing using S-box */</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">8</span><span class="p">]));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">10</span><span class="p">]));</span>

	<span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">12</span><span class="p">]));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">14</span><span class="p">]));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* Step 3 - bring in last of TK bits, assign 24-bit WEP IV value</span>
<span class="cm">	 * WEPSeed[0..2] is transmitted as WEP IV */</span>
	<span class="n">WEPSeed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hi8</span><span class="p">(</span><span class="n">IV16</span><span class="p">);</span>
	<span class="n">WEPSeed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Hi8</span><span class="p">(</span><span class="n">IV16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">WEPSeed</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lo8</span><span class="p">(</span><span class="n">IV16</span><span class="p">);</span>
	<span class="n">WEPSeed</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lo8</span><span class="p">((</span><span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">Mk16_le</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TK</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">PPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lib80211_tkip_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span> <span class="n">rc4key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkey</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TKIP_HDR_LEN</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">hdr_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc4key</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">keylen</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_phase1_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tkip_mixing_phase1</span><span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_ttak</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
				   <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span><span class="p">);</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_phase1_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tkip_mixing_phase2</span><span class="p">(</span><span class="n">rc4key</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_ttak</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv16</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TKIP_HDR_LEN</span><span class="p">);</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">TKIP_HDR_LEN</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">hdr_len</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">rc4key</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">rc4key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">rc4key</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="cm">/* Ext IV included */</span> <span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv16</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_phase1_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TKIP_HDR_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lib80211_tkip_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkey</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkcipher_desc</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc4key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">icv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;TKIP countermeasures: dropped TX packet to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">hdr_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lib80211_tkip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">priv</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="o">~</span><span class="n">crc32_le</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">icv</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">crypto_blkcipher_setkey</span><span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">crypto_blkcipher_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deal with seq counter wrapping correctly.</span>
<span class="cm"> * refer to timer_after() for jiffies wrapping handling</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tkip_replay_check</span><span class="p">(</span><span class="n">u32</span> <span class="n">iv32_n</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iv16_n</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">iv32_o</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iv16_o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">iv32_n</span> <span class="o">-</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">iv32_o</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">iv32_n</span> <span class="o">==</span> <span class="n">iv32_o</span> <span class="o">&amp;&amp;</span> <span class="n">iv16_n</span> <span class="o">&lt;=</span> <span class="n">iv16_o</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lib80211_tkip_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkey</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkcipher_desc</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rc4key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">keyidx</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iv32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">iv16</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">icv</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;TKIP countermeasures: dropped received packet from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">hdr_len</span> <span class="o">+</span> <span class="n">TKIP_HDR_LEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">keyidx</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">keyidx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;TKIP: received packet without ExtIV flag from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">keyidx</span> <span class="o">&gt;&gt;=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_idx</span> <span class="o">!=</span> <span class="n">keyidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TKIP: RX tkey-&gt;key_idx=%d frame &quot;</span>
		       <span class="s">&quot;keyidx=%d priv=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;TKIP: received packet from %pM with keyid=%d that does not have a configured key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iv16</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">iv32</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">TKIP_HDR_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tkip_replay_check</span><span class="p">(</span><span class="n">iv32</span><span class="p">,</span> <span class="n">iv16</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv16</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_LIB80211_DEBUG</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;TKIP: replay detected: STA=%pM previous TSC %08x%04x received TSC %08x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv16</span><span class="p">,</span>
				    <span class="n">iv32</span><span class="p">,</span> <span class="n">iv16</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">dot11RSNAStatsTKIPReplays</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iv32</span> <span class="o">!=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32</span> <span class="o">||</span> <span class="o">!</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_phase1_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tkip_mixing_phase1</span><span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_ttak</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_phase1_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tkip_mixing_phase2</span><span class="p">(</span><span class="n">rc4key</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_ttak</span><span class="p">,</span> <span class="n">iv16</span><span class="p">);</span>

	<span class="n">plen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">crypto_blkcipher_setkey</span><span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">plen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypto_blkcipher_decrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">plen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;TKIP: failed to decrypt received packet from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="o">~</span><span class="n">crc32_le</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">icv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">icv</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">plen</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iv32</span> <span class="o">!=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Previously cached Phase1 result was already lost, so</span>
<span class="cm">			 * it needs to be recalculated for the next packet. */</span>
			<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_phase1_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_LIB80211_DEBUG</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;TKIP: ICV error detected: STA=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">dot11RSNAStatsTKIPICVErrors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update real counters only after Michael MIC verification has</span>
<span class="cm">	 * completed */</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32_new</span> <span class="o">=</span> <span class="n">iv32</span><span class="p">;</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv16_new</span> <span class="o">=</span> <span class="n">iv16</span><span class="p">;</span>

	<span class="cm">/* Remove IV and ICV */</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">TKIP_HDR_LEN</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TKIP_HDR_LEN</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">keyidx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">michael_mic</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tfm_michael</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">hdr</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">mic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_desc</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tfm_michael</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s(): tfm_michael == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">sg_set_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sg_set_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto_hash_setkey</span><span class="p">(</span><span class="n">tfm_michael</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">tfm_michael</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">crypto_hash_digest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">mic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">michael_mic_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr11</span><span class="p">;</span>

	<span class="n">hdr11</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* DA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* SA */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* DA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* SA */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* DA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* SA */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* DA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>	<span class="cm">/* SA */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr11</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr11</span><span class="p">)))</span>
			<span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hdr</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* priority */</span>

	<span class="n">hdr</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lib80211_michael_mic_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkey</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Invalid packet for Michael MIC add &quot;</span>
		       <span class="s">&quot;(tailroom=%d hdr_len=%d skb-&gt;len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">michael_mic_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_hdr</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">michael_mic</span><span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_hdr</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lib80211_michael_mic_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">keyidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_michaelmicfailure</span> <span class="n">ev</span><span class="p">;</span>

	<span class="cm">/* TODO: needed parameters: count, keyid, key type, TSC */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">keyidx</span> <span class="o">&amp;</span> <span class="n">IW_MICFAILURE_KEY_ID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_MICFAILURE_GROUP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_MICFAILURE_PAIRWISE</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">src_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">src_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVMICHAELMICFAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lib80211_michael_mic_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keyidx</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkey</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mic</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_set</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">michael_mic_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">michael_mic</span><span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_hdr</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">mic</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mic</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Michael MIC verification failed for &quot;</span>
		       <span class="s">&quot;MSDU from %pM keyidx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
		       <span class="n">keyidx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">lib80211_michael_mic_failure</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">);</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">dot11RSNAStatsTKIPLocalMICFailures</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update TSC counters for RX now that the packet verification has</span>
<span class="cm">	 * completed. */</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32_new</span><span class="p">;</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv16</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv16_new</span><span class="p">;</span>

	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lib80211_tkip_set_key</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkey</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyidx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_blkcipher</span> <span class="o">*</span><span class="n">tfm2</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tfm3</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_blkcipher</span> <span class="o">*</span><span class="n">tfm4</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span><span class="p">;</span>

	<span class="n">keyidx</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tkey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tkey</span><span class="p">));</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_idx</span> <span class="o">=</span> <span class="n">keyidx</span><span class="p">;</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_tfm_michael</span> <span class="o">=</span> <span class="n">tfm</span><span class="p">;</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_tfm_arc4</span> <span class="o">=</span> <span class="n">tfm2</span><span class="p">;</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_tfm_michael</span> <span class="o">=</span> <span class="n">tfm3</span><span class="p">;</span>
	<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_tfm_arc4</span> <span class="o">=</span> <span class="n">tfm4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">TKIP_KEY_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">TKIP_KEY_LEN</span><span class="p">);</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv16</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* TSC is initialized to 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv32</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">rx_iv16</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lib80211_tkip_get_key</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkey</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">TKIP_KEY_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key_set</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">TKIP_KEY_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Return the sequence number of the last transmitted frame. */</span>
		<span class="n">u16</span> <span class="n">iv16</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv16</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">iv32</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iv16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">iv32</span><span class="o">--</span><span class="p">;</span>
		<span class="n">iv16</span><span class="o">--</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv16</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TKIP_KEY_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">lib80211_tkip_print_stats</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_tkip_data</span> <span class="o">*</span><span class="n">tkip</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;key[%d] alg=TKIP key_set=%d &quot;</span>
		     <span class="s">&quot;tx_pn=%02x%02x%02x%02x%02x%02x &quot;</span>
		     <span class="s">&quot;rx_pn=%02x%02x%02x%02x%02x%02x &quot;</span>
		     <span class="s">&quot;replays=%d icv_errors=%d local_mic_failures=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">,</span> <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">key_set</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">tx_iv32</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">tx_iv16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">tx_iv16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_iv32</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_iv16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_iv16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">dot11RSNAStatsTKIPReplays</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">dot11RSNAStatsTKIPICVErrors</span><span class="p">,</span>
		     <span class="n">tkip</span><span class="o">-&gt;</span><span class="n">dot11RSNAStatsTKIPLocalMICFailures</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lib80211_crypto_ops</span> <span class="n">lib80211_crypt_tkip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TKIP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">lib80211_tkip_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deinit</span> <span class="o">=</span> <span class="n">lib80211_tkip_deinit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encrypt_mpdu</span> <span class="o">=</span> <span class="n">lib80211_tkip_encrypt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decrypt_mpdu</span> <span class="o">=</span> <span class="n">lib80211_tkip_decrypt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encrypt_msdu</span> <span class="o">=</span> <span class="n">lib80211_michael_mic_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decrypt_msdu</span> <span class="o">=</span> <span class="n">lib80211_michael_mic_verify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="n">lib80211_tkip_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">lib80211_tkip_get_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_stats</span> <span class="o">=</span> <span class="n">lib80211_tkip_print_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extra_mpdu_prefix_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* IV + ExtIV */</span>
	<span class="p">.</span><span class="n">extra_mpdu_postfix_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* ICV */</span>
	<span class="p">.</span><span class="n">extra_msdu_postfix_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/* MIC */</span>
	<span class="p">.</span><span class="n">get_flags</span> <span class="o">=</span> <span class="n">lib80211_tkip_get_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_flags</span> <span class="o">=</span> <span class="n">lib80211_tkip_set_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lib80211_crypto_tkip_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lib80211_register_crypto_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lib80211_crypt_tkip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">lib80211_crypto_tkip_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lib80211_unregister_crypto_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lib80211_crypt_tkip</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">lib80211_crypto_tkip_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">lib80211_crypto_tkip_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
