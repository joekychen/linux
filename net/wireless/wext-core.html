<!DOCTYPE html>
<html><head><title>joekychen/linux » net › wireless › wext-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>wext-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file implement the Wireless Extensions core API.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors :	Jean Tourrilhes - HPL - &lt;jt@hpl.hp.com&gt;</span>
<span class="cm"> * Copyright (c) 1997-2007 Jean Tourrilhes, All Rights Reserved.</span>
<span class="cm"> * Copyright	2009 Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * (As all part of the Linux kernel, this file is GPL)</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>
<span class="cp">#include &lt;net/netlink.h&gt;</span>
<span class="cp">#include &lt;net/wext.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">wext_ioctl_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="p">,</span>
			       <span class="n">iw_handler</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Meta-data about all the standard Wireless Extension request we</span>
<span class="cm"> * know about.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_ioctl_description</span> <span class="n">standard_ioctl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWCOMMIT</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_NULL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWNAME</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_CHAR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWNWID</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_EVENT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWNWID</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWFREQ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_FREQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_EVENT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWFREQ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_FREQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWMODE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_UINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_EVENT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWMODE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_UINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWSENS</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWSENS</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWRANGE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_NULL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWRANGE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWPRIV</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_NULL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWPRIV</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* (handled directly by us) */</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_NOMAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWSTATS</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_NULL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWSTATS</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* (handled directly by us) */</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_statistics</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWSPY</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_MAX_SPY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWSPY</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">+</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_MAX_SPY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWTHRSPY</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_thrspy</span><span class="p">),</span>
		<span class="p">.</span><span class="n">min_tokens</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_thrspy</span><span class="p">),</span>
		<span class="p">.</span><span class="n">min_tokens</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWAP</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_ADDR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWMLME</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWAPLIST</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">+</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_MAX_AP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_NOMAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWSCAN</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_tokens</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_NOMAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWESSID</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_EVENT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWESSID</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWNICKN</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWNICKN</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWRATE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWRATE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWRTS</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWRTS</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWFRAG</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWFRAG</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWTXPOW</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWTXPOW</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWRETRY</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWRETRY</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWENCODE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_ENCODING_TOKEN_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_EVENT</span> <span class="o">|</span> <span class="n">IW_DESCR_FLAG_RESTRICT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWENCODE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_ENCODING_TOKEN_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IW_DESCR_FLAG_DUMP</span> <span class="o">|</span> <span class="n">IW_DESCR_FLAG_RESTRICT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWPOWER</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWPOWER</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWGENIE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_GENERIC_IE_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWGENIE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_GENERIC_IE_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWAUTH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWAUTH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_PARAM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWENCODEEXT</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span> <span class="o">+</span>
				  <span class="n">IW_ENCODING_TOKEN_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCGIWENCODEEXT</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span> <span class="o">+</span>
				  <span class="n">IW_ENCODING_TOKEN_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">SIOCSIWPMKSA</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_pmksa</span><span class="p">),</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_pmksa</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">standard_ioctl_num</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">standard_ioctl</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Meta-data about all the additional standard Wireless Extension events</span>
<span class="cm"> * we know about.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_ioctl_description</span> <span class="n">standard_event</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVTXDROP</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_ADDR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVQUAL</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_QUAL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVCUSTOM</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_CUSTOM_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVREGISTERED</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_ADDR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVEXPIRED</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_ADDR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVGENIE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_GENERIC_IE_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVMICHAELMICFAILURE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_michaelmicfailure</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVASSOCREQIE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_GENERIC_IE_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVASSOCRESPIE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="n">IW_GENERIC_IE_MAX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">IWEVPMKIDCAND</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">header_type</span>	<span class="o">=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">token_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_tokens</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_pmkid_cand</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">standard_event_num</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">standard_event</span><span class="p">);</span>

<span class="cm">/* Size (in bytes) of various events */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">event_type_size</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IW_EV_LCP_LEN</span><span class="p">,</span>			<span class="cm">/* IW_HEADER_TYPE_NULL */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">IW_EV_CHAR_LEN</span><span class="p">,</span>			<span class="cm">/* IW_HEADER_TYPE_CHAR */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">IW_EV_UINT_LEN</span><span class="p">,</span>			<span class="cm">/* IW_HEADER_TYPE_UINT */</span>
	<span class="n">IW_EV_FREQ_LEN</span><span class="p">,</span>			<span class="cm">/* IW_HEADER_TYPE_FREQ */</span>
	<span class="n">IW_EV_ADDR_LEN</span><span class="p">,</span>			<span class="cm">/* IW_HEADER_TYPE_ADDR */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">IW_EV_POINT_LEN</span><span class="p">,</span>		<span class="cm">/* Without variable payload */</span>
	<span class="n">IW_EV_PARAM_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_PARAM */</span>
	<span class="n">IW_EV_QUAL_LEN</span><span class="p">,</span>			<span class="cm">/* IW_HEADER_TYPE_QUAL */</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">compat_event_type_size</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IW_EV_COMPAT_LCP_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_NULL */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">IW_EV_COMPAT_CHAR_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_CHAR */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">IW_EV_COMPAT_UINT_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_UINT */</span>
	<span class="n">IW_EV_COMPAT_FREQ_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_FREQ */</span>
	<span class="n">IW_EV_COMPAT_ADDR_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_ADDR */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">IW_EV_COMPAT_POINT_LEN</span><span class="p">,</span>		<span class="cm">/* Without variable payload */</span>
	<span class="n">IW_EV_COMPAT_PARAM_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_PARAM */</span>
	<span class="n">IW_EV_COMPAT_QUAL_LEN</span><span class="p">,</span>		<span class="cm">/* IW_HEADER_TYPE_QUAL */</span>
<span class="p">};</span>
<span class="cp">#endif</span>


<span class="cm">/* IW event code */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">wext_pernet_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">wext_nlevents</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">wext_pernet_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">wext_nlevents</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">wext_pernet_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">wext_pernet_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">wext_pernet_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wireless_nlevent_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wext_pernet_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">wireless_nlevent_init</span><span class="p">);</span>

<span class="cm">/* Process events generated by the wireless layer or the driver. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wireless_nlevent_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">for_each_net</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">wext_nlevents</span><span class="p">)))</span>
			<span class="n">rtnl_notify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTNLGRP_LINK</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">wireless_nlevent_work</span><span class="p">,</span> <span class="n">wireless_nlevent_process</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="nf">rtnetlink_ifinfo_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifinfomsg</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span>  <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTM_NEWLINK</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlh</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">ifi_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">__ifi_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">ifi_type</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">ifi_index</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">ifi_flags</span> <span class="o">=</span> <span class="n">dev_get_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">ifi_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Wireless changes don&#39;t affect those flags */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IFLA_IFNAME</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlh</span><span class="p">;</span>
 <span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Main event dispatcher. Called from other parts and drivers.</span>
<span class="cm"> * Send the event on the appropriate channels.</span>
<span class="cm"> * May be called from interrupt context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wireless_send_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span>	<span class="n">dev</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span>	<span class="n">wrqu</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>		<span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_ioctl_description</span> <span class="o">*</span>	<span class="n">descr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">extra_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_event</span>  <span class="o">*</span><span class="n">event</span><span class="p">;</span>		<span class="cm">/* Mallocated whole event */</span>
	<span class="kt">int</span> <span class="n">event_len</span><span class="p">;</span>				<span class="cm">/* Its size */</span>
	<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">;</span>				<span class="cm">/* Size of the event header */</span>
	<span class="kt">int</span> <span class="n">wrqu_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Offset in wrqu */</span>
	<span class="cm">/* Don&#39;t &quot;optimise&quot; the following variable, it will crash */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cmd_index</span><span class="p">;</span>		<span class="cm">/* *MUST* be unsigned */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="k">struct</span> <span class="n">__compat_iw_event</span> <span class="o">*</span><span class="n">compat_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compat_iw_point</span> <span class="n">compat_wrqu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">compskb</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Nothing in the kernel sends scan events with data, be safe.</span>
<span class="cm">	 * This is necessary because we cannot fix up scan event data</span>
<span class="cm">	 * for compat, due to being contained in &#39;extra&#39;, but normally</span>
<span class="cm">	 * applications are required to retrieve the scan data anyway</span>
<span class="cm">	 * and no data is included in the event, this codifies that</span>
<span class="cm">	 * practice.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCGIWSCAN</span> <span class="o">&amp;&amp;</span> <span class="n">extra</span><span class="p">))</span>
		<span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Get the description of the Event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&lt;=</span> <span class="n">SIOCIWLAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_index</span> <span class="o">=</span> <span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_index</span> <span class="o">&lt;</span> <span class="n">standard_ioctl_num</span><span class="p">)</span>
			<span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">standard_ioctl</span><span class="p">[</span><span class="n">cmd_index</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd_index</span> <span class="o">=</span> <span class="n">IW_EVENT_IDX</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_index</span> <span class="o">&lt;</span> <span class="n">standard_event_num</span><span class="p">)</span>
			<span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">standard_event</span><span class="p">[</span><span class="n">cmd_index</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="cm">/* Don&#39;t accept unknown events */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note : we don&#39;t return an error to the driver, because</span>
<span class="cm">		 * the driver would not know what to do about it. It can&#39;t</span>
<span class="cm">		 * return an error to the user, because the event is not</span>
<span class="cm">		 * initiated by a user request.</span>
<span class="cm">		 * The best the driver could do is to log an error message.</span>
<span class="cm">		 * We will do it ourselves instead...</span>
<span class="cm">		 */</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(WE) : Invalid/Unknown Wireless Event (0x%04X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check extra parameters and set extra_len */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">header_type</span> <span class="o">==</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if number of token fits within bounds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">max_tokens</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(WE) : Wireless Event too big (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">min_tokens</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(WE) : Wireless Event too small (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Calculate extra_len - extra is NULL for restricted events */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extra</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">extra_len</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">*</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">token_size</span><span class="p">;</span>
		<span class="cm">/* Always at an offset in wrqu */</span>
		<span class="n">wrqu_off</span> <span class="o">=</span> <span class="n">IW_EV_POINT_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Total length of the event */</span>
	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">event_type_size</span><span class="p">[</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">header_type</span><span class="p">];</span>
	<span class="n">event_len</span> <span class="o">=</span> <span class="n">hdr_len</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The problem for 64/32 bit.</span>
<span class="cm">	 *</span>
<span class="cm">	 * On 64-bit, a regular event is laid out as follows:</span>
<span class="cm">	 *      |  0  |  1  |  2  |  3  |  4  |  5  |  6  |  7  |</span>
<span class="cm">	 *      | event.len | event.cmd |     p a d d i n g     |</span>
<span class="cm">	 *      | wrqu data ... (with the correct size)         |</span>
<span class="cm">	 *</span>
<span class="cm">	 * This padding exists because we manipulate event-&gt;u,</span>
<span class="cm">	 * and &#39;event&#39; is not packed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * An iw_point event is laid out like this instead:</span>
<span class="cm">	 *      |  0  |  1  |  2  |  3  |  4  |  5  |  6  |  7  |</span>
<span class="cm">	 *      | event.len | event.cmd |     p a d d i n g     |</span>
<span class="cm">	 *      | iwpnt.len | iwpnt.flg |     p a d d i n g     |</span>
<span class="cm">	 *      | extra data  ...</span>
<span class="cm">	 *</span>
<span class="cm">	 * The second padding exists because struct iw_point is extended,</span>
<span class="cm">	 * but this depends on the platform...</span>
<span class="cm">	 *</span>
<span class="cm">	 * On 32-bit, all the padding shouldn&#39;t be there.</span>
<span class="cm">	 */</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Send via the RtNetlink event channel */</span>
	<span class="n">nlh</span> <span class="o">=</span> <span class="n">rtnetlink_ifinfo_prep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">nlh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add the wireless events in the netlink packet */</span>
	<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IFLA_WIRELESS</span><span class="p">,</span> <span class="n">event_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nla</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>

	<span class="cm">/* Fill event - first clear to avoid data leaking */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">event_len</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrqu</span><span class="p">)</span> <span class="o">+</span> <span class="n">wrqu_off</span><span class="p">,</span> <span class="n">hdr_len</span> <span class="o">-</span> <span class="n">IW_EV_LCP_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extra_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">event</span><span class="p">)</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">extra_len</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">compat_event_type_size</span><span class="p">[</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">header_type</span><span class="p">];</span>
	<span class="n">event_len</span> <span class="o">=</span> <span class="n">hdr_len</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">;</span>

	<span class="n">compskb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send via the RtNetlink event channel */</span>
	<span class="n">nlh</span> <span class="o">=</span> <span class="n">rtnetlink_ifinfo_prep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">compskb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">nlh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">compskb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add the wireless events in the netlink packet */</span>
	<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_reserve</span><span class="p">(</span><span class="n">compskb</span><span class="p">,</span> <span class="n">IFLA_WIRELESS</span><span class="p">,</span> <span class="n">event_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nla</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">compskb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">compat_event</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>

	<span class="n">compat_event</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">event_len</span><span class="p">;</span>
	<span class="n">compat_event</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">header_type</span> <span class="o">==</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">compat_wrqu</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">compat_wrqu</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compat_event</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">compat_wrqu</span><span class="p">)</span> <span class="o">+</span> <span class="n">IW_EV_COMPAT_POINT_OFF</span><span class="p">,</span>
			<span class="n">hdr_len</span> <span class="o">-</span> <span class="n">IW_EV_COMPAT_LCP_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extra_len</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">compat_event</span><span class="p">)</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span>
				<span class="n">extra</span><span class="p">,</span> <span class="n">extra_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* extra_len must be zero, so no if (extra) needed */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compat_event</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span>
			<span class="n">hdr_len</span> <span class="o">-</span> <span class="n">IW_EV_COMPAT_LCP_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">compskb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span> <span class="o">=</span> <span class="n">compskb</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wext_nlevents</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wireless_nlevent_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wireless_send_event</span><span class="p">);</span>



<span class="cm">/* IW handlers */</span>

<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_WIRELESS_EXT</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="o">-&gt;</span><span class="n">get_wireless_stats</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="o">-&gt;</span><span class="n">get_wireless_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wext</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wext</span><span class="o">-&gt;</span><span class="n">get_wireless_stats</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wext</span><span class="o">-&gt;</span><span class="n">get_wireless_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* not found */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iw_handler_get_iwstats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span>		<span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span>	<span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span>		<span class="n">wrqu</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span>			<span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Get stats from the driver */</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">get_wireless_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy statistics to extra */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_statistics</span><span class="p">));</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_statistics</span><span class="p">);</span>

		<span class="cm">/* Check if we need to clear the updated flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IW_QUAL_ALL_UPDATED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">iw_handler</span> <span class="nf">get_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t &quot;optimise&quot; the following variable, it will crash */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">index</span><span class="p">;</span>		<span class="cm">/* *MUST* be unsigned */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="o">*</span><span class="n">handlers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span>
		<span class="n">handlers</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_WIRELESS_EXT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="p">)</span>
		<span class="n">handlers</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handlers</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Try as a standard command */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">handlers</span><span class="o">-&gt;</span><span class="n">num_standard</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">handlers</span><span class="o">-&gt;</span><span class="n">standard</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_WEXT_PRIV</span>
	<span class="cm">/* Try as a private command */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">-</span> <span class="n">SIOCIWFIRSTPRIV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">handlers</span><span class="o">-&gt;</span><span class="n">num_private</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">handlers</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="cm">/* Not found */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_standard_iw_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">iwp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_ioctl_description</span> <span class="o">*</span><span class="n">descr</span><span class="p">,</span>
				   <span class="n">iw_handler</span> <span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">extra_size</span><span class="p">,</span> <span class="n">user_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">essid_compat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">;</span>

	<span class="cm">/* Calculate space needed by arguments. Always allocate</span>
<span class="cm">	 * for max space.</span>
<span class="cm">	 */</span>
	<span class="n">extra_size</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">max_tokens</span> <span class="o">*</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">token_size</span><span class="p">;</span>

	<span class="cm">/* Check need for ESSID compatibility for WE &lt; 21 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSIWESSID</span>:
	<span class="k">case</span> <span class="n">SIOCGIWESSID</span>:
	<span class="k">case</span> <span class="n">SIOCSIWNICKN</span>:
	<span class="k">case</span> <span class="n">SIOCGIWNICKN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">max_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">essid_compat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IW_IS_SET</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">token_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">essid</span><span class="p">[</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
				<span class="n">essid_compat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">essid_compat</span><span class="p">;</span>

	<span class="cm">/* Check what user space is giving us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IW_IS_SET</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check NULL pointer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&amp;&amp;</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="cm">/* Check if number of token fits within bounds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">max_tokens</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">min_tokens</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Check NULL pointer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="cm">/* Save user space buffer size for checking */</span>
		<span class="n">user_length</span> <span class="o">=</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t check if user_length &gt; max to allow forward</span>
<span class="cm">		 * compatibility. The test user_length &lt; min is</span>
<span class="cm">		 * implied by the test at the end.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Support for very large requests */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_DESCR_FLAG_NOMAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">user_length</span> <span class="o">&gt;</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">max_tokens</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Allow userspace to GET more than max so</span>
<span class="cm">			 * we can support any size GET requests.</span>
<span class="cm">			 * There is still a limit : -ENOMEM.</span>
<span class="cm">			 */</span>
			<span class="n">extra_size</span> <span class="o">=</span> <span class="n">user_length</span> <span class="o">*</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">token_size</span><span class="p">;</span>

			<span class="cm">/* Note : user_length is originally a __u16,</span>
<span class="cm">			 * and token_size is controlled by us,</span>
<span class="cm">			 * so extra_size won&#39;t get negative and</span>
<span class="cm">			 * won&#39;t overflow...</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* kzalloc() ensures NULL-termination for essid_compat. */</span>
	<span class="n">extra</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">extra_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extra</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* If it is a SET, get all the extra data in here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IW_IS_SET</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span>
				   <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span>
				   <span class="n">descr</span><span class="o">-&gt;</span><span class="n">token_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSIWENCODEEXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ee</span><span class="p">)</span> <span class="o">+</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IW_IS_GET</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_DESCR_FLAG_NOMAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If this is a GET, but not NOMAX, it means that the extra</span>
<span class="cm">		 * data is not bounded by userspace, but by max_tokens. Thus</span>
<span class="cm">		 * set the length to max_tokens. This matches the extra data</span>
<span class="cm">		 * allocation.</span>
<span class="cm">		 * The driver should fill it with the number of tokens it</span>
<span class="cm">		 * provided, and it may check iwp-&gt;length rather than having</span>
<span class="cm">		 * knowledge of max_tokens. If the driver doesn&#39;t change the</span>
<span class="cm">		 * iwp-&gt;length, this ioctl just copies back max_token tokens</span>
<span class="cm">		 * filled with zeroes. Hopefully the driver isn&#39;t claiming</span>
<span class="cm">		 * them to be valid data.</span>
<span class="cm">		 */</span>
		<span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">max_tokens</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">iwp</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+=</span> <span class="n">essid_compat</span><span class="p">;</span>

	<span class="cm">/* If we have something to return to the user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">IW_IS_GET</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check if there is enough buffer up there */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_length</span> <span class="o">&lt;</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span>
				 <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span>
				 <span class="n">descr</span><span class="o">-&gt;</span><span class="n">token_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Generate an event to notify listeners of the change */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_DESCR_FLAG_EVENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIWCOMMIT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">iwp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_DESCR_FLAG_RESTRICT</span><span class="p">)</span>
			<span class="cm">/* If the event is restricted, don&#39;t</span>
<span class="cm">			 * export the payload.</span>
<span class="cm">			 */</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">extra</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call the commit handler in the driver</span>
<span class="cm"> * (if exist and if conditions are right)</span>
<span class="cm"> *</span>
<span class="cm"> * Note : our current commit strategy is currently pretty dumb,</span>
<span class="cm"> * but we will be able to improve on that...</span>
<span class="cm"> * The goal is to try to agreagate as many changes as possible</span>
<span class="cm"> * before doing the commit. Drivers that will define a commit handler</span>
<span class="cm"> * are usually those that need a reset after changing parameters, so</span>
<span class="cm"> * we want to minimise the number of reset.</span>
<span class="cm"> * A cool idea is to use a timer : at each &quot;set&quot; command, we re-set the</span>
<span class="cm"> * timer, when the timer eventually fires, we call the driver.</span>
<span class="cm"> * Hopefully, more on that later.</span>
<span class="cm"> *</span>
<span class="cm"> * Also, I&#39;m waiting to see how many people will complain about the</span>
<span class="cm"> * netif_running(dev) test. I&#39;m open on that one...</span>
<span class="cm"> * Hopefully, the driver will remember to do a commit in &quot;open()&quot; ;-)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">call_commit_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_WIRELESS_EXT</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="o">-&gt;</span><span class="n">standard</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="cm">/* Call the commit handler on the driver */</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="o">-&gt;</span><span class="n">standard</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							   <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Command completed successfully */</span>
<span class="cp">#else</span>
	<span class="cm">/* cfg80211 has no commit */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Main IOCTl dispatcher.</span>
<span class="cm"> * Check the type of IOCTL and call the appropriate wrapper...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wireless_process_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="n">wext_ioctl_func</span> <span class="n">standard</span><span class="p">,</span>
				  <span class="n">wext_ioctl_func</span> <span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">iwr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">iw_handler</span>	<span class="n">handler</span><span class="p">;</span>

	<span class="cm">/* Permissions are already checked in dev_ioctl() before calling us.</span>
<span class="cm">	 * The copy_to/from_user() of ifr is also dealt with in there */</span>

	<span class="cm">/* Make sure the device exist */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_name</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* A bunch of special cases, then the generic case...</span>
<span class="cm">	 * Note that &#39;cmd&#39; is already filtered in dev_ioctl() with</span>
<span class="cm">	 * (cmd &gt;= SIOCIWFIRST &amp;&amp; cmd &lt;= SIOCIWLAST) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCGIWSTATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iwr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">iw_handler_get_iwstats</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_WEXT_PRIV</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCGIWPRIV</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iwr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
				<span class="n">iw_handler_get_private</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Basic check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* New driver API : try to find the handler */</span>
	<span class="n">handler</span> <span class="o">=</span> <span class="n">get_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Standard and private are not the same */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&lt;</span> <span class="n">SIOCIWFIRSTPRIV</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iwr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iwr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Old driver API : call driver ioctl handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_do_ioctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_do_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* If command is `set a parameter&#39;, or `get the encoding parameters&#39;,</span>
<span class="cm"> * check if the user has the right to do it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wext_permission_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">IW_IS_SET</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCGIWENCODE</span> <span class="o">||</span>
	     <span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCGIWENCODEEXT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* entry point from dev ioctl */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wext_ioctl_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="n">wext_ioctl_func</span> <span class="n">standard</span><span class="p">,</span>
			       <span class="n">wext_ioctl_func</span> <span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">wext_permission_check</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_load</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_name</span><span class="p">);</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wireless_process_ioctl</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">standard</span><span class="p">,</span> <span class="n">private</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrapper to call a standard Wireless Extension handler.</span>
<span class="cm"> * We do various checks and also take care of moving data between</span>
<span class="cm"> * user space and kernel space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_standard_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span>	<span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iwreq</span>		<span class="o">*</span><span class="n">iwr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span>	<span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="n">iw_handler</span>		<span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_ioctl_description</span> <span class="o">*</span>	<span class="n">descr</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Get the description of the IOCTL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">standard_ioctl_num</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">standard_ioctl</span><span class="p">[</span><span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>

	<span class="cm">/* Check if we have a pointer to user space data or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">header_type</span> <span class="o">!=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* No extra arguments. Trivial to handle */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iwr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* Generate an event to notify listeners of the change */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_DESCR_FLAG_EVENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIWCOMMIT</span><span class="p">)))</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iwr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl_standard_iw_point</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span>
					      <span class="n">handler</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Call commit handler if needed and defined */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIWCOMMIT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">call_commit_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Here, we will generate the appropriate event if needed */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">wext_handle_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wext_ioctl_dispatch</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
				  <span class="n">ioctl_standard_call</span><span class="p">,</span>
				  <span class="n">ioctl_private_call</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">IW_IS_GET</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_standard_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwreq</span>		<span class="o">*</span><span class="n">iwr</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span>	<span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="n">iw_handler</span>		<span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_ioctl_description</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compat_iw_point</span> <span class="o">*</span><span class="n">iwp_compat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="n">iwp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">descr</span> <span class="o">=</span> <span class="n">standard_ioctl</span> <span class="o">+</span> <span class="n">IW_IOCTL_IDX</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">header_type</span> <span class="o">!=</span> <span class="n">IW_HEADER_TYPE_POINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ioctl_standard_call</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iwr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>

	<span class="n">iwp_compat</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">compat_iw_point</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">iwr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="n">iwp</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">iwp_compat</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">iwp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">iwp_compat</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">iwp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">iwp_compat</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ioctl_standard_iw_point</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">iwp_compat</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">ptr_to_compat</span><span class="p">(</span><span class="n">iwp</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">iwp_compat</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">iwp</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="n">iwp_compat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">iwp</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">compat_wext_handle_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="n">iwr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">colon</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwr</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">iwr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">colon</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">iwr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span>
		<span class="o">*</span><span class="n">colon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_REQUEST_FLAG_COMPAT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wext_ioctl_dispatch</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">iwr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
				  <span class="n">compat_standard_call</span><span class="p">,</span>
				  <span class="n">compat_private_call</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">IW_IS_GET</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
