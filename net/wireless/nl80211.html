<!DOCTYPE html>
<html><head><title>joekychen/linux » net › wireless › nl80211.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nl80211.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is the new netlink-based wireless configuration interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006-2010	Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/nl80211.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/netlink.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/genetlink.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;nl80211.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">nl80211_valid_auth_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nl80211_crypto_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_crypto_settings</span> <span class="o">*</span><span class="n">settings</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">cipher_limit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nl80211_pre_doit</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nl80211_post_doit</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/* the netlink family */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="n">nl80211_fam</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_GENERATE</span><span class="p">,</span>	<span class="cm">/* don&#39;t bother with a hardcoded ID */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nl80211&quot;</span><span class="p">,</span>	<span class="cm">/* have users key off the name instead */</span>
	<span class="p">.</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* no private header */</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>		<span class="cm">/* no particular meaning now */</span>
	<span class="p">.</span><span class="n">maxattr</span> <span class="o">=</span> <span class="n">NL80211_ATTR_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">netnsok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_doit</span> <span class="o">=</span> <span class="n">nl80211_pre_doit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_doit</span> <span class="o">=</span> <span class="n">nl80211_post_doit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* internal helper: get rdev and dev */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_rdev_dev_by_ifindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">netns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">**</span><span class="n">rdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">**</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ifindex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ifindex</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">netns</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">cfg80211_get_dev_from_ifindex</span><span class="p">(</span><span class="n">netns</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* policy for the attributes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">nl80211_policy</span><span class="p">[</span><span class="n">NL80211_ATTR_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NUL_STRING</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">20</span><span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_TXQ_PARAMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RETRY_SHORT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RETRY_LONG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FRAG_THRESHOLD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RTS_THRESHOLD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_COVERAGE_CLASS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_IFTYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_IFNAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NUL_STRING</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IFNAMSIZ</span><span class="o">-</span><span class="mi">1</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_PREV_BSSID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_KEY_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_MAX_KEY_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_KEY_CIPHER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_KEY_DEFAULT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_KEY_SEQ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_KEY_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_BEACON_INTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_DTIM_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_BEACON_HEAD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				       <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_BEACON_TAIL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				       <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_AID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_FLAGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_LISTEN_INTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_SUPPORTED_RATES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
					       <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_MAX_SUPP_RATES</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_ACTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_VLAN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_MNTR_FLAGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* NLA_NESTED can&#39;t be empty */</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_MESH_ID_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_MPATH_NEXT_HOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_REG_ALPHA2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_STRING</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_REG_RULES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_BSS_CTS_PROT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_BSS_SHORT_PREAMBLE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_BSS_SHORT_SLOT_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_BSS_BASIC_RATES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
					   <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_MAX_SUPP_RATES</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_BSS_HT_OPMODE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_MESH_CONFIG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_SUPPORT_MESH_AUTH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_HT_CAPABILITY_LEN</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_MGMT_SUBTYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
			      <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_SSID_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_AUTH_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_FREQ_FIXED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TIMED_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_USE_MFP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_FLAGS2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nl80211_sta_flag_update</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT_ETHERTYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT_NO_ENCRYPT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_PRIVACY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CIPHER_SUITE_GROUP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WPA_VERSIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_PID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_4ADDR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_PMKID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				 <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_PMKID_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_DURATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_COOKIE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U64</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TX_RATES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_FRAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				 <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_FRAME_MATCH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_PS_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CQM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_LOCAL_STATE_CHANGE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_AP_ISOLATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_TX_POWER_SETTING</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_TX_POWER_LEVEL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_FRAME_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_ANTENNA_TX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_ANTENNA_RX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_MCAST_RATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_OFFCHANNEL_TX_OK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_KEY_DEFAULT_TYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_WOWLAN_TRIGGERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_INTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_REKEY_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SUPP_RATES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_HIDDEN_SSID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_IE_PROBE_RESP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_IE_ASSOC_RESP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_ROAM_SUPPORT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_MATCH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TX_NO_CCK_RATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TDLS_ACTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TDLS_DIALOG_TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TDLS_OPERATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TDLS_SUPPORT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_TDLS_EXTERNAL_SETUP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_DONT_WAIT_FOR_ACK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_PROBE_RESP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_DFS_REGION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_DISABLE_HT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_HT_CAPABILITY_LEN</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_NOACK_MAP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_INACTIVITY_TIMEOUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_BG_SCAN_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* policy for the key attributes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">nl80211_key_policy</span><span class="p">[</span><span class="n">NL80211_KEY_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_KEY_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_MAX_KEY_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_CIPHER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_SEQ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_DEFAULT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_MGMT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* policy for the key default flags */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span>
<span class="n">nl80211_key_default_policy</span><span class="p">[</span><span class="n">NUM_NL80211_KEY_DEFAULT_TYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPE_UNICAST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPE_MULTICAST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* policy for WoWLAN attributes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span>
<span class="n">nl80211_wowlan_policy</span><span class="p">[</span><span class="n">NUM_NL80211_WOWLAN_TRIG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_ANY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_DISCONNECT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_MAGIC_PKT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_PKT_PATTERN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_GTK_REKEY_FAILURE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_EAP_IDENT_REQUEST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_4WAY_HANDSHAKE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_RFKILL_RELEASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* policy for GTK rekey offload attributes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span>
<span class="n">nl80211_rekey_policy</span><span class="p">[</span><span class="n">NUM_NL80211_REKEY_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_REKEY_DATA_KEK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_KEK_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_REKEY_DATA_KCK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_KCK_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_REKEY_DATA_REPLAY_CTR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_REPLAY_CTR_LEN</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span>
<span class="n">nl80211_match_policy</span><span class="p">[</span><span class="n">NL80211_SCHED_SCAN_MATCH_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_MATCH_SSID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
						 <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_SSID_LEN</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ifidx get helper */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_ifidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="p">,</span> <span class="n">GENL_HDRLEN</span> <span class="o">+</span> <span class="n">nl80211_fam</span><span class="p">.</span><span class="n">hdrsize</span><span class="p">,</span>
			  <span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">,</span> <span class="n">nl80211_fam</span><span class="p">.</span><span class="n">maxattr</span><span class="p">,</span>
			  <span class="n">nl80211_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_prepare_netdev_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">**</span><span class="n">rdev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">**</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ifidx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifidx</span><span class="p">)</span>
		<span class="n">ifidx</span> <span class="o">=</span> <span class="n">nl80211_get_ifidx</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifidx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ifidx</span><span class="p">;</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifidx</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span> <span class="n">ifidx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_rtnl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">cfg80211_get_dev_from_ifindex</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span> <span class="n">ifidx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_rtnl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_rtnl:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nl80211_finish_netdev_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* IE validation */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_valid_ie_attr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">elemlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">elemlen</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elemlen</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">elemlen</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">elemlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* message building helper */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">nl80211hdr_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* since there is no private header just add the generic one */</span>
	<span class="k">return</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_msg_put_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_FREQUENCY_ATTR_FREQ</span><span class="p">,</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_FREQUENCY_ATTR_DISABLED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_FREQUENCY_ATTR_PASSIVE_SCAN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_FREQUENCY_ATTR_NO_IBSS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_RADAR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_FREQUENCY_ATTR_RADAR</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_FREQUENCY_ATTR_MAX_TX_POWER</span><span class="p">,</span>
			<span class="n">DBM_TO_MBM</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">max_power</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* netlink command implementations */</span>

<span class="k">struct</span> <span class="n">key_parse</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">key_params</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">def</span><span class="p">,</span> <span class="n">defmgmt</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">def_uni</span><span class="p">,</span> <span class="n">def_multi</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_parse_key_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key_parse</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_KEY_MAX</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
				   <span class="n">nl80211_key_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">k</span><span class="o">-&gt;</span><span class="n">def</span> <span class="o">=</span> <span class="o">!!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT</span><span class="p">];</span>
	<span class="n">k</span><span class="o">-&gt;</span><span class="n">defmgmt</span> <span class="o">=</span> <span class="o">!!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_MGMT</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_uni</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_multi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">defmgmt</span><span class="p">)</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_multi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_IDX</span><span class="p">])</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_IDX</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_DATA</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_DATA</span><span class="p">]);</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_DATA</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_SEQ</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_SEQ</span><span class="p">]);</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_SEQ</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_CIPHER</span><span class="p">])</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_CIPHER</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_TYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_TYPE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">NUM_NL80211_KEYTYPES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPES</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">kdt</span><span class="p">[</span><span class="n">NUM_NL80211_KEY_DEFAULT_TYPES</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">kdt</span><span class="p">,</span> <span class="n">NUM_NL80211_KEY_DEFAULT_TYPES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">tb</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPES</span><span class="p">],</span>
				       <span class="n">nl80211_key_default_policy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_uni</span> <span class="o">=</span> <span class="n">kdt</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPE_UNICAST</span><span class="p">];</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_multi</span> <span class="o">=</span> <span class="n">kdt</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPE_MULTICAST</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_parse_key_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key_parse</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_DATA</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_DATA</span><span class="p">]);</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_DATA</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_SEQ</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_SEQ</span><span class="p">]);</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_SEQ</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">])</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_CIPHER</span><span class="p">])</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_CIPHER</span><span class="p">]);</span>

	<span class="n">k</span><span class="o">-&gt;</span><span class="n">def</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_DEFAULT</span><span class="p">];</span>
	<span class="n">k</span><span class="o">-&gt;</span><span class="n">defmgmt</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_DEFAULT_MGMT</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_uni</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_multi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">defmgmt</span><span class="p">)</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_multi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_TYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_TYPE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">NUM_NL80211_KEYTYPES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_DEFAULT_TYPES</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">kdt</span><span class="p">[</span><span class="n">NUM_NL80211_KEY_DEFAULT_TYPES</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span>
				<span class="n">kdt</span><span class="p">,</span> <span class="n">NUM_NL80211_KEY_DEFAULT_TYPES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_DEFAULT_TYPES</span><span class="p">],</span>
				<span class="n">nl80211_key_default_policy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_uni</span> <span class="o">=</span> <span class="n">kdt</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPE_UNICAST</span><span class="p">];</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">def_multi</span> <span class="o">=</span> <span class="n">kdt</span><span class="p">[</span><span class="n">NL80211_KEY_DEFAULT_TYPE_MULTICAST</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_parse_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key_parse</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">k</span><span class="p">));</span>
	<span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">k</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY</span><span class="p">])</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_key_new</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY</span><span class="p">],</span> <span class="n">k</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_key_old</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">def</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">defmgmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">defmgmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">def_uni</span> <span class="o">||</span> <span class="o">!</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">def_multi</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">defmgmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cfg80211_cached_keys</span> <span class="o">*</span>
<span class="nf">nl80211_parse_connkeys</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">keys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">key_parse</span> <span class="n">parse</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_cached_keys</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">result</span><span class="o">-&gt;</span><span class="n">def</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">result</span><span class="o">-&gt;</span><span class="n">defmgmt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parse</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">parse</span><span class="p">));</span>
		<span class="n">parse</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_key_new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parse</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parse</span><span class="p">.</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">parse</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parse</span><span class="p">.</span><span class="n">def</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">def</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">def</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">result</span><span class="o">-&gt;</span><span class="n">def</span> <span class="o">=</span> <span class="n">parse</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse</span><span class="p">.</span><span class="n">def_uni</span> <span class="o">||</span> <span class="o">!</span><span class="n">parse</span><span class="p">.</span><span class="n">def_multi</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parse</span><span class="p">.</span><span class="n">defmgmt</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_validate_key_settings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parse</span><span class="p">.</span><span class="n">p</span><span class="p">,</span>
						     <span class="n">parse</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">result</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">parse</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">parse</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">cipher</span><span class="p">;</span>
		<span class="n">result</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">parse</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">parse</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">result</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">parse</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">parse</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">parse</span><span class="p">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">parse</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">parse</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_key_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT_WDEV_LOCK</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">!=</span> <span class="n">CFG80211_SME_CONNECTED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_put_iftypes</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">attr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ifmodes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_modes</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_modes</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ifmodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ifmodes</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="n">ifmodes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_modes</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_put_iface_combinations</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_combis</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">nl_combis</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>
				<span class="n">NL80211_ATTR_INTERFACE_COMBINATIONS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_combis</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_iface_combinations</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_iface_combination</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_combi</span><span class="p">,</span> <span class="o">*</span><span class="n">nl_limits</span><span class="p">;</span>

		<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">iface_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">nl_combi</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_combi</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">nl_limits</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_IFACE_COMB_LIMITS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_limits</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">n_limits</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_limit</span><span class="p">;</span>

			<span class="n">nl_limit</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_limit</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_IFACE_LIMIT_MAX</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_put_iftypes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_IFACE_LIMIT_TYPES</span><span class="p">,</span>
						<span class="n">c</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">types</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_limit</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_limits</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">beacon_int_infra_match</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_IFACE_COMB_STA_AP_BI_MATCH</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_IFACE_COMB_NUM_CHANNELS</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">num_different_channels</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_IFACE_COMB_MAXNUM</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_interfaces</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_combi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_combis</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_send_wiphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_bands</span><span class="p">,</span> <span class="o">*</span><span class="n">nl_band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_freqs</span><span class="p">,</span> <span class="o">*</span><span class="n">nl_freq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_rates</span><span class="p">,</span> <span class="o">*</span><span class="n">nl_rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_cmds</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_txrx_stypes</span> <span class="o">*</span><span class="n">mgmt_stypes</span> <span class="o">=</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">mgmt_stypes</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">NL80211_CMD_NEW_WIPHY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_string</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_NAME</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_GENERATION</span><span class="p">,</span>
			<span class="n">cfg80211_rdev_list_generation</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_RETRY_SHORT</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_short</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_RETRY_LONG</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_long</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_FRAG_THRESHOLD</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">frag_threshold</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_RTS_THRESHOLD</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">rts_threshold</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_COVERAGE_CLASS</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">coverage_class</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAX_NUM_SCAN_SSIDS</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_scan_ssids</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAX_NUM_SCHED_SCAN_SSIDS</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_sched_scan_ssids</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAX_SCAN_IE_LEN</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_scan_ie_len</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAX_SCHED_SCAN_IE_LEN</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_sched_scan_ie_len</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAX_MATCH_SETS</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_match_sets</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_IBSS_RSN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SUPPORT_IBSS_RSN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_MESH_AUTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SUPPORT_MESH_AUTH</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_AP_UAPSD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SUPPORT_AP_UAPSD</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_FW_ROAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_ROAM_SUPPORT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_TDLS_SUPPORT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_TDLS_EXTERNAL_SETUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_TDLS_EXTERNAL_SETUP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_CIPHER_SUITES</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">n_cipher_suites</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">cipher_suites</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAX_NUM_PMKIDS</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_num_pmkids</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_CONTROL_PORT_PROTOCOL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_CONTROL_PORT_ETHERTYPE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_ANTENNA_AVAIL_TX</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_tx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_ANTENNA_AVAIL_RX</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_rx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_AP_PROBE_RESP_OFFLOAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_PROBE_RESP_OFFLOAD</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">probe_resp_offload</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_tx</span> <span class="o">||</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_rx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_antenna</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tx_ant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_ant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_antenna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_ant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_ant</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_ANTENNA_TX</span><span class="p">,</span>
					<span class="n">tx_ant</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_ANTENNA_RX</span><span class="p">,</span>
					<span class="n">rx_ant</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_put_iftypes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SUPPORTED_IFTYPES</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">interface_modes</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nl_bands</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_BANDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_bands</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">nl_band</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_band</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="cm">/* add HT info */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BAND_ATTR_HT_MCS_SET</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BAND_ATTR_HT_CAPA</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BAND_ATTR_HT_AMPDU_FACTOR</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BAND_ATTR_HT_AMPDU_DENSITY</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="cm">/* add frequencies */</span>
		<span class="n">nl_freqs</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BAND_ATTR_FREQS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_freqs</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nl_freq</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_freq</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_msg_put_channel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_freq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_freqs</span><span class="p">);</span>

		<span class="cm">/* add bitrates */</span>
		<span class="n">nl_rates</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BAND_ATTR_RATES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_rates</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nl_rate</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_rate</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BITRATE_ATTR_RATE</span><span class="p">,</span>
					<span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>
					 <span class="n">NL80211_BITRATE_ATTR_2GHZ_SHORTPREAMBLE</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_rate</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_rates</span><span class="p">);</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_band</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_bands</span><span class="p">);</span>

	<span class="n">nl_cmds</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SUPPORTED_COMMANDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_cmds</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#define CMD(op, n)						\</span>
<span class="cp">	 do {							\</span>
<span class="cp">		if (dev-&gt;ops-&gt;op) {				\</span>
<span class="cp">			i++;					\</span>
<span class="cp">			if (nla_put_u32(msg, i, NL80211_CMD_ ## n)) \</span>
<span class="cp">				goto nla_put_failure;		\</span>
<span class="cp">		}						\</span>
<span class="cp">	} while (0)</span>

	<span class="n">CMD</span><span class="p">(</span><span class="n">add_virtual_intf</span><span class="p">,</span> <span class="n">NEW_INTERFACE</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">change_virtual_intf</span><span class="p">,</span> <span class="n">SET_INTERFACE</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">add_key</span><span class="p">,</span> <span class="n">NEW_KEY</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">start_ap</span><span class="p">,</span> <span class="n">START_AP</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">add_station</span><span class="p">,</span> <span class="n">NEW_STATION</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">add_mpath</span><span class="p">,</span> <span class="n">NEW_MPATH</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">update_mesh_config</span><span class="p">,</span> <span class="n">SET_MESH_CONFIG</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">change_bss</span><span class="p">,</span> <span class="n">SET_BSS</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">AUTHENTICATE</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">assoc</span><span class="p">,</span> <span class="n">ASSOCIATE</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">deauth</span><span class="p">,</span> <span class="n">DEAUTHENTICATE</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">disassoc</span><span class="p">,</span> <span class="n">DISASSOCIATE</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">join_ibss</span><span class="p">,</span> <span class="n">JOIN_IBSS</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">join_mesh</span><span class="p">,</span> <span class="n">JOIN_MESH</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">set_pmksa</span><span class="p">,</span> <span class="n">SET_PMKSA</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">del_pmksa</span><span class="p">,</span> <span class="n">DEL_PMKSA</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">flush_pmksa</span><span class="p">,</span> <span class="n">FLUSH_PMKSA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_HAS_REMAIN_ON_CHANNEL</span><span class="p">)</span>
		<span class="n">CMD</span><span class="p">(</span><span class="n">remain_on_channel</span><span class="p">,</span> <span class="n">REMAIN_ON_CHANNEL</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">set_bitrate_mask</span><span class="p">,</span> <span class="n">SET_TX_BITRATE_MASK</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">mgmt_tx</span><span class="p">,</span> <span class="n">FRAME</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">mgmt_tx_cancel_wait</span><span class="p">,</span> <span class="n">FRAME_WAIT_CANCEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_NETNS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">NL80211_CMD_SET_WIPHY_NETNS</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">set_channel</span><span class="p">,</span> <span class="n">SET_CHANNEL</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">set_wds_peer</span><span class="p">,</span> <span class="n">SET_WDS_PEER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CMD</span><span class="p">(</span><span class="n">tdls_mgmt</span><span class="p">,</span> <span class="n">TDLS_MGMT</span><span class="p">);</span>
		<span class="n">CMD</span><span class="p">(</span><span class="n">tdls_oper</span><span class="p">,</span> <span class="n">TDLS_OPER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_SCHED_SCAN</span><span class="p">)</span>
		<span class="n">CMD</span><span class="p">(</span><span class="n">sched_scan_start</span><span class="p">,</span> <span class="n">START_SCHED_SCAN</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">probe_client</span><span class="p">,</span> <span class="n">PROBE_CLIENT</span><span class="p">);</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">set_noack_map</span><span class="p">,</span> <span class="n">SET_NOACK_MAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_REPORTS_OBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">NL80211_CMD_REGISTER_BEACONS</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NL80211_TESTMODE</span>
	<span class="n">CMD</span><span class="p">(</span><span class="n">testmode_cmd</span><span class="p">,</span> <span class="n">TESTMODE</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#undef CMD</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">auth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">NL80211_CMD_CONNECT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">deauth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">NL80211_CMD_DISCONNECT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_cmds</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">remain_on_channel</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_HAS_REMAIN_ON_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAX_REMAIN_ON_CHANNEL_DURATION</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_remain_on_channel_duration</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_OFFCHAN_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_OFFCHANNEL_TX_OK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_stypes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">stypes</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_ftypes</span><span class="p">,</span> <span class="o">*</span><span class="n">nl_ifs</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">ift</span><span class="p">;</span>

		<span class="n">nl_ifs</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_TX_FRAME_TYPES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_ifs</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ift</span> <span class="o">&lt;</span> <span class="n">NUM_NL80211_IFTYPES</span><span class="p">;</span> <span class="n">ift</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nl_ftypes</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ift</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_ftypes</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">stypes</span> <span class="o">=</span> <span class="n">mgmt_stypes</span><span class="p">[</span><span class="n">ift</span><span class="p">].</span><span class="n">tx</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">stypes</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">stypes</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FRAME_TYPE</span><span class="p">,</span>
						<span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">IEEE80211_FTYPE_MGMT</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
				<span class="n">stypes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_ftypes</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_ifs</span><span class="p">);</span>

		<span class="n">nl_ifs</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_RX_FRAME_TYPES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_ifs</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ift</span> <span class="o">&lt;</span> <span class="n">NUM_NL80211_IFTYPES</span><span class="p">;</span> <span class="n">ift</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nl_ftypes</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ift</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_ftypes</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">stypes</span> <span class="o">=</span> <span class="n">mgmt_stypes</span><span class="p">[</span><span class="n">ift</span><span class="p">].</span><span class="n">rx</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">stypes</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">stypes</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FRAME_TYPE</span><span class="p">,</span>
						<span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">IEEE80211_FTYPE_MGMT</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
				<span class="n">stypes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_ftypes</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_ifs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_wowlan</span><span class="p">;</span>

		<span class="n">nl_wowlan</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>
				<span class="n">NL80211_ATTR_WOWLAN_TRIGGERS_SUPPORTED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_wowlan</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_ANY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_ANY</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_DISCONNECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_DISCONNECT</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_MAGIC_PKT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_MAGIC_PKT</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_SUPPORTS_GTK_REKEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_GTK_REKEY_SUPPORTED</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_GTK_REKEY_FAILURE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_GTK_REKEY_FAILURE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_EAP_IDENTITY_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_EAP_IDENT_REQUEST</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_4WAY_HANDSHAKE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_4WAY_HANDSHAKE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_RFKILL_RELEASE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_RFKILL_RELEASE</span><span class="p">)))</span>
		    <span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nl80211_wowlan_pattern_support</span> <span class="n">pat</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">max_patterns</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span><span class="p">,</span>
				<span class="p">.</span><span class="n">min_pattern_len</span> <span class="o">=</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_min_len</span><span class="p">,</span>
				<span class="p">.</span><span class="n">max_pattern_len</span> <span class="o">=</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_max_len</span><span class="p">,</span>
			<span class="p">};</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_PKT_PATTERN</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">pat</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pat</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_wowlan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_put_iftypes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SOFTWARE_IFTYPES</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">software_iftypes</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_put_iface_combinations</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_HAVE_AP_SME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_DEVICE_AP_SME</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">ap_sme_capa</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FEATURE_FLAGS</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">features</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">ht_capa_mod_mask</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_HT_CAPABILITY_MASK</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">ht_capa_mod_mask</span><span class="p">),</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">ht_capa_mod_mask</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_dump_wiphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg80211_rdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_wiphy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
				       <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
				       <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_wiphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_wiphy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">txq_params_policy</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_TXQ_ATTR_QUEUE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_TXQ_ATTR_TXOP</span><span class="p">]</span>			<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_TXQ_ATTR_CWMIN</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_TXQ_ATTR_CWMAX</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_TXQ_ATTR_AIFS</span><span class="p">]</span>			<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_txq_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[],</span>
			    <span class="k">struct</span> <span class="n">ieee80211_txq_params</span> <span class="o">*</span><span class="n">txq_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_AC</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_TXOP</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_CWMIN</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_CWMAX</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_AIFS</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">txq_params</span><span class="o">-&gt;</span><span class="n">ac</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_AC</span><span class="p">]);</span>
	<span class="n">txq_params</span><span class="o">-&gt;</span><span class="n">txop</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_TXOP</span><span class="p">]);</span>
	<span class="n">txq_params</span><span class="o">-&gt;</span><span class="n">cwmin</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_CWMIN</span><span class="p">]);</span>
	<span class="n">txq_params</span><span class="o">-&gt;</span><span class="n">cwmax</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_CWMAX</span><span class="p">]);</span>
	<span class="n">txq_params</span><span class="o">-&gt;</span><span class="n">aifs</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_AIFS</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq_params</span><span class="o">-&gt;</span><span class="n">ac</span> <span class="o">&gt;=</span> <span class="n">NL80211_NUM_ACS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nl80211_can_set_dev_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * You can only set the channel explicitly for AP, mesh</span>
<span class="cm">	 * and WDS type interfaces; all others have their channel</span>
<span class="cm">	 * managed via their respective &quot;establish a connection&quot;</span>
<span class="cm">	 * command (connect, join, ...)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Monitors are special as they are normally slaved to</span>
<span class="cm">	 * whatever else is going on, so they behave as though</span>
<span class="cm">	 * you tried setting the wiphy channel itself.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">wdev</span> <span class="o">||</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_WDS</span> <span class="o">||</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">||</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">||</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nl80211_valid_channel_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="o">*</span><span class="n">channel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tmp</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_HT20</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tmp</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_HT40PLUS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tmp</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_HT40MINUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel_type</span><span class="p">)</span>
		<span class="o">*</span><span class="n">channel_type</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__nl80211_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_can_set_dev_channel</span><span class="p">(</span><span class="n">wdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">nl80211_valid_channel_type</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">cfg80211_set_freq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wdev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">);</span>
		<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">cfg80211_set_freq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">__nl80211_set_channel</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_wds_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wds_peer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wds_peer</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_wiphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rem_txq_params</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_txq_params</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retry_short</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retry_long</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frag_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rts_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">coverage_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to find the wiphy and netdev. Normally this</span>
<span class="cm">	 * function shouldn&#39;t need the netdev, but this is</span>
<span class="cm">	 * done for backward compatibility -- previously</span>
<span class="cm">	 * setting the channel was done per wiphy, but now</span>
<span class="cm">	 * it is per netdev. Previous userland like hostapd</span>
<span class="cm">	 * also passed a netdev to set_wiphy, so that it is</span>
<span class="cm">	 * possible to let that go to the right netdev!</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ifindex</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFINDEX</span><span class="p">]);</span>

		<span class="n">netdev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">ifindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">&amp;&amp;</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">__cfg80211_rdev_from_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">nl80211_can_set_dev_channel</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">))</span>
		<span class="n">wdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * end workaround code, by now the rdev is available</span>
<span class="cm">	 * and locked, and wdev may or may not be NULL.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_NAME</span><span class="p">])</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">cfg80211_dev_rename</span><span class="p">(</span>
			<span class="n">rdev</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_NAME</span><span class="p">]));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_TXQ_PARAMS</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_txq_params</span> <span class="n">txq_params</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXQ_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_txq_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">nl_txq_params</span><span class="p">,</span>
				    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_TXQ_PARAMS</span><span class="p">],</span>
				    <span class="n">rem_txq_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nla_parse</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_TXQ_ATTR_MAX</span><span class="p">,</span>
				  <span class="n">nla_data</span><span class="p">(</span><span class="n">nl_txq_params</span><span class="p">),</span>
				  <span class="n">nla_len</span><span class="p">(</span><span class="n">nl_txq_params</span><span class="p">),</span>
				  <span class="n">txq_params_policy</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">parse_txq_params</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq_params</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_txq_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
							   <span class="n">netdev</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">txq_params</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">__nl80211_set_channel</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_TX_POWER_SETTING</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">nl80211_tx_power_setting</span> <span class="n">type</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mbm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tx_power</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">NL80211_ATTR_WIPHY_TX_POWER_SETTING</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_TX_POWER_LEVEL</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_TX_POWER_AUTOMATIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_TX_POWER_AUTOMATIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">NL80211_ATTR_WIPHY_TX_POWER_LEVEL</span><span class="p">;</span>
			<span class="n">mbm</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tx_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">mbm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_ANTENNA_TX</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_ANTENNA_RX</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">rx_ant</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_tx</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_rx</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_antenna</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tx_ant</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_ANTENNA_TX</span><span class="p">]);</span>
		<span class="n">rx_ant</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_ANTENNA_RX</span><span class="p">]);</span>

		<span class="cm">/* reject antenna configurations which don&#39;t match the</span>
<span class="cm">		 * available antenna masks, except for the &quot;all&quot; mask */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="n">tx_ant</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_ant</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_tx</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">~</span><span class="n">rx_ant</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_ant</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_rx</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tx_ant</span> <span class="o">=</span> <span class="n">tx_ant</span> <span class="o">&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_tx</span><span class="p">;</span>
		<span class="n">rx_ant</span> <span class="o">=</span> <span class="n">rx_ant</span> <span class="o">&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">available_antennas_rx</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_antenna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">rx_ant</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RETRY_SHORT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">retry_short</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RETRY_SHORT</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry_short</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">WIPHY_PARAM_RETRY_SHORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RETRY_LONG</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">retry_long</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RETRY_LONG</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry_long</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">WIPHY_PARAM_RETRY_LONG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FRAG_THRESHOLD</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FRAG_THRESHOLD</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag_threshold</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag_threshold</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Fragments (apart from the last one) are required to</span>
<span class="cm">			 * have even length. Make the fragmentation code</span>
<span class="cm">			 * simpler by stripping LSB should someone try to use</span>
<span class="cm">			 * odd threshold value.</span>
<span class="cm">			 */</span>
			<span class="n">frag_threshold</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">WIPHY_PARAM_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RTS_THRESHOLD</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_RTS_THRESHOLD</span><span class="p">]);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">WIPHY_PARAM_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_COVERAGE_CLASS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">coverage_class</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_COVERAGE_CLASS</span><span class="p">]);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">WIPHY_PARAM_COVERAGE_CLASS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">old_retry_short</span><span class="p">,</span> <span class="n">old_retry_long</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">old_frag_threshold</span><span class="p">,</span> <span class="n">old_rts_threshold</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">old_coverage_class</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wiphy_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">old_retry_short</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_short</span><span class="p">;</span>
		<span class="n">old_retry_long</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_long</span><span class="p">;</span>
		<span class="n">old_frag_threshold</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">frag_threshold</span><span class="p">;</span>
		<span class="n">old_rts_threshold</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">rts_threshold</span><span class="p">;</span>
		<span class="n">old_coverage_class</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">coverage_class</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RETRY_SHORT</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_short</span> <span class="o">=</span> <span class="n">retry_short</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RETRY_LONG</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_long</span> <span class="o">=</span> <span class="n">retry_long</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_FRAG_THRESHOLD</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">frag_threshold</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RTS_THRESHOLD</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">rts_threshold</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_COVERAGE_CLASS</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">coverage_class</span> <span class="o">=</span> <span class="n">coverage_class</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wiphy_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_short</span> <span class="o">=</span> <span class="n">old_retry_short</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">retry_long</span> <span class="o">=</span> <span class="n">old_retry_long</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">old_frag_threshold</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">old_rts_threshold</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">coverage_class</span> <span class="o">=</span> <span class="n">old_coverage_class</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">bad_res:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_send_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">NL80211_CMD_NEW_INTERFACE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_string</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFNAME</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFTYPE</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_GENERATION</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_generation</span> <span class="o">^</span>
			<span class="p">(</span><span class="n">cfg80211_rdev_list_generation</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">;</span>

		<span class="n">chan</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">,</span>
				    <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">,</span>
				    <span class="n">channel_type</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_dump_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wp_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">if_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wp_start</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">if_start</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg80211_rdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wp_idx</span> <span class="o">&lt;</span> <span class="n">wp_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wp_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">if_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">if_idx</span> <span class="o">&lt;</span> <span class="n">if_start</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">if_idx</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_iface</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					       <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
					       <span class="n">rdev</span><span class="p">,</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">if_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">devlist_mtx</span><span class="p">);</span>

		<span class="n">wp_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp_idx</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">if_idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_iface</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">dev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">mntr_flags_policy</span><span class="p">[</span><span class="n">NL80211_MNTR_FLAG_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_MNTR_FLAG_FCSFAIL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MNTR_FLAG_PLCPFAIL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MNTR_FLAG_CONTROL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MNTR_FLAG_OTHER_BSS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MNTR_FLAG_COOK_FRAMES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_monitor_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">mntrflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">flags</span><span class="p">[</span><span class="n">NL80211_MNTR_FLAG_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mntrflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nla</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">NL80211_MNTR_FLAG_MAX</span><span class="p">,</span>
			     <span class="n">nla</span><span class="p">,</span> <span class="n">mntr_flags_policy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">flag</span> <span class="o">&lt;=</span> <span class="n">NL80211_MNTR_FLAG_MAX</span><span class="p">;</span> <span class="n">flag</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">[</span><span class="n">flag</span><span class="p">])</span>
			<span class="o">*</span><span class="n">mntrflags</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_valid_4addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">use_4addr</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">iftype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_4addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_BRIDGE_PORT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_4ADDR_AP</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_4ADDR_STATION</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">vif_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">otype</span><span class="p">,</span> <span class="n">ntype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">_flags</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">change</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">otype</span> <span class="o">=</span> <span class="n">ntype</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFTYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ntype</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFTYPE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">otype</span> <span class="o">!=</span> <span class="n">ntype</span><span class="p">)</span>
			<span class="n">change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ntype</span> <span class="o">&gt;</span> <span class="n">NL80211_IFTYPE_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ntype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
		<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">IEEE80211_MAX_SSID_LEN</span> <span class="o">!=</span>
			     <span class="n">IEEE80211_MAX_MESH_ID_LEN</span><span class="p">);</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_up_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]),</span>
		       <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_up_len</span><span class="p">);</span>
		<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_4ADDR</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">use_4addr</span> <span class="o">=</span> <span class="o">!!</span><span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_4ADDR</span><span class="p">]);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_valid_4addr</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">use_4addr</span><span class="p">,</span> <span class="n">ntype</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">use_4addr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MNTR_FLAGS</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ntype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_monitor_flags</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MNTR_FLAGS</span><span class="p">],</span>
					  <span class="o">&amp;</span><span class="n">_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_flags</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_change_iface</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ntype</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="p">.</span><span class="n">use_4addr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">use_4addr</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">use_4addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_new_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">vif_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFNAME</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFTYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFTYPE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">NL80211_IFTYPE_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_virtual_intf</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">interface_modes</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">type</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_4ADDR</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">use_4addr</span> <span class="o">=</span> <span class="o">!!</span><span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_4ADDR</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_valid_4addr</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">use_4addr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_monitor_flags</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">?</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MNTR_FLAGS</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_virtual_intf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
		<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IFNAME</span><span class="p">]),</span>
		<span class="n">type</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

		<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
		<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">IEEE80211_MAX_SSID_LEN</span> <span class="o">!=</span>
			     <span class="n">IEEE80211_MAX_MESH_ID_LEN</span><span class="p">);</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_up_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]),</span>
		       <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_up_len</span><span class="p">);</span>
		<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_del_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_virtual_intf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_virtual_intf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_noack_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">noack_map</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_NOACK_MAP</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_noack_map</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">noack_map</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_NOACK_MAP</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_noack_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">noack_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">get_key_cookie</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_key_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_key_cookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_DATA</span><span class="p">,</span>
		     <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_SEQ</span><span class="p">,</span>
		     <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_CIPHER</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_KEY_DATA</span><span class="p">,</span>
		     <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_KEY_SEQ</span><span class="p">,</span>
		     <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_KEY_CIPHER</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">,</span> <span class="n">cookie</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
 <span class="nl">nla_put_failure:</span>
	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">key_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pairwise</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_key_cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">])</span>
		<span class="n">key_idx</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_idx</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="n">pairwise</span> <span class="o">=</span> <span class="o">!!</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_TYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">kt</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEY_TYPE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kt</span> <span class="o">&gt;=</span> <span class="n">NUM_NL80211_KEYTYPES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kt</span> <span class="o">!=</span> <span class="n">NL80211_KEYTYPE_GROUP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">kt</span> <span class="o">!=</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pairwise</span> <span class="o">=</span> <span class="n">kt</span> <span class="o">==</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_NEW_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>

	<span class="n">cookie</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">cookie</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">key_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span> <span class="o">&amp;&amp;</span> <span class="n">mac_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_IBSS_RSN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">pairwise</span><span class="p">,</span>
				 <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">get_key_callback</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
 <span class="nl">free_msg:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">key_parse</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_key</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* only support setting default key */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">def</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">defmgmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wdev_lock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">def</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_default_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_key_allowed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_default_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
						 <span class="n">key</span><span class="p">.</span><span class="n">def_uni</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">def_multi</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">def_uni</span> <span class="o">||</span> <span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">def_multi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_default_mgmt_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_key_allowed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_default_mgmt_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
						      <span class="n">dev</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_mgmt_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_new_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">key_parse</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_key</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span>
			<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_GROUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_KEYTYPE_GROUP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg80211_validate_key_settings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
					   <span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">,</span>
					   <span class="n">mac_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wdev_lock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_key_allowed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
					 <span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">,</span>
					 <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
	<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_del_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key_parse</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_key</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span>
			<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_GROUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_KEYTYPE_GROUP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">wdev_lock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_key_allowed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span> <span class="o">&amp;&amp;</span> <span class="n">mac_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_IBSS_RSN</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
					 <span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">,</span>
					 <span class="n">mac_addr</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CFG80211_WEXT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_key</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_key</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_mgmt_key</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wext</span><span class="p">.</span><span class="n">default_mgmt_key</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_parse_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_beacon_data</span> <span class="o">*</span><span class="n">bcn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">haveinfo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_TAIL</span><span class="p">])</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_PROBE_RESP</span><span class="p">])</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_ASSOC_RESP</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bcn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bcn</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_HEAD</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_HEAD</span><span class="p">]);</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">head_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_HEAD</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcn</span><span class="o">-&gt;</span><span class="n">head_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">haveinfo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_TAIL</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_TAIL</span><span class="p">]);</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">tail_len</span> <span class="o">=</span>
		    <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_TAIL</span><span class="p">]);</span>
		<span class="n">haveinfo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">haveinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">beacon_ies</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">beacon_ies_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_PROBE_RESP</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">proberesp_ies</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_PROBE_RESP</span><span class="p">]);</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">proberesp_ies_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_PROBE_RESP</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_ASSOC_RESP</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_ASSOC_RESP</span><span class="p">]);</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">assocresp_ies_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE_ASSOC_RESP</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PROBE_RESP</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">probe_resp</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PROBE_RESP</span><span class="p">]);</span>
		<span class="n">bcn</span><span class="o">-&gt;</span><span class="n">probe_resp_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PROBE_RESP</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_start_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_ap_settings</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">start_ap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="cm">/* these are required for START_AP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_INTERVAL</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DTIM_PERIOD</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_HEAD</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_beacon</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">.</span><span class="n">beacon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">params</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_INTERVAL</span><span class="p">]);</span>
	<span class="n">params</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">=</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DTIM_PERIOD</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_validate_beacon_int</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In theory, some of these attributes should be required here</span>
<span class="cm">	 * but since they were not used when the command was originally</span>
<span class="cm">	 * added, keep them optional for old user space programs to let</span>
<span class="cm">	 * them continue to work with drivers that do not need the</span>
<span class="cm">	 * additional information -- drivers must check!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>
		<span class="n">params</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">params</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HIDDEN_SSID</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">hidden_ssid</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HIDDEN_SSID</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">hidden_ssid</span> <span class="o">!=</span> <span class="n">NL80211_HIDDEN_SSID_NOT_IN_USE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">params</span><span class="p">.</span><span class="n">hidden_ssid</span> <span class="o">!=</span> <span class="n">NL80211_HIDDEN_SSID_ZERO_LEN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">params</span><span class="p">.</span><span class="n">hidden_ssid</span> <span class="o">!=</span> <span class="n">NL80211_HIDDEN_SSID_ZERO_CONTENTS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">params</span><span class="p">.</span><span class="n">privacy</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PRIVACY</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AUTH_TYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AUTH_TYPE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_valid_auth_type</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">auth_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">params</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_crypto_settings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">.</span><span class="n">crypto</span><span class="p">,</span>
				      <span class="n">NL80211_MAX_NR_CIPHER_SUITES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_INACTIVITY_TIMEOUT</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NL80211_FEATURE_INACTIVITY_TIMER</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">inactivity_timeout</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_INACTIVITY_TIMEOUT</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">start_ap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_beacon_data</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_beacon</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_beacon</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_beacon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_stop_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">stop_ap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">stop_ap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">sta_flags_policy</span><span class="p">[</span><span class="n">NL80211_STA_FLAG_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_STA_FLAG_SHORT_PREAMBLE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_station_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">iftype</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">station_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">flags</span><span class="p">[</span><span class="n">NL80211_STA_FLAG_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try parsing the new attribute first so userspace</span>
<span class="cm">	 * can specify both for older kernels.</span>
<span class="cm">	 */</span>
	<span class="n">nla</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_FLAGS2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nl80211_sta_flag_update</span> <span class="o">*</span><span class="n">sta_flags</span><span class="p">;</span>

		<span class="n">sta_flags</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span> <span class="o">=</span> <span class="n">sta_flags</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_set</span> <span class="o">=</span> <span class="n">sta_flags</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span> <span class="o">|</span>
		     <span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">__NL80211_STA_FLAG_INVALID</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if present, parse the old attribute */</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_FLAGS</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nla</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">NL80211_STA_FLAG_MAX</span><span class="p">,</span>
			     <span class="n">nla</span><span class="p">,</span> <span class="n">sta_flags_policy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only allow certain flags for interface types so that</span>
<span class="cm">	 * other attributes are silently ignored. Remember that</span>
<span class="cm">	 * this is backward compatibility code with old userspace</span>
<span class="cm">	 * and shouldn&#39;t be hit in other cases anyway.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">flag</span> <span class="o">&lt;=</span> <span class="n">NL80211_STA_FLAG_MAX</span><span class="p">;</span> <span class="n">flag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">[</span><span class="n">flag</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_set</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">flag</span><span class="p">);</span>

			<span class="cm">/* no longer support new API additions in old API */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&gt;</span> <span class="n">NL80211_STA_FLAG_MAX_OLD_API</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nl80211_put_sta_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rate_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bitrate</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="cm">/* cfg80211_calculate_bitrate will return 0 for mcs &gt;= 32 */</span>
	<span class="n">bitrate</span> <span class="o">=</span> <span class="n">cfg80211_calculate_bitrate</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bitrate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_RATE_INFO_BITRATE</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RATE_INFO_FLAGS_MCS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_RATE_INFO_MCS</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RATE_INFO_FLAGS_40_MHZ_WIDTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_RATE_INFO_40_MHZ_WIDTH</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RATE_INFO_FLAGS_SHORT_GI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_RATE_INFO_SHORT_GI</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_send_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">sinfoattr</span><span class="p">,</span> <span class="o">*</span><span class="n">bss_param</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">NL80211_CMD_NEW_STATION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_GENERATION</span><span class="p">,</span> <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">sinfoattr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_STA_INFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sinfoattr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_CONNECTED_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_CONNECTED_TIME</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">connected_time</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_INACTIVE_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_INACTIVE_TIME</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">inactive_time</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_RX_BYTES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_RX_BYTES</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_TX_BYTES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_TX_BYTES</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_LLID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_LLID</span><span class="p">,</span> <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">llid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_PLID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_PLID</span><span class="p">,</span> <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">plid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_PLINK_STATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_PLINK_STATE</span><span class="p">,</span>
		       <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">plink_state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">signal_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CFG80211_SIGNAL_TYPE_MBM</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_SIGNAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_SIGNAL</span><span class="p">,</span>
			       <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_SIGNAL_AVG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_SIGNAL_AVG</span><span class="p">,</span>
			       <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal_avg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_TX_BITRATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_put_sta_rate</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">,</span>
					  <span class="n">NL80211_STA_INFO_TX_BITRATE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_RX_BITRATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_put_sta_rate</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rxrate</span><span class="p">,</span>
					  <span class="n">NL80211_STA_INFO_RX_BITRATE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_RX_PACKETS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_RX_PACKETS</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_TX_PACKETS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_TX_PACKETS</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_TX_RETRIES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_TX_RETRIES</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_retries</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_TX_FAILED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_TX_FAILED</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_failed</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_BEACON_LOSS_COUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_BEACON_LOSS</span><span class="p">,</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">beacon_loss_count</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_BSS_PARAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss_param</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_BSS_PARAM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_param</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BSS_PARAM_FLAGS_CTS_PROT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_BSS_PARAM_CTS_PROT</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BSS_PARAM_FLAGS_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_BSS_PARAM_SHORT_PREAMBLE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BSS_PARAM_FLAGS_SHORT_SLOT_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_BSS_PARAM_SHORT_SLOT_TIME</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_BSS_PARAM_DTIM_PERIOD</span><span class="p">,</span>
			       <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">dtim_period</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_BSS_PARAM_BEACON_INTERVAL</span><span class="p">,</span>
				<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bss_param</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_STA_FLAGS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_STA_FLAGS</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nl80211_sta_flag_update</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_T_OFFSET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_STA_INFO_T_OFFSET</span><span class="p">,</span>
			    <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">t_offset</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sinfoattr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_ASSOC_REQ_IES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IE</span><span class="p">,</span> <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">assoc_req_ies_len</span><span class="p">,</span>
		    <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">assoc_req_ies</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_dump_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">station_info</span> <span class="n">sinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sta_idx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_prepare_netdev_dump</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_station</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sinfo</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_station</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">,</span>
					     <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_station</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
				<span class="n">dev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">sta_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>


 <span class="nl">out:</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
 <span class="nl">out_err:</span>
	<span class="n">nl80211_finish_netdev_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">station_info</span> <span class="n">sinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sinfo</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_station</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_station</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_station</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get vlan interface making sure it is running and on the right wiphy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">get_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">vlanattr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_VLAN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vlanattr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">vlanattr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">||</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">station_parameters</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">params</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">plink_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_AID</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_SUPPORTED_RATES</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">supported_rates</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_SUPPORTED_RATES</span><span class="p">]);</span>
		<span class="n">params</span><span class="p">.</span><span class="n">supported_rates_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_SUPPORTED_RATES</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_LISTEN_INTERVAL</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">=</span>
		    <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_LISTEN_INTERVAL</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">ht_capa</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_station</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_station_flags</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_ACTION</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">plink_action</span> <span class="o">=</span>
		    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_ACTION</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_STATE</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">plink_state</span> <span class="o">=</span>
		    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_STATE</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
		<span class="cm">/* disallow mesh-specific things */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">plink_action</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* TDLS can&#39;t be set, ... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * ... but don&#39;t bother the driver with it. This works around</span>
<span class="cm">		 * a hostapd/wpa_supplicant issue -- it always includes the</span>
<span class="cm">		 * TLDS_PEER flag in the mask even for AP mode.</span>
<span class="cm">		 */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">sta_flags_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">);</span>

		<span class="cm">/* accept only the listed bits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_mask</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* must be last in here for error handling */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">vlan</span> <span class="o">=</span> <span class="n">get_vlan</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t allow userspace to change the TDLS_PEER flag,</span>
<span class="cm">		 * but silently ignore attempts to change it since we</span>
<span class="cm">		 * don&#39;t have state here to verify that it doesn&#39;t try</span>
<span class="cm">		 * to change the flag.</span>
<span class="cm">		 */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">sta_flags_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="cm">/* disallow things sta doesn&#39;t support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">plink_action</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* reject any changes other than AUTHORIZED */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="cm">/* disallow things mesh doesn&#39;t support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * No special handling for TDLS here -- the userspace</span>
<span class="cm">		 * mesh code doesn&#39;t have this bug.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_mask</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* be aware of params.vlan when changing code here */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_station</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nla_policy</span>
<span class="n">nl80211_sta_wme_policy</span><span class="p">[</span><span class="n">NL80211_STA_WME_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_STA_WME_UAPSD_QUEUES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_STA_WME_MAX_SP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_new_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">station_parameters</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_LISTEN_INTERVAL</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_SUPPORTED_RATES</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_AID</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>
	<span class="n">params</span><span class="p">.</span><span class="n">supported_rates</span> <span class="o">=</span>
		<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_SUPPORTED_RATES</span><span class="p">]);</span>
	<span class="n">params</span><span class="p">.</span><span class="n">supported_rates_len</span> <span class="o">=</span>
		<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_SUPPORTED_RATES</span><span class="p">]);</span>
	<span class="n">params</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">=</span>
		<span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_LISTEN_INTERVAL</span><span class="p">]);</span>

	<span class="n">params</span><span class="p">.</span><span class="n">aid</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_AID</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">.</span><span class="n">aid</span> <span class="o">||</span> <span class="n">params</span><span class="p">.</span><span class="n">aid</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_AID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">ht_capa</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_ACTION</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">plink_action</span> <span class="o">=</span>
		    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_PLINK_ACTION</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_station</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_station_flags</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
		<span class="cm">/* parse WME attributes if sta is WME capable */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_AP_UAPSD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_WME</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_STA_WME_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>

			<span class="n">nla</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STA_WME</span><span class="p">];</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_STA_WME_MAX</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span>
					       <span class="n">nl80211_sta_wme_policy</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_STA_WME_UAPSD_QUEUES</span><span class="p">])</span>
				<span class="n">params</span><span class="p">.</span><span class="n">uapsd_queues</span> <span class="o">=</span>
				     <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_STA_WME_UAPSD_QUEUES</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">uapsd_queues</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="n">IEEE80211_WMM_IE_STA_QOSINFO_AC_MASK</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_STA_WME_MAX_SP</span><span class="p">])</span>
				<span class="n">params</span><span class="p">.</span><span class="n">max_sp</span> <span class="o">=</span>
				     <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_STA_WME_MAX_SP</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">max_sp</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="n">IEEE80211_WMM_IE_STA_QOSINFO_SP_MASK</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">params</span><span class="p">.</span><span class="n">sta_modify_mask</span> <span class="o">|=</span> <span class="n">STATION_PARAM_APPLY_UAPSD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* TDLS peers cannot be added */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* but don&#39;t bother the driver with it */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">sta_flags_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">);</span>

		<span class="cm">/* must be last in here for error handling */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">vlan</span> <span class="o">=</span> <span class="n">get_vlan</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="cm">/* TDLS peers cannot be added */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="cm">/* Only TDLS peers can be added */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">sta_flags_set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Can only add if TDLS ... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="cm">/* ... with external setup is supported */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_TDLS_EXTERNAL_SETUP</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* be aware of params.vlan when changing code here */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_station</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">vlan</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_del_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_station</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_station</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_send_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mpath_info</span> <span class="o">*</span><span class="n">pinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pinfoattr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">NL80211_CMD_NEW_STATION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MPATH_NEXT_HOP</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_GENERATION</span><span class="p">,</span> <span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">pinfoattr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MPATH_INFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pinfoattr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">MPATH_INFO_FRAME_QLEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MPATH_INFO_FRAME_QLEN</span><span class="p">,</span>
			<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">frame_qlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">MPATH_INFO_SN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MPATH_INFO_SN</span><span class="p">,</span> <span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">MPATH_INFO_METRIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MPATH_INFO_METRIC</span><span class="p">,</span>
			 <span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">metric</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">MPATH_INFO_EXPTIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MPATH_INFO_EXPTIME</span><span class="p">,</span>
			 <span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">exptime</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">MPATH_INFO_FLAGS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MPATH_INFO_FLAGS</span><span class="p">,</span>
			<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">MPATH_INFO_DISCOVERY_TIMEOUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MPATH_INFO_DISCOVERY_TIMEOUT</span><span class="p">,</span>
			 <span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">discovery_timeout</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">MPATH_INFO_DISCOVERY_RETRIES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MPATH_INFO_DISCOVERY_RETRIES</span><span class="p">,</span>
			<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">discovery_retries</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pinfoattr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_dump_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpath_info</span> <span class="n">pinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dst</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">next_hop</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">path_idx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_prepare_netdev_dump</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_mpath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">path_idx</span><span class="p">,</span>
					   <span class="n">dst</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_mpath</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
				       <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
				       <span class="n">netdev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">pinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">path_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>


 <span class="nl">out:</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_idx</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
 <span class="nl">out_err:</span>
	<span class="n">nl80211_finish_netdev_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mpath_info</span> <span class="n">pinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">next_hop</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pinfo</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mpath</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mpath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_mpath</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MPATH_NEXT_HOP</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>
	<span class="n">next_hop</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MPATH_NEXT_HOP</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_mpath</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_mpath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_new_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MPATH_NEXT_HOP</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>
	<span class="n">next_hop</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MPATH_NEXT_HOP</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_mpath</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_mpath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_del_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_mpath</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_mpath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bss_parameters</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="cm">/* default to not changing parameters */</span>
	<span class="n">params</span><span class="p">.</span><span class="n">use_cts_prot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">use_short_preamble</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">use_short_slot_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">ap_isolate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">ht_opmode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_CTS_PROT</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">use_cts_prot</span> <span class="o">=</span>
		    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_CTS_PROT</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_SHORT_PREAMBLE</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">use_short_preamble</span> <span class="o">=</span>
		    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_SHORT_PREAMBLE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_SHORT_SLOT_TIME</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">use_short_slot_time</span> <span class="o">=</span>
		    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_SHORT_SLOT_TIME</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_BASIC_RATES</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">basic_rates</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_BASIC_RATES</span><span class="p">]);</span>
		<span class="n">params</span><span class="p">.</span><span class="n">basic_rates_len</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_BASIC_RATES</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AP_ISOLATE</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">ap_isolate</span> <span class="o">=</span> <span class="o">!!</span><span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AP_ISOLATE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_HT_OPMODE</span><span class="p">])</span>
		<span class="n">params</span><span class="p">.</span><span class="n">ht_opmode</span> <span class="o">=</span>
			<span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_HT_OPMODE</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_bss</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">change_bss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">reg_rule_policy</span><span class="p">[</span><span class="n">NL80211_REG_RULE_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_REG_RULE_FLAGS</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_START</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_END</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_MAX_BW</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_POWER_RULE_MAX_ANT_GAIN</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_POWER_RULE_MAX_EIRP</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_reg_rule</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[],</span>
	<span class="k">struct</span> <span class="n">ieee80211_reg_rule</span> <span class="o">*</span><span class="n">reg_rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_freq_range</span> <span class="o">*</span><span class="n">freq_range</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg_rule</span><span class="o">-&gt;</span><span class="n">freq_range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_power_rule</span> <span class="o">*</span><span class="n">power_rule</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg_rule</span><span class="o">-&gt;</span><span class="n">power_rule</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_RULE_FLAGS</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_START</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_END</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_MAX_BW</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_POWER_RULE_MAX_EIRP</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reg_rule</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_RULE_FLAGS</span><span class="p">]);</span>

	<span class="n">freq_range</span><span class="o">-&gt;</span><span class="n">start_freq_khz</span> <span class="o">=</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_START</span><span class="p">]);</span>
	<span class="n">freq_range</span><span class="o">-&gt;</span><span class="n">end_freq_khz</span> <span class="o">=</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_END</span><span class="p">]);</span>
	<span class="n">freq_range</span><span class="o">-&gt;</span><span class="n">max_bandwidth_khz</span> <span class="o">=</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_FREQ_RANGE_MAX_BW</span><span class="p">]);</span>

	<span class="n">power_rule</span><span class="o">-&gt;</span><span class="n">max_eirp</span> <span class="o">=</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_POWER_RULE_MAX_EIRP</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_POWER_RULE_MAX_ANT_GAIN</span><span class="p">])</span>
		<span class="n">power_rule</span><span class="o">-&gt;</span><span class="n">max_antenna_gain</span> <span class="o">=</span>
			<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_POWER_RULE_MAX_ANT_GAIN</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_req_set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * You should only get this when cfg80211 hasn&#39;t yet initialized</span>
<span class="cm">	 * completely when built-in to the kernel right between the time</span>
<span class="cm">	 * window between nl80211_init() and regulatory_init(), if that is</span>
<span class="cm">	 * even possible.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">cfg80211_regdomain</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_ALPHA2</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_ALPHA2</span><span class="p">]);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">regulatory_hint_user</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_mesh_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_config</span> <span class="n">cur_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pinfoattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mesh_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="cm">/* If not connected, get default parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_mesh_config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cur_params</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mesh_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">cur_params</span><span class="p">);</span>
	<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Draw up a netlink message to send back */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_GET_MESH_CONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">pinfoattr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MESH_CONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pinfoattr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_RETRY_TIMEOUT</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshRetryTimeout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_CONFIRM_TIMEOUT</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshConfirmTimeout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HOLDING_TIMEOUT</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHoldingTimeout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_MAX_PEER_LINKS</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshMaxPeerLinks</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_MAX_RETRIES</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshMaxRetries</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_TTL</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshTTL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_ELEMENT_TTL</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">element_ttl</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_AUTO_OPEN_PLINKS</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">auto_open_plinks</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_SYNC_OFFSET_MAX_NEIGHBOR</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshNbrOffsetMaxNeighbor</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_MAX_PREQ_RETRIES</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHWMPmaxPREQretries</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_PATH_REFRESH_TIME</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">path_refresh_time</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_MIN_DISCOVERY_TIMEOUT</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">min_discovery_timeout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_ACTIVE_PATH_TIMEOUT</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHWMPactivePathTimeout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_PREQ_MIN_INTERVAL</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHWMPpreqMinInterval</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_PERR_MIN_INTERVAL</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHWMPperrMinInterval</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_NET_DIAM_TRVS_TIME</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHWMPnetDiameterTraversalTime</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_ROOTMODE</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHWMPRootMode</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_RANN_INTERVAL</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshHWMPRannInterval</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_GATE_ANNOUNCEMENTS</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshGateAnnouncementProtocol</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_FORWARDING</span><span class="p">,</span>
		       <span class="n">cur_params</span><span class="p">.</span><span class="n">dot11MeshForwarding</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_RSSI_THRESHOLD</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">rssi_threshold</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HT_OPMODE</span><span class="p">,</span>
			<span class="n">cur_params</span><span class="p">.</span><span class="n">ht_opmode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pinfoattr</span><span class="p">);</span>
	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">nl80211_meshconf_params_policy</span><span class="p">[</span><span class="n">NL80211_MESHCONF_ATTR_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_RETRY_TIMEOUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_CONFIRM_TIMEOUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HOLDING_TIMEOUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_MAX_PEER_LINKS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_MAX_RETRIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_TTL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_ELEMENT_TTL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_AUTO_OPEN_PLINKS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_SYNC_OFFSET_MAX_NEIGHBOR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>

	<span class="p">[</span><span class="n">NL80211_MESHCONF_HWMP_MAX_PREQ_RETRIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_PATH_REFRESH_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_MIN_DISCOVERY_TIMEOUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HWMP_ACTIVE_PATH_TIMEOUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HWMP_PREQ_MIN_INTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HWMP_PERR_MIN_INTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HWMP_NET_DIAM_TRVS_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HWMP_ROOTMODE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HWMP_RANN_INTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_GATE_ANNOUNCEMENTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_FORWARDING</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_RSSI_THRESHOLD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESHCONF_HT_OPMODE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span>
	<span class="n">nl80211_mesh_setup_params_policy</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ATTR_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_SYNC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_PATH_SEL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_METRIC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESH_SETUP_USERSPACE_AUTH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESH_SETUP_IE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_MESH_SETUP_USERSPACE_AMPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_parse_mesh_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mesh_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="o">*</span><span class="n">mask_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESHCONF_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define FILL_IN_MESH_PARAM_IF_SET(table, cfg, param, mask, attr_num, nla_fn) \</span>
<span class="cp">do {\</span>
<span class="cp">	if (table[attr_num]) {\</span>
<span class="cp">		cfg-&gt;param = nla_fn(table[attr_num]); \</span>
<span class="cp">		mask |= (1 &lt;&lt; (attr_num - 1)); \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0);\</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_CONFIG</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_ATTR_MAX</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_CONFIG</span><span class="p">],</span>
			     <span class="n">nl80211_meshconf_params_policy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* This makes sure that there aren&#39;t more than 32 mesh config</span>
<span class="cm">	 * parameters (otherwise our bitfield scheme would not work.) */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">NL80211_MESHCONF_ATTR_MAX</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Fill in the params struct */</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshRetryTimeout</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_RETRY_TIMEOUT</span><span class="p">,</span> <span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshConfirmTimeout</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_CONFIRM_TIMEOUT</span><span class="p">,</span> <span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshHoldingTimeout</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HOLDING_TIMEOUT</span><span class="p">,</span> <span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshMaxPeerLinks</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_MAX_PEER_LINKS</span><span class="p">,</span> <span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshMaxRetries</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_MAX_RETRIES</span><span class="p">,</span> <span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshTTL</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_TTL</span><span class="p">,</span> <span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">element_ttl</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_ELEMENT_TTL</span><span class="p">,</span> <span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">auto_open_plinks</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_AUTO_OPEN_PLINKS</span><span class="p">,</span> <span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshNbrOffsetMaxNeighbor</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_SYNC_OFFSET_MAX_NEIGHBOR</span><span class="p">,</span>
			<span class="n">nla_get_u32</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshHWMPmaxPREQretries</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_MAX_PREQ_RETRIES</span><span class="p">,</span>
			<span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">path_refresh_time</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_PATH_REFRESH_TIME</span><span class="p">,</span> <span class="n">nla_get_u32</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">min_discovery_timeout</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_MIN_DISCOVERY_TIMEOUT</span><span class="p">,</span>
			<span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshHWMPactivePathTimeout</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_ACTIVE_PATH_TIMEOUT</span><span class="p">,</span>
			<span class="n">nla_get_u32</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshHWMPpreqMinInterval</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_PREQ_MIN_INTERVAL</span><span class="p">,</span>
			<span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshHWMPperrMinInterval</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_PERR_MIN_INTERVAL</span><span class="p">,</span>
			<span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span>
			<span class="n">dot11MeshHWMPnetDiameterTraversalTime</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HWMP_NET_DIAM_TRVS_TIME</span><span class="p">,</span>
			<span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span>
			<span class="n">dot11MeshHWMPRootMode</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
			<span class="n">NL80211_MESHCONF_HWMP_ROOTMODE</span><span class="p">,</span>
			<span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span>
			<span class="n">dot11MeshHWMPRannInterval</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
			<span class="n">NL80211_MESHCONF_HWMP_RANN_INTERVAL</span><span class="p">,</span>
			<span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span>
			<span class="n">dot11MeshGateAnnouncementProtocol</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
			<span class="n">NL80211_MESHCONF_GATE_ANNOUNCEMENTS</span><span class="p">,</span>
			<span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dot11MeshForwarding</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_FORWARDING</span><span class="p">,</span> <span class="n">nla_get_u8</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">rssi_threshold</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_RSSI_THRESHOLD</span><span class="p">,</span> <span class="n">nla_get_u32</span><span class="p">);</span>
	<span class="n">FILL_IN_MESH_PARAM_IF_SET</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">ht_opmode</span><span class="p">,</span>
			<span class="n">mask</span><span class="p">,</span> <span class="n">NL80211_MESHCONF_HT_OPMODE</span><span class="p">,</span> <span class="n">nla_get_u16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask_out</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mask_out</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#undef FILL_IN_MESH_PARAM_IF_SET</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_parse_mesh_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mesh_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_SETUP</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_MESH_SETUP_ATTR_MAX</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_SETUP</span><span class="p">],</span>
			     <span class="n">nl80211_mesh_setup_params_policy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_SYNC</span><span class="p">])</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">sync_method</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_SYNC</span><span class="p">]))</span> <span class="o">?</span>
		 <span class="n">IEEE80211_SYNC_METHOD_VENDOR</span> <span class="o">:</span>
		 <span class="n">IEEE80211_SYNC_METHOD_NEIGHBOR_OFFSET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_PATH_SEL</span><span class="p">])</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">path_sel_proto</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_PATH_SEL</span><span class="p">]))</span> <span class="o">?</span>
		 <span class="n">IEEE80211_PATH_PROTOCOL_VENDOR</span> <span class="o">:</span>
		 <span class="n">IEEE80211_PATH_PROTOCOL_HWMP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_METRIC</span><span class="p">])</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">path_metric</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_ENABLE_VENDOR_METRIC</span><span class="p">]))</span> <span class="o">?</span>
		 <span class="n">IEEE80211_PATH_METRIC_VENDOR</span> <span class="o">:</span>
		 <span class="n">IEEE80211_PATH_METRIC_AIRTIME</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">ieattr</span> <span class="o">=</span>
			<span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_IE</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">ieattr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">ieattr</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">ieattr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">setup</span><span class="o">-&gt;</span><span class="n">is_authenticated</span> <span class="o">=</span> <span class="n">nla_get_flag</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_USERSPACE_AUTH</span><span class="p">]);</span>
	<span class="n">setup</span><span class="o">-&gt;</span><span class="n">is_secure</span> <span class="o">=</span> <span class="n">nla_get_flag</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_MESH_SETUP_USERSPACE_AMPE</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_update_mesh_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_config</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_mesh_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_mesh_config</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">mesh_id_len</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_mesh_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						    <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>

	<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_reg_rules</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg80211_regdomain</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_GET_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_string</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_ALPHA2</span><span class="p">,</span>
			   <span class="n">cfg80211_regdomain</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cfg80211_regdomain</span><span class="o">-&gt;</span><span class="n">dfs_region</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_DFS_REGION</span><span class="p">,</span>
			<span class="n">cfg80211_regdomain</span><span class="o">-&gt;</span><span class="n">dfs_region</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nl_reg_rules</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_RULES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_reg_rules</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg80211_regdomain</span><span class="o">-&gt;</span><span class="n">n_reg_rules</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_reg_rule</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_reg_rule</span> <span class="o">*</span><span class="n">reg_rule</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_freq_range</span> <span class="o">*</span><span class="n">freq_range</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_power_rule</span> <span class="o">*</span><span class="n">power_rule</span><span class="p">;</span>

		<span class="n">reg_rule</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg80211_regdomain</span><span class="o">-&gt;</span><span class="n">reg_rules</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">freq_range</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg_rule</span><span class="o">-&gt;</span><span class="n">freq_range</span><span class="p">;</span>
		<span class="n">power_rule</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg_rule</span><span class="o">-&gt;</span><span class="n">power_rule</span><span class="p">;</span>

		<span class="n">nl_reg_rule</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_reg_rule</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_RULE_FLAGS</span><span class="p">,</span>
				<span class="n">reg_rule</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FREQ_RANGE_START</span><span class="p">,</span>
				<span class="n">freq_range</span><span class="o">-&gt;</span><span class="n">start_freq_khz</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FREQ_RANGE_END</span><span class="p">,</span>
				<span class="n">freq_range</span><span class="o">-&gt;</span><span class="n">end_freq_khz</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FREQ_RANGE_MAX_BW</span><span class="p">,</span>
				<span class="n">freq_range</span><span class="o">-&gt;</span><span class="n">max_bandwidth_khz</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_POWER_RULE_MAX_ANT_GAIN</span><span class="p">,</span>
				<span class="n">power_rule</span><span class="o">-&gt;</span><span class="n">max_antenna_gain</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_POWER_RULE_MAX_EIRP</span><span class="p">,</span>
				<span class="n">power_rule</span><span class="o">-&gt;</span><span class="n">max_eirp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_reg_rule</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_reg_rules</span><span class="p">);</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
<span class="nl">put_failure:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_REG_RULE_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_reg_rule</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">alpha2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem_reg_rules</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_rules</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rule_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size_of_regd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dfs_region</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_regdomain</span> <span class="o">*</span><span class="n">rd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_ALPHA2</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_RULES</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">alpha2</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_ALPHA2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DFS_REGION</span><span class="p">])</span>
		<span class="n">dfs_region</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DFS_REGION</span><span class="p">]);</span>

	<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">nl_reg_rule</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_RULES</span><span class="p">],</span>
			<span class="n">rem_reg_rules</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_rules</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_rules</span> <span class="o">&gt;</span> <span class="n">NL80211_MAX_SUPP_REG_RULES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg_is_valid_request</span><span class="p">(</span><span class="n">alpha2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size_of_regd</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_regdomain</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">num_rules</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_reg_rule</span><span class="p">));</span>

	<span class="n">rd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size_of_regd</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rd</span><span class="o">-&gt;</span><span class="n">n_reg_rules</span> <span class="o">=</span> <span class="n">num_rules</span><span class="p">;</span>
	<span class="n">rd</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rd</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable DFS master mode if the DFS region was</span>
<span class="cm">	 * not supported or known on this kernel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_supported_dfs_region</span><span class="p">(</span><span class="n">dfs_region</span><span class="p">))</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">dfs_region</span> <span class="o">=</span> <span class="n">dfs_region</span><span class="p">;</span>

	<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">nl_reg_rule</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REG_RULES</span><span class="p">],</span>
			<span class="n">rem_reg_rules</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nla_parse</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_REG_RULE_ATTR_MAX</span><span class="p">,</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">nl_reg_rule</span><span class="p">),</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">nl_reg_rule</span><span class="p">),</span>
			<span class="n">reg_rule_policy</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">parse_reg_rule</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">reg_rules</span><span class="p">[</span><span class="n">rule_idx</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_reg</span><span class="p">;</span>

		<span class="n">rule_idx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rule_idx</span> <span class="o">&gt;</span> <span class="n">NL80211_MAX_SUPP_REG_RULES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_reg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rule_idx</span> <span class="o">!=</span> <span class="n">num_rules</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">set_regdom</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

 <span class="nl">bad_reg:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_scan_freqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">freqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr1</span><span class="p">,</span> <span class="o">*</span><span class="n">attr2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>

	<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr1</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_channels</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Some hardware has a limited channel list for</span>
<span class="cm">		 * scanning, and it is pretty much nonsensical</span>
<span class="cm">		 * to scan for a channel twice, so disallow that</span>
<span class="cm">		 * and don&#39;t require drivers to check that the</span>
<span class="cm">		 * channel list they get isn&#39;t longer than what</span>
<span class="cm">		 * they can scan, as long as they can scan all</span>
<span class="cm">		 * the channels they registered at once.</span>
<span class="cm">		 */</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attr1</span> <span class="o">!=</span> <span class="n">attr2</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attr1</span><span class="p">)</span> <span class="o">==</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attr2</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n_channels</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_trigger_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">n_ssids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wiphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">n_channels</span> <span class="o">=</span> <span class="n">validate_scan_freqs</span><span class="p">(</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n_channels</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
		<span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
				<span class="n">n_channels</span> <span class="o">+=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">])</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
			<span class="n">n_ssids</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ssids</span> <span class="o">&gt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">&gt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ie_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_ssids</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_channels</span>
			<span class="o">+</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ssids</span><span class="p">)</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">n_channels</span><span class="p">];</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">n_ssids</span> <span class="o">=</span> <span class="n">n_ssids</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">)</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span> <span class="o">+</span> <span class="n">n_ssids</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">+</span> <span class="n">n_channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* user specified, bail out if channel not found */</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

			<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* ignore disabled channels */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>

		<span class="cm">/* all channels */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

				<span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span>
		       <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]),</span>
		       <span class="n">request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SUPP_RATES</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span>
				    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SUPP_RATES</span><span class="p">],</span>
				    <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span> <span class="n">nla_type</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">band</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_get_ratemask</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">],</span>
						     <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span>
						     <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span>
						     <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">band</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">no_cck</span> <span class="o">=</span>
		<span class="n">nla_get_flag</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TX_NO_CCK_RATE</span><span class="p">]);</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nl80211_send_scan_start</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_hold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="nl">out_free:</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_start_sched_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_sched_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">n_ssids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_match_sets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">interval</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_SCHED_SCAN_MATCH_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_SCHED_SCAN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sched_scan_start</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_INTERVAL</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">interval</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_INTERVAL</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wiphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">n_channels</span> <span class="o">=</span> <span class="n">validate_scan_freqs</span><span class="p">(</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n_channels</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
				<span class="n">n_channels</span> <span class="o">+=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">])</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">],</span>
				    <span class="n">tmp</span><span class="p">)</span>
			<span class="n">n_ssids</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ssids</span> <span class="o">&gt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_sched_scan_ssids</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_MATCH</span><span class="p">])</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span>
				    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_MATCH</span><span class="p">],</span>
				    <span class="n">tmp</span><span class="p">)</span>
			<span class="n">n_match_sets</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_match_sets</span> <span class="o">&gt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_match_sets</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">&gt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_sched_scan_ie_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_ssids</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">match_sets</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_match_sets</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_channels</span>
			<span class="o">+</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ssids</span><span class="p">)</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">n_channels</span><span class="p">];</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">n_ssids</span> <span class="o">=</span> <span class="n">n_ssids</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">)</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span> <span class="o">+</span> <span class="n">n_ssids</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">+</span> <span class="n">n_channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_match_sets</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">)</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">match_sets</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">)</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">match_sets</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span> <span class="o">+</span> <span class="n">n_ssids</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">match_sets</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">+</span> <span class="n">n_channels</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">n_match_sets</span> <span class="o">=</span> <span class="n">n_match_sets</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* user specified, bail out if channel not found */</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span>
				    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">],</span>
				    <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

			<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* ignore disabled channels */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* all channels */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

				<span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">],</span>
				    <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span>
			       <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_MATCH</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span>
				    <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_MATCH</span><span class="p">],</span>
				    <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">ssid</span><span class="p">;</span>

			<span class="n">nla_parse</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_SCHED_SCAN_MATCH_ATTR_MAX</span><span class="p">,</span>
				  <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span>
				  <span class="n">nl80211_match_policy</span><span class="p">);</span>
			<span class="n">ssid</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="n">NL80211_ATTR_SCHED_SCAN_MATCH_SSID</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">ssid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">match_sets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
				       <span class="n">nla_data</span><span class="p">(</span><span class="n">ssid</span><span class="p">),</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
				<span class="n">request</span><span class="o">-&gt;</span><span class="n">match_sets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span>
					<span class="n">nla_len</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span>
		       <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]),</span>
		       <span class="n">request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sched_scan_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_req</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
		<span class="n">nl80211_send_sched_scan</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					<span class="n">NL80211_CMD_START_SCHED_SCAN</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_stop_sched_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_SCHED_SCAN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sched_scan_stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__cfg80211_stop_sched_scan</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sched_scan_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_send_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_internal_bss</span> <span class="o">*</span><span class="n">intbss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intbss</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="n">ASSERT_WDEV_LOCK</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_NEW_SCAN_RESULTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">genl_dump_check_consistent</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_GENERATION</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_generation</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_BSS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_BSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">information_elements</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len_information_elements</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_INFORMATION_ELEMENTS</span><span class="p">,</span>
		     <span class="n">res</span><span class="o">-&gt;</span><span class="n">len_information_elements</span><span class="p">,</span>
		     <span class="n">res</span><span class="o">-&gt;</span><span class="n">information_elements</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">beacon_ies</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len_beacon_ies</span> <span class="o">&amp;&amp;</span>
	     <span class="n">res</span><span class="o">-&gt;</span><span class="n">beacon_ies</span> <span class="o">!=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">information_elements</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_BEACON_IES</span><span class="p">,</span>
		     <span class="n">res</span><span class="o">-&gt;</span><span class="n">len_beacon_ies</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">beacon_ies</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">tsf</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_TSF</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">tsf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_BEACON_INTERVAL</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_CAPABILITY</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_FREQUENCY</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_SEEN_MS_AGO</span><span class="p">,</span>
			<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">intbss</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">signal_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CFG80211_SIGNAL_TYPE_MBM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_SIGNAL_MBM</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CFG80211_SIGNAL_TYPE_UNSPEC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_SIGNAL_UNSPEC</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">intbss</span> <span class="o">==</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">current_bss</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_STATUS</span><span class="p">,</span>
				<span class="n">NL80211_BSS_STATUS_ASSOCIATED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">intbss</span> <span class="o">==</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">current_bss</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_BSS_STATUS</span><span class="p">,</span>
				<span class="n">NL80211_BSS_STATUS_IBSS_JOINED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bss</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_dump_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_internal_bss</span> <span class="o">*</span><span class="n">scan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_prepare_netdev_dump</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

	<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_lock</span><span class="p">);</span>
	<span class="n">cfg80211_bss_expire</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_generation</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_bss</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
				<span class="n">rdev</span><span class="p">,</span> <span class="n">wdev</span><span class="p">,</span> <span class="n">scan</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bss_lock</span><span class="p">);</span>
	<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">nl80211_finish_netdev_dump</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_send_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">infoattr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_NEW_SURVEY_RESULTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">infoattr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SURVEY_INFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">infoattr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_FREQUENCY</span><span class="p">,</span>
			<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_NOISE</span><span class="p">,</span> <span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_IN_USE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_IN_USE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_CHANNEL_TIME</span><span class="p">,</span>
			<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_CHANNEL_TIME_BUSY</span><span class="p">,</span>
			<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_busy</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_EXT_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_CHANNEL_TIME_EXT_BUSY</span><span class="p">,</span>
			<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_ext_busy</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_CHANNEL_TIME_RX</span><span class="p">,</span>
			<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_rx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_SURVEY_INFO_CHANNEL_TIME_TX</span><span class="p">,</span>
			<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_tx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">infoattr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_dump_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">survey_info</span> <span class="n">survey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">survey_idx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">nl80211_prepare_netdev_dump</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_survey</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_survey</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">survey_idx</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">survey</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="cm">/* Survey without a channel doesn&#39;t make sense */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">survey</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					     <span class="n">survey</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span> <span class="o">||</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">survey_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_survey</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
				<span class="n">netdev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">survey</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">survey_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey_idx</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
 <span class="nl">out_err:</span>
	<span class="n">nl80211_finish_netdev_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nl80211_valid_auth_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">auth_type</span> <span class="o">&lt;=</span> <span class="n">NL80211_AUTHTYPE_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nl80211_valid_wpa_versions</span><span class="p">(</span><span class="n">u32</span> <span class="n">wpa_versions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">NL80211_WPA_VERSION_1</span> <span class="o">|</span>
				  <span class="n">NL80211_WPA_VERSION_2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_authenticate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key_parse</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">local_state_change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AUTH_TYPE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_key</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_KEYTYPE_GROUP</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key</span> <span class="o">||</span> <span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span> <span class="o">||</span>
		     <span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span> <span class="o">!=</span> <span class="n">WLAN_KEY_LEN_WEP40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span> <span class="o">||</span>
		     <span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span> <span class="o">!=</span> <span class="n">WLAN_KEY_LEN_WEP104</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">n_cipher_suites</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">cipher_suites</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">auth</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span> <span class="o">||</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>
	<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">auth_type</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AUTH_TYPE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_valid_auth_type</span><span class="p">(</span><span class="n">auth_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local_state_change</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_LOCAL_STATE_CHANGE</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we no longer track auth state, ignore</span>
<span class="cm">	 * requests to only change local state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local_state_change</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cfg80211_mlme_auth</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
				  <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span>
				  <span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">key_len</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_crypto_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_crypto_settings</span> <span class="o">*</span><span class="n">settings</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">cipher_limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">settings</span><span class="p">));</span>

	<span class="n">settings</span><span class="o">-&gt;</span><span class="n">control_port</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT_ETHERTYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">proto</span><span class="p">;</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT_ETHERTYPE</span><span class="p">]);</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">control_port_ethertype</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_CONTROL_PORT_PROTOCOL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">proto</span> <span class="o">!=</span> <span class="n">ETH_P_PAE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT_NO_ENCRYPT</span><span class="p">])</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">control_port_no_encrypt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">control_port_ethertype</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CIPHER_SUITES_PAIRWISE</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CIPHER_SUITES_PAIRWISE</span><span class="p">]);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CIPHER_SUITES_PAIRWISE</span><span class="p">]);</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">n_ciphers_pairwise</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">n_ciphers_pairwise</span> <span class="o">&gt;</span> <span class="n">cipher_limit</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">ciphers_pairwise</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">n_ciphers_pairwise</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg80211_supported_cipher_suite</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="n">settings</span><span class="o">-&gt;</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CIPHER_SUITE_GROUP</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">cipher_group</span> <span class="o">=</span>
			<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CIPHER_SUITE_GROUP</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg80211_supported_cipher_suite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
						     <span class="n">settings</span><span class="o">-&gt;</span><span class="n">cipher_group</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WPA_VERSIONS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">wpa_versions</span> <span class="o">=</span>
			<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WPA_VERSIONS</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_valid_wpa_versions</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">wpa_versions</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AKM_SUITES</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AKM_SUITES</span><span class="p">]);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AKM_SUITES</span><span class="p">]);</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">n_akm_suites</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">n_akm_suites</span> <span class="o">&gt;</span> <span class="n">NL80211_MAX_NR_AKM_SUITES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">akm_suites</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_crypto_settings</span> <span class="n">crypto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_bssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_mfp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="n">ht_capa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="n">ht_capa_mask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span> <span class="o">||</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>
	<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_USE_MFP</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">nl80211_mfp</span> <span class="n">mfp</span> <span class="o">=</span>
			<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_USE_MFP</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfp</span> <span class="o">==</span> <span class="n">NL80211_MFP_REQUIRED</span><span class="p">)</span>
			<span class="n">use_mfp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mfp</span> <span class="o">!=</span> <span class="n">NL80211_MFP_NO</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PREV_BSSID</span><span class="p">])</span>
		<span class="n">prev_bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PREV_BSSID</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_get_flag</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DISABLE_HT</span><span class="p">]))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">ASSOC_REQ_DISABLE_HT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY_MASK</span><span class="p">])</span>
		<span class="n">ht_capa_mask</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY_MASK</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ht_capa_mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ht_capa</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_crypto_settings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypto</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_mlme_assoc</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">prev_bssid</span><span class="p">,</span>
					  <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">use_mfp</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">crypto</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">ht_capa</span><span class="p">,</span>
					  <span class="n">ht_capa_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_deauthenticate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">local_state_change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">deauth</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="n">reason_code</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reason Code 0 is reserved */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">local_state_change</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_LOCAL_STATE_CHANGE</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">cfg80211_mlme_deauth</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">,</span>
				    <span class="n">local_state_change</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_disassociate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">local_state_change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disassoc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="n">reason_code</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reason Code 0 is reserved */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">local_state_change</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_LOCAL_STATE_CHANGE</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">cfg80211_mlme_disassoc</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">,</span>
				      <span class="n">local_state_change</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">nl80211_parse_mcast_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">mcast_rate</span><span class="p">[</span><span class="n">IEEE80211_NUM_BANDS</span><span class="p">],</span>
			 <span class="kt">int</span> <span class="n">rateval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">band</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>

		<span class="n">sband</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">rateval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mcast_rate</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_join_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="n">ibss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_cached_keys</span> <span class="o">*</span><span class="n">connkeys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ibss</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ibss</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_INTERVAL</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ibss</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span>
			<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BEACON_INTERVAL</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibss</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ibss</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">join_ibss</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">wiphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ibss</span><span class="p">.</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ibss</span><span class="p">.</span><span class="n">bssid</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ibss</span><span class="p">.</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>
	<span class="n">ibss</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ibss</span><span class="p">.</span><span class="n">ie</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">ibss</span><span class="p">.</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_valid_channel_type</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">channel_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NL80211_FEATURE_HT_IBSS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ibss</span><span class="p">.</span><span class="n">channel_type</span> <span class="o">=</span> <span class="n">channel_type</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ibss</span><span class="p">.</span><span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ibss</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">rdev_freq_to_chan</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
		<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]),</span>
		<span class="n">ibss</span><span class="p">.</span><span class="n">channel_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibss</span><span class="p">.</span><span class="n">channel</span> <span class="o">||</span>
	    <span class="n">ibss</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">||</span>
	    <span class="n">ibss</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Both channels should be able to initiate communication */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ibss</span><span class="p">.</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40PLUS</span> <span class="o">||</span>
	     <span class="n">ibss</span><span class="p">.</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40MINUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">cfg80211_can_beacon_sec_chan</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">ibss</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
					  <span class="n">ibss</span><span class="p">.</span><span class="n">channel_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ibss</span><span class="p">.</span><span class="n">channel_fixed</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FREQ_FIXED</span><span class="p">];</span>
	<span class="n">ibss</span><span class="p">.</span><span class="n">privacy</span> <span class="o">=</span> <span class="o">!!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PRIVACY</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_BASIC_RATES</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">rates</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_BASIC_RATES</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">n_rates</span> <span class="o">=</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BSS_BASIC_RATES</span><span class="p">]);</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span> <span class="o">=</span>
			<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">ibss</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_get_ratemask</span><span class="p">(</span><span class="n">sband</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">n_rates</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ibss</span><span class="p">.</span><span class="n">basic_rates</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MCAST_RATE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">nl80211_parse_mcast_rate</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ibss</span><span class="p">.</span><span class="n">mcast_rate</span><span class="p">,</span>
			<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MCAST_RATE</span><span class="p">])))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibss</span><span class="p">.</span><span class="n">privacy</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEYS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">connkeys</span> <span class="o">=</span> <span class="n">nl80211_parse_connkeys</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEYS</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">connkeys</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">connkeys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ibss</span><span class="p">.</span><span class="n">control_port</span> <span class="o">=</span>
		<span class="n">nla_get_flag</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CONTROL_PORT</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_join_ibss</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibss</span><span class="p">,</span> <span class="n">connkeys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">connkeys</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_leave_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">leave_ibss</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cfg80211_leave_ibss</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NL80211_TESTMODE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">nl80211_testmode_mcgrp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;testmode&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_testmode_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TESTDATA</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">testmode_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TESTDATA</span><span class="p">]),</span>
				<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TESTDATA</span><span class="p">]));</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">testmode_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_testmode_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">phy_idx</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0 is a valid index, but not valid for args[0],</span>
<span class="cm">		 * so we need to offset by 1.</span>
<span class="cm">		 */</span>
		<span class="n">phy_idx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="p">,</span> <span class="n">GENL_HDRLEN</span> <span class="o">+</span> <span class="n">nl80211_fam</span><span class="p">.</span><span class="n">hdrsize</span><span class="p">,</span>
				  <span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">,</span> <span class="n">nl80211_fam</span><span class="p">.</span><span class="n">maxattr</span><span class="p">,</span>
				  <span class="n">nl80211_policy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">phy_idx</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span>
				<span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">get_rdev_dev_by_ifindex</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span>
						      <span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">phy_idx</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">;</span>
			<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">[</span><span class="n">NL80211_ATTR_TESTDATA</span><span class="p">])</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">nl80211_fam</span><span class="p">.</span><span class="n">attrbuf</span><span class="p">[</span><span class="n">NL80211_ATTR_TESTDATA</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">cfg80211_rdev_by_wiphy_idx</span><span class="p">(</span><span class="n">phy_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cfg80211_lock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg80211_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					   <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
					   <span class="n">NL80211_CMD_TESTMODE</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tmdata</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">phy_idx</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmdata</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NL80211_ATTR_TESTDATA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmdata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span>
					       <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tmdata</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOBUFS</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="cm">/* see above */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
 <span class="nl">out_err:</span>
	<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">__cfg80211_testmode_alloc_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">approxlen</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">approxlen</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_TESTMODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NL80211_ATTR_TESTDATA</span><span class="p">);</span>

	<span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">cfg80211_testmode_alloc_reply_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">approxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">testmode_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__cfg80211_testmode_alloc_skb</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">approxlen</span><span class="p">,</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">testmode_info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">testmode_info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cfg80211_testmode_alloc_reply_skb</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cfg80211_testmode_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">testmode_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">testmode_info</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cfg80211_testmode_reply</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">cfg80211_testmode_alloc_event_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">approxlen</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__cfg80211_testmode_alloc_skb</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">approxlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cfg80211_testmode_alloc_event_skb</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cfg80211_testmode_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">genlmsg_multicast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nl80211_testmode_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cfg80211_testmode_event</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="n">connect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_cached_keys</span> <span class="o">*</span><span class="n">connkeys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">connect</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ie_attr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AUTH_TYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span>
			<span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_AUTH_TYPE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_valid_auth_type</span><span class="p">(</span><span class="n">connect</span><span class="p">.</span><span class="n">auth_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span><span class="p">;</span>

	<span class="n">connect</span><span class="p">.</span><span class="n">privacy</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PRIVACY</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_crypto_settings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">.</span><span class="n">crypto</span><span class="p">,</span>
				      <span class="n">NL80211_MAX_NR_CIPHER_SUITES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">wiphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">connect</span><span class="p">.</span><span class="n">bg_scan_period</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BG_SCAN_PERIOD</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_FW_ROAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">bg_scan_period</span> <span class="o">=</span>
			<span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_BG_SCAN_PERIOD</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_SSID</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">ie</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span>
			<span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connect</span><span class="p">.</span><span class="n">channel</span> <span class="o">||</span>
		    <span class="n">connect</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">.</span><span class="n">privacy</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEYS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">connkeys</span> <span class="o">=</span> <span class="n">nl80211_parse_connkeys</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_KEYS</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">connkeys</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">connkeys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_get_flag</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DISABLE_HT</span><span class="p">]))</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASSOC_REQ_DISABLE_HT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY_MASK</span><span class="p">])</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">.</span><span class="n">ht_capa_mask</span><span class="p">,</span>
		       <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY_MASK</span><span class="p">]),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">connect</span><span class="p">.</span><span class="n">ht_capa_mask</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY_MASK</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">,</span>
		       <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_HT_CAPABILITY</span><span class="p">]),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">connect</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_connect</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="n">connkeys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">connkeys</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">reason</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">])</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">WLAN_REASON_DEAUTH_LEAVING</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cfg80211_disconnect</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_wiphy_netns</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PID</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PID</span><span class="p">]);</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">get_net_ns_by_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check if anything to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_switch_netns</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>

	<span class="n">put_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_setdel_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">rdev_ops</span><span class="p">)(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="n">pmksa</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmksa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_pmksa</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PMKID</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pmksa</span><span class="p">.</span><span class="n">pmkid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PMKID</span><span class="p">]);</span>
	<span class="n">pmksa</span><span class="p">.</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">genlhdr</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_CMD_SET_PMKSA</span>:
		<span class="n">rdev_ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pmksa</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_CMD_DEL_PMKSA</span>:
		<span class="n">rdev_ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">del_pmksa</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmksa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_flush_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_pmksa</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_pmksa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_tdls_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">action_code</span><span class="p">,</span> <span class="n">dialog_token</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tdls_mgmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TDLS_ACTION</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STATUS_CODE</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TDLS_DIALOG_TOKEN</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">peer</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>
	<span class="n">action_code</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TDLS_ACTION</span><span class="p">]);</span>
	<span class="n">status_code</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_STATUS_CODE</span><span class="p">]);</span>
	<span class="n">dialog_token</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TDLS_DIALOG_TOKEN</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tdls_mgmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">action_code</span><span class="p">,</span>
				    <span class="n">dialog_token</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span>
				    <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]),</span>
				    <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_IE</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_tdls_oper</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">nl80211_tdls_operation</span> <span class="n">operation</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tdls_oper</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TDLS_OPERATION</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">operation</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TDLS_OPERATION</span><span class="p">]);</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tdls_oper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">operation</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_remain_on_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">duration</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DURATION</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">duration</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DURATION</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should be on that channel for at least one jiffie,</span>
<span class="cm">	 * and more than 5 seconds seems excessive.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">duration</span> <span class="o">||</span> <span class="o">!</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">duration</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">max_remain_on_channel_duration</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">remain_on_channel</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_HAS_REMAIN_ON_CHANNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">nl80211_valid_channel_type</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">rdev_freq_to_chan</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_REMAIN_ON_CHANNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">remain_on_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					   <span class="n">channel_type</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_COOKIE</span><span class="p">,</span> <span class="n">cookie</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
 <span class="nl">free_msg:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_cancel_remain_on_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_COOKIE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cancel_remain_on_channel</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">nla_get_u64</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_COOKIE</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cancel_remain_on_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rateset_to_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">rates</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rates_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ridx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">ridx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">srate</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">ridx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">srate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ridx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ridx</span> <span class="o">==</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* rate not found */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ht_rateset_to_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">rates</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rates_len</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">mcs</span><span class="p">[</span><span class="n">IEEE80211_HT_MCS_MASK_LEN</span><span class="p">])</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IEEE80211_HT_MCS_MASK_LEN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ridx</span><span class="p">,</span> <span class="n">rbit</span><span class="p">;</span>

		<span class="n">ridx</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rbit</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/* check validity */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ridx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ridx</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_HT_MCS_MASK_LEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* check availability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">rbit</span><span class="p">)</span>
			<span class="n">mcs</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rbit</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">nl80211_txattr_policy</span><span class="p">[</span><span class="n">NL80211_TXRATE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_TXRATE_LEGACY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_MAX_SUPP_RATES</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_TXRATE_MCS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span>
				 <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">NL80211_MAX_SUPP_HT_RATES</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_tx_bitrate_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_bitrate_mask</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tx_rates</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TX_RATES</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bitrate_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">));</span>
	<span class="cm">/* Default to all rates enabled */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">legacy</span> <span class="o">=</span>
			<span class="n">sband</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mcs</span><span class="p">,</span>
			       <span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mcs</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mcs</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The nested attribute uses enum nl80211_band as the index. This maps</span>
<span class="cm">	 * directly to the enum ieee80211_band values used in cfg80211.</span>
<span class="cm">	 */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">NL80211_MAX_SUPP_HT_RATES</span> <span class="o">&gt;</span> <span class="n">IEEE80211_HT_MCS_MASK_LEN</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">tx_rates</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TX_RATES</span><span class="p">],</span> <span class="n">rem</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span> <span class="n">nla_type</span><span class="p">(</span><span class="n">tx_rates</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">band</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">nla_parse</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">NL80211_TXRATE_MAX</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tx_rates</span><span class="p">),</span>
			  <span class="n">nla_len</span><span class="p">(</span><span class="n">tx_rates</span><span class="p">),</span> <span class="n">nl80211_txattr_policy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_LEGACY</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">rateset_to_mask</span><span class="p">(</span>
				<span class="n">sband</span><span class="p">,</span>
				<span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_LEGACY</span><span class="p">]),</span>
				<span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_LEGACY</span><span class="p">]));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">legacy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_LEGACY</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_MCS</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ht_rateset_to_mask</span><span class="p">(</span>
					<span class="n">sband</span><span class="p">,</span>
					<span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_MCS</span><span class="p">]),</span>
					<span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_TXRATE_MCS</span><span class="p">]),</span>
					<span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">mcs</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">legacy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* don&#39;t allow empty legacy rates if HT</span>
<span class="cm">			 * is not even supported. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_HT_MCS_MASK_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">mcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* legacy and mcs rates may not be both empty */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IEEE80211_HT_MCS_MASK_LEN</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bitrate_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_register_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">frame_type</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_ACTION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME_MATCH</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME_TYPE</span><span class="p">])</span>
		<span class="n">frame_type</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME_TYPE</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* not much point in registering if we can&#39;t reply */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mgmt_tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cfg80211_mlme_register_mgmt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
			<span class="n">frame_type</span><span class="p">,</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME_MATCH</span><span class="p">]),</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME_MATCH</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_tx_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">channel_type_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">offchan</span><span class="p">,</span> <span class="n">no_cck</span><span class="p">,</span> <span class="n">dont_wait_for_ack</span><span class="p">;</span>

	<span class="n">dont_wait_for_ack</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DONT_WAIT_FOR_ACK</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mgmt_tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DURATION</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_OFFCHAN_TX</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">wait</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_DURATION</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl80211_valid_channel_type</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">channel_type_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offchan</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_OFFCHANNEL_TX_OK</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offchan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_OFFCHAN_TX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">no_cck</span> <span class="o">=</span> <span class="n">nla_get_flag</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_TX_NO_CCK_RATE</span><span class="p">]);</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">]);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">rdev_freq_to_chan</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dont_wait_for_ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">NL80211_CMD_FRAME</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cfg80211_mlme_mgmt_tx</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">offchan</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">,</span>
				    <span class="n">channel_type_valid</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span>
				    <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME</span><span class="p">]),</span>
				    <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_FRAME</span><span class="p">]),</span>
				    <span class="n">no_cck</span><span class="p">,</span> <span class="n">dont_wait_for_ack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_COOKIE</span><span class="p">,</span> <span class="n">cookie</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
 <span class="nl">free_msg:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_tx_mgmt_cancel_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_COOKIE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mgmt_tx_cancel_wait</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">nla_get_u64</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_COOKIE</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mgmt_tx_cancel_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_power_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ps_state</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PS_STATE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ps_state</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_PS_STATE</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_state</span> <span class="o">!=</span> <span class="n">NL80211_PS_DISABLED</span> <span class="o">&amp;&amp;</span> <span class="n">ps_state</span> <span class="o">!=</span> <span class="n">NL80211_PS_ENABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_power_mgmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_state</span> <span class="o">==</span> <span class="n">NL80211_PS_ENABLED</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_power_mgmt</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
					<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_power_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">nl80211_ps_state</span> <span class="n">ps_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_power_mgmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_GET_POWER_SAVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span>
		<span class="n">ps_state</span> <span class="o">=</span> <span class="n">NL80211_PS_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ps_state</span> <span class="o">=</span> <span class="n">NL80211_PS_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_PS_STATE</span><span class="p">,</span> <span class="n">ps_state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
 <span class="nl">free_msg:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nla_policy</span>
<span class="n">nl80211_attr_cqm_policy</span><span class="p">[</span><span class="n">NL80211_ATTR_CQM_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CQM_RSSI_THOLD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CQM_RSSI_HYST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_ATTR_CQM_RSSI_THRESHOLD_EVENT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_cqm_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="n">s32</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hysteresis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cqm_rssi_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cqm_rssi_config</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					      <span class="n">threshold</span><span class="p">,</span> <span class="n">hysteresis</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_cqm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CQM_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">cqm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cqm</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CQM</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">NL80211_ATTR_CQM_MAX</span><span class="p">,</span> <span class="n">cqm</span><span class="p">,</span>
			       <span class="n">nl80211_attr_cqm_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CQM_RSSI_THOLD</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CQM_RSSI_HYST</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">threshold</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">hysteresis</span><span class="p">;</span>
		<span class="n">threshold</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CQM_RSSI_THOLD</span><span class="p">]);</span>
		<span class="n">hysteresis</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_CQM_RSSI_HYST</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_set_cqm_rssi</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">hysteresis</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_join_mesh</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mesh_config</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_setup</span> <span class="n">setup</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* start with default */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_mesh_config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_mesh_setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_CONFIG</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* and parse parameters if given */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_mesh_config</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">setup</span><span class="p">.</span><span class="n">mesh_id</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]);</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">mesh_id_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_ID</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MCAST_RATE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">nl80211_parse_mcast_rate</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">setup</span><span class="p">.</span><span class="n">mcast_rate</span><span class="p">,</span>
			    <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MCAST_RATE</span><span class="p">])))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MESH_SETUP</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* parse additional setup parameters if given */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nl80211_parse_mesh_setup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cfg80211_join_mesh</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_leave_mesh</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">cfg80211_leave_mesh</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_get_wowlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_GET_WOWLAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_wowlan</span><span class="p">;</span>

		<span class="n">nl_wowlan</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WOWLAN_TRIGGERS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_wowlan</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">any</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_ANY</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_DISCONNECT</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">magic_pkt</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_MAGIC_PKT</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">gtk_rekey_failure</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_GTK_REKEY_FAILURE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">eap_identity_req</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_EAP_IDENT_REQUEST</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">four_way_handshake</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_4WAY_HANDSHAKE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">rfkill_release</span> <span class="o">&amp;&amp;</span>
		     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_TRIG_RFKILL_RELEASE</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_pats</span><span class="p">,</span> <span class="o">*</span><span class="n">nl_pat</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pat_len</span><span class="p">;</span>

			<span class="n">nl_pats</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>
					<span class="n">NL80211_WOWLAN_TRIG_PKT_PATTERN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_pats</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nl_pat</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_pat</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
				<span class="n">pat_len</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_PKTPAT_MASK</span><span class="p">,</span>
					    <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">pat_len</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
					    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_WOWLAN_PKTPAT_PATTERN</span><span class="p">,</span>
					    <span class="n">pat_len</span><span class="p">,</span>
					    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
				<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_pat</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_pats</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_wowlan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_wowlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NUM_NL80211_WOWLAN_TRIG</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="n">no_triggers</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="n">new_triggers</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">wiphy_wowlan_support</span> <span class="o">*</span><span class="n">wowlan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">prev_enabled</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WOWLAN_TRIGGERS</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">no_triggers</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">MAX_NL80211_WOWLAN_TRIG</span><span class="p">,</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WOWLAN_TRIGGERS</span><span class="p">]),</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_WOWLAN_TRIGGERS</span><span class="p">]),</span>
			<span class="n">nl80211_wowlan_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_ANY</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_ANY</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">new_triggers</span><span class="p">.</span><span class="n">any</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_DISCONNECT</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_DISCONNECT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">new_triggers</span><span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_MAGIC_PKT</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_MAGIC_PKT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">new_triggers</span><span class="p">.</span><span class="n">magic_pkt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_GTK_REKEY_SUPPORTED</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_GTK_REKEY_FAILURE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_GTK_REKEY_FAILURE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">new_triggers</span><span class="p">.</span><span class="n">gtk_rekey_failure</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_EAP_IDENT_REQUEST</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_EAP_IDENTITY_REQ</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">new_triggers</span><span class="p">.</span><span class="n">eap_identity_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_4WAY_HANDSHAKE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_4WAY_HANDSHAKE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">new_triggers</span><span class="p">.</span><span class="n">four_way_handshake</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_RFKILL_RELEASE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_WOWLAN_RFKILL_RELEASE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">new_triggers</span><span class="p">.</span><span class="n">rfkill_release</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_PKT_PATTERN</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pat</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n_patterns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rem</span><span class="p">,</span> <span class="n">pat_len</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pat_tb</span><span class="p">[</span><span class="n">NUM_NL80211_WOWLAN_PKTPAT</span><span class="p">];</span>

		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_PKT_PATTERN</span><span class="p">],</span>
				    <span class="n">rem</span><span class="p">)</span>
			<span class="n">n_patterns</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n_patterns</span> <span class="o">&gt;</span> <span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">n_patterns</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">new_triggers</span><span class="p">.</span><span class="n">n_patterns</span> <span class="o">=</span> <span class="n">n_patterns</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_TRIG_PKT_PATTERN</span><span class="p">],</span>
				    <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nla_parse</span><span class="p">(</span><span class="n">pat_tb</span><span class="p">,</span> <span class="n">MAX_NL80211_WOWLAN_PKTPAT</span><span class="p">,</span>
				  <span class="n">nla_data</span><span class="p">(</span><span class="n">pat</span><span class="p">),</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">pat</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pat_tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_PKTPAT_MASK</span><span class="p">]</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">pat_tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_PKTPAT_PATTERN</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">pat_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">pat_tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_PKTPAT_PATTERN</span><span class="p">]);</span>
			<span class="n">mask_len</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">pat_len</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">pat_tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_PKTPAT_MASK</span><span class="p">])</span> <span class="o">!=</span>
			    <span class="n">mask_len</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pat_len</span> <span class="o">&gt;</span> <span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">pattern_max_len</span> <span class="o">||</span>
			    <span class="n">pat_len</span> <span class="o">&lt;</span> <span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">pattern_min_len</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span>
				<span class="n">kmalloc</span><span class="p">(</span><span class="n">mask_len</span> <span class="o">+</span> <span class="n">pat_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span> <span class="o">=</span>
				<span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span> <span class="o">+</span> <span class="n">mask_len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
			       <span class="n">nla_data</span><span class="p">(</span><span class="n">pat_tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_PKTPAT_MASK</span><span class="p">]),</span>
			       <span class="n">mask_len</span><span class="p">);</span>
			<span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_len</span> <span class="o">=</span> <span class="n">pat_len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">,</span>
			       <span class="n">nla_data</span><span class="p">(</span><span class="n">pat_tb</span><span class="p">[</span><span class="n">NL80211_WOWLAN_PKTPAT_PATTERN</span><span class="p">]),</span>
			       <span class="n">pat_len</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_triggers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_triggers</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_triggers</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">ntrig</span><span class="p">;</span>
		<span class="n">ntrig</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_triggers</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_triggers</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ntrig</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cfg80211_rdev_free_wowlan</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span> <span class="o">=</span> <span class="n">ntrig</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="nl">no_triggers:</span>
		<span class="n">cfg80211_rdev_free_wowlan</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wakeup</span> <span class="o">&amp;&amp;</span> <span class="n">prev_enabled</span> <span class="o">!=</span> <span class="o">!!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">new_triggers</span><span class="p">.</span><span class="n">n_patterns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new_triggers</span><span class="p">.</span><span class="n">patterns</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_set_rekey_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">NUM_NL80211_REKEY_DATA</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cfg80211_gtk_rekey_data</span> <span class="n">rekey_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REKEY_DATA</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">MAX_NL80211_REKEY_DATA</span><span class="p">,</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REKEY_DATA</span><span class="p">]),</span>
			<span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_REKEY_DATA</span><span class="p">]),</span>
			<span class="n">nl80211_rekey_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_REKEY_DATA_REPLAY_CTR</span><span class="p">])</span> <span class="o">!=</span> <span class="n">NL80211_REPLAY_CTR_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_REKEY_DATA_KEK</span><span class="p">])</span> <span class="o">!=</span> <span class="n">NL80211_KEK_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_REKEY_DATA_KCK</span><span class="p">])</span> <span class="o">!=</span> <span class="n">NL80211_KCK_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rekey_data</span><span class="p">.</span><span class="n">kek</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_REKEY_DATA_KEK</span><span class="p">]),</span>
	       <span class="n">NL80211_KEK_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rekey_data</span><span class="p">.</span><span class="n">kck</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_REKEY_DATA_KCK</span><span class="p">]),</span>
	       <span class="n">NL80211_KCK_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rekey_data</span><span class="p">.</span><span class="n">replay_ctr</span><span class="p">,</span>
	       <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">NL80211_REKEY_DATA_REPLAY_CTR</span><span class="p">]),</span>
	       <span class="n">NL80211_REPLAY_CTR_LEN</span><span class="p">);</span>

	<span class="n">wdev_lock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rekey_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rekey_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rekey_data</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">wdev_unlock</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_register_unexpected_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ap_unexpected_nlpid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ap_unexpected_nlpid</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_probe_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">probe_client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">NL80211_CMD_PROBE_CLIENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">NL80211_ATTR_MAC</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">probe_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_COOKIE</span><span class="p">,</span> <span class="n">cookie</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
 <span class="nl">free_msg:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_register_beacons</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_REPORTS_OBSS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ap_beacons_nlpid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ap_beacons_nlpid</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NL80211_FLAG_NEED_WIPHY		0x01</span>
<span class="cp">#define NL80211_FLAG_NEED_NETDEV	0x02</span>
<span class="cp">#define NL80211_FLAG_NEED_RTNL		0x04</span>
<span class="cp">#define NL80211_FLAG_CHECK_NETDEV_UP	0x08</span>
<span class="cp">#define NL80211_FLAG_NEED_NETDEV_UP	(NL80211_FLAG_NEED_NETDEV |\</span>
<span class="cp">					 NL80211_FLAG_CHECK_NETDEV_UP)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_pre_doit</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rtnl</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">internal_flags</span> <span class="o">&amp;</span> <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtnl</span><span class="p">)</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">internal_flags</span> <span class="o">&amp;</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">cfg80211_get_dev_from_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtnl</span><span class="p">)</span>
				<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">internal_flags</span> <span class="o">&amp;</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_rdev_dev_by_ifindex</span><span class="p">(</span><span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtnl</span><span class="p">)</span>
				<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">internal_flags</span> <span class="o">&amp;</span> <span class="n">NL80211_FLAG_CHECK_NETDEV_UP</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtnl</span><span class="p">)</span>
				<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nl80211_post_doit</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">cfg80211_unlock_rdev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">user_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">internal_flags</span> <span class="o">&amp;</span> <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">)</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="n">nl80211_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_WIPHY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_wiphy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">nl80211_dump_wiphy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="cm">/* can be retrieved by unprivileged users */</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_WIPHY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_wiphy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_INTERFACE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_interface</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">nl80211_dump_interface</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="cm">/* can be retrieved by unprivileged users */</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_INTERFACE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_interface</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_NEW_INTERFACE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_new_interface</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DEL_INTERFACE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_del_interface</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_NEW_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_new_key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DEL_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_del_key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_BEACON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_beacon</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_START_AP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_start_ap</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_STOP_AP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_stop_ap</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_STATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_station</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">nl80211_dump_station</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_STATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_station</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_NEW_STATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_new_station</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DEL_STATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_del_station</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_MPATH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_mpath</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">nl80211_dump_mpath</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_MPATH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_mpath</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_NEW_MPATH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_new_mpath</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DEL_MPATH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_del_mpath</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_BSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_bss</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_reg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="cm">/* can be retrieved by unprivileged users */</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_reg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_REQ_SET_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_req_set_reg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_MESH_CONFIG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_mesh_config</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="cm">/* can be retrieved by unprivileged users */</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_MESH_CONFIG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_update_mesh_config</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_TRIGGER_SCAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_trigger_scan</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_SCAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">nl80211_dump_scan</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_START_SCHED_SCAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_start_sched_scan</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_STOP_SCHED_SCAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_stop_sched_scan</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_AUTHENTICATE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_authenticate</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_ASSOCIATE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_associate</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DEAUTHENTICATE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_deauthenticate</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DISASSOCIATE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_disassociate</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_JOIN_IBSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_join_ibss</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_LEAVE_IBSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_leave_ibss</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef CONFIG_NL80211_TESTMODE</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_TESTMODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_testmode_do</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">nl80211_testmode_dump</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_CONNECT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_connect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DISCONNECT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_disconnect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_WIPHY_NETNS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_wiphy_netns</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_SURVEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">nl80211_dump_survey</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_PMKSA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_setdel_pmksa</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_DEL_PMKSA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_setdel_pmksa</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_FLUSH_PMKSA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_flush_pmksa</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_REMAIN_ON_CHANNEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_remain_on_channel</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_CANCEL_REMAIN_ON_CHANNEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_cancel_remain_on_channel</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_TX_BITRATE_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_tx_bitrate_mask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_REGISTER_FRAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_register_mgmt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_FRAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_tx_mgmt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_FRAME_WAIT_CANCEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_tx_mgmt_cancel_wait</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_POWER_SAVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_power_save</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_POWER_SAVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_power_save</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="cm">/* can be retrieved by unprivileged users */</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_CQM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_cqm</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_CHANNEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_channel</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_WDS_PEER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_wds_peer</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_JOIN_MESH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_join_mesh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_LEAVE_MESH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_leave_mesh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_GET_WOWLAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_get_wowlan</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="cm">/* can be retrieved by unprivileged users */</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_WOWLAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_wowlan</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_REKEY_OFFLOAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_rekey_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_TDLS_MGMT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_tdls_mgmt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_TDLS_OPER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_tdls_oper</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_UNEXPECTED_FRAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_register_unexpected_frame</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_PROBE_CLIENT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_probe_client</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV_UP</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_REGISTER_BEACONS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_register_beacons</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_WIPHY</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NL80211_CMD_SET_NOACK_MAP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">nl80211_set_noack_map</span><span class="p">,</span>
		<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">nl80211_policy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_flags</span> <span class="o">=</span> <span class="n">NL80211_FLAG_NEED_NETDEV</span> <span class="o">|</span>
				  <span class="n">NL80211_FLAG_NEED_RTNL</span><span class="p">,</span>
	<span class="p">},</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">nl80211_mlme_mcgrp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mlme&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* multicast groups */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">nl80211_config_mcgrp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;config&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">nl80211_scan_mcgrp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;scan&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">nl80211_regulatory_mcgrp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;regulatory&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* notification functions */</span>

<span class="kt">void</span> <span class="nf">nl80211_notify_dev_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_wiphy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_config_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_add_scan_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ASSERT_RDEV_LOCK</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SCAN_SSIDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_SCAN_FREQUENCIES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IE</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_send_scan_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="cm">/* ignore errors and send incomplete event anyway */</span>
	<span class="n">nl80211_add_scan_req</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nl80211_send_sched_scan_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_scan_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">NL80211_CMD_TRIGGER_SCAN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_scan_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_scan_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_scan_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">NL80211_CMD_NEW_SCAN_RESULTS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_scan_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_scan_aborted</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_scan_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">NL80211_CMD_SCAN_ABORTED</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_scan_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_sched_scan_results</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_sched_scan_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">NL80211_CMD_SCHED_SCAN_RESULTS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_scan_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_sched_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_sched_scan_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_scan_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This can happen on global regulatory changes or device specific settings</span>
<span class="cm"> * based on custom world regulatory domains.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nl80211_send_reg_change_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulatory_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_REG_CHANGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Userspace can always count this one always being set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_INITIATOR</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">initiator</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_TYPE</span><span class="p">,</span>
			       <span class="n">NL80211_REGDOM_TYPE_WORLD</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;9&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_TYPE</span><span class="p">,</span>
			       <span class="n">NL80211_REGDOM_TYPE_CUSTOM_WORLD</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;9&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;8&#39;</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">request</span><span class="o">-&gt;</span><span class="n">intersect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_TYPE</span><span class="p">,</span>
			       <span class="n">NL80211_REGDOM_TYPE_INTERSECTION</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_TYPE</span><span class="p">,</span>
			       <span class="n">NL80211_REGDOM_TYPE_COUNTRY</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_string</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REG_ALPHA2</span><span class="p">,</span>
				   <span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wiphy_idx_valid</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">genlmsg_multicast_allns</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nl80211_regulatory_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nl80211_send_mlme_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">nl80211_commands</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FRAME</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_rx_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_event</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">NL80211_CMD_AUTHENTICATE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_rx_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_event</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">NL80211_CMD_ASSOCIATE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_deauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_event</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">NL80211_CMD_DEAUTHENTICATE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_disassoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_event</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">NL80211_CMD_DISASSOCIATE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_unprot_deauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_event</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">NL80211_CMD_UNPROT_DEAUTHENTICATE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_unprot_disassoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_event</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">NL80211_CMD_UNPROT_DISASSOCIATE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nl80211_send_mlme_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_TIMED_OUT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_auth_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			       <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_timeout</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">NL80211_CMD_AUTHENTICATE</span><span class="p">,</span>
				  <span class="n">addr</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_assoc_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_mlme_timeout</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">NL80211_CMD_ASSOCIATE</span><span class="p">,</span>
				  <span class="n">addr</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_connect_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">req_ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">req_ie_len</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">resp_ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">resp_ie_len</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_CONNECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bssid</span> <span class="o">&amp;&amp;</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">bssid</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_STATUS_CODE</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">req_ie</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REQ_IE</span><span class="p">,</span> <span class="n">req_ie_len</span><span class="p">,</span> <span class="n">req_ie</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">resp_ie</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_RESP_IE</span><span class="p">,</span> <span class="n">resp_ie_len</span><span class="p">,</span> <span class="n">resp_ie</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_roamed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">req_ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">req_ie_len</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">resp_ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">resp_ie_len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_ROAM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">bssid</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">req_ie</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REQ_IE</span><span class="p">,</span> <span class="n">req_ie_len</span><span class="p">,</span> <span class="n">req_ie</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">resp_ie</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_RESP_IE</span><span class="p">,</span> <span class="n">resp_ie_len</span><span class="p">,</span> <span class="n">resp_ie</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_disconnected</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">from_ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_DISCONNECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">from_ap</span> <span class="o">&amp;&amp;</span> <span class="n">reason</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REASON_CODE</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">from_ap</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_DISCONNECTED_BY_AP</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ie</span> <span class="o">&amp;&amp;</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IE</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">ie</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_ibss_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			     <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_JOIN_IBSS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">bssid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_new_peer_candidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">macaddr</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span><span class="o">*</span> <span class="n">ie</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie_len</span><span class="p">,</span>
		<span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_NEW_PEER_CANDIDATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">macaddr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ie_len</span> <span class="o">&amp;&amp;</span> <span class="n">ie</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IE</span><span class="p">,</span> <span class="n">ie_len</span> <span class="p">,</span> <span class="n">ie</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_michael_mic_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">nl80211_key_type</span> <span class="n">key_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_id</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tsc</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_MICHAEL_MIC_FAILURE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_TYPE</span><span class="p">,</span> <span class="n">key_type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">key_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_IDX</span><span class="p">,</span> <span class="n">key_id</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tsc</span> <span class="o">&amp;&amp;</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_KEY_SEQ</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">tsc</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_beacon_hint_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel_before</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel_after</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nl_freq</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_REG_BEACON_HINT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we are applying the beacon hint to a wiphy we know its</span>
<span class="cm">	 * wiphy_idx is valid</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">get_wiphy_idx</span><span class="p">(</span><span class="n">wiphy</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="cm">/* Before */</span>
	<span class="n">nl_freq</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FREQ_BEFORE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_freq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_msg_put_channel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">channel_before</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_freq</span><span class="p">);</span>

	<span class="cm">/* After */</span>
	<span class="n">nl_freq</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FREQ_AFTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_freq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_msg_put_channel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">channel_after</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">nl_freq</span><span class="p">);</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">genlmsg_multicast_allns</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nl80211_regulatory_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nl80211_send_remain_on_chan_event</span><span class="p">(</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_COOKIE</span><span class="p">,</span> <span class="n">cookie</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">NL80211_CMD_REMAIN_ON_CHANNEL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_DURATION</span><span class="p">,</span> <span class="n">duration</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_remain_on_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_remain_on_chan_event</span><span class="p">(</span><span class="n">NL80211_CMD_REMAIN_ON_CHANNEL</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					  <span class="n">channel_type</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_remain_on_channel_cancel</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nl80211_send_remain_on_chan_event</span><span class="p">(</span><span class="n">NL80211_CMD_CANCEL_REMAIN_ON_CHANNEL</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					  <span class="n">channel_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_sta_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nl80211_send_station</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_sta_del_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
				<span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_DEL_STATION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">__nl80211_unexpected_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nlpid</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ap_unexpected_nlpid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlpid</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_unicast</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">nlpid</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">nl80211_unexpected_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__nl80211_unexpected_frame</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NL80211_CMD_UNEXPECTED_FRAME</span><span class="p">,</span>
					  <span class="n">addr</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">nl80211_unexpected_4addr_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__nl80211_unexpected_frame</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">NL80211_CMD_UNEXPECTED_4ADDR_FRAME</span><span class="p">,</span>
					  <span class="n">addr</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nl80211_send_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nlpid</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig_dbm</span><span class="p">,</span>
		      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_FRAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sig_dbm</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_RX_SIGNAL_DBM</span><span class="p">,</span> <span class="n">sig_dbm</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FRAME</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_unicast</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">nlpid</span><span class="p">);</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_send_mgmt_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ack</span><span class="p">,</span>
				 <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_FRAME_TX_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FRAME</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_COOKIE</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;&amp;</span> <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_ACK</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nl80211_send_cqm_rssi_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">nl80211_cqm_rssi_threshold_event</span> <span class="n">rssi_event</span><span class="p">,</span>
			     <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pinfoattr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_NOTIFY_CQM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">pinfoattr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_CQM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pinfoattr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_CQM_RSSI_THRESHOLD_EVENT</span><span class="p">,</span>
			<span class="n">rssi_event</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pinfoattr</span><span class="p">);</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_gtk_rekey_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">replay_ctr</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rekey_attr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_SET_REKEY_OFFLOAD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">bssid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">rekey_attr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_REKEY_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rekey_attr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_REKEY_DATA_REPLAY_CTR</span><span class="p">,</span>
		    <span class="n">NL80211_REPLAY_CTR_LEN</span><span class="p">,</span> <span class="n">replay_ctr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rekey_attr</span><span class="p">);</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_pmksa_candidate_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">preauth</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_PMKSA_CANDIDATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">attr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_PMKSA_CANDIDATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_PMKSA_CANDIDATE_INDEX</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_PMKSA_CANDIDATE_BSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">bssid</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">preauth</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_PMKSA_CANDIDATE_PREAUTH</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_ch_switch_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">type</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_CH_SWITCH_NOTIFY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_CHANNEL_TYPE</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nl80211_send_cqm_pktloss_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">num_packets</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pinfoattr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_NOTIFY_CQM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">peer</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">pinfoattr</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_CQM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pinfoattr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_CQM_PKT_LOSS_EVENT</span><span class="p">,</span> <span class="n">num_packets</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pinfoattr</span><span class="p">);</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cfg80211_probe_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">bool</span> <span class="n">acked</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_PROBE_CLIENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_IFINDEX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_MAC</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_COOKIE</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">acked</span> <span class="o">&amp;&amp;</span> <span class="n">nla_put_flag</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_ACK</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">nl80211_mlme_mcgrp</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cfg80211_probe_status</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cfg80211_report_obss_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig_dbm</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">wiphy_to_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nlpid</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ap_beacons_nlpid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlpid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nl80211hdr_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_CMD_FRAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy_idx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">freq</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_WIPHY_FREQ</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sig_dbm</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_RX_SIGNAL_DBM</span><span class="p">,</span> <span class="n">sig_dbm</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL80211_ATTR_FRAME</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">frame</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">genlmsg_unicast</span><span class="p">(</span><span class="n">wiphy_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">nlpid</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cfg80211_report_obss_beacon</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nl80211_netlink_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span> <span class="n">nb</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">state</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">_notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netlink_notify</span> <span class="o">*</span><span class="n">notify</span> <span class="o">=</span> <span class="n">_notify</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_registered_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NETLINK_URELEASE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg80211_rdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">netdev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">cfg80211_mlme_unregister_socket</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span> <span class="n">notify</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ap_beacons_nlpid</span> <span class="o">==</span> <span class="n">notify</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ap_beacons_nlpid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">nl80211_netlink_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">nl80211_netlink_notify</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* initialisation/exit functions */</span>

<span class="kt">int</span> <span class="nf">nl80211_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_family_with_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">,</span>
		<span class="n">nl80211_ops</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nl80211_ops</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl80211_config_mcgrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl80211_scan_mcgrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl80211_regulatory_mcgrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl80211_mlme_mcgrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_NL80211_TESTMODE</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl80211_testmode_mcgrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netlink_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_netlink_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">err_out:</span>
	<span class="n">genl_unregister_family</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nl80211_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netlink_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_netlink_notifier</span><span class="p">);</span>
	<span class="n">genl_unregister_family</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl80211_fam</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
