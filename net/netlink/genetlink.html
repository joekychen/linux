<!DOCTYPE html>
<html><head><title>joekychen/linux » net › netlink › genetlink.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>genetlink.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * NETLINK      Generic Netlink Family</span>
<span class="cm"> *</span>
<span class="cm"> * 		Authors:	Jamal Hadi Salim</span>
<span class="cm"> * 				Thomas Graf &lt;tgraf@suug.ch&gt;</span>
<span class="cm"> *				Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/genetlink.h&gt;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">genl_mutex</span><span class="p">);</span> <span class="cm">/* serialization of message processing */</span>

<span class="kt">void</span> <span class="nf">genl_lock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genl_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">genl_unlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genl_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_unlock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
<span class="kt">int</span> <span class="nf">lockdep_genl_is_held</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genl_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">lockdep_genl_is_held</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define GENL_FAM_TAB_SIZE	16</span>
<span class="cp">#define GENL_FAM_TAB_MASK	(GENL_FAM_TAB_SIZE - 1)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">family_ht</span><span class="p">[</span><span class="n">GENL_FAM_TAB_SIZE</span><span class="p">];</span>
<span class="cm">/*</span>
<span class="cm"> * Bitmap of multicast groups that are currently in use.</span>
<span class="cm"> *</span>
<span class="cm"> * To avoid an allocation at boot of just one unsigned long,</span>
<span class="cm"> * declare it global instead.</span>
<span class="cm"> * Bit 0 is marked as already used since group 0 is invalid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mc_group_start</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mc_groups</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc_group_start</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mc_groups_longs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">genl_ctrl_event</span><span class="p">(</span><span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">genl_family_hash</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="n">GENL_FAM_TAB_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="nf">genl_family_chain</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">family_ht</span><span class="p">[</span><span class="n">genl_family_hash</span><span class="p">(</span><span class="n">id</span><span class="p">)];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="nf">genl_family_find_byid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">genl_family_chain</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">family_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">f</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="nf">genl_family_find_byname</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GENL_FAM_TAB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">genl_family_chain</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">family_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">f</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="nf">genl_get_cmd</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">,</span> <span class="n">ops_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Of course we are going to have problems once we hit</span>
<span class="cm"> * 2^16 alive types, but that can only happen by year 2K</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">genl_generate_id</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">id_gen_idx</span> <span class="o">=</span> <span class="n">GENL_MIN_ID</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GENL_MAX_ID</span> <span class="o">-</span> <span class="n">GENL_MIN_ID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">genl_family_find_byid</span><span class="p">(</span><span class="n">id_gen_idx</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">id_gen_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">id_gen_idx</span> <span class="o">&gt;</span> <span class="n">GENL_MAX_ID</span><span class="p">)</span>
			<span class="n">id_gen_idx</span> <span class="o">=</span> <span class="n">GENL_MIN_ID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">notify_grp</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * genl_register_mc_group - register a multicast group</span>
<span class="cm"> *</span>
<span class="cm"> * Registers the specified multicast group and notifies userspace</span>
<span class="cm"> * about the new group.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or a negative error code.</span>
<span class="cm"> *</span>
<span class="cm"> * @family: The generic netlink family the group shall be registered for.</span>
<span class="cm"> * @grp: The group to register, must have a name.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">genl_register_mc_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">new_groups</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>

	<span class="n">genl_lock</span><span class="p">();</span>

	<span class="cm">/* special-case our own group */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">notify_grp</span><span class="p">)</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_CTRL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">mc_groups</span><span class="p">,</span>
					 <span class="n">mc_groups_longs</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">mc_groups_longs</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">nlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">mc_groups_longs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mc_groups</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mc_group_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">nlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_groups</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mc_groups</span> <span class="o">=</span> <span class="n">new_groups</span><span class="p">;</span>
			<span class="o">*</span><span class="n">mc_groups</span> <span class="o">=</span> <span class="n">mc_group_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">new_groups</span> <span class="o">=</span> <span class="n">krealloc</span><span class="p">(</span><span class="n">mc_groups</span><span class="p">,</span> <span class="n">nlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_groups</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mc_groups</span> <span class="o">=</span> <span class="n">new_groups</span><span class="p">;</span>
			<span class="n">mc_groups</span><span class="p">[</span><span class="n">mc_groups_longs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mc_groups_longs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">netnsok</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

		<span class="n">netlink_table_grab</span><span class="p">();</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">for_each_net_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">__netlink_change_ngroups</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">,</span>
					<span class="n">mc_groups_longs</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * No need to roll back, can only fail if</span>
<span class="cm">				 * memory allocation fails and then the</span>
<span class="cm">				 * number of _possible_ groups has been</span>
<span class="cm">				 * increased on some sockets which is ok.</span>
<span class="cm">				 */</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="n">netlink_table_ungrab</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">netlink_table_ungrab</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">netlink_change_ngroups</span><span class="p">(</span><span class="n">init_net</span><span class="p">.</span><span class="n">genl_sock</span><span class="p">,</span>
					     <span class="n">mc_groups_longs</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">mc_groups</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">mcast_groups</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span><span class="p">;</span>

	<span class="n">genl_ctrl_event</span><span class="p">(</span><span class="n">CTRL_CMD_NEWMCAST_GRP</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">genl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_register_mc_group</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__genl_unregister_mc_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">family</span><span class="p">);</span>

	<span class="n">netlink_table_grab</span><span class="p">();</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_net_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
		<span class="n">__netlink_clear_multicast_users</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">netlink_table_ungrab</span><span class="p">();</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mc_groups</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">genl_ctrl_event</span><span class="p">(</span><span class="n">CTRL_CMD_DELMCAST_GRP</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * genl_unregister_mc_group - unregister a multicast group</span>
<span class="cm"> *</span>
<span class="cm"> * Unregisters the specified multicast group and notifies userspace</span>
<span class="cm"> * about it. All current listeners on the group are removed.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: It is not necessary to unregister all multicast groups before</span>
<span class="cm"> *       unregistering the family, unregistering the family will cause</span>
<span class="cm"> *       all assigned multicast groups to be unregistered automatically.</span>
<span class="cm"> *</span>
<span class="cm"> * @family: Generic netlink family the group belongs to.</span>
<span class="cm"> * @grp: The group to unregister, must have been registered successfully</span>
<span class="cm"> *	 previously.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">genl_unregister_mc_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">genl_lock</span><span class="p">();</span>
	<span class="n">__genl_unregister_mc_group</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
	<span class="n">genl_unlock</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_unregister_mc_group</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">genl_unregister_mc_groups</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">mcast_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">__genl_unregister_mc_group</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * genl_register_ops - register generic netlink operations</span>
<span class="cm"> * @family: generic netlink family</span>
<span class="cm"> * @ops: operations to be registered</span>
<span class="cm"> *</span>
<span class="cm"> * Registers the specified operations and assigns them to the specified</span>
<span class="cm"> * family. Either a doit or dumpit callback must be specified or the</span>
<span class="cm"> * operation will fail. Only one operation structure per command</span>
<span class="cm"> * identifier may be registered.</span>
<span class="cm"> *</span>
<span class="cm"> * See include/net/genetlink.h for more documenation on the operations</span>
<span class="cm"> * structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">genl_register_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dumpit</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">doit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genl_get_cmd</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">family</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dumpit</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENL_CMD_CAP_DUMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">doit</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENL_CMD_CAP_DO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENL_CMD_CAP_HASPOL</span><span class="p">;</span>

	<span class="n">genl_lock</span><span class="p">();</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">);</span>
	<span class="n">genl_unlock</span><span class="p">();</span>

	<span class="n">genl_ctrl_event</span><span class="p">(</span><span class="n">CTRL_CMD_NEWOPS</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">errout:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_register_ops</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * genl_unregister_ops - unregister generic netlink operations</span>
<span class="cm"> * @family: generic netlink family</span>
<span class="cm"> * @ops: operations to be unregistered</span>
<span class="cm"> *</span>
<span class="cm"> * Unregisters the specified operations and unassigns them from the</span>
<span class="cm"> * specified family. The operation blocks until the current message</span>
<span class="cm"> * processing has finished and doesn&#39;t start again until the</span>
<span class="cm"> * unregister process has finished.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: It is not necessary to unregister all operations before</span>
<span class="cm"> *       unregistering the family, unregistering the family will cause</span>
<span class="cm"> *       all assigned operations to be unregistered automatically.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">genl_unregister_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>

	<span class="n">genl_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">,</span> <span class="n">ops_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">);</span>
			<span class="n">genl_unlock</span><span class="p">();</span>
			<span class="n">genl_ctrl_event</span><span class="p">(</span><span class="n">CTRL_CMD_DELOPS</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">genl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_unregister_ops</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * genl_register_family - register a generic netlink family</span>
<span class="cm"> * @family: generic netlink family</span>
<span class="cm"> *</span>
<span class="cm"> * Registers the specified family after validating it first. Only one</span>
<span class="cm"> * family may be registered with the same family name or identifier.</span>
<span class="cm"> * The family id may equal GENL_ID_GENERATE causing an unique id to</span>
<span class="cm"> * be automatically generated and assigned.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">genl_register_family</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">GENL_MIN_ID</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">GENL_MAX_ID</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">mcast_groups</span><span class="p">);</span>

	<span class="n">genl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genl_family_find_byname</span><span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout_locked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">GENL_ID_GENERATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">newid</span> <span class="o">=</span> <span class="n">genl_generate_id</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">errout_locked</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">newid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">genl_family_find_byid</span><span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout_locked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">maxattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">family</span><span class="o">-&gt;</span><span class="n">attrbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">maxattr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">attrbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">errout_locked</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">family</span><span class="o">-&gt;</span><span class="n">attrbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">family_list</span><span class="p">,</span> <span class="n">genl_family_chain</span><span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">genl_unlock</span><span class="p">();</span>

	<span class="n">genl_ctrl_event</span><span class="p">(</span><span class="n">CTRL_CMD_NEWFAMILY</span><span class="p">,</span> <span class="n">family</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout_locked:</span>
	<span class="n">genl_unlock</span><span class="p">();</span>
<span class="nl">errout:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_register_family</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * genl_register_family_with_ops - register a generic netlink family</span>
<span class="cm"> * @family: generic netlink family</span>
<span class="cm"> * @ops: operations to be registered</span>
<span class="cm"> * @n_ops: number of elements to register</span>
<span class="cm"> *</span>
<span class="cm"> * Registers the specified family and operations from the specified table.</span>
<span class="cm"> * Only one family may be registered with the same family name or identifier.</span>
<span class="cm"> *</span>
<span class="cm"> * The family id may equal GENL_ID_GENERATE causing an unique id to</span>
<span class="cm"> * be automatically generated and assigned.</span>
<span class="cm"> *</span>
<span class="cm"> * Either a doit or dumpit callback must be specified for every registered</span>
<span class="cm"> * operation or the function will fail. Only one operation structure per</span>
<span class="cm"> * command identifier may be registered.</span>
<span class="cm"> *</span>
<span class="cm"> * See include/net/genetlink.h for more documenation on the operations</span>
<span class="cm"> * structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This is equivalent to calling genl_register_family() followed by</span>
<span class="cm"> * genl_register_ops() for every operation entry in the table taking</span>
<span class="cm"> * care to unregister the family on error path.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">genl_register_family_with_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_family</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ops</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_ops</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="n">genl_unregister_family</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_register_family_with_ops</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * genl_unregister_family - unregister generic netlink family</span>
<span class="cm"> * @family: generic netlink family</span>
<span class="cm"> *</span>
<span class="cm"> * Unregisters the specified family.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">genl_unregister_family</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>

	<span class="n">genl_lock</span><span class="p">();</span>

	<span class="n">genl_unregister_mc_groups</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">genl_family_chain</span><span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span> <span class="n">family_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">family_list</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">);</span>
		<span class="n">genl_unlock</span><span class="p">();</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">attrbuf</span><span class="p">);</span>
		<span class="n">genl_ctrl_event</span><span class="p">(</span><span class="n">CTRL_CMD_DELFAMILY</span><span class="p">,</span> <span class="n">family</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_unregister_family</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * genlmsg_put - Add generic netlink header to netlink message</span>
<span class="cm"> * @skb: socket buffer holding the message</span>
<span class="cm"> * @pid: netlink pid the message is addressed to</span>
<span class="cm"> * @seq: sequence number (usually the one of the sender)</span>
<span class="cm"> * @family: generic netlink family</span>
<span class="cm"> * @flags netlink message flags</span>
<span class="cm"> * @cmd: generic netlink command</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to user specific header</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">genlmsg_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genlmsghdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">GENL_HDRLEN</span> <span class="o">+</span>
			<span class="n">family</span><span class="o">-&gt;</span><span class="n">hdrsize</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span> <span class="o">+</span> <span class="n">GENL_HDRLEN</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genlmsg_put</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genl_rcv_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">genl_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genlmsghdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">family</span> <span class="o">=</span> <span class="n">genl_family_find_byid</span><span class="p">(</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="cm">/* this family doesn&#39;t exist in this netns */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">netnsok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">GENL_HDRLEN</span> <span class="o">+</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">hdrsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_len</span> <span class="o">&lt;</span> <span class="n">nlmsg_msg_size</span><span class="p">(</span><span class="n">hdrlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">genl_get_cmd</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_DUMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dumpit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

		<span class="n">genl_unlock</span><span class="p">();</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">netlink_dump_control</span> <span class="n">c</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">dumpit</span><span class="p">,</span>
				<span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">,</span>
			<span class="p">};</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">netlink_dump_start</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">genl_lock</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">doit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">attrbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">attrbuf</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">maxattr</span><span class="p">,</span>
				  <span class="n">ops</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">.</span><span class="n">snd_seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">snd_pid</span> <span class="o">=</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlhdr</span> <span class="o">=</span> <span class="n">nlh</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">genlhdr</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">userhdr</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">)</span> <span class="o">+</span> <span class="n">GENL_HDRLEN</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">attrbuf</span><span class="p">;</span>
	<span class="n">genl_info_net_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">user_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">user_ptr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">pre_doit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">pre_doit</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">doit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">post_doit</span><span class="p">)</span>
		<span class="n">family</span><span class="o">-&gt;</span><span class="n">post_doit</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">genl_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">genl_lock</span><span class="p">();</span>
	<span class="n">netlink_rcv_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genl_rcv_msg</span><span class="p">);</span>
	<span class="n">genl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Controller</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="n">genl_ctrl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nlctrl&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxattr</span> <span class="o">=</span> <span class="n">CTRL_ATTR_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">netnsok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_fill_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genl_ctrl</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_FAMILY_NAME</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_FAMILY_ID</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_VERSION</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_HDRSIZE</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">hdrsize</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_MAXATTR</span><span class="p">,</span> <span class="n">family</span><span class="o">-&gt;</span><span class="n">maxattr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla_ops</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">nla_ops</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_OPS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">ops_list</span><span class="p">,</span> <span class="n">ops_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>

			<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_OP_ID</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_OP_FLAGS</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nla_ops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">mcast_groups</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla_grps</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">nla_grps</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_MCAST_GROUPS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_grps</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">mcast_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>

			<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_MCAST_GRP_ID</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_MCAST_GRP_NAME</span><span class="p">,</span>
					   <span class="n">grp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nla_grps</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_fill_mcgrp_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla_grps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genl_ctrl</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_FAMILY_NAME</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_FAMILY_ID</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_grps</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_MCAST_GROUPS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_grps</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_MCAST_GRP_ID</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_ATTR_MCAST_GRP_NAME</span><span class="p">,</span>
			   <span class="n">grp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nla_grps</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_dumpfamily</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chains_to_skip</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fams_to_skip</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">chains_to_skip</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GENL_FAM_TAB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">genl_family_chain</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">family_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">netnsok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">fams_to_skip</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_fill_info</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					   <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
					   <span class="n">skb</span><span class="p">,</span> <span class="n">CTRL_CMD_NEWFAMILY</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fams_to_skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">errout:</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ctrl_build_family_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ctrl_fill_info</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ctrl_build_mcgrp_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">,</span>
					    <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ctrl_fill_mcgrp_info</span><span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">ctrl_policy</span><span class="p">[</span><span class="n">CTRL_ATTR_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CTRL_ATTR_FAMILY_ID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTRL_ATTR_FAMILY_NAME</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NUL_STRING</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">GENL_NAMSIZ</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_getfamily</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">CTRL_ATTR_FAMILY_ID</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">id</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">CTRL_ATTR_FAMILY_ID</span><span class="p">]);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">genl_family_find_byid</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">CTRL_ATTR_FAMILY_NAME</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">CTRL_ATTR_FAMILY_NAME</span><span class="p">]);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">genl_family_find_byname</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MODULES</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genl_unlock</span><span class="p">();</span>
			<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;net-pf-%d-proto-%d-family-%s&quot;</span><span class="p">,</span>
				       <span class="n">PF_NETLINK</span><span class="p">,</span> <span class="n">NETLINK_GENERIC</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">genl_lock</span><span class="p">();</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">genl_family_find_byname</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">netnsok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* family doesn&#39;t exist here */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">ctrl_build_family_msg</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span>
				    <span class="n">CTRL_CMD_NEWFAMILY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genl_ctrl_event</span><span class="p">(</span><span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>

	<span class="cm">/* genl is still initialising */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_net</span><span class="p">.</span><span class="n">genl_sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTRL_CMD_NEWFAMILY</span>:
	<span class="k">case</span> <span class="n">CTRL_CMD_DELFAMILY</span>:
		<span class="n">family</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ctrl_build_family_msg</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTRL_CMD_NEWMCAST_GRP</span>:
	<span class="k">case</span> <span class="n">CTRL_CMD_DELMCAST_GRP</span>:
		<span class="n">grp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">family</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ctrl_build_mcgrp_msg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">netnsok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genlmsg_multicast_netns</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">GENL_ID_CTRL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">genlmsg_multicast_allns</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GENL_ID_CTRL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="n">genl_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cmd</span>		<span class="o">=</span> <span class="n">CTRL_CMD_GETFAMILY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">doit</span>		<span class="o">=</span> <span class="n">ctrl_getfamily</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dumpit</span>		<span class="o">=</span> <span class="n">ctrl_dumpfamily</span><span class="p">,</span>
	<span class="p">.</span><span class="n">policy</span>		<span class="o">=</span> <span class="n">ctrl_policy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">notify_grp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;notify&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">genl_pernet_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* we&#39;ll bump the group number right afterwards */</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span> <span class="o">=</span> <span class="n">netlink_kernel_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">NETLINK_GENERIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">genl_rcv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genl_mutex</span><span class="p">,</span>
					       <span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span> <span class="o">&amp;&amp;</span> <span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;GENL: Cannot initialize generic netlink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">genl_pernet_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netlink_kernel_release</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">);</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">genl_pernet_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">genl_pernet_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">genl_pernet_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">genl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GENL_FAM_TAB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family_ht</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_family_with_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genl_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genl_ctrl_ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">problem</span><span class="p">;</span>

	<span class="n">netlink_set_nonroot</span><span class="p">(</span><span class="n">NETLINK_GENERIC</span><span class="p">,</span> <span class="n">NL_NONROOT_RECV</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genl_pernet_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">problem</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genl_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notify_grp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">problem</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">problem:</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;GENL: Cannot register controller: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">genl_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genlmsg_mcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">group</span><span class="p">,</span>
			 <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">for_each_net_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
					      <span class="n">pid</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prev</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 <span class="nl">error:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">genlmsg_multicast_allns</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">group</span><span class="p">,</span>
			    <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">genlmsg_mcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genlmsg_multicast_allns</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">genl_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">group</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">genl_sock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span><span class="p">)</span>
		<span class="n">report</span> <span class="o">=</span> <span class="n">nlmsg_report</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>

	<span class="n">nlmsg_notify</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">genl_notify</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
