<!DOCTYPE html>
<html><head><title>joekychen/linux » net › rds › rds.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rds.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _RDS_RDS_H</span>
<span class="cp">#define _RDS_RDS_H</span>

<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;rdma/rdma_cm.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/rds.h&gt;</span>

<span class="cp">#include &quot;info.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * RDS Network protocol version</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_PROTOCOL_3_0	0x0300</span>
<span class="cp">#define RDS_PROTOCOL_3_1	0x0301</span>
<span class="cp">#define RDS_PROTOCOL_VERSION	RDS_PROTOCOL_3_1</span>
<span class="cp">#define RDS_PROTOCOL_MAJOR(v)	((v) &gt;&gt; 8)</span>
<span class="cp">#define RDS_PROTOCOL_MINOR(v)	((v) &amp; 255)</span>
<span class="cp">#define RDS_PROTOCOL(maj, min)	(((maj) &lt;&lt; 8) | min)</span>

<span class="cm">/*</span>
<span class="cm"> * XXX randomly chosen, but at least seems to be unused:</span>
<span class="cm"> * #               18464-18768 Unassigned</span>
<span class="cm"> * We should do better.  We want a reserved port to discourage unpriv&#39;ed</span>
<span class="cm"> * userspace from listening.</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_PORT	18634</span>

<span class="cp">#ifdef ATOMIC64_INIT</span>
<span class="cp">#define KERNEL_HAS_ATOMIC64</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define rdsdebug(fmt, args...) pr_debug(&quot;%s(): &quot; fmt, __func__ , ##args)</span>
<span class="cp">#else</span>
<span class="cm">/* sigh, pr_debug() causes unused variable warnings */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="nf">__printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">void</span> <span class="n">rdsdebug</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* XXX is there one of these somewhere? */</span>
<span class="cp">#define ceil(x, y) \</span>
<span class="cp">	({ unsigned long __x = (x), __y = (y); (__x + __y - 1) / __y; })</span>

<span class="cp">#define RDS_FRAG_SHIFT	12</span>
<span class="cp">#define RDS_FRAG_SIZE	((unsigned int)(1 &lt;&lt; RDS_FRAG_SHIFT))</span>

<span class="cp">#define RDS_CONG_MAP_BYTES	(65536 / 8)</span>
<span class="cp">#define RDS_CONG_MAP_PAGES	(PAGE_ALIGN(RDS_CONG_MAP_BYTES) / PAGE_SIZE)</span>
<span class="cp">#define RDS_CONG_MAP_PAGE_BITS	(PAGE_SIZE * 8)</span>

<span class="k">struct</span> <span class="n">rds_cong_map</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span>		<span class="n">m_rb_node</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">m_addr</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">m_waitq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">m_conn_list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">m_page_addrs</span><span class="p">[</span><span class="n">RDS_CONG_MAP_PAGES</span><span class="p">];</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * This is how we will track the connection state:</span>
<span class="cm"> * A connection is always in one of the following</span>
<span class="cm"> * states. Updates to the state are atomic and imply</span>
<span class="cm"> * a memory barrier.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">RDS_CONN_DOWN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RDS_CONN_CONNECTING</span><span class="p">,</span>
	<span class="n">RDS_CONN_DISCONNECTING</span><span class="p">,</span>
	<span class="n">RDS_CONN_UP</span><span class="p">,</span>
	<span class="n">RDS_CONN_ERROR</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits for c_flags */</span>
<span class="cp">#define RDS_LL_SEND_FULL	0</span>
<span class="cp">#define RDS_RECONNECT_PENDING	1</span>
<span class="cp">#define RDS_IN_XMIT		2</span>

<span class="k">struct</span> <span class="n">rds_connection</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span>	<span class="n">c_hash_node</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">c_laddr</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">c_faddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_loopback</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_connection</span>	<span class="o">*</span><span class="n">c_passive</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rds_cong_map</span>	<span class="o">*</span><span class="n">c_lcong</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_cong_map</span>	<span class="o">*</span><span class="n">c_fcong</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rds_message</span>	<span class="o">*</span><span class="n">c_xmit_rm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">c_xmit_sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_xmit_hdr_off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_xmit_data_off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_xmit_atomic_sent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_xmit_rdma_sent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_xmit_data_sent</span><span class="p">;</span>

	<span class="n">spinlock_t</span>		<span class="n">c_lock</span><span class="p">;</span>		<span class="cm">/* protect msg queues */</span>
	<span class="n">u64</span>			<span class="n">c_next_tx_seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">c_send_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">c_retrans</span><span class="p">;</span>

	<span class="n">u64</span>			<span class="n">c_next_rx_seq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rds_transport</span>	<span class="o">*</span><span class="n">c_trans</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">c_transport_data</span><span class="p">;</span>

	<span class="n">atomic_t</span>		<span class="n">c_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">c_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">c_reconnect_jiffies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">c_send_w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">c_recv_w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">c_conn_w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">c_down_w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">c_cm_lock</span><span class="p">;</span>	<span class="cm">/* protect conn state &amp; cm */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">c_waitq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">c_map_item</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">c_map_queued</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_unacked_packets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_unacked_bytes</span><span class="p">;</span>

	<span class="cm">/* Protocol version */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_version</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define RDS_FLAG_CONG_BITMAP	0x01</span>
<span class="cp">#define RDS_FLAG_ACK_REQUIRED	0x02</span>
<span class="cp">#define RDS_FLAG_RETRANSMITTED	0x04</span>
<span class="cp">#define RDS_MAX_ADV_CREDIT	255</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum space available for extension headers.</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_HEADER_EXT_SPACE	16</span>

<span class="k">struct</span> <span class="n">rds_header</span> <span class="p">{</span>
	<span class="n">__be64</span>	<span class="n">h_sequence</span><span class="p">;</span>
	<span class="n">__be64</span>	<span class="n">h_ack</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">h_len</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">h_sport</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">h_dport</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">h_flags</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">h_credit</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">h_padding</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">__sum16</span>	<span class="n">h_csum</span><span class="p">;</span>

	<span class="n">u8</span>	<span class="n">h_exthdr</span><span class="p">[</span><span class="n">RDS_HEADER_EXT_SPACE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Reserved - indicates end of extensions</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_EXTHDR_NONE		0</span>

<span class="cm">/*</span>
<span class="cm"> * This extension header is included in the very</span>
<span class="cm"> * first message that is sent on a new connection,</span>
<span class="cm"> * and identifies the protocol level. This will help</span>
<span class="cm"> * rolling updates if a future change requires breaking</span>
<span class="cm"> * the protocol.</span>
<span class="cm"> * NB: This is no longer true for IB, where we do a version</span>
<span class="cm"> * negotiation during the connection setup phase (protocol</span>
<span class="cm"> * version information is included in the RDMA CM private data).</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_EXTHDR_VERSION	1</span>
<span class="k">struct</span> <span class="n">rds_ext_header_version</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">h_version</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This extension header is included in the RDS message</span>
<span class="cm"> * chasing an RDMA operation.</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_EXTHDR_RDMA		2</span>
<span class="k">struct</span> <span class="n">rds_ext_header_rdma</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">h_rdma_rkey</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This extension header tells the peer about the</span>
<span class="cm"> * destination &lt;R_Key,offset&gt; of the requested RDMA</span>
<span class="cm"> * operation.</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_EXTHDR_RDMA_DEST	3</span>
<span class="k">struct</span> <span class="n">rds_ext_header_rdma_dest</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">h_rdma_rkey</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">h_rdma_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define __RDS_EXTHDR_MAX	16 </span><span class="cm">/* for now */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">rds_incoming</span> <span class="p">{</span>
	<span class="n">atomic_t</span>		<span class="n">i_refcount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">i_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_connection</span>	<span class="o">*</span><span class="n">i_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_header</span>	<span class="n">i_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">i_rx_jiffies</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">i_saddr</span><span class="p">;</span>

	<span class="n">rds_rdma_cookie_t</span>	<span class="n">i_rdma_cookie</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_mr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span>		<span class="n">r_rb_node</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">r_refcount</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">r_key</span><span class="p">;</span>

	<span class="cm">/* A copy of the creation flags */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">r_use_once</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">r_invalidate</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">r_write</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* This is for RDS_MR_DEAD.</span>
<span class="cm">	 * It would be nice &amp; consistent to make this part of the above</span>
<span class="cm">	 * bit field here, but we need to use test_and_set_bit.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">r_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_sock</span>		<span class="o">*</span><span class="n">r_sock</span><span class="p">;</span> <span class="cm">/* back pointer to the socket that owns us */</span>
	<span class="k">struct</span> <span class="n">rds_transport</span>	<span class="o">*</span><span class="n">r_trans</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">r_trans_private</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Flags for mr-&gt;r_state */</span>
<span class="cp">#define RDS_MR_DEAD		0</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">rds_rdma_cookie_t</span> <span class="nf">rds_rdma_make_cookie</span><span class="p">(</span><span class="n">u32</span> <span class="n">r_key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">r_key</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rds_rdma_cookie_key</span><span class="p">(</span><span class="n">rds_rdma_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rds_rdma_cookie_offset</span><span class="p">(</span><span class="n">rds_rdma_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cookie</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* atomic operation types */</span>
<span class="cp">#define RDS_ATOMIC_TYPE_CSWP		0</span>
<span class="cp">#define RDS_ATOMIC_TYPE_FADD		1</span>

<span class="cm">/*</span>
<span class="cm"> * m_sock_item and m_conn_item are on lists that are serialized under</span>
<span class="cm"> * conn-&gt;c_lock.  m_sock_item has additional meaning in that once it is empty</span>
<span class="cm"> * the message will not be put back on the retransmit list after being sent.</span>
<span class="cm"> * messages that are canceled while being sent rely on this.</span>
<span class="cm"> *</span>
<span class="cm"> * m_inc is used by loopback so that it can pass an incoming message straight</span>
<span class="cm"> * back up into the rx path.  It embeds a wire header which is also used by</span>
<span class="cm"> * the send path, which is kind of awkward.</span>
<span class="cm"> *</span>
<span class="cm"> * m_sock_item indicates the message&#39;s presence on a socket&#39;s send or receive</span>
<span class="cm"> * queue.  m_rs will point to that socket.</span>
<span class="cm"> *</span>
<span class="cm"> * m_daddr is used by cancellation to prune messages to a given destination.</span>
<span class="cm"> *</span>
<span class="cm"> * The RDS_MSG_ON_SOCK and RDS_MSG_ON_CONN flags are used to avoid lock</span>
<span class="cm"> * nesting.  As paths iterate over messages on a sock, or conn, they must</span>
<span class="cm"> * also lock the conn, or sock, to remove the message from those lists too.</span>
<span class="cm"> * Testing the flag to determine if the message is still on the lists lets</span>
<span class="cm"> * us avoid testing the list_head directly.  That means each path can use</span>
<span class="cm"> * the message&#39;s list_head to keep it on a local list while juggling locks</span>
<span class="cm"> * without confusing the other path.</span>
<span class="cm"> *</span>
<span class="cm"> * m_ack_seq is an optional field set by transports who need a different</span>
<span class="cm"> * sequence number range to invalidate.  They can use this in a callback</span>
<span class="cm"> * that they pass to rds_send_drop_acked() to see if each message has been</span>
<span class="cm"> * acked.  The HAS_ACK_SEQ flag can be used to detect messages which haven&#39;t</span>
<span class="cm"> * had ack_seq set yet.</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_MSG_ON_SOCK		1</span>
<span class="cp">#define RDS_MSG_ON_CONN		2</span>
<span class="cp">#define RDS_MSG_HAS_ACK_SEQ	3</span>
<span class="cp">#define RDS_MSG_ACK_REQUIRED	4</span>
<span class="cp">#define RDS_MSG_RETRANSMITTED	5</span>
<span class="cp">#define RDS_MSG_MAPPED		6</span>
<span class="cp">#define RDS_MSG_PAGEVEC		7</span>

<span class="k">struct</span> <span class="n">rds_message</span> <span class="p">{</span>
	<span class="n">atomic_t</span>		<span class="n">m_refcount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">m_sock_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">m_conn_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_incoming</span>	<span class="n">m_inc</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">m_ack_seq</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">m_daddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">m_flags</span><span class="p">;</span>

	<span class="cm">/* Never access m_rs without holding m_rs_lock.</span>
<span class="cm">	 * Lock nesting is</span>
<span class="cm">	 *  rm-&gt;m_rs_lock</span>
<span class="cm">	 *   -&gt; rs-&gt;rs_lock</span>
<span class="cm">	 */</span>
	<span class="n">spinlock_t</span>		<span class="n">m_rs_lock</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">m_flush_wait</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rds_sock</span>		<span class="o">*</span><span class="n">m_rs</span><span class="p">;</span>

	<span class="cm">/* cookie to send to remote, in rds header */</span>
	<span class="n">rds_rdma_cookie_t</span>	<span class="n">m_rdma_cookie</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">m_used_sgs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">m_total_sgs</span><span class="p">;</span>

	<span class="kt">void</span>			<span class="o">*</span><span class="n">m_final_op</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rm_atomic_op</span> <span class="p">{</span>
			<span class="kt">int</span>			<span class="n">op_type</span><span class="p">;</span>
			<span class="k">union</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="p">{</span>
					<span class="kt">uint64_t</span>	<span class="n">compare</span><span class="p">;</span>
					<span class="kt">uint64_t</span>	<span class="n">swap</span><span class="p">;</span>
					<span class="kt">uint64_t</span>	<span class="n">compare_mask</span><span class="p">;</span>
					<span class="kt">uint64_t</span>	<span class="n">swap_mask</span><span class="p">;</span>
				<span class="p">}</span> <span class="n">op_m_cswp</span><span class="p">;</span>
				<span class="k">struct</span> <span class="p">{</span>
					<span class="kt">uint64_t</span>	<span class="n">add</span><span class="p">;</span>
					<span class="kt">uint64_t</span>	<span class="n">nocarry_mask</span><span class="p">;</span>
				<span class="p">}</span> <span class="n">op_m_fadd</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="n">u32</span>			<span class="n">op_rkey</span><span class="p">;</span>
			<span class="n">u64</span>			<span class="n">op_remote_addr</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_notify</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_recverr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_mapped</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_silent</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">op_sg</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">rds_notifier</span>	<span class="o">*</span><span class="n">op_notifier</span><span class="p">;</span>

			<span class="k">struct</span> <span class="n">rds_mr</span>		<span class="o">*</span><span class="n">op_rdma_mr</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">atomic</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="p">{</span>
			<span class="n">u32</span>			<span class="n">op_rkey</span><span class="p">;</span>
			<span class="n">u64</span>			<span class="n">op_remote_addr</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_write</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_fence</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_notify</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_recverr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_mapped</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_silent</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_bytes</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_nents</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_count</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">op_sg</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">rds_notifier</span>	<span class="o">*</span><span class="n">op_notifier</span><span class="p">;</span>

			<span class="k">struct</span> <span class="n">rds_mr</span>		<span class="o">*</span><span class="n">op_rdma_mr</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">rdma</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rm_data_op</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_nents</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">op_count</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">op_sg</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The RDS notifier is used (optionally) to tell the application about</span>
<span class="cm"> * completed RDMA operations. Rather than keeping the whole rds message</span>
<span class="cm"> * around on the queue, we allocate a small notifier that is put on the</span>
<span class="cm"> * socket&#39;s notifier_list. Notifications are delivered to the application</span>
<span class="cm"> * through control messages.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rds_notifier</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">n_list</span><span class="p">;</span>
	<span class="kt">uint64_t</span>		<span class="n">n_user_token</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">n_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct rds_transport -  transport specific behavioural hooks</span>
<span class="cm"> *</span>
<span class="cm"> * @xmit: .xmit is called by rds_send_xmit() to tell the transport to send</span>
<span class="cm"> *        part of a message.  The caller serializes on the send_sem so this</span>
<span class="cm"> *        doesn&#39;t need to be reentrant for a given conn.  The header must be</span>
<span class="cm"> *        sent before the data payload.  .xmit must be prepared to send a</span>
<span class="cm"> *        message with no data payload.  .xmit should return the number of</span>
<span class="cm"> *        bytes that were sent down the connection, including header bytes.</span>
<span class="cm"> *        Returning 0 tells the caller that it doesn&#39;t need to perform any</span>
<span class="cm"> *        additional work now.  This is usually the case when the transport has</span>
<span class="cm"> *        filled the sending queue for its connection and will handle</span>
<span class="cm"> *        triggering the rds thread to continue the send when space becomes</span>
<span class="cm"> *        available.  Returning -EAGAIN tells the caller to retry the send</span>
<span class="cm"> *        immediately.  Returning -ENOMEM tells the caller to retry the send at</span>
<span class="cm"> *        some point in the future.</span>
<span class="cm"> *</span>
<span class="cm"> * @conn_shutdown: conn_shutdown stops traffic on the given connection.  Once</span>
<span class="cm"> *                 it returns the connection can not call rds_recv_incoming().</span>
<span class="cm"> *                 This will only be called once after conn_connect returns</span>
<span class="cm"> *                 non-zero success and will The caller serializes this with</span>
<span class="cm"> *                 the send and connecting paths (xmit_* and conn_*).  The</span>
<span class="cm"> *                 transport is responsible for other serialization, including</span>
<span class="cm"> *                 rds_recv_incoming().  This is called in process context but</span>
<span class="cm"> *                 should try hard not to block.</span>
<span class="cm"> */</span>

<span class="cp">#define RDS_TRANS_IB	0</span>
<span class="cp">#define RDS_TRANS_IWARP	1</span>
<span class="cp">#define RDS_TRANS_TCP	2</span>
<span class="cp">#define RDS_TRANS_COUNT	3</span>

<span class="k">struct</span> <span class="n">rds_transport</span> <span class="p">{</span>
	<span class="kt">char</span>			<span class="n">t_name</span><span class="p">[</span><span class="n">TRANSNAMSIZ</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">t_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">module</span>		<span class="o">*</span><span class="n">t_owner</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">t_prefer_loopback</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">t_type</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">laddr_check</span><span class="p">)(</span><span class="n">__be32</span> <span class="n">addr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">conn_alloc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">conn_free</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">conn_connect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">conn_shutdown</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit_prepare</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit_complete</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdr_off</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit_rdma</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="o">*</span><span class="n">op</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit_atomic</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rm_atomic_op</span> <span class="o">*</span><span class="n">op</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">recv</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">inc_copy_to_user</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">inc_free</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">);</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cm_handle_connect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rdma_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cm_initiate_connect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cm_connect_complete</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">rdma_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">stats_info_copy</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_info_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">avail</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">exit</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_mr</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_sg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">key_ret</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">sync_mr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">trans_private</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">free_mr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">trans_private</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invalidate</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">flush_mrs</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_sock</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span>		<span class="n">rs_sk</span><span class="p">;</span>

	<span class="n">u64</span>			<span class="n">rs_user_addr</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">rs_user_bytes</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * bound_addr used for both incoming and outgoing, no INADDR_ANY</span>
<span class="cm">	 * support.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">hlist_node</span>	<span class="n">rs_bound_node</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">rs_bound_addr</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">rs_conn_addr</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">rs_bound_port</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">rs_conn_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_transport</span>    <span class="o">*</span><span class="n">rs_transport</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * rds_sendmsg caches the conn it used the last time around.</span>
<span class="cm">	 * This helps avoid costly lookups.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">rds_connection</span>	<span class="o">*</span><span class="n">rs_conn</span><span class="p">;</span>

	<span class="cm">/* flag indicating we were congested or not */</span>
	<span class="kt">int</span>			<span class="n">rs_congested</span><span class="p">;</span>
	<span class="cm">/* seen congestion (ENOBUFS) when sending? */</span>
	<span class="kt">int</span>			<span class="n">rs_seen_congestion</span><span class="p">;</span>

	<span class="cm">/* rs_lock protects all these adjacent members before the newline */</span>
	<span class="n">spinlock_t</span>		<span class="n">rs_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rs_send_queue</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rs_snd_bytes</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rs_rcv_bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rs_notify_queue</span><span class="p">;</span>	<span class="cm">/* currently used for failed RDMAs */</span>

	<span class="cm">/* Congestion wake_up. If rs_cong_monitor is set, we use cong_mask</span>
<span class="cm">	 * to decide whether the application should be woken up.</span>
<span class="cm">	 * If not set, we use rs_cong_track to find out whether a cong map</span>
<span class="cm">	 * update arrived.</span>
<span class="cm">	 */</span>
	<span class="kt">uint64_t</span>		<span class="n">rs_cong_mask</span><span class="p">;</span>
	<span class="kt">uint64_t</span>		<span class="n">rs_cong_notify</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rs_cong_list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">rs_cong_track</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * rs_recv_lock protects the receive queue, and is</span>
<span class="cm">	 * used to serialize with rds_release.</span>
<span class="cm">	 */</span>
	<span class="n">rwlock_t</span>		<span class="n">rs_recv_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rs_recv_queue</span><span class="p">;</span>

	<span class="cm">/* just for stats reporting */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rs_item</span><span class="p">;</span>

	<span class="cm">/* these have their own lock */</span>
	<span class="n">spinlock_t</span>		<span class="n">rs_rdma_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span>		<span class="n">rs_rdma_keys</span><span class="p">;</span>

	<span class="cm">/* Socket options - in case there will be more */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">rs_recverr</span><span class="p">,</span>
				<span class="n">rs_cong_monitor</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="nf">rds_sk_to_rs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_sock</span><span class="p">,</span> <span class="n">rs_sk</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">rds_rs_to_sk</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The stack assigns sk_sndbuf and sk_rcvbuf to twice the specified value</span>
<span class="cm"> * to account for overhead.  We don&#39;t account for overhead, we just apply</span>
<span class="cm"> * the number of payload bytes to the specified value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rds_sk_sndbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rds_sk_rcvbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rds_statistics</span> <span class="p">{</span>
	<span class="kt">uint64_t</span>	<span class="n">s_conn_reset</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_drop_bad_checksum</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_drop_old_seq</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_drop_no_sock</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_drop_dead_sock</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_deliver_raced</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_delivered</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_queued</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_immediate_retry</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_delayed_retry</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_ack_required</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_rdma_bytes</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_recv_ping</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_queue_empty</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_queue_full</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_lock_contention</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_lock_queue_raced</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_immediate_retry</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_delayed_retry</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_drop_acked</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_ack_required</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_queued</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_rdma</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_rdma_bytes</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_send_pong</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_page_remainder_hit</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_page_remainder_miss</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_copy_to_user</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_copy_from_user</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_cong_update_queued</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_cong_update_received</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_cong_send_error</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">s_cong_send_blocked</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* af_rds.c */</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">rds_str_array</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">array</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">elements</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">index</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_sock_addref</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_sock_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_wake_sk_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__rds_wake_sk_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">waitq</span> <span class="o">=</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">waitq</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="n">waitq</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">extern</span> <span class="n">wait_queue_head_t</span> <span class="n">rds_poll_waitq</span><span class="p">;</span>


<span class="cm">/* bind.c */</span>
<span class="kt">int</span> <span class="n">rds_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_remove_bound</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rds_find_bound</span><span class="p">(</span><span class="n">__be32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">);</span>

<span class="cm">/* cong.c */</span>
<span class="kt">int</span> <span class="n">rds_cong_get_maps</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_add_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_remove_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_set_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_cong_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_clear_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_cong_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_cong_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_cong_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_queue_updates</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_cong_map</span> <span class="o">*</span><span class="n">map</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_map_updated</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_cong_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_cong_updated_since</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">recent</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_add_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_remove_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_cong_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rds_cong_update_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>

<span class="cm">/* conn.c */</span>
<span class="kt">int</span> <span class="n">rds_conn_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_conn_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">rds_conn_create</span><span class="p">(</span><span class="n">__be32</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">faddr</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">rds_transport</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">rds_conn_create_outgoing</span><span class="p">(</span><span class="n">__be32</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">faddr</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">rds_transport</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_conn_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_conn_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_conn_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_conn_connect_if_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_for_each_conn_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">rds_info_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">rds_info_lengths</span> <span class="o">*</span><span class="n">lens</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">visitor</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
			  <span class="kt">size_t</span> <span class="n">item_len</span><span class="p">);</span>
<span class="n">__printf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="kt">void</span> <span class="n">__rds_conn_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
<span class="cp">#define rds_conn_error(conn, fmt...) \</span>
<span class="cp">	__rds_conn_error(conn, KERN_WARNING &quot;RDS: &quot; fmt)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">rds_conn_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_state</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="n">old</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">rds_conn_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">rds_conn_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">RDS_CONN_UP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">rds_conn_connecting</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">RDS_CONN_CONNECTING</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* message.c */</span>
<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rds_message_alloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nents</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">rds_message_alloc_sgs</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nents</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_message_copy_from_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">first_iov</span><span class="p">,</span>
					       <span class="kt">size_t</span> <span class="n">total_len</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rds_message_map_pages</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">page_addrs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_len</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_message_populate_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">sport</span><span class="p">,</span>
				 <span class="n">__be16</span> <span class="n">dport</span><span class="p">,</span> <span class="n">u64</span> <span class="n">seq</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_message_add_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_message_next_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_message_add_rdma_dest_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">r_key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_message_inc_copy_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">first_iov</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_message_inc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_message_addref</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_message_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_message_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_message_unmapped</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rds_message_make_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_csum</span> <span class="o">=</span> <span class="n">ip_fast_csum</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rds_message_verify_checksum</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rds_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_csum</span> <span class="o">||</span> <span class="n">ip_fast_csum</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* page.c */</span>
<span class="kt">int</span> <span class="n">rds_page_remainder_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">scat</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">,</span>
			     <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_page_copy_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">to_user</span><span class="p">);</span>
<span class="cp">#define rds_page_copy_to_user(page, offset, ptr, bytes) \</span>
<span class="cp">	rds_page_copy_user(page, offset, ptr, bytes, 1)</span>
<span class="cp">#define rds_page_copy_from_user(page, offset, ptr, bytes) \</span>
<span class="cp">	rds_page_copy_user(page, offset, ptr, bytes, 0)</span>
<span class="kt">void</span> <span class="n">rds_page_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* recv.c */</span>
<span class="kt">void</span> <span class="n">rds_inc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
		  <span class="n">__be32</span> <span class="n">saddr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_inc_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_recv_incoming</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg_flags</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_clear_recv_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_notify_queue_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_inc_info_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_incoming</span> <span class="o">*</span><span class="n">inc</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">rds_info_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
		       <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flip</span><span class="p">);</span>

<span class="cm">/* send.c */</span>
<span class="kt">int</span> <span class="n">rds_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">payload_len</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_send_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_send_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">rds_send_drop_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">dest</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">is_acked_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">ack</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_send_drop_acked</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ack</span><span class="p">,</span>
			 <span class="n">is_acked_func</span> <span class="n">is_acked</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_send_pong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">dport</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rds_send_get_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* rdma.c */</span>
<span class="kt">void</span> <span class="n">rds_rdma_unuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">r_key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_get_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_get_mr_for_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_free_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_rdma_drop_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_rdma_extra_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_rdma_args</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_cmsg_rdma_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_cmsg_rdma_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_cmsg_rdma_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_cmsg_rdma_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_rdma_free_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="o">*</span><span class="n">ro</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_atomic_free_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">rm_atomic_op</span> <span class="o">*</span><span class="n">ao</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_rdma_send_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wc_status</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_atomic_send_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wc_status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_cmsg_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">__rds_put_mr_final</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rds_mr_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">r_refcount</span><span class="p">))</span>
		<span class="n">__rds_put_mr_final</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* stats.c */</span>
<span class="n">DECLARE_PER_CPU_SHARED_ALIGNED</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_statistics</span><span class="p">,</span> <span class="n">rds_stats</span><span class="p">);</span>
<span class="cp">#define rds_stats_inc_which(which, member) do {		\</span>
<span class="cp">	per_cpu(which, get_cpu()).member++;		\</span>
<span class="cp">	put_cpu();					\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define rds_stats_inc(member) rds_stats_inc_which(rds_stats, member)</span>
<span class="cp">#define rds_stats_add_which(which, member, count) do {		\</span>
<span class="cp">	per_cpu(which, get_cpu()).member += count;	\</span>
<span class="cp">	put_cpu();					\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define rds_stats_add(member, count) rds_stats_add_which(rds_stats, member, count)</span>
<span class="kt">int</span> <span class="n">rds_stats_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_stats_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_stats_info_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_info_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
			 <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">values</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">names</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">nr</span><span class="p">);</span>

<span class="cm">/* sysctl.c */</span>
<span class="kt">int</span> <span class="n">rds_sysctl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_sysctl_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rds_sysctl_sndbuf_min</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rds_sysctl_sndbuf_default</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rds_sysctl_sndbuf_max</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rds_sysctl_reconnect_min_jiffies</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rds_sysctl_reconnect_max_jiffies</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">rds_sysctl_max_unacked_packets</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">rds_sysctl_max_unacked_bytes</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">rds_sysctl_ping_enable</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rds_sysctl_trace_flags</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">rds_sysctl_trace_level</span><span class="p">;</span>

<span class="cm">/* threads.c */</span>
<span class="kt">int</span> <span class="n">rds_threads_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_threads_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">rds_wq</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">rds_queue_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_connect_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_shutdown_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_send_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_recv_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_connect_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>

<span class="cm">/* transport.c */</span>
<span class="kt">int</span> <span class="n">rds_trans_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_transport</span> <span class="o">*</span><span class="n">trans</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_trans_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_transport</span> <span class="o">*</span><span class="n">trans</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rds_transport</span> <span class="o">*</span><span class="n">rds_trans_get_preferred</span><span class="p">(</span><span class="n">__be32</span> <span class="n">addr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_trans_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_transport</span> <span class="o">*</span><span class="n">trans</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rds_trans_stats_info_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_info_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">avail</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rds_trans_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rds_trans_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
