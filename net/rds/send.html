<!DOCTYPE html>
<html><head><title>joekychen/linux » net › rds › send.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>send.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 Oracle.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &quot;rds.h&quot;</span>

<span class="cm">/* When transmitting messages in rds_send_xmit, we need to emerge from</span>
<span class="cm"> * time to time and briefly release the CPU. Otherwise the softlock watchdog</span>
<span class="cm"> * will kick our shin.</span>
<span class="cm"> * Also, it seems fairer to not let one busy connection stall all the</span>
<span class="cm"> * others.</span>
<span class="cm"> *</span>
<span class="cm"> * send_batch_count is the number of times we&#39;ll loop in send_xmit. Setting</span>
<span class="cm"> * it to 0 will restore the old behavior (where we looped until we had</span>
<span class="cm"> * drained the queue).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_batch_count</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">send_batch_count</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">send_batch_count</span><span class="p">,</span> <span class="s">&quot; batch factor when working the send queue&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rds_send_remove_from_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">messages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the send state.  Callers must ensure that this doesn&#39;t race with</span>
<span class="cm"> * rds_send_xmit().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rds_send_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rm</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rm</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* Tell the user the RDMA op is no longer mapped by the</span>
<span class="cm">		 * transport. This isn&#39;t entirely true (it&#39;s flushed out</span>
<span class="cm">		 * independently) but as the connection is down, there&#39;s</span>
<span class="cm">		 * no ongoing RDMA to/from that memory */</span>
		<span class="n">rds_message_unmapped</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
		<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_hdr_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_atomic_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rdma_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_map_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_packets</span> <span class="o">=</span> <span class="n">rds_sysctl_max_unacked_packets</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_bytes</span> <span class="o">=</span> <span class="n">rds_sysctl_max_unacked_bytes</span><span class="p">;</span>

	<span class="cm">/* Mark messages as retransmissions, and move them to the send q */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_retrans</span><span class="p">,</span> <span class="n">m_conn_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RDS_MSG_ACK_REQUIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RDS_MSG_RETRANSMITTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_retrans</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_send_queue</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acquire_in_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">RDS_IN_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_in_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RDS_IN_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t use wait_on_bit()/wake_up_bit() because our waking is in a</span>
<span class="cm">	 * hot path and finding waiters is very rare.  We don&#39;t want to walk</span>
<span class="cm">	 * the system-wide hashed waitqueue buckets in the fast path only to</span>
<span class="cm">	 * almost never find waiters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_waitq</span><span class="p">))</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We&#39;re making the conscious trade-off here to only send one message</span>
<span class="cm"> * down the connection at a time.</span>
<span class="cm"> *   Pro:</span>
<span class="cm"> *      - tx queueing is a simple fifo list</span>
<span class="cm"> *   	- reassembly is optional and easily done by transports per conn</span>
<span class="cm"> *      - no per flow rx lookup at all, straight to the socket</span>
<span class="cm"> *   	- less per-frag memory and wire overhead</span>
<span class="cm"> *   Con:</span>
<span class="cm"> *      - queued acks can be delayed behind large messages</span>
<span class="cm"> *   Depends:</span>
<span class="cm"> *      - small message latency is higher behind queued large messages</span>
<span class="cm"> *      - large message latency isn&#39;t starved by intervening small sends</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rds_send_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">to_be_dropped</span><span class="p">);</span>

<span class="nl">restart:</span>

	<span class="cm">/*</span>
<span class="cm">	 * sendmsg calls here after having queued its message on the send</span>
<span class="cm">	 * queue.  We only have one task feeding the connection at a time.  If</span>
<span class="cm">	 * another thread is already feeding the queue then we back off.  This</span>
<span class="cm">	 * avoids blocking the caller and trading per-connection data between</span>
<span class="cm">	 * caches per message.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acquire_in_xmit</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_lock_contention</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * rds_conn_shutdown() sets the conn state and then tests RDS_IN_XMIT,</span>
<span class="cm">	 * we do the opposite to avoid races.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rds_conn_up</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_in_xmit</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_prepare</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_prepare</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * spin trying to push headers and data down the connection until</span>
<span class="cm">	 * the connection doesn&#39;t make forward progress.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">rm</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rm</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If between sending messages, we can send a pending congestion</span>
<span class="cm">		 * map update.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span> <span class="o">&amp;&amp;</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_map_queued</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rm</span> <span class="o">=</span> <span class="n">rds_cong_update_alloc</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rm</span> <span class="o">=</span> <span class="n">rm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If not already working on one, grab the next message.</span>
<span class="cm">		 *</span>
<span class="cm">		 * c_xmit_rm holds a ref while we&#39;re sending this message down</span>
<span class="cm">		 * the connction.  We can use this ref while holding the</span>
<span class="cm">		 * send_sem.. rds_send_reset() is serialized with it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_send_queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_send_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">rds_message</span><span class="p">,</span>
						<span class="n">m_conn_item</span><span class="p">);</span>
				<span class="n">rds_message_addref</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * Move the message from the send queue to the retransmit</span>
<span class="cm">				 * list right away.</span>
<span class="cm">				 */</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_conn_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_retrans</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Unfortunately, the way Infiniband deals with</span>
<span class="cm">			 * RDMA to a bad MR key is by moving the entire</span>
<span class="cm">			 * queue pair to error state. We cold possibly</span>
<span class="cm">			 * recover from that, but right now we drop the</span>
<span class="cm">			 * connection.</span>
<span class="cm">			 * Therefore, we never retransmit messages with RDMA ops.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">RDS_MSG_RETRANSMITTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">))</span>
					<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_conn_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_be_dropped</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Require an ACK every once in a while */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">.</span><span class="n">h_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_packets</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_bytes</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__set_bit</span><span class="p">(</span><span class="n">RDS_MSG_ACK_REQUIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>

				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_packets</span> <span class="o">=</span> <span class="n">rds_sysctl_max_unacked_packets</span><span class="p">;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_bytes</span> <span class="o">=</span> <span class="n">rds_sysctl_max_unacked_bytes</span><span class="p">;</span>
				<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_ack_required</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_bytes</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_unacked_packets</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rm</span> <span class="o">=</span> <span class="n">rm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The transport either sends the whole rdma or none of it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rdma_sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_final_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_rdma</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rdma_sent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* The transport owns the mapped memory for now.</span>
<span class="cm">			 * You can&#39;t unmap it while it&#39;s on the send queue */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RDS_MSG_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_atomic_sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_final_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_atomic</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_atomic_sent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* The transport owns the mapped memory for now.</span>
<span class="cm">			 * You can&#39;t unmap it while it&#39;s on the send queue */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RDS_MSG_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * A number of cases require an RDS header to be sent</span>
<span class="cm">		 * even if there is no data.</span>
<span class="cm">		 * We permit 0-byte sends; rds-ping depends on this.</span>
<span class="cm">		 * However, if there are exclusively attached silent ops,</span>
<span class="cm">		 * we skip the hdr/data send, to enable silent operation.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_nents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ops_present</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">all_ops_are_silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">ops_present</span> <span class="o">=</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">.</span><span class="n">op_active</span> <span class="o">||</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">op_active</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">.</span><span class="n">op_silent</span><span class="p">)</span>
				<span class="n">all_ops_are_silent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">op_silent</span><span class="p">)</span>
				<span class="n">all_ops_are_silent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ops_present</span> <span class="o">&amp;&amp;</span> <span class="n">all_ops_are_silent</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rdma_cookie</span><span class="p">)</span>
				<span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_final_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span>
						  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_hdr_off</span><span class="p">,</span>
						  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_sg</span><span class="p">,</span>
						  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_off</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_hdr_off</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span><span class="p">)</span> <span class="o">-</span>
					    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_hdr_off</span><span class="p">);</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_hdr_off</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_sg</span><span class="p">[</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_sg</span><span class="p">];</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
						      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_off</span><span class="p">);</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_off</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_off</span> <span class="o">==</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
					<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_sg</span><span class="o">++</span><span class="p">;</span>
					<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					       <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_sg</span> <span class="o">==</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_nents</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_hdr_off</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_header</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_sg</span> <span class="o">==</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_nents</span><span class="p">))</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_sent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * A rm will only take multiple times through this loop</span>
<span class="cm">		 * if there is a data op. Thus, if the data is sent (or there was</span>
<span class="cm">		 * none), then we&#39;re done with the rm.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_active</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_hdr_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_rdma_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_atomic_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_xmit_data_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_complete</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_complete</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">release_in_xmit</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="cm">/* Nuke any messages we decided not to retransmit. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_be_dropped</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* irqs on here, so we can put(), unlike above */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_be_dropped</span><span class="p">,</span> <span class="n">m_conn_item</span><span class="p">)</span>
			<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
		<span class="n">rds_send_remove_from_sock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_be_dropped</span><span class="p">,</span> <span class="n">RDS_RDMA_DROPPED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Other senders can queue a message after we last test the send queue</span>
<span class="cm">	 * but before we clear RDS_IN_XMIT.  In that case they&#39;d back off and</span>
<span class="cm">	 * not try and send their newly queued message.  We need to check the</span>
<span class="cm">	 * send queue after having cleared RDS_IN_XMIT so that their message</span>
<span class="cm">	 * doesn&#39;t get stuck on the send queue.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the transport cannot continue (i.e ret != 0), then it must</span>
<span class="cm">	 * call us when more room is available, such as from the tx</span>
<span class="cm">	 * completion handler.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_send_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_lock_queue_raced</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rds_send_sndbuf_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">.</span><span class="n">h_len</span><span class="p">);</span>

	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_snd_bytes</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_snd_bytes</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_snd_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_queue_empty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rds_send_is_acked</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ack</span><span class="p">,</span>
				    <span class="n">is_acked_func</span> <span class="n">is_acked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_acked</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">is_acked</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">.</span><span class="n">h_sequence</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ack</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is pretty similar to what happens below in the ACK</span>
<span class="cm"> * handling code - except that we call here as soon as we get</span>
<span class="cm"> * the IB send completion on the RDMA op and the accompanying</span>
<span class="cm"> * message.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rds_rdma_send_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="o">*</span><span class="n">ro</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_notifier</span> <span class="o">*</span><span class="n">notifier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ro</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_SOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notify</span> <span class="o">&amp;&amp;</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">notifier</span> <span class="o">=</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="p">;</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs</span><span class="p">;</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>

		<span class="n">notifier</span><span class="o">-&gt;</span><span class="n">n_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notifier</span><span class="o">-&gt;</span><span class="n">n_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_notify_queue</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>

		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_wake_sk_sleep</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rds_rdma_send_complete</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Just like above, except looks at atomic op</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rds_atomic_send_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rm_atomic_op</span> <span class="o">*</span><span class="n">ao</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_notifier</span> <span class="o">*</span><span class="n">notifier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ao</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_SOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notify</span> <span class="o">&amp;&amp;</span> <span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">notifier</span> <span class="o">=</span> <span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="p">;</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs</span><span class="p">;</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>

		<span class="n">notifier</span><span class="o">-&gt;</span><span class="n">n_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notifier</span><span class="o">-&gt;</span><span class="n">n_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_notify_queue</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>

		<span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notifier</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_wake_sk_sleep</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rds_atomic_send_complete</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is the same as rds_rdma_send_complete except we</span>
<span class="cm"> * don&#39;t do any locking - we have all the ingredients (message,</span>
<span class="cm"> * socket, socket lock) and can just move the notifier.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__rds_send_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="o">*</span><span class="n">ro</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rm_atomic_op</span> <span class="o">*</span><span class="n">ao</span><span class="p">;</span>

	<span class="n">ro</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notify</span> <span class="o">&amp;&amp;</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="o">-&gt;</span><span class="n">n_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="o">-&gt;</span><span class="n">n_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_notify_queue</span><span class="p">);</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ao</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notify</span> <span class="o">&amp;&amp;</span> <span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="o">-&gt;</span><span class="n">n_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="o">-&gt;</span><span class="n">n_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_notify_queue</span><span class="p">);</span>
		<span class="n">ao</span><span class="o">-&gt;</span><span class="n">op_notifier</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No need to wake the app - caller does this */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called from the IB send completion when we detect</span>
<span class="cm"> * a RDMA operation that failed with remote access error.</span>
<span class="cm"> * So speed is not an issue here.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="nf">rds_send_get_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_retrans</span><span class="p">,</span> <span class="n">m_conn_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span> <span class="o">==</span> <span class="n">op</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_refcount</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">rm</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_send_queue</span><span class="p">,</span> <span class="n">m_conn_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span> <span class="o">==</span> <span class="n">op</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_refcount</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">rm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rds_send_get_message</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This removes messages from the socket&#39;s list if they&#39;re on it.  The list</span>
<span class="cm"> * argument must be private to the caller, we must be able to modify it</span>
<span class="cm"> * without locks.  The messages must have a reference held for their</span>
<span class="cm"> * position on the list.  This function will drop that reference after</span>
<span class="cm"> * removing the messages from the &#39;messages&#39; list regardless of if it found</span>
<span class="cm"> * the messages on the socket list or not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rds_send_remove_from_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">messages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">was_on_sock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">messages</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span><span class="p">,</span>
				<span class="n">m_conn_item</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_conn_item</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we see this flag cleared then we&#39;re *sure* that someone</span>
<span class="cm">		 * else beat us to removing it from the sock.  If we race</span>
<span class="cm">		 * with their flag update we&#39;ll get the lock and then really</span>
<span class="cm">		 * see that the flag has been cleared.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The message spinlock makes sure nobody clears rm-&gt;m_rs</span>
<span class="cm">		 * while we&#39;re messing with it. It does not prevent the</span>
<span class="cm">		 * message from being removed from the socket, though.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_SOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock_and_drop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rds_wake_sk_sleep</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
				<span class="n">sock_put</span><span class="p">(</span><span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">rs</span> <span class="o">=</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs</span><span class="p">;</span>
			<span class="n">sock_hold</span><span class="p">(</span><span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_SOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rm_rdma_op</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">rds_notifier</span> <span class="o">*</span><span class="n">notifier</span><span class="p">;</span>

			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_sock_item</span><span class="p">);</span>
			<span class="n">rds_send_sndbuf_remove</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notify</span> <span class="o">||</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_recverr</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">notifier</span> <span class="o">=</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">op_notifier</span><span class="p">;</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notifier</span><span class="o">-&gt;</span><span class="n">n_list</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_notify_queue</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">notifier</span><span class="o">-&gt;</span><span class="n">n_status</span><span class="p">)</span>
					<span class="n">notifier</span><span class="o">-&gt;</span><span class="n">n_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
				<span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">op_notifier</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">was_on_sock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>

<span class="nl">unlock_and_drop:</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">was_on_sock</span><span class="p">)</span>
			<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_wake_sk_sleep</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">rds_rs_to_sk</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transports call here when they&#39;ve determined that the receiver queued</span>
<span class="cm"> * messages up to, and including, the given sequence number.  Messages are</span>
<span class="cm"> * moved to the retrans queue when rds_send_xmit picks them off the send</span>
<span class="cm"> * queue. This means that in the TCP case, the message may not have been</span>
<span class="cm"> * assigned the m_ack_seq yet - but that&#39;s fine as long as tcp_is_acked</span>
<span class="cm"> * checks the RDS_MSG_HAS_ACK_SEQ bit.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX It&#39;s not clear to me how this is safely serialized with socket</span>
<span class="cm"> * destruction.  Maybe it should bail if it sees SOCK_DEAD.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rds_send_drop_acked</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ack</span><span class="p">,</span>
			 <span class="n">is_acked_func</span> <span class="n">is_acked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_retrans</span><span class="p">,</span> <span class="n">m_conn_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rds_send_is_acked</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">is_acked</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_conn_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* order flag updates with spin locks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">))</span>
		<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* now remove the messages from the sock list as needed */</span>
	<span class="n">rds_send_remove_from_sock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">RDS_RDMA_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rds_send_drop_acked</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rds_send_drop_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* get all the messages we&#39;re dropping under the rs lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_send_queue</span><span class="p">,</span> <span class="n">m_sock_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_daddr</span> <span class="o">||</span>
			     <span class="n">dest</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">!=</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">.</span><span class="n">h_dport</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_sock_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">rds_send_sndbuf_remove</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_SOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* order flag updates with the rs lock */</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Remove the messages from the conn */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">m_sock_item</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">conn</span> <span class="o">=</span> <span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_conn</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Maybe someone else beat us to removing rm from the conn.</span>
<span class="cm">		 * If we race with their flag update we&#39;ll get the lock and</span>
<span class="cm">		 * then really see that the flag has been cleared.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_conn_item</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Couldn&#39;t grab m_rs_lock in top loop (lock ordering),</span>
<span class="cm">		 * but we can now.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>
		<span class="n">__rds_send_complete</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">RDS_RDMA_CANCELED</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">);</span>

		<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rds_wake_sk_sleep</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span><span class="p">,</span> <span class="n">m_sock_item</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_sock_item</span><span class="p">);</span>

		<span class="n">rds_message_wait</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
		<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * we only want this to fire once so we use the callers &#39;queued&#39;.  It&#39;s</span>
<span class="cm"> * possible that another thread can race with us and remove the</span>
<span class="cm"> * message from the flow with RDS_CANCEL_SENT_TO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rds_send_queue_rm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">sport</span><span class="p">,</span>
			     <span class="n">__be16</span> <span class="n">dport</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">queued</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">queued</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">.</span><span class="n">h_len</span><span class="p">);</span>

	<span class="cm">/* this is the only place which holds both the socket&#39;s rs_lock</span>
<span class="cm">	 * and the connection&#39;s c_lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is a little space in sndbuf, we don&#39;t queue anything,</span>
<span class="cm">	 * and userspace gets -EAGAIN. But poll() indicates there&#39;s send</span>
<span class="cm">	 * room. This can lead to bad behavior (spinning) if snd_bytes isn&#39;t</span>
<span class="cm">	 * freed up by incoming acks. So we check the *old* value of</span>
<span class="cm">	 * rs_snd_bytes here to allow the last msg to exceed the buffer,</span>
<span class="cm">	 * and poll() now knows no more data can be sent.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_snd_bytes</span> <span class="o">&lt;</span> <span class="n">rds_sk_sndbuf</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_snd_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* let recv side know we are close to send space exhaustion.</span>
<span class="cm">		 * This is probably not the optimal way to do it, as this</span>
<span class="cm">		 * means we set the flag on *all* messages as soon as our</span>
<span class="cm">		 * throughput hits a certain threshold.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_snd_bytes</span> <span class="o">&gt;=</span> <span class="n">rds_sk_sndbuf</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">RDS_MSG_ACK_REQUIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_sock_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_send_queue</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_SOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
		<span class="n">rds_message_addref</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
		<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rs</span> <span class="o">=</span> <span class="n">rs</span><span class="p">;</span>

		<span class="cm">/* The code ordering is a little weird, but we&#39;re</span>
<span class="cm">		   trying to minimize the time we hold c_lock */</span>
		<span class="n">rds_message_populate_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
		<span class="n">rds_message_addref</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">);</span>
		<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">.</span><span class="n">h_sequence</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_next_tx_seq</span><span class="o">++</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_conn_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_send_queue</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">);</span>

		<span class="n">rdsdebug</span><span class="p">(</span><span class="s">&quot;queued msg %p len %d, rs %p bytes %d seq %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rm</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_snd_bytes</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">.</span><span class="n">h_sequence</span><span class="p">));</span>

		<span class="o">*</span><span class="n">queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">queued</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rds_message is getting to be quite complicated, and we&#39;d like to allocate</span>
<span class="cm"> * it all in one go. This figures out how big it needs to be up front.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rds_rm_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmsg_groups</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span> <span class="n">cmsg</span><span class="p">;</span> <span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_NXTHDR</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CMSG_OK</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">!=</span> <span class="n">SOL_RDS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RDS_CMSG_RDMA_ARGS</span>:
			<span class="n">cmsg_groups</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rds_rdma_extra_size</span><span class="p">(</span><span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">retval</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RDS_CMSG_RDMA_DEST</span>:
		<span class="k">case</span> <span class="n">RDS_CMSG_RDMA_MAP</span>:
			<span class="n">cmsg_groups</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* these are valid but do no add any size */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RDS_CMSG_ATOMIC_CSWP</span>:
		<span class="k">case</span> <span class="n">RDS_CMSG_ATOMIC_FADD</span>:
		<span class="k">case</span> <span class="n">RDS_CMSG_MASKED_ATOMIC_CSWP</span>:
		<span class="k">case</span> <span class="n">RDS_CMSG_MASKED_ATOMIC_FADD</span>:
			<span class="n">cmsg_groups</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">size</span> <span class="o">+=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">);</span>

	<span class="cm">/* Ensure (DEST, MAP) are never used with (ARGS, ATOMIC) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg_groups</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rds_cmsg_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">allocated_mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span> <span class="n">cmsg</span><span class="p">;</span> <span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_NXTHDR</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CMSG_OK</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">!=</span> <span class="n">SOL_RDS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* As a side effect, RDMA_DEST and RDMA_MAP will set</span>
<span class="cm">		 * rm-&gt;rdma.m_rdma_cookie and rm-&gt;rdma.m_rdma_mr.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RDS_CMSG_RDMA_ARGS</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_cmsg_rdma_args</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RDS_CMSG_RDMA_DEST</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_cmsg_rdma_dest</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RDS_CMSG_RDMA_MAP</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_cmsg_rdma_map</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="o">*</span><span class="n">allocated_mr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RDS_CMSG_ATOMIC_CSWP</span>:
		<span class="k">case</span> <span class="n">RDS_CMSG_ATOMIC_FADD</span>:
		<span class="k">case</span> <span class="n">RDS_CMSG_MASKED_ATOMIC_CSWP</span>:
		<span class="k">case</span> <span class="n">RDS_CMSG_MASKED_ATOMIC_FADD</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_cmsg_atomic</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rds_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">payload_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_sock</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">rds_sk_to_rs</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">usin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">dport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">allocated_mr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nonblock</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">);</span>

	<span class="cm">/* Mirror Linux UDP mirror of BSD error message compatibility */</span>
	<span class="cm">/* XXX: Perhaps MSG_MORE someday */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSG_DONTWAIT</span> <span class="o">|</span> <span class="n">MSG_CMSG_COMPAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* XXX fail non-unicast destination IPs? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">usin</span><span class="p">)</span> <span class="o">||</span> <span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">daddr</span> <span class="o">=</span> <span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
		<span class="n">dport</span> <span class="o">=</span> <span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We only care about consistency with -&gt;connect() */</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">daddr</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_conn_addr</span><span class="p">;</span>
		<span class="n">dport</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_conn_port</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* racing with another thread binding seems ok here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">daddr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_bound_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span> <span class="cm">/* XXX not a great errno */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* size of rm including all sgs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_rm_size</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rm</span> <span class="o">=</span> <span class="n">rds_message_alloc</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Attach data to the rm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_sg</span> <span class="o">=</span> <span class="n">rds_message_alloc_sgs</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">ceil</span><span class="p">(</span><span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_sg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_message_copy_from_user</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_daddr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>

	<span class="cm">/* rds_conn_create has a spinlock that runs with IRQ off.</span>
<span class="cm">	 * Caching the conn in the socket helps a lot. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_conn</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_conn</span><span class="o">-&gt;</span><span class="n">c_faddr</span> <span class="o">==</span> <span class="n">daddr</span><span class="p">)</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_conn</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">rds_conn_create_outgoing</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_bound_addr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span>
					<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_transport</span><span class="p">,</span>
					<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parse any control messages the user may have included. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_cmsg_send</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">allocated_mr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_rdma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;rdma_op %p conn xmit_rdma %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_rdma</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">.</span><span class="n">op_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_atomic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;atomic_op %p conn xmit_atomic %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_trans</span><span class="o">-&gt;</span><span class="n">xmit_atomic</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rds_conn_connect_if_down</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_cong_wait</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_fcong</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">,</span> <span class="n">rs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_seen_congestion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rds_send_queue_rm</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_bound_port</span><span class="p">,</span>
				  <span class="n">dport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queued</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_queue_full</span><span class="p">);</span>
		<span class="cm">/* XXX make sure this is reasonable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">payload_len</span> <span class="o">&gt;</span> <span class="n">rds_sk_sndbuf</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">timeo</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span>
					<span class="n">rds_send_queue_rm</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span>
							  <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_bound_port</span><span class="p">,</span>
							  <span class="n">dport</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">queued</span><span class="p">),</span>
					<span class="n">timeo</span><span class="p">);</span>
		<span class="n">rdsdebug</span><span class="p">(</span><span class="s">&quot;sendmsg woke queued %d timeo %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">queued</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeo</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timeo</span> <span class="o">==</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">timeo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * By now we&#39;ve committed to the send.  We reuse rds_send_worker()</span>
<span class="cm">	 * to retry sends in the rds thread if the transport asks us to.</span>
<span class="cm">	 */</span>
	<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_queued</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RDS_LL_SEND_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="p">))</span>
		<span class="n">rds_send_xmit</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">payload_len</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="cm">/* If the user included a RDMA_MAP cmsg, we allocated a MR on the fly.</span>
<span class="cm">	 * If the sendmsg goes through, we keep the MR. If it fails with EAGAIN</span>
<span class="cm">	 * or in any other way, we need to destroy the MR again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">allocated_mr</span><span class="p">)</span>
		<span class="n">rds_rdma_unuse</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rds_rdma_cookie_key</span><span class="p">(</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_rdma_cookie</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="p">)</span>
		<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reply to a ping packet.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rds_send_pong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rds_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">dport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_message</span> <span class="o">*</span><span class="n">rm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rm</span> <span class="o">=</span> <span class="n">rds_message_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_daddr</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_faddr</span><span class="p">;</span>
	<span class="n">rm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">op_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rds_conn_connect_if_down</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rds_cong_wait</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_fcong</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_conn_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_send_queue</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">RDS_MSG_ON_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_flags</span><span class="p">);</span>
	<span class="n">rds_message_addref</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>

	<span class="n">rds_message_populate_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">m_inc</span><span class="p">.</span><span class="n">i_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span>
				    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_next_tx_seq</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_next_tx_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_queued</span><span class="p">);</span>
	<span class="n">rds_stats_inc</span><span class="p">(</span><span class="n">s_send_pong</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RDS_LL_SEND_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="p">))</span>
		<span class="n">rds_send_xmit</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rm</span><span class="p">)</span>
		<span class="n">rds_message_put</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
