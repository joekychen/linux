<!DOCTYPE html>
<html><head><title>joekychen/linux » net › l2tp › l2tp_ppp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>l2tp_ppp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm"> * Linux PPP over L2TP (PPPoX/PPPoL2TP) Sockets</span>
<span class="cm"> *</span>
<span class="cm"> * PPPoX    --- Generic PPP encapsulation socket family</span>
<span class="cm"> * PPPoL2TP --- PPP over L2TP (RFC 2661)</span>
<span class="cm"> *</span>
<span class="cm"> * Version:	2.0.0</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	James Chapman (jchapman@katalix.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Based on original work by Martijn van Oosterhout &lt;kleptog@svana.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * License:</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* This driver handles only L2TP data frames; control frames are handled by a</span>
<span class="cm"> * userspace application.</span>
<span class="cm"> *</span>
<span class="cm"> * To send data in an L2TP session, userspace opens a PPPoL2TP socket and</span>
<span class="cm"> * attaches it to a bound UDP socket with local tunnel_id / session_id and</span>
<span class="cm"> * peer tunnel_id / session_id set. Data can then be sent or received using</span>
<span class="cm"> * regular socket sendmsg() / recvmsg() calls. Kernel parameters of the socket</span>
<span class="cm"> * can be read or modified using ioctl() or [gs]etsockopt() calls.</span>
<span class="cm"> *</span>
<span class="cm"> * When a PPPoL2TP socket is connected with local and peer session_id values</span>
<span class="cm"> * zero, the socket is treated as a special tunnel management socket.</span>
<span class="cm"> *</span>
<span class="cm"> * Here&#39;s example userspace code to create a socket for sending/receiving data</span>
<span class="cm"> * over an L2TP session:-</span>
<span class="cm"> *</span>
<span class="cm"> *	struct sockaddr_pppol2tp sax;</span>
<span class="cm"> *	int fd;</span>
<span class="cm"> *	int session_fd;</span>
<span class="cm"> *</span>
<span class="cm"> *	fd = socket(AF_PPPOX, SOCK_DGRAM, PX_PROTO_OL2TP);</span>
<span class="cm"> *</span>
<span class="cm"> *	sax.sa_family = AF_PPPOX;</span>
<span class="cm"> *	sax.sa_protocol = PX_PROTO_OL2TP;</span>
<span class="cm"> *	sax.pppol2tp.fd = tunnel_fd;	// bound UDP socket</span>
<span class="cm"> *	sax.pppol2tp.addr.sin_addr.s_addr = addr-&gt;sin_addr.s_addr;</span>
<span class="cm"> *	sax.pppol2tp.addr.sin_port = addr-&gt;sin_port;</span>
<span class="cm"> *	sax.pppol2tp.addr.sin_family = AF_INET;</span>
<span class="cm"> *	sax.pppol2tp.s_tunnel  = tunnel_id;</span>
<span class="cm"> *	sax.pppol2tp.s_session = session_id;</span>
<span class="cm"> *	sax.pppol2tp.d_tunnel  = peer_tunnel_id;</span>
<span class="cm"> *	sax.pppol2tp.d_session = peer_session_id;</span>
<span class="cm"> *</span>
<span class="cm"> *	session_fd = connect(fd, (struct sockaddr *)&amp;sax, sizeof(sax));</span>
<span class="cm"> *</span>
<span class="cm"> * A pppd plugin that allows PPP traffic to be carried over L2TP using</span>
<span class="cm"> * this driver is available from the OpenL2TP project at</span>
<span class="cm"> * http://openl2tp.sourceforge.net.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/if_pppox.h&gt;</span>
<span class="cp">#include &lt;linux/if_pppol2tp.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;linux/ppp_channel.h&gt;</span>
<span class="cp">#include &lt;linux/ppp_defs.h&gt;</span>
<span class="cp">#include &lt;linux/ppp-ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/hash.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/l2tp.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/netns/generic.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/udp.h&gt;</span>
<span class="cp">#include &lt;net/xfrm.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &quot;l2tp_core.h&quot;</span>

<span class="cp">#define PPPOL2TP_DRV_VERSION	&quot;V2.0&quot;</span>

<span class="cm">/* Space for UDP, L2TP and PPP headers */</span>
<span class="cp">#define PPPOL2TP_HEADER_OVERHEAD	40</span>

<span class="cm">/* Number of bytes to build transmit L2TP headers.</span>
<span class="cm"> * Unfortunately the size is different depending on whether sequence numbers</span>
<span class="cm"> * are enabled.</span>
<span class="cm"> */</span>
<span class="cp">#define PPPOL2TP_L2TP_HDR_SIZE_SEQ		10</span>
<span class="cp">#define PPPOL2TP_L2TP_HDR_SIZE_NOSEQ		6</span>

<span class="cm">/* Private data of each session. This data lives at the end of struct</span>
<span class="cm"> * l2tp_session, referenced via session-&gt;priv[].</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">owner</span><span class="p">;</span>		<span class="cm">/* pid that opened the socket */</span>

	<span class="k">struct</span> <span class="n">sock</span>		<span class="o">*</span><span class="n">sock</span><span class="p">;</span>		<span class="cm">/* Pointer to the session</span>
<span class="cm">						 * PPPoX socket */</span>
	<span class="k">struct</span> <span class="n">sock</span>		<span class="o">*</span><span class="n">tunnel_sock</span><span class="p">;</span>	<span class="cm">/* Pointer to the tunnel UDP</span>
<span class="cm">						 * socket */</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* accessed by PPPIOCGFLAGS.</span>
<span class="cm">						 * Unused. */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pppol2tp_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ppp_channel_ops</span> <span class="n">pppol2tp_chan_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start_xmit</span> <span class="o">=</span>  <span class="n">pppol2tp_xmit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">pppol2tp_ops</span><span class="p">;</span>

<span class="cm">/* Helpers to obtain tunnel/session contexts from sockets.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="nf">pppol2tp_sock_to_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">session</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="p">)(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">L2TP_SESSION_MAGIC</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">session</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Receive data handling</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_recv_payload_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Skip PPP header, if present.	 In testing, Microsoft L2TP clients</span>
<span class="cm">	 * don&#39;t send the PPP header (PPP header compression enabled), but</span>
<span class="cm">	 * other clients can include the header. So we cope with both cases</span>
<span class="cm">	 * here. The PPP header is always FF03 when using L2TP.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that skb-&gt;data[] isn&#39;t dereferenced from a u16 ptr here since</span>
<span class="cm">	 * the field may be unaligned.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Receive message. This is the recvmsg for the PPPoL2TP socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_BOUND</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSG_DONTWAIT</span><span class="p">,</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If the socket is bound, send it in to PPP&#39;s input queue. Otherwise</span>
<span class="cm">	 * queue it on the session socket.</span>
<span class="cm">	 */</span>
	<span class="n">sk</span> <span class="o">=</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_sock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_BOUND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pppox_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">;</span>
		<span class="n">l2tp_dbg</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_DATA</span><span class="p">,</span>
			 <span class="s">&quot;%s: recv %d byte data frame, passing to ppp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>

		<span class="cm">/* We need to forget all info related to the L2TP packet</span>
<span class="cm">		 * gathered in the skb as we are going to reuse the same</span>
<span class="cm">		 * skb for the inner packet.</span>
<span class="cm">		 * Namely we need to:</span>
<span class="cm">		 * - reset xfrm (IPSec) information as it applies to</span>
<span class="cm">		 *   the outer L2TP packet and not to the inner one</span>
<span class="cm">		 * - release the dst to force a route lookup on the inner</span>
<span class="cm">		 *   IP packet since skb-&gt;dst currently points to the dst</span>
<span class="cm">		 *   of the UDP tunnel</span>
<span class="cm">		 * - reset netfilter information as it doesn&#39;t apply</span>
<span class="cm">		 *   to the inner packet either</span>
<span class="cm">		 */</span>
		<span class="n">secpath_reset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_dst_drop</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">nf_reset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">po</span> <span class="o">=</span> <span class="n">pppox_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">ppp_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_DATA</span><span class="p">,</span> <span class="s">&quot;%s: socket not bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/* Not bound. Nothing we can do, so discard. */</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">no_sock:</span>
	<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_DATA</span><span class="p">,</span> <span class="s">&quot;%s: no socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_session_sock_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">)</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_session_sock_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>
<span class="cm"> * Transmit handling</span>
<span class="cm"> ***********************************************************************/</span>

<span class="cm">/* This is the sendmsg for the PPPoL2TP pppol2tp_session socket.  We come here</span>
<span class="cm"> * when a user application does a sendmsg() on the session socket. L2TP and</span>
<span class="cm"> * PPP headers must be inserted into the user&#39;s data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">total_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ppph</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uhlen</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Get session and tunnel contexts */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">pppol2tp_sock_to_session</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_sock_to_tunnel</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_put_sess</span><span class="p">;</span>

	<span class="n">uhlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">encap</span> <span class="o">==</span> <span class="n">L2TP_ENCAPTYPE_UDP</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate a socket buffer */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_wmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NET_SKB_PAD</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span>
			   <span class="n">uhlen</span> <span class="o">+</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">+</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">ppph</span><span class="p">)</span> <span class="o">+</span> <span class="n">total_len</span><span class="p">,</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_put_sess_tun</span><span class="p">;</span>

	<span class="cm">/* Reserve space for headers. */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_SKB_PAD</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">));</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">uhlen</span><span class="p">);</span>

	<span class="cm">/* Add PPP header */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppph</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppph</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Copy user data into skb */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">total_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_put_sess_tun</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">total_len</span><span class="p">);</span>

	<span class="n">l2tp_xmit_skb</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">);</span>

	<span class="n">sock_put</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">error_put_sess_tun:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
<span class="nl">error_put_sess:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Transmit function called by generic PPP driver.  Sends PPP frame</span>
<span class="cm"> * over PPPoL2TP socket.</span>
<span class="cm"> *</span>
<span class="cm"> * This is almost the same as pppol2tp_sendmsg(), but rather than</span>
<span class="cm"> * being called with a msghdr from userspace, it is called with a skb</span>
<span class="cm"> * from the kernel.</span>
<span class="cm"> *</span>
<span class="cm"> * The supplied skb from ppp doesn&#39;t have enough headroom for the</span>
<span class="cm"> * insertion of L2TP, UDP and IP headers so we need to allocate more</span>
<span class="cm"> * headroom in the skb. This will create a cloned skb. But we must be</span>
<span class="cm"> * careful in the error case because the caller will expect to free</span>
<span class="cm"> * the skb it supplied, not our cloned skb. So we take care to always</span>
<span class="cm"> * leave the original skb unfreed if we return an error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ppph</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk_tun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_headroom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_headroom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uhlen</span><span class="p">,</span> <span class="n">headroom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="cm">/* Get session and tunnel contexts from the socket */</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">pppol2tp_sock_to_session</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="n">sk_tun</span> <span class="o">=</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk_tun</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort_put_sess</span><span class="p">;</span>
	<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_sock_to_tunnel</span><span class="p">(</span><span class="n">sk_tun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort_put_sess</span><span class="p">;</span>

	<span class="n">old_headroom</span> <span class="o">=</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">uhlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">encap</span> <span class="o">==</span> <span class="n">L2TP_ENCAPTYPE_UDP</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">headroom</span> <span class="o">=</span> <span class="n">NET_SKB_PAD</span> <span class="o">+</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="cm">/* IP header */</span>
		   <span class="n">uhlen</span> <span class="o">+</span>		<span class="cm">/* UDP header (if L2TP_ENCAPTYPE_UDP) */</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">+</span>	<span class="cm">/* L2TP header */</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">ppph</span><span class="p">);</span>	<span class="cm">/* PPP header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_cow_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">headroom</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">abort_put_sess_tun</span><span class="p">;</span>

	<span class="n">new_headroom</span> <span class="o">=</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">new_headroom</span> <span class="o">-</span> <span class="n">old_headroom</span><span class="p">;</span>

	<span class="cm">/* Setup PPP header */</span>
	<span class="n">__skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ppph</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppph</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppph</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">l2tp_xmit_skb</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">);</span>

	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk_tun</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">abort_put_sess_tun:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk_tun</span><span class="p">);</span>
<span class="nl">abort_put_sess:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">abort:</span>
	<span class="cm">/* Free the original skb */</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Session (and tunnel control) socket create/destroy.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/* Called by l2tp_core when a session socket is being closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_session_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">L2TP_SESSION_MAGIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PPPOX_CONNECTED</span> <span class="o">|</span> <span class="n">PPPOX_BOUND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pppox_unbind_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">PPPOX_DEAD</span><span class="p">;</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Purge any queued data */</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">reorder_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Really kill the session socket. (Called from sock_put() if</span>
<span class="cm"> * refcnt == 0.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_session_destruct</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">L2TP_SESSION_MAGIC</span><span class="p">);</span>
		<span class="n">l2tp_session_dec_refcount</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when the PPPoX socket (session) is closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">pppox_unbind_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Signal the death of the socket. */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">PPPOX_DEAD</span><span class="p">;</span>
	<span class="n">sock_orphan</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">pppol2tp_sock_to_session</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Purge any queued data */</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">reorder_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* This will delete the session context via</span>
<span class="cm">	 * pppol2tp_session_destruct() if the socket&#39;s refcnt drops to</span>
<span class="cm">	 * zero.</span>
<span class="cm">	 */</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">pppol2tp_sk_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="s">&quot;PPPOL2TP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pppox_sock</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_backlog_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">l2tp_udp_encap_recv</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NET_RX_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* socket() handler. Initialize a new struct sock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_PPPOX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pppol2tp_sk_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span>  <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">pppol2tp_ops</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_backlog_rcv</span> <span class="o">=</span> <span class="n">pppol2tp_backlog_recv</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span>	   <span class="o">=</span> <span class="n">PX_PROTO_OL2TP</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span>	   <span class="o">=</span> <span class="n">PF_PPPOX</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>	   <span class="o">=</span> <span class="n">PPPOX_NONE</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span>	   <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_destruct</span>	   <span class="o">=</span> <span class="n">pppol2tp_session_destruct</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_L2TP_DEBUGFS) || defined(CONFIG_L2TP_DEBUGFS_MODULE)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pppox_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pppox_sk</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   interface %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppp_dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* connect() handler. Attach a PPPoX socket to a tunnel UDP socket</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uservaddr</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">sockaddr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_pppol2tp</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tp</span> <span class="o">*</span><span class="p">)</span> <span class="n">uservaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppox_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pppox_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session_cfg</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tunnel_id</span><span class="p">,</span> <span class="n">peer_tunnel_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">peer_session_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ver</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">sa_protocol</span> <span class="o">!=</span> <span class="n">PX_PROTO_OL2TP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Check for already bound sockets */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t supporting rebinding anyway */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span> <span class="cm">/* socket is already attached */</span>

	<span class="cm">/* Get params from socket address. Handle L2TPv2 and L2TPv3.</span>
<span class="cm">	 * This is nasty because there are different sockaddr_pppol2tp</span>
<span class="cm">	 * structs for L2TPv2, L2TPv3, over IPv4 and IPv6. We use</span>
<span class="cm">	 * the sockaddr size to determine which structure the caller</span>
<span class="cm">	 * is using.</span>
<span class="cm">	 */</span>
	<span class="n">peer_tunnel_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sockaddr_len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">tunnel_id</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span><span class="p">;</span>
		<span class="n">peer_tunnel_id</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span><span class="p">;</span>
		<span class="n">session_id</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span><span class="p">;</span>
		<span class="n">peer_session_id</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sockaddr_len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3</span> <span class="o">*</span><span class="n">sp3</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">ver</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">fd</span> <span class="o">=</span> <span class="n">sp3</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">tunnel_id</span> <span class="o">=</span> <span class="n">sp3</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span><span class="p">;</span>
		<span class="n">peer_tunnel_id</span> <span class="o">=</span> <span class="n">sp3</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span><span class="p">;</span>
		<span class="n">session_id</span> <span class="o">=</span> <span class="n">sp3</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span><span class="p">;</span>
		<span class="n">peer_session_id</span> <span class="o">=</span> <span class="n">sp3</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sockaddr_len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tpin6</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_pppol2tpin6</span> <span class="o">*</span><span class="n">sp6</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tpin6</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">fd</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">tunnel_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span><span class="p">;</span>
		<span class="n">peer_tunnel_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span><span class="p">;</span>
		<span class="n">session_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span><span class="p">;</span>
		<span class="n">peer_session_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sockaddr_len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3in6</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3in6</span> <span class="o">*</span><span class="n">sp6</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">ver</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">fd</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">tunnel_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span><span class="p">;</span>
		<span class="n">peer_tunnel_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span><span class="p">;</span>
		<span class="n">session_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span><span class="p">;</span>
		<span class="n">peer_session_id</span> <span class="o">=</span> <span class="n">sp6</span><span class="o">-&gt;</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span> <span class="cm">/* bad socket address */</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t bind if tunnel_id is 0 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_tunnel_find</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">tunnel_id</span><span class="p">);</span>

	<span class="cm">/* Special case: create tunnel context if session_id and</span>
<span class="cm">	 * peer_session_id is 0. Otherwise look up tunnel using supplied</span>
<span class="cm">	 * tunnel id.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">peer_session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">l2tp_tunnel_cfg</span> <span class="n">tcfg</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">encap</span> <span class="o">=</span> <span class="n">L2TP_ENCAPTYPE_UDP</span><span class="p">,</span>
				<span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">};</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">l2tp_tunnel_create</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">tunnel_id</span><span class="p">,</span> <span class="n">peer_tunnel_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tunnel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Error if we can&#39;t find the tunnel */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

		<span class="cm">/* Error if socket is not prepped */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">recv_payload_hook</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">recv_payload_hook</span> <span class="o">=</span> <span class="n">pppol2tp_recv_payload_hook</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">peer_tunnel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">peer_tunnel_id</span> <span class="o">=</span> <span class="n">peer_tunnel_id</span><span class="p">;</span>

	<span class="cm">/* Create session if it doesn&#39;t already exist. We handle the</span>
<span class="cm">	 * case where a session was previously created by the netlink</span>
<span class="cm">	 * interface by checking that the session doesn&#39;t already have</span>
<span class="cm">	 * a socket and its tunnel socket are what we expect. If any</span>
<span class="cm">	 * of those checks fail, return EEXIST to the caller.</span>
<span class="cm">	 */</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">l2tp_session_find</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">tunnel</span><span class="p">,</span> <span class="n">session_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Default MTU must allow space for UDP/L2TP/PPP</span>
<span class="cm">		 * headers.</span>
<span class="cm">		 */</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">mru</span> <span class="o">=</span> <span class="mi">1500</span> <span class="o">-</span> <span class="n">PPPOL2TP_HEADER_OVERHEAD</span><span class="p">;</span>

		<span class="cm">/* Allocate and initialize a new session context. */</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">l2tp_session_create</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pppol2tp_session</span><span class="p">),</span>
					      <span class="n">tunnel</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span>
					      <span class="n">peer_session_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

		<span class="cm">/* consistency checks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span> <span class="o">!=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Associate session with its PPPoL2TP socket */</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="n">ps</span><span class="o">-&gt;</span><span class="n">owner</span>	     <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span>	     <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
	<span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>

	<span class="n">session</span><span class="o">-&gt;</span><span class="n">recv_skb</span>	<span class="o">=</span> <span class="n">pppol2tp_recv</span><span class="p">;</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">session_close</span>	<span class="o">=</span> <span class="n">pppol2tp_session_close</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_L2TP_DEBUGFS) || defined(CONFIG_L2TP_DEBUGFS_MODULE)</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">show</span>		<span class="o">=</span> <span class="n">pppol2tp_show</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* We need to know each time a skb is dropped from the reorder</span>
<span class="cm">	 * queue.</span>
<span class="cm">	 */</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">ref</span> <span class="o">=</span> <span class="n">pppol2tp_session_sock_hold</span><span class="p">;</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">deref</span> <span class="o">=</span> <span class="n">pppol2tp_session_sock_put</span><span class="p">;</span>

	<span class="cm">/* If PMTU discovery was enabled, use the MTU that was discovered */</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">sk_dst_get</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pmtu</span> <span class="o">=</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">__sk_dst_get</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmtu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">session</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">=</span> <span class="n">pmtu</span> <span class="o">-</span>
				<span class="n">PPPOL2TP_HEADER_OVERHEAD</span><span class="p">;</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Special case: if source &amp; dest session_id == 0x0000, this</span>
<span class="cm">	 * socket is being created to manage the tunnel. Just set up</span>
<span class="cm">	 * the internal context for use by ioctl() and sockopt()</span>
<span class="cm">	 * handlers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_no_ppp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The only header we need to worry about is the L2TP</span>
<span class="cm">	 * header. This size is different depending on whether</span>
<span class="cm">	 * sequence numbers are enabled for the data channel.</span>
<span class="cm">	 */</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">hdrlen</span> <span class="o">=</span> <span class="n">PPPOL2TP_L2TP_HDR_SIZE_NOSEQ</span><span class="p">;</span>

	<span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">ops</span>	 <span class="o">=</span> <span class="o">&amp;</span><span class="n">pppol2tp_chan_ops</span><span class="p">;</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">mtu</span>	 <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ppp_register_net_channel</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

<span class="nl">out_no_ppp:</span>
	<span class="cm">/* This is how we get the session context from the socket. */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">PPPOX_CONNECTED</span><span class="p">;</span>
	<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_L2TP_V3</span>

<span class="cm">/* Called when creating sessions via the netlink interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_session_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tunnel_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">peer_session_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2tp_session_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>

	<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_tunnel_find</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">tunnel_id</span><span class="p">);</span>

	<span class="cm">/* Error if we can&#39;t find the tunnel */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Error if tunnel socket is not prepped */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Check that this session doesn&#39;t already exist */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">l2tp_session_find</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">tunnel</span><span class="p">,</span> <span class="n">session_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Default MTU values. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">1500</span> <span class="o">-</span> <span class="n">PPPOL2TP_HEADER_OVERHEAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="cm">/* Allocate and initialize a new session context. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">l2tp_session_create</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pppol2tp_session</span><span class="p">),</span>
				      <span class="n">tunnel</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span>
				      <span class="n">peer_session_id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>

	<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when deleting sessions via the netlink interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_session_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">l2tp_session_dec_refcount</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_L2TP_V3 */</span><span class="cp"></span>

<span class="cm">/* getname() support.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_getname</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="o">*</span><span class="n">usockaddr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">pls</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">PPPOX_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">pppol2tp_sock_to_session</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">pls</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_sock_to_tunnel</span><span class="p">(</span><span class="n">pls</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end_put_sess</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_pppol2tp</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_family</span>	<span class="o">=</span> <span class="n">AF_PPPOX</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_protocol</span>	<span class="o">=</span> <span class="n">PX_PROTO_OL2TP</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span>  <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pls</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">peer_tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sockaddr_pppol2tpin6</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_family</span>	<span class="o">=</span> <span class="n">AF_PPPOX</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_protocol</span>	<span class="o">=</span> <span class="n">PX_PROTO_OL2TP</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span>  <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pls</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">peer_tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3in6</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_family</span>	<span class="o">=</span> <span class="n">AF_PPPOX</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_protocol</span>	<span class="o">=</span> <span class="n">PX_PROTO_OL2TP</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span>  <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pls</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">peer_tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_pppol2tpv3</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_family</span>	<span class="o">=</span> <span class="n">AF_PPPOX</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">sa_protocol</span>	<span class="o">=</span> <span class="n">PX_PROTO_OL2TP</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">fd</span>  <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pls</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">peer_tunnel_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">s_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">d_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">.</span><span class="n">pppol2tp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">usockaddr_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">sock_put</span><span class="p">(</span><span class="n">pls</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
<span class="nl">end_put_sess:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * ioctl() handlers.</span>
<span class="cm"> *</span>
<span class="cm"> * The PPPoX socket is created for L2TP sessions: tunnels have their own UDP</span>
<span class="cm"> * sockets. However, in order to control kernel tunnel features, we allow</span>
<span class="cm"> * userspace to create a special &quot;tunnel&quot; PPPoX socket which is used for</span>
<span class="cm"> * control only.  Tunnel PPPoX sockets have session_id == 0 and simply allow</span>
<span class="cm"> * the user application to issue L2TP setsockopt(), getsockopt() and ioctl()</span>
<span class="cm"> * calls.</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_copy_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">pppol2tp_ioc_stats</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">l2tp_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">rx_seq_discards</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_seq_discards</span><span class="p">;</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">rx_oos_packets</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_oos_packets</span><span class="p">;</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Session ioctl helper.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_session_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_ioc_stats</span> <span class="n">stats</span><span class="p">;</span>

	<span class="n">l2tp_dbg</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
		 <span class="s">&quot;%s: pppol2tp_session_ioctl(cmd=%#x, arg=%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>
	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGIFMTU</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ifr</span><span class="p">.</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: get mtu=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFMTU</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">session</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_mtu</span><span class="p">;</span>

		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: set mtu=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPIOCGMRU</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">mru</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: get mru=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mru</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPIOCSMRU</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">session</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: set mru=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mru</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPIOCGFLAGS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: get flags=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPIOCSFLAGS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ps</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: set flags=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPIOCGL2TPSTATS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">));</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">tunnel_id</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">tunnel_id</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span><span class="p">;</span>
		<span class="n">pppol2tp_copy_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: get L2TP stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tunnel ioctl helper.</span>
<span class="cm"> *</span>
<span class="cm"> * Note the special handling for PPPIOCGL2TPSTATS below. If the ioctl data</span>
<span class="cm"> * specifies a session_id, the session ioctl handler is called. This allows an</span>
<span class="cm"> * application to retrieve session stats via a tunnel socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_tunnel_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_ioc_stats</span> <span class="n">stats</span><span class="p">;</span>

	<span class="n">l2tp_dbg</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
		 <span class="s">&quot;%s: pppol2tp_tunnel_ioctl(cmd=%#x, arg=%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>
	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPPIOCGL2TPSTATS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="n">PPPOX_CONNECTED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">session_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* resend to session ioctl handler */</span>
			<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span>
				<span class="n">l2tp_session_find</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">tunnel</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">session_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pppol2tp_session_ioctl</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">using_ipsec</span> <span class="o">=</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_policy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_policy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">pppol2tp_copy_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: get L2TP stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Main ioctl() handler.</span>
<span class="cm"> * Dispatch to tunnel or session helpers depending on the socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PPPOX_CONNECTED</span> <span class="o">|</span> <span class="n">PPPOX_BOUND</span><span class="p">))))</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Get session context from the socket */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">pppol2tp_sock_to_session</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Special case: if session&#39;s session_id is zero, treat ioctl as a</span>
<span class="cm">	 * tunnel ioctl</span>
<span class="cm">	 */</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_sock_to_tunnel</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end_put_sess</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pppol2tp_tunnel_ioctl</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end_put_sess</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pppol2tp_session_ioctl</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

<span class="nl">end_put_sess:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * setsockopt() / getsockopt() support.</span>
<span class="cm"> *</span>
<span class="cm"> * The PPPoX socket is created for L2TP sessions: tunnels have their own UDP</span>
<span class="cm"> * sockets. In order to control kernel tunnel features, we allow userspace to</span>
<span class="cm"> * create a special &quot;tunnel&quot; PPPoX socket which is used for control only.</span>
<span class="cm"> * Tunnel PPPoX sockets have session_id == 0 and simply allow the user</span>
<span class="cm"> * application to issue L2TP setsockopt(), getsockopt() and ioctl() calls.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/* Tunnel setsockopt() helper.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_tunnel_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPPOL2TP_SO_DEBUG</span>:
		<span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: set debug=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Session setsockopt helper.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_session_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPPOL2TP_SO_RECVSEQ</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">recv_seq</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: set recv_seq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">recv_seq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_SENDSEQ</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">send_seq</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">ssk</span>      <span class="o">=</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">pppox_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pppox_sk</span><span class="p">(</span><span class="n">ssk</span><span class="p">);</span>
			<span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">hdrlen</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">PPPOL2TP_L2TP_HDR_SIZE_SEQ</span> <span class="o">:</span>
				<span class="n">PPPOL2TP_L2TP_HDR_SIZE_NOSEQ</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: set send_seq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">send_seq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_LNSMODE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">lns_mode</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: set lns_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">lns_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_DEBUG</span>:
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: set debug=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_REORDERTO</span>:
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">reorder_timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: set reorder_timeout=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">reorder_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Main setsockopt() entry point.</span>
<span class="cm"> * Does API checks, then calls either the tunnel or session setsockopt</span>
<span class="cm"> * handler, according to whether the PPPoL2TP socket is a for a regular</span>
<span class="cm"> * session or the special tunnel type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_PPPOL2TP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">udp_prot</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Get session context from the socket */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">pppol2tp_sock_to_session</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Special case: if session_id == 0x0000, treat as operation on tunnel</span>
<span class="cm">	 */</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_sock_to_tunnel</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end_put_sess</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pppol2tp_tunnel_setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">tunnel</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pppol2tp_session_setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">end_put_sess:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tunnel getsockopt helper. Called with sock locked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_tunnel_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPPOL2TP_SO_DEBUG</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: get debug=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Session getsockopt helper. Called with sock locked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_session_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPPOL2TP_SO_RECVSEQ</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">recv_seq</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: get recv_seq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_SENDSEQ</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">send_seq</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: get send_seq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_LNSMODE</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">lns_mode</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: get lns_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_DEBUG</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">;</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span> <span class="s">&quot;%s: get debug=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPPOL2TP_SO_REORDERTO</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">reorder_timeout</span><span class="p">);</span>
		<span class="n">l2tp_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">PPPOL2TP_MSG_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;%s: get reorder_timeout=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Main getsockopt() entry point.</span>
<span class="cm"> * Does API checks, then calls either the tunnel or session getsockopt</span>
<span class="cm"> * handler, according to whether the PPPoX socket is a for a regular session</span>
<span class="cm"> * or the special tunnel type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_PPPOL2TP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">udp_prot</span><span class="p">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Get the session context */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">pppol2tp_sock_to_session</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Special case: if session_id == 0x0000, treat as operation on tunnel */</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_sock_to_tunnel</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end_put_sess</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pppol2tp_tunnel_getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">tunnel</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">tunnel_sock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pppol2tp_session_getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">end_put_sess</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">optval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">end_put_sess</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">end_put_sess:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * /proc filesystem for debug</span>
<span class="cm"> * Since the original pppol2tp driver provided /proc/net/pppol2tp for</span>
<span class="cm"> * L2TPv2, we dump only L2TPv2 tunnels and sessions here.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pppol2tp_net_id</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">struct</span> <span class="n">pppol2tp_seq_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_net_private</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tunnel_idx</span><span class="p">;</span>			<span class="cm">/* current tunnel */</span>
	<span class="kt">int</span> <span class="n">session_idx</span><span class="p">;</span>		<span class="cm">/* index of session within current tunnel */</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>	<span class="cm">/* NULL means get next tunnel */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_next_tunnel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pppol2tp_seq_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">l2tp_tunnel_find_nth</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel_idx</span><span class="p">);</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel_idx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Ignore L2TPv3 tunnels */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_next_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pppol2tp_seq_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="n">l2tp_session_find_nth</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">session_idx</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">session_idx</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">session_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pppol2tp_next_tunnel</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">pppol2tp_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pppol2tp_seq_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">offs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pppol2tp_next_tunnel</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pppol2tp_next_session</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>

	<span class="cm">/* NULL tunnel and session indicates end of list */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">pd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">pd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">pppol2tp_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_seq_tunnel_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">TUNNEL &#39;%s&#39;, %c %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">tunnel</span> <span class="o">==</span> <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %08x %llu/%llu/%llu %llu/%llu/%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pppol2tp_seq_session_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2tp_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2tp_tunnel</span> <span class="o">*</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pppol2tp_session</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">l2tp_session_priv</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pppox_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pppox_sk</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">);</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  SESSION &#39;%s&#39; %08X/%d %04X/%04X -&gt; &quot;</span>
		   <span class="s">&quot;%04X/%04X %d %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
		   <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">tunnel_id</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">session_id</span><span class="p">,</span>
		   <span class="n">tunnel</span><span class="o">-&gt;</span><span class="n">peer_tunnel_id</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">peer_session_id</span><span class="p">,</span>
		   <span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">)</span> <span class="o">?</span>
		   <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   %d/%d/%c/%c/%s %08x %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mru</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">recv_seq</span> <span class="o">?</span> <span class="sc">&#39;R&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">send_seq</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">lns_mode</span> <span class="o">?</span> <span class="s">&quot;LNS&quot;</span> <span class="o">:</span> <span class="s">&quot;LAC&quot;</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">,</span>
		   <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">reorder_timeout</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   %hu/%hu %llu/%llu/%llu %llu/%llu/%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">session</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   interface %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppp_dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pppol2tp_seq_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="cm">/* display header on line 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PPPoL2TP driver info, &quot;</span> <span class="n">PPPOL2TP_DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;TUNNEL name, user-data-ok session-count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; debug tx-pkts/bytes/errs rx-pkts/bytes/errs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  SESSION name, addr/port src-tid/sid &quot;</span>
			 <span class="s">&quot;dest-tid/sid state user-data-ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   mtu/mru/rcvseq/sendseq/lns debug reorderto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   nr/ns tx-pkts/bytes/errs rx-pkts/bytes/errs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Show the tunnel or session context.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pppol2tp_seq_tunnel_show</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tunnel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pppol2tp_seq_session_show</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">pppol2tp_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">pppol2tp_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>		<span class="o">=</span> <span class="n">pppol2tp_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">pppol2tp_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>		<span class="o">=</span> <span class="n">pppol2tp_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Called when our /proc file is opened. We allocate data for use when</span>
<span class="cm"> * iterating our tunnel / session contexts and store it in the private</span>
<span class="cm"> * data of the seq_file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pppol2tp_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pppol2tp_seq_ops</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pppol2tp_seq_data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pppol2tp_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pppol2tp_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Network namespace</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="n">__net_init</span> <span class="kt">int</span> <span class="nf">pppol2tp_init_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pde</span> <span class="o">=</span> <span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;pppol2tp&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pppol2tp_proc_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_exit</span> <span class="kt">void</span> <span class="nf">pppol2tp_exit_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;pppol2tp&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">pppol2tp_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pppol2tp_init_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">pppol2tp_exit_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">pppol2tp_net_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Init and cleanup</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">pppol2tp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span> <span class="n">AF_PPPOX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">pppol2tp_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span>		<span class="o">=</span> <span class="n">sock_no_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">pppol2tp_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span>	<span class="o">=</span> <span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span>		<span class="o">=</span> <span class="n">sock_no_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span>	<span class="o">=</span> <span class="n">pppol2tp_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">datagram_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listen</span>		<span class="o">=</span> <span class="n">sock_no_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">sock_no_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>	<span class="o">=</span> <span class="n">pppol2tp_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	<span class="o">=</span> <span class="n">pppol2tp_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span>	<span class="o">=</span> <span class="n">pppol2tp_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span>	<span class="o">=</span> <span class="n">pppol2tp_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">pppox_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pppox_proto</span> <span class="n">pppol2tp_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span>		<span class="o">=</span> <span class="n">pppol2tp_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">pppol2tp_ioctl</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_L2TP_V3</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">l2tp_nl_cmd_ops</span> <span class="n">pppol2tp_nl_cmd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">session_create</span>	<span class="o">=</span> <span class="n">pppol2tp_session_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">session_delete</span>	<span class="o">=</span> <span class="n">pppol2tp_session_delete</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_L2TP_V3 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pppol2tp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pernet_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pppol2tp_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pppol2tp_sk_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_pppol2tp_pernet</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pppox_proto</span><span class="p">(</span><span class="n">PX_PROTO_OL2TP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pppol2tp_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_pppol2tp_proto</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_L2TP_V3</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">l2tp_nl_register_ops</span><span class="p">(</span><span class="n">L2TP_PWTYPE_PPP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pppol2tp_nl_cmd_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_pppox</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PPPoL2TP kernel driver, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PPPOL2TP_DRV_VERSION</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_L2TP_V3</span>
<span class="nl">out_unregister_pppox:</span>
	<span class="n">unregister_pppox_proto</span><span class="p">(</span><span class="n">PX_PROTO_OL2TP</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">out_unregister_pppol2tp_proto:</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pppol2tp_sk_proto</span><span class="p">);</span>
<span class="nl">out_unregister_pppol2tp_pernet:</span>
	<span class="n">unregister_pernet_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pppol2tp_net_ops</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pppol2tp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_L2TP_V3</span>
	<span class="n">l2tp_nl_unregister_ops</span><span class="p">(</span><span class="n">L2TP_PWTYPE_PPP</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">unregister_pppox_proto</span><span class="p">(</span><span class="n">PX_PROTO_OL2TP</span><span class="p">);</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pppol2tp_sk_proto</span><span class="p">);</span>
	<span class="n">unregister_pernet_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pppol2tp_net_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pppol2tp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pppol2tp_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;James Chapman &lt;jchapman@katalix.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PPP over L2TP over UDP&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">PPPOL2TP_DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;pppox-proto-&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">PX_PROTO_OL2TP</span><span class="p">));</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
