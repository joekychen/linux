<!DOCTYPE html>
<html><head><title>joekychen/linux » net › wimax › op-msg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>op-msg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux WiMAX</span>
<span class="cm"> * Generic messaging interface between userspace and driver/device</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2008 Intel Corporation &lt;linux-wimax@intel.com&gt;</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This implements a direct communication channel between user space and</span>
<span class="cm"> * the driver/device, by which free form messages can be sent back and</span>
<span class="cm"> * forth.</span>
<span class="cm"> *</span>
<span class="cm"> * This is intended for device-specific features, vendor quirks, etc.</span>
<span class="cm"> *</span>
<span class="cm"> * See include/net/wimax.h</span>
<span class="cm"> *</span>
<span class="cm"> * GENERIC NETLINK ENCODING AND CAPACITY</span>
<span class="cm"> *</span>
<span class="cm"> * A destination &quot;pipe name&quot; is added to each message; it is up to the</span>
<span class="cm"> * drivers to assign or use those names (if using them at all).</span>
<span class="cm"> *</span>
<span class="cm"> * Messages are encoded as a binary netlink attribute using nla_put()</span>
<span class="cm"> * using type NLA_UNSPEC (as some versions of libnl still in</span>
<span class="cm"> * deployment don&#39;t yet understand NLA_BINARY).</span>
<span class="cm"> *</span>
<span class="cm"> * The maximum capacity of this transport is PAGESIZE per message (so</span>
<span class="cm"> * the actual payload will be bit smaller depending on the</span>
<span class="cm"> * netlink/generic netlink attributes and headers).</span>
<span class="cm"> *</span>
<span class="cm"> * RECEPTION OF MESSAGES</span>
<span class="cm"> *</span>
<span class="cm"> * When a message is received from user space, it is passed verbatim</span>
<span class="cm"> * to the driver calling wimax_dev-&gt;op_msg_from_user(). The return</span>
<span class="cm"> * value from this function is passed back to user space as an ack</span>
<span class="cm"> * over the generic netlink protocol.</span>
<span class="cm"> *</span>
<span class="cm"> * The stack doesn&#39;t do any processing or interpretation of these</span>
<span class="cm"> * messages.</span>
<span class="cm"> *</span>
<span class="cm"> * SENDING MESSAGES</span>
<span class="cm"> *</span>
<span class="cm"> * Messages can be sent with wimax_msg().</span>
<span class="cm"> *</span>
<span class="cm"> * If the message delivery needs to happen on a different context to</span>
<span class="cm"> * that of its creation, wimax_msg_alloc() can be used to get a</span>
<span class="cm"> * pointer to the message that can be delivered later on with</span>
<span class="cm"> * wimax_msg_send().</span>
<span class="cm"> *</span>
<span class="cm"> * ROADMAP</span>
<span class="cm"> *</span>
<span class="cm"> * wimax_gnl_doit_msg_from_user()    Process a message from user space</span>
<span class="cm"> *   wimax_dev_get_by_genl_info()</span>
<span class="cm"> *   wimax_dev-&gt;op_msg_from_user()   Delivery of message to the driver</span>
<span class="cm"> *</span>
<span class="cm"> * wimax_msg()                       Send a message to user space</span>
<span class="cm"> *   wimax_msg_alloc()</span>
<span class="cm"> *   wimax_msg_send()</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/genetlink.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/wimax.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;wimax-internal.h&quot;</span>


<span class="cp">#define D_SUBMODULE op_msg</span>
<span class="cp">#include &quot;debug-levels.h&quot;</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_msg_alloc - Create a new skb for sending a message to userspace</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor</span>
<span class="cm"> * @pipe_name: &quot;named pipe&quot; the message will be sent to</span>
<span class="cm"> * @msg: pointer to the message data to send</span>
<span class="cm"> * @size: size of the message to send (in bytes), including the header.</span>
<span class="cm"> * @gfp_flags: flags for memory allocation.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %0 if ok, negative errno code on error</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates an skb that will contain the message to send to user</span>
<span class="cm"> * space over the messaging pipe and initializes it, copying the</span>
<span class="cm"> * payload.</span>
<span class="cm"> *</span>
<span class="cm"> * Once this call is done, you can deliver it with</span>
<span class="cm"> * wimax_msg_send().</span>
<span class="cm"> *</span>
<span class="cm"> * IMPORTANT:</span>
<span class="cm"> *</span>
<span class="cm"> * Don&#39;t use skb_push()/skb_pull()/skb_reserve() on the skb, as</span>
<span class="cm"> * wimax_msg_send() depends on skb-&gt;data being placed at the</span>
<span class="cm"> * beginning of the user message.</span>
<span class="cm"> *</span>
<span class="cm"> * Unlike other WiMAX stack calls, this call can be used way early,</span>
<span class="cm"> * even before wimax_dev_add() is called, as long as the</span>
<span class="cm"> * wimax_dev-&gt;net_dev pointer is set to point to a proper</span>
<span class="cm"> * net_dev. This is so that drivers can use it early in case they need</span>
<span class="cm"> * to send stuff around or communicate with user space.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">wimax_msg_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pipe_name</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wimax_dev_to_dev</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">msg_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">genl_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">msg_size</span> <span class="o">=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">pipe_name</span> <span class="o">?</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">genlmsg_new</span><span class="p">(</span><span class="n">msg_size</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_new</span><span class="p">;</span>
	<span class="n">genl_msg</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">WIMAX_GNL_OP_MSG_TO_USER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">genl_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory to create generic netlink message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_genlmsg_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">WIMAX_GNL_MSG_IFIDX</span><span class="p">,</span>
			     <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory to add ifindex attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_nla_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">WIMAX_GNL_MSG_PIPE_NAME</span><span class="p">,</span>
					<span class="n">pipe_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory to add pipe_name attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_nla_put</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory to add payload (msg %p size %zu) in &quot;</span>
			<span class="s">&quot;attribute: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_nla_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">genl_msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">error_nla_put:</span>
<span class="nl">error_genlmsg_put:</span>
<span class="nl">error_new:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_msg_alloc</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_msg_data_len - Return a pointer and size of a message&#39;s payload</span>
<span class="cm"> *</span>
<span class="cm"> * @msg: Pointer to a message created with wimax_msg_alloc()</span>
<span class="cm"> * @size: Pointer to where to store the message&#39;s size</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the pointer to the message data.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">wimax_msg_data_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">nlmsg_find_attr</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">genlmsghdr</span><span class="p">),</span>
			      <span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot find attribute WIMAX_GNL_MSG_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_msg_data_len</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_msg_data - Return a pointer to a message&#39;s payload</span>
<span class="cm"> *</span>
<span class="cm"> * @msg: Pointer to a message created with wimax_msg_alloc()</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">wimax_msg_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">nlmsg_find_attr</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">genlmsghdr</span><span class="p">),</span>
			      <span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot find attribute WIMAX_GNL_MSG_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_msg_data</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_msg_len - Return a message&#39;s payload length</span>
<span class="cm"> *</span>
<span class="cm"> * @msg: Pointer to a message created with wimax_msg_alloc()</span>
<span class="cm"> */</span>
<span class="kt">ssize_t</span> <span class="nf">wimax_msg_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">nlmsg_find_attr</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">genlmsghdr</span><span class="p">),</span>
			      <span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot find attribute WIMAX_GNL_MSG_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_msg_len</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_msg_send - Send a pre-allocated message to user space</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * @skb: &amp;struct sk_buff returned by wimax_msg_alloc(). Note the</span>
<span class="cm"> *     ownership of @skb is transferred to this function.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if ok, &lt; 0 errno code on error</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *</span>
<span class="cm"> * Sends a free-form message that was preallocated with</span>
<span class="cm"> * wimax_msg_alloc() and filled up.</span>
<span class="cm"> *</span>
<span class="cm"> * Assumes that once you pass an skb to this function for sending, it</span>
<span class="cm"> * owns it and will release it when done (on success).</span>
<span class="cm"> *</span>
<span class="cm"> * IMPORTANT:</span>
<span class="cm"> *</span>
<span class="cm"> * Don&#39;t use skb_push()/skb_pull()/skb_reserve() on the skb, as</span>
<span class="cm"> * wimax_msg_send() depends on skb-&gt;data being placed at the</span>
<span class="cm"> * beginning of the user message.</span>
<span class="cm"> *</span>
<span class="cm"> * Unlike other WiMAX stack calls, this call can be used way early,</span>
<span class="cm"> * even before wimax_dev_add() is called, as long as the</span>
<span class="cm"> * wimax_dev-&gt;net_dev pointer is set to point to a proper</span>
<span class="cm"> * net_dev. This is so that drivers can use it early in case they need</span>
<span class="cm"> * to send stuff around or communicate with user space.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wimax_msg_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wimax_dev_to_dev</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CTX: wimax msg, %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">d_dump</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">genlmsg_multicast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wimax_gnl_mcg</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CTX: genl multicast done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_msg_send</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_msg - Send a message to user space</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor (properly referenced)</span>
<span class="cm"> * @pipe_name: &quot;named pipe&quot; the message will be sent to</span>
<span class="cm"> * @buf: pointer to the message to send.</span>
<span class="cm"> * @size: size of the buffer pointed to by @buf (in bytes).</span>
<span class="cm"> * @gfp_flags: flags for memory allocation.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %0 if ok, negative errno code on error.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *</span>
<span class="cm"> * Sends a free-form message to user space on the device @wimax_dev.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTES:</span>
<span class="cm"> *</span>
<span class="cm"> * Once the @skb is given to this function, who will own it and will</span>
<span class="cm"> * release it when done (unless it returns error).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wimax_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pipe_name</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">wimax_msg_alloc</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">wimax_msg_send</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_msg</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">wimax_gnl_msg_policy</span><span class="p">[</span><span class="n">WIMAX_GNL_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">WIMAX_GNL_MSG_IFIDX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_UNSPEC</span><span class="p">,</span>	<span class="cm">/* libnl doesn&#39;t grok BINARY yet */</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Relays a message from user space to the driver</span>
<span class="cm"> *</span>
<span class="cm"> * The skb is passed to the driver-specific function with the netlink</span>
<span class="cm"> * and generic netlink headers already stripped.</span>
<span class="cm"> *</span>
<span class="cm"> * This call will block while handling/relaying the message.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">wimax_gnl_doit_msg_from_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pipe_name</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">msg_len</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;(skb %p info %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">WIMAX_GNL_MSG_IFIDX</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;WIMAX_GNL_MSG_FROM_USER: can&#39;t find IFIDX &quot;</span>
		       <span class="s">&quot;attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_no_wimax_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ifindex</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">WIMAX_GNL_MSG_IFIDX</span><span class="p">]);</span>
	<span class="n">wimax_dev</span> <span class="o">=</span> <span class="n">wimax_dev_get_by_genl_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wimax_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_no_wimax_dev</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wimax_dev_to_dev</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>

	<span class="cm">/* Unpack arguments */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WIMAX_GNL_MSG_FROM_USER: can&#39;t find MSG_DATA &quot;</span>
			<span class="s">&quot;attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_no_data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg_buf</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">]);</span>
	<span class="n">msg_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">WIMAX_GNL_MSG_DATA</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">WIMAX_GNL_MSG_PIPE_NAME</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pipe_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">WIMAX_GNL_MSG_PIPE_NAME</span><span class="p">];</span>
		<span class="kt">size_t</span> <span class="n">attr_len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
		<span class="cm">/* libnl-1.1 does not yet support NLA_NUL_STRING */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pipe_name</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">attr_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
		<span class="n">pipe_name</span><span class="p">[</span><span class="n">attr_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wimax_dev_is_ready</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_not_ready</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">op_msg_from_user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_noop</span><span class="p">;</span>

	<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;CRX: nlmsghdr len %u type %u flags 0x%04x seq 0x%x pid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_len</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">,</span>
		 <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">);</span>
	<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CRX: wimax message %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">);</span>
	<span class="n">d_dump</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">msg_buf</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">op_msg_from_user</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">,</span>
					     <span class="n">msg_buf</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="nl">error_noop:</span>
<span class="nl">error_not_ready:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">);</span>
<span class="nl">error_no_data:</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
<span class="nl">error_no_wimax_dev:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;(skb %p info %p) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Generic Netlink glue</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">genl_ops</span> <span class="n">wimax_gnl_msg_from_user</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">WIMAX_GNL_OP_MSG_FROM_USER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">wimax_gnl_msg_policy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">wimax_gnl_doit_msg_from_user</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
