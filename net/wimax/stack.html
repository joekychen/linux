<!DOCTYPE html>
<html><head><title>joekychen/linux » net › wimax › stack.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>stack.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux WiMAX</span>
<span class="cm"> * Initialization, addition and removal of wimax devices</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation &lt;linux-wimax@intel.com&gt;</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This implements:</span>
<span class="cm"> *</span>
<span class="cm"> *   - basic life cycle of &#39;struct wimax_dev&#39; [wimax_dev_*()]; on</span>
<span class="cm"> *     addition/registration initialize all subfields and allocate</span>
<span class="cm"> *     generic netlink resources for user space communication. On</span>
<span class="cm"> *     removal/unregistration, undo all that.</span>
<span class="cm"> *</span>
<span class="cm"> *   - device state machine [wimax_state_change()] and support to send</span>
<span class="cm"> *     reports to user space when the state changes</span>
<span class="cm"> *     [wimax_gnl_re_state_change*()].</span>
<span class="cm"> *</span>
<span class="cm"> * See include/net/wimax.h for rationales and design.</span>
<span class="cm"> *</span>
<span class="cm"> * ROADMAP</span>
<span class="cm"> *</span>
<span class="cm"> * [__]wimax_state_change()     Called by drivers to update device&#39;s state</span>
<span class="cm"> *   wimax_gnl_re_state_change_alloc()</span>
<span class="cm"> *   wimax_gnl_re_state_change_send()</span>
<span class="cm"> *</span>
<span class="cm"> * wimax_dev_init()	        Init a device</span>
<span class="cm"> * wimax_dev_add()              Register</span>
<span class="cm"> *   wimax_rfkill_add()</span>
<span class="cm"> *   wimax_gnl_add()            Register all the generic netlink resources.</span>
<span class="cm"> *   wimax_id_table_add()</span>
<span class="cm"> * wimax_dev_rm()               Unregister</span>
<span class="cm"> *   wimax_id_table_rm()</span>
<span class="cm"> *   wimax_gnl_rm()</span>
<span class="cm"> *   wimax_rfkill_rm()</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;net/genetlink.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/wimax.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;wimax-internal.h&quot;</span>


<span class="cp">#define D_SUBMODULE stack</span>
<span class="cp">#include &quot;debug-levels.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">wimax_debug_params</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">wimax_debug_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wimax_debug_params</span><span class="p">),</span>
		    <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>
		 <span class="s">&quot;String of space-separated NAME:VALUE pairs, where NAMEs &quot;</span>
		 <span class="s">&quot;are the different debug submodules and VALUE are the &quot;</span>
		 <span class="s">&quot;initial debug value to set.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Authoritative source for the RE_STATE_CHANGE attribute policy</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t really use it here, but /me likes to keep the definition</span>
<span class="cm"> * close to where the data is generated.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm">static const struct nla_policy wimax_gnl_re_status_change[WIMAX_GNL_ATTR_MAX + 1] = {</span>
<span class="cm">	[WIMAX_GNL_STCH_STATE_OLD] = { .type = NLA_U8 },</span>
<span class="cm">	[WIMAX_GNL_STCH_STATE_NEW] = { .type = NLA_U8 },</span>
<span class="cm">};</span>
<span class="cm">*/</span>


<span class="cm">/*</span>
<span class="cm"> * Allocate a Report State Change message</span>
<span class="cm"> *</span>
<span class="cm"> * @header: save it, you need it for _send()</span>
<span class="cm"> *</span>
<span class="cm"> * Creates and fills a basic state change message; different code</span>
<span class="cm"> * paths can then add more attributes to the message as needed.</span>
<span class="cm"> *</span>
<span class="cm"> * Use wimax_gnl_re_state_change_send() to send the returned skb.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: skb with the genl message if ok, IS_ERR() ptr on error</span>
<span class="cm"> *     with an errno code.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">wimax_gnl_re_state_change_alloc</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">new_state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">old_state</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wimax_dev_to_dev</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">report_skb</span><span class="p">;</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p new_state %u old_state %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">report_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RE_STCH: can&#39;t create message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_new</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">report_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wimax_gnl_mcg</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">,</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="n">WIMAX_GNL_RE_STATE_CHANGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RE_STCH: can&#39;t put data into message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">report_skb</span><span class="p">,</span> <span class="n">WIMAX_GNL_STCH_STATE_OLD</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RE_STCH: Error adding OLD attr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">report_skb</span><span class="p">,</span> <span class="n">WIMAX_GNL_STCH_STATE_NEW</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RE_STCH: Error adding NEW attr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">report_skb</span><span class="p">,</span> <span class="n">WIMAX_GNL_STCH_IFIDX</span><span class="p">,</span>
			     <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RE_STCH: Error adding IFINDEX attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p new_state %u old_state %u) = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">report_skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">report_skb</span><span class="p">;</span>

<span class="nl">error_put:</span>
	<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">report_skb</span><span class="p">);</span>
<span class="nl">error_new:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p new_state %u old_state %u) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Send a Report State Change message (as created with _alloc).</span>
<span class="cm"> *</span>
<span class="cm"> * @report_skb: as returned by wimax_gnl_re_state_change_alloc()</span>
<span class="cm"> * @header: as returned by wimax_gnl_re_state_change_alloc()</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if ok, &lt; 0 errno code on error.</span>
<span class="cm"> *</span>
<span class="cm"> * If the message is  NULL, pretend it didn&#39;t happen.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">wimax_gnl_re_state_change_send</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">report_skb</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wimax_dev_to_dev</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p report_skb %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">wimax_dev</span><span class="p">,</span> <span class="n">report_skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">genlmsg_end</span><span class="p">(</span><span class="n">report_skb</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
	<span class="n">genlmsg_multicast</span><span class="p">(</span><span class="n">report_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wimax_gnl_mcg</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p report_skb %p) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wimax_dev</span><span class="p">,</span> <span class="n">report_skb</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span>
<span class="kt">void</span> <span class="nf">__check_new_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">old_state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">new_state</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">allowed_states_bm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">new_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">allowed_states_bm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SW BUG! Forbidden state change %u -&gt; %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Set the current state of a WiMAX device [unlocking version of</span>
<span class="cm"> * wimax_state_change().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__wimax_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wimax_dev_to_dev</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">stch_skb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p new_state %u [old %u])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">new_state</span> <span class="o">&gt;=</span> <span class="n">__WIMAX_ST_INVALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SW BUG: requesting invalid state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">new_state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">new_state</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* gcc complains? can&#39;t grok why */</span>
	<span class="n">stch_skb</span> <span class="o">=</span> <span class="n">wimax_gnl_re_state_change_alloc</span><span class="p">(</span>
		<span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">);</span>

	<span class="cm">/* Verify the state transition and do exit-from-state actions */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">old_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">__WIMAX_ST_NULL</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_DOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_DOWN</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__WIMAX_ST_QUIESCING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_UNINITIALIZED</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_RADIO_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">__WIMAX_ST_QUIESCING</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_DOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_UNINITIALIZED</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__WIMAX_ST_QUIESCING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_RADIO_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_RADIO_OFF</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__WIMAX_ST_QUIESCING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_READY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_READY</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__WIMAX_ST_QUIESCING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_RADIO_OFF</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_SCANNING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_CONNECTING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_CONNECTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_SCANNING</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__WIMAX_ST_QUIESCING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_RADIO_OFF</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_READY</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_CONNECTING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_CONNECTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_CONNECTING</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__WIMAX_ST_QUIESCING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_RADIO_OFF</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_READY</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_SCANNING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_CONNECTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_CONNECTED</span>:
		<span class="n">__check_new_state</span><span class="p">(</span><span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__WIMAX_ST_QUIESCING</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_RADIO_OFF</span>
				  <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WIMAX_ST_READY</span><span class="p">);</span>
		<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">__WIMAX_ST_INVALID</span>:
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SW BUG: wimax_dev %p is in unknown state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">wimax_dev</span><span class="p">,</span> <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Execute the actions of entry to the new state */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">__WIMAX_ST_NULL</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SW BUG: wimax_dev %p entering NULL state &quot;</span>
			<span class="s">&quot;from %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wimax_dev</span><span class="p">,</span> <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* Nobody can enter this state */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_DOWN</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">__WIMAX_ST_QUIESCING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_UNINITIALIZED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_RADIO_OFF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_READY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_SCANNING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_CONNECTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIMAX_ST_CONNECTED</span>:
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">__WIMAX_ST_INVALID</span>:
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">__wimax_state_set</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">stch_skb</span><span class="p">))</span>
		<span class="n">wimax_gnl_re_state_change_send</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">stch_skb</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p new_state %u [old %u]) = void</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_state_change - Set the current state of a WiMAX device</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor (properly referenced)</span>
<span class="cm"> * @new_state: New state to switch to</span>
<span class="cm"> *</span>
<span class="cm"> * This implements the state changes for the wimax devices. It will</span>
<span class="cm"> *</span>
<span class="cm"> * - verify that the state transition is legal (for now it&#39;ll just</span>
<span class="cm"> *   print a warning if not) according to the table in</span>
<span class="cm"> *   linux/wimax.h&#39;s documentation for &#39;enum wimax_st&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * - perform the actions needed for leaving the current state and</span>
<span class="cm"> *   whichever are needed for entering the new state.</span>
<span class="cm"> *</span>
<span class="cm"> * - issue a report to user space indicating the new state (and an</span>
<span class="cm"> *   optional payload with information about the new state).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: @wimax_dev must be locked</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wimax_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * A driver cannot take the wimax_dev out of the</span>
<span class="cm">	 * __WIMAX_ST_NULL state unless by calling wimax_dev_add(). If</span>
<span class="cm">	 * the wimax_dev&#39;s state is still NULL, we ignore any request</span>
<span class="cm">	 * to change its state because it means it hasn&#39;t been yet</span>
<span class="cm">	 * registered.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There is no need to complain about it, as routines that</span>
<span class="cm">	 * call this might be shared from different code paths that</span>
<span class="cm">	 * are called before or after wimax_dev_add() has done its</span>
<span class="cm">	 * job.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">__WIMAX_ST_NULL</span><span class="p">)</span>
		<span class="n">__wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_state_change</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_state_get() - Return the current state of a WiMAX device</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: Current state of the device according to its driver.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">wimax_st</span> <span class="nf">wimax_state_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">wimax_st</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_state_get</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_dev_init - initialize a newly allocated instance</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor to initialize.</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes fields of a freshly allocated @wimax_dev instance. This</span>
<span class="cm"> * function assumes that after allocation, the memory occupied by</span>
<span class="cm"> * @wimax_dev was zeroed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wimax_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">id_table_node</span><span class="p">);</span>
	<span class="n">__wimax_state_set</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">__WIMAX_ST_NULL</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex_reset</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_dev_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This extern is declared here because it&#39;s easier to keep track --</span>
<span class="cm"> * both declarations are a list of the same</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">genl_ops</span>
	<span class="n">wimax_gnl_msg_from_user</span><span class="p">,</span>
	<span class="n">wimax_gnl_reset</span><span class="p">,</span>
	<span class="n">wimax_gnl_rfkill</span><span class="p">,</span>
	<span class="n">wimax_gnl_state_get</span><span class="p">;</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">wimax_gnl_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">wimax_gnl_msg_from_user</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">wimax_gnl_reset</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">wimax_gnl_rfkill</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">wimax_gnl_state_get</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span>
<span class="kt">size_t</span> <span class="nf">wimax_addr_scnprint</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addr_str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">addr_str_size</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">total</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">addr_len</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">addr_str</span> <span class="o">+</span> <span class="n">total</span><span class="p">,</span> <span class="n">addr_str_size</span> <span class="o">-</span> <span class="n">total</span><span class="p">,</span>
				   <span class="s">&quot;%02x%c&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span>
				   <span class="n">cnt</span> <span class="o">==</span> <span class="n">addr_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span> <span class="sc">&#39;\0&#39;</span> <span class="o">:</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_dev_add - Register a new WiMAX device</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor (as embedded in your @net_dev&#39;s</span>
<span class="cm"> *     priv data). You must have called wimax_dev_init() on it before.</span>
<span class="cm"> *</span>
<span class="cm"> * @net_dev: net device the @wimax_dev is associated with. The</span>
<span class="cm"> *     function expects SET_NETDEV_DEV() and register_netdev() were</span>
<span class="cm"> *     already called on it.</span>
<span class="cm"> *</span>
<span class="cm"> * Registers the new WiMAX device, sets up the user-kernel control</span>
<span class="cm"> * interface (generic netlink) and common WiMAX infrastructure.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the parts that will allow interaction with user space are</span>
<span class="cm"> * setup at the very end, when the rest is in place, as once that</span>
<span class="cm"> * happens, the driver might get user space control requests via</span>
<span class="cm"> * netlink or from debugfs that might translate into calls into</span>
<span class="cm"> * wimax_dev-&gt;op_*().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wimax_dev_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">addr_str</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p net_dev %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wimax_dev</span><span class="p">,</span> <span class="n">net_dev</span><span class="p">);</span>

	<span class="cm">/* Do the RFKILL setup before locking, as RFKILL will call</span>
<span class="cm">	 * into our functions. */</span>
	<span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">net_dev</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wimax_rfkill_add</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_rfkill_add</span><span class="p">;</span>

	<span class="cm">/* Set up user-space interaction */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wimax_id_table_add</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wimax_debugfs_add</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot initialize debugfs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_debugfs_add</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__wimax_state_set</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_DOWN</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wimax_addr_scnprint</span><span class="p">(</span><span class="n">addr_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr_str</span><span class="p">),</span>
			    <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WiMAX interface %s (%s) ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr_str</span><span class="p">);</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p net_dev %p) = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wimax_dev</span><span class="p">,</span> <span class="n">net_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_debugfs_add:</span>
	<span class="n">wimax_id_table_rm</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wimax_rfkill_rm</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
<span class="nl">error_rfkill_add:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p net_dev %p) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wimax_dev</span><span class="p">,</span> <span class="n">net_dev</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_dev_add</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * wimax_dev_rm - Unregister an existing WiMAX device</span>
<span class="cm"> *</span>
<span class="cm"> * @wimax_dev: WiMAX device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Unregisters a WiMAX device previously registered for use with</span>
<span class="cm"> * wimax_add_rm().</span>
<span class="cm"> *</span>
<span class="cm"> * IMPORTANT! Must call before calling unregister_netdev().</span>
<span class="cm"> *</span>
<span class="cm"> * After this function returns, you will not get any more user space</span>
<span class="cm"> * control requests (via netlink or debugfs) and thus to wimax_dev-&gt;ops.</span>
<span class="cm"> *</span>
<span class="cm"> * Reentrancy control is ensured by setting the state to</span>
<span class="cm"> * %__WIMAX_ST_QUIESCING. rfkill operations coming through</span>
<span class="cm"> * wimax_*rfkill*() will be stopped by the quiescing state; ops coming</span>
<span class="cm"> * from the rfkill subsystem will be stopped by the support being</span>
<span class="cm"> * removed by wimax_rfkill_rm().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wimax_dev_rm</span><span class="p">(</span><span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wimax_dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">__WIMAX_ST_QUIESCING</span><span class="p">);</span>
	<span class="n">wimax_debugfs_rm</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="n">wimax_id_table_rm</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="n">__wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_DOWN</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wimax_rfkill_rm</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">);</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;(wimax_dev %p) = void</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wimax_dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wimax_dev_rm</span><span class="p">);</span>


<span class="cm">/* Debug framework control of debug levels */</span>
<span class="k">struct</span> <span class="n">d_level</span> <span class="n">D_LEVEL</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">D_SUBMODULE_DEFINE</span><span class="p">(</span><span class="n">debugfs</span><span class="p">),</span>
	<span class="n">D_SUBMODULE_DEFINE</span><span class="p">(</span><span class="n">id_table</span><span class="p">),</span>
	<span class="n">D_SUBMODULE_DEFINE</span><span class="p">(</span><span class="n">op_msg</span><span class="p">),</span>
	<span class="n">D_SUBMODULE_DEFINE</span><span class="p">(</span><span class="n">op_reset</span><span class="p">),</span>
	<span class="n">D_SUBMODULE_DEFINE</span><span class="p">(</span><span class="n">op_rfkill</span><span class="p">),</span>
	<span class="n">D_SUBMODULE_DEFINE</span><span class="p">(</span><span class="n">op_state_get</span><span class="p">),</span>
	<span class="n">D_SUBMODULE_DEFINE</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span>
<span class="p">};</span>
<span class="kt">size_t</span> <span class="n">D_LEVEL_SIZE</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">D_LEVEL</span><span class="p">);</span>


<span class="k">struct</span> <span class="n">genl_family</span> <span class="n">wimax_gnl_family</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_GENERATE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;WiMAX&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">WIMAX_GNL_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxattr</span> <span class="o">=</span> <span class="n">WIMAX_GNL_ATTR_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">wimax_gnl_mcg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;msg&quot;</span><span class="p">,</span>
<span class="p">};</span>



<span class="cm">/* Shutdown the wimax stack */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">wimax_subsys_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">d_parse_params</span><span class="p">(</span><span class="n">D_LEVEL</span><span class="p">,</span> <span class="n">D_LEVEL_SIZE</span><span class="p">,</span> <span class="n">wimax_debug_params</span><span class="p">,</span>
		       <span class="s">&quot;wimax.debug&quot;</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">wimax_gnl_family</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wimax_gnl_family</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
		 <span class="s">&quot;WiMAX&quot;</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">genl_register_family</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot register generic netlink family: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_register_family</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wimax_gnl_ops</span><span class="p">);</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">genl_register_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">,</span>
					   <span class="n">wimax_gnl_ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="n">d_printf</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;registering generic netlink op code &quot;</span>
			 <span class="s">&quot;%u: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wimax_gnl_ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot register generic netlink op &quot;</span>
			       <span class="s">&quot;code %u: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">wimax_gnl_ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_register_ops</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wimax_gnl_mcg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_mc_group</span><span class="p">;</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;() = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_mc_group:</span>
<span class="nl">error_register_ops:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">genl_unregister_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">,</span>
				    <span class="n">wimax_gnl_ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
	<span class="n">genl_unregister_family</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">);</span>
<span class="nl">error_register_family:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">wimax_subsys_init</span><span class="p">);</span>


<span class="cm">/* Shutdown the wimax stack */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">wimax_subsys_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">wimax_id_table_release</span><span class="p">();</span>
	<span class="n">genl_unregister_mc_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wimax_gnl_mcg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wimax_gnl_ops</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">genl_unregister_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">,</span>
				    <span class="n">wimax_gnl_ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
	<span class="n">genl_unregister_family</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wimax_gnl_family</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">wimax_subsys_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Intel Corporation &lt;linux-wimax@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux WiMAX stack&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
