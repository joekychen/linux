<!DOCTYPE html>
<html><head><title>joekychen/linux » net › packet › af_packet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>af_packet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * INET		An implementation of the TCP/IP protocol suite for the LINUX</span>
<span class="cm"> *		operating system.  INET is implemented using the  BSD Socket</span>
<span class="cm"> *		interface as the means of communication with the user level.</span>
<span class="cm"> *</span>
<span class="cm"> *		PACKET - implements raw packet sockets.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Ross Biro</span>
<span class="cm"> *		Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;</span>
<span class="cm"> *		Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixes:</span>
<span class="cm"> *		Alan Cox	:	verify_area() now used correctly</span>
<span class="cm"> *		Alan Cox	:	new skbuff lists, look ma no backlogs!</span>
<span class="cm"> *		Alan Cox	:	tidied skbuff lists.</span>
<span class="cm"> *		Alan Cox	:	Now uses generic datagram routines I</span>
<span class="cm"> *					added. Also fixed the peek/read crash</span>
<span class="cm"> *					from all old Linux datagram code.</span>
<span class="cm"> *		Alan Cox	:	Uses the improved datagram code.</span>
<span class="cm"> *		Alan Cox	:	Added NULL&#39;s for socket options.</span>
<span class="cm"> *		Alan Cox	:	Re-commented the code.</span>
<span class="cm"> *		Alan Cox	:	Use new kernel side addressing</span>
<span class="cm"> *		Rob Janssen	:	Correct MTU usage.</span>
<span class="cm"> *		Dave Platt	:	Counter leaks caused by incorrect</span>
<span class="cm"> *					interrupt locking and some slightly</span>
<span class="cm"> *					dubious gcc output. Can you read</span>
<span class="cm"> *					compiler: it said _VOLATILE_</span>
<span class="cm"> *	Richard Kooijman	:	Timestamp fixes.</span>
<span class="cm"> *		Alan Cox	:	New buffers. Use sk-&gt;mac.raw.</span>
<span class="cm"> *		Alan Cox	:	sendmsg/recvmsg support.</span>
<span class="cm"> *		Alan Cox	:	Protocol setting support</span>
<span class="cm"> *	Alexey Kuznetsov	:	Untied from IPv4 stack.</span>
<span class="cm"> *	Cyrus Durgin		:	Fixed kerneld for kmod.</span>
<span class="cm"> *	Michal Ostrowski        :       Module initialization cleanup.</span>
<span class="cm"> *         Ulises Alonso        :       Frame number limit removal and</span>
<span class="cm"> *                                      packet_set_ring memory leak.</span>
<span class="cm"> *		Eric Biederman	:	Allow for &gt; 8 byte hardware addresses.</span>
<span class="cm"> *					The convention is that longer addresses</span>
<span class="cm"> *					will simply extend the hardware address</span>
<span class="cm"> *					byte arrays at the end of sockaddr_ll</span>
<span class="cm"> *					and packet_mreq.</span>
<span class="cm"> *		Johann Baudy	:	Added TX RING.</span>
<span class="cm"> *		Chetan Loke	:	Implemented TPACKET_V3 block abstraction</span>
<span class="cm"> *					layer.</span>
<span class="cm"> *					Copyright (C) 2011, &lt;lokec@ccs.neu.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_packet.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/protocol.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/ioctls.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_net.h&gt;</span>
<span class="cp">#include &lt;linux/errqueue.h&gt;</span>
<span class="cp">#include &lt;linux/net_tstamp.h&gt;</span>

<span class="cp">#ifdef CONFIG_INET</span>
<span class="cp">#include &lt;net/inet_common.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">   Assumptions:</span>
<span class="cm">   - if device has no dev-&gt;hard_header routine, it adds and removes ll header</span>
<span class="cm">     inside itself. In this case ll header is invisible outside of device,</span>
<span class="cm">     but higher levels still should reserve dev-&gt;hard_header_len.</span>
<span class="cm">     Some devices are enough clever to reallocate skb, when header</span>
<span class="cm">     will not fit to reserved space (tunnel), another ones are silly</span>
<span class="cm">     (PPP).</span>
<span class="cm">   - packet socket receives packets with pulled ll header,</span>
<span class="cm">     so that SOCK_RAW should push it back.</span>

<span class="cm">On receive:</span>
<span class="cm">-----------</span>

<span class="cm">Incoming, dev-&gt;hard_header!=NULL</span>
<span class="cm">   mac_header -&gt; ll header</span>
<span class="cm">   data       -&gt; data</span>

<span class="cm">Outgoing, dev-&gt;hard_header!=NULL</span>
<span class="cm">   mac_header -&gt; ll header</span>
<span class="cm">   data       -&gt; ll header</span>

<span class="cm">Incoming, dev-&gt;hard_header==NULL</span>
<span class="cm">   mac_header -&gt; UNKNOWN position. It is very likely, that it points to ll</span>
<span class="cm">		 header.  PPP makes it, that is wrong, because introduce</span>
<span class="cm">		 assymetry between rx and tx paths.</span>
<span class="cm">   data       -&gt; data</span>

<span class="cm">Outgoing, dev-&gt;hard_header==NULL</span>
<span class="cm">   mac_header -&gt; data. ll header is still not built!</span>
<span class="cm">   data       -&gt; data</span>

<span class="cm">Resume</span>
<span class="cm">  If dev-&gt;hard_header==NULL we are unlikely to restore sensible ll header.</span>


<span class="cm">On transmit:</span>
<span class="cm">------------</span>

<span class="cm">dev-&gt;hard_header != NULL</span>
<span class="cm">   mac_header -&gt; ll header</span>
<span class="cm">   data       -&gt; ll header</span>

<span class="cm">dev-&gt;hard_header == NULL (ll header is added by device, we cannot control it)</span>
<span class="cm">   mac_header -&gt; data</span>
<span class="cm">   data       -&gt; data</span>

<span class="cm">   We should set nh.raw on output to correct posistion,</span>
<span class="cm">   packet classifier depends on it.</span>
<span class="cm"> */</span>

<span class="cm">/* Private packet socket structures. */</span>

<span class="k">struct</span> <span class="n">packet_mclist</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_mclist</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ifindex</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">alen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">addr</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
<span class="p">};</span>
<span class="cm">/* identical to struct packet_mreq except it has</span>
<span class="cm"> * a longer address field.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">packet_mreq_max</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">mr_ifindex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">mr_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">mr_alen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">mr_address</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">packet_set_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="o">*</span><span class="n">req_u</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">closing</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_ring</span><span class="p">);</span>


<span class="cp">#define V3_ALIGNMENT	(8)</span>

<span class="cp">#define BLK_HDR_LEN	(ALIGN(sizeof(struct tpacket_block_desc), V3_ALIGNMENT))</span>

<span class="cp">#define BLK_PLUS_PRIV(sz_of_priv) \</span>
<span class="cp">	(BLK_HDR_LEN + ALIGN((sz_of_priv), V3_ALIGNMENT))</span>

<span class="cm">/* kbdq - kernel block descriptor queue */</span>
<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgv</span>	<span class="o">*</span><span class="n">pkbdq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">feature_req_word</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">hdrlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">reset_pending_on_curr_blk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">delete_blk_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">kactive_blk_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">blk_sizeof_priv</span><span class="p">;</span>

	<span class="cm">/* last_kactive_blk_num:</span>
<span class="cm">	 * trick to see if user-space has caught up</span>
<span class="cm">	 * in order to avoid refreshing timer when every single pkt arrives.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">last_kactive_blk_num</span><span class="p">;</span>

	<span class="kt">char</span>		<span class="o">*</span><span class="n">pkblk_start</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">pkblk_end</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">kblk_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">knum_blocks</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">knxt_seq_num</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">nxt_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">atomic_t</span>	<span class="n">blk_fill_in_prog</span><span class="p">;</span>

	<span class="cm">/* Default is set to 8ms */</span>
<span class="cp">#define DEFAULT_PRB_RETIRE_TOV	(8)</span>

	<span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">retire_blk_tov</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">version</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">tov_in_jiffies</span><span class="p">;</span>

	<span class="cm">/* timer to retire an outstanding block */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">retire_blk_timer</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PGV_FROM_VMALLOC 1</span>
<span class="k">struct</span> <span class="n">pgv</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgv</span>		<span class="o">*</span><span class="n">pg_vec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">frames_per_block</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">frame_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">frame_max</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pg_vec_order</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pg_vec_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pg_vec_len</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span>	<span class="n">prb_bdqc</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">pending</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define BLOCK_STATUS(x)	((x)-&gt;hdr.bh1.block_status)</span>
<span class="cp">#define BLOCK_NUM_PKTS(x)	((x)-&gt;hdr.bh1.num_pkts)</span>
<span class="cp">#define BLOCK_O2FP(x)		((x)-&gt;hdr.bh1.offset_to_first_pkt)</span>
<span class="cp">#define BLOCK_LEN(x)		((x)-&gt;hdr.bh1.blk_len)</span>
<span class="cp">#define BLOCK_SNUM(x)		((x)-&gt;hdr.bh1.seq_num)</span>
<span class="cp">#define BLOCK_O2PRIV(x)	((x)-&gt;offset_to_priv)</span>
<span class="cp">#define BLOCK_PRIV(x)		((void *)((char *)(x) + BLOCK_O2PRIV(x)))</span>

<span class="k">struct</span> <span class="n">packet_sock</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tpacket_snd</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">packet_previous_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">packet_increment_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">buff</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prb_curr_blk_in_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">prb_dispatch_next_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prb_retire_current_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prb_queue_frozen</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prb_open_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prb_retire_rx_blk_timer_expired</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_prb_refresh_rx_retire_blk_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prb_init_blk_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prb_fill_rxhash</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prb_clear_rxhash</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prb_fill_vlan_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">packet_flush_mclist</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">packet_fanout</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">packet_sock</span> <span class="p">{</span>
	<span class="cm">/* struct sock has to be the first member of packet_sock */</span>
	<span class="k">struct</span> <span class="n">sock</span>		<span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_fanout</span>	<span class="o">*</span><span class="n">fanout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_stats</span>	<span class="n">stats</span><span class="p">;</span>
	<span class="k">union</span>  <span class="n">tpacket_stats_u</span>	<span class="n">stats_u</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_ring_buffer</span>	<span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_ring_buffer</span>	<span class="n">tx_ring</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">copy_thresh</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">bind_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">pg_vec_lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">running</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* prot_hook is attached*/</span>
				<span class="nl">auxdata:</span><span class="mi">1</span><span class="p">,</span>
				<span class="nl">origdev:</span><span class="mi">1</span><span class="p">,</span>
				<span class="nl">has_vnet_hdr:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ifindex</span><span class="p">;</span>	<span class="cm">/* bound device		*/</span>
	<span class="n">__be16</span>			<span class="n">num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_mclist</span>	<span class="o">*</span><span class="n">mclist</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">mapped</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">tpacket_versions</span>	<span class="n">tp_version</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tp_hdrlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tp_reserve</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tp_loss</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tp_tstamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_type</span>	<span class="n">prot_hook</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PACKET_FANOUT_MAX	256</span>

<span class="k">struct</span> <span class="n">packet_fanout</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_NET_NS</span>
	<span class="k">struct</span> <span class="n">net</span>		<span class="o">*</span><span class="n">net</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">num_members</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">defrag</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">rr_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span>		<span class="o">*</span><span class="n">arr</span><span class="p">[</span><span class="n">PACKET_FANOUT_MAX</span><span class="p">];</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">sk_ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_type</span>	<span class="n">prot_hook</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">packet_skb_cb</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">origlen</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_pkt</span> <span class="n">pkt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="n">ll</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">sa</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PACKET_SKB_CB(__skb)	((struct packet_skb_cb *)((__skb)-&gt;cb))</span>

<span class="cp">#define GET_PBDQC_FROM_RB(x)	((struct tpacket_kbdq_core *)(&amp;(x)-&gt;prb_bdqc))</span>
<span class="cp">#define GET_PBLOCK_DESC(x, bid)	\</span>
<span class="cp">	((struct tpacket_block_desc *)((x)-&gt;pkbdq[(bid)].buffer))</span>
<span class="cp">#define GET_CURR_PBLOCK_DESC_FROM_CORE(x)	\</span>
<span class="cp">	((struct tpacket_block_desc *)((x)-&gt;pkbdq[(x)-&gt;kactive_blk_num].buffer))</span>
<span class="cp">#define GET_NEXT_PRB_BLK_NUM(x) \</span>
<span class="cp">	(((x)-&gt;kactive_blk_num &lt; ((x)-&gt;knum_blocks-1)) ? \</span>
<span class="cp">	((x)-&gt;kactive_blk_num+1) : 0)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="nf">pkt_sk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__fanout_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__fanout_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">);</span>

<span class="cm">/* register_prot_hook must be invoked with the po-&gt;bind_lock held,</span>
<span class="cm"> * or from a context in which asynchronous accesses to the packet</span>
<span class="cm"> * socket is not possible (packet_create()).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">register_prot_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="p">)</span>
			<span class="n">__fanout_link</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">po</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">);</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* {,__}unregister_prot_hook() must be invoked with the po-&gt;bind_lock</span>
<span class="cm"> * held.   If the sync parameter is true, we will temporarily drop</span>
<span class="cm"> * the po-&gt;bind_lock and do a synchronize_net to make sure no</span>
<span class="cm"> * asynchronous packet processing paths still refer to the elements</span>
<span class="cm"> * of po-&gt;prot_hook.  If the sync parameter is false, it is the</span>
<span class="cm"> * callers responsibility to take care of this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__unregister_prot_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="p">)</span>
		<span class="n">__fanout_unlink</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">po</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">);</span>
	<span class="n">__sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
		<span class="n">synchronize_net</span><span class="p">();</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unregister_prot_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="n">__unregister_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__pure</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">pgv_to_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_vmalloc_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">vmalloc_to_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__packet_set_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpacket_hdr</span> <span class="o">*</span><span class="n">h1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tpacket2_hdr</span> <span class="o">*</span><span class="n">h2</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">h</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACKET_V1</span>:
		<span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pgv_to_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACKET_V2</span>:
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pgv_to_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACKET_V3</span>:
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;TPACKET version not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">smp_wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__packet_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpacket_hdr</span> <span class="o">*</span><span class="n">h1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tpacket2_hdr</span> <span class="o">*</span><span class="n">h2</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="n">h</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACKET_V1</span>:
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pgv_to_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_status</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_status</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACKET_V2</span>:
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pgv_to_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_status</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_status</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACKET_V3</span>:
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;TPACKET version not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">packet_lookup_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">position</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pg_vec_pos</span><span class="p">,</span> <span class="n">frame_offset</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpacket_hdr</span> <span class="o">*</span><span class="n">h1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tpacket2_hdr</span> <span class="o">*</span><span class="n">h2</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">pg_vec_pos</span> <span class="o">=</span> <span class="n">position</span> <span class="o">/</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">frames_per_block</span><span class="p">;</span>
	<span class="n">frame_offset</span> <span class="o">=</span> <span class="n">position</span> <span class="o">%</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">frames_per_block</span><span class="p">;</span>

	<span class="n">h</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec</span><span class="p">[</span><span class="n">pg_vec_pos</span><span class="p">].</span><span class="n">buffer</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">frame_offset</span> <span class="o">*</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">__packet_get_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">raw</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">h</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">packet_current_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">packet_lookup_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_del_retire_blk_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">retire_blk_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_shutdown_retire_blk_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">tx_ring</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">rb_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">;</span>

	<span class="n">pkc</span> <span class="o">=</span> <span class="n">tx_ring</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">prb_bdqc</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">prb_bdqc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">delete_blk_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">prb_del_retire_blk_timer</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_init_blk_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">retire_blk_timer</span><span class="p">);</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">retire_blk_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">po</span><span class="p">;</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">retire_blk_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">retire_blk_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_setup_retire_blk_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">pkc</span> <span class="o">=</span> <span class="n">tx_ring</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">prb_bdqc</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">prb_bdqc</span><span class="p">;</span>
	<span class="n">prb_init_blk_timer</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">pkc</span><span class="p">,</span> <span class="n">prb_retire_rx_blk_timer_expired</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prb_calc_retire_blk_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">blk_size_in_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">ecmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">DEFAULT_PRB_RETIRE_TOV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__ethtool_get_settings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecmd</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10000</span>:
			<span class="n">msec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">msec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the link speed is so slow you don&#39;t really</span>
<span class="cm">		 * need to worry about perf anyways</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="k">case</span> <span class="n">SPEED_10</span>:
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">DEFAULT_PRB_RETIRE_TOV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mbits</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk_size_in_bytes</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div</span><span class="p">)</span>
		<span class="n">mbits</span> <span class="o">/=</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">tmo</span> <span class="o">=</span> <span class="n">mbits</span> <span class="o">*</span> <span class="n">msec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tmo</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_init_ft_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="o">*</span><span class="n">req_u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">feature_req_word</span> <span class="o">=</span> <span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_feature_req_word</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_prb_bdqc</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pgv</span> <span class="o">*</span><span class="n">pg_vec</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="o">*</span><span class="n">req_u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">prb_bdqc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">));</span>

	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">knxt_seq_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">pkbdq</span> <span class="o">=</span> <span class="n">pg_vec</span><span class="p">;</span>
	<span class="n">pbd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">pg_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">pkblk_start</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pg_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">kblk_size</span> <span class="o">=</span> <span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_size</span><span class="p">;</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">knum_blocks</span>	<span class="o">=</span> <span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_nr</span><span class="p">;</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">hdrlen</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span><span class="p">;</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">;</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">last_kactive_blk_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">stats_u</span><span class="p">.</span><span class="n">stats3</span><span class="p">.</span><span class="n">tp_freeze_q_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_retire_blk_tov</span><span class="p">)</span>
		<span class="n">p1</span><span class="o">-&gt;</span><span class="n">retire_blk_tov</span> <span class="o">=</span> <span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_retire_blk_tov</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p1</span><span class="o">-&gt;</span><span class="n">retire_blk_tov</span> <span class="o">=</span> <span class="n">prb_calc_retire_blk_tmo</span><span class="p">(</span><span class="n">po</span><span class="p">,</span>
						<span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_size</span><span class="p">);</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">tov_in_jiffies</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">retire_blk_tov</span><span class="p">);</span>
	<span class="n">p1</span><span class="o">-&gt;</span><span class="n">blk_sizeof_priv</span> <span class="o">=</span> <span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_sizeof_priv</span><span class="p">;</span>

	<span class="n">prb_init_ft_ops</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">req_u</span><span class="p">);</span>
	<span class="n">prb_setup_retire_blk_timer</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">prb_open_block</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">pbd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*  Do NOT update the last_blk_num first.</span>
<span class="cm"> *  Assumes sk_buff_head lock is held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_prb_refresh_rx_retire_blk_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">retire_blk_timer</span><span class="p">,</span>
			<span class="n">jiffies</span> <span class="o">+</span> <span class="n">pkc</span><span class="o">-&gt;</span><span class="n">tov_in_jiffies</span><span class="p">);</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">last_kactive_blk_num</span> <span class="o">=</span> <span class="n">pkc</span><span class="o">-&gt;</span><span class="n">kactive_blk_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Timer logic:</span>
<span class="cm"> * 1) We refresh the timer only when we open a block.</span>
<span class="cm"> *    By doing this we don&#39;t waste cycles refreshing the timer</span>
<span class="cm"> *	  on packet-by-packet basis.</span>
<span class="cm"> *</span>
<span class="cm"> * With a 1MB block-size, on a 1Gbps line, it will take</span>
<span class="cm"> * i) ~8 ms to fill a block + ii) memcpy etc.</span>
<span class="cm"> * In this cut we are not accounting for the memcpy time.</span>
<span class="cm"> *</span>
<span class="cm"> * So, if the user sets the &#39;tmo&#39; to 10ms then the timer</span>
<span class="cm"> * will never fire while the block is still getting filled</span>
<span class="cm"> * (which is what we want). However, the user could choose</span>
<span class="cm"> * to close a block early and that&#39;s fine.</span>
<span class="cm"> *</span>
<span class="cm"> * But when the timer does fire, we check whether or not to refresh it.</span>
<span class="cm"> * Since the tmo granularity is in msecs, it is not too expensive</span>
<span class="cm"> * to refresh the timer, lets say every &#39;8&#39; msecs.</span>
<span class="cm"> * Either the user can set the &#39;tmo&#39; or we can derive it based on</span>
<span class="cm"> * a) line-speed and b) block-size.</span>
<span class="cm"> * prb_calc_retire_blk_tmo() calculates the tmo.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_retire_rx_blk_timer_expired</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">prb_bdqc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frozen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">.</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">frozen</span> <span class="o">=</span> <span class="n">prb_queue_frozen</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>
	<span class="n">pbd</span> <span class="o">=</span> <span class="n">GET_CURR_PBLOCK_DESC_FROM_CORE</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">delete_blk_timer</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* We only need to plug the race when the block is partially filled.</span>
<span class="cm">	 * tpacket_rcv:</span>
<span class="cm">	 *		lock(); increment BLOCK_NUM_PKTS; unlock()</span>
<span class="cm">	 *		copy_bits() is in progress ...</span>
<span class="cm">	 *		timer fires on other cpu:</span>
<span class="cm">	 *		we can&#39;t retire the current block because copy_bits</span>
<span class="cm">	 *		is in progress.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BLOCK_NUM_PKTS</span><span class="p">(</span><span class="n">pbd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">blk_fill_in_prog</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Waiting for skb_copy_bits to finish... */</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">last_kactive_blk_num</span> <span class="o">==</span> <span class="n">pkc</span><span class="o">-&gt;</span><span class="n">kactive_blk_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frozen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prb_retire_current_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">TP_STATUS_BLK_TMO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prb_dispatch_next_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">po</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">refresh_timer</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Case 1. Queue was frozen because user-space was</span>
<span class="cm">			 *	   lagging behind.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prb_curr_blk_in_use</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Ok, user-space is still behind.</span>
<span class="cm">				 * So just refresh the timer.</span>
<span class="cm">				 */</span>
				<span class="k">goto</span> <span class="n">refresh_timer</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			       <span class="cm">/* Case 2. queue was frozen,user-space caught up,</span>
<span class="cm">				* now the link went idle &amp;&amp; the timer fired.</span>
<span class="cm">				* We don&#39;t have a block to close.So we open this</span>
<span class="cm">				* block and restart the timer.</span>
<span class="cm">				* opening a block thaws the queue,restarts timer</span>
<span class="cm">				* Thawing/timer-refresh is a side effect.</span>
<span class="cm">				*/</span>
				<span class="n">prb_open_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">refresh_timer:</span>
	<span class="n">_prb_refresh_rx_retire_blk_timer</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">.</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_flush_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc1</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd1</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Flush everything minus the block header */</span>

<span class="cp">#if ARCH_IMPLEMENTS_FLUSH_DCACHE_PAGE == 1</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pbd1</span><span class="p">;</span>

	<span class="cm">/* Skip the block header(we know header WILL fit in 4K) */</span>
	<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">pkblk_end</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pgv_to_page</span><span class="p">(</span><span class="n">start</span><span class="p">));</span>

	<span class="n">smp_wmb</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/* Now update the block status. */</span>

	<span class="n">BLOCK_STATUS</span><span class="p">(</span><span class="n">pbd1</span><span class="p">)</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Flush the block header */</span>

<span class="cp">#if ARCH_IMPLEMENTS_FLUSH_DCACHE_PAGE == 1</span>
	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pbd1</span><span class="p">;</span>
	<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pgv_to_page</span><span class="p">(</span><span class="n">start</span><span class="p">));</span>

	<span class="n">smp_wmb</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Side effect:</span>
<span class="cm"> *</span>
<span class="cm"> * 1) flush the block</span>
<span class="cm"> * 2) Increment active_blk_num</span>
<span class="cm"> *</span>
<span class="cm"> * Note:We DONT refresh the timer on purpose.</span>
<span class="cm"> *	Because almost always the next block will be opened.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_close_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc1</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd1</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">TP_STATUS_USER</span> <span class="o">|</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="n">last_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_hdr_v1</span> <span class="o">*</span><span class="n">h1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbd1</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">bh1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tp_drops</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_STATUS_LOSING</span><span class="p">;</span>

	<span class="n">last_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">last_pkt</span><span class="o">-&gt;</span><span class="n">tp_next_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the ts of the last pkt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BLOCK_NUM_PKTS</span><span class="p">(</span><span class="n">pbd1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">h1</span><span class="o">-&gt;</span><span class="n">ts_last_pkt</span><span class="p">.</span><span class="n">ts_sec</span> <span class="o">=</span> <span class="n">last_pkt</span><span class="o">-&gt;</span><span class="n">tp_sec</span><span class="p">;</span>
		<span class="n">h1</span><span class="o">-&gt;</span><span class="n">ts_last_pkt</span><span class="p">.</span><span class="n">ts_nsec</span>	<span class="o">=</span> <span class="n">last_pkt</span><span class="o">-&gt;</span><span class="n">tp_nsec</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Ok, we tmo&#39;d - so get the current time */</span>
		<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">h1</span><span class="o">-&gt;</span><span class="n">ts_last_pkt</span><span class="p">.</span><span class="n">ts_sec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">h1</span><span class="o">-&gt;</span><span class="n">ts_last_pkt</span><span class="p">.</span><span class="n">ts_nsec</span>	<span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="cm">/* Flush the block */</span>
	<span class="n">prb_flush_block</span><span class="p">(</span><span class="n">pkc1</span><span class="p">,</span> <span class="n">pbd1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">kactive_blk_num</span> <span class="o">=</span> <span class="n">GET_NEXT_PRB_BLK_NUM</span><span class="p">(</span><span class="n">pkc1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_thaw_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">reset_pending_on_curr_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Side effect of opening a block:</span>
<span class="cm"> *</span>
<span class="cm"> * 1) prb_queue is thawed.</span>
<span class="cm"> * 2) retire_blk_timer is refreshed.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_open_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc1</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_hdr_v1</span> <span class="o">*</span><span class="n">h1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbd1</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">bh1</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">TP_STATUS_KERNEL</span> <span class="o">==</span> <span class="n">BLOCK_STATUS</span><span class="p">(</span><span class="n">pbd1</span><span class="p">)))</span> <span class="p">{</span>

		<span class="cm">/* We could have just memset this but we will lose the</span>
<span class="cm">		 * flexibility of making the priv area sticky</span>
<span class="cm">		 */</span>
		<span class="n">BLOCK_SNUM</span><span class="p">(</span><span class="n">pbd1</span><span class="p">)</span> <span class="o">=</span> <span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">knxt_seq_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">BLOCK_NUM_PKTS</span><span class="p">(</span><span class="n">pbd1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BLOCK_LEN</span><span class="p">(</span><span class="n">pbd1</span><span class="p">)</span> <span class="o">=</span> <span class="n">BLK_PLUS_PRIV</span><span class="p">(</span><span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">blk_sizeof_priv</span><span class="p">);</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">h1</span><span class="o">-&gt;</span><span class="n">ts_first_pkt</span><span class="p">.</span><span class="n">ts_sec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">h1</span><span class="o">-&gt;</span><span class="n">ts_first_pkt</span><span class="p">.</span><span class="n">ts_nsec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
		<span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">pkblk_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pbd1</span><span class="p">;</span>
		<span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">nxt_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">pkblk_start</span> <span class="o">+</span>
		<span class="n">BLK_PLUS_PRIV</span><span class="p">(</span><span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">blk_sizeof_priv</span><span class="p">));</span>
		<span class="n">BLOCK_O2FP</span><span class="p">(</span><span class="n">pbd1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">BLK_PLUS_PRIV</span><span class="p">(</span><span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">blk_sizeof_priv</span><span class="p">);</span>
		<span class="n">BLOCK_O2PRIV</span><span class="p">(</span><span class="n">pbd1</span><span class="p">)</span> <span class="o">=</span> <span class="n">BLK_HDR_LEN</span><span class="p">;</span>
		<span class="n">pbd1</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
		<span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">nxt_offset</span><span class="p">;</span>
		<span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">pkblk_end</span> <span class="o">=</span> <span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">pkblk_start</span> <span class="o">+</span> <span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">kblk_size</span><span class="p">;</span>
		<span class="n">prb_thaw_queue</span><span class="p">(</span><span class="n">pkc1</span><span class="p">);</span>
		<span class="n">_prb_refresh_rx_retire_blk_timer</span><span class="p">(</span><span class="n">pkc1</span><span class="p">);</span>

		<span class="n">smp_wmb</span><span class="p">();</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ERROR block:%p is NOT FREE status:%d kactive_blk_num:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pbd1</span><span class="p">,</span> <span class="n">BLOCK_STATUS</span><span class="p">(</span><span class="n">pbd1</span><span class="p">),</span> <span class="n">pkc1</span><span class="o">-&gt;</span><span class="n">kactive_blk_num</span><span class="p">);</span>
	<span class="n">dump_stack</span><span class="p">();</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queue freeze logic:</span>
<span class="cm"> * 1) Assume tp_block_nr = 8 blocks.</span>
<span class="cm"> * 2) At time &#39;t0&#39;, user opens Rx ring.</span>
<span class="cm"> * 3) Some time past &#39;t0&#39;, kernel starts filling blocks starting from 0 .. 7</span>
<span class="cm"> * 4) user-space is either sleeping or processing block &#39;0&#39;.</span>
<span class="cm"> * 5) tpacket_rcv is currently filling block &#39;7&#39;, since there is no space left,</span>
<span class="cm"> *    it will close block-7,loop around and try to fill block &#39;0&#39;.</span>
<span class="cm"> *    call-flow:</span>
<span class="cm"> *    __packet_lookup_frame_in_block</span>
<span class="cm"> *      prb_retire_current_block()</span>
<span class="cm"> *      prb_dispatch_next_block()</span>
<span class="cm"> *        |-&gt;(BLOCK_STATUS == USER) evaluates to true</span>
<span class="cm"> *    5.1) Since block-0 is currently in-use, we just freeze the queue.</span>
<span class="cm"> * 6) Now there are two cases:</span>
<span class="cm"> *    6.1) Link goes idle right after the queue is frozen.</span>
<span class="cm"> *         But remember, the last open_block() refreshed the timer.</span>
<span class="cm"> *         When this timer expires,it will refresh itself so that we can</span>
<span class="cm"> *         re-open block-0 in near future.</span>
<span class="cm"> *    6.2) Link is busy and keeps on receiving packets. This is a simple</span>
<span class="cm"> *         case and __packet_lookup_frame_in_block will check if block-0</span>
<span class="cm"> *         is free and can now be re-used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_freeze_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">reset_pending_on_curr_blk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">stats_u</span><span class="p">.</span><span class="n">stats3</span><span class="p">.</span><span class="n">tp_freeze_q_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TOTAL_PKT_LEN_INCL_ALIGN(length) (ALIGN((length), V3_ALIGNMENT))</span>

<span class="cm">/*</span>
<span class="cm"> * If the next block is free then we will dispatch it</span>
<span class="cm"> * and return a good offset.</span>
<span class="cm"> * Else, we will freeze the queue.</span>
<span class="cm"> * So, caller must check the return value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">prb_dispatch_next_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="cm">/* 1. Get current block num */</span>
	<span class="n">pbd</span> <span class="o">=</span> <span class="n">GET_CURR_PBLOCK_DESC_FROM_CORE</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>

	<span class="cm">/* 2. If this block is currently in_use then freeze the queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TP_STATUS_USER</span> <span class="o">&amp;</span> <span class="n">BLOCK_STATUS</span><span class="p">(</span><span class="n">pbd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prb_freeze_queue</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">po</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 3.</span>
<span class="cm">	 * open this block and return the offset where the first packet</span>
<span class="cm">	 * needs to get stored.</span>
<span class="cm">	 */</span>
	<span class="n">prb_open_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">nxt_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_retire_current_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span> <span class="o">=</span> <span class="n">GET_CURR_PBLOCK_DESC_FROM_CORE</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>

	<span class="cm">/* retire/close the current block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">TP_STATUS_KERNEL</span> <span class="o">==</span> <span class="n">BLOCK_STATUS</span><span class="p">(</span><span class="n">pbd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Plug the case where copy_bits() is in progress on</span>
<span class="cm">		 * cpu-0 and tpacket_rcv() got invoked on cpu-1, didn&#39;t</span>
<span class="cm">		 * have space to copy the pkt in the current block and</span>
<span class="cm">		 * called prb_retire_current_block()</span>
<span class="cm">		 *</span>
<span class="cm">		 * We don&#39;t need to worry about the TMO case because</span>
<span class="cm">		 * the timer-handler already handled this case.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_STATUS_BLK_TMO</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">blk_fill_in_prog</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Waiting for skb_copy_bits to finish... */</span>
				<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">prb_close_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ERROR-pbd[%d]:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkc</span><span class="o">-&gt;</span><span class="n">kactive_blk_num</span><span class="p">,</span> <span class="n">pbd</span><span class="p">);</span>
	<span class="n">dump_stack</span><span class="p">();</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prb_curr_blk_in_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TP_STATUS_USER</span> <span class="o">&amp;</span> <span class="n">BLOCK_STATUS</span><span class="p">(</span><span class="n">pbd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prb_queue_frozen</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pkc</span><span class="o">-&gt;</span><span class="n">reset_pending_on_curr_blk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_clear_blk_fill_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span>  <span class="o">=</span> <span class="n">GET_PBDQC_FROM_RB</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">blk_fill_in_prog</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_fill_rxhash</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hv1</span><span class="p">.</span><span class="n">tp_rxhash</span> <span class="o">=</span> <span class="n">skb_get_rxhash</span><span class="p">(</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_clear_rxhash</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hv1</span><span class="p">.</span><span class="n">tp_rxhash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_fill_vlan_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hv1</span><span class="p">.</span><span class="n">tp_vlan_tci</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">tp_status</span> <span class="o">=</span> <span class="n">TP_STATUS_VLAN_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hv1</span><span class="p">.</span><span class="n">tp_vlan_tci</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">tp_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_run_all_ft_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">prb_fill_vlan_info</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">ppd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">feature_req_word</span> <span class="o">&amp;</span> <span class="n">TP_FT_REQ_FILL_RXHASH</span><span class="p">)</span>
		<span class="n">prb_fill_rxhash</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">ppd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">prb_clear_rxhash</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">ppd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prb_fill_curr_block</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>

	<span class="n">ppd</span>  <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">curr</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">tp_next_offset</span> <span class="o">=</span> <span class="n">TOTAL_PKT_LEN_INCL_ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">nxt_offset</span> <span class="o">+=</span> <span class="n">TOTAL_PKT_LEN_INCL_ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">BLOCK_LEN</span><span class="p">(</span><span class="n">pbd</span><span class="p">)</span> <span class="o">+=</span> <span class="n">TOTAL_PKT_LEN_INCL_ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">BLOCK_NUM_PKTS</span><span class="p">(</span><span class="n">pbd</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkc</span><span class="o">-&gt;</span><span class="n">blk_fill_in_prog</span><span class="p">);</span>
	<span class="n">prb_run_all_ft_ops</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">ppd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Assumes caller has the sk-&gt;rx_queue.lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">__packet_lookup_frame_in_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">status</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span>
					    <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="n">pkc</span> <span class="o">=</span> <span class="n">GET_PBDQC_FROM_RB</span><span class="p">(((</span><span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">));</span>
	<span class="n">pbd</span> <span class="o">=</span> <span class="n">GET_CURR_PBLOCK_DESC_FROM_CORE</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>

	<span class="cm">/* Queue is frozen when user space is lagging behind */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prb_queue_frozen</span><span class="p">(</span><span class="n">pkc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if that last block which caused the queue to freeze,</span>
<span class="cm">		 * is still in_use by user-space.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prb_curr_blk_in_use</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Can&#39;t record this packet */</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Ok, the block was released by user-space.</span>
<span class="cm">			 * Now let&#39;s open that block.</span>
<span class="cm">			 * opening a block also thaws the queue.</span>
<span class="cm">			 * Thawing is a side effect.</span>
<span class="cm">			 */</span>
			<span class="n">prb_open_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="n">curr</span> <span class="o">=</span> <span class="n">pkc</span><span class="o">-&gt;</span><span class="n">nxt_offset</span><span class="p">;</span>
	<span class="n">pkc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pbd</span> <span class="o">+</span> <span class="n">pkc</span><span class="o">-&gt;</span><span class="n">kblk_size</span><span class="p">);</span>

	<span class="cm">/* first try the current block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">+</span><span class="n">TOTAL_PKT_LEN_INCL_ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prb_fill_curr_block</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">curr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ok, close the current block */</span>
	<span class="n">prb_retire_current_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Now, try to dispatch the next block */</span>
	<span class="n">curr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">prb_dispatch_next_block</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">po</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbd</span> <span class="o">=</span> <span class="n">GET_CURR_PBLOCK_DESC_FROM_CORE</span><span class="p">(</span><span class="n">pkc</span><span class="p">);</span>
		<span class="n">prb_fill_curr_block</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">pkc</span><span class="p">,</span> <span class="n">pbd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">curr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * No free blocks are available.user_space hasn&#39;t caught up yet.</span>
<span class="cm">	 * Queue was just frozen and now this packet will get dropped.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">packet_current_rx_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACKET_V1</span>:
	<span class="k">case</span> <span class="n">TPACKET_V2</span>:
		<span class="n">curr</span> <span class="o">=</span> <span class="n">packet_lookup_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
					<span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">curr</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACKET_V3</span>:
		<span class="k">return</span> <span class="n">__packet_lookup_frame_in_block</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;TPACKET version not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">prb_lookup_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_kbdq_core</span> <span class="o">*</span><span class="n">pkc</span>  <span class="o">=</span> <span class="n">GET_PBDQC_FROM_RB</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="o">*</span><span class="n">pbd</span> <span class="o">=</span> <span class="n">GET_PBLOCK_DESC</span><span class="p">(</span><span class="n">pkc</span><span class="p">,</span> <span class="n">previous</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BLOCK_STATUS</span><span class="p">(</span><span class="n">pbd</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pbd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prb_previous_blk_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">prb_bdqc</span><span class="p">.</span><span class="n">kactive_blk_num</span><span class="p">)</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">prb_bdqc</span><span class="p">.</span><span class="n">kactive_blk_num</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">prb_bdqc</span><span class="p">.</span><span class="n">knum_blocks</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">prev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Assumes caller has held the rx_queue.lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">__prb_previous_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">prb_previous_blk_num</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">prb_lookup_block</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">packet_previous_rx_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&lt;=</span> <span class="n">TPACKET_V2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">packet_previous_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__prb_previous_block</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_increment_rx_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACKET_V1</span>:
	<span class="k">case</span> <span class="n">TPACKET_V2</span>:
		<span class="k">return</span> <span class="n">packet_increment_head</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TPACKET_V3</span>:
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;TPACKET version not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">packet_previous_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">?</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">frame_max</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">packet_lookup_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_increment_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buff</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">buff</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">!=</span> <span class="n">buff</span><span class="o">-&gt;</span><span class="n">frame_max</span> <span class="o">?</span> <span class="n">buff</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_sock_destruct</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Attempt to release alive packet socket: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sk_refcnt_debug_dec</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fanout_rr_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rr_cur</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">fanout_demux_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">hash</span> <span class="o">*</span> <span class="n">num</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">fanout_demux_lb</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cur</span><span class="p">,</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rr_cur</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">old</span> <span class="o">=</span> <span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rr_cur</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span>
				     <span class="n">fanout_rr_next</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">num</span><span class="p">)))</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">)</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">cur</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">fanout_demux_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">cpu</span> <span class="o">%</span> <span class="n">num</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_rcv_fanout</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">af_packet_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">num_members</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">read_pnet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET_FANOUT_HASH</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">defrag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">ip_check_defrag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IP_DEFRAG_AF_PACKET</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_get_rxhash</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">fanout_demux_hash</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_FANOUT_LB</span>:
		<span class="n">sk</span> <span class="o">=</span> <span class="n">fanout_demux_lb</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_FANOUT_CPU</span>:
		<span class="n">sk</span> <span class="o">=</span> <span class="n">fanout_demux_cpu</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">func</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">,</span> <span class="n">orig_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">fanout_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">fanout_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__fanout_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">num_members</span><span class="p">]</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">num_members</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__fanout_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">num_members</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">sk</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">num_members</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">num_members</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">num_members</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fanout_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">type_flags</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">defrag</span> <span class="o">=</span> <span class="p">(</span><span class="n">type_flags</span> <span class="o">&amp;</span> <span class="n">PACKET_FANOUT_FLAG_DEFRAG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET_FANOUT_HASH</span>:
	<span class="k">case</span> <span class="n">PACKET_FANOUT_LB</span>:
	<span class="k">case</span> <span class="n">PACKET_FANOUT_CPU</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fanout_mutex</span><span class="p">);</span>
	<span class="n">match</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fanout_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span>
		    <span class="n">read_pnet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">)</span> <span class="o">==</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">match</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">defrag</span> <span class="o">!=</span> <span class="n">defrag</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">match</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">write_pnet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">defrag</span> <span class="o">=</span> <span class="n">defrag</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">rr_cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">sk_ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">packet_rcv_fanout</span><span class="p">;</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">af_packet_priv</span> <span class="o">=</span> <span class="n">match</span><span class="p">;</span>
		<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fanout_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span> <span class="o">&amp;&amp;</span>
	    <span class="n">match</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;&amp;</span>
	    <span class="n">match</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">sk_ref</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PACKET_FANOUT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">);</span>
			<span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span> <span class="o">=</span> <span class="n">match</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">sk_ref</span><span class="p">);</span>
			<span class="n">__fanout_link</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">po</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fanout_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fanout_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">packet_fanout</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fanout_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">sk_ref</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fanout_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">packet_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">packet_ops_spkt</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_rcv_spkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_pkt</span> <span class="o">*</span><span class="n">spkt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	When we registered the protocol we saved the socket in the data</span>
<span class="cm">	 *	field for just this event.</span>
<span class="cm">	 */</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">af_packet_priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Yank back the headers [hope the device set this</span>
<span class="cm">	 *	right or kerboom...]</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Incoming packets have ll header pulled,</span>
<span class="cm">	 *	push it back.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	For outgoing ones skb-&gt;data == skb_mac_header(skb)</span>
<span class="cm">	 *	so that this procedure is noop.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_LOOPBACK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_share_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>

	<span class="cm">/* drop any routing info */</span>
	<span class="n">skb_dst_drop</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* drop conntrack reference */</span>
	<span class="n">nf_reset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">spkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">PACKET_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 *	The SOCK_PACKET socket receives _all_ frames.</span>
<span class="cm">	 */</span>

	<span class="n">spkt</span><span class="o">-&gt;</span><span class="n">spkt_family</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">spkt</span><span class="o">-&gt;</span><span class="n">spkt_device</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spkt</span><span class="o">-&gt;</span><span class="n">spkt_device</span><span class="p">));</span>
	<span class="n">spkt</span><span class="o">-&gt;</span><span class="n">spkt_protocol</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Charge the memory to the socket. This is done specifically</span>
<span class="cm">	 *	to prevent sockets using all the memory up.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock_queue_rcv_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">oom:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Output a raw packet to a device layer. This bypasses all the other</span>
<span class="cm"> *	protocol layers and you must therefore supply it with a complete frame</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_sendmsg_spkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_pkt</span> <span class="o">*</span><span class="n">saddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">extra_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Get and verify the address.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pkt</span><span class="p">))</span>
			<span class="n">proto</span> <span class="o">=</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">spkt_protocol</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>	<span class="cm">/* SOCK_PACKET must be sent giving an address */</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Find the device first to size check it</span>
<span class="cm">	 */</span>

	<span class="n">saddr</span><span class="o">-&gt;</span><span class="n">spkt_device</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">retry:</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_name_rcu</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">spkt_device</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * You may not queue a frame bigger than the mtu. This is the lowest level</span>
<span class="cm">	 * raw protocol and you must do your own fragmentation at this level.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_NOFCS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_supports_nofcs</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">extra_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* We&#39;re doing our own CRC */</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">reserved</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hhlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_wmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">reserved</span> <span class="o">+</span> <span class="n">tlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="cm">/* FIXME: Save some space for broken drivers that write a hard</span>
<span class="cm">		 * header at transmission time by themselves. PPP is the notable</span>
<span class="cm">		 * one here. This should really be fixed at the driver level.</span>
<span class="cm">		 */</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">reserved</span><span class="p">);</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="cm">/* Try to align data part correctly */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hhlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-=</span> <span class="n">hhlen</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-=</span> <span class="n">hhlen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">hhlen</span><span class="p">)</span>
				<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Earlier code assumed this would be a VLAN pkt,</span>
<span class="cm">		 * double-check this now that we have the actual</span>
<span class="cm">		 * packet in hand.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ehdr</span><span class="p">;</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ehdr</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_priority</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_mark</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_tx_timestamp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">extra_len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">no_fcs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="nl">out_free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">run_filter</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">filter</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">SK_RUN_FILTER</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function makes lazy skb cloning in hope that most of packets</span>
<span class="cm"> * are discarded by BPF.</span>
<span class="cm"> *</span>
<span class="cm"> * Note tricky part: we DO mangle shared skb! skb-&gt;data, skb-&gt;len</span>
<span class="cm"> * and skb-&gt;cb are mangled. It works because (and until) packets</span>
<span class="cm"> * falling here are owned by current CPU. Output packets are cloned</span>
<span class="cm"> * by dev_queue_xmit_nit(), input packets are processed by net_bh</span>
<span class="cm"> * sequencially, so that if we return skb to original state on exit,</span>
<span class="cm"> * we will not harm anyone.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="n">sll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">skb_head</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snaplen</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_LOOPBACK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">af_packet_priv</span><span class="p">;</span>
	<span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The device has an explicit notion of ll header,</span>
<span class="cm">		 * exported to higher levels.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Otherwise, the device hides details of its frame</span>
<span class="cm">		 * structure, so that corresponding packet head is</span>
<span class="cm">		 * never delivered to user.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_DGRAM</span><span class="p">)</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_OUTGOING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Special case: outgoing packets have ll header at head */</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snaplen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">snaplen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_n_restore</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snaplen</span> <span class="o">&gt;</span> <span class="n">res</span><span class="p">)</span>
		<span class="n">snaplen</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_n_acct</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop_n_acct</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_head</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb_head</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">PACKET_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="o">+</span> <span class="n">MAX_ADDR_LEN</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">&gt;</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>

	<span class="n">sll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">PACKET_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">ll</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_family</span> <span class="o">=</span> <span class="n">AF_PACKET</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_hatype</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_protocol</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_pkttype</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">origdev</span><span class="p">))</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span> <span class="o">=</span> <span class="n">orig_dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>

	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_halen</span> <span class="o">=</span> <span class="n">dev_parse_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_addr</span><span class="p">);</span>

	<span class="n">PACKET_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">origlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pskb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">snaplen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop_n_acct</span><span class="p">;</span>

	<span class="n">skb_set_owner_r</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_dst_drop</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* drop conntrack reference */</span>
	<span class="n">nf_reset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tp_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dropcount</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_drops</span><span class="p">);</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop_n_acct:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tp_drops</span><span class="o">++</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_drops</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">drop_n_restore:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_head</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb_head</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">drop:</span>
	<span class="n">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacket_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="n">sll</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpacket_hdr</span> <span class="o">*</span><span class="n">h1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tpacket2_hdr</span> <span class="o">*</span><span class="n">h2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="o">*</span><span class="n">h3</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">skb_head</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snaplen</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span> <span class="o">=</span> <span class="n">TP_STATUS_USER</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">macoff</span><span class="p">,</span> <span class="n">netoff</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">copy_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_shared_hwtstamps</span> <span class="o">*</span><span class="n">shhwtstamps</span> <span class="o">=</span> <span class="n">skb_hwtstamps</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_LOOPBACK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">af_packet_priv</span><span class="p">;</span>
	<span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_DGRAM</span><span class="p">)</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_OUTGOING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Special case: outgoing packets have ll header at head */</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_STATUS_CSUMNOTREADY</span><span class="p">;</span>

	<span class="n">snaplen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">snaplen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_n_restore</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snaplen</span> <span class="o">&gt;</span> <span class="n">res</span><span class="p">)</span>
		<span class="n">snaplen</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">macoff</span> <span class="o">=</span> <span class="n">netoff</span> <span class="o">=</span> <span class="n">TPACKET_ALIGN</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span>
				  <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_reserve</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maclen</span> <span class="o">=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">netoff</span> <span class="o">=</span> <span class="n">TPACKET_ALIGN</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">maclen</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">maclen</span><span class="p">))</span> <span class="o">+</span>
			<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_reserve</span><span class="p">;</span>
		<span class="n">macoff</span> <span class="o">=</span> <span class="n">netoff</span> <span class="o">-</span> <span class="n">maclen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&lt;=</span> <span class="n">TPACKET_V2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macoff</span> <span class="o">+</span> <span class="n">snaplen</span> <span class="o">&gt;</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">frame_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">copy_thresh</span> <span class="o">&amp;&amp;</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">copy_skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">copy_skb</span> <span class="o">=</span> <span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">skb_head</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_skb</span><span class="p">)</span>
					<span class="n">skb_set_owner_r</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">snaplen</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">frame_size</span> <span class="o">-</span> <span class="n">macoff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">snaplen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">snaplen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">h</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">packet_current_rx_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					<span class="n">TP_STATUS_KERNEL</span><span class="p">,</span> <span class="p">(</span><span class="n">macoff</span><span class="o">+</span><span class="n">snaplen</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">.</span><span class="n">raw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ring_is_full</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&lt;=</span> <span class="n">TPACKET_V2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packet_increment_rx_head</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * LOSING will be reported till you read the stats,</span>
<span class="cm">	 * because it&#39;s COR - Clear On Read.</span>
<span class="cm">	 * Anyways, moving it for V1/V2 only as V3 doesn&#39;t need this</span>
<span class="cm">	 * at packet level.</span>
<span class="cm">	 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tp_drops</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_STATUS_LOSING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tp_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_STATUS_COPY</span><span class="p">;</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">copy_skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">raw</span> <span class="o">+</span> <span class="n">macoff</span><span class="p">,</span> <span class="n">snaplen</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACKET_V1</span>:
		<span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_snaplen</span> <span class="o">=</span> <span class="n">snaplen</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_mac</span> <span class="o">=</span> <span class="n">macoff</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_net</span> <span class="o">=</span> <span class="n">netoff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span> <span class="o">&amp;</span> <span class="n">SOF_TIMESTAMPING_SYS_HARDWARE</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">tv</span> <span class="o">=</span> <span class="n">ktime_to_timeval</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span> <span class="o">&amp;</span> <span class="n">SOF_TIMESTAMPING_RAW_HARDWARE</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">tv</span> <span class="o">=</span> <span class="n">ktime_to_timeval</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">tv</span> <span class="o">=</span> <span class="n">ktime_to_timeval</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_sec</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_usec</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">.</span><span class="n">h1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACKET_V2</span>:
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_snaplen</span> <span class="o">=</span> <span class="n">snaplen</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_mac</span> <span class="o">=</span> <span class="n">macoff</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_net</span> <span class="o">=</span> <span class="n">netoff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span> <span class="o">&amp;</span> <span class="n">SOF_TIMESTAMPING_SYS_HARDWARE</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">ktime_to_timespec</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span> <span class="o">&amp;</span> <span class="n">SOF_TIMESTAMPING_RAW_HARDWARE</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">ktime_to_timespec</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">ktime_to_timespec</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_sec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_nsec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_vlan_tci</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_STATUS_VLAN_VALID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_vlan_tci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">.</span><span class="n">h2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACKET_V3</span>:
		<span class="cm">/* tp_nxt_offset,vlan are already populated above.</span>
<span class="cm">		 * So DONT clear those fields here</span>
<span class="cm">		 */</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="o">-&gt;</span><span class="n">tp_status</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="o">-&gt;</span><span class="n">tp_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="o">-&gt;</span><span class="n">tp_snaplen</span> <span class="o">=</span> <span class="n">snaplen</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="o">-&gt;</span><span class="n">tp_mac</span> <span class="o">=</span> <span class="n">macoff</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="o">-&gt;</span><span class="n">tp_net</span> <span class="o">=</span> <span class="n">netoff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span> <span class="o">&amp;</span> <span class="n">SOF_TIMESTAMPING_SYS_HARDWARE</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">ktime_to_timespec</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span> <span class="o">&amp;</span> <span class="n">SOF_TIMESTAMPING_RAW_HARDWARE</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">ktime_to_timespec</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">ktime_to_timespec</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="o">-&gt;</span><span class="n">tp_sec</span>  <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="o">-&gt;</span><span class="n">tp_nsec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">.</span><span class="n">h3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">sll</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">raw</span> <span class="o">+</span> <span class="n">TPACKET_ALIGN</span><span class="p">(</span><span class="n">hdrlen</span><span class="p">);</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_halen</span> <span class="o">=</span> <span class="n">dev_parse_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_addr</span><span class="p">);</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_family</span> <span class="o">=</span> <span class="n">AF_PACKET</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_hatype</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_protocol</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_pkttype</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">origdev</span><span class="p">))</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span> <span class="o">=</span> <span class="n">orig_dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>

	<span class="n">smp_mb</span><span class="p">();</span>
<span class="cp">#if ARCH_IMPLEMENTS_FLUSH_DCACHE_PAGE == 1</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&lt;=</span> <span class="n">TPACKET_V2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">h</span><span class="p">.</span><span class="n">raw</span>
				<span class="o">+</span> <span class="n">macoff</span> <span class="o">+</span> <span class="n">snaplen</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
				<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pgv_to_page</span><span class="p">(</span><span class="n">start</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&lt;=</span> <span class="n">TPACKET_V2</span><span class="p">)</span>
		<span class="n">__packet_set_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">prb_clear_blk_fill_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">drop_n_restore:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_head</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb_head</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ring_is_full:</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tp_drops</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">drop_n_restore</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacket_destruct_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ph</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ph</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">destructor_arg</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">__packet_get_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TP_STATUS_SENDING</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pending</span><span class="p">);</span>
		<span class="n">__packet_set_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">TP_STATUS_AVAILABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sock_wfree</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacket_fill_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size_max</span><span class="p">,</span>
		<span class="n">__be16</span> <span class="n">proto</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpacket_hdr</span> <span class="o">*</span><span class="n">h1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tpacket2_hdr</span> <span class="o">*</span><span class="n">h2</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_write</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">tp_len</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">,</span> <span class="n">len_max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">.</span><span class="n">sk_socket</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ph</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">.</span><span class="n">sk_priority</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">.</span><span class="n">sk_mark</span><span class="p">;</span>
	<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">destructor_arg</span> <span class="o">=</span> <span class="n">ph</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACKET_V2</span>:
		<span class="n">tp_len</span> <span class="o">=</span> <span class="n">ph</span><span class="p">.</span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">tp_len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tp_len</span> <span class="o">=</span> <span class="n">ph</span><span class="p">.</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">tp_len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tp_len</span> <span class="o">&gt;</span> <span class="n">size_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;packet size is too long (%d &gt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tp_len</span><span class="p">,</span> <span class="n">size_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ph</span><span class="p">.</span><span class="n">raw</span> <span class="o">+</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">);</span>
	<span class="n">to_write</span> <span class="o">=</span> <span class="n">tp_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dev_hard_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">proto</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="n">tp_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* net device doesn&#39;t like empty head */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tp_len</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;packet size is too short (%d &lt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tp_len</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">skb_store_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>
		<span class="n">to_write</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">len_max</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">to_write</span> <span class="o">&gt;</span> <span class="n">len_max</span><span class="p">)</span> <span class="o">?</span> <span class="n">len_max</span> <span class="o">:</span> <span class="n">to_write</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">to_write</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">to_write</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">to_write</span><span class="p">;</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">to_write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">.</span><span class="n">sk_wmem_alloc</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">to_write</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nr_frags</span> <span class="o">&gt;=</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Packet exceed the number of skb frags(%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">MAX_SKB_FRAGS</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">pgv_to_page</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">to_write</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len_max</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">to_write</span> <span class="o">&gt;</span> <span class="n">len_max</span><span class="p">)</span> <span class="o">?</span> <span class="n">len_max</span> <span class="o">:</span> <span class="n">to_write</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tp_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacket_snd</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">need_rls_dev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">reserve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="n">saddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tp_len</span><span class="p">,</span> <span class="n">size_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">tlen</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">proto</span>	<span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">addr</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_halen</span>
					<span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">,</span>
						<span class="n">sll_addr</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">proto</span>	<span class="o">=</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_protocol</span><span class="p">;</span>
		<span class="n">addr</span>	<span class="o">=</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_addr</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span><span class="p">);</span>
		<span class="n">need_rls_dev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">reserve</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="n">size_max</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">frame_size</span>
		<span class="o">-</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size_max</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">reserve</span><span class="p">)</span>
		<span class="n">size_max</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">reserve</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ph</span> <span class="o">=</span> <span class="n">packet_current_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
				<span class="n">TP_STATUS_SEND_REQUEST</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ph</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">TP_STATUS_SEND_REQUEST</span><span class="p">;</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span>
				<span class="n">hlen</span> <span class="o">+</span> <span class="n">tlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_status</span><span class="p">;</span>

		<span class="n">tp_len</span> <span class="o">=</span> <span class="n">tpacket_fill_skb</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">size_max</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tp_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_loss</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__packet_set_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span>
						<span class="n">TP_STATUS_AVAILABLE</span><span class="p">);</span>
				<span class="n">packet_increment_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">TP_STATUS_WRONG_FORMAT</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">tp_len</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">tpacket_destruct_skb</span><span class="p">;</span>
		<span class="n">__packet_set_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">TP_STATUS_SENDING</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pending</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">TP_STATUS_SEND_REQUEST</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">net_xmit_errno</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">__packet_get_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span> <span class="o">==</span>
				   <span class="n">TP_STATUS_AVAILABLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* skb was destructed already */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_status</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * skb was dropped but not destructed yet;</span>
<span class="cm">			 * let&#39;s treat it like congestion or err &lt; 0</span>
<span class="cm">			 */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">packet_increment_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
		<span class="n">len_sum</span> <span class="o">+=</span> <span class="n">tp_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">ph</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pending</span><span class="p">))))</span>
		<span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">len_sum</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

<span class="nl">out_status:</span>
	<span class="n">__packet_set_status</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">out_put:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_rls_dev</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">packet_alloc_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">prepad</span><span class="p">,</span>
				        <span class="kt">size_t</span> <span class="n">reserve</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
				        <span class="kt">size_t</span> <span class="n">linear</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noblock</span><span class="p">,</span>
				        <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Under a page?  Don&#39;t bother with paged skb. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prepad</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">||</span> <span class="o">!</span><span class="n">linear</span><span class="p">)</span>
		<span class="n">linear</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_pskb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">prepad</span> <span class="o">+</span> <span class="n">linear</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">linear</span><span class="p">,</span> <span class="n">noblock</span><span class="p">,</span>
				   <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">reserve</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">linear</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">linear</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">linear</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_snd</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="n">saddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">need_rls_dev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">reserve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_net_hdr</span> <span class="n">vnet_hdr</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vnet_hdr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">gso_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">tlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">extra_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Get and verify the address.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">proto</span>	<span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">addr</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_halen</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">,</span> <span class="n">sll_addr</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">proto</span>	<span class="o">=</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_protocol</span><span class="p">;</span>
		<span class="n">addr</span>	<span class="o">=</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_addr</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span><span class="p">);</span>
		<span class="n">need_rls_dev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_RAW</span><span class="p">)</span>
		<span class="n">reserve</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">has_vnet_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vnet_hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vnet_hdr</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">vnet_hdr_len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">vnet_hdr_len</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">memcpy_fromiovec</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vnet_hdr</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span>
				       <span class="n">vnet_hdr_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIRTIO_NET_HDR_F_NEEDS_CSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">+</span> <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span>
		      <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">hdr_len</span><span class="p">))</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">hdr_len</span> <span class="o">=</span> <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">+</span>
						 <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">hdr_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">!=</span> <span class="n">VIRTIO_NET_HDR_GSO_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VIRTIO_NET_HDR_GSO_ECN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">VIRTIO_NET_HDR_GSO_TCPV4</span>:
				<span class="n">gso_type</span> <span class="o">=</span> <span class="n">SKB_GSO_TCPV4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">VIRTIO_NET_HDR_GSO_TCPV6</span>:
				<span class="n">gso_type</span> <span class="o">=</span> <span class="n">SKB_GSO_TCPV6</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">VIRTIO_NET_HDR_GSO_UDP</span>:
				<span class="n">gso_type</span> <span class="o">=</span> <span class="n">SKB_GSO_UDP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="n">VIRTIO_NET_HDR_GSO_ECN</span><span class="p">)</span>
				<span class="n">gso_type</span> <span class="o">|=</span> <span class="n">SKB_GSO_TCP_ECN</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_NOFCS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_supports_nofcs</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">extra_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* We&#39;re doing our own CRC */</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gso_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">reserve</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">hlen</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">packet_alloc_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hlen</span> <span class="o">+</span> <span class="n">tlen</span><span class="p">,</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">hdr_len</span><span class="p">,</span>
			       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">reserve</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_DGRAM</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">dev_hard_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">proto</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="cm">/* Returns -EFAULT on error */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">skb_copy_datagram_from_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_tx_timestamp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gso_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">reserve</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Earlier code assumed this would be a VLAN pkt,</span>
<span class="cm">		 * double-check this now that we have the actual</span>
<span class="cm">		 * packet in hand.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ehdr</span><span class="p">;</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ehdr</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_priority</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_mark</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">has_vnet_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vnet_hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIRTIO_NET_HDR_F_NEEDS_CSUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_partial_csum_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_start</span><span class="p">,</span>
						  <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_offset</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">=</span> <span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_size</span><span class="p">;</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">=</span> <span class="n">gso_type</span><span class="p">;</span>

		<span class="cm">/* Header must be checked, and gso_segs computed. */</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">|=</span> <span class="n">SKB_GSO_DODGY</span><span class="p">;</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">vnet_hdr_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">extra_len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">no_fcs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Now send it</span>
<span class="cm">	 */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">net_xmit_errno</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_rls_dev</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">need_rls_dev</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tpacket_snd</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">packet_snd</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Close a PACKET socket. This is fairly simple. We immediately go</span>
<span class="cm"> *	to &#39;closed&#39; state and remove our protocol entry in the device list.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="n">req_u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist_lock</span><span class="p">);</span>
	<span class="n">sk_del_node_init_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_prot_inuse_add</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist_lock</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="n">unregister_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>

	<span class="n">packet_flush_mclist</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req_u</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span>
		<span class="n">packet_set_ring</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req_u</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span>
		<span class="n">packet_set_ring</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req_u</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">fanout_release</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">synchronize_net</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now the socket is dead. No more input will appear.</span>
<span class="cm">	 */</span>
	<span class="n">sock_orphan</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Purge queues */</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
	<span class="n">sk_refcnt_debug_release</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Attach a packet hook.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_do_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">protocol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="n">unregister_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">register_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Bind a packet socket to a device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_bind_spkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check legality</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">packet_do_bind</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="n">sll</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 *	Check legality</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_family</span> <span class="o">!=</span> <span class="n">AF_PACKET</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">packet_do_bind</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_protocol</span> <span class="o">?</span> <span class="o">:</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">packet_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="s">&quot;PACKET&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_sock</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Create a packet of type SOCK_PACKET.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">proto</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__be16</span><span class="p">)</span><span class="n">protocol</span><span class="p">;</span> <span class="cm">/* weird, but documented */</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_RAW</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_DGRAM</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_RAW</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_PACKET</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_PACKET</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packet_ops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_PACKET</span><span class="p">)</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packet_ops_spkt</span><span class="p">;</span>

	<span class="n">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">=</span> <span class="n">PF_PACKET</span><span class="p">;</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_destruct</span> <span class="o">=</span> <span class="n">packet_sock_destruct</span><span class="p">;</span>
	<span class="n">sk_refcnt_debug_inc</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Attach a protocol block</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">packet_rcv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_PACKET</span><span class="p">)</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">packet_rcv_spkt</span><span class="p">;</span>

	<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">af_packet_priv</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
		<span class="n">register_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist_lock</span><span class="p">);</span>
	<span class="n">sk_add_node_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist</span><span class="p">);</span>
	<span class="n">sock_prot_inuse_add</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_proto</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_recv_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock_exterr_skb</span> <span class="o">*</span><span class="n">serr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">copied</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_skb</span><span class="p">;</span>

	<span class="n">sock_recv_timestamp</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">serr</span> <span class="o">=</span> <span class="n">SKB_EXT_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">put_cmsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SOL_PACKET</span><span class="p">,</span> <span class="n">PACKET_TX_TIMESTAMP</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">serr</span><span class="o">-&gt;</span><span class="n">ee</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">serr</span><span class="o">-&gt;</span><span class="n">ee</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_ERRQUEUE</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">copied</span><span class="p">;</span>

	<span class="cm">/* Reset and regenerate socket error */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">SKB_EXT_ERR</span><span class="p">(</span><span class="n">skb2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ee</span><span class="p">.</span><span class="n">ee_errno</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">out_free_skb:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Pull a packet from our receive queue and hand it to the user.</span>
<span class="cm"> *	If necessary we block.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="n">sll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vnet_hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSG_PEEK</span><span class="o">|</span><span class="n">MSG_DONTWAIT</span><span class="o">|</span><span class="n">MSG_TRUNC</span><span class="o">|</span><span class="n">MSG_CMSG_COMPAT</span><span class="o">|</span><span class="n">MSG_ERRQUEUE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* What error should we return now? EUNATTACH? */</span>
<span class="c">	if (pkt_sk(sk)-&gt;ifindex &lt; 0)</span>
<span class="c">		return -ENODEV;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_ERRQUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">packet_recv_error</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Call the generic datagram receiver. This handles all sorts</span>
<span class="cm">	 *	of horrible races and re-entrancy so we can forget about it</span>
<span class="cm">	 *	in the protocol layers.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Now it will return ENETDOWN, if device have just gone down,</span>
<span class="cm">	 *	but then it will block.</span>
<span class="cm">	 */</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	An error occurred so return it. Because skb_recv_datagram()</span>
<span class="cm">	 *	handles the blocking we don&#39;t see and worry about blocking</span>
<span class="cm">	 *	retries.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">has_vnet_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">virtio_net_hdr</span> <span class="n">vnet_hdr</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">vnet_hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vnet_hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">vnet_hdr_len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">vnet_hdr_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">skb_shared_info</span> <span class="o">*</span><span class="n">sinfo</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="cm">/* This is a hint as to how much should be linear. */</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">hdr_len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_size</span> <span class="o">=</span> <span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="n">SKB_GSO_TCPV4</span><span class="p">)</span>
				<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">=</span> <span class="n">VIRTIO_NET_HDR_GSO_TCPV4</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="n">SKB_GSO_TCPV6</span><span class="p">)</span>
				<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">=</span> <span class="n">VIRTIO_NET_HDR_GSO_TCPV6</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="n">SKB_GSO_UDP</span><span class="p">)</span>
				<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">=</span> <span class="n">VIRTIO_NET_HDR_GSO_UDP</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="n">SKB_GSO_FCOE</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="n">SKB_GSO_TCP_ECN</span><span class="p">)</span>
				<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">|=</span> <span class="n">VIRTIO_NET_HDR_GSO_ECN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">gso_type</span> <span class="o">=</span> <span class="n">VIRTIO_NET_HDR_GSO_NONE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">VIRTIO_NET_HDR_F_NEEDS_CSUM</span><span class="p">;</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">=</span> <span class="n">skb_checksum_start_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">csum_offset</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vnet_hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">VIRTIO_NET_HDR_F_DATA_VALID</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* else everything is zero */</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">memcpy_toiovec</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vnet_hdr</span><span class="p">,</span>
				     <span class="n">vnet_hdr_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	If the address length field is there to be filled in, we fill</span>
<span class="cm">	 *	it in now.</span>
<span class="cm">	 */</span>

	<span class="n">sll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">PACKET_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">ll</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_PACKET</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_pkt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_halen</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">,</span> <span class="n">sll_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	You lose any data beyond the buffer you gave. If it worries a</span>
<span class="cm">	 *	user program they can ask the device for its MTU anyway.</span>
<span class="cm">	 */</span>

	<span class="n">copied</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">sock_recv_ts_and_drops</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PACKET_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">auxdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpacket_auxdata</span> <span class="n">aux</span><span class="p">;</span>

		<span class="n">aux</span><span class="p">.</span><span class="n">tp_status</span> <span class="o">=</span> <span class="n">TP_STATUS_USER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
			<span class="n">aux</span><span class="p">.</span><span class="n">tp_status</span> <span class="o">|=</span> <span class="n">TP_STATUS_CSUMNOTREADY</span><span class="p">;</span>
		<span class="n">aux</span><span class="p">.</span><span class="n">tp_len</span> <span class="o">=</span> <span class="n">PACKET_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">origlen</span><span class="p">;</span>
		<span class="n">aux</span><span class="p">.</span><span class="n">tp_snaplen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">aux</span><span class="p">.</span><span class="n">tp_mac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">aux</span><span class="p">.</span><span class="n">tp_net</span> <span class="o">=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">aux</span><span class="p">.</span><span class="n">tp_vlan_tci</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">aux</span><span class="p">.</span><span class="n">tp_status</span> <span class="o">|=</span> <span class="n">TP_STATUS_VLAN_VALID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">aux</span><span class="p">.</span><span class="n">tp_vlan_tci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">aux</span><span class="p">.</span><span class="n">tp_padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">put_cmsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SOL_PACKET</span><span class="p">,</span> <span class="n">PACKET_AUXDATA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aux</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">aux</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Free or return the buffer as appropriate. Again this</span>
<span class="cm">	 *	hides all the races and re-entrancy issues from us.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">vnet_hdr_len</span> <span class="o">+</span> <span class="p">((</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">MSG_TRUNC</span><span class="p">)</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">copied</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_getname_spkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">uaddr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span>	<span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">uaddr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">AF_PACKET</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">uaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">uaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="o">*</span><span class="n">uaddr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_getname</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">uaddr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">DECLARE_SOCKADDR</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="o">*</span><span class="p">,</span> <span class="n">sll</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_family</span> <span class="o">=</span> <span class="n">AF_PACKET</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_ifindex</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_protocol</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_pkttype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_hatype</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_halen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_hatype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Bad: we have no ARPHRD_UNSPEC */</span>
		<span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_halen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="o">*</span><span class="n">uaddr_len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ll</span><span class="p">,</span> <span class="n">sll_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">sll</span><span class="o">-&gt;</span><span class="n">sll_halen</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_dev_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_mclist</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET_MR_MULTICAST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">alen</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dev_mc_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">dev_mc_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_MR_PROMISC</span>:
		<span class="k">return</span> <span class="n">dev_set_promiscuity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_MR_ALLMULTI</span>:
		<span class="k">return</span> <span class="n">dev_set_allmulti</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_MR_UNICAST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">alen</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dev_uc_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">dev_uc_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_dev_mclist</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_mclist</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span>
			<span class="n">packet_dev_mc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_mc_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_mreq_max</span> <span class="o">*</span><span class="n">mreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">packet_mclist</span> <span class="o">*</span><span class="n">ml</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_alen</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ml</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span><span class="p">;</span> <span class="n">ml</span><span class="p">;</span> <span class="n">ml</span> <span class="o">=</span> <span class="n">ml</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ml</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_ifindex</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ml</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_type</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ml</span><span class="o">-&gt;</span><span class="n">alen</span> <span class="o">==</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_alen</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">ml</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_address</span><span class="p">,</span> <span class="n">ml</span><span class="o">-&gt;</span><span class="n">alen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ml</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Free the new element ... */</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_type</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_ifindex</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">alen</span> <span class="o">=</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_alen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_address</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">alen</span><span class="p">);</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span><span class="p">;</span>
	<span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">packet_dev_mc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_mc_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_mreq_max</span> <span class="o">*</span><span class="n">mreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_mclist</span> <span class="o">*</span><span class="n">ml</span><span class="p">,</span> <span class="o">**</span><span class="n">mlp</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mlp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mclist</span><span class="p">;</span> <span class="p">(</span><span class="n">ml</span> <span class="o">=</span> <span class="o">*</span><span class="n">mlp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">mlp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ml</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ml</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_ifindex</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ml</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_type</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ml</span><span class="o">-&gt;</span><span class="n">alen</span> <span class="o">==</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_alen</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">ml</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">mr_address</span><span class="p">,</span> <span class="n">ml</span><span class="o">-&gt;</span><span class="n">alen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ml</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
				<span class="o">*</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">ml</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">ml</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
					<span class="n">packet_dev_mc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ml</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ml</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_flush_mclist</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">packet_mclist</span> <span class="o">*</span><span class="n">ml</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ml</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span> <span class="o">=</span> <span class="n">ml</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_index</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">ml</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">packet_dev_mc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ml</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ml</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">packet_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_PACKET</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET_ADD_MEMBERSHIP</span>:
	<span class="k">case</span> <span class="n">PACKET_DROP_MEMBERSHIP</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">packet_mreq_max</span> <span class="n">mreq</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">optlen</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mreq</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_mreq</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mreq</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mreq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mreq</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mreq</span><span class="p">.</span><span class="n">mr_alen</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_mreq</span><span class="p">,</span> <span class="n">mr_address</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">optname</span> <span class="o">==</span> <span class="n">PACKET_ADD_MEMBERSHIP</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">packet_mc_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mreq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">packet_mc_drop</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mreq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">PACKET_RX_RING</span>:
	<span class="k">case</span> <span class="n">PACKET_TX_RING</span>:
	<span class="p">{</span>
		<span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="n">req_u</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TPACKET_V1</span>:
		<span class="k">case</span> <span class="n">TPACKET_V2</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req_u</span><span class="p">.</span><span class="n">req</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TPACKET_V3</span>:
		<span class="nl">default:</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req_u</span><span class="p">.</span><span class="n">req3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">has_vnet_hdr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">packet_set_ring</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req_u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">optname</span> <span class="o">==</span> <span class="n">PACKET_TX_RING</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_COPY_THRESH</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">copy_thresh</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_VERSION</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">pg_vec</span> <span class="o">||</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TPACKET_V1</span>:
		<span class="k">case</span> <span class="n">TPACKET_V2</span>:
		<span class="k">case</span> <span class="n">TPACKET_V3</span>:
			<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_RESERVE</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">pg_vec</span> <span class="o">||</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_reserve</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_LOSS</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">pg_vec</span> <span class="o">||</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_loss</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_AUXDATA</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">po</span><span class="o">-&gt;</span><span class="n">auxdata</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_ORIGDEV</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">po</span><span class="o">-&gt;</span><span class="n">origdev</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_VNET_HDR</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_RAW</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">pg_vec</span> <span class="o">||</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">po</span><span class="o">-&gt;</span><span class="n">has_vnet_hdr</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_TIMESTAMP</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET_FANOUT</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">fanout_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">lv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_stats</span> <span class="n">st</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">tpacket_stats_u</span> <span class="n">st_u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_PACKET</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET_STATISTICS</span>:
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">==</span> <span class="n">TPACKET_V3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_stats_v3</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_u</span><span class="p">.</span><span class="n">stats3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_stats</span><span class="p">));</span>
			<span class="n">st_u</span><span class="p">.</span><span class="n">stats3</span><span class="p">.</span><span class="n">tp_freeze_q_cnt</span> <span class="o">=</span>
					<span class="n">po</span><span class="o">-&gt;</span><span class="n">stats_u</span><span class="p">.</span><span class="n">stats3</span><span class="p">.</span><span class="n">tp_freeze_q_cnt</span><span class="p">;</span>
			<span class="n">st_u</span><span class="p">.</span><span class="n">stats3</span><span class="p">.</span><span class="n">tp_packets</span> <span class="o">+=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tp_drops</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st_u</span><span class="p">.</span><span class="n">stats3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_stats</span><span class="p">);</span>
			<span class="n">st</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
			<span class="n">st</span><span class="p">.</span><span class="n">tp_packets</span> <span class="o">+=</span> <span class="n">st</span><span class="p">.</span><span class="n">tp_drops</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="p">));</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_AUXDATA</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">auxdata</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_ORIGDEV</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">origdev</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_VNET_HDR</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">has_vnet_hdr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_VERSION</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_HDRLEN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TPACKET_V1</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TPACKET_V2</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket2_hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TPACKET_V3</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket3_hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_RESERVE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_reserve</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_LOSS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_loss</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_TIMESTAMP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_tstamp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_FANOUT</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span> <span class="o">?</span>
		       <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">fanout</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">:</span>
		       <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">lv</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sk_for_each_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NETDEV_UNREGISTER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span><span class="p">)</span>
				<span class="n">packet_dev_mclist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">mclist</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fallthrough */</span>

		<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">__unregister_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
					<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ENETDOWN</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
						<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="n">NETDEV_UNREGISTER</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
						<span class="n">dev_put</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NETDEV_UP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span>
					<span class="n">register_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCOUTQ</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">sk_wmem_alloc_get</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SIOCINQ</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SIOCGSTAMP</span>:
		<span class="k">return</span> <span class="n">sock_get_timestamp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SIOCGSTAMPNS</span>:
		<span class="k">return</span> <span class="n">sock_get_timestampns</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_INET</span>
	<span class="k">case</span> <span class="n">SIOCADDRT</span>:
	<span class="k">case</span> <span class="n">SIOCDELRT</span>:
	<span class="k">case</span> <span class="n">SIOCDARP</span>:
	<span class="k">case</span> <span class="n">SIOCGARP</span>:
	<span class="k">case</span> <span class="n">SIOCSARP</span>:
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFNETMASK</span>:
	<span class="k">case</span> <span class="n">SIOCSIFNETMASK</span>:
	<span class="k">case</span> <span class="n">SIOCGIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFFLAGS</span>:
		<span class="k">return</span> <span class="n">inet_dgram_ops</span><span class="p">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">packet_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
				<span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">datagram_poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet_previous_rx_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
			<span class="n">TP_STATUS_KERNEL</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet_current_frame</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">TP_STATUS_AVAILABLE</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Dirty? Well, I still did not learn better way to account</span>
<span class="cm"> * for user mmaps.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_mm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_mm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">packet_mmap_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>	<span class="o">=</span>	<span class="n">packet_mm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>	<span class="o">=</span>	<span class="n">packet_mm_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_pg_vec</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgv</span> <span class="o">*</span><span class="n">pg_vec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_vmalloc_addr</span><span class="p">(</span><span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">))</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">,</span>
					   <span class="n">order</span><span class="p">);</span>
			<span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pg_vec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">alloc_one_pg_vec_page</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">gfp_flags</span> <span class="o">=</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_COMP</span> <span class="o">|</span>
			  <span class="n">__GFP_ZERO</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span> <span class="n">__GFP_NORETRY</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_pages</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * __get_free_pages failed, fall back to vmalloc</span>
<span class="cm">	 */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * vmalloc failed, lets dig into swap here</span>
<span class="cm">	 */</span>
	<span class="n">gfp_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__GFP_NORETRY</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * complete and utter failure</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pgv</span> <span class="o">*</span><span class="nf">alloc_pg_vec</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacket_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_nr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgv</span> <span class="o">*</span><span class="n">pg_vec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pg_vec</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">block_nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pg_vec</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">block_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">alloc_one_pg_vec_page</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free_pgvec</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">pg_vec</span><span class="p">;</span>

<span class="nl">out_free_pgvec:</span>
	<span class="n">free_pg_vec</span><span class="p">(</span><span class="n">pg_vec</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">block_nr</span><span class="p">);</span>
	<span class="n">pg_vec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_set_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="o">*</span><span class="n">req_u</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">closing</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgv</span> <span class="o">*</span><span class="n">pg_vec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">was_running</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">rb_queue</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Added to avoid minimal code churn */</span>
	<span class="k">struct</span> <span class="n">tpacket_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* Opening a Tx-ring is NOT supported in TPACKET_V3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">closing</span> <span class="o">&amp;&amp;</span> <span class="n">tx_ring</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&gt;</span> <span class="n">TPACKET_V2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tx-ring is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb</span> <span class="o">=</span> <span class="n">tx_ring</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="n">rb_queue</span> <span class="o">=</span> <span class="n">tx_ring</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">closing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sanity tests and some calculations */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TPACKET_V1</span>:
			<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span> <span class="o">=</span> <span class="n">TPACKET_HDRLEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TPACKET_V2</span>:
			<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span> <span class="o">=</span> <span class="n">TPACKET2_HDRLEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TPACKET_V3</span>:
			<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span> <span class="o">=</span> <span class="n">TPACKET3_HDRLEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_size</span> <span class="o">&lt;</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_hdrlen</span> <span class="o">+</span>
					<span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_reserve</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPACKET_ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">frames_per_block</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_size</span><span class="o">/</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">frames_per_block</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">frames_per_block</span> <span class="o">*</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_nr</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_nr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_size</span><span class="p">);</span>
		<span class="n">pg_vec</span> <span class="o">=</span> <span class="n">alloc_pg_vec</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pg_vec</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TPACKET_V3</span>:
		<span class="cm">/* Transmit path is not supported. We checked</span>
<span class="cm">		 * it above but just being paranoid</span>
<span class="cm">		 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="p">)</span>
				<span class="n">init_prb_bdqc</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">pg_vec</span><span class="p">,</span> <span class="n">req_u</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Done */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_nr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Detach socket from network */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="n">was_running</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">was_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__unregister_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>

	<span class="n">synchronize_net</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">closing</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">swap</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec</span><span class="p">,</span> <span class="n">pg_vec</span><span class="p">);</span>
		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">frame_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_size</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">swap</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec_order</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
		<span class="n">swap</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec_len</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_nr</span><span class="p">);</span>

		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec_pages</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_size</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">prot_hook</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">pg_vec</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">tpacket_rcv</span> <span class="o">:</span> <span class="n">packet_rcv</span><span class="p">;</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="n">rb_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;packet_mmap: vma is busy: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">was_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">register_prot_hook</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">bind_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">closing</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&gt;</span> <span class="n">TPACKET_V2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Because we don&#39;t support block-based V3 on tx-ring */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="p">)</span>
			<span class="n">prb_shutdown_retire_blk_timer</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">,</span> <span class="n">rb_queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pg_vec</span><span class="p">)</span>
		<span class="n">free_pg_vec</span><span class="p">(</span><span class="n">pg_vec</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_nr</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">expected_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>

	<span class="n">expected_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span> <span class="n">rb</span> <span class="o">&lt;=</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span> <span class="n">rb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">expected_size</span> <span class="o">+=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec_len</span>
						<span class="o">*</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec_pages</span>
						<span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">expected_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">expected_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span> <span class="n">rb</span> <span class="o">&lt;=</span> <span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span> <span class="n">rb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">pg_num</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">pg_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pg_num</span> <span class="o">&lt;</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec_pages</span><span class="p">;</span> <span class="n">pg_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">page</span> <span class="o">=</span> <span class="n">pgv_to_page</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">vm_insert_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
				<span class="n">kaddr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">);</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packet_mmap_ops</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">packet_ops_spkt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>	<span class="n">PF_PACKET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">packet_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">packet_bind_spkt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span>	<span class="n">sock_no_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span> <span class="o">=</span>	<span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span> <span class="o">=</span>	<span class="n">sock_no_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span> <span class="o">=</span>	<span class="n">packet_getname_spkt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">datagram_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">packet_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listen</span> <span class="o">=</span>	<span class="n">sock_no_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>	<span class="n">sock_no_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span> <span class="o">=</span>	<span class="n">sock_no_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span> <span class="o">=</span>	<span class="n">sock_no_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span> <span class="o">=</span>	<span class="n">packet_sendmsg_spkt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span> <span class="o">=</span>	<span class="n">packet_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span> <span class="o">=</span>	<span class="n">sock_no_sendpage</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">packet_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>	<span class="n">PF_PACKET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">packet_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">packet_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span>	<span class="n">sock_no_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span> <span class="o">=</span>	<span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span> <span class="o">=</span>	<span class="n">sock_no_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span> <span class="o">=</span>	<span class="n">packet_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">packet_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">packet_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listen</span> <span class="o">=</span>	<span class="n">sock_no_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>	<span class="n">sock_no_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span> <span class="o">=</span>	<span class="n">packet_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span> <span class="o">=</span>	<span class="n">packet_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span> <span class="o">=</span>	<span class="n">packet_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span> <span class="o">=</span>	<span class="n">packet_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">packet_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span> <span class="o">=</span>	<span class="n">sock_no_sendpage</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">packet_family_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>	<span class="n">PF_PACKET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span>	<span class="n">packet_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">packet_netdev_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span>	<span class="n">packet_notifier</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">packet_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">RCU</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">seq_hlist_start_head_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">packet_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">seq_hlist_next_rcu</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">RCU</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;sk       RefCnt Type Proto  Iface R Rmem   User   Inode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">sk_entry</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="n">pkt_sk</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;%pK %-6d %-4d %04x   %-5d %1d %-6u %-6u %-6lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">s</span><span class="p">,</span>
			   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sk_refcnt</span><span class="p">),</span>
			   <span class="n">s</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">,</span>
			   <span class="n">ntohs</span><span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">),</span>
			   <span class="n">po</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span>
			   <span class="n">po</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">,</span>
			   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">),</span>
			   <span class="n">sock_i_uid</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
			   <span class="n">sock_i_ino</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">packet_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">packet_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">packet_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">packet_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">packet_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_seq_ops</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_net_private</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">packet_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">packet_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">packet_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist_lock</span><span class="p">);</span>
	<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">.</span><span class="n">sklist</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;packet&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_seq_fops</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">packet_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;packet&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">packet_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">packet_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">packet_net_exit</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">packet_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_netdev_notifier</span><span class="p">);</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_net_ops</span><span class="p">);</span>
	<span class="n">sock_unregister</span><span class="p">(</span><span class="n">PF_PACKET</span><span class="p">);</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">packet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_family_ops</span><span class="p">);</span>
	<span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_net_ops</span><span class="p">);</span>
	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_netdev_notifier</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">packet_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">packet_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NETPROTO</span><span class="p">(</span><span class="n">PF_PACKET</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
