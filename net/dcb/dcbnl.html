<!DOCTYPE html>
<html><head><title>joekychen/linux » net › dcb › dcbnl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dcbnl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011, Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lucy Liu &lt;lucy.liu@intel.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/netlink.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/netlink.h&gt;</span>
<span class="cp">#include &lt;net/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/dcbnl.h&gt;</span>
<span class="cp">#include &lt;net/dcbevent.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> * Data Center Bridging (DCB) is a collection of Ethernet enhancements</span>
<span class="cm"> * intended to allow network traffic with differing requirements</span>
<span class="cm"> * (highly reliable, no drops vs. best effort vs. low latency) to operate</span>
<span class="cm"> * and co-exist on Ethernet.  Current DCB features are:</span>
<span class="cm"> *</span>
<span class="cm"> * Enhanced Transmission Selection (aka Priority Grouping [PG]) - provides a</span>
<span class="cm"> *   framework for assigning bandwidth guarantees to traffic classes.</span>
<span class="cm"> *</span>
<span class="cm"> * Priority-based Flow Control (PFC) - provides a flow control mechanism which</span>
<span class="cm"> *   can work independently for each 802.1p priority.</span>
<span class="cm"> *</span>
<span class="cm"> * Congestion Notification - provides a mechanism for end-to-end congestion</span>
<span class="cm"> *   control for protocols which do not have built-in congestion management.</span>
<span class="cm"> *</span>
<span class="cm"> * More information about the emerging standards for these Ethernet features</span>
<span class="cm"> * can be found at: http://www.ieee802.org/1/pages/dcbridges.html</span>
<span class="cm"> *</span>
<span class="cm"> * This file implements an rtnetlink interface to allow configuration of DCB</span>
<span class="cm"> * features for capable devices.</span>
<span class="cm"> */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Lucy Liu, &lt;lucy.liu@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Data Center Bridging netlink interface&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/**************** DCB attribute policies *************************************/</span>

<span class="cm">/* DCB netlink attributes policy */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_rtnl_policy</span><span class="p">[</span><span class="n">DCB_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_ATTR_IFNAME</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NUL_STRING</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_STATE</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_PFC_CFG</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_PG_CFG</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_SET_ALL</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_PERM_HWADDR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_CAP</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_PFC_STATE</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_BCN</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_APP</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_IEEE</span><span class="p">]</span>	       <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_DCBX</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_FEATCFG</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DCB priority flow control to User Priority nested attributes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_pfc_up_nest</span><span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_1</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_2</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_3</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_4</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_5</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_6</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_7</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_ALL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DCB priority grouping nested attributes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_pg_nest</span><span class="p">[</span><span class="n">DCB_PG_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_0</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_1</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_2</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_3</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_4</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_5</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_6</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_7</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_TC_ALL</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_1</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_2</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_3</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_4</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_5</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_6</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_7</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_ALL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DCB traffic class nested attributes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_tc_param_nest</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_PGID</span><span class="p">]</span>            <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_UP_MAPPING</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_STRICT_PRIO</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_BW_PCT</span><span class="p">]</span>          <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_ALL</span><span class="p">]</span>             <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DCB capabilities nested attributes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_cap_nest</span><span class="p">[</span><span class="n">DCB_CAP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_ALL</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_PG</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_PFC</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_UP2TC</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_PG_TCS</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_PFC_TCS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_GSP</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_BCN</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_CAP_ATTR_DCBX</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DCB capabilities nested attributes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_numtcs_nest</span><span class="p">[</span><span class="n">DCB_NUMTCS_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_NUMTCS_ATTR_ALL</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_NUMTCS_ATTR_PG</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_NUMTCS_ATTR_PFC</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DCB BCN nested attributes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_bcn_nest</span><span class="p">[</span><span class="n">DCB_BCN_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_0</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_1</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_2</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_3</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_4</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_5</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_6</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_7</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RP_ALL</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_BCNA_0</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_BCNA_1</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_ALPHA</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_BETA</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_GD</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_GI</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_TMAX</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_TD</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RMIN</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_W</span><span class="p">]</span>            <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RD</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RU</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_WRTT</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_RI</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_C</span><span class="p">]</span>            <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_BCN_ATTR_ALL</span><span class="p">]</span>          <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DCB APP nested attributes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_app_nest</span><span class="p">[</span><span class="n">DCB_APP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_APP_ATTR_IDTYPE</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_APP_ATTR_ID</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U16</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_APP_ATTR_PRIORITY</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* IEEE 802.1Qaz nested attributes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_ieee_policy</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_ATTR_IEEE_ETS</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_ets</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_IEEE_PFC</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_pfc</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_IEEE_APP_TABLE</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_ATTR_IEEE_MAXRATE</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_maxrate</span><span class="p">)},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_ieee_app</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_APP_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_ATTR_IEEE_APP</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcb_app</span><span class="p">)},</span>
<span class="p">};</span>

<span class="cm">/* DCB number of traffic classes nested attributes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">dcbnl_featcfg_nest</span><span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_ALL</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_PG</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_PFC</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
	<span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_APP</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dcb_app_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dcb_lock</span><span class="p">);</span>

<span class="cm">/* standard netlink reply call */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_reply</span><span class="p">(</span><span class="n">u8</span> <span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">event</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">attr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span>
                       <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* end the message, assign the nlmsg_len. */</span>
	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nlmsg_failure:</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                          <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* if (!tb[DCB_ATTR_STATE] || !netdev-&gt;dcbnl_ops-&gt;getstate) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getstate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="n">RTM_GETDCB</span><span class="p">,</span>
	                  <span class="n">DCB_CMD_GSTATE</span><span class="p">,</span> <span class="n">DCB_ATTR_STATE</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getpfccfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                           <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">getall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PFC_CFG</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpfccfg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_PFC_UP_ATTR_MAX</span><span class="p">,</span>
	                       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PFC_CFG</span><span class="p">],</span>
	                       <span class="n">dcbnl_pfc_up_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_PFC_GCFG</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_PFC_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_ALL</span><span class="p">])</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PFC_UP_ATTR_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpfccfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">,</span>
		                             <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nlmsg_failure:</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getperm_hwaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                                <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">perm_addr</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpermhwaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_GPERM_HWADDR</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpermhwaddr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">perm_addr</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_PERM_HWADDR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">perm_addr</span><span class="p">),</span>
	              <span class="n">perm_addr</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nlmsg_failure:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                        <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_CAP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">getall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_CAP</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getcap</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_CAP_ATTR_MAX</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_CAP</span><span class="p">],</span>
	                       <span class="n">dcbnl_cap_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_GCAP</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_CAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_CAP_ATTR_ALL</span><span class="p">])</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_CAP_ATTR_ALL</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_CAP_ATTR_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getcap</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nlmsg_failure:</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getnumtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                           <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_NUMTCS_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">getall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_NUMTCS</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getnumtcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_NUMTCS_ATTR_MAX</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_NUMTCS</span><span class="p">],</span>
	                       <span class="n">dcbnl_numtcs_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_GNUMTCS</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_NUMTCS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_NUMTCS_ATTR_ALL</span><span class="p">])</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_NUMTCS_ATTR_ALL</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_NUMTCS_ATTR_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getnumtcs</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nlmsg_failure:</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setnumtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                           <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_NUMTCS_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_NUMTCS</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setnumtcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_NUMTCS_ATTR_MAX</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_NUMTCS</span><span class="p">],</span>
	                       <span class="n">dcbnl_numtcs_nest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_NUMTCS_ATTR_ALL</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_NUMTCS_ATTR_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setnumtcs</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">operr</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">operr:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="o">!!</span><span class="n">ret</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_SNUMTCS</span><span class="p">,</span>
	                  <span class="n">DCB_ATTR_NUMTCS</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getpfcstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpfcstate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpfcstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="n">RTM_GETDCB</span><span class="p">,</span>
	                  <span class="n">DCB_CMD_PFC_GSTATE</span><span class="p">,</span> <span class="n">DCB_ATTR_PFC_STATE</span><span class="p">,</span>
	                  <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setpfcstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PFC_STATE</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpfcstate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PFC_STATE</span><span class="p">]);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpfcstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_PFC_SSTATE</span><span class="p">,</span> <span class="n">DCB_ATTR_PFC_STATE</span><span class="p">,</span>
	                  <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                        <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">app_nest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">up</span><span class="p">,</span> <span class="n">idtype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_APP</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">app_tb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_MAX</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_APP</span><span class="p">],</span>
	                       <span class="n">dcbnl_app_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* all must be non-null */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_IDTYPE</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_ID</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* either by eth type or by socket number */</span>
	<span class="n">idtype</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_IDTYPE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">idtype</span> <span class="o">!=</span> <span class="n">DCB_APP_IDTYPE_ETHTYPE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">idtype</span> <span class="o">!=</span> <span class="n">DCB_APP_IDTYPE_PORTNUM</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_ID</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getapp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dcb_app</span> <span class="n">app</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">idtype</span><span class="p">,</span>
					<span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>
				     <span class="p">};</span>
		<span class="n">up</span> <span class="o">=</span> <span class="n">dcb_getapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send this back */</span>
	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_GAPP</span><span class="p">;</span>

	<span class="n">app_nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_APP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">app_nest</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cancel</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_IDTYPE</span><span class="p">,</span> <span class="n">idtype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cancel</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_ID</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cancel</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_PRIORITY</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cancel</span><span class="p">;</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">app_nest</span><span class="p">);</span>
	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_cancel:</span>
	<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">app_nest</span><span class="p">);</span>
<span class="nl">nlmsg_failure:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                        <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">up</span><span class="p">,</span> <span class="n">idtype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_APP</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">app_tb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_MAX</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_APP</span><span class="p">],</span>
	                       <span class="n">dcbnl_app_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* all must be non-null */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_IDTYPE</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_ID</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_PRIORITY</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* either by eth type or by socket number */</span>
	<span class="n">idtype</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_IDTYPE</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">idtype</span> <span class="o">!=</span> <span class="n">DCB_APP_IDTYPE_ETHTYPE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">idtype</span> <span class="o">!=</span> <span class="n">DCB_APP_IDTYPE_PORTNUM</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">nla_get_u16</span><span class="p">(</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_ID</span><span class="p">]);</span>
	<span class="n">up</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">app_tb</span><span class="p">[</span><span class="n">DCB_APP_ATTR_PRIORITY</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setapp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dcb_app</span> <span class="n">app</span><span class="p">;</span>
		<span class="n">app</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">idtype</span><span class="p">;</span>
		<span class="n">app</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">app</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dcb_setapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_SAPP</span><span class="p">,</span> <span class="n">DCB_ATTR_APP</span><span class="p">,</span>
			  <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dcbnl_cee_notify</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_SAPP</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dcbnl_pg_getcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pg_nest</span><span class="p">,</span> <span class="o">*</span><span class="n">param_nest</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">DCB_PG_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">prio</span><span class="p">,</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">,</span> <span class="n">up_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">getall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PG_CFG</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgtx</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgrx</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgtx</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgrx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">pg_tb</span><span class="p">,</span> <span class="n">DCB_PG_ATTR_MAX</span><span class="p">,</span>
	                       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PG_CFG</span><span class="p">],</span> <span class="n">dcbnl_pg_nest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">?</span> <span class="n">DCB_CMD_PGRX_GCFG</span> <span class="o">:</span> <span class="n">DCB_CMD_PGTX_GCFG</span><span class="p">;</span>

	<span class="n">pg_nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_PG_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg_nest</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">DCB_PG_ATTR_TC_ALL</span><span class="p">])</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PG_ATTR_TC_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">DCB_PG_ATTR_TC_ALL</span><span class="p">])</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">pg_tb</span><span class="p">[</span><span class="n">DCB_PG_ATTR_TC_ALL</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">pg_tb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">param_tb</span><span class="p">,</span> <span class="n">DCB_TC_ATTR_PARAM_MAX</span><span class="p">,</span>
				       <span class="n">data</span><span class="p">,</span> <span class="n">dcbnl_tc_param_nest</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pg</span><span class="p">;</span>

		<span class="n">param_nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param_nest</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pg</span><span class="p">;</span>

		<span class="n">pgid</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">prio</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">tc_pct</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">up_map</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgrx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
						<span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prio</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_map</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Tx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgtx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
						<span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prio</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_map</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_PGID</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_ALL</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span>
			                 <span class="n">DCB_TC_ATTR_PARAM_PGID</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_param</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_UP_MAPPING</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_ALL</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span>
			                 <span class="n">DCB_TC_ATTR_PARAM_UP_MAPPING</span><span class="p">,</span> <span class="n">up_map</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_param</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_STRICT_PRIO</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_ALL</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span>
			                 <span class="n">DCB_TC_ATTR_PARAM_STRICT_PRIO</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_param</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_BW_PCT</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_ALL</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_TC_ATTR_PARAM_BW_PCT</span><span class="p">,</span>
			                 <span class="n">tc_pct</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_param</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">param_nest</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">DCB_PG_ATTR_BW_ID_ALL</span><span class="p">])</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PG_ATTR_BW_ID_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tc_pct</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgrx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
					<span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Tx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgtx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
					<span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pg_nest</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_param:</span>
	<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">param_nest</span><span class="p">);</span>
<span class="nl">err_pg:</span>
	<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pg_nest</span><span class="p">);</span>
<span class="nl">nlmsg_failure:</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">ret</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_pgtx_getcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__dcbnl_pg_getcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_pgrx_getcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__dcbnl_pg_getcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                          <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_STATE</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setstate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_STATE</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
	                  <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_SSTATE</span><span class="p">,</span> <span class="n">DCB_ATTR_STATE</span><span class="p">,</span>
	                  <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setpfccfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                           <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_PFC_UP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PFC_CFG</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpfccfg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_PFC_UP_ATTR_MAX</span><span class="p">,</span>
	                       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PFC_CFG</span><span class="p">],</span>
	                       <span class="n">dcbnl_pfc_up_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PFC_UP_ATTR_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpfccfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">nla_type</span> <span class="o">-</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_PFC_SCFG</span><span class="p">,</span> <span class="n">DCB_ATTR_PFC_CFG</span><span class="p">,</span>
	                  <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setall</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                        <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_SET_ALL</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setall</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setall</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="n">RTM_SETDCB</span><span class="p">,</span>
	                  <span class="n">DCB_CMD_SET_ALL</span><span class="p">,</span> <span class="n">DCB_ATTR_SET_ALL</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dcbnl_cee_notify</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_SET_ALL</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dcbnl_pg_setcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">DCB_PG_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pgid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">up_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prio</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tc_pct</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PG_CFG</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgtccfgtx</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgtccfgrx</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgbwgcfgtx</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgbwgcfgrx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">pg_tb</span><span class="p">,</span> <span class="n">DCB_PG_ATTR_MAX</span><span class="p">,</span>
	                       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_PG_CFG</span><span class="p">],</span> <span class="n">dcbnl_pg_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PG_ATTR_TC_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">param_tb</span><span class="p">,</span> <span class="n">DCB_TC_ATTR_PARAM_MAX</span><span class="p">,</span>
		                       <span class="n">pg_tb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dcbnl_tc_param_nest</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">pgid</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">prio</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">tc_pct</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">up_map</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_STRICT_PRIO</span><span class="p">])</span>
			<span class="n">prio</span> <span class="o">=</span>
			    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_STRICT_PRIO</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_PGID</span><span class="p">])</span>
			<span class="n">pgid</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_PGID</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_BW_PCT</span><span class="p">])</span>
			<span class="n">tc_pct</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_BW_PCT</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_UP_MAPPING</span><span class="p">])</span>
			<span class="n">up_map</span> <span class="o">=</span>
			     <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">param_tb</span><span class="p">[</span><span class="n">DCB_TC_ATTR_PARAM_UP_MAPPING</span><span class="p">]);</span>

		<span class="cm">/* dir: Tx = 0, Rx = 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgtccfgrx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
				<span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">,</span>
				<span class="n">prio</span><span class="p">,</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">,</span> <span class="n">up_map</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Tx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgtccfgtx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
				<span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">,</span>
				<span class="n">prio</span><span class="p">,</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">,</span> <span class="n">up_map</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PG_ATTR_BW_ID_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tc_pct</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">pg_tb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* dir: Tx = 0, Rx = 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgbwgcfgrx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Tx */</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setpgbwgcfgtx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">dir</span> <span class="o">?</span> <span class="n">DCB_CMD_PGRX_SCFG</span> <span class="o">:</span> <span class="n">DCB_CMD_PGTX_SCFG</span><span class="p">),</span>
			  <span class="n">DCB_ATTR_PG_CFG</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_pgtx_setcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__dcbnl_pg_setcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_pgrx_setcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__dcbnl_pg_setcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_bcn_getcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                            <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">bcn_nest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">bcn_tb</span><span class="p">[</span><span class="n">DCB_BCN_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">value_byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value_integer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">getall</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_BCN</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getbcnrp</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getbcncfg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">bcn_tb</span><span class="p">,</span> <span class="n">DCB_BCN_ATTR_MAX</span><span class="p">,</span>
	                       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_BCN</span><span class="p">],</span> <span class="n">dcbnl_bcn_nest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_BCN_GCFG</span><span class="p">;</span>

	<span class="n">bcn_nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_BCN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcn_nest</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcn_tb</span><span class="p">[</span><span class="n">DCB_BCN_ATTR_ALL</span><span class="p">])</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_BCN_ATTR_RP_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_BCN_ATTR_RP_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bcn_tb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getbcnrp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_BCN_ATTR_RP_0</span><span class="p">,</span>
		                            <span class="o">&amp;</span><span class="n">value_byte</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_bcn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_BCN_ATTR_BCNA_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_BCN_ATTR_RI</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bcn_tb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getbcncfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		                             <span class="o">&amp;</span><span class="n">value_integer</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value_integer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_bcn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">bcn_nest</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_bcn:</span>
	<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">bcn_nest</span><span class="p">);</span>
<span class="nl">nlmsg_failure:</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">ret</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_bcn_setcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
                            <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_BCN_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value_byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value_int</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_BCN</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setbcncfg</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setbcnrp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_BCN_ATTR_MAX</span><span class="p">,</span>
	                       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_BCN</span><span class="p">],</span>
	                       <span class="n">dcbnl_pfc_up_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_BCN_ATTR_RP_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_BCN_ATTR_RP_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">value_byte</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setbcnrp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">nla_type</span> <span class="o">-</span> <span class="n">DCB_BCN_ATTR_RP_0</span><span class="p">,</span> <span class="n">value_byte</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_BCN_ATTR_BCNA_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_BCN_ATTR_RI</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">value_int</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setbcncfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
	                                     <span class="n">i</span><span class="p">,</span> <span class="n">value_int</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_BCN_SCFG</span><span class="p">,</span> <span class="n">DCB_ATTR_BCN</span><span class="p">,</span>
	                  <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_build_peer_app</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">app_nested_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">app_info_type</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">app_entry_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcb_peer_app_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">app_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>


	<span class="cm">/**</span>
<span class="cm">	 * retrieve the peer app configuration form the driver. If the driver</span>
<span class="cm">	 * handlers fail exit without doing anything</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_getappinfo</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">app_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">app_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcb_app</span><span class="p">)</span> <span class="o">*</span> <span class="n">app_count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_getapptable</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">app</span><span class="p">;</span>

		<span class="cm">/**</span>
<span class="cm">		 * build the message, from here on the only possible failure</span>
<span class="cm">		 * is due to the skb size</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

		<span class="n">app</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">app_nested_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">app</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">app_info_type</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">app_info_type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">app_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">app_entry_type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcb_app</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">app</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle IEEE 802.1Qaz GET commands. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_ieee_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="o">*</span><span class="n">app</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dcbx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IFNAME</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">ieee</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_getets</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_ets</span> <span class="n">ets</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_getets</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ets</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_ETS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ets</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ets</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_getmaxrate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_maxrate</span> <span class="n">maxrate</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_getmaxrate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxrate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_MAXRATE</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">maxrate</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">maxrate</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_getpfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_pfc</span> <span class="n">pfc</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_getpfc</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_PFC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pfc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">app</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_APP_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">app</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_APP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">)</span>
		<span class="n">dcbx</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dcbx</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">app</span><span class="p">);</span>

	<span class="cm">/* get peer info if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_peer_getets</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_ets</span> <span class="n">ets</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_peer_getets</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ets</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_PEER_ETS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ets</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ets</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_peer_getpfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_pfc</span> <span class="n">pfc</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_peer_getpfc</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_PEER_PFC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pfc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_getappinfo</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_getapptable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_build_peer_app</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					   <span class="n">DCB_ATTR_IEEE_PEER_APP</span><span class="p">,</span>
					   <span class="n">DCB_ATTR_IEEE_APP_UNSPEC</span><span class="p">,</span>
					   <span class="n">DCB_ATTR_IEEE_APP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcbx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_DCBX</span><span class="p">,</span> <span class="n">dcbx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_cee_pg_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">up_map</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">DCB_ATTR_CEE_TX_PG</span> <span class="o">:</span> <span class="n">DCB_ATTR_CEE_RX_PG</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PG_ATTR_TC_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tc_nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc_nest</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">pgid</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">prio</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">tc_pct</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>
		<span class="n">up_map</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgrx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_map</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgtx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_map</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_TC_ATTR_PARAM_PGID</span><span class="p">,</span> <span class="n">pgid</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_TC_ATTR_PARAM_UP_MAPPING</span><span class="p">,</span> <span class="n">up_map</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_TC_ATTR_PARAM_STRICT_PRIO</span><span class="p">,</span> <span class="n">prio</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_TC_ATTR_PARAM_BW_PCT</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tc_nest</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PG_ATTR_BW_ID_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tc_pct</span> <span class="o">=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgrx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgtx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tc_pct</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tc_pct</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_cee_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">cee</span><span class="p">,</span> <span class="o">*</span><span class="n">app</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dcbx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_IFNAME</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">cee</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_CEE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cee</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="cm">/* local pg */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgtx</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgtx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_cee_pg_fill</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgtccfgrx</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpgbwgcfgrx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_cee_pg_fill</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* local pfc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpfccfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pfc_nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_CEE_PFC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfc_nest</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_PFC_UP_ATTR_7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">getpfccfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pfc_nest</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* local app */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="n">app</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_CEE_APP_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">app</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">dcb_unlock</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">app_nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
								 <span class="n">DCB_ATTR_APP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">app_nest</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">dcb_unlock</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_IDTYPE</span><span class="p">,</span>
					 <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">selector</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">dcb_unlock</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put_u16</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_ID</span><span class="p">,</span>
					  <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">dcb_unlock</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_APP_ATTR_PRIORITY</span><span class="p">,</span>
					 <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">priority</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">dcb_unlock</span><span class="p">;</span>

			<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">app_nest</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">app</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">)</span>
		<span class="n">dcbx</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dcbx</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>

	<span class="cm">/* features flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">getfeatcfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">feat</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_CEE_FEAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feat</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_FEATCFG_ATTR_ALL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_FEATCFG_ATTR_MAX</span><span class="p">;</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">getfeatcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">feat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* peer info if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cee_peer_getpg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cee_pg</span> <span class="n">pg</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">cee_peer_getpg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_CEE_PEER_PG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cee_peer_getpfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cee_pfc</span> <span class="n">pfc</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">cee_peer_getpfc</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_CEE_PEER_PFC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pfc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_getappinfo</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_getapptable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_build_peer_app</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					   <span class="n">DCB_ATTR_CEE_PEER_APP_TABLE</span><span class="p">,</span>
					   <span class="n">DCB_ATTR_CEE_PEER_APP_INFO</span><span class="p">,</span>
					   <span class="n">DCB_ATTR_CEE_PEER_APP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cee</span><span class="p">);</span>

	<span class="cm">/* DCBX state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcbx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DCB_ATTR_DCBX</span><span class="p">,</span> <span class="n">dcbx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">dcb_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dcbx_ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcbx_ver</span> <span class="o">==</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_ieee_fill</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_cee_fill</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Report error to broadcast listeners */</span>
		<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rtnl_set_sk_err</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">RTNLGRP_DCB</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* End nlmsg and notify broadcast listeners */</span>
		<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
		<span class="n">rtnl_notify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTNLGRP_DCB</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dcbnl_ieee_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dcbnl_notify</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcbnl_ieee_notify</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dcbnl_cee_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dcbnl_notify</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcbnl_cee_notify</span><span class="p">);</span>

<span class="cm">/* Handle IEEE 802.1Qaz SET commands. If any requested operation can not</span>
<span class="cm"> * be completed the entire msg is aborted and error value is returned.</span>
<span class="cm"> * No attempt is made to reconcile the case where only part of the</span>
<span class="cm"> * cmd can be completed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_ieee_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_MAX</span><span class="p">,</span>
			       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE</span><span class="p">],</span> <span class="n">dcbnl_ieee_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_ETS</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setets</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_ets</span> <span class="o">*</span><span class="n">ets</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_ETS</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setets</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">ets</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_MAXRATE</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setmaxrate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_maxrate</span> <span class="o">*</span><span class="n">maxrate</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_MAXRATE</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setmaxrate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">maxrate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_PFC</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setpfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee_pfc</span> <span class="o">*</span><span class="n">pfc</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_PFC</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setpfc</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">pfc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_APP_TABLE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rem</span><span class="p">;</span>

		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_APP_TABLE</span><span class="p">],</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">app_data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DCB_ATTR_IEEE_APP</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">app_data</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setapp</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_setapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">app_data</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">dcb_ieee_setapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">app_data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_IEEE_SET</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE</span><span class="p">,</span>
		    <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dcbnl_ieee_notify</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_IEEE_SET</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_ieee_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_IEEE_GET</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_ieee_fill</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_ieee_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE_MAX</span><span class="p">,</span>
			       <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE</span><span class="p">],</span> <span class="n">dcbnl_ieee_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_APP_TABLE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rem</span><span class="p">;</span>

		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ieee</span><span class="p">[</span><span class="n">DCB_ATTR_IEEE_APP_TABLE</span><span class="p">],</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">app_data</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nla_type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DCB_ATTR_IEEE_APP</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">app_data</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_delapp</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ieee_delapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">app_data</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">dcb_ieee_delapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">app_data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_IEEE_DEL</span><span class="p">,</span> <span class="n">DCB_ATTR_IEEE</span><span class="p">,</span>
		    <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dcbnl_ieee_notify</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_IEEE_DEL</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* DCBX configuration */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getdcbx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="n">RTM_GETDCB</span><span class="p">,</span>
			  <span class="n">DCB_CMD_GDCBX</span><span class="p">,</span> <span class="n">DCB_ATTR_DCBX</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setdcbx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setdcbx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_DCBX</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_DCBX</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setdcbx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
			  <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_SDCBX</span><span class="p">,</span> <span class="n">DCB_ATTR_DCBX</span><span class="p">,</span>
			  <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_getfeatcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dcbnl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">getall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getfeatcfg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_FEATCFG</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_FEATCFG_ATTR_MAX</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_FEATCFG</span><span class="p">],</span>
			       <span class="n">dcbnl_featcfg_nest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">dcbnl_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcbnl_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">NLMSG_NEW</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_GFEATCFG</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">DCB_ATTR_FEATCFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_ALL</span><span class="p">])</span>
		<span class="n">getall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_FEATCFG_ATTR_ALL</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_FEATCFG_ATTR_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getfeatcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
<span class="nl">nlmsg_failure:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">dcbnl_skb</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_setfeatcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">DCB_FEATCFG_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setfeatcfg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_FEATCFG</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DCB_FEATCFG_ATTR_MAX</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_FEATCFG</span><span class="p">],</span>
			       <span class="n">dcbnl_featcfg_nest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_FEATCFG_ATTR_ALL</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DCB_FEATCFG_ATTR_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">setfeatcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err:</span>
	<span class="n">dcbnl_reply</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_SFEATCFG</span><span class="p">,</span> <span class="n">DCB_ATTR_FEATCFG</span><span class="p">,</span>
		    <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle CEE DCBX GET commands. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcbnl_cee_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dcb_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DCB_CMD_CEE_GET</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dcbnl_cee_fill</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
		<span class="n">nlmsg_free</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dcb_doit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcbmsg</span>  <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dcbmsg</span> <span class="o">*</span><span class="p">)</span><span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">?</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dcb</span><span class="p">),</span> <span class="n">tb</span><span class="p">,</span> <span class="n">DCB_ATTR_MAX</span><span class="p">,</span>
			  <span class="n">dcbnl_rtnl_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_IFNAME</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">DCB_ATTR_IFNAME</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCB_CMD_GSTATE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                     <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PFC_GCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getpfccfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                      <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_GPERM_HWADDR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getperm_hwaddr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                           <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PGTX_GCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_pgtx_getcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                        <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PGRX_GCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_pgrx_getcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                        <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_BCN_GCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_bcn_getcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                       <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_SSTATE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                     <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PFC_SCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setpfccfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                      <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DCB_CMD_SET_ALL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setall</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                   <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PGTX_SCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_pgtx_setcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                        <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PGRX_SCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_pgrx_setcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                        <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_GCAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getcap</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                   <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_GNUMTCS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getnumtcs</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                      <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_SNUMTCS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setnumtcs</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                      <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PFC_GSTATE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getpfcstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                        <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_PFC_SSTATE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setpfcstate</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                        <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_BCN_SCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_bcn_setcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                       <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_GAPP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                   <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_SAPP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
		                   <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_IEEE_SET</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_ieee_set</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				     <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_IEEE_GET</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_ieee_get</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				     <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_IEEE_DEL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_ieee_del</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				     <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_GDCBX</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getdcbx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				    <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_SDCBX</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setdcbx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				    <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_GFEATCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_getfeatcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				       <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_SFEATCFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_setfeatcfg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				       <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CMD_CEE_GET</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dcbnl_cee_get</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
				    <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">errout:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dcb_getapp - retrieve the DCBX application user priority</span>
<span class="cm"> *</span>
<span class="cm"> * On success returns a non-zero 802.1p user priority bitmap</span>
<span class="cm"> * otherwise returns 0 as the invalid user priority bitmap to</span>
<span class="cm"> * indicate an error.</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">dcb_getapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prio</span> <span class="o">=</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">priority</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">prio</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcb_getapp</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dcb_setapp - add CEE dcb application data to app list</span>
<span class="cm"> *</span>
<span class="cm"> * Priority 0 is an invalid priority in CEE spec. This routine</span>
<span class="cm"> * removes applications from the app list if the priority is</span>
<span class="cm"> * set to zero.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcb_setapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">event</span><span class="p">.</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">.</span><span class="n">app</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">app</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">)</span>
		<span class="n">event</span><span class="p">.</span><span class="n">dcbx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="cm">/* Search for existing match and replace */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span>
				<span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">itr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* App type does not exist add new application type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcb_app_type</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="n">call_dcbevent_notifiers</span><span class="p">(</span><span class="n">DCB_APP_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcb_setapp</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dcb_ieee_getapp_mask - retrieve the IEEE DCB application priority</span>
<span class="cm"> *</span>
<span class="cm"> * Helper routine which on success returns a non-zero 802.1Qaz user</span>
<span class="cm"> * priority bitmap otherwise returns 0 to indicate the dcb_app was</span>
<span class="cm"> * not found in APP list.</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">dcb_ieee_getapp_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prio</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">priority</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">prio</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcb_ieee_getapp_mask</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dcb_ieee_setapp - add IEEE dcb application data to app list</span>
<span class="cm"> *</span>
<span class="cm"> * This adds Application data to the list. Multiple application</span>
<span class="cm"> * entries may exists for the same selector and protocol as long</span>
<span class="cm"> * as the priorities are different.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcb_ieee_setapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">itr</span><span class="p">,</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">event</span><span class="p">.</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">.</span><span class="n">app</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">app</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">)</span>
		<span class="n">event</span><span class="p">.</span><span class="n">dcbx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="cm">/* Search for existing match and abort if found */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">priority</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* App entry does not exist add new entry */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcb_app_type</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">call_dcbevent_notifiers</span><span class="p">(</span><span class="n">DCB_APP_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcb_ieee_setapp</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dcb_ieee_delapp - delete IEEE dcb application data from list</span>
<span class="cm"> *</span>
<span class="cm"> * This removes a matching APP data from the APP list</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcb_ieee_delapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">del</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">event</span><span class="p">.</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">.</span><span class="n">app</span><span class="p">,</span> <span class="n">del</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">app</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">)</span>
		<span class="n">event</span><span class="p">.</span><span class="n">dcbx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span><span class="o">-&gt;</span><span class="n">getdcbx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="cm">/* Search for existing match and remove it. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">priority</span> <span class="o">==</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&amp;&amp;</span>
		    <span class="n">itr</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">itr</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">call_dcbevent_notifiers</span><span class="p">(</span><span class="n">DCB_APP_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcb_ieee_delapp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dcb_flushapp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">app</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcb_app_type</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dcbnl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb_app_list</span><span class="p">);</span>

	<span class="n">rtnl_register</span><span class="p">(</span><span class="n">PF_UNSPEC</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="n">dcb_doit</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rtnl_register</span><span class="p">(</span><span class="n">PF_UNSPEC</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">,</span> <span class="n">dcb_doit</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">dcbnl_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dcbnl_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtnl_unregister</span><span class="p">(</span><span class="n">PF_UNSPEC</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">);</span>
	<span class="n">rtnl_unregister</span><span class="p">(</span><span class="n">PF_UNSPEC</span><span class="p">,</span> <span class="n">RTM_SETDCB</span><span class="p">);</span>
	<span class="n">dcb_flushapp</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dcbnl_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
