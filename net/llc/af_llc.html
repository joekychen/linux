<!DOCTYPE html>
<html><head><title>joekychen/linux » net › llc › af_llc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>af_llc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * af_llc.c - LLC User Interface SAPs</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Functions in this module are implementation of socket based llc</span>
<span class="cm"> *   communications for the Linux operating system. Support of llc class</span>
<span class="cm"> *   one and class two is provided via SOCK_DGRAM and SOCK_STREAM</span>
<span class="cm"> *   respectively.</span>
<span class="cm"> *</span>
<span class="cm"> *   An llc2 connection is (mac + sap), only one llc2 sap connection</span>
<span class="cm"> *   is allowed per mac. Though one sap may have multiple mac + sap</span>
<span class="cm"> *   connections.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 by Jay Schulist &lt;jschlst@samba.org&gt;</span>
<span class="cm"> *		 2002-2003 by Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program can be redistributed or modified under the terms of the</span>
<span class="cm"> * GNU General Public License as published by the Free Software Foundation.</span>
<span class="cm"> * This program is distributed without any warranty or implied warranty</span>
<span class="cm"> * of merchantability or fitness for a particular purpose.</span>
<span class="cm"> *</span>
<span class="cm"> * See the GNU General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/llc.h&gt;</span>
<span class="cp">#include &lt;net/llc_sap.h&gt;</span>
<span class="cp">#include &lt;net/llc_pdu.h&gt;</span>
<span class="cp">#include &lt;net/llc_conn.h&gt;</span>
<span class="cp">#include &lt;net/tcp_states.h&gt;</span>

<span class="cm">/* remember: uninitialized global data is zeroed because its in .bss */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">llc_ui_sap_last_autoport</span> <span class="o">=</span> <span class="n">LLC_SAP_DYN_START</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">llc_ui_sap_link_no_max</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="n">llc_ui_addrnull</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">llc_ui_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_ui_wait_for_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_ui_wait_for_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_ui_wait_for_busy_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define dprintk(args...) printk(KERN_DEBUG args)</span>
<span class="cp">#else</span>
<span class="cp">#define dprintk(args...)</span>
<span class="cp">#endif</span>

<span class="cm">/* Maybe we&#39;ll add some more in the future. */</span>
<span class="cp">#define LLC_CMSG_PKTINFO	1</span>


<span class="cm">/**</span>
<span class="cm"> *	llc_ui_next_link_no - return the next unused link number for a sap</span>
<span class="cm"> *	@sap: Address of sap to get link number from.</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the next unused link number for a given sap.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">llc_ui_next_link_no</span><span class="p">(</span><span class="kt">int</span> <span class="n">sap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">llc_ui_sap_link_no_max</span><span class="p">[</span><span class="n">sap</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_proto_type - return eth protocol for ARP header type</span>
<span class="cm"> *	@arphrd: ARP header type.</span>
<span class="cm"> *</span>
<span class="cm"> *	Given an ARP header type return the corresponding ethernet protocol.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be16</span> <span class="nf">llc_proto_type</span><span class="p">(</span><span class="n">u16</span> <span class="n">arphrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_addr_null - determines if a address structure is null</span>
<span class="cm"> *	@addr: Address to test if null.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">llc_ui_addr_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc_ui_addrnull</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_header_len - return length of llc header based on operation</span>
<span class="cm"> *	@sk: Socket which contains a valid llc socket type.</span>
<span class="cm"> *	@addr: Complete sockaddr_llc structure received from the user.</span>
<span class="cm"> *</span>
<span class="cm"> *	Provide the length of the llc header depending on what kind of</span>
<span class="cm"> *	operation the user would like to perform and the type of socket.</span>
<span class="cm"> *	Returns the correct llc header length.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">llc_ui_header_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">LLC_PDU_LEN_U</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_test</span> <span class="o">||</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_xid</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LLC_PDU_LEN_U</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LLC_PDU_LEN_I</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_send_data - send data via reliable llc2 connection</span>
<span class="cm"> *	@sk: Connection the socket is using.</span>
<span class="cm"> *	@skb: Data the user wishes to send.</span>
<span class="cm"> *	@noblock: can we block waiting for data?</span>
<span class="cm"> *</span>
<span class="cm"> *	Send data via reliable llc2 connection.</span>
<span class="cm"> *	Returns 0 upon success, non-zero if action did not succeed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_send_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span><span class="o">*</span> <span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span><span class="o">*</span> <span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">llc_data_accept_state</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span> <span class="o">||</span>
		     <span class="n">llc</span><span class="o">-&gt;</span><span class="n">p_flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">noblock</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_ui_wait_for_busy_core</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_build_and_send_pkt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_ui_sk_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sock_graft</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span>	<span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_ui_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">llc_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="s">&quot;LLC&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_sock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">slab_flags</span> <span class="o">=</span> <span class="n">SLAB_DESTROY_BY_RCU</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_create - alloc and init a new llc_ui socket</span>
<span class="cm"> *	@net: network namespace (must be default network)</span>
<span class="cm"> *	@sock: Socket to initialize and attach allocated sk to.</span>
<span class="cm"> *	@protocol: Unused.</span>
<span class="cm"> *	@kern: on behalf of kernel or userspace</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocate and initialize a new llc_ui socket, validate the user wants a</span>
<span class="cm"> *	socket type we have available.</span>
<span class="cm"> *	Returns 0 upon success, negative upon failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_RAW</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_DGRAM</span> <span class="o">||</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">llc_sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_LLC</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc_proto</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">llc_ui_sk_init</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_release - shutdown socket</span>
<span class="cm"> *	@sock: Socket to release.</span>
<span class="cm"> *</span>
<span class="cm"> *	Shutdown and deallocate an existing socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: closing local(%02X) remote(%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
		<span class="n">llc_ui_wait_for_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span>
		<span class="n">llc_sap_remove_socket</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">llc_sk_free</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_autoport - provide dynamically allocate SAP number</span>
<span class="cm"> *</span>
<span class="cm"> *	Provide the caller with a dynamically allocated SAP number according</span>
<span class="cm"> *	to the rules that are set in this function. Returns: 0, upon failure,</span>
<span class="cm"> *	SAP number otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_autoport</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&lt;</span> <span class="n">LLC_SAP_DYN_TRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">llc_ui_sap_last_autoport</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LLC_SAP_DYN_STOP</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sap</span> <span class="o">=</span> <span class="n">llc_sap_find</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">llc_ui_sap_last_autoport</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">llc_sap_put</span><span class="p">(</span><span class="n">sap</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">llc_ui_sap_last_autoport</span> <span class="o">=</span> <span class="n">LLC_SAP_DYN_START</span><span class="p">;</span>
		<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_autobind - automatically bind a socket to a sap</span>
<span class="cm"> *	@sock: socket to bind</span>
<span class="cm"> *	@addr: address to connect to</span>
<span class="cm"> *</span>
<span class="cm"> * 	Used by llc_ui_connect and llc_ui_sendmsg when the user hasn&#39;t</span>
<span class="cm"> * 	specifically used llc_ui_bind to bind to an specific address/sap</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns: 0 upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_autobind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_arphrd</span> <span class="o">!=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_getfirstbyhwtype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_arphrd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EUSERS</span><span class="p">;</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span> <span class="o">=</span> <span class="n">llc_ui_autoport</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* some other network layer is using the sap */</span>
	<span class="n">sap</span> <span class="o">=</span> <span class="n">llc_sap_open</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">IFHWADDRLEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>
	<span class="cm">/* assign new connection to its SAP */</span>
	<span class="n">llc_sap_add_socket</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_bind - bind a socket to a specific address.</span>
<span class="cm"> *	@sock: Socket to bind an address to.</span>
<span class="cm"> *	@uaddr: Address the user wants the socket bound to.</span>
<span class="cm"> *	@addrlen: Length of the uaddr structure.</span>
<span class="cm"> *</span>
<span class="cm"> *	Bind a socket to a specific address. For llc a user is able to bind to</span>
<span class="cm"> *	a specific sap only or mac + sap.</span>
<span class="cm"> *	If the user desires to bind to a specific mac + sap, it is possible to</span>
<span class="cm"> *	have multiple sap connections via multiple macs.</span>
<span class="cm"> *	Bind and autobind for that matter must enforce the correct sap usage</span>
<span class="cm"> *	otherwise all hell will break loose.</span>
<span class="cm"> *	Returns: 0 upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: binding %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">)</span> <span class="o">||</span> <span class="n">addrlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_family</span> <span class="o">!=</span> <span class="n">AF_LLC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_arphrd</span><span class="p">)</span>
				<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_arphrd</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">llc_mac_null</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">))</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				       <span class="n">IFHWADDRLEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_arphrd</span> <span class="o">!=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">llc_mac_match</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span>
					   <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_getbyhwaddr_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_arphrd</span><span class="p">,</span>
					   <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">dev_hold</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EUSERS</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span> <span class="o">=</span> <span class="n">llc_ui_autoport</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sap</span> <span class="o">=</span> <span class="n">llc_sap_find</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sap</span> <span class="o">=</span> <span class="n">llc_sap_open</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* some other network layer is using the sap */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sap</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_addr</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">ask</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">laddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">laddr</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">daddr</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: check if the address is multicast,</span>
<span class="cm">		 * 	  only SOCK_DGRAM can do this.</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">laddr</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span> <span class="n">IFHWADDRLEN</span><span class="p">);</span>
		<span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span> <span class="cm">/* mac + sap clash. */</span>
		<span class="n">ask</span> <span class="o">=</span> <span class="n">llc_lookup_established</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">laddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock_put</span><span class="p">(</span><span class="n">ask</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span> <span class="n">IFHWADDRLEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>
	<span class="cm">/* assign new connection to its SAP */</span>
	<span class="n">llc_sap_add_socket</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_put:</span>
	<span class="n">llc_sap_put</span><span class="p">(</span><span class="n">sap</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_shutdown - shutdown a connect llc2 socket.</span>
<span class="cm"> *	@sock: Socket to shutdown.</span>
<span class="cm"> *	@how: What part of the socket to shutdown.</span>
<span class="cm"> *</span>
<span class="cm"> *	Shutdown a connected llc2 socket. Currently this function only supports</span>
<span class="cm"> *	shutting down both sends and receives (2), we could probably make this</span>
<span class="cm"> *	function such that a user can shutdown only half the connection but not</span>
<span class="cm"> *	right now.</span>
<span class="cm"> *	Returns: 0 upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">how</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">how</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_ui_wait_for_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span><span class="p">);</span>
	<span class="cm">/* Wake up anyone sleeping in poll */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_connect - Connect to a remote llc2 mac + sap.</span>
<span class="cm"> *	@sock: Socket which will be connected to the remote destination.</span>
<span class="cm"> *	@uaddr: Remote and possibly the local address of the new connection.</span>
<span class="cm"> *	@addrlen: Size of uaddr structure.</span>
<span class="cm"> *	@flags: Operational flags specified by the user.</span>
<span class="cm"> *</span>
<span class="cm"> *	Connect to a remote llc2 mac + sap. The caller must specify the</span>
<span class="cm"> *	destination mac and address to connect to. If the user hasn&#39;t previously</span>
<span class="cm"> *	called bind(2) with a smac the address of the first interface of the</span>
<span class="cm"> *	specified arp type will be used.</span>
<span class="cm"> *	This function will autobind if user did not previously call bind.</span>
<span class="cm"> *	Returns: 0 upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">addrlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_family</span> <span class="o">!=</span> <span class="n">AF_LLC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTING</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* bind connection to sap if user hasn&#39;t done it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* bind to sap with null dev, exclusive */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_ui_autobind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span> <span class="n">IFHWADDRLEN</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTING</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>   <span class="o">=</span> <span class="n">TCP_SYN_SENT</span><span class="p">;</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">link</span>   <span class="o">=</span> <span class="n">llc_ui_next_link_no</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_establish_connection</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				      <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: llc_ui_send_conn failed :-(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span>  <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_CLOSE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_SYN_SENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span> <span class="o">||</span> <span class="o">!</span><span class="n">llc_ui_wait_for_conn</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeo</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sock_error</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">sock_error:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_listen - allow a normal socket to accept incoming connections</span>
<span class="cm"> *	@sock: Socket to allow incoming connections on.</span>
<span class="cm"> *	@backlog: Number of connections to queue.</span>
<span class="cm"> *</span>
<span class="cm"> *	Allow a normal socket to accept incoming connections.</span>
<span class="cm"> *	Returns 0 upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SS_UNCONNECTED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">backlog</span><span class="p">)</span>	<span class="cm">/* BSDism */</span>
		<span class="n">backlog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>	   <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">__SO_ACCEPTCON</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_wait_for_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk_wait_event</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_wait_for_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk_wait_event</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_SYN_SENT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_wait_for_busy_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk_wait_event</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span> <span class="o">||</span>
				  <span class="p">(</span><span class="o">!</span><span class="n">llc_data_accept_state</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span> <span class="o">&amp;&amp;</span>
				   <span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">p_flag</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_wait_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * POSIX 1003.1g mandates this order.</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk_wait_data</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_cmsg_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">cmsg_flags</span> <span class="o">&amp;</span> <span class="n">LLC_CMSG_PKTINFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_pktinfo</span> <span class="n">info</span><span class="p">;</span>

		<span class="n">info</span><span class="p">.</span><span class="n">lpi_ifindex</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
		<span class="n">llc_pdu_decode_dsap</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">lpi_sap</span><span class="p">);</span>
		<span class="n">llc_pdu_decode_da</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">lpi_mac</span><span class="p">);</span>
		<span class="n">put_cmsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SOL_LLC</span><span class="p">,</span> <span class="n">LLC_OPT_PKTINFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_accept - accept a new incoming connection.</span>
<span class="cm"> *	@sock: Socket which connections arrive on.</span>
<span class="cm"> *	@newsock: Socket to move incoming connection to.</span>
<span class="cm"> *	@flags: User specified operational flags.</span>
<span class="cm"> *</span>
<span class="cm"> *	Accept a new incoming connection.</span>
<span class="cm"> *	Returns 0 upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">newsock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="o">*</span><span class="n">newsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span><span class="p">,</span> <span class="o">*</span><span class="n">newllc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: accepting on %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SS_UNCONNECTED</span> <span class="o">||</span>
		     <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* wait for a connection to arrive. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_wait_data</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: got a new connection on %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">frees</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newsk</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="cm">/* attach connection to a new socket. */</span>
	<span class="n">llc_ui_sk_init</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="n">newsk</span><span class="p">);</span>
	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
	<span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_state</span>		<span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
	<span class="n">newsock</span><span class="o">-&gt;</span><span class="n">state</span>		<span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
	<span class="n">llc</span>			<span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">newllc</span>			<span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newllc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">newllc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">newllc</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">llc_ui_next_link_no</span><span class="p">(</span><span class="n">newllc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">);</span>

	<span class="cm">/* put original socket back into a clean listen state. */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: ok success on %02X, client on %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sllc_sap</span><span class="p">,</span> <span class="n">newllc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">);</span>
<span class="nl">frees:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_recvmsg - copy received data to the socket user.</span>
<span class="cm"> *	@sock: Socket to copy data from.</span>
<span class="cm"> *	@msg: Various user space related information.</span>
<span class="cm"> *	@len: Size of user buffer.</span>
<span class="cm"> *	@flags: User specified flags.</span>
<span class="cm"> *</span>
<span class="cm"> *	Copy received data to the socket user.</span>
<span class="cm"> *	Returns non-negative upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="n">uaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">nonblock</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu_flags</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">peek_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">seq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span><span class="p">;</span>	<span class="cm">/* Read at least this many bytes */</span>
	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">copied</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_rcvtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">);</span>

	<span class="n">seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">copied_seq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peek_seq</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">copied_seq</span><span class="p">;</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peek_seq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">sock_rcvlowat</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_WAITALL</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need to check signals first, to get correct SIGURG</span>
<span class="cm">		 * handling. FIXME: Need to check this doesn&#39;t impact 1003.1g</span>
<span class="cm">		 * and move it down to the bottom of the loop</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">copied</span> <span class="o">=</span> <span class="n">timeo</span> <span class="o">?</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Next get a buffer. */</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">seq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found_ok_skb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Well, if we have backlog, try to process it now yet. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;=</span> <span class="n">target</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_backlog</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">||</span>
			    <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">timeo</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DONE</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">copied</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DONE</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * This occurs when user tries to read</span>
<span class="cm">					 * from never connected socket.</span>
<span class="cm">					 */</span>
					<span class="n">copied</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">copied</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Do not sleep, just process backlog. */</span>
			<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sk_wait_data</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">peek_seq</span> <span class="o">!=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">copied_seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;LLC(%s:%d): Application bug, race in MSG_PEEK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span>
					    <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
			<span class="n">peek_seq</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">copied_seq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="nl">found_ok_skb:</span>
		<span class="cm">/* Ok so how much can we use? */</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">used</span><span class="p">)</span>
			<span class="n">used</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_TRUNC</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							 <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">used</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Exception. Bailout! */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copied</span><span class="p">)</span>
					<span class="n">copied</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">seq</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">used</span><span class="p">;</span>

		<span class="cm">/* For non stream protcols we get one packet per recvmsg call */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">copy_uaddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cpu_flags</span><span class="p">);</span>
			<span class="n">sk_eat_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cpu_flags</span><span class="p">);</span>
			<span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Partial read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="nl">copy_uaddr:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uaddr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="n">llc_ui_skb_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uaddr</span><span class="p">));</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmsg_flags</span><span class="p">)</span>
		<span class="n">llc_cmsg_rcv</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cpu_flags</span><span class="p">);</span>
			<span class="n">sk_eat_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cpu_flags</span><span class="p">);</span>
			<span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_sendmsg - Transmit data provided by the socket user.</span>
<span class="cm"> *	@sock: Socket to transmit data from.</span>
<span class="cm"> *	@msg: Various user related information.</span>
<span class="cm"> *	@len: Length of data to transmit.</span>
<span class="cm"> *</span>
<span class="cm"> *	Transmit data provided by the socket user.</span>
<span class="cm"> *	Returns non-negative upon success, negative otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">noblock</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: sending from %02X to %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">llc_ui_addr_null</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* must bind connection to sap if user hasn&#39;t done it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* bind to sap with null dev, exclusive. */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_ui_autobind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+</span> <span class="n">llc_ui_header_len</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
	<span class="n">copied</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">noblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span>      <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">llc_proto_type</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_arphrd</span><span class="p">);</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">copied</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_DGRAM</span> <span class="o">||</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_ua</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc_build_and_send_ui_pkt</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span>
					  <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc_build_and_send_test_pkt</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span>
					    <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_xid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc_build_and_send_xid_pkt</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_mac</span><span class="p">,</span>
					   <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_sap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sllc_ua</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_ui_send_data</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">noblock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">release:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: failed sending from %02X to %02X: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="o">:</span> <span class="n">copied</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_getname - return the address info of a socket</span>
<span class="cm"> *	@sock: Socket to get address of.</span>
<span class="cm"> *	@uaddr: Address structure to return information.</span>
<span class="cm"> *	@uaddrlen: Length of address structure.</span>
<span class="cm"> *	@peer: Does user want local or remote address information.</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the address information of a socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_getname</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">uaddrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_llc</span> <span class="n">sllc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sllc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sllc</span><span class="p">));</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="o">*</span><span class="n">uaddrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sllc</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">uaddrlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">sllc</span><span class="p">.</span><span class="n">sllc_arphrd</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">sllc</span><span class="p">.</span><span class="n">sllc_sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sllc</span><span class="p">.</span><span class="n">sllc_mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">IFHWADDRLEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">sllc</span><span class="p">.</span><span class="n">sllc_sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sllc</span><span class="p">.</span><span class="n">sllc_arphrd</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sllc</span><span class="p">.</span><span class="n">sllc_mac</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
			       <span class="n">IFHWADDRLEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sllc</span><span class="p">.</span><span class="n">sllc_family</span> <span class="o">=</span> <span class="n">AF_LLC</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sllc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sllc</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_ioctl - io controls for PF_LLC</span>
<span class="cm"> *	@sock: Socket to get/set info</span>
<span class="cm"> *	@cmd: command</span>
<span class="cm"> *	@arg: optional argument for cmd</span>
<span class="cm"> *</span>
<span class="cm"> *	get/set info on llc sockets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_setsockopt - set various connection specific parameters.</span>
<span class="cm"> *	@sock: Socket to set options on.</span>
<span class="cm"> *	@level: Socket level user is requesting operations on.</span>
<span class="cm"> *	@optname: Operation name.</span>
<span class="cm"> *	@optval User provided operation data.</span>
<span class="cm"> *	@optlen: Length of optval.</span>
<span class="cm"> *</span>
<span class="cm"> *	Set various connection specific parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_LLC</span> <span class="o">||</span> <span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LLC_OPT_RETRY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_RETRY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">n2</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_SIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">n1</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_ACK_TMR_EXP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_ACK_TMR_EXP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">=</span> <span class="n">opt</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_P_TMR_EXP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_P_TMR_EXP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">pf_cycle_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">=</span> <span class="n">opt</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_REJ_TMR_EXP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_REJ_TMR_EXP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">=</span> <span class="n">opt</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_BUSY_TMR_EXP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_BUSY_TMR_EXP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">busy_state_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">=</span> <span class="n">opt</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_TX_WIN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_WIN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_RX_WIN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&gt;</span> <span class="n">LLC_OPT_MAX_WIN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_PKTINFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span>
			<span class="n">llc</span><span class="o">-&gt;</span><span class="n">cmsg_flags</span> <span class="o">|=</span> <span class="n">LLC_CMSG_PKTINFO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">llc</span><span class="o">-&gt;</span><span class="n">cmsg_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LLC_CMSG_PKTINFO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_ui_getsockopt - get connection specific socket info</span>
<span class="cm"> *	@sock: Socket to get information from.</span>
<span class="cm"> *	@level: Socket level user is requesting operations on.</span>
<span class="cm"> *	@optname: Operation name.</span>
<span class="cm"> *	@optval: Variable to return operation data in.</span>
<span class="cm"> *	@optlen: Length of optval.</span>
<span class="cm"> *</span>
<span class="cm"> *	Get connection specific socket information.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_ui_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_LLC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LLC_OPT_RETRY</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">n2</span><span class="p">;</span>					<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_SIZE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">n1</span><span class="p">;</span>					<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_ACK_TMR_EXP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_P_TMR_EXP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">pf_cycle_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_REJ_TMR_EXP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_BUSY_TMR_EXP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">busy_state_timer</span><span class="p">.</span><span class="n">expire</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_TX_WIN</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">;</span>				<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_RX_WIN</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">;</span>				<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_OPT_PKTINFO</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">cmsg_flags</span> <span class="o">&amp;</span> <span class="n">LLC_CMSG_PKTINFO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">llc_ui_family_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">PF_LLC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">llc_ui_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">llc_ui_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>	     <span class="o">=</span> <span class="n">PF_LLC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>       <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>     <span class="o">=</span> <span class="n">llc_ui_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span>	     <span class="o">=</span> <span class="n">llc_ui_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>     <span class="o">=</span> <span class="n">llc_ui_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span>  <span class="o">=</span> <span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span>      <span class="o">=</span> <span class="n">llc_ui_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span>     <span class="o">=</span> <span class="n">llc_ui_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>	     <span class="o">=</span> <span class="n">datagram_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>       <span class="o">=</span> <span class="n">llc_ui_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listen</span>      <span class="o">=</span> <span class="n">llc_ui_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>    <span class="o">=</span> <span class="n">llc_ui_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>  <span class="o">=</span> <span class="n">llc_ui_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>  <span class="o">=</span> <span class="n">llc_ui_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span>     <span class="o">=</span> <span class="n">llc_ui_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span>     <span class="o">=</span> <span class="n">llc_ui_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>	     <span class="o">=</span> <span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span>    <span class="o">=</span> <span class="n">sock_no_sendpage</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">llc_proc_err_msg</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="n">KERN_CRIT</span> <span class="s">&quot;LLC: Unable to register the proc_fs entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">llc_sysctl_err_msg</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="n">KERN_CRIT</span> <span class="s">&quot;LLC: Unable to register the sysctl entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">llc_sock_err_msg</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="n">KERN_CRIT</span> <span class="s">&quot;LLC: Unable to register the network family</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">llc2_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">llc_build_offset_table</span><span class="p">();</span>
	<span class="n">llc_station_init</span><span class="p">();</span>
	<span class="n">llc_ui_sap_last_autoport</span> <span class="o">=</span> <span class="n">LLC_SAP_DYN_START</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_proc_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">llc_proc_err_msg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unregister_llc_proto</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_sysctl_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">llc_sysctl_err_msg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_proc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_ui_family_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">llc_sock_err_msg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_sysctl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">llc_add_pack</span><span class="p">(</span><span class="n">LLC_DEST_SAP</span><span class="p">,</span> <span class="n">llc_sap_handler</span><span class="p">);</span>
	<span class="n">llc_add_pack</span><span class="p">(</span><span class="n">LLC_DEST_CONN</span><span class="p">,</span> <span class="n">llc_conn_handler</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">out_sysctl:</span>
	<span class="n">llc_sysctl_exit</span><span class="p">();</span>
<span class="nl">out_proc:</span>
	<span class="n">llc_proc_exit</span><span class="p">();</span>
<span class="nl">out_unregister_llc_proto:</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_proto</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">llc2_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_station_exit</span><span class="p">();</span>
	<span class="n">llc_remove_pack</span><span class="p">(</span><span class="n">LLC_DEST_SAP</span><span class="p">);</span>
	<span class="n">llc_remove_pack</span><span class="p">(</span><span class="n">LLC_DEST_CONN</span><span class="p">);</span>
	<span class="n">sock_unregister</span><span class="p">(</span><span class="n">PF_LLC</span><span class="p">);</span>
	<span class="n">llc_proc_exit</span><span class="p">();</span>
	<span class="n">llc_sysctl_exit</span><span class="p">();</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">llc2_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">llc2_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Procom 1997, Jay Schullist 2001, Arnaldo C. Melo 2001-2003&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IEEE 802.2 PF_LLC support&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NETPROTO</span><span class="p">(</span><span class="n">PF_LLC</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
