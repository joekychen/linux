<!DOCTYPE html>
<html><head><title>joekychen/linux » net › llc › llc_station.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>llc_station.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * llc_station.c - station component of LLC</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1997 by Procom Technology, Inc.</span>
<span class="cm"> * 		 2001-2003 by Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program can be redistributed or modified under the terms of the</span>
<span class="cm"> * GNU General Public License as published by the Free Software Foundation.</span>
<span class="cm"> * This program is distributed without any warranty or implied warranty</span>
<span class="cm"> * of merchantability or fitness for a particular purpose.</span>
<span class="cm"> *</span>
<span class="cm"> * See the GNU General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/llc.h&gt;</span>
<span class="cp">#include &lt;net/llc_sap.h&gt;</span>
<span class="cp">#include &lt;net/llc_conn.h&gt;</span>
<span class="cp">#include &lt;net/llc_c_ac.h&gt;</span>
<span class="cp">#include &lt;net/llc_s_ac.h&gt;</span>
<span class="cp">#include &lt;net/llc_c_ev.h&gt;</span>
<span class="cp">#include &lt;net/llc_c_st.h&gt;</span>
<span class="cp">#include &lt;net/llc_s_ev.h&gt;</span>
<span class="cp">#include &lt;net/llc_s_st.h&gt;</span>
<span class="cp">#include &lt;net/llc_pdu.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> * struct llc_station - LLC station component</span>
<span class="cm"> *</span>
<span class="cm"> * SAP and connection resource manager, one per adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * @state - state of station</span>
<span class="cm"> * @xid_r_count - XID response PDU counter</span>
<span class="cm"> * @mac_sa - MAC source address</span>
<span class="cm"> * @sap_list - list of related SAPs</span>
<span class="cm"> * @ev_q - events entering state mach.</span>
<span class="cm"> * @mac_pdu_q - PDUs ready to send to MAC</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">llc_station</span> <span class="p">{</span>
	<span class="n">u8</span>			    <span class="n">state</span><span class="p">;</span>
	<span class="n">u8</span>			    <span class="n">xid_r_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	    <span class="n">ack_timer</span><span class="p">;</span>
	<span class="n">u8</span>			    <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span>			    <span class="n">maximum_retry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">list</span><span class="p">;</span>
		<span class="n">spinlock_t</span>	    <span class="n">lock</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ev_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span>	    <span class="n">mac_pdu_q</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define LLC_STATION_ACK_TIME (3 * HZ)</span>

<span class="kt">int</span> <span class="n">sysctl_llc_station_ack_timeout</span> <span class="o">=</span> <span class="n">LLC_STATION_ACK_TIME</span><span class="p">;</span>

<span class="cm">/* Types of events (possible values in &#39;ev-&gt;type&#39;) */</span>
<span class="cp">#define LLC_STATION_EV_TYPE_SIMPLE	1</span>
<span class="cp">#define LLC_STATION_EV_TYPE_CONDITION	2</span>
<span class="cp">#define LLC_STATION_EV_TYPE_PRIM	3</span>
<span class="cp">#define LLC_STATION_EV_TYPE_PDU		4       </span><span class="cm">/* command/response PDU */</span><span class="cp"></span>
<span class="cp">#define LLC_STATION_EV_TYPE_ACK_TMR	5</span>
<span class="cp">#define LLC_STATION_EV_TYPE_RPT_STATUS	6</span>

<span class="cm">/* Events */</span>
<span class="cp">#define LLC_STATION_EV_ENABLE_WITH_DUP_ADDR_CHECK		1</span>
<span class="cp">#define LLC_STATION_EV_ENABLE_WITHOUT_DUP_ADDR_CHECK		2</span>
<span class="cp">#define LLC_STATION_EV_ACK_TMR_EXP_LT_RETRY_CNT_MAX_RETRY	3</span>
<span class="cp">#define LLC_STATION_EV_ACK_TMR_EXP_EQ_RETRY_CNT_MAX_RETRY	4</span>
<span class="cp">#define LLC_STATION_EV_RX_NULL_DSAP_XID_C			5</span>
<span class="cp">#define LLC_STATION_EV_RX_NULL_DSAP_0_XID_R_XID_R_CNT_EQ	6</span>
<span class="cp">#define LLC_STATION_EV_RX_NULL_DSAP_1_XID_R_XID_R_CNT_EQ	7</span>
<span class="cp">#define LLC_STATION_EV_RX_NULL_DSAP_TEST_C			8</span>
<span class="cp">#define LLC_STATION_EV_DISABLE_REQ				9</span>

<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="p">{</span>
	<span class="n">u8</span>		 <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">prim</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">prim_type</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">reason</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span> <span class="cm">/* node in station-&gt;ev_q.list */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span>
					<span class="nf">llc_station_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">llc_station_ev_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="cp">#define LLC_STATION_STATE_DOWN		1	</span><span class="cm">/* initial state */</span><span class="cp"></span>
<span class="cp">#define LLC_STATION_STATE_DUP_ADDR_CHK	2</span>
<span class="cp">#define LLC_STATION_STATE_UP		3</span>

<span class="cp">#define LLC_NBR_STATION_STATES		3	</span><span class="cm">/* size of state table */</span><span class="cp"></span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">llc_station_action_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="cm">/* Station component state table structure */</span>
<span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="p">{</span>
	<span class="n">llc_station_ev_t</span> <span class="n">ev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">next_state</span><span class="p">;</span>
	<span class="n">llc_station_action_t</span> <span class="o">*</span><span class="n">ev_actions</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">llc_station_state</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">curr_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">**</span><span class="n">transitions</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station</span> <span class="n">llc_main_station</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_enable_with_dup_addr_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_SIMPLE</span> <span class="o">&amp;&amp;</span>
	       <span class="n">ev</span><span class="o">-&gt;</span><span class="n">prim_type</span> <span class="o">==</span>
			      <span class="n">LLC_STATION_EV_ENABLE_WITH_DUP_ADDR_CHECK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_enable_without_dup_addr_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_SIMPLE</span> <span class="o">&amp;&amp;</span>
	       <span class="n">ev</span><span class="o">-&gt;</span><span class="n">prim_type</span> <span class="o">==</span>
			<span class="n">LLC_STATION_EV_ENABLE_WITHOUT_DUP_ADDR_CHECK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_ack_tmr_exp_lt_retry_cnt_max_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_ACK_TMR</span> <span class="o">&amp;&amp;</span>
		<span class="n">llc_main_station</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">&lt;</span>
		<span class="n">llc_main_station</span><span class="p">.</span><span class="n">maximum_retry</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_ack_tmr_exp_eq_retry_cnt_max_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_ACK_TMR</span> <span class="o">&amp;&amp;</span>
		<span class="n">llc_main_station</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">==</span>
		<span class="n">llc_main_station</span><span class="p">.</span><span class="n">maximum_retry</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_rx_null_dsap_xid_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_pdu_un</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_un_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_PDU</span> <span class="o">&amp;&amp;</span>
	       <span class="n">LLC_PDU_IS_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>			<span class="cm">/* command PDU */</span>
	       <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>		<span class="cm">/* U type PDU */</span>
	       <span class="n">LLC_U_PDU_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_1_PDU_CMD_XID</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* NULL DSAP value */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_rx_null_dsap_0_xid_r_xid_r_cnt_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_pdu_un</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_un_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_PDU</span> <span class="o">&amp;&amp;</span>
	       <span class="n">LLC_PDU_IS_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>			<span class="cm">/* response PDU */</span>
	       <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>		<span class="cm">/* U type PDU */</span>
	       <span class="n">LLC_U_PDU_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_1_PDU_CMD_XID</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">&amp;&amp;</span>				<span class="cm">/* NULL DSAP value */</span>
	       <span class="o">!</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">xid_r_count</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_rx_null_dsap_1_xid_r_xid_r_cnt_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_pdu_un</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_un_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_PDU</span> <span class="o">&amp;&amp;</span>
	       <span class="n">LLC_PDU_IS_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>			<span class="cm">/* response PDU */</span>
	       <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>		<span class="cm">/* U type PDU */</span>
	       <span class="n">LLC_U_PDU_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_1_PDU_CMD_XID</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">&amp;&amp;</span>				<span class="cm">/* NULL DSAP value */</span>
	       <span class="n">llc_main_station</span><span class="p">.</span><span class="n">xid_r_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_rx_null_dsap_test_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_pdu_un</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_un_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_PDU</span> <span class="o">&amp;&amp;</span>
	       <span class="n">LLC_PDU_IS_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>			<span class="cm">/* command PDU */</span>
	       <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>		<span class="cm">/* U type PDU */</span>
	       <span class="n">LLC_U_PDU_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_1_PDU_CMD_TEST</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* NULL DSAP */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_stat_ev_disable_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_PRIM</span> <span class="o">&amp;&amp;</span>
	       <span class="n">ev</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">==</span> <span class="n">LLC_DISABLE_PRIM</span> <span class="o">&amp;&amp;</span>
	       <span class="n">ev</span><span class="o">-&gt;</span><span class="n">prim_type</span> <span class="o">==</span> <span class="n">LLC_PRIM_TYPE_REQ</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_station_send_pdu - queues PDU to send</span>
<span class="cm"> *	@skb: Address of the PDU</span>
<span class="cm"> *</span>
<span class="cm"> *	Queues a PDU to send to the MAC layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_station_send_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">mac_pdu_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">mac_pdu_q</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_start_ack_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ack_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">sysctl_llc_station_ack_timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_set_retry_cnt_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_main_station</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_inc_retry_cnt_by_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_main_station</span><span class="p">.</span><span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_set_xid_r_cnt_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_main_station</span><span class="p">.</span><span class="n">xid_r_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_inc_xid_r_cnt_by_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_main_station</span><span class="p">.</span><span class="n">xid_r_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_send_null_dsap_xid_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_xid_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
	<span class="n">llc_pdu_init_as_xid_cmd</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_XID_NULL_CLASS_2</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="n">llc_station_send_pdu</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_send_xid_r</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac_da</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">],</span> <span class="n">dsap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_xid_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">llc_pdu_decode_sa</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mac_da</span><span class="p">);</span>
	<span class="n">llc_pdu_decode_ssap</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsap</span><span class="p">);</span>
	<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
	<span class="n">llc_pdu_init_as_xid_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_XID_NULL_CLASS_2</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac_da</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="n">llc_station_send_pdu</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_send_test_r</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac_da</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">],</span> <span class="n">dsap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>

	<span class="cm">/* The test request command is type U (llc_len = 3) */</span>
	<span class="n">data_size</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">llc_pdu_decode_sa</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mac_da</span><span class="p">);</span>
	<span class="n">llc_pdu_decode_ssap</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsap</span><span class="p">);</span>
	<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
	<span class="n">llc_pdu_init_as_test_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac_da</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="n">llc_station_send_pdu</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_station_ac_report_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* COMMON STATION STATE transitions */</span>

<span class="cm">/* dummy last-transition indicator; common to all state transition groups</span>
<span class="cm"> * last entry for this state</span>
<span class="cm"> * all members are zeros, .bss zeroes it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_state_trans_end</span><span class="p">;</span>

<span class="cm">/* DOWN STATE transitions */</span>

<span class="cm">/* state transition for LLC_STATION_EV_ENABLE_WITH_DUP_ADDR_CHECK event */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_down_state_actions_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_start_ack_timer</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_set_retry_cnt_0</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_set_xid_r_cnt_0</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_send_null_dsap_xid_c</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_down_state_trans_1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_enable_with_dup_addr_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_DUP_ADDR_CHK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_down_state_actions_1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_ENABLE_WITHOUT_DUP_ADDR_CHECK event */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_down_state_actions_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_report_status</span><span class="p">,</span>	<span class="cm">/* STATION UP */</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_down_state_trans_2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_enable_without_dup_addr_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_UP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_down_state_actions_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* array of pointers; one to each transition */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">*</span><span class="n">llc_stat_dwn_state_trans</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_down_state_trans_1</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_down_state_trans_2</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_state_trans_end</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* UP STATE transitions */</span>
<span class="cm">/* state transition for LLC_STATION_EV_DISABLE_REQ event */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_up_state_actions_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_report_status</span><span class="p">,</span>	<span class="cm">/* STATION DOWN */</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_up_state_trans_1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_disable_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_DOWN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_up_state_actions_1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_RX_NULL_DSAP_XID_C event */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_up_state_actions_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_send_xid_r</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_up_state_trans_2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_rx_null_dsap_xid_c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_UP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_up_state_actions_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_RX_NULL_DSAP_TEST_C event */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_up_state_actions_3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_send_test_r</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_up_state_trans_3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_rx_null_dsap_test_c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_UP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_up_state_actions_3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* array of pointers; one to each transition */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">*</span><span class="n">llc_stat_up_state_trans</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_up_state_trans_1</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_up_state_trans_2</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_up_state_trans_3</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_state_trans_end</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* DUP ADDR CHK STATE transitions */</span>
<span class="cm">/* state transition for LLC_STATION_EV_RX_NULL_DSAP_0_XID_R_XID_R_CNT_EQ</span>
<span class="cm"> * event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_dupaddr_state_actions_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_inc_xid_r_cnt_by_1</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_dupaddr_state_trans_1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_rx_null_dsap_0_xid_r_xid_r_cnt_eq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_DUP_ADDR_CHK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_dupaddr_state_actions_1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_RX_NULL_DSAP_1_XID_R_XID_R_CNT_EQ</span>
<span class="cm"> * event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_dupaddr_state_actions_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_report_status</span><span class="p">,</span>	<span class="cm">/* DUPLICATE ADDRESS FOUND */</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_dupaddr_state_trans_2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_rx_null_dsap_1_xid_r_xid_r_cnt_eq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_DOWN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_dupaddr_state_actions_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_RX_NULL_DSAP_XID_C event */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_dupaddr_state_actions_3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_send_xid_r</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_dupaddr_state_trans_3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_rx_null_dsap_xid_c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_DUP_ADDR_CHK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_dupaddr_state_actions_3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_ACK_TMR_EXP_LT_RETRY_CNT_MAX_RETRY</span>
<span class="cm"> * event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_dupaddr_state_actions_4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_start_ack_timer</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_inc_retry_cnt_by_1</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_set_xid_r_cnt_0</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_send_null_dsap_xid_c</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_dupaddr_state_trans_4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_ack_tmr_exp_lt_retry_cnt_max_retry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_DUP_ADDR_CHK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_dupaddr_state_actions_4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_ACK_TMR_EXP_EQ_RETRY_CNT_MAX_RETRY</span>
<span class="cm"> * event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_dupaddr_state_actions_5</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_report_status</span><span class="p">,</span>	<span class="cm">/* STATION UP */</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_dupaddr_state_trans_5</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_ack_tmr_exp_eq_retry_cnt_max_retry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_UP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_dupaddr_state_actions_5</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* state transition for LLC_STATION_EV_DISABLE_REQ event */</span>
<span class="k">static</span> <span class="n">llc_station_action_t</span> <span class="n">llc_stat_dupaddr_state_actions_6</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc_station_ac_report_status</span><span class="p">,</span>	<span class="cm">/* STATION DOWN */</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="n">llc_stat_dupaddr_state_trans_6</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ev</span>	    <span class="o">=</span> <span class="n">llc_stat_ev_disable_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">LLC_STATION_STATE_DOWN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ev_actions</span> <span class="o">=</span> <span class="n">llc_stat_dupaddr_state_actions_6</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* array of pointers; one to each transition */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">*</span><span class="n">llc_stat_dupaddr_state_trans</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_dupaddr_state_trans_6</span><span class="p">,</span>	<span class="cm">/* Request */</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_dupaddr_state_trans_4</span><span class="p">,</span>	<span class="cm">/* Timer */</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_dupaddr_state_trans_5</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_dupaddr_state_trans_1</span><span class="p">,</span>	<span class="cm">/* Receive frame */</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_dupaddr_state_trans_2</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_dupaddr_state_trans_3</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">llc_stat_state_trans_end</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state</span>
			<span class="n">llc_station_state_table</span><span class="p">[</span><span class="n">LLC_NBR_STATION_STATES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">LLC_STATION_STATE_DOWN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">curr_state</span>  <span class="o">=</span> <span class="n">LLC_STATION_STATE_DOWN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="n">llc_stat_dwn_state_trans</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">LLC_STATION_STATE_DUP_ADDR_CHK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">curr_state</span>  <span class="o">=</span> <span class="n">LLC_STATION_STATE_DUP_ADDR_CHK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="n">llc_stat_dupaddr_state_trans</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">LLC_STATION_STATE_UP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">curr_state</span>  <span class="o">=</span> <span class="n">LLC_STATION_STATE_UP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="n">llc_stat_up_state_trans</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_exec_station_trans_actions - executes actions for transition</span>
<span class="cm"> *	@trans: Address of the transition</span>
<span class="cm"> *	@skb: Address of the event that caused the transition</span>
<span class="cm"> *</span>
<span class="cm"> *	Executes actions of a transition of the station state machine. Returns</span>
<span class="cm"> *	0 if all actions complete successfully, nonzero otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">llc_exec_station_trans_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">llc_station_action_t</span> <span class="o">*</span><span class="n">next_action</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ev_actions</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">next_action</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">next_action</span><span class="p">;</span> <span class="n">next_action</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">next_action</span><span class="p">)(</span><span class="n">skb</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_find_station_trans - finds transition for this event</span>
<span class="cm"> *	@skb: Address of the event</span>
<span class="cm"> *</span>
<span class="cm"> *	Search thru events of the current state of the station until list</span>
<span class="cm"> *	exhausted or it&#39;s obvious that the event is not valid for the current</span>
<span class="cm"> *	state. Returns the address of the transition if cound, %NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">*</span>
				<span class="nf">llc_find_station_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">**</span><span class="n">next_trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_station_state</span> <span class="o">*</span><span class="n">curr_state</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">llc_station_state_table</span><span class="p">[</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">state</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">next_trans</span> <span class="o">=</span> <span class="n">curr_state</span><span class="o">-&gt;</span><span class="n">transitions</span><span class="p">;</span> <span class="n">next_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">next_trans</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_station_free_ev - frees an event</span>
<span class="cm"> *	@skb: Address of the event</span>
<span class="cm"> *</span>
<span class="cm"> *	Frees an event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_station_free_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_STATION_EV_TYPE_PDU</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_station_next_state - processes event and goes to the next state</span>
<span class="cm"> *	@skb: Address of the event</span>
<span class="cm"> *</span>
<span class="cm"> *	Processes an event, executes any transitions related to that event and</span>
<span class="cm"> *	updates the state of the station.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">llc_station_next_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_station_state_trans</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">LLC_NBR_STATION_STATES</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">trans</span> <span class="o">=</span> <span class="n">llc_find_station_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* got the state to which we next transition; perform the</span>
<span class="cm">		 * actions associated with this transition before actually</span>
<span class="cm">		 * transitioning to the next state</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_exec_station_trans_actions</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="cm">/* transition station to next state if all actions</span>
<span class="cm">			 * execute successfully; done; wait for next event</span>
<span class="cm">			 */</span>
			<span class="n">llc_main_station</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* event not recognized in current state; re-queue it for</span>
<span class="cm">		 * processing again at a later time; return failure</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">llc_station_free_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_station_service_events - service events in the queue</span>
<span class="cm"> *</span>
<span class="cm"> *	Get an event from the station event queue (if any); attempt to service</span>
<span class="cm"> *	the event; if event serviced, get the next event (if any) on the event</span>
<span class="cm"> *	queue; if event not service, re-queue the event on the event queue and</span>
<span class="cm"> *	attempt to service the next event; when serviced all events in queue,</span>
<span class="cm"> *	finished; if don&#39;t transition to different state, just service all</span>
<span class="cm"> *	events once; if transition to new state, service all events again.</span>
<span class="cm"> *	Caller must hold llc_main_station.ev_q.lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_station_service_events</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ev_q</span><span class="p">.</span><span class="n">list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">llc_station_next_state</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_station_state_process: queue event and try to process queue.</span>
<span class="cm"> *	@skb: Address of the event</span>
<span class="cm"> *</span>
<span class="cm"> *	Queues an event (on the station event queue) for handling by the</span>
<span class="cm"> *	station state machine and attempts to process any queued-up events.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_station_state_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ev_q</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ev_q</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">llc_station_service_events</span><span class="p">();</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ev_q</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_station_ack_tmr_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">LLC_STATION_EV_TYPE_ACK_TMR</span><span class="p">;</span>
		<span class="n">llc_station_state_process</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	llc_station_rcv - send received pdu to the station state machine</span>
<span class="cm"> *	@skb: received frame.</span>
<span class="cm"> *</span>
<span class="cm"> *	Sends data unit to station state machine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_station_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span>   <span class="o">=</span> <span class="n">LLC_STATION_EV_TYPE_PDU</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">llc_station_state_process</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">llc_station_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_station_state_ev</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">mac_pdu_q</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ev_q</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ev_q</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">.</span><span class="n">ack_timer</span><span class="p">,</span> <span class="n">llc_station_ack_tmr_cb</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">llc_main_station</span><span class="p">);</span>
	<span class="n">llc_main_station</span><span class="p">.</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expires</span>  <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
						<span class="n">sysctl_llc_station_ack_timeout</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">llc_set_station_handler</span><span class="p">(</span><span class="n">llc_station_rcv</span><span class="p">);</span>
	<span class="n">ev</span> <span class="o">=</span> <span class="n">llc_station_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">));</span>
	<span class="n">llc_main_station</span><span class="p">.</span><span class="n">maximum_retry</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">llc_main_station</span><span class="p">.</span><span class="n">state</span>		<span class="o">=</span> <span class="n">LLC_STATION_STATE_DOWN</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">LLC_STATION_EV_TYPE_SIMPLE</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">prim_type</span>	<span class="o">=</span> <span class="n">LLC_STATION_EV_ENABLE_WITHOUT_DUP_ADDR_CHECK</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_station_next_state</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">llc_station_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_set_station_handler</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
