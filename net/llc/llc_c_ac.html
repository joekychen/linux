<!DOCTYPE html>
<html><head><title>joekychen/linux » net › llc › llc_c_ac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>llc_c_ac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * llc_c_ac.c - actions performed during connection state transition.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Functions in this module are implementation of connection component actions</span>
<span class="cm"> *   Details of actions can be found in IEEE-802.2 standard document.</span>
<span class="cm"> *   All functions have one connection and one event as input argument. All of</span>
<span class="cm"> *   them return 0 On success and 1 otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1997 by Procom Technology, Inc.</span>
<span class="cm"> * 		 2001-2003 by Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program can be redistributed or modified under the terms of the</span>
<span class="cm"> * GNU General Public License as published by the Free Software Foundation.</span>
<span class="cm"> * This program is distributed without any warranty or implied warranty</span>
<span class="cm"> * of merchantability or fitness for a particular purpose.</span>
<span class="cm"> *</span>
<span class="cm"> * See the GNU General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/llc_conn.h&gt;</span>
<span class="cp">#include &lt;net/llc_sap.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/llc_c_ev.h&gt;</span>
<span class="cp">#include &lt;net/llc_c_ac.h&gt;</span>
<span class="cp">#include &lt;net/llc_c_st.h&gt;</span>
<span class="cp">#include &lt;net/llc_pdu.h&gt;</span>
<span class="cp">#include &lt;net/llc.h&gt;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_conn_ac_inc_vs_by_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">llc_process_tmr_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_conn_ac_data_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_conn_ac_inc_npta_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_conn_ac_send_rr_rsp_f_set_ackpf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">llc_conn_ac_set_p_flag_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="cp">#define INCORRECT 0</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_clear_remote_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">nr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">busy_state_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">LLC_I_GET_NR</span><span class="p">(</span><span class="n">pdu</span><span class="p">);</span>
		<span class="n">llc_conn_resend_i_pdu_as_cmd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_conn_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ind_prim</span> <span class="o">=</span> <span class="n">LLC_CONN_PRIM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_conn_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">cfm_prim</span> <span class="o">=</span> <span class="n">LLC_CONN_PRIM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_conn_ac_data_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">cfm_prim</span> <span class="o">=</span> <span class="n">LLC_DATA_PRIM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_data_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_conn_rtn_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_disc_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_CONN_EV_TYPE_PDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_pdu_un</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_un_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">LLC_PDU_IS_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">LLC_U_PDU_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_2_PDU_RSP_DM</span><span class="p">)</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="n">LLC_DISC_REASON_RX_DM_RSP_PDU</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">LLC_PDU_IS_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">LLC_U_PDU_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_2_PDU_CMD_DISC</span><span class="p">)</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="n">LLC_DISC_REASON_RX_DISC_CMD_PDU</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LLC_CONN_EV_TYPE_ACK_TMR</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">LLC_DISC_REASON_ACK_TMR_EXP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">reason</span>   <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ind_prim</span> <span class="o">=</span> <span class="n">LLC_DISC_PRIM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_disc_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">reason</span>   <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">cfm_prim</span> <span class="o">=</span> <span class="n">LLC_DISC_PRIM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_rst_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_pdu_un</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_un_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LLC_CONN_EV_TYPE_PDU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">LLC_PDU_IS_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">LLC_U_PDU_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_2_PDU_RSP_FRMR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="n">LLC_RESET_REASON_LOCAL</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">LLC_PDU_IS_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">LLC_PDU_TYPE_IS_U</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">LLC_U_PDU_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">==</span> <span class="n">LLC_2_PDU_CMD_SABME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="n">LLC_RESET_REASON_REMOTE</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LLC_CONN_EV_TYPE_ACK_TMR</span>:
	<span class="k">case</span> <span class="n">LLC_CONN_EV_TYPE_P_TMR</span>:
	<span class="k">case</span> <span class="n">LLC_CONN_EV_TYPE_REJ_TMR</span>:
	<span class="k">case</span> <span class="n">LLC_CONN_EV_TYPE_BUSY_TMR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">n2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="n">LLC_RESET_REASON_LOCAL</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">reason</span>   <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ind_prim</span> <span class="o">=</span> <span class="n">LLC_RESET_PRIM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_rst_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">reason</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">cfm_prim</span> <span class="o">=</span> <span class="n">LLC_RESET_PRIM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_clear_remote_busy_if_f_eq_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LLC_PDU_IS_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LLC_PDU_TYPE_IS_I</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LLC_I_PF_IS_1</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ack_pf</span><span class="p">)</span>
		<span class="n">llc_conn_ac_clear_remote_busy</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_stop_rej_tmr_if_data_flag_eq_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">data_flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_disc_cmd_p_set_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_disc_cmd</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
		<span class="n">llc_conn_ac_set_p_flag_1</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_dm_rsp_f_set_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">f_bit</span><span class="p">;</span>

		<span class="n">llc_pdu_decode_pf_bit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_bit</span><span class="p">);</span>
		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_dm_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">f_bit</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_dm_rsp_f_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_dm_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_frmr_rsp_f_set_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">f_bit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">rx_pdu_hdr</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pdu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LLC_PDU_IS_CMD</span><span class="p">(</span><span class="n">pdu</span><span class="p">))</span>
		<span class="n">llc_pdu_decode_pf_bit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_bit</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">f_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_frmr_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_frmr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">pdu</span><span class="p">,</span> <span class="n">f_bit</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span>
					 <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">,</span> <span class="n">INCORRECT</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_resend_frmr_rsp_f_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_frmr_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">rx_pdu_hdr</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_frmr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">pdu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span>
					 <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">,</span> <span class="n">INCORRECT</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_resend_frmr_rsp_f_set_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">f_bit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">llc_pdu_decode_pf_bit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_bit</span><span class="p">);</span>
	<span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_frmr_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_frmr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">pdu</span><span class="p">,</span> <span class="n">f_bit</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span>
					 <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">,</span> <span class="n">INCORRECT</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_i_cmd_p_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

	<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_I</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
			    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
	<span class="n">llc_pdu_init_as_i_cmd</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">llc_conn_ac_inc_vs_by_1</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_conn_ac_send_i_cmd_p_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

	<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_I</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
			    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
	<span class="n">llc_pdu_init_as_i_cmd</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">llc_conn_ac_inc_vs_by_1</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_i_xxx_x_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

	<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_I</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
			    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
	<span class="n">llc_pdu_init_as_i_cmd</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">llc_conn_ac_inc_vs_by_1</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_resend_i_xxx_x_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">LLC_I_GET_NR</span><span class="p">(</span><span class="n">pdu</span><span class="p">);</span>

	<span class="n">llc_conn_resend_i_pdu_as_cmd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_resend_i_xxx_x_set_0_or_send_rr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span>
			<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">LLC_I_GET_NR</span><span class="p">(</span><span class="n">pdu</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">llc_conn_resend_i_pdu_as_cmd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_resend_i_rsp_f_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">LLC_I_GET_NR</span><span class="p">(</span><span class="n">pdu</span><span class="p">);</span>

	<span class="n">llc_conn_resend_i_pdu_as_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rej_cmd_p_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rej_cmd</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rej_rsp_f_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rej_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rej_xxx_x_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rej_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rnr_cmd_p_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rnr_cmd</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rnr_rsp_f_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rnr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rnr_xxx_x_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rnr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_remote_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">busy_state_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
			 <span class="n">jiffies</span> <span class="o">+</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">busy_state_timer</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_opt_send_rnr_xxx_x_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rnr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rr_cmd_p_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rr_cmd</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rr_rsp_f_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">f_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">f_bit</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_ack_rsp_f_set_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_rr_xxx_x_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_ack_xxx_x_set_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">llc_conn_set_p_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state_changed</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">p_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>

	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">p_flag</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_changed</span><span class="p">)</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_sabme_cmd_p_set_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">dmac</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span>
			<span class="n">dmac</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_CMD</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_sabme_cmd</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dmac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
		<span class="n">llc_conn_set_p_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_send_ua_rsp_f_set_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">f_bit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">llc_pdu_decode_pf_bit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_bit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">nskb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_U</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_ua_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">f_bit</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_s_flag_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_s_flag_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_start_p_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">llc_conn_set_p_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">pf_cycle_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">pf_cycle_timer</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_send_ack_if_needed - check if ack is needed</span>
<span class="cm"> *	@sk: current connection structure</span>
<span class="cm"> *	@skb: current event</span>
<span class="cm"> *</span>
<span class="cm"> *	Checks number of received PDUs which have not been acknowledged, yet,</span>
<span class="cm"> *	If number of them reaches to &quot;npta&quot;(Number of PDUs To Acknowledge) then</span>
<span class="cm"> *	sends an RR response as acknowledgement for them.  Returns 0 for</span>
<span class="cm"> *	success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_ac_send_ack_if_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pf_bit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">llc_pdu_decode_pf_bit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pf_bit</span><span class="p">);</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span> <span class="o">|=</span> <span class="n">pf_bit</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">first_pdu_Ns</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span> <span class="o">=</span> <span class="n">pf_bit</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span> <span class="o">-</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">first_pdu_Ns</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">LLC_2_SEQ_NBR_MODULO</span><span class="p">)</span>
			<span class="o">%</span> <span class="n">LLC_2_SEQ_NBR_MODULO</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc_conn_ac_send_rr_rsp_f_set_ackpf</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">llc_conn_ac_inc_npta_value</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_rst_sendack_flag - resets ack_must_be_send flag</span>
<span class="cm"> *	@sk: current connection structure</span>
<span class="cm"> *	@skb: current event</span>
<span class="cm"> *</span>
<span class="cm"> *	This action resets ack_must_be_send flag of given connection, this flag</span>
<span class="cm"> *	indicates if there is any PDU which has not been acknowledged yet.</span>
<span class="cm"> *	Returns 0 for success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_ac_rst_sendack_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ack_pf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_send_i_rsp_f_set_ackpf - acknowledge received PDUs</span>
<span class="cm"> *	@sk: current connection structure</span>
<span class="cm"> *	@skb: current event</span>
<span class="cm"> *</span>
<span class="cm"> *	Sends an I response PDU with f-bit set to ack_pf flag as acknowledge to</span>
<span class="cm"> *	all received PDUs which have not been acknowledged, yet. ack_pf flag is</span>
<span class="cm"> *	set to one if one PDU with p-bit set to one is received.  Returns 0 for</span>
<span class="cm"> *	success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_conn_ac_send_i_rsp_f_set_ackpf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

	<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_I</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
			    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
	<span class="n">llc_pdu_init_as_i_cmd</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">llc_conn_ac_inc_vs_by_1</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_send_i_as_ack - sends an I-format PDU to acknowledge rx PDUs</span>
<span class="cm"> *	@sk: current connection structure.</span>
<span class="cm"> *	@skb: current event.</span>
<span class="cm"> *</span>
<span class="cm"> *	This action sends an I-format PDU as acknowledge to received PDUs which</span>
<span class="cm"> *	have not been acknowledged, yet, if there is any. By using of this</span>
<span class="cm"> *	action number of acknowledgements decreases, this technic is called</span>
<span class="cm"> *	piggy backing. Returns 0 for success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_ac_send_i_as_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc_conn_ac_send_i_rsp_f_set_ackpf</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">llc_conn_ac_send_i_cmd_p_set_0</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_send_rr_rsp_f_set_ackpf - ack all rx PDUs not yet acked</span>
<span class="cm"> *	@sk: current connection structure.</span>
<span class="cm"> *	@skb: current event.</span>
<span class="cm"> *</span>
<span class="cm"> *	This action sends an RR response with f-bit set to ack_pf flag as</span>
<span class="cm"> *	acknowledge to all received PDUs which have not been acknowledged, yet,</span>
<span class="cm"> *	if there is any. ack_pf flag indicates if a PDU has been received with</span>
<span class="cm"> *	p-bit set to one. Returns 0 for success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_conn_ac_send_rr_rsp_f_set_ackpf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">llc_alloc_frame</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_sap</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">sap</span><span class="p">;</span>

		<span class="n">llc_pdu_header_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">LLC_PDU_TYPE_S</span><span class="p">,</span> <span class="n">sap</span><span class="o">-&gt;</span><span class="n">laddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span>
				    <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LLC_PDU_RSP</span><span class="p">);</span>
		<span class="n">llc_pdu_init_as_rr_rsp</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">llc_mac_hdr_init</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">llc_conn_send_pdu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_inc_npta_value - tries to make value of npta greater</span>
<span class="cm"> *	@sk: current connection structure.</span>
<span class="cm"> *	@skb: current event.</span>
<span class="cm"> *</span>
<span class="cm"> *	After &quot;inc_cntr&quot; times calling of this action, &quot;npta&quot; increase by one.</span>
<span class="cm"> *	this action tries to make vale of &quot;npta&quot; greater as possible; number of</span>
<span class="cm"> *	acknowledgements decreases by increasing of &quot;npta&quot;. Returns 0 for</span>
<span class="cm"> *	success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_conn_ac_inc_npta_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">inc_cntr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_cntr</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">inc_cntr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">++</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">LLC_2_SEQ_NBR_MODULO</span><span class="p">)</span>
			<span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">LLC_2_SEQ_NBR_MODULO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">--</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">inc_cntr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_adjust_npta_by_rr - decreases &quot;npta&quot; by one</span>
<span class="cm"> *	@sk: current connection structure.</span>
<span class="cm"> *	@skb: current event.</span>
<span class="cm"> *</span>
<span class="cm"> *	After receiving &quot;dec_cntr&quot; times RR command, this action decreases</span>
<span class="cm"> *	&quot;npta&quot; by one. Returns 0 for success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_ac_adjust_npta_by_rr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">connect_step</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_step</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_cntr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">llc</span><span class="o">-&gt;</span><span class="n">inc_cntr</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_cntr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_cntr</span> <span class="o">-=</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">connect_step</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_adjust_npta_by_rnr - decreases &quot;npta&quot; by one</span>
<span class="cm"> *	@sk: current connection structure.</span>
<span class="cm"> *	@skb: current event.</span>
<span class="cm"> *</span>
<span class="cm"> *	After receiving &quot;dec_cntr&quot; times RNR command, this action decreases</span>
<span class="cm"> *	&quot;npta&quot; by one. Returns 0 for success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_ac_adjust_npta_by_rnr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_step</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_cntr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">llc</span><span class="o">-&gt;</span><span class="n">inc_cntr</span> <span class="o">=</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_cntr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">--</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">npta</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">--</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dec_cntr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_dec_tx_win_size - decreases tx window size</span>
<span class="cm"> *	@sk: current connection structure.</span>
<span class="cm"> *	@skb: current event.</span>
<span class="cm"> *</span>
<span class="cm"> *	After receiving of a REJ command or response, transmit window size is</span>
<span class="cm"> *	decreased by number of PDUs which are outstanding yet. Returns 0 for</span>
<span class="cm"> *	success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_ac_dec_tx_win_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">unacked_pdu</span> <span class="o">=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">pdu_unack_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">-</span> <span class="n">unacked_pdu</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">-=</span> <span class="n">unacked_pdu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_ac_inc_tx_win_size - tx window size is inc by 1</span>
<span class="cm"> *	@sk: current connection structure.</span>
<span class="cm"> *	@skb: current event.</span>
<span class="cm"> *</span>
<span class="cm"> *	After receiving an RR response with f-bit set to one, transmit window</span>
<span class="cm"> *	size is increased by one. Returns 0 for success, 1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_ac_inc_tx_win_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">LLC_2_SEQ_NBR_MODULO</span><span class="p">)</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">LLC_2_SEQ_NBR_MODULO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_stop_all_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">pf_cycle_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">busy_state_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_stop_other_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">pf_cycle_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">busy_state_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_must_be_send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_pf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_start_ack_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_start_rej_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_start_ack_tmr_if_not_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_stop_ack_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_stop_p_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">pf_cycle_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">llc_conn_set_p_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_stop_rej_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rej_sent_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_upd_nr_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">acked</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">unacked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">llc_sock</span> <span class="o">*</span><span class="n">llc</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">llc</span><span class="o">-&gt;</span><span class="n">last_nr</span> <span class="o">=</span> <span class="n">PDU_SUPV_GET_Nr</span><span class="p">(</span><span class="n">pdu</span><span class="p">);</span>
	<span class="n">acked</span> <span class="o">=</span> <span class="n">llc_conn_remove_acked_pdus</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">last_nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unacked</span><span class="p">);</span>
	<span class="cm">/* On loopback we don&#39;t queue I frames in unack_pdu_q queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acked</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">llc</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">failed_data_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* already, we did not accept data from upper layer</span>
<span class="cm">			 * (tx_window full or unacceptable state). Now, we</span>
<span class="cm">			 * can send data and must inform to upper layer.</span>
<span class="cm">			 */</span>
			<span class="n">llc</span><span class="o">-&gt;</span><span class="n">failed_data_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">llc_conn_ac_data_confirm</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unacked</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
				  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">llc</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="o">-&gt;</span><span class="n">failed_data_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">f_bit</span><span class="p">;</span>

		<span class="n">llc_pdu_decode_pf_bit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_bit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f_bit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">llc</span><span class="o">-&gt;</span><span class="n">failed_data_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">llc_conn_ac_data_confirm</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_upd_p_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LLC_PDU_IS_RSP</span><span class="p">(</span><span class="n">pdu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">f_bit</span><span class="p">;</span>

		<span class="n">llc_pdu_decode_pf_bit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_bit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">llc_conn_set_p_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">llc_conn_ac_stop_p_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_data_flag_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_flag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_data_flag_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_data_flag_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_data_flag_1_if_data_flag_eq_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_flag</span><span class="p">)</span>
		<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_p_flag_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_conn_set_p_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_conn_ac_set_p_flag_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_conn_set_p_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_remote_busy_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">remote_busy_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_cause_flag_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cause_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_cause_flag_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cause_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_retry_cnt_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_inc_retry_cnt_by_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_vr_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_inc_vr_by_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vR</span> <span class="o">=</span> <span class="n">PDU_GET_NEXT_Vr</span><span class="p">(</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_vs_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_set_vs_nr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vS</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_nr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">llc_conn_ac_inc_vs_by_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vS</span> <span class="o">=</span> <span class="p">(</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">LLC_2_SEQ_NBR_MODULO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_conn_tmr_common_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">timeout_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="n">bh_lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_conn_state_ev</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">llc_conn_ev</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">skb_set_owner_r</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">llc_process_tmr_ev</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">llc_conn_pf_cycle_tmr_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_conn_tmr_common_cb</span><span class="p">(</span><span class="n">timeout_data</span><span class="p">,</span> <span class="n">LLC_CONN_EV_TYPE_P_TMR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">llc_conn_busy_tmr_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_conn_tmr_common_cb</span><span class="p">(</span><span class="n">timeout_data</span><span class="p">,</span> <span class="n">LLC_CONN_EV_TYPE_BUSY_TMR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">llc_conn_ack_tmr_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_conn_tmr_common_cb</span><span class="p">(</span><span class="n">timeout_data</span><span class="p">,</span> <span class="n">LLC_CONN_EV_TYPE_ACK_TMR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">llc_conn_rej_tmr_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_conn_tmr_common_cb</span><span class="p">(</span><span class="n">timeout_data</span><span class="p">,</span> <span class="n">LLC_CONN_EV_TYPE_REJ_TMR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_rst_vs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">X</span> <span class="o">=</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">;</span>
	<span class="n">llc_conn_ac_set_vs_nr</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">llc_conn_ac_upd_vs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">llc_pdu_sn</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="n">llc_pdu_sn_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">PDU_SUPV_GET_Nr</span><span class="p">(</span><span class="n">pdu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llc_circular_between</span><span class="p">(</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vS</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">X</span><span class="p">))</span>
		<span class="n">llc_conn_ac_set_vs_nr</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Non-standard actions; these not contained in IEEE specification; for</span>
<span class="cm"> * our own usage</span>
<span class="cm"> */</span>
<span class="cm">/**</span>
<span class="cm"> *	llc_conn_disc - removes connection from SAP list and frees it</span>
<span class="cm"> *	@sk: closed connection</span>
<span class="cm"> *	@skb: occurred event</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: this thing seems to want to die */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_conn_reset - resets connection</span>
<span class="cm"> *	@sk : reseting connection.</span>
<span class="cm"> *	@skb: occurred event.</span>
<span class="cm"> *</span>
<span class="cm"> *	Stop all timers, empty all queues and reset all flags.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">llc_conn_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">llc_sk_reset</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_circular_between - designates that b is between a and c or not</span>
<span class="cm"> *	@a: lower bound</span>
<span class="cm"> *	@b: element to see if is between a and b</span>
<span class="cm"> *	@c: upper bound</span>
<span class="cm"> *</span>
<span class="cm"> *	This function designates that b is between a and c or not (for example,</span>
<span class="cm"> *	0 is between 127 and 1). Returns 1 if b is between a and c, 0</span>
<span class="cm"> *	otherwise.</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">llc_circular_between</span><span class="p">(</span><span class="n">u8</span> <span class="n">a</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="n">u8</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	llc_process_tmr_ev - timer backend</span>
<span class="cm"> *	@sk: active connection</span>
<span class="cm"> *	@skb: occurred event</span>
<span class="cm"> *</span>
<span class="cm"> *	This function is called from timer callback functions. When connection</span>
<span class="cm"> *	is busy (during sending a data frame) timer expiration event must be</span>
<span class="cm"> *	queued. Otherwise this event can be sent to connection state machine.</span>
<span class="cm"> *	Queued events will process by llc_backlog_rcv function after sending</span>
<span class="cm"> *	data frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">llc_process_tmr_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">llc_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LLC_CONN_OUT_OF_SVC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: timer called on closed connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
			<span class="n">llc_conn_state_process</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">llc_set_backlog_type</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">LLC_EVENT</span><span class="p">);</span>
			<span class="n">__sk_add_backlog</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
