<!DOCTYPE html>
<html><head><title>joekychen/linux » net › rxrpc › ar-ack.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ar-ack.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Management of Tx window, Tx resend, ACKs and out-of-sequence reception</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/af_rxrpc.h&gt;</span>
<span class="cp">#include &quot;ar-internal.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxrpc_ack_defer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">rxrpc_acks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;---&quot;</span><span class="p">,</span> <span class="s">&quot;REQ&quot;</span><span class="p">,</span> <span class="s">&quot;DUP&quot;</span><span class="p">,</span> <span class="s">&quot;OOS&quot;</span><span class="p">,</span> <span class="s">&quot;WIN&quot;</span><span class="p">,</span> <span class="s">&quot;MEM&quot;</span><span class="p">,</span> <span class="s">&quot;PNG&quot;</span><span class="p">,</span> <span class="s">&quot;PNR&quot;</span><span class="p">,</span> <span class="s">&quot;DLY&quot;</span><span class="p">,</span> <span class="s">&quot;IDL&quot;</span><span class="p">,</span>
	<span class="s">&quot;-?-&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">rxrpc_ack_priority</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_DELAY</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_REQUESTED</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_IDLE</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_PING_RESPONSE</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_DUPLICATE</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_OUT_OF_SEQUENCE</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_EXCEEDS_WINDOW</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RXRPC_ACK_NOSPACE</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * propose an ACK be sent</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__rxrpc_propose_ACK</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ack_reason</span><span class="p">,</span>
			 <span class="n">__be32</span> <span class="n">serial</span><span class="p">,</span> <span class="n">bool</span> <span class="n">immediate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expiry</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">prior</span> <span class="o">=</span> <span class="n">rxrpc_ack_priority</span><span class="p">[</span><span class="n">ack_reason</span><span class="p">];</span>

	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%d},%s,%%%x,%u&quot;</span><span class="p">,</span>
	       <span class="n">call</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">rxrpc_acks</span><span class="p">[</span><span class="n">ack_reason</span><span class="p">],</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">serial</span><span class="p">),</span>
	       <span class="n">immediate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prior</span> <span class="o">&lt;</span> <span class="n">rxrpc_ack_priority</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">immediate</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cancel_timer</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update DELAY, IDLE, REQUESTED and PING_RESPONSE ACK serial</span>
<span class="cm">	 * numbers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prior</span> <span class="o">==</span> <span class="n">rxrpc_ack_priority</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prior</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_serial</span> <span class="o">=</span> <span class="n">serial</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">immediate</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cancel_timer</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span> <span class="o">=</span> <span class="n">ack_reason</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_serial</span> <span class="o">=</span> <span class="n">serial</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ack_reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RXRPC_ACK_DELAY</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;run delay timer&quot;</span><span class="p">);</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">rxrpc_ack_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RXRPC_ACK_IDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">immediate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;run defer timer&quot;</span><span class="p">);</span>
			<span class="n">expiry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">run_timer</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">cancel_timer</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RXRPC_ACK_REQUESTED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxrpc_ack_defer</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cancel_timer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">immediate</span> <span class="o">||</span> <span class="n">serial</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;run defer timer&quot;</span><span class="p">);</span>
			<span class="n">expiry</span> <span class="o">=</span> <span class="n">rxrpc_ack_defer</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">run_timer</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;immediate ACK&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cancel_timer</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">run_timer:</span>
	<span class="n">expiry</span> <span class="o">+=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">.</span><span class="n">expires</span><span class="p">,</span> <span class="n">expiry</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">,</span> <span class="n">expiry</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">cancel_timer:</span>
	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;cancel timer %%%u&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">serial</span><span class="p">));</span>
	<span class="n">try_to_del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">);</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">RXRPC_CALL_COMPLETE</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span>
		<span class="n">rxrpc_queue_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * propose an ACK be sent, locking the call structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rxrpc_propose_ACK</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ack_reason</span><span class="p">,</span>
		       <span class="n">__be32</span> <span class="n">serial</span><span class="p">,</span> <span class="n">bool</span> <span class="n">immediate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">prior</span> <span class="o">=</span> <span class="n">rxrpc_ack_priority</span><span class="p">[</span><span class="n">ack_reason</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prior</span> <span class="o">&gt;</span> <span class="n">rxrpc_ack_priority</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">__rxrpc_propose_ACK</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">ack_reason</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">immediate</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the resend timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_set_resend</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span> <span class="n">u8</span> <span class="n">resend</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resend_at</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">)</span>
		<span class="n">resend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resend</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;SET RESEND&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RESEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resend</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;MODIFY RESEND TIMER&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RUN_RTIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">resend_timer</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;KILL RESEND TIMER&quot;</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">resend_timer</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RESEND_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RUN_RTIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resend packets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_resend</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxrpc_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p_txb</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">,</span> <span class="n">stop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resend</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%d,%d,%d,%d},&quot;</span><span class="p">,</span>
	       <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_hard</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_unacked</span><span class="p">,</span>
	       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">),</span>
	       <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span><span class="p">));</span>

	<span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resend_at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">;</span>
	     <span class="n">loop</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span> <span class="o">||</span> <span class="n">stop</span><span class="p">;</span>
	     <span class="n">loop</span> <span class="o">=</span> <span class="p">(</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
	     <span class="p">)</span> <span class="p">{</span>
		<span class="n">p_txb</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span> <span class="o">+</span> <span class="n">loop</span><span class="p">;</span>
		<span class="n">smp_read_barrier_depends</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">txb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="n">p_txb</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="cm">/* each Tx packet has a new serial number */</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span>
				<span class="n">htonl</span><span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">));</span>

			<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span><span class="p">;</span>

			<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Tx DATA %%%u { #%d }&quot;</span><span class="p">,</span>
			       <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_send_packet</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">,</span> <span class="n">txb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span> <span class="o">=</span>
					<span class="n">jiffies</span> <span class="o">+</span> <span class="n">rxrpc_resend_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resend</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">))</span>
				<span class="n">resend_at</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">resend_at</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rxrpc_set_resend</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">resend</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle resend timer expiry</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_resend_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p_txb</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resend</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%d,%d,%d&quot;</span><span class="p">,</span>
	       <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_unacked</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">resend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resend_at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_unacked</span><span class="p">;</span>
	     <span class="n">loop</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">;</span>
	     <span class="n">loop</span> <span class="o">=</span> <span class="p">(</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
	     <span class="p">)</span> <span class="p">{</span>
		<span class="n">p_txb</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span> <span class="o">+</span> <span class="n">loop</span><span class="p">;</span>
		<span class="n">smp_read_barrier_depends</span><span class="p">();</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resend</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">))</span>
				<span class="n">resend_at</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">resend_at</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rxrpc_set_resend</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">resend</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process soft ACKs of our transmitted packets</span>
<span class="cm"> * - these indicate packets the peer has or has not received, but hasn&#39;t yet</span>
<span class="cm"> *   given to the consumer, and so can still be discarded and re-requested</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxrpc_process_soft_ACKs</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rxrpc_ackpacket</span> <span class="o">*</span><span class="n">ack</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p_txb</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sacks</span><span class="p">[</span><span class="n">RXRPC_MAXACKS</span><span class="p">],</span> <span class="n">resend</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%d,%d},{%d},&quot;</span><span class="p">,</span>
	       <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_hard</span><span class="p">,</span>
	       <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span><span class="p">),</span>
	       <span class="n">ack</span><span class="o">-&gt;</span><span class="n">nAcks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sacks</span><span class="p">,</span> <span class="n">ack</span><span class="o">-&gt;</span><span class="n">nAcks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">protocol_error</span><span class="p">;</span>

	<span class="n">resend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resend_at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">ack</span><span class="o">-&gt;</span><span class="n">nAcks</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p_txb</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span><span class="p">;</span>
		<span class="n">p_txb</span> <span class="o">+=</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span> <span class="o">+</span> <span class="n">loop</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">smp_read_barrier_depends</span><span class="p">();</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sacks</span><span class="p">[</span><span class="n">loop</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RXRPC_ACK_TYPE_ACK</span>:
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p_txb</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RXRPC_ACK_TYPE_NACK</span>:
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;Unsupported ACK type %d&quot;</span><span class="p">,</span> <span class="n">sacks</span><span class="p">[</span><span class="n">loop</span><span class="p">]);</span>
			<span class="k">goto</span> <span class="n">protocol_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_unacked</span> <span class="o">=</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span> <span class="o">+</span> <span class="n">loop</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* anything not explicitly ACK&#39;d is implicitly NACK&#39;d, but may just not</span>
<span class="cm">	 * have been received or processed yet by the far end */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_unacked</span><span class="p">;</span>
	     <span class="n">loop</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">;</span>
	     <span class="n">loop</span> <span class="o">=</span> <span class="p">(</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
	     <span class="p">)</span> <span class="p">{</span>
		<span class="n">p_txb</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span> <span class="o">+</span> <span class="n">loop</span><span class="p">;</span>
		<span class="n">smp_read_barrier_depends</span><span class="p">();</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* packet must have been discarded */</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p_txb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">need_resend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resend</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">))</span>
				<span class="n">resend_at</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">resend_at</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">resend_at</span><span class="p">;</span>
			<span class="n">resend</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rxrpc_set_resend</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">resend</span><span class="p">,</span> <span class="n">resend_at</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">protocol_error:</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = -EPROTO&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * discard hard-ACK&#39;d packets from the Tx window</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_rotate_tx_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">,</span> <span class="n">old_tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win</span> <span class="o">=</span> <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u,%u},%u&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_hard</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">hard</span><span class="p">);</span>

	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">hard</span> <span class="o">-</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_hard</span><span class="p">,</span> <span class="o">&lt;=</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_hard</span> <span class="o">&lt;</span> <span class="n">hard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smp_read_barrier_depends</span><span class="p">();</span>
		<span class="n">_skb</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">rxrpc_free_skb</span><span class="p">((</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="n">_skb</span><span class="p">);</span>
		<span class="n">old_tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_unacked</span> <span class="o">==</span> <span class="n">old_tail</span><span class="p">)</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_unacked</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_hard</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tx_waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear the Tx window in the event of a failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_clear_tx_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rxrpc_rotate_tx_window</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * drain the out of sequence received packet queue into the packet Rx queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxrpc_drain_rx_oos_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">terminal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%d,%d}&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_post</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RELEASED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">socket_unavailable</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_oos_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;drain OOS packet %d [%d]&quot;</span><span class="p">,</span>
		       <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">),</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">)</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_oos_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;requeue %p {%u}&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">=</span> <span class="n">RXRPC_SKB_MARK_DATA</span><span class="p">;</span>
			<span class="n">terminal</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXRPC_LAST_PACKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXRPC_CLIENT_INITIATED</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rxrpc_queue_rcv_skb</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">terminal</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;drain #%u&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_post</span><span class="p">);</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_post</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* find out what the next packet is */</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_oos_queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span> <span class="o">=</span>
					<span class="n">ntohl</span><span class="p">(</span><span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;peek %p {%u}&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">socket_unavailable:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * insert an out of sequence packet into the buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_insert_oos_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">psp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,,{%u}&quot;</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">rxrpc_packet_destructor</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">call</span><span class="p">,</span> <span class="o">==</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="p">;</span>
	<span class="n">rxrpc_get_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>

	<span class="cm">/* insert into the buffer in sequence order */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_oos_queue</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">psp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;insert oos #%u before #%u&quot;</span><span class="p">,</span>
			       <span class="n">seq</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">psp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">));</span>
			<span class="n">skb_insert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_oos_queue</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">inserted</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;append oos #%u&quot;</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_oos_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">inserted:</span>

	<span class="cm">/* we might now have a new front to the queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">seq</span> <span class="o">&lt;</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">)</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">RXRPC_CALL_COMPLETE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_post</span> <span class="o">==</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;drain rx oos now&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_DRAIN_RX_OOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; [stored #%u]&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear the Tx window on final ACK reception</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_zap_tx_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_skb</span><span class="p">,</span> <span class="o">*</span><span class="n">acks_window</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">winsz</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tail</span><span class="p">;</span>

	<span class="n">acks_window</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">,</span> <span class="n">winsz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">;</span>
		<span class="n">smp_read_barrier_depends</span><span class="p">();</span>
		<span class="n">_skb</span> <span class="o">=</span> <span class="n">acks_window</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">winsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="n">_skb</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;+++ clear Tx %u&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">));</span>
		<span class="n">rxrpc_free_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">acks_window</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process the extra information that may be appended to an ACK packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxrpc_extract_ackinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">latest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nAcks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_ackinfo</span> <span class="n">ackinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxrpc_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nAcks</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ackinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; [no ackinfo]&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Rx ACK %%%u Info { rx=%u max=%u rwin=%u jm=%u }&quot;</span><span class="p">,</span>
	       <span class="n">latest</span><span class="p">,</span>
	       <span class="n">ntohl</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">.</span><span class="n">rxMTU</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">.</span><span class="n">maxMTU</span><span class="p">),</span>
	       <span class="n">ntohl</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">.</span><span class="n">rwind</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">.</span><span class="n">jumbo_max</span><span class="p">));</span>

	<span class="n">mtu</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">.</span><span class="n">rxMTU</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">.</span><span class="n">maxMTU</span><span class="p">));</span>

	<span class="n">peer</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">maxdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">peer</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
		<span class="n">peer</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span> <span class="o">+</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">hdrsize</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">_net</span><span class="p">(</span><span class="s">&quot;Net MTU %u (maxdata %u)&quot;</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">maxdata</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process packets in the reception queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxrpc_process_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="o">*</span><span class="n">_abort_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_ackpacket</span> <span class="n">ack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">post_ACK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">latest</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hard</span><span class="p">,</span> <span class="n">tx</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

<span class="nl">process_further:</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">_net</span><span class="p">(</span><span class="s">&quot;deferred skb %p&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;process %s [st %d]&quot;</span><span class="p">,</span> <span class="n">rxrpc_pkts</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">],</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">post_ACK</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* data packets that wind up here have been received out of</span>
<span class="cm">		 * order, need security processing or are jumbo packets */</span>
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_DATA</span>:
		<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;OOSQ DATA %%%u { #%u }&quot;</span><span class="p">,</span>
		       <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">));</span>

		<span class="cm">/* secured packets must be verified and possibly decrypted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_verify_packet</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">_abort_code</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">protocol_error</span><span class="p">;</span>

		<span class="n">rxrpc_insert_oos_packet</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">process_further</span><span class="p">;</span>

		<span class="cm">/* partial ACK to process */</span>
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ack</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extraction failure&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">protocol_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ack</span><span class="p">)))</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">latest</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span><span class="p">);</span>
		<span class="n">hard</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">firstPacket</span><span class="p">);</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>

		<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Rx ACK %%%u { m=%hu f=#%u p=#%u s=%%%u r=%s n=%u }&quot;</span><span class="p">,</span>
		       <span class="n">latest</span><span class="p">,</span>
		       <span class="n">ntohs</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">maxSkew</span><span class="p">),</span>
		       <span class="n">hard</span><span class="p">,</span>
		       <span class="n">ntohl</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">previousPacket</span><span class="p">),</span>
		       <span class="n">ntohl</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">serial</span><span class="p">),</span>
		       <span class="n">rxrpc_acks</span><span class="p">[</span><span class="n">ack</span><span class="p">.</span><span class="n">reason</span><span class="p">],</span>
		       <span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span><span class="p">);</span>

		<span class="n">rxrpc_extract_ackinfo</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">latest</span><span class="p">,</span> <span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">RXRPC_ACK_PING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Rx ACK %%%u PING Request&quot;</span><span class="p">,</span> <span class="n">latest</span><span class="p">);</span>
			<span class="n">rxrpc_propose_ACK</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">RXRPC_ACK_PING_RESPONSE</span><span class="p">,</span>
					  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* discard any out-of-order or duplicate ACKs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">latest</span> <span class="o">-</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_latest</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;discard ACK %d &lt;= %d&quot;</span><span class="p">,</span>
			       <span class="n">latest</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_latest</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_latest</span> <span class="o">=</span> <span class="n">latest</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RXRPC_CALL_CLIENT_SEND_REQUEST</span> <span class="o">&amp;&amp;</span>
		    <span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RXRPC_CALL_CLIENT_AWAIT_REPLY</span> <span class="o">&amp;&amp;</span>
		    <span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RXRPC_CALL_SERVER_SEND_REPLY</span> <span class="o">&amp;&amp;</span>
		    <span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RXRPC_CALL_SERVER_AWAIT_ACK</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;Tx=%d H=%u S=%d&quot;</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_hard</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hard</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hard</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;hard-ACK&#39;d packet %d not transmitted&quot;</span>
				       <span class="s">&quot; (%d top)&quot;</span><span class="p">,</span>
				       <span class="n">hard</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">protocol_error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RXRPC_CALL_CLIENT_AWAIT_REPLY</span> <span class="o">||</span>
			     <span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RXRPC_CALL_SERVER_AWAIT_ACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hard</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">all_acked</span><span class="p">;</span>

			<span class="n">smp_rmb</span><span class="p">();</span>
			<span class="n">rxrpc_rotate_tx_window</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">hard</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hard</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;soft-ACK&#39;d packet %d+%d not&quot;</span>
				       <span class="s">&quot; transmitted (%d top)&quot;</span><span class="p">,</span>
				       <span class="n">hard</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">protocol_error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_process_soft_ACKs</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">protocol_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>

		<span class="cm">/* complete ACK to process */</span>
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_ACKALL</span>:
		<span class="k">goto</span> <span class="n">all_acked</span><span class="p">;</span>

		<span class="cm">/* abort and busy are handled elsewhere */</span>
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_BUSY</span>:
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_ABORT</span>:
		<span class="n">BUG</span><span class="p">();</span>

		<span class="cm">/* connection level events - also handled elsewhere */</span>
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_CHALLENGE</span>:
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_RESPONSE</span>:
	<span class="k">case</span> <span class="n">RXRPC_PACKET_TYPE_DEBUG</span>:
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* if we&#39;ve had a hard ACK that covers all the packets we&#39;ve sent, then</span>
<span class="cm">	 * that ends that phase of the operation */</span>
<span class="nl">all_acked:</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;ack all %d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RXRPC_CALL_CLIENT_AWAIT_REPLY</span>:
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RXRPC_CALL_CLIENT_RECV_REPLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RXRPC_CALL_SERVER_AWAIT_ACK</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;srv complete&quot;</span><span class="p">);</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">;</span>
		<span class="n">post_ACK</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RXRPC_CALL_CLIENT_SEND_REQUEST</span>:
	<span class="k">case</span> <span class="n">RXRPC_CALL_SERVER_RECV_REQUEST</span>:
		<span class="k">goto</span> <span class="n">protocol_error_unlock</span><span class="p">;</span> <span class="cm">/* can&#39;t occur yet */</span>
	<span class="nl">default:</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span> <span class="cm">/* assume packet left over from earlier phase */</span>
	<span class="p">}</span>

	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>

	<span class="cm">/* if all the packets we sent are hard-ACK&#39;d, then we can discard</span>
<span class="cm">	 * whatever we&#39;ve got left */</span>
	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;clear Tx %d&quot;</span><span class="p">,</span>
	       <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_head</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_tail</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_winsz</span><span class="p">));</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">resend_timer</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RUN_RTIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RESEND_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">acks_window</span><span class="p">)</span>
		<span class="n">rxrpc_zap_tx_window</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* post the final ACK message for userspace to pick up */</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;post ACK&quot;</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">=</span> <span class="n">RXRPC_SKB_MARK_FINAL_ACK</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="p">;</span>
		<span class="n">rxrpc_get_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_queue_rcv_skb</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">process_further</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">discard:</span>
	<span class="n">rxrpc_free_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">process_further</span><span class="p">;</span>

<span class="nl">protocol_error_unlock:</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
<span class="nl">protocol_error:</span>
	<span class="n">rxrpc_free_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = -EPROTO&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * post a message to the socket Rx queue for recvmsg() to pick up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxrpc_post_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mark</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">fatal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_skb_priv</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%d,%lx},%u,%u,%d&quot;</span><span class="p">,</span>
	       <span class="n">call</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">fatal</span><span class="p">);</span>

	<span class="cm">/* remove timers and things for fatal messages */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fatal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">resend_timer</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RUN_RTIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">!=</span> <span class="n">RXRPC_SKB_MARK_NEW_CALL</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_HAS_USERID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;[no userid]&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_TERMINAL_MSG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">rxrpc_new_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">=</span> <span class="n">mark</span><span class="p">;</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="n">rxrpc_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">));</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="p">;</span>
		<span class="n">rxrpc_get_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rxrpc_queue_rcv_skb</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">fatal</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle background processing of incoming call packets and ACK / abort</span>
<span class="cm"> * generation</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rxrpc_process_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxrpc_call</span> <span class="o">*</span><span class="n">call</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rxrpc_call</span><span class="p">,</span> <span class="n">processor</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rxrpc_ackpacket</span> <span class="n">ack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxrpc_ackinfo</span> <span class="n">ackinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxrpc_header</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">data</span><span class="p">,</span> <span class="n">pad</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">genbit</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">nbit</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">abort_code</span> <span class="o">=</span> <span class="n">RX_PROTOCOL_ERROR</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">acks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>printk("\n--------------------\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%d,%s,%lx} [%lu]&quot;</span><span class="p">,</span>
	       <span class="n">call</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">rxrpc_call_states</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">],</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">creation_jif</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_PROC_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;XXXXXXXXXXXXX RUNNING ON MULTIPLE CPUS XXXXXXXXXXXXX&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* there&#39;s a good chance we&#39;re going to have to send a message, so set</span>
<span class="cm">	 * one up in advance */</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">srx</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">sin</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_namelen</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">srx</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">sin</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">epoch</span>	<span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">cid</span>		<span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">callNumber</span>	<span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">seq</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">RXRPC_PACKET_TYPE_ACK</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">out_clientflag</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">userStatus</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">securityIndex</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_ix</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">_rsvd</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">serviceId</span>	<span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">service_id</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iov</span><span class="p">));</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>

	<span class="cm">/* deal with events of a final nature */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RELEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rxrpc_release_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RELEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RCVD_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_CONN_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_REJECT_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">net_error</span><span class="p">;</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;post net error %d&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_post_message</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">RXRPC_SKB_MARK_NET_ERROR</span><span class="p">,</span>
				       <span class="n">error</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RCVD_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">kill_ACKs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_CONN_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_REJECT_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;post conn abort&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_post_message</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">RXRPC_SKB_MARK_LOCAL_ERROR</span><span class="p">,</span>
				       <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_CONN_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">kill_ACKs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_REJECT_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RXRPC_PACKET_TYPE_BUSY</span><span class="p">;</span>
		<span class="n">genbit</span> <span class="o">=</span> <span class="n">RXRPC_CALL_REJECT_BUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_message</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_post_message</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">RXRPC_SKB_MARK_LOCAL_ERROR</span><span class="p">,</span>
				       <span class="n">ECONNABORTED</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RXRPC_PACKET_TYPE_ABORT</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">abort_code</span><span class="p">);</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">genbit</span> <span class="o">=</span> <span class="n">RXRPC_CALL_ABORT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_message</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ACK_FINAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">genbit</span> <span class="o">=</span> <span class="n">RXRPC_CALL_ACK_FINAL</span><span class="p">;</span>

		<span class="n">ack</span><span class="p">.</span><span class="n">bufferSpace</span>	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">maxSkew</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">serial</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">reason</span>	<span class="o">=</span> <span class="n">RXRPC_ACK_IDLE</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_serial</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">previousPacket</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_prev_seq</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">firstPacket</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_eaten</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ack</span><span class="p">);</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pad</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ackinfo</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">send_ACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RXRPC_CALL_RCVD_BUSY</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RXRPC_CALL_RCVD_ABORT</span><span class="p">))</span>
	    <span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mark</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RCVD_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span>
			<span class="n">mark</span> <span class="o">=</span> <span class="n">RXRPC_SKB_MARK_REMOTE_ABORT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mark</span> <span class="o">=</span> <span class="n">RXRPC_SKB_MARK_BUSY</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;post abort/busy&quot;</span><span class="p">);</span>
		<span class="n">rxrpc_clear_tx_window</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_post_message</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">ECONNABORTED</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RCVD_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RCVD_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">kill_ACKs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RCVD_ACKALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;do implicit ackall&quot;</span><span class="p">);</span>
		<span class="n">rxrpc_clear_tx_window</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_LIFE_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RXRPC_CALL_LOCALLY_ABORTED</span><span class="p">;</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">abort_code</span> <span class="o">=</span> <span class="n">RX_CALL_TIMEOUT</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;post timeout&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_post_message</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">RXRPC_SKB_MARK_LOCAL_ERROR</span><span class="p">,</span>
				       <span class="n">ETIME</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_LIFE_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">kill_ACKs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* deal with assorted inbound messages */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rxrpc_process_rx_queue</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abort_code</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EKEYREJECTED</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EPROTO</span>:
			<span class="n">rxrpc_abort_call</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">abort_code</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">kill_ACKs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* handle resending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RESEND_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span>
		<span class="n">rxrpc_resend_timer</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RESEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span>
		<span class="n">rxrpc_resend</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>

	<span class="cm">/* consider sending an ordinary ACK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;send ACK: window: %d - %d { %lx }&quot;</span><span class="p">,</span>
		       <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_eaten</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_win_top</span><span class="p">,</span>
		       <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">RXRPC_CALL_SERVER_ACK_REQUEST</span> <span class="o">&amp;&amp;</span>
		    <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span> <span class="o">!=</span> <span class="n">RXRPC_ACK_PING_RESPONSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ACK by sending reply DATA packet in this state */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">maybe_reschedule</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">genbit</span> <span class="o">=</span> <span class="n">RXRPC_CALL_ACK</span><span class="p">;</span>

		<span class="n">acks</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_win_top</span> <span class="o">-</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_eaten</span><span class="p">,</span>
			       <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acks</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>hdr.flags    = RXRPC<em>SLOW</em>START_OK;</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ack</span><span class="p">.</span><span class="n">bufferSpace</span>	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">maxSkew</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">serial</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">reason</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_serial</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">previousPacket</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_prev_seq</span><span class="p">;</span>
		<span class="n">ack</span><span class="p">.</span><span class="n">firstPacket</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_eaten</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">RXRPC_ACKR_WINDOW_ASZ</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nbit</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bits</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_window</span><span class="p">[</span><span class="n">loop</span><span class="p">];</span> <span class="n">bits</span><span class="p">;</span> <span class="n">bits</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
			     <span class="p">)</span> <span class="p">{</span>
				<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;- l=%d n=%d b=%lx&quot;</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">nbit</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">acks</span><span class="p">[</span><span class="n">nbit</span><span class="p">]</span> <span class="o">=</span> <span class="n">RXRPC_ACK_TYPE_ACK</span><span class="p">;</span>
					<span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span> <span class="o">=</span> <span class="n">nbit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">nbit</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ack</span><span class="p">);</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">acks</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pad</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ackinfo</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">iov_len</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ackinfo</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RXRPC_ACK_REQUESTED</span>:
		<span class="k">case</span> <span class="n">RXRPC_ACK_DUPLICATE</span>:
		<span class="k">case</span> <span class="n">RXRPC_ACK_OUT_OF_SEQUENCE</span>:
		<span class="k">case</span> <span class="n">RXRPC_ACK_EXCEEDS_WINDOW</span>:
		<span class="k">case</span> <span class="n">RXRPC_ACK_NOSPACE</span>:
		<span class="k">case</span> <span class="n">RXRPC_ACK_PING</span>:
		<span class="k">case</span> <span class="n">RXRPC_ACK_PING_RESPONSE</span>:
			<span class="k">goto</span> <span class="n">send_ACK_with_skew</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RXRPC_ACK_DELAY</span>:
		<span class="k">case</span> <span class="n">RXRPC_ACK_IDLE</span>:
			<span class="k">goto</span> <span class="n">send_ACK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* handle completion of security negotiations on an incoming</span>
<span class="cm">	 * connection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_SECURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;secured&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RXRPC_CALL_SERVER_SECURING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;securing&quot;</span><span class="p">);</span>
			<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RELEASED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RELEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;not released&quot;</span><span class="p">);</span>
				<span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RXRPC_CALL_SERVER_ACCEPTING</span><span class="p">;</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">accept_link</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">acceptq</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_POST_ACCEPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
			<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_POST_ACCEPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">maybe_reschedule</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* post a notification of an acceptable connection to the app */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_POST_ACCEPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;post accept&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_post_message</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">RXRPC_SKB_MARK_NEW_CALL</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_POST_ACCEPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">maybe_reschedule</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle incoming call acceptance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ACCEPTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;accepted&quot;</span><span class="p">);</span>
		<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_post</span><span class="p">,</span> <span class="o">==</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_DRAIN_RX_OOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* drain the out of sequence received packet queue into the packet Rx</span>
<span class="cm">	 * queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_DRAIN_RX_OOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_data_post</span> <span class="o">==</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_first_oos</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxrpc_drain_rx_oos_queue</span><span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">maybe_reschedule</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* other events may have been raised since we started checking */</span>
	<span class="k">goto</span> <span class="n">maybe_reschedule</span><span class="p">;</span>

<span class="nl">send_ACK_with_skew:</span>
	<span class="n">ack</span><span class="p">.</span><span class="n">maxSkew</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hi_serial</span><span class="p">)</span> <span class="o">-</span>
			    <span class="n">ntohl</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">serial</span><span class="p">));</span>
<span class="nl">send_ACK:</span>
	<span class="n">mtu</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">if_mtu</span><span class="p">;</span>
	<span class="n">mtu</span> <span class="o">-=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">hdrsize</span><span class="p">;</span>
	<span class="n">ackinfo</span><span class="p">.</span><span class="n">maxMTU</span>	<span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">mtu</span><span class="p">);</span>
	<span class="n">ackinfo</span><span class="p">.</span><span class="n">rwind</span>	<span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* permit the peer to send us jumbo packets if it wants to */</span>
	<span class="n">ackinfo</span><span class="p">.</span><span class="n">rxMTU</span>	<span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">5692</span><span class="p">);</span>
	<span class="n">ackinfo</span><span class="p">.</span><span class="n">jumbo_max</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">));</span>
	<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Tx ACK %%%u { m=%hu f=#%u p=#%u s=%%%u r=%s n=%u }&quot;</span><span class="p">,</span>
	       <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span><span class="p">),</span>
	       <span class="n">ntohs</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">maxSkew</span><span class="p">),</span>
	       <span class="n">ntohl</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">firstPacket</span><span class="p">),</span>
	       <span class="n">ntohl</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">previousPacket</span><span class="p">),</span>
	       <span class="n">ntohl</span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">serial</span><span class="p">),</span>
	       <span class="n">rxrpc_acks</span><span class="p">[</span><span class="n">ack</span><span class="p">.</span><span class="n">reason</span><span class="p">],</span>
	       <span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">nAcks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_TX_SOFT_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">send_message_2</span><span class="p">;</span>

<span class="nl">send_message:</span>
	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;send message&quot;</span><span class="p">);</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">));</span>
	<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Tx %s %%%u&quot;</span><span class="p">,</span> <span class="n">rxrpc_pkts</span><span class="p">[</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">],</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">serial</span><span class="p">));</span>
<span class="nl">send_message_2:</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kernel_sendmsg</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;sendmsg failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">RXRPC_CALL_DEAD</span><span class="p">)</span>
			<span class="n">rxrpc_queue_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">genbit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RXRPC_CALL_ABORT</span>:
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">genbit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RCVD_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">kill_ACKs</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RXRPC_CALL_ACK_FINAL</span>:
		<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RXRPC_CALL_CLIENT_FINAL_ACK</span><span class="p">)</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RXRPC_CALL_COMPLETE</span><span class="p">;</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">kill_ACKs</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">genbit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RXRPC_CALL_CLIENT_AWAIT_REPLY</span>:
		<span class="k">case</span> <span class="n">RXRPC_CALL_CLIENT_RECV_REPLY</span>:
		<span class="k">case</span> <span class="n">RXRPC_CALL_SERVER_RECV_REQUEST</span>:
		<span class="k">case</span> <span class="n">RXRPC_CALL_SERVER_ACK_REQUEST</span>:
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;start ACK timer&quot;</span><span class="p">);</span>
			<span class="n">rxrpc_propose_ACK</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">RXRPC_ACK_DELAY</span><span class="p">,</span>
					  <span class="n">call</span><span class="o">-&gt;</span><span class="n">ackr_serial</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">maybe_reschedule</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">kill_ACKs:</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ACK_FINAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span>
		<span class="n">rxrpc_put_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

<span class="nl">maybe_reschedule:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">RXRPC_CALL_DEAD</span><span class="p">)</span>
			<span class="n">rxrpc_queue_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t leave aborted connections on the accept queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">RXRPC_CALL_COMPLETE</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">accept_link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;X unlinking once-pending call %p { e=%lx f=%lx c=%x }&quot;</span><span class="p">,</span>
		       <span class="n">call</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		       <span class="n">ntohl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">));</span>

		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RELEASED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_RELEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span>
			<span class="n">rxrpc_queue_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RXRPC_CALL_PROC_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acks</span><span class="p">);</span>

	<span class="cm">/* because we don&#39;t want two CPUs both processing the work item for one</span>
<span class="cm">	 * call at the same time, we use a flag to note when it&#39;s busy; however</span>
<span class="cm">	 * this means there&#39;s a race between clearing the flag and setting the</span>
<span class="cm">	 * work pending bit and the work item being processed again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;jumpstart %x&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">));</span>
		<span class="n">rxrpc_queue_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">no_mem:</span>
	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;out of memory&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">maybe_reschedule</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
