<!DOCTYPE html>
<html><head><title>joekychen/linux » net › wanrouter › wanproc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>wanproc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm">* wanproc.c	WAN Router Module. /proc filesystem interface.</span>
<span class="cm">*</span>
<span class="cm">*		This module is completely hardware-independent and provides</span>
<span class="cm">*		access to the router using Linux /proc filesystem.</span>
<span class="cm">*</span>
<span class="cm">* Author: 	Gideon Hack</span>
<span class="cm">*</span>
<span class="cm">* Copyright:	(c) 1995-1999 Sangoma Technologies Inc.</span>
<span class="cm">*</span>
<span class="cm">*		This program is free software; you can redistribute it and/or</span>
<span class="cm">*		modify it under the terms of the GNU General Public License</span>
<span class="cm">*		as published by the Free Software Foundation; either version</span>
<span class="cm">*		2 of the License, or (at your option) any later version.</span>
<span class="cm">* ============================================================================</span>
<span class="cm">* Jun 02, 1999  Gideon Hack	Updates for Linux 2.2.X kernels.</span>
<span class="cm">* Jun 29, 1997	Alan Cox	Merged with 1.0.3 vendor code</span>
<span class="cm">* Jan 29, 1997	Gene Kozin	v1.0.1. Implemented /proc read routines</span>
<span class="cm">* Jan 30, 1997	Alan Cox	Hacked around for 2.1</span>
<span class="cm">* Dec 13, 1996	Gene Kozin	Initial version (based on Sangoma&#39;s WANPIPE)</span>
<span class="cm">*****************************************************************************/</span>

<span class="cp">#include &lt;linux/init.h&gt;		</span><span class="cm">/* __initfunc et al. */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/stddef.h&gt;	</span><span class="cm">/* offsetof(), etc. */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/errno.h&gt;	</span><span class="cm">/* return codes */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/wanrouter.h&gt;	</span><span class="cm">/* WAN router API definitions */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#define PROC_STATS_FORMAT &quot;%30s: %12lu\n&quot;</span>

<span class="cm">/****** Defines and Macros **************************************************/</span>

<span class="cp">#define PROT_DECODE(prot) ((prot == WANCONFIG_FR) ? &quot; FR&quot; :\</span>
<span class="cp">			      (prot == WANCONFIG_X25) ? &quot; X25&quot; : \</span>
<span class="cp">				 (prot == WANCONFIG_PPP) ? &quot; PPP&quot; : \</span>
<span class="cp">				    (prot == WANCONFIG_CHDLC) ? &quot; CHDLC&quot;: \</span>
<span class="cp">				       (prot == WANCONFIG_MPPP) ? &quot; MPPP&quot; : \</span>
<span class="cp">					   &quot; Unknown&quot; )</span>

<span class="cm">/****** Function Prototypes *************************************************/</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="cm">/* Miscellaneous */</span>

<span class="cm">/*</span>
<span class="cm"> *	Structures for interfacing with the /proc filesystem.</span>
<span class="cm"> *	Router creates its own directory /proc/net/router with the following</span>
<span class="cm"> *	entries:</span>
<span class="cm"> *	config		device configuration</span>
<span class="cm"> *	status		global device statistics</span>
<span class="cm"> *	&lt;device&gt;	entry for each WAN device</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	Generic /proc/net/router/&lt;file&gt; file and inode operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	/proc/net/router</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">config_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_router</span><span class="p">;</span>

<span class="cm">/* Strings */</span>

<span class="cm">/*</span>
<span class="cm"> *	Interface functions</span>
<span class="cm"> */</span>

<span class="cm">/****** Proc filesystem entry points ****************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *	Iterator</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">r_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">wandev</span> <span class="o">=</span> <span class="n">wanrouter_router_devlist</span><span class="p">;</span> <span class="n">l</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">wandev</span><span class="p">;</span>
	     <span class="n">wandev</span> <span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">return</span> <span class="n">wandev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">r_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="o">?</span> <span class="n">wanrouter_router_devlist</span> <span class="o">:</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Device name    | port |IRQ|DMA|  mem.addr  |&quot;</span>
			    <span class="s">&quot;mem.size|option1|option2|option3|option4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-15s|0x%-4X|%3u|%3u| 0x%-8lX |0x%-6X|%7u|%7u|%7u|%7u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">hw_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hw_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hw_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hw_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">status_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Device name    |protocol|station|interface|&quot;</span>
			    <span class="s">&quot;clocking|baud rate| MTU |ndev|link state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-15s|%-8s| %-7s| %-9s|%-8s|%9u|%5u|%3u |&quot;</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">PROT_DECODE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">config_id</span><span class="p">),</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">config_id</span> <span class="o">==</span> <span class="n">WANCONFIG_FR</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">station</span> <span class="o">?</span> <span class="s">&quot;Node&quot;</span> <span class="o">:</span> <span class="s">&quot;CPE&quot;</span><span class="p">)</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">config_id</span> <span class="o">==</span> <span class="n">WANCONFIG_X25</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">station</span> <span class="o">?</span> <span class="s">&quot;DCE&quot;</span> <span class="o">:</span> <span class="s">&quot;DTE&quot;</span><span class="p">)</span> <span class="o">:</span>
			<span class="p">(</span><span class="s">&quot;N/A&quot;</span><span class="p">)),</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">?</span> <span class="s">&quot;V.35&quot;</span> <span class="o">:</span> <span class="s">&quot;RS-232&quot;</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">clocking</span> <span class="o">?</span> <span class="s">&quot;internal&quot;</span> <span class="o">:</span> <span class="s">&quot;external&quot;</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">bps</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WAN_UNCONFIGURED</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-12s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;unconfigured&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WAN_DISCONNECTED</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-12s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;disconnected&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WAN_CONNECTING</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-12s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;connecting&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WAN_CONNECTED</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-12s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;connected&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-12s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;invalid&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">config_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">r_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">r_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">r_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">config_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">status_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">r_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">r_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">r_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">status_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">status_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">config_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">config_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">status_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">status_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wandev_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">ROUTER_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;device is not configured!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update device statistics */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">wandev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Device is busy!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Device is not configured!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;total packets received&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;total packets transmitted&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;total bytes received&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;total bytes transmitted&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;bad packets received&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;packet transmit problems&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;received frames dropped&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;transmit frames dropped&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;multicast packets received&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;transmit collisions&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;receive length errors&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;receiver overrun errors&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;CRC errors&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;frame format errors (aborts)&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;receiver fifo overrun&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;receiver missed packet&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PROC_STATS_FORMAT</span><span class="p">,</span>
		<span class="s">&quot;aborted frames transmitted&quot;</span><span class="p">,</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wandev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">wandev_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">wandev_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">wandev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>  <span class="o">=</span> <span class="n">wanrouter_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Initialize router proc interface.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">wanrouter_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">proc_router</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">ROUTER_NAME</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_router</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">proc_router</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_config</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">proc_router</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_stat</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_stat:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span> <span class="n">proc_router</span><span class="p">);</span>
<span class="nl">fail_config:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">ROUTER_NAME</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Clean up router proc interface.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">wanrouter_proc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span> <span class="n">proc_router</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="n">proc_router</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">ROUTER_NAME</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Add directory entry for WAN device.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">wanrouter_proc_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span><span class="o">*</span> <span class="n">wandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">ROUTER_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wandev</span><span class="o">-&gt;</span><span class="n">dent</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">proc_router</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wandev_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">wandev</span><span class="o">-&gt;</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">data</span>	<span class="o">=</span> <span class="n">wandev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Delete directory entry for WAN device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wanrouter_proc_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span><span class="o">*</span> <span class="n">wandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">ROUTER_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">proc_router</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cm">/*</span>
<span class="cm"> *	No /proc - output stubs</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">wanrouter_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wanrouter_proc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wanrouter_proc_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wanrouter_proc_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	End</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
