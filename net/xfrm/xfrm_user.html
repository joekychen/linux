<!DOCTYPE html>
<html><head><title>joekychen/linux » net › xfrm › xfrm_user.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfrm_user.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* xfrm_user.c: User interface to configure xfrm engine.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002 David S. Miller (davem@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:</span>
<span class="cm"> *	Mitsuru KANDA @USAGI</span>
<span class="cm"> * 	Kazunori MIYAZAWA @USAGI</span>
<span class="cm"> * 	Kunihiro Ishiguro &lt;kunihiro@ipinfusion.com&gt;</span>
<span class="cm"> * 		IPv6 support</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/pfkeyv2.h&gt;</span>
<span class="cp">#include &lt;linux/ipsec.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/xfrm.h&gt;</span>
<span class="cp">#include &lt;net/netlink.h&gt;</span>
<span class="cp">#include &lt;net/ah.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">aead_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo_aead</span> <span class="o">*</span><span class="n">alg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">alg</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_one_alg</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">,</span> <span class="k">enum</span> <span class="n">xfrm_attr_type_t</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_algo</span> <span class="o">*</span><span class="n">algp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">algp</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">xfrm_alg_len</span><span class="p">(</span><span class="n">algp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRMA_ALG_AUTH</span>:
	<span class="k">case</span> <span class="n">XFRMA_ALG_CRYPT</span>:
	<span class="k">case</span> <span class="n">XFRMA_ALG_COMP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">algp</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_auth_trunc</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_auth</span> <span class="o">*</span><span class="n">algp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">algp</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">xfrm_alg_auth_len</span><span class="p">(</span><span class="n">algp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">algp</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_aead</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_aead</span> <span class="o">*</span><span class="n">algp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">algp</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">aead_len</span><span class="p">(</span><span class="n">algp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">algp</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">verify_one_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">,</span> <span class="k">enum</span> <span class="n">xfrm_attr_type_t</span> <span class="n">type</span><span class="p">,</span>
			   <span class="n">xfrm_address_t</span> <span class="o">**</span><span class="n">addrp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">&amp;&amp;</span> <span class="n">addrp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">addrp</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">verify_sec_ctx_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">uctx</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">verify_replay</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_REPLAY_ESN_VAL</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFRM_STATE_ESN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">IPPROTO_ESP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replay_window</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_newsa_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AF_INET6</span>:
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPPROTO_AH</span>:
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH</span><span class="p">]</span>	<span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">])</span> <span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_CRYPT</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_COMP</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TFCPAD</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPPROTO_ESP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_COMP</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_CRYPT</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH</span><span class="p">]</span> <span class="o">||</span>
		     <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">]</span> <span class="o">||</span>
		     <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_CRYPT</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TFCPAD</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">XFRM_MODE_TUNNEL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPPROTO_COMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_COMP</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_CRYPT</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TFCPAD</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">IPPROTO_DSTOPTS</span>:
	<span class="k">case</span> <span class="n">IPPROTO_ROUTING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_COMP</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_CRYPT</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ENCAP</span><span class="p">]</span>		<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">]</span>	<span class="o">||</span>
		    <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TFCPAD</span><span class="p">]</span>		<span class="o">||</span>
		    <span class="o">!</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_COADDR</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">verify_aead</span><span class="p">(</span><span class="n">attrs</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">verify_auth_trunc</span><span class="p">(</span><span class="n">attrs</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">verify_one_alg</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">XFRMA_ALG_AUTH</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">verify_one_alg</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">XFRMA_ALG_CRYPT</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">verify_one_alg</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">XFRMA_ALG_COMP</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">verify_sec_ctx_len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">verify_replay</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MODE_TRANSPORT</span>:
	<span class="k">case</span> <span class="n">XFRM_MODE_TUNNEL</span>:
	<span class="k">case</span> <span class="n">XFRM_MODE_ROUTEOPTIMIZATION</span>:
	<span class="k">case</span> <span class="n">XFRM_MODE_BEET</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">attach_one_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo</span> <span class="o">**</span><span class="n">algpp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_byname</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">),</span>
			   <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_algo</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">ualg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">algo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rta</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ualg</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rta</span><span class="p">);</span>

	<span class="n">algo</span> <span class="o">=</span> <span class="n">get_byname</span><span class="p">(</span><span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">algo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">props</span> <span class="o">=</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">ualg</span><span class="p">,</span> <span class="n">xfrm_alg_len</span><span class="p">(</span><span class="n">ualg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="o">*</span><span class="n">algpp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">attach_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo_auth</span> <span class="o">**</span><span class="n">algpp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_algo</span> <span class="o">*</span><span class="n">ualg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_auth</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">algo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rta</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ualg</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rta</span><span class="p">);</span>

	<span class="n">algo</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byname</span><span class="p">(</span><span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">algo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">props</span> <span class="o">=</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">=</span> <span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_trunc_len</span> <span class="o">=</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">icv_truncbits</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span> <span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span> <span class="p">(</span><span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="o">*</span><span class="n">algpp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">attach_auth_trunc</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo_auth</span> <span class="o">**</span><span class="n">algpp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_auth</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">ualg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">algo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rta</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ualg</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rta</span><span class="p">);</span>

	<span class="n">algo</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byname</span><span class="p">(</span><span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">algo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_trunc_len</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_AH_AUTH_LEN</span> <span class="o">||</span>
	    <span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_trunc_len</span> <span class="o">&gt;</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">icv_fullbits</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">props</span> <span class="o">=</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">ualg</span><span class="p">,</span> <span class="n">xfrm_alg_auth_len</span><span class="p">(</span><span class="n">ualg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_trunc_len</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_trunc_len</span> <span class="o">=</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">icv_truncbits</span><span class="p">;</span>

	<span class="o">*</span><span class="n">algpp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">attach_aead</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo_aead</span> <span class="o">**</span><span class="n">algpp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_aead</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">ualg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">algo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rta</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ualg</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rta</span><span class="p">);</span>

	<span class="n">algo</span> <span class="o">=</span> <span class="n">xfrm_aead_get_byname</span><span class="p">(</span><span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">ualg</span><span class="o">-&gt;</span><span class="n">alg_icv_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">algo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">props</span> <span class="o">=</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">ualg</span><span class="p">,</span> <span class="n">aead_len</span><span class="p">(</span><span class="n">ualg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">algo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="o">*</span><span class="n">algpp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfrm_replay_verify_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_replay_state_esn</span> <span class="o">*</span><span class="n">replay_esn</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_replay_state_esn</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">replay_esn</span> <span class="o">||</span> <span class="o">!</span><span class="n">rp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">up</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">replay_esn</span><span class="p">)</span> <span class="o">!=</span>
			<span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">up</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_alloc_replay_state_esn</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_replay_state_esn</span> <span class="o">**</span><span class="n">replay_esn</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">xfrm_replay_state_esn</span> <span class="o">**</span><span class="n">preplay_esn</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_replay_state_esn</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rta</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">up</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rta</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">up</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">up</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">replay_esn</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="o">*</span><span class="n">preplay_esn</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfrm_user_sec_ctx_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">xfrm_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_from_user_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">));</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">replay_window</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">replay_window</span><span class="p">;</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">;</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">));</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFRM_STATE_AF_UNSPEC</span><span class="p">))</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * someday when pfkey also has support, we could have the code</span>
<span class="cm"> * somehow made shareable and move it to xfrm_state.c - JHS</span>
<span class="cm"> *</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xfrm_update_ae_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_REPLAY_VAL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">re</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_REPLAY_ESN_VAL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">lt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_LTIME_VAL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">et</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ETIMER_THRESH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_REPLAY_THRESH</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_replay_state_esn</span> <span class="o">*</span><span class="n">replay_esn</span><span class="p">;</span>
		<span class="n">replay_esn</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">re</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">,</span> <span class="n">replay_esn</span><span class="p">,</span>
		       <span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">replay_esn</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">preplay_esn</span><span class="p">,</span> <span class="n">replay_esn</span><span class="p">,</span>
		       <span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">replay_esn</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_replay_state</span> <span class="o">*</span><span class="n">replay</span><span class="p">;</span>
		<span class="n">replay</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">,</span> <span class="n">replay</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">replay</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">preplay</span><span class="p">,</span> <span class="n">replay</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">replay</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_lifetime_cur</span> <span class="o">*</span><span class="n">ltime</span><span class="p">;</span>
		<span class="n">ltime</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">lt</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ltime</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">packets</span> <span class="o">=</span> <span class="n">ltime</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">add_time</span> <span class="o">=</span> <span class="n">ltime</span><span class="o">-&gt;</span><span class="n">add_time</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">use_time</span> <span class="o">=</span> <span class="n">ltime</span><span class="o">-&gt;</span><span class="n">use_time</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">et</span><span class="p">)</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_maxage</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">et</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_maxdiff</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="nf">xfrm_state_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="o">*</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_no_put</span><span class="p">;</span>

	<span class="n">copy_from_user_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">attach_aead</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">ealgo</span><span class="p">,</span>
			       <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">])))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">attach_auth_trunc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">aalgo</span><span class="p">,</span>
				     <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">])))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">aalgo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">attach_auth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">aalgo</span><span class="p">,</span>
				       <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_AUTH</span><span class="p">])))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">attach_one_algo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">ealgo</span><span class="p">,</span>
				   <span class="n">xfrm_ealg_get_byname</span><span class="p">,</span>
				   <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_CRYPT</span><span class="p">])))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">attach_one_algo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">calgo</span><span class="p">,</span>
				   <span class="n">xfrm_calg_get_byname</span><span class="p">,</span>
				   <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ALG_COMP</span><span class="p">])))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ENCAP</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_ENCAP</span><span class="p">]),</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TFCPAD</span><span class="p">])</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">tfcpad</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TFCPAD</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_COADDR</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_COADDR</span><span class="p">]),</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__xfrm_init_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">security_xfrm_state_alloc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">])))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_alloc_replay_state_esn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">preplay_esn</span><span class="p">,</span>
					       <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_REPLAY_ESN_VAL</span><span class="p">])))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_maxdiff</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">sysctl_aevent_rseqth</span><span class="p">;</span>
	<span class="cm">/* sysctl_xfrm_aevent_etime is in 100ms units */</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_maxage</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">sysctl_aevent_etime</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="n">XFRM_AE_ETH_M</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_init_replay</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* override default values from above */</span>
	<span class="n">xfrm_update_ae_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFRM_STATE_DEAD</span><span class="p">;</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="nl">error_no_put:</span>
	<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_add_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_newsa_info</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_construct</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">xfrm_state_hold</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span> <span class="o">==</span> <span class="n">XFRM_MSG_NEWSA</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_update</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
	<span class="n">xfrm_audit_state_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loginuid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFRM_STATE_DEAD</span><span class="p">;</span>
		<span class="n">__xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>

	<span class="n">km_state_notify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="nf">xfrm_user_state_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">xfrm_usersa_id</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="o">*</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_id_proto_match</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">IPSEC_PROTO_ANY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">saddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">verify_one_addr</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">XFRMA_SRCADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_lookup_byaddr</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span>
					     <span class="n">p</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">errp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_del_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_id</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">uid_t</span> <span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_user_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">security_xfrm_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_state_kern</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>
	<span class="n">km_state_notify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
	<span class="n">xfrm_audit_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loginuid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_to_user_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">replay_window</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">replay_window</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">reqid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">seq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">xfrm_dump_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">in_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nlmsg_flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_sec_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctx_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">;</span>

	<span class="n">attr</span> <span class="o">=</span> <span class="n">nla_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_SEC_CTX</span><span class="p">,</span> <span class="n">ctx_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">uctx</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">exttype</span> <span class="o">=</span> <span class="n">XFRMA_SEC_CTX</span><span class="p">;</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ctx_size</span><span class="p">;</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_doi</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ctx_doi</span><span class="p">;</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_alg</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ctx_alg</span><span class="p">;</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">uctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ctx_str</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_to_user_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_algo</span> <span class="o">*</span><span class="n">algo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_ALG_AUTH</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">algo</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nla</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">algo</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">algo</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">algo</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span> <span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">algo</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">=</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Don&#39;t change this without updating xfrm_sa_len! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_to_user_state_extra</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">copy_to_user_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_COADDR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span><span class="p">),</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lastused</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_LASTUSED</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">lastused</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aead</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_ALG_AEAD</span><span class="p">,</span> <span class="n">aead_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aead</span><span class="p">),</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">aead</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">copy_to_user_auth</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">,</span>
		     <span class="n">xfrm_alg_auth_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">),</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_ALG_CRYPT</span><span class="p">,</span> <span class="n">xfrm_alg_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">),</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_ALG_COMP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">)),</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_ENCAP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">),</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">tfcpad</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_TFCPAD</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">tfcpad</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_mark_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_REPLAY_ESN_VAL</span><span class="p">,</span>
		    <span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">),</span>
		    <span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">&amp;&amp;</span> <span class="n">copy_sec_ctx</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_one_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_dump_info</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">in_skb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">in_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">in_skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
			<span class="n">XFRM_MSG_NEWSA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user_state_extra</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_dump_sa_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_state_walk</span> <span class="o">*</span><span class="n">walk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state_walk</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">xfrm_state_walk_done</span><span class="p">(</span><span class="n">walk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_dump_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state_walk</span> <span class="o">*</span><span class="n">walk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state_walk</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_dump_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state_walk</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">info</span><span class="p">.</span><span class="n">in_skb</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_seq</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_flags</span> <span class="o">=</span> <span class="n">NLM_F_MULTI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xfrm_state_walk_init</span><span class="p">(</span><span class="n">walk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">xfrm_state_walk</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="n">dump_one_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">xfrm_state_netlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">in_skb</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_dump_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">in_skb</span> <span class="o">=</span> <span class="n">in_skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dump_one_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_spdinfo_msgsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrmu_spdinfo</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrmu_spdhinfo</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_spdinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrmk_spdinfo</span> <span class="n">si</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrmu_spdinfo</span> <span class="n">spc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrmu_spdhinfo</span> <span class="n">sph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">XFRM_MSG_NEWSPDINFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* shouldn&#39;t really happen ... */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">xfrm_spd_getinfo</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">);</span>
	<span class="n">spc</span><span class="p">.</span><span class="n">incnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">incnt</span><span class="p">;</span>
	<span class="n">spc</span><span class="p">.</span><span class="n">outcnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">outcnt</span><span class="p">;</span>
	<span class="n">spc</span><span class="p">.</span><span class="n">fwdcnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">fwdcnt</span><span class="p">;</span>
	<span class="n">spc</span><span class="p">.</span><span class="n">inscnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">inscnt</span><span class="p">;</span>
	<span class="n">spc</span><span class="p">.</span><span class="n">outscnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">outscnt</span><span class="p">;</span>
	<span class="n">spc</span><span class="p">.</span><span class="n">fwdscnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">fwdscnt</span><span class="p">;</span>
	<span class="n">sph</span><span class="p">.</span><span class="n">spdhcnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">spdhcnt</span><span class="p">;</span>
	<span class="n">sph</span><span class="p">.</span><span class="n">spdhmcnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">spdhmcnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_SPD_INFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">spc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_SPD_HINFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sph</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_get_spdinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">r_skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">spid</span> <span class="o">=</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>

	<span class="n">r_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_spdinfo_msgsize</span><span class="p">(),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_spdinfo</span><span class="p">(</span><span class="n">r_skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">spid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_unicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">r_skb</span><span class="p">,</span> <span class="n">spid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_sadinfo_msgsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrmu_sadhinfo</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="cm">/* XFRMA_SAD_CNT */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_sadinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrmk_sadinfo</span> <span class="n">si</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrmu_sadhinfo</span> <span class="n">sh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">XFRM_MSG_NEWSADINFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* shouldn&#39;t really happen ... */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">xfrm_sad_getinfo</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">);</span>

	<span class="n">sh</span><span class="p">.</span><span class="n">sadhmcnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">sadhmcnt</span><span class="p">;</span>
	<span class="n">sh</span><span class="p">.</span><span class="n">sadhcnt</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">sadhcnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_SAD_CNT</span><span class="p">,</span> <span class="n">si</span><span class="p">.</span><span class="n">sadcnt</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_SAD_HINFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sh</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_get_sadinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">r_skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">spid</span> <span class="o">=</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>

	<span class="n">r_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_sadinfo_msgsize</span><span class="p">(),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_sadinfo</span><span class="p">(</span><span class="n">r_skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">spid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_unicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">r_skb</span><span class="p">,</span> <span class="n">spid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_get_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_id</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">resp_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_user_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_noput</span><span class="p">;</span>

	<span class="n">resp_skb</span> <span class="o">=</span> <span class="n">xfrm_state_netlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_unicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">resp_skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="nl">out_noput:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_userspi_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_userspi_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPPROTO_AH</span>:
	<span class="k">case</span> <span class="n">IPPROTO_ESP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPPROTO_COMP</span>:
		<span class="cm">/* IPCOMP spi is 16-bits. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_alloc_userspi</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_userspi_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">resp_skb</span><span class="p">;</span>
	<span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">daddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">family</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_userspi_info</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_noput</span><span class="p">;</span>

	<span class="n">family</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">family</span><span class="p">;</span>
	<span class="n">daddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mark</span> <span class="o">=</span> <span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_find_acq_byseq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">xfrm_addr_cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">family</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
			<span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_find_acq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">reqid</span><span class="p">,</span>
				  <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="n">family</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_noput</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_alloc_spi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">resp_skb</span> <span class="o">=</span> <span class="n">xfrm_state_netlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_unicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">resp_skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="nl">out_noput:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_policy_dir</span><span class="p">(</span><span class="n">u8</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_POLICY_IN</span>:
	<span class="k">case</span> <span class="n">XFRM_POLICY_OUT</span>:
	<span class="k">case</span> <span class="n">XFRM_POLICY_FWD</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_policy_type</span><span class="p">(</span><span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span>:
<span class="cp">#ifdef CONFIG_XFRM_SUB_POLICY</span>
	<span class="k">case</span> <span class="n">XFRM_POLICY_TYPE_SUB</span>:
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_newpolicy_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">share</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_SHARE_ANY</span>:
	<span class="k">case</span> <span class="n">XFRM_SHARE_SESSION</span>:
	<span class="k">case</span> <span class="n">XFRM_SHARE_USER</span>:
	<span class="k">case</span> <span class="n">XFRM_SHARE_UNIQUE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_POLICY_ALLOW</span>:
	<span class="k">case</span> <span class="n">XFRM_POLICY_BLOCK</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AF_INET6</span>:
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">verify_policy_dir</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_from_user_sec_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">uctx</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">security_xfrm_policy_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_templates</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="o">*</span><span class="n">ut</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ut</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ut</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_id</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ut</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">xfrm_address_t</span><span class="p">));</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">share</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">share</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">optional</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">optional</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">aalgos</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">aalgos</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">ealgos</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">ealgos</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">calgos</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">calgos</span><span class="p">;</span>
		<span class="cm">/* If all masks are ~0, then we allow all algorithms. */</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">allalgs</span> <span class="o">=</span> <span class="o">!~</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">aalgos</span> <span class="o">&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ealgos</span> <span class="o">&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">calgos</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">encap_family</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_tmpl</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="o">*</span><span class="n">ut</span><span class="p">,</span> <span class="n">u16</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">XFRM_MAX_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We never validated the ut-&gt;family value, so many</span>
<span class="cm">		 * applications simply leave it at zero.  The check was</span>
<span class="cm">		 * never made and ut-&gt;family was ignored because all</span>
<span class="cm">		 * templates could be assumed to have the same family as</span>
<span class="cm">		 * the policy itself.  Now that we will have ipv4-in-ipv6</span>
<span class="cm">		 * and ipv6-in-ipv4 tunnels, this is no longer true.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ut</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">family</span><span class="p">)</span>
			<span class="n">ut</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ut</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AF_INET</span>:
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
		<span class="k">case</span> <span class="n">AF_INET6</span>:
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_from_user_tmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TMPL</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="o">*</span><span class="n">utmpl</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">utmpl</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">validate_tmpl</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">utmpl</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">copy_templates</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="n">utmpl</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_from_user_policy_type</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_POLICY_TYPE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_type</span> <span class="o">*</span><span class="n">upt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">upt</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">upt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_policy_type</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_from_user_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">));</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span><span class="p">;</span>
	<span class="cm">/* XXX xp-&gt;share = p-&gt;share; */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_to_user_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">share</span> <span class="o">=</span> <span class="n">XFRM_SHARE_ANY</span><span class="p">;</span> <span class="cm">/* XXX xp-&gt;share */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="nf">xfrm_policy_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xp</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">copy_from_user_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_policy_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_tmpl</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_sec_ctx</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">xp</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xfrm_policy_destroy</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_add_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">excl</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_newpolicy_info</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_sec_ctx_len</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_construct</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* shouldn&#39;t excl be based on nlh flags??</span>
<span class="cm">	 * Aha! this is anti-netlink really i.e  more pfkey derived</span>
<span class="cm">	 * in netlink excl is a flag and you wouldnt need</span>
<span class="cm">	 * a type XFRM_MSG_UPDPOLICY - JHS */</span>
	<span class="n">excl</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span> <span class="o">==</span> <span class="n">XFRM_MSG_NEWPOLICY</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_policy_insert</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">excl</span><span class="p">);</span>
	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
	<span class="n">xfrm_audit_policy_add</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loginuid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">security_xfrm_policy_free</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>
	<span class="n">km_policy_notify</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

	<span class="n">xfrm_pol_put</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_to_user_tmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="n">vec</span><span class="p">[</span><span class="n">XFRM_MAX_DEPTH</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">encap_family</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">));</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">share</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">share</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">optional</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">optional</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">aalgos</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">aalgos</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">ealgos</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">ealgos</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">calgos</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">calgos</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_TMPL</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_tmpl</span><span class="p">)</span> <span class="o">*</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">copy_to_user_state_sec_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">copy_sec_ctx</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">copy_to_user_sec_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">copy_sec_ctx</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">userpolicy_type_attrsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_XFRM_SUB_POLICY</span>
	<span class="k">return</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_userpolicy_type</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XFRM_SUB_POLICY</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_to_user_policy_type</span><span class="p">(</span><span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_type</span> <span class="n">upt</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_POLICY_TYPE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">upt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">upt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">copy_to_user_policy_type</span><span class="p">(</span><span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_one_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_dump_info</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">in_skb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">in_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">in_skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
			<span class="n">XFRM_MSG_NEWPOLICY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">copy_to_user_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_tmpl</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_sec_ctx</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_policy_type</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_mark_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
<span class="nl">nlmsg_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_dump_policy_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_policy_walk</span> <span class="o">*</span><span class="n">walk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy_walk</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">xfrm_policy_walk_done</span><span class="p">(</span><span class="n">walk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_dump_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_policy_walk</span> <span class="o">*</span><span class="n">walk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy_walk</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_dump_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy_walk</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">info</span><span class="p">.</span><span class="n">in_skb</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_seq</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_flags</span> <span class="o">=</span> <span class="n">NLM_F_MULTI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xfrm_policy_walk_init</span><span class="p">(</span><span class="n">walk</span><span class="p">,</span> <span class="n">XFRM_POLICY_TYPE_ANY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">xfrm_policy_walk</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="n">dump_one_policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">xfrm_policy_netlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">in_skb</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_dump_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">in_skb</span> <span class="o">=</span> <span class="n">in_skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nlmsg_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dump_one_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_get_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_id</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">delete</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span> <span class="o">==</span> <span class="n">XFRM_MSG_DELPOLICY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_policy_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_policy_dir</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_byid</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">verify_sec_ctx_len</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">security_xfrm_policy_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_bysel_ctx</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span>
					   <span class="n">ctx</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="n">security_xfrm_policy_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">resp_skb</span><span class="p">;</span>

		<span class="n">resp_skb</span> <span class="o">=</span> <span class="n">xfrm_policy_netlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_unicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">resp_skb</span><span class="p">,</span>
					    <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uid_t</span> <span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

		<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
		<span class="n">xfrm_audit_policy_delete</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loginuid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">,</span>
					 <span class="n">sid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">byid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>
		<span class="n">km_policy_notify</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">xfrm_pol_put</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_flush_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_flush</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_audit</span> <span class="n">audit_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">audit_info</span><span class="p">.</span><span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">audit_info</span><span class="p">.</span><span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_info</span><span class="p">.</span><span class="n">secid</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="cm">/* empty table */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">km_state_notify</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_aevent_msgsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">replay_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span> <span class="o">?</span>
			      <span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">)</span> <span class="o">:</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_replay_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_aevent_id</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">replay_size</span><span class="p">)</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_lifetime_cur</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_mark</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="cm">/* XFRM_AE_RTHR */</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="cm">/* XFRM_AE_ETHR */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_aevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_aevent_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">XFRM_MSG_NEWAE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">));</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">));</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">reqid</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">aevent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_REPLAY_ESN_VAL</span><span class="p">,</span>
			    <span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">),</span>
			    <span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_REPLAY_VAL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">),</span>
			    <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_LTIME_VAL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFRM_AE_RTHR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_REPLAY_THRESH</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_maxdiff</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFRM_AE_ETHR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_ETIMER_THRESH</span><span class="p">,</span>
			<span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_maxage</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_mark_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_get_ae</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">r_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_aevent_id</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">;</span>

	<span class="n">mark</span> <span class="o">=</span> <span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="n">r_skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_aevent_msgsize</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: is this lock really needed - none of the other</span>
<span class="cm">	 * gets lock (the concern is things getting updated</span>
<span class="cm">	 * while we are still reading) - jhs</span>
<span class="cm">	*/</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">aevent</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_aevent</span><span class="p">(</span><span class="n">r_skb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_unicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">r_skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_new_ae</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_aevent_id</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_REPLAY_VAL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">re</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_REPLAY_ESN_VAL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">lt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_LTIME_VAL</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">re</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* pedantic mode - thou shalt sayeth replaceth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span><span class="o">&amp;</span><span class="n">NLM_F_REPLACE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mark</span> <span class="o">=</span> <span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">spi</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">proto</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sa_id</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">XFRM_STATE_VALID</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_replay_verify_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">xfrm_update_ae_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">aevent</span> <span class="o">=</span> <span class="n">XFRM_AE_CU</span><span class="p">;</span>
	<span class="n">km_state_notify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_flush_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_audit</span> <span class="n">audit_info</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_policy_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">audit_info</span><span class="p">.</span><span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">audit_info</span><span class="p">.</span><span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_info</span><span class="p">.</span><span class="n">secid</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_policy_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="cm">/* empty table */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">km_policy_notify</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_add_pol_expire</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_user_polexpire</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pol</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_policy_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_policy_dir</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_byid</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">verify_sec_ctx_len</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">security_xfrm_policy_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_bysel_ctx</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="n">security_xfrm_policy_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">dead</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">hard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uid_t</span> <span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

		<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
		<span class="n">xfrm_policy_delete</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">xfrm_audit_policy_delete</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loginuid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>reset the timers here?</p></td><td class="code"><div class="highlight"><pre>		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Dont know what to do with soft policy expire</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">km_policy_expired</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">hard</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">xfrm_pol_put</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_add_sa_expire</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_user_expire</span> <span class="o">*</span><span class="n">ue</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">XFRM_STATE_VALID</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">km_state_expired</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ue</span><span class="o">-&gt;</span><span class="n">hard</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ue</span><span class="o">-&gt;</span><span class="n">hard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uid_t</span> <span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

		<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
		<span class="n">__xfrm_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="n">xfrm_audit_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loginuid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_add_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="o">*</span><span class="n">ut</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_TMPL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">mark</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">xfrm_user_acquire</span> <span class="o">*</span><span class="n">ua</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>

	<span class="n">xfrm_mark_get</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mark</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_newpolicy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad_policy</span><span class="p">;</span>

	<span class="cm">/*   build an XP */</span>
	<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_construct</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_state</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">mark</span><span class="p">.</span><span class="n">m</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">mark</span><span class="p">.</span><span class="n">v</span><span class="p">;</span>
	<span class="n">ut</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="cm">/* extract the templates and for each call km_key */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ut</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">ut</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">aalgos</span> <span class="o">=</span> <span class="n">ua</span><span class="o">-&gt;</span><span class="n">aalgos</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">ealgos</span> <span class="o">=</span> <span class="n">ua</span><span class="o">-&gt;</span><span class="n">ealgos</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">calgos</span> <span class="o">=</span> <span class="n">ua</span><span class="o">-&gt;</span><span class="n">calgos</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">km_query</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xp</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad_policy:</span>
	<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;BAD policy passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">free_state:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="nl">nomem:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XFRM_MIGRATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_from_user_migrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">ma</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_MIGRATE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_user_migrate</span> <span class="o">*</span><span class="n">um</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_migrate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_user_kmaddress</span> <span class="o">*</span><span class="n">uk</span><span class="p">;</span>

		<span class="n">uk</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_KMADDRESS</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uk</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uk</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">));</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">uk</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
		<span class="n">k</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">uk</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">um</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="n">num_migrate</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">um</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_migrate</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num_migrate</span> <span class="o">&gt;</span> <span class="n">XFRM_MAX_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_migrate</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">um</span><span class="o">++</span><span class="p">,</span> <span class="n">ma</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">old_daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">old_daddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">old_daddr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">new_daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">new_daddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">new_daddr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">));</span>

		<span class="n">ma</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">um</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
		<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">um</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">ma</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">um</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">;</span>

		<span class="n">ma</span><span class="o">-&gt;</span><span class="n">old_family</span> <span class="o">=</span> <span class="n">um</span><span class="o">-&gt;</span><span class="n">old_family</span><span class="p">;</span>
		<span class="n">ma</span><span class="o">-&gt;</span><span class="n">new_family</span> <span class="o">=</span> <span class="n">um</span><span class="o">-&gt;</span><span class="n">new_family</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_do_migrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_id</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="n">m</span><span class="p">[</span><span class="n">XFRM_MAX_DEPTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="n">km</span><span class="p">,</span> <span class="o">*</span><span class="n">kmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_MIGRATE</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">kmp</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_KMADDRESS</span><span class="p">]</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">km</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_policy_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user_migrate</span><span class="p">((</span><span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">,</span> <span class="n">kmp</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xfrm_migrate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">kmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_do_migrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_XFRM_MIGRATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_to_user_migrate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_migrate</span> <span class="n">um</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">));</span>
	<span class="n">um</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">um</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">um</span><span class="p">.</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">;</span>
	<span class="n">um</span><span class="p">.</span><span class="n">old_family</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">old_family</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="p">.</span><span class="n">old_daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">old_daddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">.</span><span class="n">old_daddr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="p">.</span><span class="n">old_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">.</span><span class="n">old_saddr</span><span class="p">));</span>
	<span class="n">um</span><span class="p">.</span><span class="n">new_family</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">new_family</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="p">.</span><span class="n">new_daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">new_daddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">.</span><span class="n">new_daddr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="p">.</span><span class="n">new_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">.</span><span class="n">new_saddr</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_MIGRATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">um</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_to_user_kmaddress</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_kmaddress</span> <span class="n">uk</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uk</span><span class="p">));</span>
	<span class="n">uk</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
	<span class="n">uk</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uk</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uk</span><span class="p">.</span><span class="n">local</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uk</span><span class="p">.</span><span class="n">remote</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uk</span><span class="p">.</span><span class="n">remote</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_KMADDRESS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">uk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_migrate_msgsize</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_migrate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">with_kma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_userpolicy_id</span><span class="p">))</span>
	      <span class="o">+</span> <span class="p">(</span><span class="n">with_kma</span> <span class="o">?</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_kmaddress</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	      <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_migrate</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_migrate</span><span class="p">)</span>
	      <span class="o">+</span> <span class="n">userpolicy_type_attrsize</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_migrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">num_migrate</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_id</span> <span class="o">*</span><span class="n">pol_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRM_MSG_MIGRATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pol_id</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">pol_id</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="cm">/* copy data from selector, dir, and type to the pol_id */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pol_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pol_id</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pol_id</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pol_id</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>
	<span class="n">pol_id</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">copy_to_user_kmaddress</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_policy_type</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">m</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_migrate</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_migrate</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
<span class="nl">nlmsg_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_send_migrate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_migrate</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_migrate_msgsize</span><span class="p">(</span><span class="n">num_migrate</span><span class="p">,</span> <span class="o">!!</span><span class="n">k</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* build migrate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">build_migrate</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">num_migrate</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_MIGRATE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_send_migrate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_migrate</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define XMSGSIZE(type) sizeof(struct type)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">xfrm_msg_min</span><span class="p">[</span><span class="n">XFRM_NR_MSGTYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">XFRM_MSG_NEWSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_usersa_info</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_DELSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_usersa_id</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_usersa_id</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_NEWPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_userpolicy_info</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_DELPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_userpolicy_id</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_userpolicy_id</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_ALLOCSPI</span>    <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_userspi_info</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_ACQUIRE</span>     <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_user_acquire</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_EXPIRE</span>      <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_user_expire</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_UPDPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_userpolicy_info</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_UPDSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_usersa_info</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_POLEXPIRE</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_user_polexpire</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_FLUSHSA</span>     <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_usersa_flush</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_FLUSHPOLICY</span> <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">XFRM_MSG_NEWAE</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_aevent_id</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETAE</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_aevent_id</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_REPORT</span>      <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_user_report</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_MIGRATE</span>     <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">XMSGSIZE</span><span class="p">(</span><span class="n">xfrm_userpolicy_id</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETSADINFO</span>  <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETSPDINFO</span>  <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#undef XMSGSIZE</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">xfrma_policy</span><span class="p">[</span><span class="n">XFRMA_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">XFRMA_SA</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_usersa_info</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">XFRMA_POLICY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">XFRMA_LASTUSED</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U64</span><span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_ALG_AUTH_TRUNC</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo_auth</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">XFRMA_ALG_AEAD</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo_aead</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_ALG_AUTH</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_ALG_CRYPT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_ALG_COMP</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_ENCAP</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_encap_tmpl</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_TMPL</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_tmpl</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_SEC_CTX</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_sec_ctx</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_LTIME_VAL</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_lifetime_cur</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_REPLAY_VAL</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_replay_state</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_REPLAY_THRESH</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_ETIMER_THRESH</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_SRCADDR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfrm_address_t</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_COADDR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfrm_address_t</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_POLICY_TYPE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_userpolicy_type</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">XFRMA_MIGRATE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_migrate</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_KMADDRESS</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_kmaddress</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_MARK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_mark</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_TFCPAD</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRMA_REPLAY_ESN_VAL</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_replay_state_esn</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_link</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">doit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">dump</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="p">);</span>
<span class="p">}</span> <span class="n">xfrm_dispatch</span><span class="p">[</span><span class="n">XFRM_NR_MSGTYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">XFRM_MSG_NEWSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_add_sa</span>        <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_DELSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_del_sa</span>        <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_get_sa</span><span class="p">,</span>
						   <span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">xfrm_dump_sa</span><span class="p">,</span>
						   <span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">xfrm_dump_sa_done</span>  <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_NEWPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_add_policy</span>    <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_DELPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_get_policy</span>    <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_get_policy</span><span class="p">,</span>
						   <span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">xfrm_dump_policy</span><span class="p">,</span>
						   <span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">xfrm_dump_policy_done</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_ALLOCSPI</span>    <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_alloc_userspi</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_ACQUIRE</span>     <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_add_acquire</span>   <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_EXPIRE</span>      <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_add_sa_expire</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_UPDPOLICY</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_add_policy</span>    <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_UPDSA</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_add_sa</span>        <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_POLEXPIRE</span>   <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_add_pol_expire</span><span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_FLUSHSA</span>     <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_flush_sa</span>      <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_FLUSHPOLICY</span> <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_flush_policy</span>  <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_NEWAE</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_new_ae</span>  <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETAE</span>       <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_get_ae</span>  <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_MIGRATE</span>     <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_do_migrate</span>    <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETSADINFO</span>  <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_get_sadinfo</span>   <span class="p">},</span>
	<span class="p">[</span><span class="n">XFRM_MSG_GETSPDINFO</span>  <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">xfrm_get_spdinfo</span>   <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_user_rcv_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[</span><span class="n">XFRMA_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">XFRM_MSG_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">-=</span> <span class="n">XFRM_MSG_BASE</span><span class="p">;</span>
	<span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xfrm_dispatch</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>

	<span class="cm">/* All operations require privileges, even GET */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="p">(</span><span class="n">XFRM_MSG_GETSA</span> <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">type</span> <span class="o">==</span> <span class="p">(</span><span class="n">XFRM_MSG_GETPOLICY</span> <span class="o">-</span> <span class="n">XFRM_MSG_BASE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_DUMP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dump</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">netlink_dump_control</span> <span class="n">c</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">,</span>
				<span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">,</span>
			<span class="p">};</span>
			<span class="k">return</span> <span class="n">netlink_dump_start</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="n">xfrm_msg_min</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">XFRMA_MAX</span><span class="p">,</span>
			  <span class="n">xfrma_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">doit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">doit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xfrm_netlink_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfrm_cfg_mutex</span><span class="p">);</span>
	<span class="n">netlink_rcv_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xfrm_user_rcv_msg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfrm_cfg_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_expire_msgsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_expire</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_mark</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_expire</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_expire</span> <span class="o">*</span><span class="n">ue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRM_MSG_EXPIRE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ue</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">ue</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">copy_to_user_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">ue</span><span class="o">-&gt;</span><span class="n">hard</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">hard</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_mark_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_exp_state_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_expire_msgsize</span><span class="p">(),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_expire</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_EXPIRE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_aevent_state_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_aevent_msgsize</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_aevent</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_AEVENTS</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_notify_sa_flush</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_flush</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_usersa_flush</span><span class="p">));</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">XFRM_MSG_FLUSHSA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">proto</span><span class="p">;</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_SA</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_sa_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aead</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">aead_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aead</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_algo</span><span class="p">)</span> <span class="o">+</span>
				    <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">xfrm_alg_auth_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">xfrm_alg_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">tfcpad</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">tfcpad</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">xfrm_replay_state_esn_len</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">replay_esn</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">coaddr</span><span class="p">));</span>

	<span class="cm">/* Must count x-&gt;lastused as it may become non-zero behind our back. */</span>
	<span class="n">l</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_notify_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_usersa_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">xfrm_sa_len</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">headlen</span><span class="p">;</span>

	<span class="n">headlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">XFRM_MSG_DELSA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">headlen</span><span class="p">);</span>
		<span class="n">headlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_mark</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="n">headlen</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">headlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">XFRM_MSG_DELSA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>

		<span class="n">id</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">));</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">spi</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">;</span>

		<span class="n">attr</span> <span class="o">=</span> <span class="n">nla_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_SA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_state_extra</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_SA</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="cm">/* Somebody screwed up with xfrm_sa_len! */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_send_state_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_EXPIRE</span>:
		<span class="k">return</span> <span class="n">xfrm_exp_state_notify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWAE</span>:
		<span class="k">return</span> <span class="n">xfrm_aevent_state_notify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_DELSA</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_UPDSA</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWSA</span>:
		<span class="k">return</span> <span class="n">xfrm_notify_sa</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_FLUSHSA</span>:
		<span class="k">return</span> <span class="n">xfrm_notify_sa_flush</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;xfrm_user: Unknown SA event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_acquire_msgsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_acquire</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_tmpl</span><span class="p">)</span> <span class="o">*</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">)</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_mark</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">xfrm_user_sec_ctx_size</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">userpolicy_type_attrsize</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">xt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_acquire</span> <span class="o">*</span><span class="n">ua</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">xfrm_get_acqseq</span><span class="p">();</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRM_MSG_ACQUIRE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ua</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">ua</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>
	<span class="n">copy_to_user_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">ua</span><span class="o">-&gt;</span><span class="n">aalgos</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">aalgos</span><span class="p">;</span>
	<span class="n">ua</span><span class="o">-&gt;</span><span class="n">ealgos</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">ealgos</span><span class="p">;</span>
	<span class="n">ua</span><span class="o">-&gt;</span><span class="n">calgos</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">calgos</span><span class="p">;</span>
	<span class="n">ua</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_tmpl</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_state_sec_ctx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_policy_type</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_mark_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
<span class="nl">nlmsg_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_send_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">xt</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_acquire_msgsize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_acquire</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_ACQUIRE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* User gives us xfrm_user_policy_info followed by an array of 0</span>
<span class="cm"> * or more templates.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="nf">xfrm_compile_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">,</span>
					       <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="o">*</span><span class="n">ut</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_tmpl</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">!=</span> <span class="n">IP_XFRM_POLICY</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">!=</span> <span class="n">IPV6_XFRM_POLICY</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">verify_newpolicy_info</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ut</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">validate_tmpl</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">ut</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">&gt;</span> <span class="n">XFRM_POLICY_OUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">copy_from_user_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">;</span>
	<span class="n">copy_templates</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">ut</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_polexpire_msgsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_polexpire</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_tmpl</span><span class="p">)</span> <span class="o">*</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">)</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">xfrm_user_sec_ctx_size</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_mark</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">userpolicy_type_attrsize</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_polexpire</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_polexpire</span> <span class="o">*</span><span class="n">upe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hard</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">hard</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRM_MSG_POLEXPIRE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">upe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">upe</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">copy_to_user_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upe</span><span class="o">-&gt;</span><span class="n">pol</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_tmpl</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_sec_ctx</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_policy_type</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_mark_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">upe</span><span class="o">-&gt;</span><span class="n">hard</span> <span class="o">=</span> <span class="o">!!</span><span class="n">hard</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
<span class="nl">nlmsg_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_exp_policy_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xp_net</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_polexpire_msgsize</span><span class="p">(</span><span class="n">xp</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_polexpire</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_EXPIRE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_notify_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xp_net</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_userpolicy_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_tmpl</span><span class="p">)</span> <span class="o">*</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">headlen</span><span class="p">;</span>

	<span class="n">headlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">XFRM_MSG_DELPOLICY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">headlen</span><span class="p">);</span>
		<span class="n">headlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">userpolicy_type_attrsize</span><span class="p">();</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_mark</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="n">headlen</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">headlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">XFRM_MSG_DELPOLICY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>

		<span class="n">id</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">));</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">byid</span><span class="p">)</span>
			<span class="n">id</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>

		<span class="n">attr</span> <span class="o">=</span> <span class="n">nla_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_POLICY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">copy_to_user_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_tmpl</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_policy_type</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_mark_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_POLICY</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
<span class="nl">nlmsg_failure:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_notify_policy_flush</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">userpolicy_type_attrsize</span><span class="p">(),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">XFRM_MSG_FLUSHPOLICY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_policy_type</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nlmsg_failure</span><span class="p">;</span>

	<span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_POLICY</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

<span class="nl">nlmsg_failure:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_send_policy_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWPOLICY</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_UPDPOLICY</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_DELPOLICY</span>:
		<span class="k">return</span> <span class="n">xfrm_notify_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_FLUSHPOLICY</span>:
		<span class="k">return</span> <span class="n">xfrm_notify_policy_flush</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_POLEXPIRE</span>:
		<span class="k">return</span> <span class="n">xfrm_exp_policy_notify</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;xfrm_user: Unknown Policy event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_report_msgsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_report</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">proto</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_report</span> <span class="o">*</span><span class="n">ur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRM_MSG_REPORT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ur</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">ur</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">ur</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">XFRMA_COADDR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">),</span> <span class="n">addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_send_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u8</span> <span class="n">proto</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_report_msgsize</span><span class="p">(),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_report</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_REPORT</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">xfrm_mapping_msgsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_user_mapping</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span>
			 <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">new_saddr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">new_sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_mapping</span> <span class="o">*</span><span class="n">um</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRM_MSG_MAPPING</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">um</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">um</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">));</span>
	<span class="n">um</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span><span class="p">;</span>
	<span class="n">um</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">;</span>
	<span class="n">um</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">,</span> <span class="n">new_saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">));</span>
	<span class="n">um</span><span class="o">-&gt;</span><span class="n">new_sport</span> <span class="o">=</span> <span class="n">new_sport</span><span class="p">;</span>
	<span class="n">um</span><span class="o">-&gt;</span><span class="n">old_sport</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="o">-&gt;</span><span class="n">encap_sport</span><span class="p">;</span>
	<span class="n">um</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">reqid</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xfrm_send_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">,</span>
			     <span class="n">__be16</span> <span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">IPPROTO_ESP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">xfrm_mapping_msgsize</span><span class="p">(),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="n">sport</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nlmsg_multicast</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFRMNLGRP_MAPPING</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_mgr</span> <span class="n">netlink_mgr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="s">&quot;netlink&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify</span>		<span class="o">=</span> <span class="n">xfrm_send_state_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire</span>	<span class="o">=</span> <span class="n">xfrm_send_acquire</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compile_policy</span>	<span class="o">=</span> <span class="n">xfrm_compile_policy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify_policy</span>	<span class="o">=</span> <span class="n">xfrm_send_policy_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">report</span>		<span class="o">=</span> <span class="n">xfrm_send_report</span><span class="p">,</span>
	<span class="p">.</span><span class="n">migrate</span>	<span class="o">=</span> <span class="n">xfrm_send_migrate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">new_mapping</span>	<span class="o">=</span> <span class="n">xfrm_send_mapping</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">xfrm_user_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">nlsk</span><span class="p">;</span>

	<span class="n">nlsk</span> <span class="o">=</span> <span class="n">netlink_kernel_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">NETLINK_XFRM</span><span class="p">,</span> <span class="n">XFRMNLGRP_MAX</span><span class="p">,</span>
				     <span class="n">xfrm_netlink_rcv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlsk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk_stash</span> <span class="o">=</span> <span class="n">nlsk</span><span class="p">;</span> <span class="cm">/* Don&#39;t set to NULL */</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="n">nlsk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">xfrm_user_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">net_exit_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net_exit_list</span><span class="p">,</span> <span class="n">exit_list</span><span class="p">)</span>
		<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">synchronize_net</span><span class="p">();</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net_exit_list</span><span class="p">,</span> <span class="n">exit_list</span><span class="p">)</span>
		<span class="n">netlink_kernel_release</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">nlsk_stash</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">xfrm_user_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>	    <span class="o">=</span> <span class="n">xfrm_user_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit_batch</span> <span class="o">=</span> <span class="n">xfrm_user_net_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xfrm_user_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Initializing XFRM netlink socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfrm_user_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">xfrm_register_km</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netlink_mgr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfrm_user_net_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">xfrm_user_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfrm_unregister_km</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netlink_mgr</span><span class="p">);</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfrm_user_net_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">xfrm_user_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">xfrm_user_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NET_PF_PROTO</span><span class="p">(</span><span class="n">PF_NETLINK</span><span class="p">,</span> <span class="n">NETLINK_XFRM</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
