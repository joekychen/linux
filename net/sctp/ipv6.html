<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sctp › ipv6.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ipv6.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* SCTP kernel implementation</span>
<span class="cm"> * (C) Copyright IBM Corp. 2002, 2004</span>
<span class="cm"> * Copyright (c) 2001 Nokia, Inc.</span>
<span class="cm"> * Copyright (c) 2001 La Monte H.P. Yarroll</span>
<span class="cm"> * Copyright (c) 2002-2003 Intel Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is part of the SCTP kernel implementation</span>
<span class="cm"> *</span>
<span class="cm"> * SCTP over IPv6.</span>
<span class="cm"> *</span>
<span class="cm"> * This SCTP implementation is free software;</span>
<span class="cm"> * you can redistribute it and/or modify it under the terms of</span>
<span class="cm"> * the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This SCTP implementation is distributed in the hope that it</span>
<span class="cm"> * will be useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<span class="cm"> *		   ************************</span>
<span class="cm"> * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> * See the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with GNU CC; see the file COPYING.  If not, write to</span>
<span class="cm"> * the Free Software Foundation, 59 Temple Place - Suite 330,</span>
<span class="cm"> * Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Please send any bug reports or fixes you make to the</span>
<span class="cm"> * email address(es):</span>
<span class="cm"> *    lksctp developers &lt;lksctp-developers@lists.sourceforge.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Or submit a bug report through the following website:</span>
<span class="cm"> *    http://www.sf.net/projects/lksctp</span>
<span class="cm"> *</span>
<span class="cm"> * Written or modified by:</span>
<span class="cm"> *    Le Yanqun		    &lt;yanqun.le@nokia.com&gt;</span>
<span class="cm"> *    Hui Huang		    &lt;hui.huang@nokia.com&gt;</span>
<span class="cm"> *    La Monte H.P. Yarroll &lt;piggy@acm.org&gt;</span>
<span class="cm"> *    Sridhar Samudrala	    &lt;sri@us.ibm.com&gt;</span>
<span class="cm"> *    Jon Grimm		    &lt;jgrimm@us.ibm.com&gt;</span>
<span class="cm"> *    Ardelle Fan	    &lt;ardelle.fan@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on:</span>
<span class="cm"> *	linux/net/ipv6/tcp_ipv6.c</span>
<span class="cm"> *</span>
<span class="cm"> * Any bugs reported given to us we will try to fix... any fixes shared will</span>
<span class="cm"> * be incorporated into the next SCTP release.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ipsec.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/icmpv6.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#include &lt;net/protocol.h&gt;</span>
<span class="cp">#include &lt;net/ndisc.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/transp_v6.h&gt;</span>
<span class="cp">#include &lt;net/addrconf.h&gt;</span>
<span class="cp">#include &lt;net/ip6_route.h&gt;</span>
<span class="cp">#include &lt;net/inet_common.h&gt;</span>
<span class="cp">#include &lt;net/inet_ecn.h&gt;</span>
<span class="cp">#include &lt;net/sctp/sctp.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">sctp_v6_addr_match_len</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span>
					 <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">s2</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sctp_v6_to_addr</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span>
			      <span class="n">__be16</span> <span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sctp_v6_cmp_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr1</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr2</span><span class="p">);</span>

<span class="cm">/* Event handler for inet6 address addition/deletion events.</span>
<span class="cm"> * The sctp_local_addr_list needs to be protocted by a spin lock since</span>
<span class="cm"> * multiple notifiers (say IPv4 and IPv6) may be running at the same</span>
<span class="cm"> * time and thus corrupt the list.</span>
<span class="cm"> * The reader side is protected with RCU.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_inet6addr_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ev</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_sockaddr_entry</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_sockaddr_entry</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_sockaddr_entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_local_addr_lock</span><span class="p">);</span>
			<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sctp_local_addr_list</span><span class="p">);</span>
			<span class="n">sctp_addr_wq_mgmt</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">SCTP_ADDR_NEW</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_local_addr_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_local_addr_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sctp_local_addr_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span> <span class="o">&amp;&amp;</span>
					<span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sctp_addr_wq_mgmt</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">SCTP_ADDR_DEL</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">addr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_local_addr_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">sctp_inet6addr_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">sctp_inet6addr_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ICMP error handler. */</span>
<span class="n">SCTP_STATIC</span> <span class="kt">void</span> <span class="nf">sctp_v6_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inet6_skb_parm</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_association</span> <span class="o">*</span><span class="n">asoc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="n">sk_buff_data_t</span> <span class="n">saveip</span><span class="p">,</span> <span class="n">savesctp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">in6_dev_get</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Fix up skb to look at the embedded net header. */</span>
	<span class="n">saveip</span>	 <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span><span class="p">;</span>
	<span class="n">savesctp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span><span class="p">;</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">sk</span> <span class="o">=</span> <span class="n">sctp_err_lookup</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">sctp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">asoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transport</span><span class="p">);</span>
	<span class="cm">/* Put back, the original pointers. */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span>   <span class="o">=</span> <span class="n">saveip</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span> <span class="o">=</span> <span class="n">savesctp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ICMP6_INC_STATS_BH</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">idev</span><span class="p">,</span> <span class="n">ICMP6_MIB_INERRORS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Warning:  The sock lock is held.  Remember to call</span>
<span class="cm">	 * sctp_err_finish!</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ICMPV6_PKT_TOOBIG</span>:
		<span class="n">sctp_icmp_frag_needed</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">asoc</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ICMPV6_PARAMPROB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ICMPV6_UNK_NEXTHDR</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sctp_icmp_proto_unreachable</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">asoc</span><span class="p">,</span> <span class="n">transport</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">icmpv6_err_convert</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">recverr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* Only an error on timeout */</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err_soft</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">sctp_err_finish</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">asoc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">idev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Based on tcp_v6_xmit() in tcp_ipv6.c. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sctp_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">flowi6</span> <span class="n">fl6</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fl6</span><span class="p">));</span>

	<span class="n">fl6</span><span class="p">.</span><span class="n">flowi6_proto</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">;</span>

	<span class="cm">/* Fill in the dest address from the route entry passed with the skb</span>
<span class="cm">	 * and the source address from the transport.</span>
<span class="cm">	 */</span>
	<span class="n">fl6</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">transport</span><span class="o">-&gt;</span><span class="n">ipaddr</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>
	<span class="n">fl6</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">transport</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>

	<span class="n">fl6</span><span class="p">.</span><span class="n">flowlabel</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">flow_label</span><span class="p">;</span>
	<span class="n">IP6_ECN_flow_xmit</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">fl6</span><span class="p">.</span><span class="n">flowlabel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl6</span><span class="p">.</span><span class="n">saddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span>
		<span class="n">fl6</span><span class="p">.</span><span class="n">flowi6_oif</span> <span class="o">=</span> <span class="n">transport</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fl6</span><span class="p">.</span><span class="n">flowi6_oif</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">opt</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">srcrt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rt0_hdr</span> <span class="o">*</span><span class="n">rt0</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt0_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">srcrt</span><span class="p">;</span>
		<span class="n">fl6</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">rt0</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SCTP_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;%s: skb:%p, len:%d, src:%pI6 dst:%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">fl6</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="p">.</span><span class="n">daddr</span><span class="p">);</span>

	<span class="n">SCTP_INC_STATS</span><span class="p">(</span><span class="n">SCTP_MIB_OUTSCTPPACKS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">param_flags</span> <span class="o">&amp;</span> <span class="n">SPP_PMTUD_ENABLE</span><span class="p">))</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">local_df</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ip6_xmit</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tclass</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Returns the dst cache entry for the given source and destination ip</span>
<span class="cm"> * addresses.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_get_dst</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_transport</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">flowi</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sctp_association</span> <span class="o">*</span><span class="n">asoc</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">asoc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowi6</span> <span class="o">*</span><span class="n">fl6</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ip6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_bind_addr</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_sockaddr_entry</span> <span class="o">*</span><span class="n">laddr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">baddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">daddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ipaddr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">sctp_addr</span> <span class="n">dst_saddr</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">matchlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bmatchlen</span><span class="p">;</span>
	<span class="n">sctp_scope_t</span> <span class="n">scope</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fl6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flowi6</span><span class="p">));</span>
	<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>
	<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">fl6_dport</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span><span class="p">;</span>
	<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">flowi6_proto</span> <span class="o">=</span> <span class="n">IPPROTO_SCTP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">daddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span>
		<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">flowi6_oif</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span><span class="p">;</span>

	<span class="n">SCTP_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;%s: DST=%pI6 &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asoc</span><span class="p">)</span>
		<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">fl6_sport</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">asoc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">bind_addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">fl6_sport</span> <span class="o">=</span> <span class="n">saddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span><span class="p">;</span>
		<span class="n">SCTP_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;SRC=%pI6 - &quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">ip6_dst_lookup_flow</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">fl6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asoc</span> <span class="o">||</span> <span class="n">saddr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">asoc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">bind_addr</span><span class="p">;</span>
	<span class="n">scope</span> <span class="o">=</span> <span class="n">sctp_scope</span><span class="p">(</span><span class="n">daddr</span><span class="p">);</span>
	<span class="cm">/* ip6_dst_lookup has filled in the fl6-&gt;saddr for us.  Check</span>
<span class="cm">	 * to see if we can use it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Walk through the bind address list and look for a bind</span>
<span class="cm">		 * address that matches the source address of the returned dst.</span>
<span class="cm">		 */</span>
		<span class="n">sctp_v6_to_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">laddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">||</span> <span class="p">(</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SCTP_ADDR_SRC</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Do not compare against v4 addrs */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">sctp_v6_cmp_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="cm">/* None of the bound addresses match the source address of the</span>
<span class="cm">		 * dst. So release it.</span>
<span class="cm">		 */</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Walk through the bind address list and try to get the</span>
<span class="cm">	 * best source address for a given destination.</span>
<span class="cm">	 */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">laddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">laddr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SCTP_ADDR_SRC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">scope</span> <span class="o">&lt;=</span> <span class="n">sctp_scope</span><span class="p">(</span><span class="o">&amp;</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bmatchlen</span> <span class="o">=</span> <span class="n">sctp_v6_addr_match_len</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baddr</span> <span class="o">||</span> <span class="p">(</span><span class="n">matchlen</span> <span class="o">&lt;</span> <span class="n">bmatchlen</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">baddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">laddr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span>
				<span class="n">matchlen</span> <span class="o">=</span> <span class="n">bmatchlen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">baddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="n">fl6</span><span class="o">-&gt;</span><span class="n">fl6_sport</span> <span class="o">=</span> <span class="n">baddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">ip6_dst_lookup_flow</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">fl6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
		<span class="n">SCTP_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;rt6_dst:%pI6 rt6_src:%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_dst</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">SCTP_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;NO ROUTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Returns the number of consecutive initial bits that match in the 2 ipv6</span>
<span class="cm"> * addresses.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sctp_v6_addr_match_len</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span>
					 <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">s2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipv6_addr_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s2</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fills in the source address(saddr) based on the destination address(daddr)</span>
<span class="cm"> * and asoc&#39;s bind address list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_get_saddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sctp_transport</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">flowi</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flowi6</span> <span class="o">*</span><span class="n">fl6</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ip6</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">saddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>

	<span class="n">SCTP_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;%s: asoc:%p dst:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">asoc</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="n">saddr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">fl6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Make a copy of all potential local addresses. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_copy_addrlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">addrlist</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">in6_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_sockaddr_entry</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">in6_dev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">addr_list</span><span class="p">,</span> <span class="n">if_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add the address to the local list.  */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">t_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_sockaddr_entry</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">addrlist</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Initialize a sockaddr_storage from in incoming skb. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_from_skb</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">is_saddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctphdr</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_flowinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">inet6_skb_parm</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">sctp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_saddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">port</span>  <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize an sctp_addr from a socket. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_from_sk</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_saddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize sk-&gt;sk_rcv_saddr from sctp_addr. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_to_sk_saddr</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span> <span class="o">&amp;&amp;</span> <span class="n">sctp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v4mapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">);</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_saddr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize sk-&gt;sk_daddr from sctp_addr. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_to_sk_daddr</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span> <span class="o">&amp;&amp;</span> <span class="n">sctp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v4mapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">);</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize a sctp_addr from an address parameter. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_from_addr_param</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">sctp_addr_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				    <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_flowinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* BUG */</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="n">iif</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize an address parameter from a sctp_addr and return the length</span>
<span class="cm"> * of the address parameter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_to_addr_param</span><span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">sctp_addr_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sctp_ipv6addr_param_t</span><span class="p">);</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">param_hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCTP_PARAM_IPV6_ADDRESS</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">param_hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize a sctp_addr from struct in6_addr. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_to_addr</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span>
			      <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">saddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare addresses exactly.</span>
<span class="cm"> * v4-mapped-v6 is also in consideration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_cmp_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr1</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span> <span class="o">&amp;&amp;</span>
		    <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ipv6_addr_v4mapped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">==</span> <span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">&amp;&amp;</span>
			    <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span>
			    <span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span> <span class="o">&amp;&amp;</span>
		    <span class="n">addr1</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ipv6_addr_v4mapped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">==</span> <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">&amp;&amp;</span>
			    <span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span>
			    <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* If this is a linklocal address, compare the scope_id. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span> <span class="o">&amp;&amp;</span> <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span> <span class="o">!=</span> <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize addr struct to INADDR_ANY. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_inaddr_any</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span><span class="p">));</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Is this a wildcard address? */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_is_any</span><span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipv6_addr_any</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Should this be available for binding?   */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_available</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">in6</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">ipv6_addr_type</span><span class="p">(</span><span class="n">in6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPV6_ADDR_ANY</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPV6_ADDR_MAPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">v4mapped</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&amp;&amp;</span> <span class="n">ipv6_only_sock</span><span class="p">(</span><span class="n">sctp_opt2sk</span><span class="p">(</span><span class="n">sp</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sctp_v6_map_v4</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sctp_get_af_specific</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_UNICAST</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ipv6_chk_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">in6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function checks if the address is a valid address to be used for</span>
<span class="cm"> * SCTP.</span>
<span class="cm"> *</span>
<span class="cm"> * Output:</span>
<span class="cm"> * Return 0 - If the address is a non-unicast or an illegal address.</span>
<span class="cm"> * Return 1 - If the address is a unicast.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_addr_valid</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">);</span>

	<span class="cm">/* Support v4-mapped-v6 address. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPV6_ADDR_MAPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note: This routine is used in input, so v4-mapped-v6</span>
<span class="cm">		 * are disallowed here when there is no sctp_sock.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span> <span class="o">||</span> <span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">v4mapped</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&amp;&amp;</span> <span class="n">ipv6_only_sock</span><span class="p">(</span><span class="n">sctp_opt2sk</span><span class="p">(</span><span class="n">sp</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sctp_v6_map_v4</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sctp_get_af_specific</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr_valid</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Is this a non-unicast address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_UNICAST</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* What is the scope of &#39;addr&#39;?  */</span>
<span class="k">static</span> <span class="n">sctp_scope_t</span> <span class="nf">sctp_v6_scope</span><span class="p">(</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">v6scope</span><span class="p">;</span>
	<span class="n">sctp_scope_t</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* The IPv6 scope is really a set of bit fields.</span>
<span class="cm">	 * See IFA_* in &lt;net/if_inet6.h&gt;.  Map to a generic SCTP scope.</span>
<span class="cm">	 */</span>

	<span class="n">v6scope</span> <span class="o">=</span> <span class="n">ipv6_addr_scope</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">v6scope</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IFA_HOST</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SCTP_SCOPE_LOOPBACK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IFA_LINK</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SCTP_SCOPE_LINK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IFA_SITE</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SCTP_SCOPE_PRIVATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SCTP_SCOPE_GLOBAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create and initialize a new sk for the socket to be returned by accept(). */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">sctp_v6_create_accept_sk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">sctp_association</span> <span class="o">*</span><span class="n">asoc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">newsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">newnp</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sctp6_sock</span> <span class="o">*</span><span class="n">newsctp6sk</span><span class="p">;</span>

	<span class="n">newsk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">PF_INET6</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newsk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sock_init_data</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">newsk</span><span class="p">);</span>

	<span class="n">sctp_copy_sock</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">asoc</span><span class="p">);</span>
	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>

	<span class="n">newsctp6sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sctp6_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">newsk</span><span class="p">;</span>
	<span class="n">inet_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pinet6</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">newsctp6sk</span><span class="o">-&gt;</span><span class="n">inet6</span><span class="p">;</span>

	<span class="n">sctp_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v4mapped</span> <span class="o">=</span> <span class="n">sctp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v4mapped</span><span class="p">;</span>

	<span class="n">newnp</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">newnp</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6_pinfo</span><span class="p">));</span>

	<span class="cm">/* Initialize sk&#39;s sport, dport, rcv_saddr and daddr for getsockname()</span>
<span class="cm">	 * and getpeername().</span>
<span class="cm">	 */</span>
	<span class="n">sctp_v6_to_sk_daddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asoc</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">primary_addr</span><span class="p">,</span> <span class="n">newsk</span><span class="p">);</span>

	<span class="n">sk_refcnt_debug_inc</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">newsk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sk_common_release</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
		<span class="n">newsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">newsk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Map v4 address to mapped v6 address */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_addr_v4map</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">v4mapped</span> <span class="o">&amp;&amp;</span> <span class="n">AF_INET</span> <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">)</span>
		<span class="n">sctp_v4_map_v6</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Where did this skb come from?  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_skb_iif</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_skb_parm</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet6_skb_parm</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Was this packet marked by Explicit Congestion Notification? */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_v6_is_ce</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Dump the v6 addr to the seq file. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_seq_dump_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%pI6 &quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_v6_ecn_capable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tclass</span> <span class="o">|=</span> <span class="n">INET_ECN_ECT_0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize a PF_INET6 socket msg_name. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_inet6_msgname</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msgname</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin6</span><span class="p">;</span>

	<span class="n">sin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">msgname</span><span class="p">;</span>
	<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_flowinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/*FIXME */</span>
	<span class="o">*</span><span class="n">addr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialize a PF_INET msgname from a ulpevent. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_inet6_event_msgname</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_ulpevent</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">msgname</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin6</span><span class="p">,</span> <span class="o">*</span><span class="n">sin6from</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msgname</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sctp_association</span> <span class="o">*</span><span class="n">asoc</span><span class="p">;</span>

		<span class="n">asoc</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">asoc</span><span class="p">;</span>
		<span class="n">sctp_inet6_msgname</span><span class="p">(</span><span class="n">msgname</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
		<span class="n">sin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">msgname</span><span class="p">;</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">asoc</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">asoc</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">primary_addr</span><span class="p">;</span>

		<span class="cm">/* Note: If we go to a common v6 format, this code</span>
<span class="cm">		 * will change.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Map ipv4 address into v4-mapped-on-v6 address.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sctp_sk</span><span class="p">(</span><span class="n">asoc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v4mapped</span> <span class="o">&amp;&amp;</span>
		    <span class="n">AF_INET</span> <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sctp_v4_map_v6</span><span class="p">((</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="p">)</span><span class="n">sin6</span><span class="p">);</span>
			<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">addr</span><span class="o">-&gt;</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sin6from</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">asoc</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">primary_addr</span><span class="p">.</span><span class="n">v6</span><span class="p">;</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">sin6from</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span>
			<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="n">sin6from</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize a msg_name from an inbound skb. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_inet6_skb_msgname</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msgname</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="o">*</span><span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sctphdr</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msgname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sctp_inet6_msgname</span><span class="p">(</span><span class="n">msgname</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
		<span class="n">sin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">msgname</span><span class="p">;</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">sctp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>

		<span class="cm">/* Map ipv4 address into v4-mapped-on-v6 address. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sctp_sk</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v4mapped</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sctp_v4_map_v6</span><span class="p">((</span><span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="p">)</span><span class="n">sin6</span><span class="p">);</span>
			<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Otherwise, just copy the v6 address. */</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sctp_ulpevent</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">sctp_skb2event</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Do we support this AF? */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_inet6_af_supported</span><span class="p">(</span><span class="n">sa_family_t</span> <span class="n">family</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* v4-mapped-v6 addresses */</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__ipv6_only_sock</span><span class="p">(</span><span class="n">sctp_opt2sk</span><span class="p">(</span><span class="n">sp</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Address matching with wildcards allowed.  This extra level</span>
<span class="cm"> * of indirection lets us choose whether a PF_INET6 should</span>
<span class="cm"> * disallow any v4 addresses if we so choose.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_inet6_cmp_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr1</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr2</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sctp_af</span> <span class="o">*</span><span class="n">af1</span><span class="p">,</span> <span class="o">*</span><span class="n">af2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sctp_opt2sk</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>

	<span class="n">af1</span> <span class="o">=</span> <span class="n">sctp_get_af_specific</span><span class="p">(</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">);</span>
	<span class="n">af2</span> <span class="o">=</span> <span class="n">sctp_get_af_specific</span><span class="p">(</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">af1</span> <span class="o">||</span> <span class="o">!</span><span class="n">af2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the socket is IPv6 only, v4 addrs will not match */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__ipv6_only_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">af1</span> <span class="o">!=</span> <span class="n">af2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Today, wildcard AF_INET/AF_INET6. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sctp_is_any</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr1</span><span class="p">)</span> <span class="o">||</span> <span class="n">sctp_is_any</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr2</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">addr2</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">af1</span><span class="o">-&gt;</span><span class="n">cmp_addr</span><span class="p">(</span><span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Verify that the provided sockaddr looks bindable.   Common verification,</span>
<span class="cm"> * has already been taken care of.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_inet6_bind_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sctp_af</span> <span class="o">*</span><span class="n">af</span><span class="p">;</span>

	<span class="cm">/* ASSERT: address family has already been verified. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">af</span> <span class="o">=</span> <span class="n">sctp_get_af_specific</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span>
						   <span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">ipv6_chk_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">,</span>
					   <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPV6_ADDR_MAPPED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">v4mapped</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">af</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">pf</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Verify that the provided sockaddr looks sendable.   Common verification,</span>
<span class="cm"> * has already been taken care of.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_inet6_send_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="k">union</span> <span class="n">sctp_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sctp_af</span> <span class="o">*</span><span class="n">af</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* ASSERT: address family has already been verified. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">af</span> <span class="o">=</span> <span class="n">sctp_get_af_specific</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_family</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span>
						   <span class="n">addr</span><span class="o">-&gt;</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_scope_id</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">af</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">pf</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">af</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fill in Supported Address Type information for INIT and INIT-ACK</span>
<span class="cm"> * chunks.   Note: In the future, we may want to look at sock options</span>
<span class="cm"> * to determine whether a PF_INET6 socket really wants to have IPV4</span>
<span class="cm"> * addresses.</span>
<span class="cm"> * Returns number of addresses supported.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_inet6_supported_addrs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sctp_sock</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
				      <span class="n">__be16</span> <span class="o">*</span><span class="n">types</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCTP_PARAM_IPV6_ADDRESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opt</span> <span class="o">||</span> <span class="o">!</span><span class="n">ipv6_only_sock</span><span class="p">(</span><span class="n">sctp_opt2sk</span><span class="p">(</span><span class="n">opt</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCTP_PARAM_IPV4_ADDRESS</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">inet6_seqpacket_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		   <span class="o">=</span> <span class="n">PF_INET6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	   <span class="o">=</span> <span class="n">inet6_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span>		   <span class="o">=</span> <span class="n">inet6_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	   <span class="o">=</span> <span class="n">inet_dgram_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span>	   <span class="o">=</span> <span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span>		   <span class="o">=</span> <span class="n">inet_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span>	   <span class="o">=</span> <span class="n">inet6_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		   <span class="o">=</span> <span class="n">sctp_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		   <span class="o">=</span> <span class="n">inet6_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listen</span>		   <span class="o">=</span> <span class="n">sctp_inet_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	   <span class="o">=</span> <span class="n">inet_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>	   <span class="o">=</span> <span class="n">sock_common_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	   <span class="o">=</span> <span class="n">sock_common_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span>	   <span class="o">=</span> <span class="n">inet_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span>	   <span class="o">=</span> <span class="n">sock_common_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		   <span class="o">=</span> <span class="n">sock_no_mmap</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_setsockopt</span> <span class="o">=</span> <span class="n">compat_sock_common_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_getsockopt</span> <span class="o">=</span> <span class="n">compat_sock_common_getsockopt</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inet_protosw</span> <span class="n">sctpv6_seqpacket_protosw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">protocol</span>      <span class="o">=</span> <span class="n">IPPROTO_SCTP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prot</span> 	       <span class="o">=</span> <span class="o">&amp;</span><span class="n">sctpv6_prot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet6_seqpacket_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_check</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>         <span class="o">=</span> <span class="n">SCTP_PROTOSW_FLAG</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inet_protosw</span> <span class="n">sctpv6_stream_protosw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">protocol</span>      <span class="o">=</span> <span class="n">IPPROTO_SCTP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prot</span> 	       <span class="o">=</span> <span class="o">&amp;</span><span class="n">sctpv6_prot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet6_seqpacket_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_check</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>         <span class="o">=</span> <span class="n">SCTP_PROTOSW_FLAG</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp6_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sctp_rcv</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">inet6_protocol</span> <span class="n">sctpv6_protocol</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>      <span class="o">=</span> <span class="n">sctp6_rcv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span>  <span class="o">=</span> <span class="n">sctp_v6_err</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">INET6_PROTO_NOPOLICY</span> <span class="o">|</span> <span class="n">INET6_PROTO_FINAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sctp_af</span> <span class="n">sctp_af_inet6</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sa_family</span>	   <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sctp_xmit</span>	   <span class="o">=</span> <span class="n">sctp_v6_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>	   <span class="o">=</span> <span class="n">ipv6_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	   <span class="o">=</span> <span class="n">ipv6_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dst</span>	   <span class="o">=</span> <span class="n">sctp_v6_get_dst</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_saddr</span>	   <span class="o">=</span> <span class="n">sctp_v6_get_saddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy_addrlist</span>	   <span class="o">=</span> <span class="n">sctp_v6_copy_addrlist</span><span class="p">,</span>
	<span class="p">.</span><span class="n">from_skb</span>	   <span class="o">=</span> <span class="n">sctp_v6_from_skb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">from_sk</span>	   <span class="o">=</span> <span class="n">sctp_v6_from_sk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">to_sk_saddr</span>	   <span class="o">=</span> <span class="n">sctp_v6_to_sk_saddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">to_sk_daddr</span>	   <span class="o">=</span> <span class="n">sctp_v6_to_sk_daddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">from_addr_param</span>   <span class="o">=</span> <span class="n">sctp_v6_from_addr_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">to_addr_param</span>	   <span class="o">=</span> <span class="n">sctp_v6_to_addr_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp_addr</span>	   <span class="o">=</span> <span class="n">sctp_v6_cmp_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scope</span>		   <span class="o">=</span> <span class="n">sctp_v6_scope</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr_valid</span>	   <span class="o">=</span> <span class="n">sctp_v6_addr_valid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inaddr_any</span>	   <span class="o">=</span> <span class="n">sctp_v6_inaddr_any</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_any</span>		   <span class="o">=</span> <span class="n">sctp_v6_is_any</span><span class="p">,</span>
	<span class="p">.</span><span class="n">available</span>	   <span class="o">=</span> <span class="n">sctp_v6_available</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skb_iif</span>	   <span class="o">=</span> <span class="n">sctp_v6_skb_iif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_ce</span>		   <span class="o">=</span> <span class="n">sctp_v6_is_ce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">seq_dump_addr</span>	   <span class="o">=</span> <span class="n">sctp_v6_seq_dump_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ecn_capable</span>	   <span class="o">=</span> <span class="n">sctp_v6_ecn_capable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">net_header_len</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">),</span>
	<span class="p">.</span><span class="n">sockaddr_len</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_setsockopt</span> <span class="o">=</span> <span class="n">compat_ipv6_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_getsockopt</span> <span class="o">=</span> <span class="n">compat_ipv6_getsockopt</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sctp_pf</span> <span class="n">sctp_pf_inet6</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">event_msgname</span> <span class="o">=</span> <span class="n">sctp_inet6_event_msgname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skb_msgname</span>   <span class="o">=</span> <span class="n">sctp_inet6_skb_msgname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">af_supported</span>  <span class="o">=</span> <span class="n">sctp_inet6_af_supported</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp_addr</span>      <span class="o">=</span> <span class="n">sctp_inet6_cmp_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_verify</span>   <span class="o">=</span> <span class="n">sctp_inet6_bind_verify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_verify</span>   <span class="o">=</span> <span class="n">sctp_inet6_send_verify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported_addrs</span> <span class="o">=</span> <span class="n">sctp_inet6_supported_addrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_accept_sk</span> <span class="o">=</span> <span class="n">sctp_v6_create_accept_sk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr_v4map</span>    <span class="o">=</span> <span class="n">sctp_v6_addr_v4map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">af</span>            <span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_af_inet6</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Initialize IPv6 support and register with socket layer.  */</span>
<span class="kt">void</span> <span class="nf">sctp_v6_pf_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Register the SCTP specific PF_INET6 functions. */</span>
	<span class="n">sctp_register_pf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_pf_inet6</span><span class="p">,</span> <span class="n">PF_INET6</span><span class="p">);</span>

	<span class="cm">/* Register the SCTP specific AF_INET6 functions. */</span>
	<span class="n">sctp_register_af</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_af_inet6</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sctp_v6_pf_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_af_inet6</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialize IPv6 support and register with socket layer.  */</span>
<span class="kt">int</span> <span class="nf">sctp_v6_protosw_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_prot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Add SCTPv6(UDP and TCP style) to inetsw6 linked list. */</span>
	<span class="n">inet6_register_protosw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_seqpacket_protosw</span><span class="p">);</span>
	<span class="n">inet6_register_protosw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_stream_protosw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sctp_v6_protosw_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet6_unregister_protosw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_seqpacket_protosw</span><span class="p">);</span>
	<span class="n">inet6_unregister_protosw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_stream_protosw</span><span class="p">);</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_prot</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Register with inet6 layer. */</span>
<span class="kt">int</span> <span class="nf">sctp_v6_add_protocol</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Register notifier for inet6 address additions/deletions. */</span>
	<span class="n">register_inet6addr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_inet6addr_notifier</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inet6_add_protocol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_protocol</span><span class="p">,</span> <span class="n">IPPROTO_SCTP</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Unregister with inet6 layer. */</span>
<span class="kt">void</span> <span class="nf">sctp_v6_del_protocol</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet6_del_protocol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctpv6_protocol</span><span class="p">,</span> <span class="n">IPPROTO_SCTP</span><span class="p">);</span>
	<span class="n">unregister_inet6addr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctp_inet6addr_notifier</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
