<!DOCTYPE html>
<html><head><title>joekychen/linux » net › decnet › af_decnet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>af_decnet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * DECnet       An implementation of the DECnet protocol suite for the LINUX</span>
<span class="cm"> *              operating system.  DECnet is implemented using the  BSD Socket</span>
<span class="cm"> *              interface as the means of communication with the user level.</span>
<span class="cm"> *</span>
<span class="cm"> *              DECnet Socket Layer Interface</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:     Eduardo Marcelo Serrat &lt;emserrat@geocities.com&gt;</span>
<span class="cm"> *              Patrick Caulfield &lt;patrick@pandh.demon.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:</span>
<span class="cm"> *        Steve Whitehouse: Copied from Eduardo Serrat and Patrick Caulfield&#39;s</span>
<span class="cm"> *                          version of the code. Original copyright preserved</span>
<span class="cm"> *                          below.</span>
<span class="cm"> *        Steve Whitehouse: Some bug fixes, cleaning up some code to make it</span>
<span class="cm"> *                          compatible with my routing layer.</span>
<span class="cm"> *        Steve Whitehouse: Merging changes from Eduardo Serrat and Patrick</span>
<span class="cm"> *                          Caulfield.</span>
<span class="cm"> *        Steve Whitehouse: Further bug fixes, checking module code still works</span>
<span class="cm"> *                          with new routing layer.</span>
<span class="cm"> *        Steve Whitehouse: Additional set/get_sockopt() calls.</span>
<span class="cm"> *        Steve Whitehouse: Fixed TIOCINQ ioctl to be same as Eduardo&#39;s new</span>
<span class="cm"> *                          code.</span>
<span class="cm"> *        Steve Whitehouse: recvmsg() changed to try and behave in a POSIX like</span>
<span class="cm"> *                          way. Didn&#39;t manage it entirely, but its better.</span>
<span class="cm"> *        Steve Whitehouse: ditto for sendmsg().</span>
<span class="cm"> *        Steve Whitehouse: A selection of bug fixes to various things.</span>
<span class="cm"> *        Steve Whitehouse: Added TIOCOUTQ ioctl.</span>
<span class="cm"> *        Steve Whitehouse: Fixes to username2sockaddr &amp; sockaddr2username.</span>
<span class="cm"> *        Steve Whitehouse: Fixes to connect() error returns.</span>
<span class="cm"> *       Patrick Caulfield: Fixes to delayed acceptance logic.</span>
<span class="cm"> *         David S. Miller: New socket locking</span>
<span class="cm"> *        Steve Whitehouse: Socket list hashing/locking</span>
<span class="cm"> *         Arnaldo C. Melo: use capable, not suser</span>
<span class="cm"> *        Steve Whitehouse: Removed unused code. Fix to use sk-&gt;allocation</span>
<span class="cm"> *                          when required.</span>
<span class="cm"> *       Patrick Caulfield: /proc/net/decnet now has object name/number</span>
<span class="cm"> *        Steve Whitehouse: Fixed local port allocation, hashed sk list</span>
<span class="cm"> *          Matthew Wilcox: Fixes for dn_ioctl()</span>
<span class="cm"> *        Steve Whitehouse: New connect/accept logic to allow timeouts and</span>
<span class="cm"> *                          prepare for sendpage etc.</span>
<span class="cm"> */</span>


<span class="cm">/******************************************************************************</span>
<span class="cm">    (c) 1995-1998 E.M. Serrat		emserrat@geocities.com</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">HISTORY:</span>

<span class="cm">Version           Kernel     Date       Author/Comments</span>
<span class="cm">-------           ------     ----       ---------------</span>
<span class="cm">Version 0.0.1     2.0.30    01-dic-97	Eduardo Marcelo Serrat</span>
<span class="cm">					(emserrat@geocities.com)</span>

<span class="cm">					First Development of DECnet Socket La-</span>
<span class="cm">					yer for Linux. Only supports outgoing</span>
<span class="cm">					connections.</span>

<span class="cm">Version 0.0.2	  2.1.105   20-jun-98   Patrick J. Caulfield</span>
<span class="cm">					(patrick@pandh.demon.co.uk)</span>

<span class="cm">					Port to new kernel development version.</span>

<span class="cm">Version 0.0.3     2.1.106   25-jun-98   Eduardo Marcelo Serrat</span>
<span class="cm">					(emserrat@geocities.com)</span>
<span class="cm">					_</span>
<span class="cm">					Added support for incoming connections</span>
<span class="cm">					so we can start developing server apps</span>
<span class="cm">					on Linux.</span>
<span class="cm">					-</span>
<span class="cm">					Module Support</span>
<span class="cm">Version 0.0.4     2.1.109   21-jul-98   Eduardo Marcelo Serrat</span>
<span class="cm">				       (emserrat@geocities.com)</span>
<span class="cm">				       _</span>
<span class="cm">					Added support for X11R6.4. Now we can</span>
<span class="cm">					use DECnet transport for X on Linux!!!</span>
<span class="cm">				       -</span>
<span class="cm">Version 0.0.5    2.1.110   01-aug-98   Eduardo Marcelo Serrat</span>
<span class="cm">				       (emserrat@geocities.com)</span>
<span class="cm">				       Removed bugs on flow control</span>
<span class="cm">				       Removed bugs on incoming accessdata</span>
<span class="cm">				       order</span>
<span class="cm">				       -</span>
<span class="cm">Version 0.0.6    2.1.110   07-aug-98   Eduardo Marcelo Serrat</span>
<span class="cm">				       dn_recvmsg fixes</span>

<span class="cm">					Patrick J. Caulfield</span>
<span class="cm">				       dn_bind fixes</span>
<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/route.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/tcp_states.h&gt;</span>
<span class="cp">#include &lt;net/flow.h&gt;</span>
<span class="cp">#include &lt;asm/ioctls.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/neighbour.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;net/fib_rules.h&gt;</span>
<span class="cp">#include &lt;net/dn.h&gt;</span>
<span class="cp">#include &lt;net/dn_nsp.h&gt;</span>
<span class="cp">#include &lt;net/dn_dev.h&gt;</span>
<span class="cp">#include &lt;net/dn_route.h&gt;</span>
<span class="cp">#include &lt;net/dn_fib.h&gt;</span>
<span class="cp">#include &lt;net/dn_neigh.h&gt;</span>

<span class="k">struct</span> <span class="n">dn_sock</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="n">scp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dn_keepalive</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="cp">#define DN_SK_HASH_SHIFT 8</span>
<span class="cp">#define DN_SK_HASH_SIZE (1 &lt;&lt; DN_SK_HASH_SHIFT)</span>
<span class="cp">#define DN_SK_HASH_MASK (DN_SK_HASH_SIZE - 1)</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">dn_proto_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">dn_hash_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">dn_sk_hash</span><span class="p">[</span><span class="n">DN_SK_HASH_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">dn_wild_sk</span><span class="p">;</span>
<span class="k">static</span> <span class="n">atomic_long_t</span> <span class="n">decnet_memory_allocated</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__dn_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__dn_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="nf">dn_find_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_flags</span> <span class="o">&amp;</span> <span class="n">SDF_WILD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_wild_sk</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">dn_wild_sk</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dn_sk_hash</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrloc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DN_SK_HASH_MASK</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Valid ports are those greater than zero and not already in use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_port</span><span class="p">(</span><span class="n">__le16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dn_sk_hash</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DN_SK_HASH_MASK</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrloc</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">port_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">check_port</span><span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">++</span><span class="n">port</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="n">i_port</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrloc</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Since this is only ever called from user</span>
<span class="cm"> * level, we don&#39;t need a write_lock() version</span>
<span class="cm"> * of this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_hash_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EUSERS</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sk_hashed</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrloc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port_alloc</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">list</span> <span class="o">=</span> <span class="n">dn_find_list</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sk_add_node</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_unhash_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="n">sk_del_node_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_unhash_sock_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="n">sk_del_node_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="nf">listen_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hash</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hash</span> <span class="o">^=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objname</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">hash</span> <span class="o">^=</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dn_sk_hash</span><span class="p">[</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="n">DN_SK_HASH_MASK</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called to transform a socket from bound (i.e. with a local address)</span>
<span class="cm"> * into a listening socket (doesn&#39;t need a local port number) and rehashes</span>
<span class="cm"> * based upon the object name/number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_rehash_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_flags</span> <span class="o">&amp;</span> <span class="n">SDF_WILD</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="n">sk_del_node_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addrloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list</span> <span class="o">=</span> <span class="n">listen_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">sk_add_node</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dn_sockaddr2username</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">sdn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objname</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objname</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On reception of usernames, we handle types 1 and 0 for destination</span>
<span class="cm"> * addresses only. Types 2 and 4 are used for source addresses, but the</span>
<span class="cm"> * UIC, GIC are ignored and they are both treated the same way. Type 3</span>
<span class="cm"> * is never used as I&#39;ve no idea what its purpose might be or what its</span>
<span class="cm"> * format is.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dn_username2sockaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">sdn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">namel</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DN_MAXOBJL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">namel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">len</span>  <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">len</span>  <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">namel</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objname</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sdn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">size</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">dn_sklist_find_listener</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">listen_hash</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objnum</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objnum</span> <span class="o">!=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objnamel</span> <span class="o">!=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objname</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objname</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_wild_sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
			<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">dn_find_by_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_skb_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">DN_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dn_sk_hash</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">dst_port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DN_SK_HASH_MASK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">!=</span> <span class="n">dn_saddr2dn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">dst_port</span> <span class="o">!=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrloc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrrem</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">src_port</span> <span class="o">!=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrrem</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_destruct</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">data_xmit_queue</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_xmit_queue</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_receive_queue</span><span class="p">);</span>

	<span class="n">dst_release</span><span class="p">(</span><span class="n">rcu_dereference_check</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_dst_cache</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dn_memory_pressure</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_enter_memory_pressure</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn_memory_pressure</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dn_memory_pressure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">dn_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;NSP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enter_memory_pressure</span>	<span class="o">=</span> <span class="n">dn_enter_memory_pressure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">memory_pressure</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dn_memory_pressure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">memory_allocated</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">decnet_memory_allocated</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysctl_mem</span>		<span class="o">=</span> <span class="n">sysctl_decnet_mem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysctl_wmem</span>		<span class="o">=</span> <span class="n">sysctl_decnet_wmem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysctl_rmem</span>		<span class="o">=</span> <span class="n">sysctl_decnet_rmem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_header</span>		<span class="o">=</span> <span class="n">DN_MAX_NSP_DATA_HEADER</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dn_sock</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">dn_alloc_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_DECnet</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dn_proto</span><span class="p">);</span>

	<span class="k">if</span>  <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dn_proto_ops</span><span class="p">;</span>
	<span class="n">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_backlog_rcv</span> <span class="o">=</span> <span class="n">dn_nsp_backlog_rcv</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_destruct</span>    <span class="o">=</span> <span class="n">dn_destruct</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_no_check</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span>      <span class="o">=</span> <span class="n">PF_DECnet</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span>  <span class="o">=</span> <span class="n">gfp</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span>	   <span class="o">=</span> <span class="n">sysctl_decnet_wmem</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span>	   <span class="o">=</span> <span class="n">sysctl_decnet_rmem</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Initialization of DECnet Session Control Port		*/</span>
	<span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span>	<span class="o">=</span> <span class="n">DN_O</span><span class="p">;</span>		<span class="cm">/* Open			*/</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">numdat</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Next data seg to tx	*/</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">numoth</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Next oth data to tx  */</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackxmt_dat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Last data seg ack&#39;ed */</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackxmt_oth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Last oth data ack&#39;ed */</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackrcv_dat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Highest data ack recv*/</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackrcv_oth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Last oth data ack rec*/</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_sw</span> <span class="o">=</span> <span class="n">DN_SEND</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowloc_sw</span> <span class="o">=</span> <span class="n">DN_SEND</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_dat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_oth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowloc_dat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowloc_oth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">services_rem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">services_loc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">NSP_FC_NONE</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">info_rem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">info_loc</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* NSP version 4.1 */</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">segsize_rem</span> <span class="o">=</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">DN_MAX_NSP_DATA_HEADER</span><span class="p">;</span> <span class="cm">/* Default: Updated by remote segsize */</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">multi_ireq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">accept_mode</span> <span class="o">=</span> <span class="n">ACC_IMMED</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_family</span>    <span class="o">=</span> <span class="n">AF_DECnet</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">sdn_family</span>    <span class="o">=</span> <span class="n">AF_DECnet</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_accl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_acc</span><span class="p">,</span> <span class="s">&quot;LINUX&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">max_window</span>   <span class="o">=</span> <span class="n">NSP_MAX_WINDOW</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">snd_window</span>   <span class="o">=</span> <span class="n">NSP_MIN_WINDOW</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">nsp_srtt</span>     <span class="o">=</span> <span class="n">NSP_INITIAL_SRTT</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">nsp_rttvar</span>   <span class="o">=</span> <span class="n">NSP_INITIAL_RTTVAR</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">nsp_rxtshift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">data_xmit_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_xmit_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_receive_queue</span><span class="p">);</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist_fxn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">keepalive</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">keepalive_fxn</span> <span class="o">=</span> <span class="n">dn_keepalive</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">delack_timer</span><span class="p">);</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">delack_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">delack_fxn</span> <span class="o">=</span> <span class="n">dn_nsp_delayed_ack</span><span class="p">;</span>

	<span class="n">dn_start_slow_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Keepalive timer.</span>
<span class="cm"> * FIXME: Should respond to SO_KEEPALIVE etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_keepalive</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * By checking the other_data transmit queue is empty</span>
<span class="cm">	 * we are double checking that we are not sending too</span>
<span class="cm">	 * many of these keepalive frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_xmit_queue</span><span class="p">))</span>
		<span class="n">dn_nsp_send_link</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DN_NOCHANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Timer for shutdown/destroyed sockets.</span>
<span class="cm"> * When socket is dead &amp; no packets have been sent for a</span>
<span class="cm"> * certain amount of time, they are removed by this</span>
<span class="cm"> * routine. Also takes care of sending out DI &amp; DC</span>
<span class="cm"> * frames at correct times.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dn_destroy_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist</span> <span class="o">=</span> <span class="n">dn_nsp_persist</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DN_DI</span>:
		<span class="n">dn_nsp_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NSP_DISCINIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">nsp_rxtshift</span> <span class="o">&gt;=</span> <span class="n">decnet_di_count</span><span class="p">)</span>
			<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DN_CN</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DN_DR</span>:
		<span class="n">dn_nsp_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NSP_DISCINIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">nsp_rxtshift</span> <span class="o">&gt;=</span> <span class="n">decnet_dr_count</span><span class="p">)</span>
			<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DN_DRC</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DN_DN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">nsp_rxtshift</span> <span class="o">&lt;</span> <span class="n">decnet_dn_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* printk(KERN_DEBUG &quot;dn_destroy_timer: DN\n&quot;); */</span>
			<span class="n">dn_nsp_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NSP_DISCCONF</span><span class="p">,</span> <span class="n">NSP_REASON_DC</span><span class="p">,</span>
					 <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">decnet_time_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">stamp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">decnet_time_wait</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dn_unhash_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_destroy_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">nsp_rxtshift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* reset back off */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SS_UNCONNECTED</span><span class="p">)</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_DISCONNECTING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_CLOSE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DN_DN</span>:
		<span class="n">dn_nsp_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NSP_DISCCONF</span><span class="p">,</span> <span class="n">NSP_REASON_DC</span><span class="p">,</span>
				 <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist_fxn</span> <span class="o">=</span> <span class="n">dn_destroy_timer</span><span class="p">;</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist</span> <span class="o">=</span> <span class="n">dn_nsp_persist</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CR</span>:
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DN_DR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">disc_reject</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_RUN</span>:
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DN_DI</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_DI</span>:
	<span class="k">case</span> <span class="n">DN_DR</span>:
<span class="nl">disc_reject:</span>
		<span class="n">dn_nsp_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NSP_DISCINIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DN_NC</span>:
	<span class="k">case</span> <span class="n">DN_NR</span>:
	<span class="k">case</span> <span class="n">DN_RJ</span>:
	<span class="k">case</span> <span class="n">DN_DIC</span>:
	<span class="k">case</span> <span class="n">DN_CN</span>:
	<span class="k">case</span> <span class="n">DN_DRC</span>:
	<span class="k">case</span> <span class="n">DN_CI</span>:
	<span class="k">case</span> <span class="n">DN_CD</span>:
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist_fxn</span> <span class="o">=</span> <span class="n">dn_destroy_timer</span><span class="p">;</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist</span> <span class="o">=</span> <span class="n">dn_nsp_persist</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DECnet: dn_destroy_sock passed socket in invalid state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DN_O</span>:
		<span class="n">dn_stop_slow_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="n">dn_unhash_sock_bh</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">dn_addr2asc</span><span class="p">(</span><span class="n">__u16</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">node</span><span class="p">,</span> <span class="n">area</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x03ff</span><span class="p">;</span>
	<span class="n">area</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hd.%hd&quot;</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOCK_SEQPACKET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">DNPROTO_NSP</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOCK_STREAM</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">sk</span> <span class="o">=</span> <span class="n">dn_alloc_sock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dn_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock_orphan</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">dn_destroy_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">saddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">ldev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_family</span> <span class="o">!=</span> <span class="n">AF_DECnet</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_nodeaddrl</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_nodeaddrl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DN_MAXOBJL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SDF_WILD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_BIND_SERVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_flags</span> <span class="o">&amp;</span> <span class="n">SDF_WILD</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_flags</span> <span class="o">&amp;</span> <span class="n">SDF_WILD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">saddr</span><span class="o">-&gt;</span><span class="n">sdn_nodeaddrl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">ldev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dn_ptr</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dn_dev_islocal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dn_saddr2dn</span><span class="p">(</span><span class="n">saddr</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">ldev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ldev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
		<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">dn_hash_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
			<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_auto_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_flags</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This stuff is to keep compatibility with Eduardo&#39;s</span>
<span class="cm">	 * patch. I hope I can dispense with it shortly...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_accl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_accl</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objnamel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_accl</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objname</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_acc</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_objnamel</span><span class="p">));</span>

		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_accl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">.</span><span class="n">acc_acc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* End of compatibility stuff */</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_add</span><span class="p">.</span><span class="n">a_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">dn_dev_bind_default</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_add</span><span class="p">.</span><span class="n">a_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">dn_hash_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
			<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_confirm_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timeo</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">allocation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DN_CC</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">segsize_loc</span> <span class="o">=</span> <span class="n">dst_metric_advmss</span><span class="p">(</span><span class="n">__sk_dst_get</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="n">dn_send_conn_conf</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">allocation</span><span class="p">);</span>

	<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_CC</span><span class="p">)</span>
			<span class="o">*</span><span class="n">timeo</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">timeo</span><span class="p">);</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_RUN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="o">*</span><span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">timeo</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_wait_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_RUN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">timeo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_CI</span> <span class="o">||</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_CC</span><span class="p">)</span>
			<span class="o">*</span><span class="n">timeo</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">timeo</span><span class="p">);</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_RUN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="o">*</span><span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">timeo</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CI</span> <span class="o">&amp;&amp;</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dn_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timeo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowidn</span> <span class="n">fld</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_RUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CI</span> <span class="o">&amp;&amp;</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">dn_wait_run</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_O</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">addrlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_family</span> <span class="o">!=</span> <span class="n">AF_DECnet</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sdn_flags</span> <span class="o">&amp;</span> <span class="n">SDF_WILD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dn_auto_bind</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fld</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fld</span><span class="p">));</span>
	<span class="n">fld</span><span class="p">.</span><span class="n">flowidn_oif</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">;</span>
	<span class="n">fld</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">dn_saddr2dn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">);</span>
	<span class="n">fld</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">dn_saddr2dn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">dn_sk_ports_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fld</span><span class="p">,</span> <span class="n">scp</span><span class="p">);</span>
	<span class="n">fld</span><span class="p">.</span><span class="n">flowidn_proto</span> <span class="o">=</span> <span class="n">DNPROTO_NSP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dn_route_output_sock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_dst_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fld</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_route_caps</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_dst_cache</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTING</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DN_CI</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">segsize_loc</span> <span class="o">=</span> <span class="n">dst_metric_advmss</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_dst_cache</span><span class="p">);</span>

	<span class="n">dn_nsp_send_conninit</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NSP_CI</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">timeo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dn_wait_run</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__dn_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dn_check_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timeo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DN_RUN</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CR</span>:
		<span class="k">return</span> <span class="n">dn_confirm_accept</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeo</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DN_CI</span>:
	<span class="k">case</span> <span class="n">DN_CC</span>:
		<span class="k">return</span> <span class="n">dn_wait_run</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DN_O</span>:
		<span class="k">return</span> <span class="n">__dn_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="n">timeo</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_access_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">accessdata_dn</span> <span class="o">*</span><span class="n">acc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_userl</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_user</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_userl</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_userl</span><span class="p">;</span>

	<span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_passl</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_pass</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_passl</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_passl</span><span class="p">;</span>

	<span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_accl</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_acc</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_accl</span><span class="p">);</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_accl</span> <span class="o">+</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_passl</span> <span class="o">+</span> <span class="n">acc</span><span class="o">-&gt;</span><span class="n">acc_userl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_user_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">optdata_dn</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* yes, it&#39;s 8bit on the wire */</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">);</span> <span class="cm">/* we&#39;ve checked the contents earlier */</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt_optl</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt_data</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">dn_wait_for_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">timeo</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">timeo</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="o">*</span><span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">timeo</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">:</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">newsock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="o">*</span><span class="n">newsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_skb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">menuver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_rcvtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span> <span class="o">||</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_O</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dn_wait_for_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="n">DN_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="o">--</span><span class="p">;</span>
	<span class="n">newsk</span> <span class="o">=</span> <span class="n">dn_alloc_sock</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">newsock</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newsk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sk_dst_set</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span>        <span class="o">=</span> <span class="n">DN_CR</span><span class="p">;</span>
	<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addrrem</span>      <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">src_port</span><span class="p">;</span>
	<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">services_rem</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">services</span><span class="p">;</span>
	<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info_rem</span>     <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">segsize_rem</span>  <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">segsize</span><span class="p">;</span>
	<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">accept_mode</span>  <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">accept_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">segsize_rem</span> <span class="o">&lt;</span> <span class="mi">230</span><span class="p">)</span>
		<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">segsize_rem</span> <span class="o">=</span> <span class="mi">230</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">services_rem</span> <span class="o">&amp;</span> <span class="n">NSP_FC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NSP_FC_NONE</span><span class="p">)</span>
		<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max_window</span> <span class="o">=</span> <span class="n">decnet_no_fc_max_cwnd</span><span class="p">;</span>

	<span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_state</span>  <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are listening on a wild socket, we don&#39;t want</span>
<span class="cm">	 * the newly created socket on the wrong hash queue.</span>
<span class="cm">	 */</span>
	<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDF_WILD</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dn_username2sockaddr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">));</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dn_username2sockaddr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">));</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">sdn_add</span><span class="p">.</span><span class="n">a_addr</span><span class="p">)</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sdn_add</span><span class="p">.</span><span class="n">a_addr</span><span class="p">)</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">menuver</span> <span class="o">=</span> <span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">menuver</span> <span class="o">&amp;</span> <span class="n">DN_MENUVER_ACC</span><span class="p">)</span>
		<span class="n">dn_access_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">menuver</span> <span class="o">&amp;</span> <span class="n">DN_MENUVER_USR</span><span class="p">)</span>
		<span class="n">dn_user_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">conndata_in</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">menuver</span> <span class="o">&amp;</span> <span class="n">DN_MENUVER_PRX</span><span class="p">)</span>
		<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">sdn_flags</span> <span class="o">|=</span> <span class="n">SDF_PROXY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">menuver</span> <span class="o">&amp;</span> <span class="n">DN_MENUVER_UIC</span><span class="p">)</span>
		<span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">.</span><span class="n">sdn_flags</span> <span class="o">|=</span> <span class="n">SDF_UICPROXY</span><span class="p">;</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">conndata_out</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">conndata_out</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">discdata_out</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">discdata_out</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">));</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dn_hash_sock</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
		<span class="n">dn_send_conn_ack</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Here we use sk-&gt;sk_allocation since although the conn conf is</span>
<span class="cm">		 * for the newsk, the context is the old socket.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">accept_mode</span> <span class="o">==</span> <span class="n">ACC_IMMED</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dn_confirm_accept</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">,</span>
						<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_getname</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">uaddr_len</span><span class="p">,</span><span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="o">*</span><span class="n">uaddr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SS_CONNECTED</span> <span class="o">&amp;&amp;</span>
		     <span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SS_CONNECTING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">accept_mode</span> <span class="o">==</span> <span class="n">ACC_IMMED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dn_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">poll_table</span>  <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">datagram_poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_receive_queue</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLRDBAND</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>:
		<span class="k">return</span> <span class="n">dn_dev_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SIOCATMARK</span>:
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_receive_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_RUN</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TIOCOUTQ</span>:
		<span class="n">amount</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">-</span> <span class="n">sk_wmem_alloc_get</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TIOCINQ</span>:
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_receive_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span>
				<span class="n">amount</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_O</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>           <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>
	<span class="n">err</span>                 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dn_rehash_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">how</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_UNCONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_DISCONNECTING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DN_O</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">how</span> <span class="o">!=</span> <span class="n">SHUTDOWN_MASK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">=</span> <span class="n">how</span><span class="p">;</span>
	<span class="n">dn_destroy_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__dn_setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dn_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span><span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">optdata_dn</span> <span class="n">opt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">accessdata_dn</span> <span class="n">acc</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">win</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">services</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">info</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">optval</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSO_CONDATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_O</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CR</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">opt_optl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">conndata_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">opt</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_DISDATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SS_CONNECTED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">accept_mode</span> <span class="o">==</span> <span class="n">ACC_IMMED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">opt_optl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">discdata_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">opt</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_CONACCESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_O</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">accessdata_dn</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="p">.</span><span class="n">acc</span><span class="p">.</span><span class="n">acc_accl</span> <span class="o">&gt;</span> <span class="n">DN_MAXACCL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">acc</span><span class="p">.</span><span class="n">acc_passl</span> <span class="o">&gt;</span> <span class="n">DN_MAXACCL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">acc</span><span class="p">.</span><span class="n">acc_userl</span> <span class="o">&gt;</span> <span class="n">DN_MAXACCL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">acc</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_ACCEPTMODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_O</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">ACC_IMMED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">ACC_DEFER</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">accept_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_CONACCEPT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_rcvtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dn_confirm_accept</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_CONREJECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_CR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DN_DR</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">=</span> <span class="n">SHUTDOWN_MASK</span><span class="p">;</span>
		<span class="n">dn_nsp_send_disc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_NETFILTER</span>
		<span class="k">return</span> <span class="n">nf_setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">PF_DECnet</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">DSO_LINKINFO</span>:
	<span class="k">case</span> <span class="n">DSO_STREAM</span>:
	<span class="k">case</span> <span class="n">DSO_SEQPACKET</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_MAXWINDOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">win</span> <span class="o">&gt;</span> <span class="n">NSP_MAX_WINDOW</span><span class="p">)</span>
			<span class="n">u</span><span class="p">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">NSP_MAX_WINDOW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">win</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">max_window</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">snd_window</span> <span class="o">&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">win</span><span class="p">)</span>
			<span class="n">scp</span><span class="o">-&gt;</span><span class="n">snd_window</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_NODELAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* if (scp-&gt;nonagle == 1) { Push pending frames } */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_CORK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* if (scp-&gt;nonagle == 0) { Push pending frames } */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_SERVICES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="p">.</span><span class="n">services</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NSP_FC_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="p">.</span><span class="n">services</span> <span class="o">&amp;</span> <span class="n">NSP_FC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NSP_FC_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">services_loc</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">services</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">info_loc</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__dn_getsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dn_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span><span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">linkinfo_dn</span> <span class="n">link</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r_len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">r_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">r_len</span> <span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSO_CONDATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">conndata_in</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_DISDATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">optdata_dn</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">discdata_in</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_CONACCESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">accessdata_dn</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">accessdata_dn</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accessdata</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_ACCEPTMODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accept_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_LINKINFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">linkinfo_dn</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">linkinfo_dn</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SS_CONNECTING</span>:
			<span class="n">link</span><span class="p">.</span><span class="n">idn_linkstate</span> <span class="o">=</span> <span class="n">LL_CONNECTING</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SS_DISCONNECTING</span>:
			<span class="n">link</span><span class="p">.</span><span class="n">idn_linkstate</span> <span class="o">=</span> <span class="n">LL_DISCONNECTING</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SS_CONNECTED</span>:
			<span class="n">link</span><span class="p">.</span><span class="n">idn_linkstate</span> <span class="o">=</span> <span class="n">LL_RUNNING</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">link</span><span class="p">.</span><span class="n">idn_linkstate</span> <span class="o">=</span> <span class="n">LL_INACTIVE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">link</span><span class="p">.</span><span class="n">idn_segsize</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">segsize_rem</span><span class="p">;</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_NETFILTER</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">PF_DECnet</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">DSO_STREAM</span>:
	<span class="k">case</span> <span class="n">DSO_SEQPACKET</span>:
	<span class="k">case</span> <span class="n">DSO_CONACCEPT</span>:
	<span class="k">case</span> <span class="n">DSO_CONREJECT</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_MAXWINDOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">max_window</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_NODELAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_CORK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_SERVICES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">services_rem</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSO_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span>
			<span class="n">r_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">info_rem</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">r_data</span><span class="p">,</span> <span class="n">r_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">r_len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dn_skb_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">DN_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">nsp_flags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SOCK_SEQPACKET reads to EOM */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* so does SOCK_STREAM unless WAITALL is specified */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_WAITALL</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* minimum data length for read exceeded */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_skb_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">eor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_rcvtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">dn_check_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSG_CMSG_COMPAT</span><span class="o">|</span><span class="n">MSG_PEEK</span><span class="o">|</span><span class="n">MSG_OOB</span><span class="o">|</span><span class="n">MSG_WAITALL</span><span class="o">|</span><span class="n">MSG_DONTWAIT</span><span class="o">|</span><span class="n">MSG_NOSIGNAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_receive_queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_WAITALL</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * See if there is data ready to read, sleep if there isn&#39;t</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_receive_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_OOB</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_report</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_report</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DN_RUN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dn_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_ASYNC_WAITDATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sk_wait_event</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">,</span> <span class="n">dn_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">target</span><span class="p">));</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">SOCK_ASYNC_WAITDATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">cb</span> <span class="o">=</span> <span class="n">DN_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">chunk</span> <span class="o">+</span> <span class="n">copied</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">chunk</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">copied</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcpy_toiovec</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">chunk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>

		<span class="n">eor</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nsp_flags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * N.B. Don&#39;t refer to skb or cb after this point</span>
<span class="cm">			 * in loop.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowloc_sw</span> <span class="o">==</span> <span class="n">DN_DONTSEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dn_congested</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowloc_sw</span> <span class="o">=</span> <span class="n">DN_SEND</span><span class="p">;</span>
				<span class="n">dn_nsp_send_link</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DN_SEND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_WAITALL</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">copied</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">eor</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">SOCK_SEQPACKET</span><span class="p">))</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_EOR</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">:</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rv</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">));</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dn_queue_too_long</span><span class="p">(</span><span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fctype</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">services_rem</span> <span class="o">&amp;</span> <span class="n">NSP_FC_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">snd_window</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fctype</span> <span class="o">!=</span> <span class="n">NSP_FC_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_oth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_dat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The DECnet spec requires that the &quot;routing layer&quot; accepts packets which</span>
<span class="cm"> * are at least 230 bytes in size. This excludes any headers which the NSP</span>
<span class="cm"> * layer might add, so we always assume that we&#39;ll be using the maximal</span>
<span class="cm"> * length header on data packets. The variation in length is due to the</span>
<span class="cm"> * inclusion (or not) of the two 16 bit acknowledgement fields so it doesn&#39;t</span>
<span class="cm"> * make much practical difference.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dn_mss_from_pmtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mss</span> <span class="o">=</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">DN_MAX_NSP_DATA_HEADER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dn_dev</span> <span class="o">*</span><span class="n">dn_db</span> <span class="o">=</span> <span class="n">rcu_dereference_raw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dn_ptr</span><span class="p">);</span>
		<span class="n">mtu</span> <span class="o">-=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dn_db</span><span class="o">-&gt;</span><span class="n">use_long</span><span class="p">)</span>
			<span class="n">mtu</span> <span class="o">-=</span> <span class="mi">21</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mtu</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">mtu</span> <span class="o">-=</span> <span class="n">DN_MAX_NSP_DATA_HEADER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 21 = long header, 16 = guess at MAC header length</span>
<span class="cm">		 */</span>
		<span class="n">mtu</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="n">DN_MAX_NSP_DATA_HEADER</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">mss</span><span class="p">)</span>
		<span class="n">mss</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mss</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dn_current_mss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">__sk_dst_get</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mss_now</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">segsize_loc</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">segsize_rem</span><span class="p">);</span>

	<span class="cm">/* Other data messages are limited to 16 bytes per packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* This works out the maximum size of segment we can send out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">mss_now</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">dn_mss_from_pmtu</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mtu</span><span class="p">),</span> <span class="n">mss_now</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mss_now</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * N.B. We get the timeout wrong here, but then we always did get it</span>
<span class="cm"> * wrong before and this is another step along the road to correcting</span>
<span class="cm"> * it. It ought to get updated each time we pass through the routine,</span>
<span class="cm"> * but in practise it probably doesn&#39;t matter too much for now.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">dn_alloc_send_pskb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">datalen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noblock</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">errcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span>
						   <span class="n">noblock</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_DNA_RT</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OUTGOING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">mss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">data_xmit_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr_len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_skb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fctype</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSG_TRYHARD</span><span class="o">|</span><span class="n">MSG_OOB</span><span class="o">|</span><span class="n">MSG_DONTWAIT</span><span class="o">|</span><span class="n">MSG_EOR</span><span class="o">|</span><span class="n">MSG_NOSIGNAL</span><span class="o">|</span><span class="n">MSG_MORE</span><span class="o">|</span><span class="n">MSG_CMSG_COMPAT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The only difference between stream sockets and sequenced packet</span>
<span class="cm">	 * sockets is that the stream sockets always behave as if MSG_EOR</span>
<span class="cm">	 * has been set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_EOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">MSG_EOR</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">dn_check_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">SEND_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_NOSIGNAL</span><span class="p">))</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_TRYHARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_dst_cache</span><span class="p">)</span>
		<span class="n">dst_negative_advice</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">mss</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">segsize_rem</span><span class="p">;</span>
	<span class="n">fctype</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">services_rem</span> <span class="o">&amp;</span> <span class="n">NSP_FC_MASK</span><span class="p">;</span>

	<span class="n">mss</span> <span class="o">=</span> <span class="n">dn_current_mss</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">other_xmit_queue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">mss</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist_fxn</span> <span class="o">=</span> <span class="n">dn_nsp_xmit_timeout</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Calculate size that we wish to send.</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">sent</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">mss</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">mss</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for queue size to go down below the window</span>
<span class="cm">		 * size.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dn_queue_too_long</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_ASYNC_WAITDATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">sk_wait_event</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">,</span>
				      <span class="o">!</span><span class="n">dn_queue_too_long</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">flags</span><span class="p">));</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">SOCK_ASYNC_WAITDATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get a suitably sized skb.</span>
<span class="cm">		 * 64 is a bit of a hack really, but its larger than any</span>
<span class="cm">		 * link-layer headers and has served us well as a good</span>
<span class="cm">		 * guess as to their real length.</span>
<span class="cm">		 */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dn_alloc_send_pskb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">DN_MAX_NSP_DATA_HEADER</span><span class="p">,</span>
					 <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cb</span> <span class="o">=</span> <span class="n">DN_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">DN_MAX_NSP_DATA_HEADER</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nsp_flags</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fctype</span> <span class="o">!=</span> <span class="n">NSP_FC_NONE</span><span class="p">)</span>
				<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_oth</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nsp_flags</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">seg_total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nsp_flags</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>

			<span class="n">scp</span><span class="o">-&gt;</span><span class="n">seg_total</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">sent</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_EOR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nsp_flags</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
				<span class="n">scp</span><span class="o">-&gt;</span><span class="n">seg_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fctype</span> <span class="o">==</span> <span class="n">NSP_FC_SCMC</span><span class="p">)</span>
					<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_dat</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fctype</span> <span class="o">==</span> <span class="n">NSP_FC_SRC</span><span class="p">)</span>
				<span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_dat</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sent</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">dn_nsp_queue_xmit</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">persist</span> <span class="o">=</span> <span class="n">dn_nsp_persist</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="p">}</span>
<span class="nl">out:</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sent</span> <span class="o">?</span> <span class="n">sent</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sk_stream_error</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_device_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="n">dn_dev_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">dn_dev_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">dn_dev_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">dn_device_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dn_route_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="n">dn_dix_packet_type</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>		<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_DNA_RT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">func</span> <span class="o">=</span>		<span class="n">dn_route_rcv</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">struct</span> <span class="n">dn_iter_state</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">bucket</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">dn_socket_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&lt;</span> <span class="n">DN_SK_HASH_SIZE</span><span class="p">;</span>
	    <span class="o">++</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sk_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_sk_hash</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">dn_socket_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">sk_next</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="nl">try_again:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&gt;=</span> <span class="n">DN_SK_HASH_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">sk_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_sk_hash</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">]);</span>
	<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">socket_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">dn_socket_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sk</span> <span class="o">=</span> <span class="n">dn_socket_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sk</span><span class="p">)))</span>
			<span class="o">--*</span><span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dn_socket_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">socket_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dn_socket_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="n">dn_socket_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dn_socket_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dn_socket_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dn_socket_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_socket_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_hash_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IS_NOT_PRINTABLE(x) ((x) &lt; 32 || (x) &gt; 126)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dn_printable_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_dn</span> <span class="o">*</span><span class="n">dn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">sdn_objnum</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">sdn_objnamel</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">sdn_objname</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOT_PRINTABLE</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dn_state2asc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DN_O</span>:
		<span class="k">return</span> <span class="s">&quot;OPEN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CR</span>:
		<span class="k">return</span> <span class="s">&quot;  CR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_DR</span>:
		<span class="k">return</span> <span class="s">&quot;  DR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_DRC</span>:
		<span class="k">return</span> <span class="s">&quot; DRC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CC</span>:
		<span class="k">return</span> <span class="s">&quot;  CC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CI</span>:
		<span class="k">return</span> <span class="s">&quot;  CI&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_NR</span>:
		<span class="k">return</span> <span class="s">&quot;  NR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_NC</span>:
		<span class="k">return</span> <span class="s">&quot;  NC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CD</span>:
		<span class="k">return</span> <span class="s">&quot;  CD&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_RJ</span>:
		<span class="k">return</span> <span class="s">&quot;  RJ&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_RUN</span>:
		<span class="k">return</span> <span class="s">&quot; RUN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_DI</span>:
		<span class="k">return</span> <span class="s">&quot;  DI&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_DIC</span>:
		<span class="k">return</span> <span class="s">&quot; DIC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_DN</span>:
		<span class="k">return</span> <span class="s">&quot;  DN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CL</span>:
		<span class="k">return</span> <span class="s">&quot;  CL&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DN_CN</span>:
		<span class="k">return</span> <span class="s">&quot;  CN&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;????&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dn_socket_format_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_scp</span> <span class="o">*</span><span class="n">scp</span> <span class="o">=</span> <span class="n">DN_SK</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="n">DN_ASCBUF_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="n">DN_ASCBUF_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">local_object</span><span class="p">[</span><span class="n">DN_MAXOBJL</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">remote_object</span><span class="p">[</span><span class="n">DN_MAXOBJL</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">dn_printable_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">local_object</span><span class="p">);</span>
	<span class="n">dn_printable_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="n">remote_object</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;%6s/%04X %04d:%04d %04d:%04d %01d %-16s &quot;</span>
		   <span class="s">&quot;%6s/%04X %04d:%04d %04d:%04d %01d %-16s %4s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dn_addr2asc</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dn_saddr2dn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)),</span> <span class="n">buf1</span><span class="p">),</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrloc</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">numdat</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">numoth</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackxmt_dat</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackxmt_oth</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowloc_sw</span><span class="p">,</span>
		   <span class="n">local_object</span><span class="p">,</span>
		   <span class="n">dn_addr2asc</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dn_saddr2dn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)),</span> <span class="n">buf2</span><span class="p">),</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">addrrem</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">numdat_rcv</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">numoth_rcv</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackrcv_dat</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">ackrcv_oth</span><span class="p">,</span>
		   <span class="n">scp</span><span class="o">-&gt;</span><span class="n">flowrem_sw</span><span class="p">,</span>
		   <span class="n">remote_object</span><span class="p">,</span>
		   <span class="n">dn_state2asc</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
		   <span class="p">((</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">accept_mode</span> <span class="o">==</span> <span class="n">ACC_IMMED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IMMED&quot;</span> <span class="o">:</span> <span class="s">&quot;DEFER&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_socket_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Local                                              Remote</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dn_socket_format_entry</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">dn_socket_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">dn_socket_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">dn_socket_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">dn_socket_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">dn_socket_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dn_socket_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_private</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dn_socket_seq_ops</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dn_iter_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dn_socket_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dn_socket_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span>	<span class="n">dn_family_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>	<span class="n">AF_DECnet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span>	<span class="n">dn_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">dn_proto_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>	<span class="n">AF_DECnet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">dn_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">dn_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span>	<span class="n">dn_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span> <span class="o">=</span>	<span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span> <span class="o">=</span>	<span class="n">dn_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span> <span class="o">=</span>	<span class="n">dn_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">dn_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">dn_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listen</span> <span class="o">=</span>	<span class="n">dn_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>	<span class="n">dn_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span> <span class="o">=</span>	<span class="n">dn_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span> <span class="o">=</span>	<span class="n">dn_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span> <span class="o">=</span>	<span class="n">dn_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span> <span class="o">=</span>	<span class="n">dn_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span> <span class="o">=</span>	<span class="n">sock_no_sendpage</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">dn_register_sysctl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">dn_unregister_sysctl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;The Linux DECnet Network Protocol&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linux DECnet Project Team&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NETPROTO</span><span class="p">(</span><span class="n">PF_DECnet</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">banner</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">KERN_INFO</span> <span class="s">&quot;NET4: DECnet for Linux: V.2.5.68s (C) 1995-2003 Linux DECnet Project Team</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">decnet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">banner</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_proto</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dn_neigh_init</span><span class="p">();</span>
	<span class="n">dn_dev_init</span><span class="p">();</span>
	<span class="n">dn_route_init</span><span class="p">();</span>
	<span class="n">dn_fib_init</span><span class="p">();</span>

	<span class="n">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_family_ops</span><span class="p">);</span>
	<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_dix_packet_type</span><span class="p">);</span>
	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dn_dev_notifier</span><span class="p">);</span>

	<span class="n">proc_net_fops_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="s">&quot;decnet&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dn_socket_seq_fops</span><span class="p">);</span>
	<span class="n">dn_register_sysctl</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">decnet_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Prevent DECnet module unloading until its fixed properly.</span>
<span class="cm"> * Requires an audit of the code to check for memory leaks and</span>
<span class="cm"> * initialisation problems etc.</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void __exit decnet_exit(void)</span>
<span class="c">{</span>
<span class="c">	sock_unregister(AF_DECnet);</span>
<span class="c">	rtnl_unregister_all(PF_DECnet);</span>
<span class="c">	dev_remove_pack(&amp;dn_dix_packet_type);</span>

<span class="c">	dn_unregister_sysctl();</span>

<span class="c">	unregister_netdevice_notifier(&amp;dn_dev_notifier);</span>

<span class="c">	dn_route_cleanup();</span>
<span class="c">	dn_dev_cleanup();</span>
<span class="c">	dn_neigh_cleanup();</span>
<span class="c">	dn_fib_cleanup();</span>

<span class="c">	proc_net_remove(&amp;init_net, &quot;decnet&quot;);</span>

<span class="c">	proto_unregister(&amp;dn_proto);</span>

<span class="c">	rcu_barrier_bh(); /* Wait for completion of call_rcu_bh()&#39;s */</span>
<span class="c">}</span>
<span class="c">module_exit(decnet_exit);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
