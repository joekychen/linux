<!DOCTYPE html>
<html><head><title>joekychen/linux » net › tipc › link.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>link.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net/tipc/link.c: TIPC link code</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1996-2007, Ericsson AB</span>
<span class="cm"> * Copyright (c) 2004-2007, 2010-2011, Wind River Systems</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. Neither the names of the copyright holders nor the names of its</span>
<span class="cm"> *    contributors may be used to endorse or promote products derived from</span>
<span class="cm"> *    this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="cm"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="cm"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="cm"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;link.h&quot;</span>
<span class="cp">#include &quot;port.h&quot;</span>
<span class="cp">#include &quot;name_distr.h&quot;</span>
<span class="cp">#include &quot;discover.h&quot;</span>
<span class="cp">#include &quot;config.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * Out-of-range value for link session numbers</span>
<span class="cm"> */</span>
<span class="cp">#define INVALID_SESSION 0x10000</span>

<span class="cm">/*</span>
<span class="cm"> * Link state events:</span>
<span class="cm"> */</span>
<span class="cp">#define  STARTING_EVT    856384768	</span><span class="cm">/* link processing trigger */</span><span class="cp"></span>
<span class="cp">#define  TRAFFIC_MSG_EVT 560815u	</span><span class="cm">/* rx&#39;d ??? */</span><span class="cp"></span>
<span class="cp">#define  TIMEOUT_EVT     560817u	</span><span class="cm">/* link timer expired */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * The following two &#39;message types&#39; is really just implementation</span>
<span class="cm"> * data conveniently stored in the message header.</span>
<span class="cm"> * They must not be considered part of the protocol</span>
<span class="cm"> */</span>
<span class="cp">#define OPEN_MSG   0</span>
<span class="cp">#define CLOSED_MSG 1</span>

<span class="cm">/*</span>
<span class="cm"> * State value stored in &#39;exp_msg_count&#39;</span>
<span class="cm"> */</span>
<span class="cp">#define START_CHANGEOVER 100000u</span>

<span class="cm">/**</span>
<span class="cm"> * struct tipc_link_name - deconstructed link name</span>
<span class="cm"> * @addr_local: network address of node at this end</span>
<span class="cm"> * @if_local: name of interface at this end</span>
<span class="cm"> * @addr_peer: network address of node at far end</span>
<span class="cm"> * @if_peer: name of interface at far end</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tipc_link_name</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr_local</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">if_local</span><span class="p">[</span><span class="n">TIPC_MAX_IF_NAME</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">addr_peer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">if_peer</span><span class="p">[</span><span class="n">TIPC_MAX_IF_NAME</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">link_handle_out_of_seq_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">link_recv_proto_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">link_recv_changeover_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">**</span><span class="n">l_ptr</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">link_set_supervision_props</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tolerance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">link_send_sections_long</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_port</span> <span class="o">*</span><span class="n">sender</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iovec</span> <span class="k">const</span> <span class="o">*</span><span class="n">msg_sect</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">num_sect</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_len</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">destnode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">link_check_defragm_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">link_state_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">link_reset_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">link_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">link_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">link_send_long_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Simple link routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">align</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3u</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_init_max_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_pkt</span><span class="p">;</span>

	<span class="n">max_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_pkt</span> <span class="o">&gt;</span> <span class="n">MAX_MSG_SIZE</span><span class="p">)</span>
		<span class="n">max_pkt</span> <span class="o">=</span> <span class="n">MAX_MSG_SIZE</span><span class="p">;</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span> <span class="o">=</span> <span class="n">max_pkt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span> <span class="o">&lt;</span> <span class="n">MAX_PKT_DEFAULT</span><span class="p">)</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">=</span> <span class="n">MAX_PKT_DEFAULT</span><span class="p">;</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_probes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">link_next_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">link_last_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mod</span><span class="p">(</span><span class="n">link_next_sent</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Simple non-static link routines (i.e. referenced outside this file)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tipc_link_is_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">link_working_working</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="o">||</span> <span class="n">link_working_unknown</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tipc_link_is_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">l_ptr</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">l_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_name_validate - validate &amp; (optionally) deconstruct tipc_link name</span>
<span class="cm"> * @name - ptr to link name string</span>
<span class="cm"> * @name_parts - ptr to area for link name components (or NULL if not needed)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if link name is valid, otherwise 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_name_validate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tipc_link_name</span> <span class="o">*</span><span class="n">name_parts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name_copy</span><span class="p">[</span><span class="n">TIPC_MAX_LINK_NAME</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">addr_local</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">if_local</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">addr_peer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">if_peer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">z_local</span><span class="p">,</span> <span class="n">c_local</span><span class="p">,</span> <span class="n">n_local</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">z_peer</span><span class="p">,</span> <span class="n">c_peer</span><span class="p">,</span> <span class="n">n_peer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">if_local_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">if_peer_len</span><span class="p">;</span>

	<span class="cm">/* copy link name &amp; ensure length is OK */</span>
	<span class="n">name_copy</span><span class="p">[</span><span class="n">TIPC_MAX_LINK_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* need above in case non-Posix strncpy() doesn&#39;t pad with nulls */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">name_copy</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">TIPC_MAX_LINK_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name_copy</span><span class="p">[</span><span class="n">TIPC_MAX_LINK_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ensure all component parts of link name are present */</span>
	<span class="n">addr_local</span> <span class="o">=</span> <span class="n">name_copy</span><span class="p">;</span>
	<span class="n">if_local</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">addr_local</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">if_local</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">if_local</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr_peer</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">if_local</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_peer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">addr_peer</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">if_local_len</span> <span class="o">=</span> <span class="n">addr_peer</span> <span class="o">-</span> <span class="n">if_local</span><span class="p">;</span>
	<span class="n">if_peer</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">addr_peer</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">if_peer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">if_peer</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">if_peer_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">if_peer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* validate component parts of link name */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sscanf</span><span class="p">(</span><span class="n">addr_local</span><span class="p">,</span> <span class="s">&quot;%u.%u.%u%c&quot;</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">z_local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c_local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n_local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">addr_peer</span><span class="p">,</span> <span class="s">&quot;%u.%u.%u%c&quot;</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">z_peer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c_peer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n_peer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">z_local</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c_local</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">n_local</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">z_peer</span>  <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c_peer</span>  <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">n_peer</span>  <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">if_local_len</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">if_local_len</span> <span class="o">&gt;</span> <span class="n">TIPC_MAX_IF_NAME</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">if_peer_len</span>  <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">if_peer_len</span>  <span class="o">&gt;</span> <span class="n">TIPC_MAX_IF_NAME</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strspn</span><span class="p">(</span><span class="n">if_local</span><span class="p">,</span> <span class="n">tipc_alphabet</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">if_local_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strspn</span><span class="p">(</span><span class="n">if_peer</span><span class="p">,</span> <span class="n">tipc_alphabet</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">if_peer_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* return link name components, if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name_parts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_parts</span><span class="o">-&gt;</span><span class="n">addr_local</span> <span class="o">=</span> <span class="n">tipc_addr</span><span class="p">(</span><span class="n">z_local</span><span class="p">,</span> <span class="n">c_local</span><span class="p">,</span> <span class="n">n_local</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">name_parts</span><span class="o">-&gt;</span><span class="n">if_local</span><span class="p">,</span> <span class="n">if_local</span><span class="p">);</span>
		<span class="n">name_parts</span><span class="o">-&gt;</span><span class="n">addr_peer</span> <span class="o">=</span> <span class="n">tipc_addr</span><span class="p">(</span><span class="n">z_peer</span><span class="p">,</span> <span class="n">c_peer</span><span class="p">,</span> <span class="n">n_peer</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">name_parts</span><span class="o">-&gt;</span><span class="n">if_peer</span><span class="p">,</span> <span class="n">if_peer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_timeout - handle expiration of link timer</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> *</span>
<span class="cm"> * This routine must not grab &quot;tipc_net_lock&quot; to avoid a potential deadlock conflict</span>
<span class="cm"> * with tipc_link_delete().  (There is no risk that the node will be deleted by</span>
<span class="cm"> * another thread because tipc_link_delete() always cancels the link timer before</span>
<span class="cm"> * tipc_node_delete() is called.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="cm">/* update counters used in statistical profiling of send traffic */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">accu_queue_sz</span> <span class="o">+=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">queue_sz_counts</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">MSG_FRAGMENTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">FIRST_FRAGMENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg_get_wrapped</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_lengths_total</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_counts</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">4096</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">16384</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">32768</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* do all other link processing performed on a periodic basis */</span>
	<span class="n">link_check_defragm_bufs</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">link_state_event</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">TIMEOUT_EVT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span>
		<span class="n">tipc_link_push_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_set_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">k_start_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tipc_link_create - create a new link</span>
<span class="cm"> * @n_ptr: pointer to associated node</span>
<span class="cm"> * @b_ptr: pointer to associated bearer</span>
<span class="cm"> * @media_addr: media address to use when sending messages over link</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to link.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="nf">tipc_link_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">tipc_bearer</span> <span class="o">*</span><span class="n">b_ptr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">tipc_media_addr</span> <span class="o">*</span><span class="n">media_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">if_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">addr_string</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">peer</span> <span class="o">=</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">link_cnt</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tipc_addr_string_fill</span><span class="p">(</span><span class="n">addr_string</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Attempt to establish third link to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr_string</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">tipc_addr_string_fill</span><span class="p">(</span><span class="n">addr_string</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Attempt to establish second link on &lt;%s&gt; to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr_string</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">l_ptr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link creation failed, no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">peer</span><span class="p">;</span>
	<span class="n">if_name</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%u.%u.%u:%s-%u.%u.%u:unknown&quot;</span><span class="p">,</span>
		<span class="n">tipc_zone</span><span class="p">(</span><span class="n">tipc_own_addr</span><span class="p">),</span> <span class="n">tipc_cluster</span><span class="p">(</span><span class="n">tipc_own_addr</span><span class="p">),</span>
		<span class="n">tipc_node</span><span class="p">(</span><span class="n">tipc_own_addr</span><span class="p">),</span>
		<span class="n">if_name</span><span class="p">,</span>
		<span class="n">tipc_zone</span><span class="p">(</span><span class="n">peer</span><span class="p">),</span> <span class="n">tipc_cluster</span><span class="p">(</span><span class="n">peer</span><span class="p">),</span> <span class="n">tipc_node</span><span class="p">(</span><span class="n">peer</span><span class="p">));</span>
		<span class="cm">/* note: peer i/f name is updated by reset/activate message */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">,</span> <span class="n">media_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">media_addr</span><span class="p">));</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">n_ptr</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_session</span> <span class="o">=</span> <span class="n">INVALID_SESSION</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span> <span class="o">=</span> <span class="n">b_ptr</span><span class="p">;</span>
	<span class="n">link_set_supervision_props</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">);</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RESET_UNKNOWN</span><span class="p">;</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="n">tipc_msg_init</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">LINK_PROTOCOL</span><span class="p">,</span> <span class="n">RESET_MSG</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">msg_set_size</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg</span><span class="p">));</span>
	<span class="n">msg_set_session</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">tipc_random</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">msg_set_bearer_id</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_data</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">if_name</span><span class="p">);</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="n">tipc_link_set_queue_limits</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>

	<span class="n">link_init_max_pkt</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">waiting_ports</span><span class="p">);</span>

	<span class="n">link_reset_statistics</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">tipc_node_attach_link</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">k_init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="p">(</span><span class="n">Handler</span><span class="p">)</span><span class="n">link_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">link_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">);</span>
	<span class="n">tipc_k_signal</span><span class="p">((</span><span class="n">Handler</span><span class="p">)</span><span class="n">link_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">l_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tipc_link_delete - delete a link</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> *</span>
<span class="cm"> * Note: &#39;tipc_net_lock&#39; is write_locked, bearer is locked.</span>
<span class="cm"> * This routine must not grab the node lock until after link timer cancellation</span>
<span class="cm"> * to avoid a potential deadlock situation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Attempt to delete non-existent link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">k_cancel_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">tipc_node_detach_link</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">tipc_link_stop</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">link_list</span><span class="p">);</span>
	<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">k_term_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">link_state_event</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STARTING_EVT</span><span class="p">);</span>
	<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_schedule_port - schedule port for deferred sending</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> * @origport: reference to sending port</span>
<span class="cm"> * @sz: amount of data to be sent</span>
<span class="cm"> *</span>
<span class="cm"> * Schedules port for renewed sending of messages after link congestion</span>
<span class="cm"> * has abated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_schedule_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">origport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_port</span> <span class="o">*</span><span class="n">p_ptr</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_port_list_lock</span><span class="p">);</span>
	<span class="n">p_ptr</span> <span class="o">=</span> <span class="n">tipc_port_lock</span><span class="p">(</span><span class="n">origport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">wait_list</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">congested</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">waiting_pkts</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">wait_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">waiting_ports</span><span class="p">);</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_congs</span><span class="o">++</span><span class="p">;</span>
<span class="nl">exit:</span>
		<span class="n">tipc_port_unlock</span><span class="p">(</span><span class="n">p_ptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_port_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ELINKCONG</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tipc_link_wakeup_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_port</span> <span class="o">*</span><span class="n">p_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_port</span> <span class="o">*</span><span class="n">temp_p_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">all</span><span class="p">)</span>
		<span class="n">win</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_port_list_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p_ptr</span><span class="p">,</span> <span class="n">temp_p_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">waiting_ports</span><span class="p">,</span>
				 <span class="n">wait_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">wait_list</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">congested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">(</span><span class="n">p_ptr</span><span class="p">);</span>
		<span class="n">win</span> <span class="o">-=</span> <span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">waiting_pkts</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">p_ptr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_port_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_release_outqueue - purge link&#39;s outbound message queue</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_release_outqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tipc_link_reset_fragments - purge link&#39;s inbound message fragments queue</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_reset_fragments</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">defragm_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">defragm_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tipc_link_stop - purge all inbound and outbound messages associated with link</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tipc_link_reset_fragments</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span><span class="p">);</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tipc_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prev_state</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_active_link</span> <span class="o">=</span> <span class="n">tipc_link_is_active</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">msg_set_session</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">,</span> <span class="p">((</span><span class="n">msg_session</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="cm">/* Link is down, accept any session */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_session</span> <span class="o">=</span> <span class="n">INVALID_SESSION</span><span class="p">;</span>

	<span class="cm">/* Prepare for max packet size negotiation */</span>
	<span class="n">link_init_max_pkt</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RESET_UNKNOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">prev_state</span> <span class="o">==</span> <span class="n">RESET_UNKNOWN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">prev_state</span> <span class="o">==</span> <span class="n">RESET_RESET</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tipc_node_link_down</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">tipc_bearer_remove_dest</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_active_link</span> <span class="o">&amp;&amp;</span> <span class="n">tipc_node_active_links</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">permit_changeover</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">reset_checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">;</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">exp_msg_count</span> <span class="o">=</span> <span class="n">START_CHANGEOVER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clean up all queues: */</span>
	<span class="n">link_release_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span><span class="p">);</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">waiting_ports</span><span class="p">))</span>
		<span class="n">tipc_link_wakeup_ports</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">unacked_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">deferred_inqueue_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">newest_deferred_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stale_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link_reset_statistics</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_info</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tipc_node_link_up</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">tipc_bearer_add_dest</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_state_event - link finite state machine</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> * @event: state machine event to process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_state_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cont_intv</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">continuity_interval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">STARTING_EVT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Not yet. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_blocked</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">TIMEOUT_EVT</span><span class="p">)</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>	  <span class="cm">/* Changeover going on */</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WORKING_WORKING</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRAFFIC_MSG_EVT</span>:
		<span class="k">case</span> <span class="n">ACTIVATE_MSG</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIMEOUT_EVT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">!=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bclink_acks_missing</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span>
								 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">&lt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span>
								 <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WORKING_UNKNOWN</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RESET_MSG</span>:
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;Resetting link &lt;%s&gt;, requested by peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RESET_RESET</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">ACTIVATE_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unknown link event %u in WW state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WORKING_UNKNOWN</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRAFFIC_MSG_EVT</span>:
		<span class="k">case</span> <span class="n">ACTIVATE_MSG</span>:
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WORKING_WORKING</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RESET_MSG</span>:
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;Resetting link &lt;%s&gt;, requested by peer &quot;</span>
			     <span class="s">&quot;while probing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RESET_RESET</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">ACTIVATE_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIMEOUT_EVT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">!=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WORKING_WORKING</span><span class="p">;</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bclink_acks_missing</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span>
								 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">&lt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">abort_limit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span>
							 <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Link has failed */</span>
				<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Resetting link &lt;%s&gt;, peer not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RESET_UNKNOWN</span><span class="p">;</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">RESET_MSG</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unknown link event %u in WU state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESET_UNKNOWN</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRAFFIC_MSG_EVT</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACTIVATE_MSG</span>:
			<span class="n">other</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="o">&amp;&amp;</span> <span class="n">link_working_unknown</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WORKING_WORKING</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">link_activate</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RESET_MSG</span>:
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RESET_RESET</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">ACTIVATE_MSG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STARTING_EVT</span>:
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">TIMEOUT_EVT</span>:
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">RESET_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unknown link event %u in RU state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESET_RESET</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRAFFIC_MSG_EVT</span>:
		<span class="k">case</span> <span class="n">ACTIVATE_MSG</span>:
			<span class="n">other</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="o">&amp;&amp;</span> <span class="n">link_working_unknown</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WORKING_WORKING</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">link_activate</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RESET_MSG</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIMEOUT_EVT</span>:
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">ACTIVATE_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">link_set_timer</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">cont_intv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unknown link event %u in RR state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unknown link state %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * link_bundle_buf(): Append contents of a buffer to</span>
<span class="cm"> * the tail of an existing one.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_bundle_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">bundler</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">bundler_msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">bundler</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bundle_size</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">bundler_msg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">to_pos</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">bundle_size</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pad</span> <span class="o">=</span> <span class="n">to_pos</span> <span class="o">-</span> <span class="n">bundle_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">bundler_msg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MSG_BUNDLER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">bundler_msg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OPEN_MSG</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">bundler</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pad</span> <span class="o">+</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">to_pos</span> <span class="o">+</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">bundler</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">bundler</span><span class="p">,</span> <span class="n">to_pos</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">msg_set_size</span><span class="p">(</span><span class="n">bundler_msg</span><span class="p">,</span> <span class="n">to_pos</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">msg_set_msgcnt</span><span class="p">(</span><span class="n">bundler_msg</span><span class="p">,</span> <span class="n">msg_msgcnt</span><span class="p">(</span><span class="n">bundler_msg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_bundled</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_add_to_outqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">seqno</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span><span class="o">++</span><span class="p">);</span>

	<span class="n">msg_set_word</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">ack</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">seqno</span><span class="p">));</span>
	<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span> <span class="o">&gt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">max_queue_sz</span><span class="p">)</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">max_queue_sz</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_add_chain_to_outqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf_chain</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">long_msgno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buf_chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="p">;</span>
		<span class="n">buf_chain</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">msg_set_long_msgno</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">long_msgno</span><span class="p">);</span>
		<span class="n">link_add_to_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tipc_link_send_buf() is the &#39;full path&#39; for messages, called from</span>
<span class="cm"> * inside TIPC when the &#39;fast path&#39; in tipc_send_buf</span>
<span class="cm"> * has failed, and from link_send()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tipc_link_send_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dsz</span> <span class="o">=</span> <span class="n">msg_data_sz</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">queue_size</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">imp</span> <span class="o">=</span> <span class="n">tipc_msg_tot_importance</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">queue_limit</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">imp</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">max_packet</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">;</span>

	<span class="cm">/* Match msg importance against queue limits: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">queue_size</span> <span class="o">&gt;=</span> <span class="n">queue_limit</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imp</span> <span class="o">&lt;=</span> <span class="n">TIPC_CRITICAL_IMPORTANCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">link_schedule_port</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">msg_origport</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ELINKCONG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imp</span> <span class="o">&gt;</span> <span class="n">CONN_MANAGER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Resetting link &lt;%s&gt;, send queue full&quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">dsz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fragmentation needed ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_packet</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">link_send_long_buf</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* Packet can be queued or sent. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">tipc_bearer_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">link_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">link_add_to_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tipc_bearer_send</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">unacked_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tipc_bearer_schedule</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="o">++</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">dsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Congestion: can message be bundled ? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHANGEOVER_PROTOCOL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MSG_FRAGMENTER</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Try adding message to an existing bundle */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">&amp;&amp;</span>
		    <span class="n">link_bundle_buf</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tipc_bearer_resolve_congestion</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">dsz</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Try creating a new bundle */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">max_packet</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">bundler</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">max_packet</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="n">bundler_hdr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bundler</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tipc_msg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bundler_hdr</span><span class="p">,</span> <span class="n">MSG_BUNDLER</span><span class="p">,</span> <span class="n">OPEN_MSG</span><span class="p">,</span>
					 <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">bundler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bundler_hdr</span><span class="p">,</span>
							<span class="n">INT_H_SIZE</span><span class="p">);</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">bundler</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
				<span class="n">link_bundle_buf</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">bundler</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="n">bundler</span><span class="p">;</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_bundles</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">link_add_to_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">tipc_bearer_resolve_congestion</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dsz</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tipc_link_send(): same as tipc_link_send_buf(), but the link to use has</span>
<span class="cm"> * not been selected yet, and the the owner node is not locked</span>
<span class="cm"> * Called by TIPC internal users, e.g. the name distributor</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tipc_link_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ELINKCONG</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">n_ptr</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
		<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">tipc_link_send_buf</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tipc_link_send_names - send name table entries to new neighbor</span>
<span class="cm"> *</span>
<span class="cm"> * Send routine for bulk delivery of name table messages when contact</span>
<span class="cm"> * with a new neighbor occurs. No link congestion checking is performed</span>
<span class="cm"> * because name table messages *must* be delivered. The messages must be</span>
<span class="cm"> * small enough not to require fragmentation.</span>
<span class="cm"> * Called without any locks held.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_send_names</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">message_list</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">temp_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">message_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">n_ptr</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
		<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* convert circular list to linear list */</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">message_list</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">link_add_chain_to_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">message_list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tipc_link_push_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">message_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>

	<span class="cm">/* discard the messages if they couldn&#39;t be sent */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">temp_buf</span><span class="p">,</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">message_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">((</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * link_send_buf_fast: Entry for data messages where the</span>
<span class="cm"> * destination link is known and the header is complete,</span>
<span class="cm"> * inclusive total message length. Very time critical.</span>
<span class="cm"> * Link is locked. Returns user data length.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_send_buf_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="o">*</span><span class="n">used_max_pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">msg_data_sz</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">link_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">cong_links</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">link_add_to_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tipc_bearer_send</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">unacked_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tipc_bearer_schedule</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="o">++</span><span class="p">;</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">used_max_pkt</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tipc_link_send_buf</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>  <span class="cm">/* All other cases */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tipc_send_buf_fast: Entry for data messages where the</span>
<span class="cm"> * destination node is known and the header is complete,</span>
<span class="cm"> * inclusive total message length.</span>
<span class="cm"> * Returns user data length.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tipc_send_buf_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">destnode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">msg_origport</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">n_ptr</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">destnode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
		<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="n">selector</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">link_send_buf_fast</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">msg_data_sz</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">tipc_reject_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">TIPC_ERR_NO_NODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * tipc_link_send_sections_fast: Entry for messages where the</span>
<span class="cm"> * destination processor is known and the header is complete,</span>
<span class="cm"> * except for total message length.</span>
<span class="cm"> * Returns user data length or errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tipc_link_send_sections_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_port</span> <span class="o">*</span><span class="n">sender</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iovec</span> <span class="k">const</span> <span class="o">*</span><span class="n">msg_sect</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u32</span> <span class="n">num_sect</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_len</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">destaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">phdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">msg_origport</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Try building message using port&#39;s max_pkt hint.</span>
<span class="cm">	 * (Must not hold any locks while building message.)</span>
<span class="cm">	 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">tipc_msg_build</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">msg_sect</span><span class="p">,</span> <span class="n">num_sect</span><span class="p">,</span> <span class="n">total_len</span><span class="p">,</span>
			     <span class="n">sender</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">,</span> <span class="o">!</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">user_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">destaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="n">selector</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">link_send_buf_fast</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">);</span>
<span class="nl">exit:</span>
				<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
				<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Exit if build request was invalid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

			<span class="cm">/* Exit if link (or bearer) is congested */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">cong_links</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">link_schedule_port</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span>
							 <span class="n">sender</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Message size exceeds max_pkt hint; update hint,</span>
<span class="cm">			 * then re-try fast path or fragment the message</span>
<span class="cm">			 */</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">;</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>


			<span class="k">if</span> <span class="p">((</span><span class="n">msg_hdr_sz</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">res</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">link_send_sections_long</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">msg_sect</span><span class="p">,</span>
						       <span class="n">num_sect</span><span class="p">,</span> <span class="n">total_len</span><span class="p">,</span>
						       <span class="n">destaddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>

	<span class="cm">/* Couldn&#39;t find a link to the destination node */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tipc_reject_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">TIPC_ERR_NO_NODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tipc_port_reject_sections</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">msg_sect</span><span class="p">,</span> <span class="n">num_sect</span><span class="p">,</span>
						 <span class="n">total_len</span><span class="p">,</span> <span class="n">TIPC_ERR_NO_NODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * link_send_sections_long(): Entry for long messages where the</span>
<span class="cm"> * destination node is known and the header is complete,</span>
<span class="cm"> * inclusive total message length.</span>
<span class="cm"> * Link and bearer congestion status have been checked to be ok,</span>
<span class="cm"> * and are ignored if they change.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that fragments do not use the full link MTU so that they won&#39;t have</span>
<span class="cm"> * to undergo refragmentation if link changeover causes them to be sent</span>
<span class="cm"> * over another link with an additional tunnel header added as prefix.</span>
<span class="cm"> * (Refragmentation will still occur if the other link has a smaller MTU.)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns user data length or errno.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_send_sections_long</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_port</span> <span class="o">*</span><span class="n">sender</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iovec</span> <span class="k">const</span> <span class="o">*</span><span class="n">msg_sect</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">num_sect</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_len</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">destaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">phdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dsz</span> <span class="o">=</span> <span class="n">total_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_pkt</span><span class="p">,</span> <span class="n">fragm_sz</span><span class="p">,</span> <span class="n">rest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="n">fragm_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">buf_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fragm_crs</span><span class="p">,</span> <span class="n">fragm_rest</span><span class="p">,</span> <span class="n">hsz</span><span class="p">,</span> <span class="n">sect_rest</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">unchar</span> <span class="o">*</span><span class="n">sect_crs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_sect</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fragm_no</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">fragm_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">max_pkt</span> <span class="o">=</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">-</span> <span class="n">INT_H_SIZE</span><span class="p">;</span>
		<span class="cm">/* leave room for tunnel header in case of link changeover */</span>
	<span class="n">fragm_sz</span> <span class="o">=</span> <span class="n">max_pkt</span> <span class="o">-</span> <span class="n">INT_H_SIZE</span><span class="p">;</span>
		<span class="cm">/* leave room for fragmentation header in each fragment */</span>
	<span class="n">rest</span> <span class="o">=</span> <span class="n">dsz</span><span class="p">;</span>
	<span class="n">fragm_crs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fragm_rest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sect_rest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sect_crs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">curr_sect</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Prepare reusable fragment header */</span>
	<span class="n">tipc_msg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">MSG_FRAGMENTER</span><span class="p">,</span> <span class="n">FIRST_FRAGMENT</span><span class="p">,</span>
		 <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">msg_destnode</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">msg_set_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">max_pkt</span><span class="p">);</span>
	<span class="n">msg_set_fragm_no</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Prepare header of first fragment */</span>
	<span class="n">buf_chain</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">max_pkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
	<span class="n">hsz</span> <span class="o">=</span> <span class="n">msg_hdr_sz</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hsz</span><span class="p">);</span>

	<span class="cm">/* Chop up message */</span>
	<span class="n">fragm_crs</span> <span class="o">=</span> <span class="n">INT_H_SIZE</span> <span class="o">+</span> <span class="n">hsz</span><span class="p">;</span>
	<span class="n">fragm_rest</span> <span class="o">=</span> <span class="n">fragm_sz</span> <span class="o">-</span> <span class="n">hsz</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>		<span class="cm">/* For all sections */</span>
		<span class="n">u32</span> <span class="n">sz</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sect_rest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sect_rest</span> <span class="o">=</span> <span class="n">msg_sect</span><span class="p">[</span><span class="o">++</span><span class="n">curr_sect</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
			<span class="n">sect_crs</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">unchar</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_sect</span><span class="p">[</span><span class="n">curr_sect</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sect_rest</span> <span class="o">&lt;</span> <span class="n">fragm_rest</span><span class="p">)</span>
			<span class="n">sz</span> <span class="o">=</span> <span class="n">sect_rest</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sz</span> <span class="o">=</span> <span class="n">fragm_rest</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">user_port</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">fragm_crs</span><span class="p">,</span> <span class="n">sect_crs</span><span class="p">,</span> <span class="n">sz</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">error:</span>
				<span class="k">for</span> <span class="p">(;</span> <span class="n">buf_chain</span><span class="p">;</span> <span class="n">buf_chain</span> <span class="o">=</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">buf</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf_chain</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fragm_crs</span><span class="p">,</span>
						       <span class="n">sect_crs</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">sect_crs</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">sect_rest</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">fragm_crs</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">fragm_rest</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">rest</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fragm_rest</span> <span class="o">&amp;&amp;</span> <span class="n">rest</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Initiate new fragment: */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&lt;=</span> <span class="n">fragm_sz</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fragm_sz</span> <span class="o">=</span> <span class="n">rest</span><span class="p">;</span>
				<span class="n">msg_set_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">LAST_FRAGMENT</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">msg_set_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">FRAGMENT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">msg_set_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">fragm_sz</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
			<span class="n">msg_set_fragm_no</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="o">++</span><span class="n">fragm_no</span><span class="p">);</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">fragm_sz</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
			<span class="n">fragm_crs</span> <span class="o">=</span> <span class="n">INT_H_SIZE</span><span class="p">;</span>
			<span class="n">fragm_rest</span> <span class="o">=</span> <span class="n">fragm_sz</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we have a buffer chain. Select a link and check</span>
<span class="cm">	 * that packet size is still OK</span>
<span class="cm">	 */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">destaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">ref</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">&lt;</span> <span class="n">max_pkt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">;</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">buf_chain</span><span class="p">;</span> <span class="n">buf_chain</span> <span class="o">=</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf_chain</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">reject:</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">buf_chain</span><span class="p">;</span> <span class="n">buf_chain</span> <span class="o">=</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf_chain</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">tipc_port_reject_sections</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">msg_sect</span><span class="p">,</span> <span class="n">num_sect</span><span class="p">,</span>
						 <span class="n">total_len</span><span class="p">,</span> <span class="n">TIPC_ERR_NO_NODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Append chain of fragments to send queue &amp; send them */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">long_msg_seq_no</span><span class="o">++</span><span class="p">;</span>
	<span class="n">link_add_chain_to_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf_chain</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">long_msg_seq_no</span><span class="p">);</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_fragments</span> <span class="o">+=</span> <span class="n">fragm_no</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_fragmented</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tipc_link_push_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dsz</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tipc_link_push_packet: Push one unsent packet to the media</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">tipc_link_push_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r_q_size</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r_q_head</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_head</span><span class="p">;</span>

	<span class="cm">/* Step to position where retransmission failed, if any,    */</span>
	<span class="cm">/* consider that buffers may have been released in meantime */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_q_size</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">last</span> <span class="o">=</span> <span class="n">lesser</span><span class="p">(</span><span class="n">mod</span><span class="p">(</span><span class="n">r_q_head</span> <span class="o">+</span> <span class="n">r_q_size</span><span class="p">),</span>
				  <span class="n">link_last_sent</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">));</span>
		<span class="n">u32</span> <span class="n">first</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">less</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">r_q_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_head</span> <span class="o">=</span> <span class="n">r_q_head</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span> <span class="o">=</span> <span class="n">r_q_size</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Continue retransmission now, if there is anything: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_q_size</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bearer_send</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_head</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="o">++</span><span class="n">r_q_head</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span> <span class="o">=</span> <span class="o">--</span><span class="n">r_q_size</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">retransmitted</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">PUSH_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Send deferred protocol message, if any: */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bearer_send</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">unacked_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">PUSH_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Send one deferred data message, if send window not full: */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">next</span> <span class="o">=</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">first</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">first</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bearer_send</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">MSG_BUNDLER</span><span class="p">)</span>
					<span class="n">msg_set_type</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">CLOSED_MSG</span><span class="p">);</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">PUSH_FAILED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PUSH_FINISHED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * push_queue(): push out the unsent messages of a link where</span>
<span class="cm"> *               congestion has abated. Node is locked</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_push_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bearer_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">tipc_link_push_packet</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">PUSH_FAILED</span><span class="p">)</span>
		<span class="n">tipc_bearer_schedule</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_reset_all</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">addr_string</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">n_ptr</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* node no longer exists */</span>
	<span class="p">}</span>

	<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>

	<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Resetting all links to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">tipc_addr_string_fill</span><span class="p">(</span><span class="n">addr_string</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BEARERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">link_print</span><span class="p">(</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;Resetting link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_retransmit_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Retransmission failure on link &lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Handle failure on standard link */</span>
		<span class="n">link_print</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="s">&quot;Resetting link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Handle failure on broadcast link */</span>
		<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">addr_string</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Msg seq number: %u,  &quot;</span><span class="p">,</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Outstanding acks: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">TIPC_SKB_CB</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

		<span class="n">n_ptr</span> <span class="o">=</span> <span class="n">tipc_bclink_retransmit_to</span><span class="p">();</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>

		<span class="n">tipc_addr_string_fill</span><span class="p">(</span><span class="n">addr_string</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Broadcast link info for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr_string</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Supportable: %d,  &quot;</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">supportable</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Supported: %d,  &quot;</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">supported</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Acked: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">acked</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Last in: %u,  &quot;</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Oos state: %u,  &quot;</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">oos_state</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Last sent: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_sent</span><span class="p">);</span>

		<span class="n">tipc_k_signal</span><span class="p">((</span><span class="n">Handler</span><span class="p">)</span><span class="n">link_reset_all</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>

		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stale_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tipc_link_retransmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">retransmits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bearer_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_head</span> <span class="o">=</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span> <span class="o">=</span> <span class="n">retransmits</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unexpected retransmit on link %s (qsize=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Detect repeated retransmit failures on uncongested bearer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_retransmitted</span> <span class="o">==</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stale_count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">link_retransmit_failure</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_retransmitted</span> <span class="o">=</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stale_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">retransmits</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bearer_send</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">retransmits</span><span class="o">--</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">retransmitted</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tipc_bearer_schedule</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="o">++</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_head</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span> <span class="o">=</span> <span class="n">retransmits</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_head</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">retransm_queue_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_insert_deferred_queue - insert deferred messages back into receive chain</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">link_insert_deferred_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">seq_no</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">seq_no</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq_no</span> <span class="o">==</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">newest_deferred_in</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">;</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">deferred_inqueue_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_recv_buf_validate - validate basic format of received message</span>
<span class="cm"> *</span>
<span class="cm"> * This routine ensures a TIPC message has an acceptable header, and at least</span>
<span class="cm"> * as much data as the header indicates it should.  The routine also ensures</span>
<span class="cm"> * that the entire message header is stored in the main fragment of the message</span>
<span class="cm"> * buffer, to simplify future access to message header fields.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Having extra info present in the message header or data areas is OK.</span>
<span class="cm"> * TIPC will ignore the excess, under the assumption that it is optional info</span>
<span class="cm"> * introduced by a later release of the protocol.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_recv_buf_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">min_data_hdr_size</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SHORT_H_SIZE</span><span class="p">,</span> <span class="n">MCAST_H_SIZE</span><span class="p">,</span> <span class="n">NAMED_H_SIZE</span><span class="p">,</span> <span class="n">BASIC_H_SIZE</span><span class="p">,</span>
		<span class="n">MAX_H_SIZE</span><span class="p">,</span> <span class="n">MAX_H_SIZE</span><span class="p">,</span> <span class="n">MAX_H_SIZE</span><span class="p">,</span> <span class="n">MAX_H_SIZE</span>
		<span class="p">};</span>

	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tipc_hdr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hdr_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">min_hdr_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">MIN_H_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tipc_hdr</span><span class="p">),</span> <span class="n">tipc_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">msg_version</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TIPC_VERSION</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">hdr_size</span> <span class="o">=</span> <span class="n">msg_hdr_sz</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">min_hdr_size</span> <span class="o">=</span> <span class="n">msg_isdata</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">min_data_hdr_size</span><span class="p">[</span><span class="n">msg_type</span><span class="p">(</span><span class="n">msg</span><span class="p">)]</span> <span class="o">:</span> <span class="n">INT_H_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">hdr_size</span> <span class="o">&lt;</span> <span class="n">min_hdr_size</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">hdr_size</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_size</span> <span class="o">&gt;</span> <span class="n">TIPC_MAX_USER_MSG_SIZE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">hdr_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tipc_recv_msg - process TIPC messages arriving from off-node</span>
<span class="cm"> * @head: pointer to message buffer chain</span>
<span class="cm"> * @tb_ptr: pointer to bearer message arrived on</span>
<span class="cm"> *</span>
<span class="cm"> * Invoked with no locks held.  Bearer pointer must point to a valid bearer</span>
<span class="cm"> * structure (i.e. cannot be NULL), but bearer can be inactive.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_recv_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tipc_bearer</span> <span class="o">*</span><span class="n">b_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">crs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">seq_no</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">ackd</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">released</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

		<span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="cm">/* Ensure bearer is still enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>

		<span class="cm">/* Ensure message is well-formed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">link_recv_buf_validate</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>

		<span class="cm">/* Ensure message data is a single contiguous unit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_linearize</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>

		<span class="cm">/* Handle arrival of a non-unicast link message */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">msg_non_seq</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span>  <span class="n">LINK_CONFIG</span><span class="p">)</span>
				<span class="n">tipc_disc_recv_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">b_ptr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tipc_bclink_recv_pkt</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Discard unicast link messages destined for another node */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">msg_short</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">msg_destnode</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tipc_own_addr</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>

		<span class="cm">/* Locate neighboring node that sent message */</span>
		<span class="n">n_ptr</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">msg_prevnode</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">n_ptr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>

		<span class="cm">/* Locate unicast link endpoint that should handle message */</span>
		<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Verify that communication with node is currently allowed */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">block_setup</span> <span class="o">&amp;</span> <span class="n">WAIT_PEER_DOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">LINK_PROTOCOL</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">RESET_MSG</span> <span class="o">||</span>
					<span class="n">msg_type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">ACTIVATE_MSG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">msg_redundant_link</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
			<span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">block_setup</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WAIT_PEER_DOWN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">block_setup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Validate message sequence number info */</span>
		<span class="n">seq_no</span> <span class="o">=</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">ackd</span> <span class="o">=</span> <span class="n">msg_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

		<span class="cm">/* Release acked messages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">supported</span><span class="p">)</span>
			<span class="n">tipc_bclink_acknowledge</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">,</span> <span class="n">msg_bcast_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>

		<span class="n">crs</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="n">less_eq</span><span class="p">(</span><span class="n">buf_seqno</span><span class="p">(</span><span class="n">crs</span><span class="p">),</span> <span class="n">ackd</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">crs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">crs</span><span class="p">);</span>
			<span class="n">crs</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">released</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">released</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span> <span class="o">=</span> <span class="n">crs</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span> <span class="o">-=</span> <span class="n">released</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Try sending any messages link endpoint has pending */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">))</span>
			<span class="n">tipc_link_push_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">waiting_ports</span><span class="p">)))</span>
			<span class="n">tipc_link_wakeup_ports</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">++</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">unacked_window</span> <span class="o">&gt;=</span> <span class="n">TIPC_MIN_LINK_WIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_acks</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Now (finally!) process the incoming message */</span>
<span class="nl">protocol_check:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">link_working_working</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">seq_no</span> <span class="o">==</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">))</span>
					<span class="n">head</span> <span class="o">=</span> <span class="n">link_insert_deferred_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span>
									  <span class="n">head</span><span class="p">);</span>
<span class="nl">deliver:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">msg_isdata</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
					<span class="n">tipc_port_recv_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">MSG_BUNDLER</span>:
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_bundles</span><span class="o">++</span><span class="p">;</span>
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_bundled</span> <span class="o">+=</span>
						<span class="n">msg_msgcnt</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
					<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
					<span class="n">tipc_link_recv_bundle</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NAME_DISTRIBUTOR</span>:
					<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
					<span class="n">tipc_named_recv</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CONN_MANAGER</span>:
					<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
					<span class="n">tipc_port_recv_proto_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">MSG_FRAGMENTER</span>:
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_fragments</span><span class="o">++</span><span class="p">;</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">tipc_link_recv_fragment</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">defragm_buf</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_fragmented</span><span class="o">++</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">deliver</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
						<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="o">--</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CHANGEOVER_PROTOCOL</span>:
					<span class="n">type</span> <span class="o">=</span> <span class="n">msg_type</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">link_recv_changeover_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="p">,</span>
								     <span class="o">&amp;</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
						<span class="n">seq_no</span> <span class="o">=</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ORIGINAL_MSG</span><span class="p">)</span>
							<span class="k">goto</span> <span class="n">deliver</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">protocol_check</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
					<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
				<span class="n">tipc_net_route_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">link_handle_out_of_seq_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">head</span> <span class="o">=</span> <span class="n">link_insert_deferred_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">LINK_PROTOCOL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">link_recv_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">head</span> <span class="o">=</span> <span class="n">link_insert_deferred_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">link_state_event</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">TRAFFIC_MSG_EVT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">link_working_working</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Re-insert in front of queue */</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
			<span class="n">head</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
<span class="nl">cont:</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tipc_link_defer_pkt - Add out-of-sequence message to deferred reception queue</span>
<span class="cm"> *</span>
<span class="cm"> * Returns increase in queue length (i.e. 0 or 1)</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">tipc_link_defer_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">tail</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">queue_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq_no</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Empty queue ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Last ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">less</span><span class="p">(</span><span class="n">buf_seqno</span><span class="p">(</span><span class="o">*</span><span class="n">tail</span><span class="p">),</span> <span class="n">seq_no</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">tail</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Locate insertion point in queue, then insert; discard if duplicate */</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">queue_buf</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">curr_seqno</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">queue_buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">seq_no</span> <span class="o">==</span> <span class="n">curr_seqno</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">less</span><span class="p">(</span><span class="n">seq_no</span><span class="p">,</span> <span class="n">curr_seqno</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">queue_buf</span> <span class="o">=</span> <span class="n">queue_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">queue_buf</span><span class="p">;</span>
	<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * link_handle_out_of_seq_msg - handle arrival of out-of-sequence packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_handle_out_of_seq_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">seq_no</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">==</span> <span class="n">LINK_PROTOCOL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">link_recv_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Record OOS packet arrival (force mismatch on next timeout) */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Discard packet if a duplicate; otherwise add it to deferred queue</span>
<span class="cm">	 * and notify peer of gap as per protocol specification</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">less</span><span class="p">(</span><span class="n">seq_no</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">duplicates</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tipc_link_defer_pkt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">newest_deferred_in</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">deferred_inqueue_sz</span><span class="o">++</span><span class="p">;</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">deferred_recv</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">deferred_inqueue_sz</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">duplicates</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send protocol message to the other endpoint.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_send_proto_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msg_typ</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">probe_msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tolerance</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">priority</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ack_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r_flag</span><span class="p">;</span>

	<span class="cm">/* Discard any previous message that was deferred due to congestion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span><span class="p">);</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_blocked</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Abort non-RESET send if communication with node is prohibited */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">block_setup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg_typ</span> <span class="o">!=</span> <span class="n">RESET_MSG</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Create protocol message with &quot;out-of-sequence&quot; sequence number */</span>
	<span class="n">msg_set_type</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg_typ</span><span class="p">);</span>
	<span class="n">msg_set_net_plane</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">net_plane</span><span class="p">);</span>
	<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
	<span class="n">msg_set_last_bcast</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">tipc_bclink_get_last_sent</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg_typ</span> <span class="o">==</span> <span class="n">STATE_MSG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">next_sent</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tipc_link_is_up</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span>
			<span class="n">next_sent</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">);</span>
		<span class="n">msg_set_next_sent</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">next_sent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">);</span>
			<span class="n">gap</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">rec</span> <span class="o">-</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">msg_set_seq_gap</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">gap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gap</span><span class="p">)</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_nacks</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg_set_link_tolerance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">);</span>
		<span class="n">msg_set_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
		<span class="n">msg_set_max_pkt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ack_mtu</span><span class="p">);</span>
		<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">msg_set_probe</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">probe_msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">probe_msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">link_working_working</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">fsm_msg_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msg_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">+</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span> <span class="o">-</span> <span class="n">mtu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_probes</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_probes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">msg_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">+</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span> <span class="o">-</span> <span class="n">mtu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_probes</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_probes</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_states</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* RESET_MSG or ACTIVATE_MSG */</span>
		<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">reset_checkpoint</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">msg_set_seq_gap</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msg_set_next_sent</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msg_set_probe</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msg_set_link_tolerance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">);</span>
		<span class="n">msg_set_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
		<span class="n">msg_set_max_pkt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">working_links</span> <span class="o">&gt;</span> <span class="n">tipc_link_is_up</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">));</span>
	<span class="n">msg_set_redundant_link</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">r_flag</span><span class="p">);</span>
	<span class="n">msg_set_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
	<span class="n">msg_set_size</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">);</span>

	<span class="n">msg_set_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xffff</span><span class="o">/</span><span class="mi">2</span><span class="p">)));</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">msg_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg</span><span class="p">));</span>

	<span class="cm">/* Defer message if bearer is already congested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bearer_congested</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Defer message if attempting to send results in bearer congestion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tipc_bearer_send</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">media_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tipc_bearer_schedule</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="p">);</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg_queue</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Discard message if it was sent successfully */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">unacked_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive protocol message :</span>
<span class="cm"> * Note that network plane id propagates through the network, and may</span>
<span class="cm"> * change at any time. The node with lowest address rules</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_recv_proto_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rec_gap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_pkt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_pkt_ack</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_tol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_blocked</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* record unnumbered packet arrival (force mismatch on next timeout) */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">net_plane</span> <span class="o">!=</span> <span class="n">msg_net_plane</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tipc_own_addr</span> <span class="o">&gt;</span> <span class="n">msg_prevnode</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">net_plane</span> <span class="o">=</span> <span class="n">msg_net_plane</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">permit_changeover</span> <span class="o">=</span> <span class="n">msg_redundant_link</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">RESET_MSG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_working_unknown</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_session</span> <span class="o">!=</span> <span class="n">INVALID_SESSION</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">less_eq</span><span class="p">(</span><span class="n">msg_session</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_session</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* duplicate or old reset: ignore */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg_redundant_link</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">link_working_working</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">link_working_unknown</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * peer has lost contact -- don&#39;t allow peer&#39;s links</span>
<span class="cm">			 * to reactivate before we recognize loss &amp; clean up</span>
<span class="cm">			 */</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">block_setup</span> <span class="o">=</span> <span class="n">WAIT_NODE_DOWN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">link_state_event</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">RESET_MSG</span><span class="p">);</span>

		<span class="cm">/* fall thru&#39; */</span>
	<span class="k">case</span> <span class="n">ACTIVATE_MSG</span>:
		<span class="cm">/* Update link settings according other endpoint&#39;s values */</span>
		<span class="n">strcpy</span><span class="p">((</span><span class="n">strrchr</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_data</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>

		<span class="n">msg_tol</span> <span class="o">=</span> <span class="n">msg_link_tolerance</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_tol</span> <span class="o">&gt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">)</span>
			<span class="n">link_set_supervision_props</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">msg_tol</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">msg_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

		<span class="n">max_pkt_info</span> <span class="o">=</span> <span class="n">msg_max_pkt</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_pkt_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_pkt_info</span> <span class="o">&lt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span> <span class="o">=</span> <span class="n">max_pkt_info</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">&gt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">)</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_target</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">supportable</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pkt_info</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Synchronize broadcast link info, if not done previously */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tipc_node_is_up</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_sent</span> <span class="o">=</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span> <span class="o">=</span>
				<span class="n">msg_last_bcast</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">oos_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_session</span> <span class="o">=</span> <span class="n">msg_session</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_bearer_id</span> <span class="o">=</span> <span class="n">msg_bearer_id</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">ACTIVATE_MSG</span><span class="p">)</span>
			<span class="n">link_state_event</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">ACTIVATE_MSG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATE_MSG</span>:

		<span class="n">msg_tol</span> <span class="o">=</span> <span class="n">msg_link_tolerance</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_tol</span><span class="p">)</span>
			<span class="n">link_set_supervision_props</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">msg_tol</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">msg_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Resetting link &lt;%s&gt;, priority change %u-&gt;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">,</span> <span class="n">msg_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">msg_linkprio</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span> <span class="cm">/* Enforce change to take effect */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">link_state_event</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">TRAFFIC_MSG_EVT</span><span class="p">);</span>
		<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_states</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_reset_unknown</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">less_eq</span><span class="p">(</span><span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">),</span> <span class="n">msg_next_sent</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rec_gap</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">msg_next_sent</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-</span>
				      <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">max_pkt_ack</span> <span class="o">=</span> <span class="n">msg_max_pkt</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_pkt_ack</span> <span class="o">&gt;</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span> <span class="o">=</span> <span class="n">max_pkt_ack</span><span class="p">;</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt_probes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">max_pkt_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_probe</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_probes</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">proto_msg</span><span class="p">))</span>
				<span class="n">max_pkt_ack</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Protocol message before retransmits, reduce loss risk */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">supported</span><span class="p">)</span>
			<span class="n">tipc_bclink_update_link_state</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span>
						      <span class="n">msg_last_bcast</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rec_gap</span> <span class="o">||</span> <span class="p">(</span><span class="n">msg_probe</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">STATE_MSG</span><span class="p">,</span>
						 <span class="mi">0</span><span class="p">,</span> <span class="n">rec_gap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_pkt_ack</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_seq_gap</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_nacks</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tipc_link_retransmit</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">,</span>
					     <span class="n">msg_seq_gap</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * tipc_link_tunnel(): Send one message via a link belonging to</span>
<span class="cm"> * another bearer. Owner node is locked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tipc_link_tunnel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">tunnel_hdr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tipc_msg</span>  <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">tunnel</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tipc_link_is_up</span><span class="p">(</span><span class="n">tunnel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link changeover error, &quot;</span>
		     <span class="s">&quot;tunnel link no longer available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg_set_size</span><span class="p">(</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link changeover error, &quot;</span>
		     <span class="s">&quot;unable to send tunnel msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
	<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">tipc_link_send_buf</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * changeover(): Send whole message queue via the remaining link</span>
<span class="cm"> *               Owner node is locked.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_changeover</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msgcount</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">crs</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="n">tunnel_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">split_bundles</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tunnel</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">permit_changeover</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link changeover error, &quot;</span>
		     <span class="s">&quot;peer did not permit changeover</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tipc_msg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">CHANGEOVER_PROTOCOL</span><span class="p">,</span>
		 <span class="n">ORIGINAL_MSG</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">msg_set_bearer_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_bearer_id</span><span class="p">);</span>
	<span class="n">msg_set_msgcnt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">msgcount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
			<span class="n">msg_set_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
			<span class="n">tipc_link_send_buf</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link changeover error, &quot;</span>
			     <span class="s">&quot;unable to send changeover msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">split_bundles</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span>
			 <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">crs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">crs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">MSG_BUNDLER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">split_bundles</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">msg_get_wrapped</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">unchar</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">unchar</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">;</span>

			<span class="n">msgcount</span> <span class="o">=</span> <span class="n">msg_msgcnt</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">msgcount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msg_set_seqno</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
				<span class="n">tipc_link_tunnel</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
						 <span class="n">msg_link_selector</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
				<span class="n">pos</span> <span class="o">+=</span> <span class="n">align</span><span class="p">(</span><span class="n">msg_size</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
				<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tipc_link_tunnel</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
					 <span class="n">msg_link_selector</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">crs</span> <span class="o">=</span> <span class="n">crs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tipc_link_send_duplicate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">tunnel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="n">tunnel_hdr</span><span class="p">;</span>

	<span class="n">tipc_msg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">CHANGEOVER_PROTOCOL</span><span class="p">,</span>
		 <span class="n">DUPLICATE_MSG</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">msg_set_msgcnt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="p">);</span>
	<span class="n">msg_set_bearer_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">peer_bearer_id</span><span class="p">);</span>
	<span class="n">iter</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">outbuf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg_user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">MSG_BUNDLER</span><span class="p">)</span>
			<span class="n">msg_set_type</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">CLOSED_MSG</span><span class="p">);</span>
		<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>	<span class="cm">/* Update */</span>
		<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">bclink</span><span class="p">.</span><span class="n">last_in</span><span class="p">);</span>
		<span class="n">msg_set_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="n">outbuf</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">outbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link changeover error, &quot;</span>
			     <span class="s">&quot;unable to send duplicate msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tunnel_hdr</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					       <span class="n">length</span><span class="p">);</span>
		<span class="n">tipc_link_send_buf</span><span class="p">(</span><span class="n">tunnel</span><span class="p">,</span> <span class="n">outbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tipc_link_is_up</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * buf_extract - extracts embedded TIPC message from another message</span>
<span class="cm"> * @skb: encapsulating message buffer</span>
<span class="cm"> * @from_pos: offset to extract from</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a new message buffer containing an embedded message.  The</span>
<span class="cm"> * encapsulating message itself is left unchanged.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">buf_extract</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">from_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">from_pos</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">eb</span><span class="p">;</span>

	<span class="n">eb</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eb</span><span class="p">)</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">eb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  link_recv_changeover_msg(): Receive tunneled packet sent</span>
<span class="cm"> *  via other link. Node is locked. Return extracted buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_recv_changeover_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">**</span><span class="n">l_ptr</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tunnel_buf</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">dest_link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">tunnel_msg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">tunnel_buf</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">msg_typ</span> <span class="o">=</span> <span class="n">msg_type</span><span class="p">(</span><span class="n">tunnel_msg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">msg_count</span> <span class="o">=</span> <span class="n">msg_msgcnt</span><span class="p">(</span><span class="n">tunnel_msg</span><span class="p">);</span>

	<span class="n">dest_link</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">msg_bearer_id</span><span class="p">(</span><span class="n">tunnel_msg</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_link</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_link</span> <span class="o">==</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unexpected changeover message on link &lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">l_ptr</span> <span class="o">=</span> <span class="n">dest_link</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">msg_get_wrapped</span><span class="p">(</span><span class="n">tunnel_msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg_typ</span> <span class="o">==</span> <span class="n">DUPLICATE_MSG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">less</span><span class="p">(</span><span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">mod</span><span class="p">(</span><span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf_extract</span><span class="p">(</span><span class="n">tunnel_buf</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link changeover error, duplicate msg dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">tunnel_buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First original message ?: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tipc_link_is_up</span><span class="p">(</span><span class="n">dest_link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Resetting link &lt;%s&gt;, changeover initiated by peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">tipc_link_reset</span><span class="p">(</span><span class="n">dest_link</span><span class="p">);</span>
		<span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">exp_msg_count</span> <span class="o">=</span> <span class="n">msg_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg_count</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">exp_msg_count</span> <span class="o">==</span> <span class="n">START_CHANGEOVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">exp_msg_count</span> <span class="o">=</span> <span class="n">msg_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg_count</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Receive original message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">exp_msg_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link switchover error, &quot;</span>
		     <span class="s">&quot;got too many tunnelled messages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">exp_msg_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">less</span><span class="p">(</span><span class="n">msg_seqno</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">dest_link</span><span class="o">-&gt;</span><span class="n">reset_checkpoint</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf_extract</span><span class="p">(</span><span class="n">tunnel_buf</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">tunnel_buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link changeover error, original msg dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">tunnel_buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Bundler functionality:</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tipc_link_recv_bundle</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msgcount</span> <span class="o">=</span> <span class="n">msg_msgcnt</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">INT_H_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">obuf</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">msgcount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obuf</span> <span class="o">=</span> <span class="n">buf_extract</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Link unable to unbundle message(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">align</span><span class="p">(</span><span class="n">msg_size</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">obuf</span><span class="p">)));</span>
		<span class="n">tipc_net_route_msg</span><span class="p">(</span><span class="n">obuf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Fragmentation/defragmentation:</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * link_send_long_buf: Entry for buffers needing fragmentation.</span>
<span class="cm"> * The buffer is complete, inclusive total message length.</span>
<span class="cm"> * Returns user data length.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_send_long_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf_chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf_chain_tail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">inmsg</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="n">fragm_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">insize</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">inmsg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dsz</span> <span class="o">=</span> <span class="n">msg_data_sz</span><span class="p">(</span><span class="n">inmsg</span><span class="p">);</span>
	<span class="n">unchar</span> <span class="o">*</span><span class="n">crs</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">insize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pack_sz</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fragm_sz</span> <span class="o">=</span> <span class="n">pack_sz</span> <span class="o">-</span> <span class="n">INT_H_SIZE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fragm_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">destaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg_short</span><span class="p">(</span><span class="n">inmsg</span><span class="p">))</span>
		<span class="n">destaddr</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">destaddr</span> <span class="o">=</span> <span class="n">msg_destnode</span><span class="p">(</span><span class="n">inmsg</span><span class="p">);</span>

	<span class="cm">/* Prepare reusable fragment header: */</span>
	<span class="n">tipc_msg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">MSG_FRAGMENTER</span><span class="p">,</span> <span class="n">FIRST_FRAGMENT</span><span class="p">,</span>
		 <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">destaddr</span><span class="p">);</span>

	<span class="cm">/* Chop up message: */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">fragm</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&lt;=</span> <span class="n">fragm_sz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fragm_sz</span> <span class="o">=</span> <span class="n">rest</span><span class="p">;</span>
			<span class="n">msg_set_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">LAST_FRAGMENT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fragm</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">fragm_sz</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fragm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">buf_chain</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="p">;</span>
				<span class="n">buf_chain</span> <span class="o">=</span> <span class="n">buf_chain</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg_set_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">fragm_sz</span> <span class="o">+</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="n">fragm_no</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg_set_fragm_no</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">fragm_no</span><span class="p">);</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">fragm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">);</span>
		<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">fragm</span><span class="p">,</span> <span class="n">INT_H_SIZE</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span>
					       <span class="n">fragm_sz</span><span class="p">);</span>
		<span class="n">buf_chain_tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">fragm</span><span class="p">;</span>
		<span class="n">buf_chain_tail</span> <span class="o">=</span> <span class="n">fragm</span><span class="p">;</span>

		<span class="n">rest</span> <span class="o">-=</span> <span class="n">fragm_sz</span><span class="p">;</span>
		<span class="n">crs</span> <span class="o">+=</span> <span class="n">fragm_sz</span><span class="p">;</span>
		<span class="n">msg_set_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fragm_hdr</span><span class="p">,</span> <span class="n">FRAGMENT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* Append chain of fragments to send queue &amp; send them */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">long_msg_seq_no</span><span class="o">++</span><span class="p">;</span>
	<span class="n">link_add_chain_to_outqueue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">buf_chain</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">long_msg_seq_no</span><span class="p">);</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_fragments</span> <span class="o">+=</span> <span class="n">fragm_no</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_fragmented</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tipc_link_push_queue</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dsz</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A pending message being re-assembled must store certain values</span>
<span class="cm"> * to handle subsequent fragments correctly. The following functions</span>
<span class="cm"> * help storing these values in unused, available fields in the</span>
<span class="cm"> * pending message. This makes dynamic memory allocation unnecessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_long_msg_seqno</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msg_set_seqno</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">seqno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_fragm_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msg_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_fragm_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msg_set_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">sz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_expected_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msg_bcast_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_expected_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">exp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msg_set_bcast_ack</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">exp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_timer_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msg_reroute_cnt</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">incr_timer_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msg_incr_reroute_cnt</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tipc_link_recv_fragment(): Called with node lock on. Returns</span>
<span class="cm"> * the reassembled buffer if message is complete.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tipc_link_recv_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">pending</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">fb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">fbuf</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">fragm</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">fbuf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pbuf</span> <span class="o">=</span> <span class="o">*</span><span class="n">pending</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">long_msg_seq_no</span> <span class="o">=</span> <span class="n">msg_long_msgno</span><span class="p">(</span><span class="n">fragm</span><span class="p">);</span>

	<span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Is there an incomplete message waiting for this fragment? */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pbuf</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">buf_seqno</span><span class="p">(</span><span class="n">pbuf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">long_msg_seq_no</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">msg_orignode</span><span class="p">(</span><span class="n">fragm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_orignode</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">pbuf</span><span class="p">)))))</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">fragm</span><span class="p">)</span> <span class="o">==</span> <span class="n">FIRST_FRAGMENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="n">imsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tipc_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_data</span><span class="p">(</span><span class="n">fragm</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">msg_sz</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">(</span><span class="n">imsg</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">fragm_sz</span> <span class="o">=</span> <span class="n">msg_data_sz</span><span class="p">(</span><span class="n">fragm</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">exp_fragm_cnt</span> <span class="o">=</span> <span class="n">msg_sz</span><span class="o">/</span><span class="n">fragm_sz</span> <span class="o">+</span> <span class="o">!!</span><span class="p">(</span><span class="n">msg_sz</span> <span class="o">%</span> <span class="n">fragm_sz</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">max</span> <span class="o">=</span>  <span class="n">TIPC_MAX_USER_MSG_SIZE</span> <span class="o">+</span> <span class="n">NAMED_H_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">imsg</span><span class="p">)</span> <span class="o">==</span> <span class="n">TIPC_MCAST_MSG</span><span class="p">)</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">TIPC_MAX_USER_MSG_SIZE</span> <span class="o">+</span> <span class="n">MCAST_H_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_size</span><span class="p">(</span><span class="n">imsg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fbuf</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="n">tipc_buf_acquire</span><span class="p">(</span><span class="n">msg_size</span><span class="p">(</span><span class="n">imsg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">pending</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pending</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">imsg</span><span class="p">,</span>
						<span class="n">msg_data_sz</span><span class="p">(</span><span class="n">fragm</span><span class="p">));</span>
			<span class="cm">/*  Prepare buffer for subsequent fragments. */</span>
			<span class="n">set_long_msg_seqno</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">long_msg_seq_no</span><span class="p">);</span>
			<span class="n">set_fragm_size</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">fragm_sz</span><span class="p">);</span>
			<span class="n">set_expected_frags</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">exp_fragm_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Link unable to reassemble fragmented message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fbuf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">(</span><span class="n">fragm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FIRST_FRAGMENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">dsz</span> <span class="o">=</span> <span class="n">msg_data_sz</span><span class="p">(</span><span class="n">fragm</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">fsz</span> <span class="o">=</span> <span class="n">get_fragm_size</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">crs</span> <span class="o">=</span> <span class="p">((</span><span class="n">msg_fragm_no</span><span class="p">(</span><span class="n">fragm</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">fsz</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">exp_frags</span> <span class="o">=</span> <span class="n">get_expected_frags</span><span class="p">(</span><span class="n">pbuf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span>
					       <span class="n">msg_data</span><span class="p">(</span><span class="n">fragm</span><span class="p">),</span> <span class="n">dsz</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fbuf</span><span class="p">);</span>

		<span class="cm">/* Is message complete? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp_frags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">pending</span> <span class="o">=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">msg_reset_reroute_cnt</span><span class="p">(</span><span class="n">buf_msg</span><span class="p">(</span><span class="n">pbuf</span><span class="p">));</span>
			<span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
			<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">buf_msg</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_expected_frags</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">exp_frags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_check_defragm_bufs - flush stale incoming message fragments</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_check_defragm_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">defragm_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_working_working</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">get_timer_cnt</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">incr_timer_cnt</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">defragm_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_set_supervision_props</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tolerance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tolerance</span> <span class="o">&lt;</span> <span class="n">TIPC_MIN_LINK_TOL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tolerance</span> <span class="o">&gt;</span> <span class="n">TIPC_MAX_LINK_TOL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">continuity_interval</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">tolerance</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">?</span> <span class="mi">500</span> <span class="o">:</span> <span class="n">tolerance</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">abort_limit</span> <span class="o">=</span> <span class="n">tolerance</span> <span class="o">/</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">continuity_interval</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tipc_link_set_queue_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">window</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Data messages from this node, inclusive FIRST_FRAGM */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_LOW_IMPORTANCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_MEDIUM_IMPORTANCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_HIGH_IMPORTANCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_CRITICAL_IMPORTANCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">;</span>
	<span class="cm">/* Transiting data messages,inclusive FIRST_FRAGM */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_LOW_IMPORTANCE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_MEDIUM_IMPORTANCE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_HIGH_IMPORTANCE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">TIPC_CRITICAL_IMPORTANCE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">CONN_MANAGER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">CHANGEOVER_PROTOCOL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">NAME_DISTRIBUTOR</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="cm">/* FRAGMENT and LAST_FRAGMENT packets */</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="n">MSG_FRAGMENTER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_find_link - locate link by name</span>
<span class="cm"> * @name - ptr to link name string</span>
<span class="cm"> * @node - ptr to area to be filled with ptr to associated node</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must hold &#39;tipc_net_lock&#39; to ensure node and bearer are not deleted;</span>
<span class="cm"> * this also prevents link deletion.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to link (or 0 if invalid link name).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="nf">link_find_link</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">**</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link_name</span> <span class="n">link_name_parts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_bearer</span> <span class="o">*</span><span class="n">b_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_name_validate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_name_parts</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">b_ptr</span> <span class="o">=</span> <span class="n">tipc_bearer_find_interface</span><span class="p">(</span><span class="n">link_name_parts</span><span class="p">.</span><span class="n">if_local</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">link_name_parts</span><span class="p">.</span><span class="n">addr_peer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">node</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">l_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">l_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_value_is_valid -- validate proposed link tolerance/priority/window</span>
<span class="cm"> *</span>
<span class="cm"> * @cmd - value type (TIPC_CMD_SET_LINK_*)</span>
<span class="cm"> * @new_value - the new value</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if value is within range, 0 if not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_value_is_valid</span><span class="p">(</span><span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_TOL</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&gt;=</span> <span class="n">TIPC_MIN_LINK_TOL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;=</span> <span class="n">TIPC_MAX_LINK_TOL</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_PRI</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;=</span> <span class="n">TIPC_MAX_LINK_PRI</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_WINDOW</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&gt;=</span> <span class="n">TIPC_MIN_LINK_WIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;=</span> <span class="n">TIPC_MAX_LINK_WIN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_cmd_set_value - change priority/tolerance/window for link/bearer/media</span>
<span class="cm"> * @name - ptr to link, bearer, or media name</span>
<span class="cm"> * @new_value - new value of link, bearer, or media setting</span>
<span class="cm"> * @cmd - which link, bearer, or media attribute to set (TIPC_CMD_SET_LINK_*)</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must hold &#39;tipc_net_lock&#39; to ensure link/bearer/media is not deleted.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if value updated and negative value on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_cmd_set_value</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_bearer</span> <span class="o">*</span><span class="n">b_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_media</span> <span class="o">*</span><span class="n">m_ptr</span><span class="p">;</span>

	<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">link_find_link</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * acquire node lock for tipc_link_send_proto_msg().</span>
<span class="cm">		 * see &quot;TIPC locking policy&quot; in net.c.</span>
<span class="cm">		 */</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_TOL</span>:
			<span class="n">link_set_supervision_props</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span>
				<span class="n">STATE_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_PRI</span>:
			<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
			<span class="n">tipc_link_send_proto_msg</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span>
				<span class="n">STATE_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_WINDOW</span>:
			<span class="n">tipc_link_set_queue_limits</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b_ptr</span> <span class="o">=</span> <span class="n">tipc_bearer_find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_TOL</span>:
			<span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_PRI</span>:
			<span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_WINDOW</span>:
			<span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_ptr</span> <span class="o">=</span> <span class="n">tipc_media_find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_TOL</span>:
		<span class="n">m_ptr</span><span class="o">-&gt;</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_PRI</span>:
		<span class="n">m_ptr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIPC_CMD_SET_LINK_WINDOW</span>:
		<span class="n">m_ptr</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">tipc_link_cmd_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">req_tlv_area</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_tlv_space</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_link_config</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TLV_CHECK</span><span class="p">(</span><span class="n">req_tlv_area</span><span class="p">,</span> <span class="n">req_tlv_space</span><span class="p">,</span> <span class="n">TIPC_TLV_LINK_CONFIG</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="n">TIPC_CFG_TLV_ERROR</span><span class="p">);</span>

	<span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link_config</span> <span class="o">*</span><span class="p">)</span><span class="n">TLV_DATA</span><span class="p">(</span><span class="n">req_tlv_area</span><span class="p">);</span>
	<span class="n">new_value</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_value_is_valid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">new_value</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span>
			<span class="s">&quot;cannot change, value invalid&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tipc_bclink_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">TIPC_CMD_SET_LINK_WINDOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tipc_bclink_set_queue_limits</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">tipc_cfg_reply_none</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="n">TIPC_CFG_NOT_SUPPORTED</span>
						   <span class="s">&quot; (cannot change setting on broadcast link)&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">link_cmd_set_value</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="s">&quot;cannot change link setting&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tipc_cfg_reply_none</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * link_reset_statistics - reset link statistics</span>
<span class="cm"> * @l_ptr: pointer to link</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_reset_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_info</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span><span class="p">;</span>
	<span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_info</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">tipc_link_cmd_reset_stats</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">req_tlv_area</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_tlv_space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">link_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TLV_CHECK</span><span class="p">(</span><span class="n">req_tlv_area</span><span class="p">,</span> <span class="n">req_tlv_space</span><span class="p">,</span> <span class="n">TIPC_TLV_LINK_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="n">TIPC_CFG_TLV_ERROR</span><span class="p">);</span>

	<span class="n">link_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">TLV_DATA</span><span class="p">(</span><span class="n">req_tlv_area</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">link_name</span><span class="p">,</span> <span class="n">tipc_bclink_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tipc_bclink_reset_stats</span><span class="p">())</span>
			<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="s">&quot;link not found&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_none</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">link_find_link</span><span class="p">(</span><span class="n">link_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="s">&quot;link not found&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="n">link_reset_statistics</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">);</span>
	<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tipc_cfg_reply_none</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * percent - convert count to a percentage of total (rounding up or down)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">percent</span><span class="p">(</span><span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">total</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tipc_link_stats - print link statistics</span>
<span class="cm"> * @name: link name</span>
<span class="cm"> * @buf: print buffer area</span>
<span class="cm"> * @buf_size: size of print buffer area</span>
<span class="cm"> *</span>
<span class="cm"> * Returns length of print buffer data string (or 0 if error)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tipc_link_stats</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_buf</span> <span class="n">pb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">profile_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tipc_bclink_name</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tipc_bclink_stats</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>

	<span class="n">tipc_printbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">link_find_link</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tipc_link_is_active</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="s">&quot;ACTIVE&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tipc_link_is_up</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="s">&quot;STANDBY&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="s">&quot;DEFUNCT&quot;</span><span class="p">;</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="s">&quot;Link &lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			 <span class="s">&quot;  %s  MTU:%u  Priority:%u  Tolerance:%u ms&quot;</span>
			 <span class="s">&quot;  Window:%u packets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">queue_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="s">&quot;  RX packets:%u fragments:%u/%u bundles:%u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span> <span class="o">-</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_info</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_fragments</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_fragmented</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_bundles</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_bundled</span><span class="p">);</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="s">&quot;  TX packets:%u fragments:%u/%u bundles:%u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span> <span class="o">-</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_info</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_fragments</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_fragmented</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_bundles</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_bundled</span><span class="p">);</span>
	<span class="n">profile_total</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_counts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">profile_total</span><span class="p">)</span>
		<span class="n">profile_total</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="s">&quot;  TX profile sample:%u packets  average:%u octets</span><span class="se">\n</span><span class="s">&quot;</span>
			 <span class="s">&quot;  0-64:%u%% -256:%u%% -1024:%u%% -4096:%u%% &quot;</span>
			 <span class="s">&quot;-16384:%u%% -32768:%u%% -66000:%u%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_counts</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_lengths_total</span> <span class="o">/</span> <span class="n">profile_total</span><span class="p">,</span>
		    <span class="n">percent</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">profile_total</span><span class="p">),</span>
		    <span class="n">percent</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">profile_total</span><span class="p">),</span>
		    <span class="n">percent</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">profile_total</span><span class="p">),</span>
		    <span class="n">percent</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">profile_total</span><span class="p">),</span>
		    <span class="n">percent</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">profile_total</span><span class="p">),</span>
		    <span class="n">percent</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">profile_total</span><span class="p">),</span>
		    <span class="n">percent</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">msg_length_profile</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">profile_total</span><span class="p">));</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="s">&quot;  RX states:%u probes:%u naks:%u defs:%u dups:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_states</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_probes</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_nacks</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">deferred_recv</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">duplicates</span><span class="p">);</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="s">&quot;  TX states:%u probes:%u naks:%u acks:%u dups:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_states</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_probes</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_nacks</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">sent_acks</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">retransmitted</span><span class="p">);</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">,</span> <span class="s">&quot;  Congestion bearer:%u link:%u  Send queue max:%u avg:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bearer_congs</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_congs</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">max_queue_sz</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">queue_sz_counts</span>
		    <span class="o">?</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">accu_queue_sz</span> <span class="o">/</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">queue_sz_counts</span><span class="p">)</span>
		    <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tipc_printbuf_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_LINK_STATS_INFO 2000</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">tipc_link_cmd_show_stats</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">req_tlv_area</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_tlv_space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlv_desc</span> <span class="o">*</span><span class="n">rep_tlv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">str_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TLV_CHECK</span><span class="p">(</span><span class="n">req_tlv_area</span><span class="p">,</span> <span class="n">req_tlv_space</span><span class="p">,</span> <span class="n">TIPC_TLV_LINK_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="n">TIPC_CFG_TLV_ERROR</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">tipc_cfg_reply_alloc</span><span class="p">(</span><span class="n">TLV_SPACE</span><span class="p">(</span><span class="n">MAX_LINK_STATS_INFO</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rep_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tlv_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">str_len</span> <span class="o">=</span> <span class="n">tipc_link_stats</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">TLV_DATA</span><span class="p">(</span><span class="n">req_tlv_area</span><span class="p">),</span>
				  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">TLV_DATA</span><span class="p">(</span><span class="n">rep_tlv</span><span class="p">),</span> <span class="n">MAX_LINK_STATS_INFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tipc_cfg_reply_error_string</span><span class="p">(</span><span class="s">&quot;link not found&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">TLV_SPACE</span><span class="p">(</span><span class="n">str_len</span><span class="p">));</span>
	<span class="n">TLV_SET</span><span class="p">(</span><span class="n">rep_tlv</span><span class="p">,</span> <span class="n">TIPC_TLV_ULTRA_STRING</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">str_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tipc_link_get_max_pkt - get maximum packet size to use when sending to destination</span>
<span class="cm"> * @dest: network address of destination node</span>
<span class="cm"> * @selector: used to select from set of active links</span>
<span class="cm"> *</span>
<span class="cm"> * If no active link can be found, uses default maximum packet size.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">tipc_link_get_max_pkt</span><span class="p">(</span><span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tipc_node</span> <span class="o">*</span><span class="n">n_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res</span> <span class="o">=</span> <span class="n">MAX_PKT_DEFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">==</span> <span class="n">tipc_own_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MAX_MSG_SIZE</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="n">n_ptr</span> <span class="o">=</span> <span class="n">tipc_node_find</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tipc_node_lock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
		<span class="n">l_ptr</span> <span class="o">=</span> <span class="n">n_ptr</span><span class="o">-&gt;</span><span class="n">active_links</span><span class="p">[</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">max_pkt</span><span class="p">;</span>
		<span class="n">tipc_node_unlock</span><span class="p">(</span><span class="n">n_ptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tipc_net_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_link</span> <span class="o">*</span><span class="n">l_ptr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">print_area</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">print_buf</span> <span class="n">pb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pb</span><span class="p">;</span>

	<span class="n">tipc_printbuf_init</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">print_area</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">print_area</span><span class="p">));</span>

	<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Link %x&lt;%s&gt;:&quot;</span><span class="p">,</span>
		    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TIPC_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_reset_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">)</span> <span class="o">||</span> <span class="n">link_reset_unknown</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">print_state</span><span class="p">;</span>

	<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;: NXO(%u):&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out_no</span><span class="p">));</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;NXI(%u):&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_in_no</span><span class="p">));</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;SQUE&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[%u..&quot;</span><span class="p">,</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">)</span>
			<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u..&quot;</span><span class="p">,</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">));</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u]&quot;</span><span class="p">,</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mod</span><span class="p">(</span><span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span><span class="p">)</span> <span class="o">-</span>
			 <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">))</span>
		     <span class="o">!=</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Send queue inconsistency</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;first_out= %p &quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">first_out</span><span class="p">);</span>
			<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;next_out= %p &quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">next_out</span><span class="p">);</span>
			<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;last_out= %p &quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">last_out</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[]&quot;</span><span class="p">);</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;SQSIZ(%u)&quot;</span><span class="p">,</span> <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">out_queue_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">o</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">oldest_deferred_in</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">n</span> <span class="o">=</span> <span class="n">buf_seqno</span><span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">newest_deferred_in</span><span class="p">);</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;:RQUE[%u..%u]&quot;</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">deferred_inqueue_sz</span> <span class="o">!=</span> <span class="n">mod</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">o</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;:RQSIZ(%u)&quot;</span><span class="p">,</span>
				    <span class="n">l_ptr</span><span class="o">-&gt;</span><span class="n">deferred_inqueue_sz</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">print_state:</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_working_unknown</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;:WU&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link_reset_reset</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;:RR&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link_reset_unknown</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;:RU&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link_working_working</span><span class="p">(</span><span class="n">l_ptr</span><span class="p">))</span>
		<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;:WW&quot;</span><span class="p">);</span>
	<span class="n">tipc_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tipc_printbuf_validate</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">print_area</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
