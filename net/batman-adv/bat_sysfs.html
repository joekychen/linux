<!DOCTYPE html>
<html><head><title>joekychen/linux » net › batman-adv › bat_sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>bat_sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2010-2012 B.A.T.M.A.N. contributors:</span>
<span class="cm"> *</span>
<span class="cm"> * Marek Lindner</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General Public</span>
<span class="cm"> * License as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;bat_sysfs.h&quot;</span>
<span class="cp">#include &quot;translation-table.h&quot;</span>
<span class="cp">#include &quot;originator.h&quot;</span>
<span class="cp">#include &quot;hard-interface.h&quot;</span>
<span class="cp">#include &quot;gateway_common.h&quot;</span>
<span class="cp">#include &quot;gateway_client.h&quot;</span>
<span class="cp">#include &quot;vis.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">kobj_to_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="nf">kobj_to_batpriv</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">kobj_to_netdev</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define UEV_TYPE_VAR	&quot;BATTYPE=&quot;</span>
<span class="cp">#define UEV_ACTION_VAR	&quot;BATACTION=&quot;</span>
<span class="cp">#define UEV_DATA_VAR	&quot;BATDATA=&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uev_action_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;add&quot;</span><span class="p">,</span>
	<span class="s">&quot;del&quot;</span><span class="p">,</span>
	<span class="s">&quot;change&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uev_type_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;gw&quot;</span>
<span class="p">};</span>

<span class="cm">/* Use this, if you have customized show and store functions */</span>
<span class="cp">#define BAT_ATTR(_name, _mode, _show, _store)	\</span>
<span class="cp">struct bat_attribute bat_attr_##_name = {	\</span>
<span class="cp">	.attr = {.name = __stringify(_name),	\</span>
<span class="cp">		 .mode = _mode },		\</span>
<span class="cp">	.show   = _show,			\</span>
<span class="cp">	.store  = _store,			\</span>
<span class="cp">};</span>

<span class="cp">#define BAT_ATTR_SIF_STORE_BOOL(_name, _post_func)			\</span>
<span class="cp">ssize_t store_##_name(struct kobject *kobj, struct attribute *attr,	\</span>
<span class="cp">		      char *buff, size_t count)				\</span>
<span class="cp">{									\</span>
<span class="cp">	struct net_device *net_dev = kobj_to_netdev(kobj);		\</span>
<span class="cp">	struct bat_priv *bat_priv = netdev_priv(net_dev);		\</span>
<span class="cp">	return __store_bool_attr(buff, count, _post_func, attr,		\</span>
<span class="cp">				 &amp;bat_priv-&gt;_name, net_dev);		\</span>
<span class="cp">}</span>

<span class="cp">#define BAT_ATTR_SIF_SHOW_BOOL(_name)					\</span>
<span class="cp">ssize_t show_##_name(struct kobject *kobj,				\</span>
<span class="cp">		     struct attribute *attr, char *buff)		\</span>
<span class="cp">{									\</span>
<span class="cp">	struct bat_priv *bat_priv = kobj_to_batpriv(kobj);		\</span>
<span class="cp">	return sprintf(buff, &quot;%s\n&quot;,					\</span>
<span class="cp">		       atomic_read(&amp;bat_priv-&gt;_name) == 0 ?		\</span>
<span class="cp">		       &quot;disabled&quot; : &quot;enabled&quot;);				\</span>
<span class="cp">}									\</span>

<span class="cm">/* Use this, if you are going to turn a [name] in the soft-interface</span>
<span class="cm"> * (bat_priv) on or off */</span>
<span class="cp">#define BAT_ATTR_SIF_BOOL(_name, _mode, _post_func)			\</span>
<span class="cp">	static BAT_ATTR_SIF_STORE_BOOL(_name, _post_func)		\</span>
<span class="cp">	static BAT_ATTR_SIF_SHOW_BOOL(_name)				\</span>
<span class="cp">	static BAT_ATTR(_name, _mode, show_##_name, store_##_name)</span>


<span class="cp">#define BAT_ATTR_SIF_STORE_UINT(_name, _min, _max, _post_func)		\</span>
<span class="cp">ssize_t store_##_name(struct kobject *kobj, struct attribute *attr,	\</span>
<span class="cp">		      char *buff, size_t count)				\</span>
<span class="cp">{									\</span>
<span class="cp">	struct net_device *net_dev = kobj_to_netdev(kobj);		\</span>
<span class="cp">	struct bat_priv *bat_priv = netdev_priv(net_dev);		\</span>
<span class="cp">	return __store_uint_attr(buff, count, _min, _max, _post_func,	\</span>
<span class="cp">				 attr, &amp;bat_priv-&gt;_name, net_dev);	\</span>
<span class="cp">}</span>

<span class="cp">#define BAT_ATTR_SIF_SHOW_UINT(_name)					\</span>
<span class="cp">ssize_t show_##_name(struct kobject *kobj,				\</span>
<span class="cp">		     struct attribute *attr, char *buff)		\</span>
<span class="cp">{									\</span>
<span class="cp">	struct bat_priv *bat_priv = kobj_to_batpriv(kobj);		\</span>
<span class="cp">	return sprintf(buff, &quot;%i\n&quot;, atomic_read(&amp;bat_priv-&gt;_name));	\</span>
<span class="cp">}									\</span>

<span class="cm">/* Use this, if you are going to set [name] in the soft-interface</span>
<span class="cm"> * (bat_priv) to an unsigned integer value */</span>
<span class="cp">#define BAT_ATTR_SIF_UINT(_name, _mode, _min, _max, _post_func)		\</span>
<span class="cp">	static BAT_ATTR_SIF_STORE_UINT(_name, _min, _max, _post_func)	\</span>
<span class="cp">	static BAT_ATTR_SIF_SHOW_UINT(_name)				\</span>
<span class="cp">	static BAT_ATTR(_name, _mode, show_##_name, store_##_name)</span>


<span class="cp">#define BAT_ATTR_HIF_STORE_UINT(_name, _min, _max, _post_func)		\</span>
<span class="cp">ssize_t store_##_name(struct kobject *kobj, struct attribute *attr,	\</span>
<span class="cp">		      char *buff, size_t count)				\</span>
<span class="cp">{									\</span>
<span class="cp">	struct net_device *net_dev = kobj_to_netdev(kobj);		\</span>
<span class="cp">	struct hard_iface *hard_iface = hardif_get_by_netdev(net_dev);	\</span>
<span class="cp">	ssize_t length;							\</span>
<span class="cp">									\</span>
<span class="cp">	if (!hard_iface)						\</span>
<span class="cp">		return 0;						\</span>
<span class="cp">									\</span>
<span class="cp">	length = __store_uint_attr(buff, count, _min, _max, _post_func,	\</span>
<span class="cp">				   attr, &amp;hard_iface-&gt;_name, net_dev);	\</span>
<span class="cp">									\</span>
<span class="cp">	hardif_free_ref(hard_iface);					\</span>
<span class="cp">	return length;							\</span>
<span class="cp">}</span>

<span class="cp">#define BAT_ATTR_HIF_SHOW_UINT(_name)					\</span>
<span class="cp">ssize_t show_##_name(struct kobject *kobj,				\</span>
<span class="cp">		     struct attribute *attr, char *buff)		\</span>
<span class="cp">{									\</span>
<span class="cp">	struct net_device *net_dev = kobj_to_netdev(kobj);		\</span>
<span class="cp">	struct hard_iface *hard_iface = hardif_get_by_netdev(net_dev);	\</span>
<span class="cp">	ssize_t length;							\</span>
<span class="cp">									\</span>
<span class="cp">	if (!hard_iface)						\</span>
<span class="cp">		return 0;						\</span>
<span class="cp">									\</span>
<span class="cp">	length = sprintf(buff, &quot;%i\n&quot;, atomic_read(&amp;hard_iface-&gt;_name));\</span>
<span class="cp">									\</span>
<span class="cp">	hardif_free_ref(hard_iface);					\</span>
<span class="cp">	return length;							\</span>
<span class="cp">}</span>

<span class="cm">/* Use this, if you are going to set [name] in hard_iface to an</span>
<span class="cm"> * unsigned integer value*/</span>
<span class="cp">#define BAT_ATTR_HIF_UINT(_name, _mode, _min, _max, _post_func)		\</span>
<span class="cp">	static BAT_ATTR_HIF_STORE_UINT(_name, _min, _max, _post_func)	\</span>
<span class="cp">	static BAT_ATTR_HIF_SHOW_UINT(_name)				\</span>
<span class="cp">	static BAT_ATTR(_name, _mode, show_##_name, store_##_name)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">store_bool_attr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">atomic_t</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;enabled&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: Invalid parameter received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">attr_name</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;%s: Changing from: %s to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span>
		 <span class="n">atomic_read</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
		 <span class="n">enabled</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">enabled</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span> <span class="nf">__store_bool_attr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">post_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">),</span>
			<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="n">atomic_t</span> <span class="o">*</span><span class="n">attr_store</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">store_bool_attr</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">net_dev</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">attr_store</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">post_func</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="p">)</span>
		<span class="n">post_func</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">store_uint_attr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">attr_name</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="n">atomic_t</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uint_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uint_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: Invalid parameter received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">attr_name</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uint_val</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;%s: Value is too small: %lu min: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">attr_name</span><span class="p">,</span> <span class="n">uint_val</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uint_val</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;%s: Value is too big: %lu max: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">attr_name</span><span class="p">,</span> <span class="n">uint_val</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">uint_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;%s: Changing from: %i to: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">attr_name</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">uint_val</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">uint_val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span> <span class="nf">__store_uint_attr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span>
			<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">post_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">),</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="n">atomic_t</span> <span class="o">*</span><span class="n">attr_store</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">store_uint_attr</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">net_dev</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			      <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">attr_store</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">post_func</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="p">)</span>
		<span class="n">post_func</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vis_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">kobj_to_batpriv</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vis_mode</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">vis_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vis_mode</span> <span class="o">==</span> <span class="n">VIS_TYPE_CLIENT_UPDATE</span> <span class="o">?</span>
							<span class="s">&quot;client&quot;</span> <span class="o">:</span> <span class="s">&quot;server&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_vis_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">kobj_to_netdev</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">vis_mode_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">VIS_TYPE_CLIENT_UPDATE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;client&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">vis_mode_tmp</span> <span class="o">=</span> <span class="n">VIS_TYPE_CLIENT_UPDATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">VIS_TYPE_SERVER_SYNC</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;server&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">vis_mode_tmp</span> <span class="o">=</span> <span class="n">VIS_TYPE_SERVER_SYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vis_mode_tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span>
			 <span class="s">&quot;Invalid parameter for &#39;vis mode&#39; setting received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">vis_mode</span><span class="p">)</span> <span class="o">==</span> <span class="n">vis_mode_tmp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;Changing vis mode from: %s to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">vis_mode</span><span class="p">)</span> <span class="o">==</span> <span class="n">VIS_TYPE_CLIENT_UPDATE</span> <span class="o">?</span>
		 <span class="s">&quot;client&quot;</span> <span class="o">:</span> <span class="s">&quot;server&quot;</span><span class="p">,</span> <span class="n">vis_mode_tmp</span> <span class="o">==</span> <span class="n">VIS_TYPE_CLIENT_UPDATE</span> <span class="o">?</span>
		 <span class="s">&quot;client&quot;</span> <span class="o">:</span> <span class="s">&quot;server&quot;</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">vis_mode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">vis_mode_tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bat_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">kobj_to_batpriv</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">bat_algo_ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">post_gw_deselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="n">gw_deselect</span><span class="p">(</span><span class="n">bat_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_gw_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">kobj_to_batpriv</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bytes_written</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">gw_mode</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GW_MODE_CLIENT</span>:
		<span class="n">bytes_written</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GW_MODE_CLIENT_NAME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GW_MODE_SERVER</span>:
		<span class="n">bytes_written</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GW_MODE_SERVER_NAME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bytes_written</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GW_MODE_OFF_NAME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bytes_written</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_gw_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">kobj_to_netdev</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">curr_gw_mode_str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gw_mode_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">GW_MODE_OFF_NAME</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">GW_MODE_OFF_NAME</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gw_mode_tmp</span> <span class="o">=</span> <span class="n">GW_MODE_OFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">GW_MODE_CLIENT_NAME</span><span class="p">,</span>
		    <span class="n">strlen</span><span class="p">(</span><span class="n">GW_MODE_CLIENT_NAME</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gw_mode_tmp</span> <span class="o">=</span> <span class="n">GW_MODE_CLIENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">GW_MODE_SERVER_NAME</span><span class="p">,</span>
		    <span class="n">strlen</span><span class="p">(</span><span class="n">GW_MODE_SERVER_NAME</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gw_mode_tmp</span> <span class="o">=</span> <span class="n">GW_MODE_SERVER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gw_mode_tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span>
			 <span class="s">&quot;Invalid parameter for &#39;gw mode&#39; setting received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">gw_mode</span><span class="p">)</span> <span class="o">==</span> <span class="n">gw_mode_tmp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">gw_mode</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GW_MODE_CLIENT</span>:
		<span class="n">curr_gw_mode_str</span> <span class="o">=</span> <span class="n">GW_MODE_CLIENT_NAME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GW_MODE_SERVER</span>:
		<span class="n">curr_gw_mode_str</span> <span class="o">=</span> <span class="n">GW_MODE_SERVER_NAME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">curr_gw_mode_str</span> <span class="o">=</span> <span class="n">GW_MODE_OFF_NAME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bat_info</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;Changing gw mode from: %s to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">curr_gw_mode_str</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>

	<span class="n">gw_deselect</span><span class="p">(</span><span class="n">bat_priv</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">gw_mode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">gw_mode_tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_gw_bwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">kobj_to_batpriv</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">down</span><span class="p">,</span> <span class="n">up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gw_bandwidth</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">gw_bandwidth</span><span class="p">);</span>

	<span class="n">gw_bandwidth_to_kbit</span><span class="p">(</span><span class="n">gw_bandwidth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">down</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%i%s/%i%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">down</span> <span class="o">&gt;</span> <span class="mi">2048</span> <span class="o">?</span> <span class="n">down</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">:</span> <span class="n">down</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">down</span> <span class="o">&gt;</span> <span class="mi">2048</span> <span class="o">?</span> <span class="s">&quot;MBit&quot;</span> <span class="o">:</span> <span class="s">&quot;KBit&quot;</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">up</span> <span class="o">&gt;</span> <span class="mi">2048</span> <span class="o">?</span> <span class="n">up</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">:</span> <span class="n">up</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">up</span> <span class="o">&gt;</span> <span class="mi">2048</span> <span class="o">?</span> <span class="s">&quot;MBit&quot;</span> <span class="o">:</span> <span class="s">&quot;KBit&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_gw_bwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">kobj_to_netdev</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gw_bandwidth_set</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">BAT_ATTR_SIF_BOOL</span><span class="p">(</span><span class="n">aggregated_ogms</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">BAT_ATTR_SIF_BOOL</span><span class="p">(</span><span class="n">bonding</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BATMAN_ADV_BLA</span>
<span class="n">BAT_ATTR_SIF_BOOL</span><span class="p">(</span><span class="n">bridge_loop_avoidance</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">BAT_ATTR_SIF_BOOL</span><span class="p">(</span><span class="n">fragmentation</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">update_min_mtu</span><span class="p">);</span>
<span class="n">BAT_ATTR_SIF_BOOL</span><span class="p">(</span><span class="n">ap_isolation</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BAT_ATTR</span><span class="p">(</span><span class="n">vis_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_vis_mode</span><span class="p">,</span> <span class="n">store_vis_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BAT_ATTR</span><span class="p">(</span><span class="n">routing_algo</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_bat_algo</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BAT_ATTR</span><span class="p">(</span><span class="n">gw_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_gw_mode</span><span class="p">,</span> <span class="n">store_gw_mode</span><span class="p">);</span>
<span class="n">BAT_ATTR_SIF_UINT</span><span class="p">(</span><span class="n">orig_interval</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">JITTER</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">BAT_ATTR_SIF_UINT</span><span class="p">(</span><span class="n">hop_penalty</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TQ_MAX_VALUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">BAT_ATTR_SIF_UINT</span><span class="p">(</span><span class="n">gw_sel_class</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TQ_MAX_VALUE</span><span class="p">,</span>
		  <span class="n">post_gw_deselect</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BAT_ATTR</span><span class="p">(</span><span class="n">gw_bandwidth</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_gw_bwidth</span><span class="p">,</span>
		<span class="n">store_gw_bwidth</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BATMAN_ADV_DEBUG</span>
<span class="n">BAT_ATTR_SIF_UINT</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bat_attribute</span> <span class="o">*</span><span class="n">mesh_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">bat_attr_aggregated_ogms</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_bonding</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_BATMAN_ADV_BLA</span>
	<span class="o">&amp;</span><span class="n">bat_attr_bridge_loop_avoidance</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="o">&amp;</span><span class="n">bat_attr_fragmentation</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_ap_isolation</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_vis_mode</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_routing_algo</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_gw_mode</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_orig_interval</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_hop_penalty</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_gw_sel_class</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_gw_bandwidth</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_BATMAN_ADV_DEBUG</span>
	<span class="o">&amp;</span><span class="n">bat_attr_log_level</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">sysfs_add_meshif</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">batif_kobject</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bat_attribute</span> <span class="o">**</span><span class="n">bat_attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="n">SYSFS_IF_MESH_SUBDIR</span><span class="p">,</span>
						    <span class="n">batif_kobject</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bat_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t add sysfs directory: %s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">SYSFS_IF_MESH_SUBDIR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bat_attr</span> <span class="o">=</span> <span class="n">mesh_attrs</span><span class="p">;</span> <span class="o">*</span><span class="n">bat_attr</span><span class="p">;</span> <span class="o">++</span><span class="n">bat_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">bat_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bat_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t add sysfs file: %s/%s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SYSFS_IF_MESH_SUBDIR</span><span class="p">,</span>
				<span class="p">((</span><span class="o">*</span><span class="n">bat_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">).</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rem_attr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rem_attr:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bat_attr</span> <span class="o">=</span> <span class="n">mesh_attrs</span><span class="p">;</span> <span class="o">*</span><span class="n">bat_attr</span><span class="p">;</span> <span class="o">++</span><span class="n">bat_attr</span><span class="p">)</span>
		<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">bat_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">));</span>

	<span class="n">kobject_put</span><span class="p">(</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span><span class="p">);</span>
	<span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sysfs_del_meshif</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bat_attribute</span> <span class="o">**</span><span class="n">bat_attr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bat_attr</span> <span class="o">=</span> <span class="n">mesh_attrs</span><span class="p">;</span> <span class="o">*</span><span class="n">bat_attr</span><span class="p">;</span> <span class="o">++</span><span class="n">bat_attr</span><span class="p">)</span>
		<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">bat_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">));</span>

	<span class="n">kobject_put</span><span class="p">(</span><span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span><span class="p">);</span>
	<span class="n">bat_priv</span><span class="o">-&gt;</span><span class="n">mesh_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_mesh_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">kobj_to_netdev</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hard_iface</span> <span class="o">*</span><span class="n">hard_iface</span> <span class="o">=</span> <span class="n">hardif_get_by_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hard_iface</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard_iface</span><span class="o">-&gt;</span><span class="n">if_status</span> <span class="o">==</span> <span class="n">IF_NOT_IN_USE</span> <span class="o">?</span>
			 <span class="s">&quot;none&quot;</span> <span class="o">:</span> <span class="n">hard_iface</span><span class="o">-&gt;</span><span class="n">soft_iface</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hardif_free_ref</span><span class="p">(</span><span class="n">hard_iface</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_mesh_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">kobj_to_netdev</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hard_iface</span> <span class="o">*</span><span class="n">hard_iface</span> <span class="o">=</span> <span class="n">hardif_get_by_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hard_iface</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">buff</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">IFNAMSIZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Invalid parameter for &#39;mesh_iface&#39; setting received: interface name too long &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">buff</span><span class="p">);</span>
		<span class="n">hardif_free_ref</span><span class="p">(</span><span class="n">hard_iface</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status_tmp</span> <span class="o">=</span> <span class="n">IF_NOT_IN_USE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status_tmp</span> <span class="o">=</span> <span class="n">IF_I_WANT_YOU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hard_iface</span><span class="o">-&gt;</span><span class="n">if_status</span> <span class="o">==</span> <span class="n">status_tmp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hard_iface</span><span class="o">-&gt;</span><span class="n">soft_iface</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">hard_iface</span><span class="o">-&gt;</span><span class="n">soft_iface</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_tmp</span> <span class="o">==</span> <span class="n">IF_NOT_IN_USE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hardif_disable_interface</span><span class="p">(</span><span class="n">hard_iface</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if the interface already is in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard_iface</span><span class="o">-&gt;</span><span class="n">if_status</span> <span class="o">!=</span> <span class="n">IF_NOT_IN_USE</span><span class="p">)</span>
		<span class="n">hardif_disable_interface</span><span class="p">(</span><span class="n">hard_iface</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hardif_enable_interface</span><span class="p">(</span><span class="n">hard_iface</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">hardif_free_ref</span><span class="p">(</span><span class="n">hard_iface</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_iface_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">kobj_to_netdev</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hard_iface</span> <span class="o">*</span><span class="n">hard_iface</span> <span class="o">=</span> <span class="n">hardif_get_by_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hard_iface</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hard_iface</span><span class="o">-&gt;</span><span class="n">if_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IF_TO_BE_REMOVED</span>:
		<span class="n">length</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IF_INACTIVE</span>:
		<span class="n">length</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;inactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IF_ACTIVE</span>:
		<span class="n">length</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IF_TO_BE_ACTIVATED</span>:
		<span class="n">length</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;enabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IF_NOT_IN_USE</span>:
	<span class="nl">default:</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;not in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hardif_free_ref</span><span class="p">(</span><span class="n">hard_iface</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BAT_ATTR</span><span class="p">(</span><span class="n">mesh_iface</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="n">show_mesh_iface</span><span class="p">,</span> <span class="n">store_mesh_iface</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BAT_ATTR</span><span class="p">(</span><span class="n">iface_status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_iface_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bat_attribute</span> <span class="o">*</span><span class="n">batman_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">bat_attr_mesh_iface</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bat_attr_iface_status</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">sysfs_add_hardif</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">**</span><span class="n">hardif_obj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">hardif_kobject</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bat_attribute</span> <span class="o">**</span><span class="n">bat_attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">hardif_obj</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="n">SYSFS_IF_BAT_SUBDIR</span><span class="p">,</span>
						    <span class="n">hardif_kobject</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">hardif_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bat_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t add sysfs directory: %s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">SYSFS_IF_BAT_SUBDIR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bat_attr</span> <span class="o">=</span> <span class="n">batman_attrs</span><span class="p">;</span> <span class="o">*</span><span class="n">bat_attr</span><span class="p">;</span> <span class="o">++</span><span class="n">bat_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">*</span><span class="n">hardif_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">bat_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bat_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t add sysfs file: %s/%s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SYSFS_IF_BAT_SUBDIR</span><span class="p">,</span>
				<span class="p">((</span><span class="o">*</span><span class="n">bat_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">).</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rem_attr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rem_attr:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bat_attr</span> <span class="o">=</span> <span class="n">batman_attrs</span><span class="p">;</span> <span class="o">*</span><span class="n">bat_attr</span><span class="p">;</span> <span class="o">++</span><span class="n">bat_attr</span><span class="p">)</span>
		<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="o">*</span><span class="n">hardif_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">bat_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sysfs_del_hardif</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">**</span><span class="n">hardif_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">*</span><span class="n">hardif_obj</span><span class="p">);</span>
	<span class="o">*</span><span class="n">hardif_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">throw_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">bat_priv</span> <span class="o">*</span><span class="n">bat_priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">uev_type</span> <span class="n">type</span><span class="p">,</span>
		 <span class="k">enum</span> <span class="n">uev_action</span> <span class="n">action</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hard_iface</span> <span class="o">*</span><span class="n">primary_if</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">bat_kobj</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="n">primary_if</span> <span class="o">=</span> <span class="n">primary_if_get_selected</span><span class="p">(</span><span class="n">bat_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">primary_if</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">bat_kobj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">primary_if</span><span class="o">-&gt;</span><span class="n">soft_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">;</span>

	<span class="n">uevent_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">UEV_TYPE_VAR</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">uev_type_str</span><span class="p">[</span><span class="n">type</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">UEV_TYPE_VAR</span><span class="p">,</span> <span class="n">uev_type_str</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>

	<span class="n">uevent_env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">UEV_ACTION_VAR</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">uev_action_str</span><span class="p">[</span><span class="n">action</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">UEV_ACTION_VAR</span><span class="p">,</span> <span class="n">uev_action_str</span><span class="p">[</span><span class="n">action</span><span class="p">]);</span>

	<span class="cm">/* If the event is DEL, ignore the data field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">!=</span> <span class="n">UEV_DEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uevent_env</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">UEV_DATA_VAR</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">UEV_DATA_VAR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_uevent_env</span><span class="p">(</span><span class="n">bat_kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">uevent_env</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uevent_env</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">primary_if</span><span class="p">)</span>
		<span class="n">hardif_free_ref</span><span class="p">(</span><span class="n">primary_if</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">bat_dbg</span><span class="p">(</span><span class="n">DBG_BATMAN</span><span class="p">,</span> <span class="n">bat_priv</span><span class="p">,</span>
			<span class="s">&quot;Impossible to send uevent for (%s,%s,%s) event (err: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uev_type_str</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">uev_action_str</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
			<span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">UEV_DEL</span> <span class="o">?</span> <span class="s">&quot;NULL&quot;</span> <span class="o">:</span> <span class="n">data</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
