<!DOCTYPE html>
<html><head><title>joekychen/linux » net › atm › mpoa_proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mpoa_proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;:%s: &quot; fmt, __func__</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/atmmpc.h&gt;</span>
<span class="cp">#include &lt;linux/atm.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &quot;mpc.h&quot;</span>
<span class="cp">#include &quot;mpoa_caches.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * mpoa_proc.c: Implementation MPOA client&#39;s proc</span>
<span class="cm"> * file system statistics</span>
<span class="cm"> */</span>

<span class="cp">#if 1</span>
<span class="cp">#define dprintk(format, args...)					\</span>
<span class="cp">	printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __FILE__, ##args)  </span><span class="cm">/* debug */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define dprintk(format, args...)					\</span>
<span class="cp">	do { if (0)							\</span>
<span class="cp">		printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __FILE__, ##args);\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define ddprintk(format, args...)					\</span>
<span class="c">	printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __FILE__, ##args)  /* debug */</span>
<span class="cp">#else</span>
<span class="cp">#define ddprintk(format, args...)					\</span>
<span class="cp">	do { if (0)							\</span>
<span class="cp">		printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __FILE__, ##args);\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#define STAT_FILE_NAME &quot;mpc&quot;     </span><span class="cm">/* Our statistic file&#39;s name */</span><span class="cp"></span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpcs</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">atm_proc_root</span><span class="p">;</span>  <span class="cm">/* from proc.c. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_mpc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">proc_mpc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">parse_qos</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *   Define allowed FILE OPERATIONS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpc_file_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">proc_mpc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">proc_mpc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the state of an ingress cache entry as a string</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ingress_state_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INGRESS_RESOLVING</span>:
		<span class="k">return</span> <span class="s">&quot;resolving  &quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INGRESS_RESOLVED</span>:
		<span class="k">return</span> <span class="s">&quot;resolved   &quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INGRESS_INVALID</span>:
		<span class="k">return</span> <span class="s">&quot;invalid    &quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INGRESS_REFRESHING</span>:
		<span class="k">return</span> <span class="s">&quot;refreshing &quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the state of an egress cache entry as a string</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">egress_state_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EGRESS_RESOLVED</span>:
		<span class="k">return</span> <span class="s">&quot;resolved   &quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EGRESS_PURGE</span>:
		<span class="k">return</span> <span class="s">&quot;purge      &quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EGRESS_INVALID</span>:
		<span class="k">return</span> <span class="s">&quot;invalid    &quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: mpcs (and per-mpc lists) have no locking whatsoever.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">mpc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">=</span> <span class="n">mpcs</span><span class="p">;</span> <span class="n">mpc</span><span class="p">;</span> <span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="o">--</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mpc</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">mpc_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span> <span class="o">?</span> <span class="n">mpcs</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * READING function - called when the /proc/atm/mpoa file is read from.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">in_entry</span><span class="p">;</span>
	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">eg_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ip_string</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atm_mpoa_disp_qos</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Interface %d:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev_num</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Ingress Entries:</span><span class="se">\n</span><span class="s">IP address      State      Holding time  Packets fwded  VPI  VCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">in_entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_cache</span><span class="p">;</span> <span class="n">in_entry</span><span class="p">;</span> <span class="n">in_entry</span> <span class="o">=</span> <span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ip_string</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">in_dst_ip</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s%s%-14lu%-12u&quot;</span><span class="p">,</span>
			   <span class="n">ip_string</span><span class="p">,</span>
			   <span class="n">ingress_state_string</span><span class="p">(</span><span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">entry_state</span><span class="p">),</span>
			   <span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">holding_time</span> <span class="o">-</span>
			   <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">),</span>
			   <span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">packets_fwded</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   %-3d  %-3d&quot;</span><span class="p">,</span>
				   <span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span>
				   <span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Egress Entries:</span><span class="se">\n</span><span class="s">Ingress MPC ATM addr</span><span class="se">\n</span><span class="s">Cache-id        State      Holding time  Packets recvd  Latest IP addr   VPI VCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">eg_entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_cache</span><span class="p">;</span> <span class="n">eg_entry</span><span class="p">;</span> <span class="n">eg_entry</span> <span class="o">=</span> <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">in_MPC_data_ATM_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATM_ESA_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%-16lu%s%-14lu%-15u&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ntohl</span><span class="p">(</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">cache_id</span><span class="p">),</span>
			   <span class="n">egress_state_string</span><span class="p">(</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">entry_state</span><span class="p">),</span>
			   <span class="p">(</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">holding_time</span> <span class="o">-</span>
			    <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)),</span>
			   <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">packets_rcvd</span><span class="p">);</span>

		<span class="cm">/* latest IP address */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ip_string</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">latest_ip_addr</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s&quot;</span><span class="p">,</span> <span class="n">ip_string</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %-3d %-3d&quot;</span><span class="p">,</span>
				   <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span>
				   <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">mpc_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span>	<span class="n">mpc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span> <span class="o">=</span>		<span class="n">mpc_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>		<span class="n">mpc_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span>		<span class="n">mpc_show</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_mpc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpc_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">proc_mpc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">len</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">buff</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_qos</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mpoa: proc_mpc_write: could not parse &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_qos</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* possible lines look like this</span>
<span class="cm">	 * add 130.230.54.142 tx=max_pcr,max_sdu rx=max_pcr,max_sdu</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tx_pcr</span><span class="p">,</span> <span class="n">tx_sdu</span><span class="p">,</span> <span class="n">rx_pcr</span><span class="p">,</span> <span class="n">rx_sdu</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ipaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_qos</span> <span class="n">qos</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_qos</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;del %hhu.%hhu.%hhu.%hhu&quot;</span><span class="p">,</span>
			<span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipaddr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">atm_mpoa_delete_qos</span><span class="p">(</span><span class="n">atm_mpoa_search_qos</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;add %hhu.%hhu.%hhu.%hhu tx=%d,%d rx=tx&quot;</span><span class="p">,</span>
			<span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_pcr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_sdu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_pcr</span> <span class="o">=</span> <span class="n">tx_pcr</span><span class="p">;</span>
		<span class="n">rx_sdu</span> <span class="o">=</span> <span class="n">tx_sdu</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;add %hhu.%hhu.%hhu.%hhu tx=%d,%d rx=%d,%d&quot;</span><span class="p">,</span>
		<span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">ip</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_pcr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_sdu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_pcr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_sdu</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipaddr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">;</span>
	<span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="n">ATM_CBR</span><span class="p">;</span>
	<span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">=</span> <span class="n">tx_pcr</span><span class="p">;</span>
	<span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">=</span> <span class="n">tx_sdu</span><span class="p">;</span>
	<span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="n">ATM_CBR</span><span class="p">;</span>
	<span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">=</span> <span class="n">rx_pcr</span><span class="p">;</span>
	<span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">=</span> <span class="n">rx_sdu</span><span class="p">;</span>
	<span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">=</span> <span class="n">ATM_AAL5</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;parse_qos(): setting qos paramameters to tx=%d,%d rx=%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> <span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span>
		<span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> <span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">);</span>

	<span class="n">atm_mpoa_add_qos</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qos</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * INITIALIZATION function - called when module is initialized/loaded.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mpc_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="n">STAT_FILE_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atm_proc_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpc_file_operations</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to initialize /proc/atm/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STAT_FILE_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DELETING function - called when module is removed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mpc_proc_clean</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">STAT_FILE_NAME</span><span class="p">,</span> <span class="n">atm_proc_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
