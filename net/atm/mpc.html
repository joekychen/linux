<!DOCTYPE html>
<html><head><title>joekychen/linux » net › atm › mpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;:%s: &quot; fmt, __func__</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cm">/* We are an ethernet device */</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;   </span><span class="cm">/* for ip_fast_csum() */</span><span class="cp"></span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>

<span class="cm">/* And atm device */</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/atmlec.h&gt;</span>
<span class="cp">#include &lt;linux/atmmpc.h&gt;</span>
<span class="cm">/* Modular too */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;lec.h&quot;</span>
<span class="cp">#include &quot;mpc.h&quot;</span>
<span class="cp">#include &quot;resources.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * mpc.c: Implementation of MPOA client kernel part</span>
<span class="cm"> */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define dprintk(format, args...) \</span>
<span class="c">	printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __func__, ##args)</span>
<span class="c">#define dprintk_cont(format, args...) printk(KERN_CONT format, ##args)</span>
<span class="cp">#else</span>
<span class="cp">#define dprintk(format, args...)					\</span>
<span class="cp">	do { if (0)							\</span>
<span class="cp">		printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __func__, ##args);\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define dprintk_cont(format, args...)			\</span>
<span class="cp">	do { if (0) printk(KERN_CONT format, ##args); } while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define ddprintk(format, args...) \</span>
<span class="c">	printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __func__, ##args)</span>
<span class="c">#define ddprintk_cont(format, args...) printk(KERN_CONT format, ##args)</span>
<span class="cp">#else</span>
<span class="cp">#define ddprintk(format, args...)					\</span>
<span class="cp">	do { if (0)							\</span>
<span class="cp">		printk(KERN_DEBUG &quot;mpoa:%s: &quot; format, __func__, ##args);\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define ddprintk_cont(format, args...)			\</span>
<span class="cp">	do { if (0) printk(KERN_CONT format, ##args); } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* mpc_daemon -&gt; kernel */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MPOA_trigger_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MPOA_res_reply_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ingress_purge_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">egress_purge_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mps_death</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clean_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">action</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MPOA_cache_impos_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_mpc_ctrl_addr_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_mps_mac_addr_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">copy_macs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">router_mac</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">tlvs</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">mps_macs</span><span class="p">,</span>
				<span class="kt">uint8_t</span> <span class="n">device_type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">purge_egress_shortcut</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">send_set_mps_ctrl_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpoad_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msg_from_mpoad</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">mpc_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpoa_event_listener</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">mpoa_notifier</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_timer_refresh</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_cache_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">checking_time</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_snap_hdr</span> <span class="n">llc_snap_mpoa_ctrl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">}</span>         <span class="cm">/* For MPOA control PDUs */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_snap_hdr</span> <span class="n">llc_snap_mpoa_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>         <span class="cm">/* This is for IP PDUs only */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">llc_snap_hdr</span> <span class="n">llc_snap_mpoa_data_tagged</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">}</span>         <span class="cm">/* This is for tagged data PDUs */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">mpoa_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">mpoa_event_listener</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpcs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">qos_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">mpc_timer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="nf">find_mpc_by_itfnum</span><span class="p">(</span><span class="kt">int</span> <span class="n">itf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpcs</span><span class="p">;</span>  <span class="cm">/* our global linked list */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev_num</span> <span class="o">==</span> <span class="n">itf</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mpc</span><span class="p">;</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>   <span class="cm">/* not found */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="nf">find_mpc_by_vcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpcs</span><span class="p">;</span>  <span class="cm">/* our global linked list */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span> <span class="o">==</span> <span class="n">vcc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mpc</span><span class="p">;</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>   <span class="cm">/* not found */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="nf">find_mpc_by_lec</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpcs</span><span class="p">;</span>  <span class="cm">/* our global linked list */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mpc</span><span class="p">;</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>   <span class="cm">/* not found */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions for managing QoS list</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Overwrites the old entry or makes a new one.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="nf">atm_mpoa_add_qos</span><span class="p">(</span><span class="n">__be32</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">atm_mpoa_search_qos</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">qos</span> <span class="o">=</span> <span class="o">*</span><span class="n">qos</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_mpoa_qos</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mpoa: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ipaddr</span> <span class="o">=</span> <span class="n">dst_ip</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">qos</span> <span class="o">=</span> <span class="o">*</span><span class="n">qos</span><span class="p">;</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">qos_head</span><span class="p">;</span>
	<span class="n">qos_head</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="nf">atm_mpoa_search_qos</span><span class="p">(</span><span class="n">__be32</span> <span class="n">dst_ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">;</span>

	<span class="n">qos</span> <span class="o">=</span> <span class="n">qos_head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">qos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">ipaddr</span> <span class="o">==</span> <span class="n">dst_ip</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">qos</span> <span class="o">=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">qos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns 0 for failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">atm_mpoa_delete_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">qos_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qos_head</span> <span class="o">=</span> <span class="n">qos_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">curr</span> <span class="o">=</span> <span class="n">qos_head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">curr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this is buggered - we need locking for qos_head */</span>
<span class="kt">void</span> <span class="nf">atm_mpoa_disp_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">;</span>

	<span class="n">qos</span> <span class="o">=</span> <span class="n">qos_head</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;QoS entries for shortcuts:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;IP address</span><span class="se">\n</span><span class="s">  TX:max_pcr pcr     min_pcr max_cdv max_sdu</span><span class="se">\n</span><span class="s">  RX:max_pcr pcr     min_pcr max_cdv max_sdu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">qos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">     %-7d %-7d %-7d %-7d %-7d</span><span class="se">\n</span><span class="s">     %-7d %-7d %-7d %-7d %-7d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">ipaddr</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_cdv</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">pcr</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_cdv</span><span class="p">,</span>
			   <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">);</span>
		<span class="n">qos</span> <span class="o">=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">find_lec_by_itfnum</span><span class="p">(</span><span class="kt">int</span> <span class="n">itf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;lec%d&quot;</span><span class="p">,</span> <span class="n">itf</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="nf">alloc_mpc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpoa_client</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">ingress_lock</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">mpcs</span><span class="p">;</span>
	<span class="n">atm_mpoa_init_cache</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>

	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p1</span> <span class="o">=</span> <span class="n">MPC_P1</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p2</span> <span class="o">=</span> <span class="n">MPC_P2</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p3</span><span class="p">));</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p4</span> <span class="o">=</span> <span class="n">MPC_P4</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p5</span> <span class="o">=</span> <span class="n">MPC_P5</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p6</span> <span class="o">=</span> <span class="n">MPC_P6</span><span class="p">;</span>

	<span class="n">mpcs</span> <span class="o">=</span> <span class="n">mpc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mpc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * start_mpc() puts the MPC on line. All the packets destined</span>
<span class="cm"> * to the lec underneath us are now being monitored and</span>
<span class="cm"> * shortcuts will be established.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_mpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) not starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">old_ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">new_ops</span> <span class="o">=</span> <span class="o">*</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">old_ops</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">new_ops</span><span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">mpc_send_packet</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">new_ops</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_mpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s)&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Lets not nullify lec device&#39;s dev-&gt;hard_start_xmit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">new_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot; mpc already stopped, not fatal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">old_ops</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">old_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* close_shortcuts(mpc);    ??? FIXME */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mpoa_device_type_string</span><span class="p">(</span><span class="kt">char</span> <span class="n">type</span><span class="p">)</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">));</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mpoa_device_type_string</span><span class="p">(</span><span class="kt">char</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NON_MPOA</span>:
		<span class="k">return</span> <span class="s">&quot;non-MPOA device&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPS</span>:
		<span class="k">return</span> <span class="s">&quot;MPS&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPC</span>:
		<span class="k">return</span> <span class="s">&quot;MPC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPS_AND_MPC</span>:
		<span class="k">return</span> <span class="s">&quot;both MPS and MPC&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;unspecified (non-MPOA) device&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lec device calls this via its netdev_priv(dev)-&gt;lane2_ops</span>
<span class="cm"> * -&gt;associate_indicator() when it sees a TLV in LE_ARP packet.</span>
<span class="cm"> * We fill in the pointer above when we see a LANE2 lec initializing</span>
<span class="cm"> * See LANE2 spec 3.1.5</span>
<span class="cm"> *</span>
<span class="cm"> * Quite a big and ugly function but when you look at it</span>
<span class="cm"> * all it does is to try to locate and parse MPOA Device</span>
<span class="cm"> * Type TLV.</span>
<span class="cm"> * We give our lec a pointer to this function and when the</span>
<span class="cm"> * lec sees a TLV it uses the pointer to call this function.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lane2_assoc_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tlvs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sizeoftlvs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">length</span><span class="p">,</span> <span class="n">mpoa_device_type</span><span class="p">,</span> <span class="n">number_of_mps_macs</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">end_of_tlvs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>

	<span class="n">mpoa_device_type</span> <span class="o">=</span> <span class="n">number_of_mps_macs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* silence gcc */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) received TLV(s), &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;total length of all TLVs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sizeoftlvs</span><span class="p">);</span>
	<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_lec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* Sampo-Fix: moved here from below */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) no mpc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">end_of_tlvs</span> <span class="o">=</span> <span class="n">tlvs</span> <span class="o">+</span> <span class="n">sizeoftlvs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">end_of_tlvs</span> <span class="o">-</span> <span class="n">tlvs</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="p">((</span><span class="n">tlvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tlvs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">tlvs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tlvs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">tlvs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">tlvs</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;    type 0x%x length %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tlvs</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">end_of_tlvs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;TLV value extends past its buffer, aborting parse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mpoa: (%s) TLV type was 0, returning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TLV_MPOA_DEVICE_TYPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlvs</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>  <span class="cm">/* skip other TLVs */</span>
		<span class="p">}</span>
		<span class="n">mpoa_device_type</span> <span class="o">=</span> <span class="o">*</span><span class="n">tlvs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">number_of_mps_macs</span> <span class="o">=</span> <span class="o">*</span><span class="n">tlvs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) MPOA device type &#39;%s&#39;, &quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpoa_device_type_string</span><span class="p">(</span><span class="n">mpoa_device_type</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpoa_device_type</span> <span class="o">==</span> <span class="n">MPS_AND_MPC</span> <span class="o">&amp;&amp;</span>
		    <span class="n">length</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">42</span> <span class="o">+</span> <span class="n">number_of_mps_macs</span><span class="o">*</span><span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* :) */</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) short MPOA Device Type TLV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mpoa_device_type</span> <span class="o">==</span> <span class="n">MPS</span> <span class="o">||</span> <span class="n">mpoa_device_type</span> <span class="o">==</span> <span class="n">MPC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">22</span> <span class="o">+</span> <span class="n">number_of_mps_macs</span><span class="o">*</span><span class="n">ETH_ALEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) short MPOA Device Type TLV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpoa_device_type</span> <span class="o">!=</span> <span class="n">MPS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mpoa_device_type</span> <span class="o">!=</span> <span class="n">MPS_AND_MPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ignoring non-MPS device &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpoa_device_type</span> <span class="o">==</span> <span class="n">MPC</span><span class="p">)</span>
				<span class="n">tlvs</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>  <span class="cm">/* we are only interested in MPSs */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">number_of_mps_macs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mpoa_device_type</span> <span class="o">==</span> <span class="n">MPS_AND_MPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) MPS_AND_MPC has zero MACs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>  <span class="cm">/* someone should read the spec */</span>
		<span class="p">}</span>
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;this MPS has %d MAC addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">number_of_mps_macs</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * ok, now we can go and tell our daemon</span>
<span class="cm">		 * the control address of MPS</span>
<span class="cm">		 */</span>
		<span class="n">send_set_mps_ctrl_addr</span><span class="p">(</span><span class="n">tlvs</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>

		<span class="n">tlvs</span> <span class="o">=</span> <span class="n">copy_macs</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">tlvs</span><span class="p">,</span>
				 <span class="n">number_of_mps_macs</span><span class="p">,</span> <span class="n">mpoa_device_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tlvs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end_of_tlvs</span> <span class="o">-</span> <span class="n">tlvs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) ignoring %Zd bytes of trailing TLV garbage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">end_of_tlvs</span> <span class="o">-</span> <span class="n">tlvs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Store at least advertizing router&#39;s MAC address</span>
<span class="cm"> * plus the possible MAC address(es) to mpc-&gt;mps_macs.</span>
<span class="cm"> * For a freshly allocated MPOA client mpc-&gt;mps_macs == 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="nf">copy_macs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">router_mac</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">tlvs</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">mps_macs</span><span class="p">,</span>
				<span class="kt">uint8_t</span> <span class="n">device_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_macs</span><span class="p">;</span>
	<span class="n">num_macs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mps_macs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">mps_macs</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span> <span class="o">!=</span> <span class="n">num_macs</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* need to reallocate? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_macs</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_macs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">num_macs</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_macs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) out of mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_macs</span><span class="p">,</span> <span class="n">router_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">tlvs</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">MPS_AND_MPC</span><span class="p">)</span> <span class="n">tlvs</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mps_macs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_macs</span><span class="p">,</span> <span class="n">tlvs</span><span class="p">,</span> <span class="n">mps_macs</span><span class="o">*</span><span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">tlvs</span> <span class="o">+=</span> <span class="n">mps_macs</span><span class="o">*</span><span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span> <span class="o">=</span> <span class="n">num_macs</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tlvs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_via_shortcut</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ipaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">llc_snap_hdr</span> <span class="n">hdr</span><span class="p">;</span>
		<span class="n">__be32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">tagged_llc_snap_hdr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">}},</span>
		<span class="mi">0</span>
	<span class="p">};</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>
	<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buff</span><span class="p">;</span>
	<span class="n">ipaddr</span> <span class="o">=</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>

	<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s) ipaddr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">add_entry</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* threshold not exceeded or VCC not ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">cache_hit</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">mpc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s) cache_hit: returns != OPEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s) using shortcut</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* MPOA spec A.1.4, MPOA client must decrement IP ttl at least by one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s) IP ttl = %u, using LANE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="o">--</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="n">ip_fast_csum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s) adding tag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span>
		<span class="n">tagged_llc_snap_hdr</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">tag</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>	<span class="cm">/* get rid of Eth header */</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tagged_llc_snap_hdr</span><span class="p">));</span>
						<span class="cm">/* add LLC/SNAP header   */</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tagged_llc_snap_hdr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">tagged_llc_snap_hdr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>	<span class="cm">/* get rid of Eth header */</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_snap_hdr</span><span class="p">));</span>
						<span class="cm">/* add LLC/SNAP header + tag  */</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc_snap_mpoa_data</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_snap_hdr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">);</span>
	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">atm_options</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">atm_options</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">packets_fwded</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Probably needs some error checks and locking, not sure...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">mpc_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_lec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* this should NEVER fail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) no MPC found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">non_ip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">non_ip</span><span class="p">;</span> <span class="cm">/* Multi-Protocol Over ATM :-) */</span>

	<span class="cm">/* Weed out funny packets (e.g., AF_PACKET or raw). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">non_ip</span><span class="p">;</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">non_ip</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_macs</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">send_via_shortcut</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mpc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* try shortcut */</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">non_ip:</span>
	<span class="k">return</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">old_ops</span><span class="o">-&gt;</span><span class="n">ndo_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atm_mpoa_vcc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes_left</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmmpc_ioc</span> <span class="n">ioc_data</span><span class="p">;</span>
	<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">in_entry</span><span class="p">;</span>
	<span class="n">__be32</span>  <span class="n">ipaddr</span><span class="p">;</span>

	<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc_data</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmmpc_ioc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes_left</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mpoa:Short read (missed %d bytes) from userland</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bytes_left</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipaddr</span> <span class="o">=</span> <span class="n">ioc_data</span><span class="p">.</span><span class="n">ipaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_data</span><span class="p">.</span><span class="n">dev_num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ioc_data</span><span class="p">.</span><span class="n">dev_num</span> <span class="o">&gt;=</span> <span class="n">MAX_LEC_ITF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_itfnum</span><span class="p">(</span><span class="n">ioc_data</span><span class="p">.</span><span class="n">dev_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_data</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">MPC_SOCKET_INGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_entry</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">&lt;</span> <span class="n">INGRESS_RESOLVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) did not find RESOLVED entry from ingress cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">in_entry</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) attaching ingress SVC, entry = %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">in_dst_ip</span><span class="p">);</span>
		<span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">in_entry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) attaching egress SVC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">proto_data</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span> <span class="o">=</span> <span class="n">mpc_push</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_vcc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">in_entry</span><span class="p">;</span>
	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">eg_entry</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_lec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) close for unknown MPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">in_entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">get_by_vcc</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) ingress SVC closed ip = %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">in_dst_ip</span><span class="p">);</span>
		<span class="n">in_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">in_entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">eg_entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">get_by_vcc</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eg_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) egress SVC closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">eg_entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_entry</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">eg_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) unused vcc closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">proto_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">eg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) null skb, closing VCC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mpc_vcc_close</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc_snap_mpoa_ctrl</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_snap_hdr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) control packet arrived</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* Pass control packets to daemon */</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* data coming over the shortcut */</span>
	<span class="n">atm_return</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_lec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) unknown MPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc_snap_mpoa_data_tagged</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_snap_hdr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* MPOA tagged data */</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s) tagged data packet arrived</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llc_snap_mpoa_data</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_snap_hdr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* MPOA data */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) Unsupported non-tagged data packet arrived.  Purging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) garbage arrived, purging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_snap_hdr</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">eg</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">get_by_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mpoa: (%s) Didn&#39;t find egress cache entry, tag = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">purge_egress_shortcut</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if ingress MPC is using shortcut we opened as a return channel.</span>
<span class="cm">	 * This means we have a bi-directional vcc opened by us.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eg</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eg</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) egress SVC in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">llc_snap_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tag</span><span class="p">));</span>
					<span class="cm">/* get rid of LLC/SNAP header */</span>
	<span class="n">new_skb</span> <span class="o">=</span> <span class="n">skb_realloc_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">eg</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">DH_length</span><span class="p">);</span>
					<span class="cm">/* LLC/SNAP is shorter than MAC header :( */</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">eg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">eg</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">DH_length</span><span class="p">);</span>     <span class="cm">/* add MAC header */</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">eg</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">DLL_header</span><span class="p">,</span>
				<span class="n">eg</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">DH_length</span><span class="p">);</span>
	<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>

	<span class="n">eg</span><span class="o">-&gt;</span><span class="n">latest_ip_addr</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">new_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">eg</span><span class="o">-&gt;</span><span class="n">packets_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">eg</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">new_skb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_skb_data</span><span class="p">));</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">mpc_ops</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* only send is required */</span>
	<span class="p">.</span><span class="n">close</span>	<span class="o">=</span> <span class="n">mpoad_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span>	<span class="o">=</span> <span class="n">msg_from_mpoad</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atm_dev</span> <span class="n">mpc_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="s">&quot;mpc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">number</span>	<span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span>	<span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">mpc_dev</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
	<span class="cm">/* members not explicitly initialised will be 0 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atm_mpoa_mpoad_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lec_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpcs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc_timer</span><span class="p">);</span>
		<span class="n">mpc_timer_refresh</span><span class="p">();</span>

		<span class="cm">/* This lets us now how our LECs are doing */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpoa_notifier</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc_timer</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_itfnum</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;allocating new mpc for itf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">alloc_mpc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev_num</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">find_lec_by_itfnum</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
					<span class="cm">/* NULL if there was no lec */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mpoad is already present for itf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* check if the lec is LANE2 capable */</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane_version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane2_ops</span><span class="o">-&gt;</span><span class="n">associate_indicator</span> <span class="o">=</span> <span class="n">lane2_assoc_ind</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc_dev</span><span class="p">;</span>
	<span class="n">vcc_insert_socket</span><span class="p">(</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">));</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_META</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">empty</span><span class="p">[</span><span class="n">ATM_ESA_LEN</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">empty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATM_ESA_LEN</span><span class="p">);</span>

		<span class="n">start_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* set address if mpcd e.g. gets killed and restarted.</span>
<span class="cm">		 * If we do not do it now we have to wait for the next LE_ARP</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_ctrl_addr</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> <span class="n">ATM_ESA_LEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_set_mps_ctrl_addr</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_ctrl_addr</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_set_mps_ctrl_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">k_message</span> <span class="n">mesg</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_ctrl_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ATM_ESA_LEN</span><span class="p">);</span>

	<span class="n">mesg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SET_MPS_CTRL_ADDR</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">MPS_ctrl</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ATM_ESA_LEN</span><span class="p">);</span>
	<span class="n">msg_to_mpoad</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpoad_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_vcc</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;did not find MPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;close for non-present mpoad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lec_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane2_ops</span><span class="o">-&gt;</span><span class="n">associate_indicator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">stop_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">destroy_cache</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">destroy_cache</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">atm_return</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) going down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">msg_from_mpoad</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_vcc</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">mesg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;no mpc found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s)&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">?</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mesg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPOA_RES_REPLY_RCVD</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;mpoa_res_reply_rcvd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">MPOA_res_reply_rcvd</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPOA_TRIGGER_RCVD</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;mpoa_trigger_rcvd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">MPOA_trigger_rcvd</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INGRESS_PURGE_RCVD</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;nhrp_purge_rcvd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ingress_purge_rcvd</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EGRESS_PURGE_RCVD</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;egress_purge_reply_rcvd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">egress_purge_rcvd</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPS_DEATH</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;mps_death</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mps_death</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CACHE_IMPOS_RCVD</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;cache_impos_rcvd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">MPOA_cache_impos_rcvd</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_MPC_CTRL_ADDR</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;set_mpc_ctrl_addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_mpc_ctrl_addr_rcvd</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_MPS_MAC_ADDR</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;set_mps_mac_addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_mps_mac_addr_rcvd</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLEAN_UP_AND_EXIT</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;clean_up_and_exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clean_up</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">DIE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RELOAD</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;reload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clean_up</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">RELOAD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_MPC_PARAMS</span>:
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;set_mpc_params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">mesg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">params</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;unknown message %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mesg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remember that this function may not do things that sleep */</span>
<span class="kt">int</span> <span class="nf">msg_to_mpoad</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mesg %d to a non-existent mpoad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mesg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span><span class="p">));</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mesg</span><span class="p">));</span>
	<span class="n">atm_force_charge</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_atm</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpoa_event_listener</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">mpoa_notifier</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lec_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;lec&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span> <span class="cm">/* we are only interested in lec:s */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_REGISTER</span>:       <span class="cm">/* a new lec device was allocated */</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane_version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane2_ops</span><span class="o">-&gt;</span><span class="n">associate_indicator</span> <span class="o">=</span> <span class="n">lane2_assoc_ind</span><span class="p">;</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_itfnum</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">itfnum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;allocating new mpc for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">mpc</span> <span class="o">=</span> <span class="n">alloc_mpc</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;no new mpc&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev_num</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">itfnum</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">dev_hold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) was initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_UNREGISTER</span>:
		<span class="cm">/* the lec device was deallocated */</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_lec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;device (%s) was deallocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">stop_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="cm">/* the dev was ifconfig&#39;ed up */</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_lec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">start_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="cm">/* the dev was ifconfig&#39;ed down */</span>
		<span class="cm">/* this means that the flow of packets from the</span>
<span class="cm">		 * upper layer stops</span>
<span class="cm">		 */</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">find_mpc_by_lec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mpoad_vcc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">stop_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_REBOOT</span>:
	<span class="k">case</span> <span class="n">NETDEV_CHANGE</span>:
	<span class="k">case</span> <span class="n">NETDEV_CHANGEMTU</span>:
	<span class="k">case</span> <span class="n">NETDEV_CHANGEADDR</span>:
	<span class="k">case</span> <span class="n">NETDEV_GOING_DOWN</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions which are called after a message is received from mpcd.</span>
<span class="cm"> * Msg is reused on purpose.</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">MPOA_trigger_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">dst_ip</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">in_info</span><span class="p">.</span><span class="n">in_dst_ip</span><span class="p">;</span>
	<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">add_entry</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">=</span> <span class="n">INGRESS_RESOLVING</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SND_MPOA_RES_RQST</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">in_info</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">;</span>
		<span class="n">msg_to_mpoad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">reply_wait</span><span class="p">));</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">==</span> <span class="n">INGRESS_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">=</span> <span class="n">INGRESS_RESOLVING</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SND_MPOA_RES_RQST</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">in_info</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">;</span>
		<span class="n">msg_to_mpoad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">reply_wait</span><span class="p">));</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) entry already in resolving state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">);</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Things get complicated because we have to check if there&#39;s an egress</span>
<span class="cm"> * shortcut with suitable traffic parameters we could use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_qos_and_open_shortcut</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">dst_ip</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">in_info</span><span class="p">.</span><span class="n">in_dst_ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">qos</span> <span class="o">=</span> <span class="n">atm_mpoa_search_qos</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">);</span>
	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">eg_entry</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">get_by_src_ip</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eg_entry</span> <span class="o">&amp;&amp;</span> <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">&amp;</span>
		    <span class="n">msg</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">qos</span> <span class="o">?</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">:</span> <span class="n">ATM_UBR</span> <span class="o">|</span> <span class="n">ATM_CBR</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_UBR</span><span class="p">)</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">eg_entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) using egress SVC to reach %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_ip</span><span class="p">);</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">eg_entry</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eg_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">eg_entry</span><span class="p">);</span>

	<span class="cm">/* No luck in the egress cache we must open an ingress SVC */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OPEN_INGRESS_SVC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">qos</span> <span class="o">=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) trying to get a CBR shortcut</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_qos</span><span class="p">));</span>
	<span class="n">msg_to_mpoad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MPOA_res_reply_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">dst_ip</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">in_info</span><span class="p">.</span><span class="n">in_dst_ip</span><span class="p">;</span>
	<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) ip %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_ip</span><span class="p">);</span>
	<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;(%s) entry = %p&quot;</span><span class="p">,</span>
		 <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) ARGH, received res. reply for an entry that doesn&#39;t exist.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ddprintk_cont</span><span class="p">(</span><span class="s">&quot; entry_state = %d &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">==</span> <span class="n">INGRESS_RESOLVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) RESOLVED entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">in_info</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">tv</span><span class="p">));</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">reply_wait</span><span class="p">));</span> <span class="cm">/* Used in refreshing func from now on */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">refresh_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ddprintk_cont</span><span class="p">(</span><span class="s">&quot;entry-&gt;shortcut = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">==</span> <span class="n">INGRESS_RESOLVING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">=</span> <span class="n">INGRESS_RESOLVED</span><span class="p">;</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Shortcut already open... */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) entry-&gt;shortcut != NULL, impossible!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">check_qos_and_open_shortcut</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_state</span> <span class="o">=</span> <span class="n">INGRESS_RESOLVED</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ingress_purge_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">dst_ip</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">in_info</span><span class="p">.</span><span class="n">in_dst_ip</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">ip_mask</span><span class="p">;</span>
	<span class="n">in_cache_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">get_with_mask</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) purge for a non-existing entry, ip = %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_ip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) removing an ingress entry, ip = %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_ip</span><span class="p">);</span>
		<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">ingress_lock</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">remove_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">ingress_lock</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">get_with_mask</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">egress_purge_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">cache_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">eg_info</span><span class="p">.</span><span class="n">cache_id</span><span class="p">;</span>
	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">get_by_cache_id</span><span class="p">(</span><span class="n">cache_id</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) purge for a non-existing entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">remove_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>

	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">purge_egress_shortcut</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">purge_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;entering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;vcc == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span><span class="p">));</span>
	<span class="n">purge_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">purge_msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DATA_PLANE_PURGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">purge_msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">eg_info</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">;</span>

	<span class="n">atm_force_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Our MPS died. Tell our daemon to send NHRP data plane purge to each</span>
<span class="cm"> * of the egress shortcuts we have.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mps_death</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">MPS_ctrl</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_ctrl_addr</span><span class="p">,</span> <span class="n">ATM_ESA_LEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) wrong MPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: This knows too much of the cache structure */</span>
	<span class="n">read_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_cache</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">purge_egress_shortcut</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">shortcut</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>

	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">destroy_cache</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">destroy_cache</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MPOA_cache_impos_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">holding_time</span><span class="p">;</span>
	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">get_by_cache_id</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">eg_info</span><span class="p">.</span><span class="n">cache_id</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>

	<span class="n">holding_time</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">eg_info</span><span class="p">.</span><span class="n">holding_time</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) entry = %p, holding_time = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">holding_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">holding_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">add_entry</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">holding_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">holding_time</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">remove_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>

	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_mpc_ctrl_addr_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lec_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="p">;</span>

	<span class="kt">uint8_t</span> <span class="n">tlv</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ATM_ESA_LEN</span><span class="p">];</span>

	<span class="n">tlv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mo">00</span><span class="p">;</span> <span class="n">tlv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span> <span class="n">tlv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3e</span><span class="p">;</span> <span class="n">tlv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">;</span> <span class="cm">/* type  */</span>
	<span class="n">tlv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ATM_ESA_LEN</span><span class="p">;</span>  <span class="cm">/* length                           */</span>
	<span class="n">tlv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>                 <span class="cm">/* MPOA client                      */</span>
	<span class="n">tlv</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>                 <span class="cm">/* number of MPS MAC addresses      */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlv</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">mesg</span><span class="o">-&gt;</span><span class="n">MPS_ctrl</span><span class="p">,</span> <span class="n">ATM_ESA_LEN</span><span class="p">);</span> <span class="cm">/* MPC ctrl ATM addr */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">our_ctrl_addr</span><span class="p">,</span> <span class="n">mesg</span><span class="o">-&gt;</span><span class="n">MPS_ctrl</span><span class="p">,</span> <span class="n">ATM_ESA_LEN</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;(%s) setting MPC ctrl ATM address to&quot;</span><span class="p">,</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">?</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tlv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">tlv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane2_ops</span><span class="o">-&gt;</span><span class="n">associate_req</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
							<span class="n">tlv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tlv</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) MPOA device type TLV association failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane2_ops</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;(%s) targetless LE_ARP request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_mps_mac_addr_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">mps_macs</span><span class="p">);</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">mps_macs</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">MPS_ctrl</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">mps_macs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">number_of_mps_macs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * purge egress cache and tell daemon to &#39;action&#39; (DIE, RELOAD)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clean_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">k_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">eg_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SND_EGRESS_PURGE</span><span class="p">;</span>


	<span class="cm">/* FIXME: This knows too much of the cache structure */</span>
	<span class="n">read_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_cache</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">.</span><span class="n">eg_info</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;cache_id %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ctrl_info</span><span class="p">.</span><span class="n">cache_id</span><span class="p">);</span>
		<span class="n">msg_to_mpoad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">egress_lock</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">msg_to_mpoad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_timer_refresh</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">MPC_P2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">mpc_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mpc_timer</span><span class="p">.</span><span class="n">expires</span><span class="p">;</span>
	<span class="n">mpc_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">mpc_cache_check</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_cache_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">checking_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span> <span class="o">=</span> <span class="n">mpcs</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">previous_resolving_check_time</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">previous_refresh_time</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">clear_count</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">clear_expired</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checking_time</span> <span class="o">-</span> <span class="n">previous_resolving_check_time</span> <span class="o">&gt;</span>
		    <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p4</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">check_resolving</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
			<span class="n">previous_resolving_check_time</span> <span class="o">=</span> <span class="n">checking_time</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checking_time</span> <span class="o">-</span> <span class="n">previous_refresh_time</span> <span class="o">&gt;</span>
		    <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">mpc_p5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">refresh</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
			<span class="n">previous_refresh_time</span> <span class="o">=</span> <span class="n">checking_time</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpc_timer_refresh</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atm_mpoa_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SD</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">ATMMPC_CTRL</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">ATMMPC_DATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATMMPC_CTRL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">atm_mpoa_mpoad_attach</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATMMPC_DATA</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">atm_mpoa_vcc_attach</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atm_ioctl</span> <span class="n">atm_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>	<span class="o">=</span> <span class="n">atm_mpoa_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">atm_mpoa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_atm_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_ioctl_ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc_proc_init</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;failed to initialize /proc/mpoa</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mpc.c: initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">atm_mpoa_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpoa_client</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_mpoa_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="o">*</span><span class="n">nextqos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lec_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mpc_proc_clean</span><span class="p">();</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc_timer</span><span class="p">);</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpoa_notifier</span><span class="p">);</span>
	<span class="n">deregister_atm_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_ioctl_ops</span><span class="p">);</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpcs</span><span class="p">;</span>
	<span class="n">mpcs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mpc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stop_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane2_ops</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lane2_ops</span><span class="o">-&gt;</span><span class="n">associate_indicator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;about to clear caches</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">in_ops</span><span class="o">-&gt;</span><span class="n">destroy_cache</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">eg_ops</span><span class="o">-&gt;</span><span class="n">destroy_cache</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;caches cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">mps_macs</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpoa_client</span><span class="p">));</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;about to kfree %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>
		<span class="n">ddprintk</span><span class="p">(</span><span class="s">&quot;next mpc is at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qos</span> <span class="o">=</span> <span class="n">qos_head</span><span class="p">;</span>
	<span class="n">qos_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">qos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextqos</span> <span class="o">=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;freeing qos entry %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qos</span><span class="p">);</span>
		<span class="n">qos</span> <span class="o">=</span> <span class="n">nextqos</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">atm_mpoa_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">atm_mpoa_cleanup</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
