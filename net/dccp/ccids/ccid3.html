<!DOCTYPE html>
<html><head><title>joekychen/linux » net › dccp › ccids › ccid3.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ccid3.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) 2007   The University of Aberdeen, Scotland, UK</span>
<span class="cm"> *  Copyright (c) 2005-7 The University of Waikato, Hamilton, New Zealand.</span>
<span class="cm"> *  Copyright (c) 2005-7 Ian McDonald &lt;ian.mcdonald@jandi.co.nz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  An implementation of the DCCP protocol</span>
<span class="cm"> *</span>
<span class="cm"> *  This code has been developed by the University of Waikato WAND</span>
<span class="cm"> *  research group. For further information please see http://www.wand.net.nz/</span>
<span class="cm"> *</span>
<span class="cm"> *  This code also uses code from Lulea University, rereleased as GPL by its</span>
<span class="cm"> *  authors:</span>
<span class="cm"> *  Copyright (c) 2003 Nils-Erik Mattsson, Joacim Haggmark, Magnus Erixzon</span>
<span class="cm"> *</span>
<span class="cm"> *  Changes to meet Linux coding standards, to make it meet latest ccid3 draft</span>
<span class="cm"> *  and to make it work as a loadable module in the DCCP stack written by</span>
<span class="cm"> *  Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2005 Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;../dccp.h&quot;</span>
<span class="cp">#include &quot;ccid3.h&quot;</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#ifdef CONFIG_IP_DCCP_CCID3_DEBUG</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ccid3_debug</span><span class="p">;</span>
<span class="cp">#define ccid3_pr_debug(format, a...)	DCCP_PR_DEBUG(ccid3_debug, format, ##a)</span>
<span class="cp">#else</span>
<span class="cp">#define ccid3_pr_debug(format, a...)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	Transmitter Half-Connection Routines</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_IP_DCCP_CCID3_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ccid3_tx_state_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">ccid3_hc_tx_states</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ccid3_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TFRC_SSTATE_NO_SENT</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;NO_SENT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TFRC_SSTATE_NO_FBACK</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NO_FBACK&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TFRC_SSTATE_FBACK</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;FBACK&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">ccid3_state_names</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ccid3_hc_tx_states</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ccid3_hc_tx_states</span> <span class="n">oldstate</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">;</span>

	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p) %-8.8s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ccid3_tx_state_name</span><span class="p">(</span><span class="n">oldstate</span><span class="p">),</span>
		       <span class="n">ccid3_tx_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">oldstate</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute the initial sending rate X_init in the manner of RFC 3390:</span>
<span class="cm"> *</span>
<span class="cm"> *	X_init  =  min(4 * s, max(2 * s, 4380 bytes)) / RTT</span>
<span class="cm"> *</span>
<span class="cm"> * Note that RFC 3390 uses MSS, RFC 4342 refers to RFC 3390, and rfc3448bis</span>
<span class="cm"> * (rev-02) clarifies the use of RFC 3390 with regard to the above formula.</span>
<span class="cm"> * For consistency with other parts of the code, X_init is scaled by 2^6.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">rfc3390_initial_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__u32</span> <span class="n">w_init</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">__u32</span><span class="p">,</span> <span class="mi">4380U</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scaled_div</span><span class="p">(</span><span class="n">w_init</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ccid3_update_send_interval  -  Calculate new t_ipi = s / X_inst</span>
<span class="cm"> * This respects the granularity of X_inst (64 * bytes/second).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_update_send_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ipi</span> <span class="o">=</span> <span class="n">scaled_div32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span><span class="p">);</span>

	<span class="n">DCCP_BUG_ON</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ipi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;t_ipi=%u, s=%u, X=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ipi</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ccid3_hc_tx_idle_rtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">ktime_us_delta</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_last_win_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ccid3_hc_tx_update_x  -  Update allowed sending rate X</span>
<span class="cm"> * @stamp: most recent time if available - can be left NULL.</span>
<span class="cm"> * This function tracks draft rfc3448bis, check there for latest details.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: X and X_recv are both stored in units of 64 * bytes/second, to support</span>
<span class="cm"> *       fine-grained resolution of sending rates. This requires scaling by 2^6</span>
<span class="cm"> *       throughout the code. Only X_calc is unscaled (in bytes/second).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_update_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="o">*</span><span class="n">stamp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__u64</span> <span class="n">min_rate</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__u64</span> <span class="n">old_x</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">stamp</span> <span class="o">?</span> <span class="o">*</span><span class="n">stamp</span> <span class="o">:</span> <span class="n">ktime_get_real</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle IDLE periods: do not reduce below RFC3390 initial sending rate</span>
<span class="cm">	 * when idling [RFC 4342, 5.1]. Definition of idling is from rfc3448bis:</span>
<span class="cm">	 * a sender is idle if it has not sent anything over a 2-RTT-period.</span>
<span class="cm">	 * For consistency with X and X_recv, min_rate is also scaled by 2^6.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccid3_hc_tx_idle_rtt</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">min_rate</span> <span class="o">=</span> <span class="n">rfc3390_initial_rate</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">min_rate</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">min_rate</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">=</span> <span class="n">min</span><span class="p">(((</span><span class="n">__u64</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_calc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">min_rate</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span><span class="p">,</span> <span class="p">(((</span><span class="n">__u64</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">TFRC_T_MBI</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ktime_us_delta</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ld</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span><span class="p">,</span> <span class="n">min_rate</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span><span class="p">,</span>
			       <span class="n">scaled_div</span><span class="p">(((</span><span class="n">__u64</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">));</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ld</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">!=</span> <span class="n">old_x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;X_prev=%u, X_now=%u, X_calc=%u, &quot;</span>
			       <span class="s">&quot;X_recv=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">old_x</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">),</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">),</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_calc</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>

		<span class="n">ccid3_update_send_interval</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Track the mean packet size `s&#39; (cf. RFC 4342, 5.3 and  RFC 3448, 4.1)</span>
<span class="cm"> *	@len: DCCP packet payload size in bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_update_s</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">old_s</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">;</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span> <span class="o">=</span> <span class="n">tfrc_ewma</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span> <span class="o">!=</span> <span class="n">old_s</span><span class="p">)</span>
		<span class="n">ccid3_update_send_interval</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Update Window Counter using the algorithm from [RFC 4342, 8.1].</span>
<span class="cm"> *	As elsewhere, RTT &gt; 0 is assumed by using dccp_sample_rtt().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_update_win_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span>
						<span class="n">ktime_t</span> <span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">ktime_us_delta</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_last_win_count</span><span class="p">),</span>
	    <span class="n">quarter_rtts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">delta</span><span class="p">)</span> <span class="o">/</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quarter_rtts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_last_win_count</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_last_win_count</span>  <span class="o">+=</span> <span class="n">min</span><span class="p">(</span><span class="n">quarter_rtts</span><span class="p">,</span> <span class="mi">5U</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_last_win_count</span>  <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>		<span class="cm">/* mod 16 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_no_feedback_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t_nfb</span> <span class="o">=</span> <span class="n">USEC_PER_SEC</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">bh_lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Try again later. */</span>
		<span class="cm">/* XXX: set some sensible MIB */</span>
		<span class="k">goto</span> <span class="n">restart_timer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p, state=%s) - entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span>
		       <span class="n">ccid3_tx_state_name</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">));</span>

	<span class="cm">/* Ignore and do not restart after leaving the established state */</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DCCPF_OPEN</span> <span class="o">|</span> <span class="n">DCCPF_PARTOPEN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Reset feedback state to &quot;no feedback received&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TFRC_SSTATE_FBACK</span><span class="p">)</span>
		<span class="n">ccid3_hc_tx_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">TFRC_SSTATE_NO_FBACK</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine new allowed sending rate X as per draft rfc3448bis-00, 4.4</span>
<span class="cm">	 * RTO is 0 if and only if no feedback has been received yet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* halve send rate directly */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="p">(((</span><span class="n">__u64</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">TFRC_T_MBI</span><span class="p">);</span>
		<span class="n">ccid3_update_send_interval</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Modify the cached value of X_recv</span>
<span class="cm">		 *</span>
<span class="cm">		 *  If (X_calc &gt; 2 * X_recv)</span>
<span class="cm">		 *    X_recv = max(X_recv / 2, s / (2 * t_mbi));</span>
<span class="cm">		 *  Else</span>
<span class="cm">		 *    X_recv = X_calc / 4;</span>
<span class="cm">		 *</span>
<span class="cm">		 *  Note that X_recv is scaled by 2^6 while X_calc is not</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_calc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">=</span>
				<span class="n">max</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
				    <span class="p">(((</span><span class="n">__u64</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">TFRC_T_MBI</span><span class="p">));</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_calc</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ccid3_hc_tx_update_x</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;Reduced X to %llu/64 bytes/sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set new timeout for the nofeedback timer.</span>
<span class="cm">	 * See comments in packet_recv() regarding the value of t_RTO.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>	<span class="cm">/* no feedback received yet */</span>
		<span class="n">t_nfb</span> <span class="o">=</span> <span class="n">TFRC_INITIAL_TIMEOUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">t_nfb</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ipi</span><span class="p">);</span>

<span class="nl">restart_timer:</span>
	<span class="n">sk_reset_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_no_feedback_timer</span><span class="p">,</span>
			   <span class="n">jiffies</span> <span class="o">+</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">t_nfb</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ccid3_hc_tx_send_packet  -  Delay-based dequeueing of TX packets</span>
<span class="cm"> * @skb: next packet candidate to send on @sk</span>
<span class="cm"> * This function uses the convention of ccid_packet_dequeue_eval() and</span>
<span class="cm"> * returns a millisecond-delay value between 0 and t_mbi = 64000 msec.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccid3_hc_tx_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">ktime_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">ktime_get_real</span><span class="p">();</span>
	<span class="n">s64</span> <span class="n">delay</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This function is called only for Data and DataAck packets. Sending</span>
<span class="cm">	 * zero-sized Data(Ack)s is theoretically possible, but for congestion</span>
<span class="cm">	 * control this case is pathological - ignore it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TFRC_SSTATE_NO_SENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk_reset_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_no_feedback_timer</span><span class="p">,</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span>
			       <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">TFRC_INITIAL_TIMEOUT</span><span class="p">)));</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_last_win_count</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_last_win_count</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

		<span class="cm">/* Set t_0 for initial packet */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_nom</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use initial RTT sample when available: recommended by erratum</span>
<span class="cm">		 * to RFC 4342. This implements the initialisation procedure of</span>
<span class="cm">		 * draft rfc3448bis, section 4.2. Remember, X is scaled by 2^6.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_syn_rtt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;SYN RTT = %uus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_syn_rtt</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span>  <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_syn_rtt</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span>    <span class="o">=</span> <span class="n">rfc3390_initial_rate</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ld</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Sender does not have RTT sample:</span>
<span class="cm">			 * - set fallback RTT (RFC 4340, 3.4) since a RTT value</span>
<span class="cm">			 *   is needed in several parts (e.g.  window counter);</span>
<span class="cm">			 * - set sending rate X_pps = 1pps as per RFC 3448, 4.2.</span>
<span class="cm">			 */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span> <span class="o">=</span> <span class="n">DCCP_FALLBACK_RTT</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span>   <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ccid3_update_send_interval</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

		<span class="n">ccid3_hc_tx_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">TFRC_SSTATE_NO_FBACK</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">ktime_us_delta</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_nom</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>
		<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;delay=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">delay</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *	Scheduling of packet transmissions (RFC 5348, 8.3)</span>
<span class="cm">		 *</span>
<span class="cm">		 * if (t_now &gt; t_nom - delta)</span>
<span class="cm">		 *       // send the packet now</span>
<span class="cm">		 * else</span>
<span class="cm">		 *       // send the packet in (t_nom - t_now) milliseconds.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="n">TFRC_T_DELTA</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">delay</span> <span class="o">/</span> <span class="n">USEC_PER_MSEC</span><span class="p">;</span>

		<span class="n">ccid3_hc_tx_update_win_count</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* prepare to send now (add options etc.) */</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_tx_insert_options</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">DCCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccpd_ccval</span>  <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_last_win_count</span><span class="p">;</span>

	<span class="cm">/* set the nominal send time for the next following packet */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_nom</span> <span class="o">=</span> <span class="n">ktime_add_us</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_nom</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ipi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CCID_PACKET_SEND_AT_ONCE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_packet_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">ccid3_hc_tx_update_s</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tfrc_tx_hist_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_hist</span><span class="p">,</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_gss</span><span class="p">))</span>
		<span class="n">DCCP_CRIT</span><span class="p">(</span><span class="s">&quot;packet history - out of memory!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_packet_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tfrc_tx_hist_entry</span> <span class="o">*</span><span class="n">acked</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t_nfb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r_sample</span><span class="p">;</span>

	<span class="cm">/* we are only interested in ACKs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DCCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccpd_type</span> <span class="o">==</span> <span class="n">DCCP_PKT_ACK</span> <span class="o">||</span>
	      <span class="n">DCCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccpd_type</span> <span class="o">==</span> <span class="n">DCCP_PKT_DATAACK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Locate the acknowledged packet in the TX history.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Returning &quot;entry not found&quot; here can for instance happen when</span>
<span class="cm">	 *  - the host has not sent out anything (e.g. a passive server),</span>
<span class="cm">	 *  - the Ack is outdated (packet with higher Ack number was received),</span>
<span class="cm">	 *  - it is a bogus Ack (for a packet not sent on this connection).</span>
<span class="cm">	 */</span>
	<span class="n">acked</span> <span class="o">=</span> <span class="n">tfrc_tx_hist_find_entry</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_hist</span><span class="p">,</span> <span class="n">dccp_hdr_ack_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acked</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* For the sake of RTT sampling, ignore/remove all older entries */</span>
	<span class="n">tfrc_tx_hist_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acked</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="cm">/* Update the moving average for the RTT estimate (RFC 3448, 4.3) */</span>
	<span class="n">now</span>	  <span class="o">=</span> <span class="n">ktime_get_real</span><span class="p">();</span>
	<span class="n">r_sample</span>  <span class="o">=</span> <span class="n">dccp_sample_rtt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">ktime_us_delta</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">acked</span><span class="o">-&gt;</span><span class="n">stamp</span><span class="p">));</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span> <span class="o">=</span> <span class="n">tfrc_ewma</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">,</span> <span class="n">r_sample</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update allowed sending rate X as per draft rfc3448bis-00, 4.2/3</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TFRC_SSTATE_NO_FBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccid3_hc_tx_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">TFRC_SSTATE_FBACK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Initial feedback packet: Larger Initial Windows (4.2)</span>
<span class="cm">			 */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span>    <span class="o">=</span> <span class="n">rfc3390_initial_rate</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ld</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

			<span class="n">ccid3_update_send_interval</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">done_computing_x</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * First feedback after nofeedback timer expiry (4.3)</span>
<span class="cm">			 */</span>
			<span class="k">goto</span> <span class="n">done_computing_x</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Update sending rate (step 4 of [RFC 3448, 4.3]) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_calc</span> <span class="o">=</span> <span class="n">tfrc_calc_x</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span><span class="p">);</span>
	<span class="n">ccid3_hc_tx_update_x</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>

<span class="nl">done_computing_x:</span>
	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p), RTT=%uus (sample=%uus), s=%u, &quot;</span>
			       <span class="s">&quot;p=%u, X_calc=%u, X_recv=%u, X=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">,</span> <span class="n">r_sample</span><span class="p">,</span>
			       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_s</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_calc</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">),</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>

	<span class="cm">/* unschedule no feedback timer */</span>
	<span class="n">sk_stop_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_no_feedback_timer</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As we have calculated new ipi, delta, t_nom it is possible</span>
<span class="cm">	 * that we now can send a packet, so wake up dccp_wait_for_ccid</span>
<span class="cm">	 */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update timeout interval for the nofeedback timer. In order to control</span>
<span class="cm">	 * rate halving on networks with very low RTTs (&lt;= 1 ms), use per-route</span>
<span class="cm">	 * tunable RTAX_RTO_MIN value as the lower bound.</span>
<span class="cm">	 */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">,</span>
				  <span class="n">USEC_PER_SEC</span><span class="o">/</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">tcp_rto_min</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Schedule no feedback timer to expire in</span>
<span class="cm">	 * max(t_RTO, 2 * s/X)  =  max(t_RTO, 2 * t_ipi)</span>
<span class="cm">	 */</span>
	<span class="n">t_nfb</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ipi</span><span class="p">);</span>

	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p), Scheduled no feedback timer to &quot;</span>
		       <span class="s">&quot;expire in %lu jiffies (%luus)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">t_nfb</span><span class="p">),</span> <span class="n">t_nfb</span><span class="p">);</span>

	<span class="n">sk_reset_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_no_feedback_timer</span><span class="p">,</span>
			   <span class="n">jiffies</span> <span class="o">+</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">t_nfb</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccid3_hc_tx_parse_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">packet_type</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">option</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="n">u8</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="n">opt_val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TFRC_OPT_RECEIVE_RATE</span>:
	<span class="k">case</span> <span class="n">TFRC_OPT_LOSS_EVENT_RATE</span>:
		<span class="cm">/* Must be ignored on Data packets, cf. RFC 4342 8.3 and 8.5 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet_type</span> <span class="o">==</span> <span class="n">DCCP_PKT_DATA</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DCCP_WARN</span><span class="p">(</span><span class="s">&quot;%s(%p), invalid len %d for %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">optlen</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">opt_val</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">get_unaligned</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="n">TFRC_OPT_RECEIVE_RATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Receive Rate is kept in units of 64 bytes/second */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">=</span> <span class="n">opt_val</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span>

			<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p), RECEIVE_RATE=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">opt_val</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Update the fixpoint Loss Event Rate fraction */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span> <span class="o">=</span> <span class="n">tfrc_invert_loss_event_rate</span><span class="p">(</span><span class="n">opt_val</span><span class="p">);</span>

			<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p), LOSS_EVENT_RATE=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">opt_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccid3_hc_tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid</span> <span class="o">*</span><span class="n">ccid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid_priv</span><span class="p">(</span><span class="n">ccid</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TFRC_SSTATE_NO_SENT</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_hist</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_no_feedback_timer</span><span class="p">,</span>
			<span class="n">ccid3_hc_tx_no_feedback_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sk_stop_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_no_feedback_timer</span><span class="p">);</span>
	<span class="n">tfrc_tx_hist_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_hist</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_tx_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpi_rto</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpi_rtt</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccid3_hc_tx_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_tx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tfrc_tx_info</span> <span class="n">tfrc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_CCID_TX_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tfrc</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">tfrc</span><span class="p">.</span><span class="n">tfrctx_x</span>	   <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x</span><span class="p">;</span>
		<span class="n">tfrc</span><span class="p">.</span><span class="n">tfrctx_x_recv</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_recv</span><span class="p">;</span>
		<span class="n">tfrc</span><span class="p">.</span><span class="n">tfrctx_x_calc</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_x_calc</span><span class="p">;</span>
		<span class="n">tfrc</span><span class="p">.</span><span class="n">tfrctx_rtt</span>	   <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_rtt</span><span class="p">;</span>
		<span class="n">tfrc</span><span class="p">.</span><span class="n">tfrctx_p</span>	   <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_p</span><span class="p">;</span>
		<span class="n">tfrc</span><span class="p">.</span><span class="n">tfrctx_rto</span>	   <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_rto</span><span class="p">;</span>
		<span class="n">tfrc</span><span class="p">.</span><span class="n">tfrctx_ipi</span>	   <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">tx_t_ipi</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tfrc</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tfrc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Receiver Half-Connection Routines</span>
<span class="cm"> */</span>

<span class="cm">/* CCID3 feedback types */</span>
<span class="k">enum</span> <span class="n">ccid3_fback_type</span> <span class="p">{</span>
	<span class="n">CCID3_FBACK_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CCID3_FBACK_INITIAL</span><span class="p">,</span>
	<span class="n">CCID3_FBACK_PERIODIC</span><span class="p">,</span>
	<span class="n">CCID3_FBACK_PARAM_CHANGE</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_IP_DCCP_CCID3_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ccid3_rx_state_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">ccid3_hc_rx_states</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ccid3_rx_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TFRC_RSTATE_NO_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NO_DATA&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TFRC_RSTATE_DATA</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;DATA&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">ccid3_rx_state_names</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_rx_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ccid3_hc_rx_states</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ccid3_hc_rx_states</span> <span class="n">oldstate</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_state</span><span class="p">;</span>

	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p) %-8.8s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ccid3_rx_state_name</span><span class="p">(</span><span class="n">oldstate</span><span class="p">),</span>
		       <span class="n">ccid3_rx_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">oldstate</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_rx_send_feedback</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">ccid3_fback_type</span> <span class="n">fbtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">ktime_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">ktime_get_real</span><span class="p">();</span>
	<span class="n">s64</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fbtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCID3_FBACK_INITIAL</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_pinv</span>   <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>   <span class="cm">/* see RFC 4342, 8.5 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CCID3_FBACK_PARAM_CHANGE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * When parameters change (new loss or p &gt; p_prev), we do not</span>
<span class="cm">		 * have a reliable estimate for R_m of [RFC 3448, 6.2] and so</span>
<span class="cm">		 * need to  reuse the previous value of X_recv. However, when</span>
<span class="cm">		 * X_recv was 0 (due to early loss), this would kill X down to</span>
<span class="cm">		 * s/t_mbi (i.e. one packet in 64 seconds).</span>
<span class="cm">		 * To avoid such drastic reduction, we approximate X_recv as</span>
<span class="cm">		 * the number of bytes since last feedback.</span>
<span class="cm">		 * This is a safe fallback, since X is bounded above by X_calc.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">CCID3_FBACK_PERIODIC</span>:
		<span class="n">delta</span> <span class="o">=</span> <span class="n">ktime_us_delta</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_tstamp_last_feedback</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">DCCP_BUG</span><span class="p">(</span><span class="s">&quot;delta (%ld) &lt;= 0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">delta</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span> <span class="o">=</span> <span class="n">scaled_div32</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_bytes_recv</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;Interval %ldusec, X_recv=%u, 1/p=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">delta</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_pinv</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_tstamp_last_feedback</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_last_counter</span>	    <span class="o">=</span> <span class="n">dccp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccph_ccval</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_bytes_recv</span>	    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_insert_options</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dccp_send_ack</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccid3_hc_rx_insert_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="n">x_recv</span><span class="p">,</span> <span class="n">pinv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_OPEN</span> <span class="o">||</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_PARTOPEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dccp_packet_without_ack</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">x_recv</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span><span class="p">);</span>
	<span class="n">pinv</span>   <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_pinv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dccp_insert_option</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TFRC_OPT_LOSS_EVENT_RATE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">pinv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pinv</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">dccp_insert_option</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TFRC_OPT_RECEIVE_RATE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">x_recv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x_recv</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ccid3_first_li  -  Implements [RFC 5348, 6.3.1]</span>
<span class="cm"> *</span>
<span class="cm"> * Determine the length of the first loss interval via inverse lookup.</span>
<span class="cm"> * Assume that X_recv can be computed by the throughput equation</span>
<span class="cm"> *		    s</span>
<span class="cm"> *	X_recv = --------</span>
<span class="cm"> *		 R * fval</span>
<span class="cm"> * Find some p such that f(p) = fval; return 1/p (scaled).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ccid3_first_li</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">x_recv</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_rtt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DCCP_WARN</span><span class="p">(</span><span class="s">&quot;No RTT estimate available, using fallback RTT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_rtt</span> <span class="o">=</span> <span class="n">DCCP_FALLBACK_RTT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">delta</span>  <span class="o">=</span> <span class="n">ktime_to_us</span><span class="p">(</span><span class="n">net_timedelta</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_tstamp_last_feedback</span><span class="p">));</span>
	<span class="n">x_recv</span> <span class="o">=</span> <span class="n">scaled_div32</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_bytes_recv</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x_recv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* would also trigger divide-by-zero */</span>
		<span class="n">DCCP_WARN</span><span class="p">(</span><span class="s">&quot;X_recv==0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DCCP_BUG</span><span class="p">(</span><span class="s">&quot;stored value of X_recv is zero&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">x_recv</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fval</span> <span class="o">=</span> <span class="n">scaled_div</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_s</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_rtt</span><span class="p">);</span>
	<span class="n">fval</span> <span class="o">=</span> <span class="n">scaled_div32</span><span class="p">(</span><span class="n">fval</span><span class="p">,</span> <span class="n">x_recv</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">tfrc_calc_x_reverse_lookup</span><span class="p">(</span><span class="n">fval</span><span class="p">);</span>

	<span class="n">ccid3_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p), receive rate=%u bytes/s, implied &quot;</span>
		       <span class="s">&quot;loss rate=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span> <span class="n">x_recv</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0U</span> <span class="o">:</span> <span class="n">scaled_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_rx_packet_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ccid3_fback_type</span> <span class="n">do_feedback</span> <span class="o">=</span> <span class="n">CCID3_FBACK_NONE</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="n">ndp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_options_received</span><span class="p">.</span><span class="n">dccpor_ndp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">bool</span> <span class="n">is_data_packet</span> <span class="o">=</span> <span class="n">dccp_data_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">==</span> <span class="n">TFRC_RSTATE_NO_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_data_packet</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u32</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">dccp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccph_doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">do_feedback</span> <span class="o">=</span> <span class="n">CCID3_FBACK_INITIAL</span><span class="p">;</span>
			<span class="n">ccid3_hc_rx_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">TFRC_RSTATE_DATA</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_s</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Not necessary to update rx_bytes_recv here,</span>
<span class="cm">			 * since X_recv = 0 for the first feedback packet (cf.</span>
<span class="cm">			 * RFC 3448, 6.3) -- gerrit</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">update_records</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tfrc_rx_hist_duplicate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_hist</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* done receiving */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_data_packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">dccp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccph_doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Update moving-average of s and the sum of received payload bytes</span>
<span class="cm">		 */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_s</span> <span class="o">=</span> <span class="n">tfrc_ewma</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_s</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_bytes_recv</span> <span class="o">+=</span> <span class="n">payload</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Perform loss detection and handle pending losses</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tfrc_rx_handle_loss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_hist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_li_hist</span><span class="p">,</span>
				<span class="n">skb</span><span class="p">,</span> <span class="n">ndp</span><span class="p">,</span> <span class="n">ccid3_first_li</span><span class="p">,</span> <span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">do_feedback</span> <span class="o">=</span> <span class="n">CCID3_FBACK_PARAM_CHANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done_receiving</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tfrc_rx_hist_loss_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_hist</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* done receiving */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle data packets: RTT sampling and monitoring p</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_data_packet</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">update_records</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfrc_lh_is_initialised</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_li_hist</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">sample</span> <span class="o">=</span> <span class="n">tfrc_rx_hist_sample_rtt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_hist</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Empty loss history: no loss so far, hence p stays 0.</span>
<span class="cm">		 * Sample RTT values, since an RTT estimate is required for the</span>
<span class="cm">		 * computation of p when the first loss occurs; RFC 3448, 6.3.1.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_rtt</span> <span class="o">=</span> <span class="n">tfrc_ewma</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_rtt</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tfrc_lh_update_i_mean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_li_hist</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Step (3) of [RFC 3448, 6.1]: Recompute I_mean and, if I_mean</span>
<span class="cm">		 * has decreased (resp. p has increased), send feedback now.</span>
<span class="cm">		 */</span>
		<span class="n">do_feedback</span> <span class="o">=</span> <span class="n">CCID3_FBACK_PARAM_CHANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if the periodic once-per-RTT feedback is due; RFC 4342, 10.3</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUB16</span><span class="p">(</span><span class="n">dccp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccph_ccval</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_last_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">do_feedback</span> <span class="o">=</span> <span class="n">CCID3_FBACK_PERIODIC</span><span class="p">;</span>

<span class="nl">update_records:</span>
	<span class="n">tfrc_rx_hist_add_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_hist</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ndp</span><span class="p">);</span>

<span class="nl">done_receiving:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_feedback</span><span class="p">)</span>
		<span class="n">ccid3_hc_rx_send_feedback</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">do_feedback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccid3_hc_rx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid</span> <span class="o">*</span><span class="n">ccid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid_priv</span><span class="p">(</span><span class="n">ccid</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">TFRC_RSTATE_NO_DATA</span><span class="p">;</span>
	<span class="n">tfrc_lh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_li_hist</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tfrc_rx_hist_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_hist</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_rx_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">tfrc_rx_hist_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_hist</span><span class="p">);</span>
	<span class="n">tfrc_lh_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_li_hist</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccid3_hc_rx_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpi_ca_state</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_state</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpi_options</span>  <span class="o">|=</span> <span class="n">TCPI_OPT_TIMESTAMPS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpi_rcv_rtt</span>  <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_rtt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccid3_hc_rx_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tfrc_rx_info</span> <span class="n">rx_info</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_CCID_RX_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">rx_info</span><span class="p">.</span><span class="n">tfrcrx_x_recv</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_x_recv</span><span class="p">;</span>
		<span class="n">rx_info</span><span class="p">.</span><span class="n">tfrcrx_rtt</span>    <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_rtt</span><span class="p">;</span>
		<span class="n">rx_info</span><span class="p">.</span><span class="n">tfrcrx_p</span>      <span class="o">=</span> <span class="n">tfrc_invert_loss_event_rate</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">rx_pinv</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_info</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_info</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ccid_operations</span> <span class="n">ccid3_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ccid_id</span>		   <span class="o">=</span> <span class="n">DCCPC_CCID3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_name</span>		   <span class="o">=</span> <span class="s">&quot;TCP-Friendly Rate Control&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_obj_size</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid3_hc_tx_sock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_init</span>	   <span class="o">=</span> <span class="n">ccid3_hc_tx_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_exit</span>	   <span class="o">=</span> <span class="n">ccid3_hc_tx_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_send_packet</span>	   <span class="o">=</span> <span class="n">ccid3_hc_tx_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_packet_sent</span>	   <span class="o">=</span> <span class="n">ccid3_hc_tx_packet_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_packet_recv</span>	   <span class="o">=</span> <span class="n">ccid3_hc_tx_packet_recv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_parse_options</span>  <span class="o">=</span> <span class="n">ccid3_hc_tx_parse_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_rx_obj_size</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccid3_hc_rx_sock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ccid_hc_rx_init</span>	   <span class="o">=</span> <span class="n">ccid3_hc_rx_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_rx_exit</span>	   <span class="o">=</span> <span class="n">ccid3_hc_rx_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_rx_insert_options</span> <span class="o">=</span> <span class="n">ccid3_hc_rx_insert_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_rx_packet_recv</span>	   <span class="o">=</span> <span class="n">ccid3_hc_rx_packet_recv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_rx_get_info</span>	   <span class="o">=</span> <span class="n">ccid3_hc_rx_get_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_get_info</span>	   <span class="o">=</span> <span class="n">ccid3_hc_tx_get_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_rx_getsockopt</span>	   <span class="o">=</span> <span class="n">ccid3_hc_rx_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccid_hc_tx_getsockopt</span>	   <span class="o">=</span> <span class="n">ccid3_hc_tx_getsockopt</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_IP_DCCP_CCID3_DEBUG</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ccid3_debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ccid3_debug</span><span class="p">,</span> <span class="s">&quot;Enable CCID-3 debug messages&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
