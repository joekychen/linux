<!DOCTYPE html>
<html><head><title>joekychen/linux » net › dccp › proto.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>proto.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  net/dccp/proto.c</span>
<span class="cm"> *</span>
<span class="cm"> *  An implementation of the DCCP protocol</span>
<span class="cm"> *  Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *	under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *	published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dccp.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>

<span class="cp">#include &lt;net/inet_sock.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/xfrm.h&gt;</span>

<span class="cp">#include &lt;asm/ioctls.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>

<span class="cp">#include &quot;ccid.h&quot;</span>
<span class="cp">#include &quot;dccp.h&quot;</span>
<span class="cp">#include &quot;feat.h&quot;</span>

<span class="n">DEFINE_SNMP_STAT</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_mib</span><span class="p">,</span> <span class="n">dccp_statistics</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_statistics</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">percpu_counter</span> <span class="n">dccp_orphan_count</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_orphan_count</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">inet_hashinfo</span> <span class="n">dccp_hashinfo</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_hashinfo</span><span class="p">);</span>

<span class="cm">/* the maximum queue length for tx in packets. 0 is no limit */</span>
<span class="kt">int</span> <span class="n">sysctl_dccp_tx_qlen</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_DCCP_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dccp_state_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">dccp_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DCCP_OPEN</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;OPEN&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_REQUESTING</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;REQUESTING&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_PARTOPEN</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;PARTOPEN&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_LISTEN</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;LISTEN&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_RESPOND</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;RESPOND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_CLOSING</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;CLOSING&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_ACTIVE_CLOSEREQ</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;CLOSEREQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_PASSIVE_CLOSE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;PASSIVE_CLOSE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_PASSIVE_CLOSEREQ</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;PASSIVE_CLOSEREQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_TIME_WAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TIME_WAIT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DCCP_CLOSED</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;CLOSED&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">DCCP_MAX_STATES</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;INVALID STATE!&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dccp_state_names</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">dccp_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">oldstate</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">;</span>

	<span class="n">dccp_pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p)  %s  --&gt;  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dccp_role</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span>
		      <span class="n">dccp_state_name</span><span class="p">(</span><span class="n">oldstate</span><span class="p">),</span> <span class="n">dccp_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">oldstate</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_OPEN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">oldstate</span> <span class="o">!=</span> <span class="n">DCCP_OPEN</span><span class="p">)</span>
			<span class="n">DCCP_INC_STATS</span><span class="p">(</span><span class="n">DCCP_MIB_CURRESTAB</span><span class="p">);</span>
		<span class="cm">/* Client retransmits all Confirm options until entering OPEN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldstate</span> <span class="o">==</span> <span class="n">DCCP_PARTOPEN</span><span class="p">)</span>
			<span class="n">dccp_feat_list_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_featneg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DCCP_CLOSED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">oldstate</span> <span class="o">==</span> <span class="n">DCCP_OPEN</span> <span class="o">||</span> <span class="n">oldstate</span> <span class="o">==</span> <span class="n">DCCP_ACTIVE_CLOSEREQ</span> <span class="o">||</span>
		    <span class="n">oldstate</span> <span class="o">==</span> <span class="n">DCCP_CLOSING</span><span class="p">)</span>
			<span class="n">DCCP_INC_STATS</span><span class="p">(</span><span class="n">DCCP_MIB_ESTABRESETS</span><span class="p">);</span>

		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="o">-&gt;</span><span class="n">unhash</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_bind_hash</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_userlocks</span> <span class="o">&amp;</span> <span class="n">SOCK_BINDPORT_LOCK</span><span class="p">))</span>
			<span class="n">inet_put_port</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldstate</span> <span class="o">==</span> <span class="n">DCCP_OPEN</span><span class="p">)</span>
			<span class="n">DCCP_DEC_STATS</span><span class="p">(</span><span class="n">DCCP_MIB_CURRESTAB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Change state AFTER socket is unhashed to avoid closed</span>
<span class="cm">	 * socket sitting in hash tables.</span>
<span class="cm">	 */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_set_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dccp_finish_passive_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_PASSIVE_CLOSE</span>:
		<span class="cm">/* Node (client or server) has received Close packet. */</span>
		<span class="n">dccp_send_reset</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_RESET_CODE_CLOSED</span><span class="p">);</span>
		<span class="n">dccp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_CLOSED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_PASSIVE_CLOSEREQ</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Client received CloseReq. We set the `active&#39; flag so that</span>
<span class="cm">		 * dccp_send_close() retransmits the Close as per RFC 4340, 8.3.</span>
<span class="cm">		 */</span>
		<span class="n">dccp_send_close</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dccp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_CLOSING</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dccp_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dccp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_CLOSED</span><span class="p">);</span>
	<span class="n">dccp_clear_xmit_timers</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">=</span> <span class="n">SHUTDOWN_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">inet_csk_destroy_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_done</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dccp_packet_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">dccp_packet_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DCCP_PKT_REQUEST</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;REQUEST&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RESPONSE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_DATA</span><span class="p">]</span>	    <span class="o">=</span> <span class="s">&quot;DATA&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_ACK</span><span class="p">]</span>	    <span class="o">=</span> <span class="s">&quot;ACK&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_DATAACK</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;DATAACK&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_CLOSEREQ</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CLOSEREQ&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_CLOSE</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;CLOSE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_RESET</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;RESET&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_SYNC</span><span class="p">]</span>	    <span class="o">=</span> <span class="s">&quot;SYNC&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DCCP_PKT_SYNCACK</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;SYNCACK&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">DCCP_NR_PKT_TYPES</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;INVALID&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dccp_packet_names</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_packet_name</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dccp_init_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">ctl_sock_initialized</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_rto</span>		<span class="o">=</span> <span class="n">DCCP_TIMEOUT_INIT</span><span class="p">;</span>
	<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_syn_retries</span>	<span class="o">=</span> <span class="n">sysctl_dccp_request_retries</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>		<span class="o">=</span> <span class="n">DCCP_CLOSED</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span>	<span class="o">=</span> <span class="n">dccp_write_space</span><span class="p">;</span>
	<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_sync_mss</span>	<span class="o">=</span> <span class="n">dccp_sync_mss</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_mss_cache</span>	<span class="o">=</span> <span class="mi">536</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_rate_last</span>	<span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_role</span>		<span class="o">=</span> <span class="n">DCCP_ROLE_UNDEFINED</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service</span>	<span class="o">=</span> <span class="n">DCCP_SERVICE_CODE_IS_ABSENT</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_tx_qlen</span>	<span class="o">=</span> <span class="n">sysctl_dccp_tx_qlen</span><span class="p">;</span>

	<span class="n">dccp_init_xmit_timers</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_featneg</span><span class="p">);</span>
	<span class="cm">/* control socket doesn&#39;t need feat nego */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ctl_sock_initialized</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dccp_feat_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_init_sock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dccp_destroy_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * DCCP doesn&#39;t use sk_write_queue, just sk_send_head</span>
<span class="cm">	 * for retransmissions</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_send_head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_send_head</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_send_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clean up a referenced DCCP bind bucket. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_bind_hash</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">inet_put_port</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service_list</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ackvec</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dccp_ackvec_free</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ackvec</span><span class="p">);</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ackvec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccid_hc_rx_delete</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ccid</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">ccid_hc_tx_delete</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_tx_ccid</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ccid</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_tx_ccid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* clean up feature negotiation state */</span>
	<span class="n">dccp_feat_list_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_featneg</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_destroy_sock</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_listen_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_role</span> <span class="o">=</span> <span class="n">DCCP_ROLE_LISTEN</span><span class="p">;</span>
	<span class="cm">/* do not start to listen if feature negotiation setup fails */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dccp_feat_finalise_settings</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">inet_csk_listen_start</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_need_reset</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">DCCP_CLOSED</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">DCCP_LISTEN</span> <span class="o">&amp;&amp;</span>
	       <span class="n">state</span> <span class="o">!=</span> <span class="n">DCCP_REQUESTING</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dccp_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">DCCP_CLOSED</span><span class="p">)</span>
		<span class="n">dccp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_CLOSED</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This corresponds to the ABORT function of RFC793, sec. 3.8</span>
<span class="cm">	 * TCP uses a RST segment, DCCP a Reset packet with Code 2, &quot;Aborted&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">DCCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet_csk_listen_stop</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dccp_need_reset</span><span class="p">(</span><span class="n">old_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dccp_send_reset</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_RESET_CODE_ABORTED</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">DCCP_REQUESTING</span><span class="p">)</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ECONNRESET</span><span class="p">;</span>

	<span class="n">dccp_clear_xmit_timers</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_send_head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_send_head</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_send_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_userlocks</span> <span class="o">&amp;</span> <span class="n">SOCK_BINDADDR_LOCK</span><span class="p">))</span>
		<span class="n">inet_reset_saddr</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DONE</span><span class="p">);</span>

	<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_backoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inet_csk_delack_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__sk_dst_reset</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_num</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_bind_hash</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_disconnect</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Wait for a DCCP event.</span>
<span class="cm"> *</span>
<span class="cm"> *	Note that we don&#39;t need to lock the socket, as the upper poll layers</span>
<span class="cm"> *	take care of normal races (between the test and the event) and we don&#39;t</span>
<span class="cm"> *	go look at any of the socket buffers directly.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dccp_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		       <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">sock_poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_LISTEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">inet_csk_listen_poll</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Socket is not locked. We are protected from async events</span>
<span class="cm">	   by poll logic and correct handling of state changes</span>
<span class="cm">	   made by another threads is impossible in any case.</span>
<span class="cm">	 */</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">POLLERR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">==</span> <span class="n">SHUTDOWN_MASK</span> <span class="o">||</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_CLOSED</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLHUP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span> <span class="o">|</span> <span class="n">POLLRDHUP</span><span class="p">;</span>

	<span class="cm">/* Connected? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DCCPF_REQUESTING</span> <span class="o">|</span> <span class="n">DCCPF_RESPOND</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">SEND_SHUTDOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sk_stream_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">sk_stream_min_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* send SIGIO later */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_ASYNC_NOSPACE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_NOSPACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

				<span class="cm">/* Race breaker. If space is freed after</span>
<span class="cm">				 * wspace test but before the flags are set,</span>
<span class="cm">				 * IO signal will be lost.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sk_stream_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">sk_stream_min_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
					<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_poll</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dccp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_LISTEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCINQ</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We will only return the amount of this packet since</span>
<span class="cm">			 * that is all that will be read.</span>
<span class="cm">			 */</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_ioctl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dccp_setsockopt_service</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be32</span> <span class="n">service</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dccp_service_list</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="n">DCCP_SERVICE_INVALID_VALUE</span> <span class="o">||</span>
	    <span class="n">optlen</span> <span class="o">&gt;</span> <span class="n">DCCP_SERVICE_LIST_MAX_LEN</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">service</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">optlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">sl</span><span class="o">-&gt;</span><span class="n">dccpsl_nr</span> <span class="o">=</span> <span class="n">optlen</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dccpsl_list</span><span class="p">,</span>
				   <span class="n">optval</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">service</span><span class="p">),</span>
				   <span class="n">optlen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">service</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">dccp_list_has_service</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">DCCP_SERVICE_INVALID_VALUE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service</span> <span class="o">=</span> <span class="n">service</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service_list</span><span class="p">);</span>

	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service_list</span> <span class="o">=</span> <span class="n">sl</span><span class="p">;</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dccp_setsockopt_cscov</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cscov</span><span class="p">,</span> <span class="n">bool</span> <span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cscov</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cscov</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Populate a list of permissible values, in the range cscov...15. This</span>
<span class="cm">	 * is necessary since feature negotiation of single values only works if</span>
<span class="cm">	 * both sides incidentally choose the same value. Since the list starts</span>
<span class="cm">	 * lowest-value first, negotiation will pick the smallest shared value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cscov</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">cscov</span><span class="p">;</span>

	<span class="n">list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cscov</span><span class="o">++</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dccp_feat_register_sp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCPF_MIN_CSUM_COVER</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_pcrlen</span> <span class="o">=</span> <span class="n">cscov</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_pcslen</span> <span class="o">=</span> <span class="n">cscov</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dccp_setsockopt_ccid</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">optlen</span> <span class="o">&gt;</span> <span class="n">DCCP_FEAT_MAX_SP_VALS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_SOCKOPT_TX_CCID</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_SOCKOPT_CCID</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dccp_feat_register_sp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCPF_CCID</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_SOCKOPT_RX_CCID</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_SOCKOPT_CCID</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dccp_feat_register_sp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCPF_CCID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_dccp_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_PACKET_SIZE</span>:
		<span class="n">DCCP_WARN</span><span class="p">(</span><span class="s">&quot;sockopt(PACKET_SIZE) is deprecated: fix your app</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_CHANGE_L</span>:
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_CHANGE_R</span>:
		<span class="n">DCCP_WARN</span><span class="p">(</span><span class="s">&quot;sockopt(CHANGE_L/R) is deprecated: fix your app</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_CCID</span>:
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_RX_CCID</span>:
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_TX_CCID</span>:
		<span class="k">return</span> <span class="n">dccp_setsockopt_ccid</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optname</span> <span class="o">==</span> <span class="n">DCCP_SOCKOPT_SERVICE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dccp_setsockopt_service</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_SERVER_TIMEWAIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_role</span> <span class="o">!=</span> <span class="n">DCCP_ROLE_SERVER</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_server_timewait</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_SEND_CSCOV</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">dccp_setsockopt_cscov</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_RECV_CSCOV</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">dccp_setsockopt_cscov</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_QPOLICY_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">DCCP_CLOSED</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">DCCPQ_POLICY_MAX</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_qpolicy</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_QPOLICY_TXQLEN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_tx_qlen</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dccp_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_DCCP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_af_ops</span><span class="o">-&gt;</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
							     <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span>
							     <span class="n">optlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">do_dccp_setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_setsockopt</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="kt">int</span> <span class="nf">compat_dccp_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_DCCP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">inet_csk_compat_setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span>
						  <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">do_dccp_setsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">compat_dccp_setsockopt</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dccp_getsockopt_service</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				   <span class="n">__be32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dccp_service_list</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">slen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sl</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slen</span> <span class="o">=</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">dccpsl_nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">total_len</span> <span class="o">+=</span> <span class="n">slen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">total_len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service</span><span class="p">,</span> <span class="n">optval</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sl</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">dccpsl_list</span><span class="p">,</span> <span class="n">slen</span><span class="p">)))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_dccp_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_PACKET_SIZE</span>:
		<span class="n">DCCP_WARN</span><span class="p">(</span><span class="s">&quot;sockopt(PACKET_SIZE) is deprecated: fix your app</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_SERVICE</span>:
		<span class="k">return</span> <span class="n">dccp_getsockopt_service</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">__be32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_GET_CUR_MPS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_mss_cache</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_AVAILABLE_CCIDS</span>:
		<span class="k">return</span> <span class="n">ccid_getsockopt_builtin_ccids</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_TX_CCID</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ccid_get_current_tx_ccid</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_RX_CCID</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ccid_get_current_rx_ccid</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_SERVER_TIMEWAIT</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_server_timewait</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_SEND_CSCOV</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_pcslen</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_RECV_CSCOV</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_pcrlen</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_QPOLICY_ID</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_qpolicy</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_SOCKOPT_QPOLICY_TXQLEN</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_tx_qlen</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span> <span class="p">...</span> <span class="mi">191</span>:
		<span class="k">return</span> <span class="n">ccid_hc_rx_getsockopt</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ccid</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span>
					     <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">192</span> <span class="p">...</span> <span class="mi">255</span>:
		<span class="k">return</span> <span class="n">ccid_hc_tx_getsockopt</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_hc_tx_ccid</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span>
					     <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dccp_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_DCCP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_af_ops</span><span class="o">-&gt;</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
							     <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span>
							     <span class="n">optlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">do_dccp_getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_getsockopt</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="kt">int</span> <span class="nf">compat_dccp_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_DCCP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">inet_csk_compat_getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span>
						  <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">do_dccp_getsockopt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">compat_dccp_getsockopt</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dccp_msghdr_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assign an (opaque) qpolicy priority value to skb-&gt;priority.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We are overloading this skb field for use with the qpolicy subystem.</span>
<span class="cm">	 * The skb-&gt;priority is normally used for the SO_PRIORITY option, which</span>
<span class="cm">	 * is initialised from sk_priority. Since the assignment of sk_priority</span>
<span class="cm">	 * to skb-&gt;priority happens later (on layer 3), we overload this field</span>
<span class="cm">	 * for use with queueing priorities as long as the skb is on layer 4.</span>
<span class="cm">	 * The default priority value (if nothing is set) is 0.</span>
<span class="cm">	 */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">cmsg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_NXTHDR</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CMSG_OK</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">!=</span> <span class="n">SOL_DCCP</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">&lt;=</span> <span class="n">DCCP_SCM_QPOLICY_MAX</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">dccp_qpolicy_param_ok</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCCP_SCM_PRIORITY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_len</span> <span class="o">!=</span> <span class="n">CMSG_LEN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span><span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dccp_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		 <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">noblock</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_mss_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dccp_qpolicy_full</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">noblock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to use sk_stream_wait_connect here to set sk_write_pending,</span>
<span class="cm">	 * so that the trick in dccp_rcv_request_sent_state_process.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Wait for a connection to finish. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DCCPF_OPEN</span> <span class="o">|</span> <span class="n">DCCPF_PARTOPEN</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">sk_stream_wait_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="o">-&gt;</span><span class="n">max_header</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">noblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="o">-&gt;</span><span class="n">max_header</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_discard</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dccp_msghdr_parse</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_discard</span><span class="p">;</span>

	<span class="n">dccp_qpolicy_push</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The xmit_timer is set if the TX CCID is rate-based and will expire</span>
<span class="cm">	 * when congestion control permits to release further packets into the</span>
<span class="cm">	 * network. Window-based CCIDs do not use this timer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_xmit_timer</span><span class="p">))</span>
		<span class="n">dccp_write_xmit</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out_release:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">out_discard:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_sendmsg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dccp_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		 <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dccp_hdr</span> <span class="o">*</span><span class="n">dh</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeo</span> <span class="o">=</span> <span class="n">sock_rcvtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">verify_sock_status</span><span class="p">;</span>

		<span class="n">dh</span> <span class="o">=</span> <span class="n">dccp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCCP_PKT_DATA</span>:
		<span class="k">case</span> <span class="n">DCCP_PKT_DATAACK</span>:
			<span class="k">goto</span> <span class="n">found_ok_skb</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DCCP_PKT_CLOSE</span>:
		<span class="k">case</span> <span class="n">DCCP_PKT_CLOSEREQ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span>
				<span class="n">dccp_finish_passive_close</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">DCCP_PKT_RESET</span>:
			<span class="n">dccp_pr_debug</span><span class="p">(</span><span class="s">&quot;found fin (%s) ok!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">dccp_packet_name</span><span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_type</span><span class="p">));</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found_fin_ok</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dccp_pr_debug</span><span class="p">(</span><span class="s">&quot;packet_type=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">dccp_packet_name</span><span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_type</span><span class="p">));</span>
			<span class="n">sk_eat_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">verify_sock_status:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_CLOSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DONE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* This occurs when user tries to read</span>
<span class="cm">				 * from never connected socket.</span>
<span class="cm">				 */</span>
				<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sk_wait_data</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeo</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="nl">found_ok_skb:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Exception. Bailout! */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_TRUNC</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="nl">found_fin_ok:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span>
			<span class="n">sk_eat_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_recvmsg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">inet_dccp_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SS_UNCONNECTED</span> <span class="o">||</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_DCCP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">old_state</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">old_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCCPF_CLOSED</span> <span class="o">|</span> <span class="n">DCCPF_LISTEN</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Really, if the socket is already in listen state</span>
<span class="cm">	 * we can only allow the backlog to be adjusted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">DCCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: here it probably should be sk-&gt;sk_prot-&gt;listen_start</span>
<span class="cm">		 * see tcp_listen_start</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dccp_listen_start</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">inet_dccp_listen</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dccp_terminate_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">next_state</span> <span class="o">=</span> <span class="n">DCCP_CLOSED</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCCP_PASSIVE_CLOSE</span>:
	<span class="k">case</span> <span class="n">DCCP_PASSIVE_CLOSEREQ</span>:
		<span class="n">dccp_finish_passive_close</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCCP_PARTOPEN</span>:
		<span class="n">dccp_pr_debug</span><span class="p">(</span><span class="s">&quot;Stop PARTOPEN timer (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="n">inet_csk_clear_xmit_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">ICSK_TIME_DACK</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">DCCP_OPEN</span>:
		<span class="n">dccp_send_close</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_role</span> <span class="o">==</span> <span class="n">DCCP_ROLE_SERVER</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_server_timewait</span><span class="p">)</span>
			<span class="n">next_state</span> <span class="o">=</span> <span class="n">DCCP_ACTIVE_CLOSEREQ</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">next_state</span> <span class="o">=</span> <span class="n">DCCP_CLOSING</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">dccp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">next_state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dccp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_was_unread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">=</span> <span class="n">SHUTDOWN_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dccp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_CLOSED</span><span class="p">);</span>

		<span class="cm">/* Special case. */</span>
		<span class="n">inet_csk_listen_stop</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">adjudge_to_death</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sk_stop_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_xmit_timer</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to flush the recv. buffs.  We do this only on the</span>
<span class="cm">	 * descriptor close, not protocol-sourced closes, because the</span>
<span class="cm">	  *reader process may not have drained the data yet!</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_was_unread</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_was_unread</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unread data was tossed, send an appropriate Reset Code */</span>
		<span class="n">DCCP_WARN</span><span class="p">(</span><span class="s">&quot;ABORT with %u bytes unread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_was_unread</span><span class="p">);</span>
		<span class="n">dccp_send_reset</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_RESET_CODE_ABORTED</span><span class="p">);</span>
		<span class="n">dccp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">DCCP_CLOSED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_LINGER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_lingertime</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check zero linger _after_ checking for unread data. */</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">DCCP_CLOSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Normal connection termination. May need to wait if there are</span>
<span class="cm">		 * still packets in the TX queue that are delayed by the CCID.</span>
<span class="cm">		 */</span>
		<span class="n">dccp_flush_write_queue</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">dccp_terminate_connection</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Flush write queue. This may be necessary in several cases:</span>
<span class="cm">	 * - we have been closed by the peer but still have application data;</span>
<span class="cm">	 * - abortive termination (unread data or zero linger time),</span>
<span class="cm">	 * - normal termination but queue could not be flushed within time limit</span>
<span class="cm">	 */</span>
	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">);</span>

	<span class="n">sk_stream_wait_close</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

<span class="nl">adjudge_to_death:</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">;</span>
	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_orphan</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * It is the last release_sock in its life. It will remove backlog.</span>
<span class="cm">	 */</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now socket is owned by kernel and we acquire BH lock</span>
<span class="cm">	 * to finish close. No need to check for user refs.</span>
<span class="cm">	 */</span>
	<span class="n">local_bh_disable</span><span class="p">();</span>
	<span class="n">bh_lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>

	<span class="n">percpu_counter_inc</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="o">-&gt;</span><span class="n">orphan_count</span><span class="p">);</span>

	<span class="cm">/* Have we already been destroyed by a softirq or backlog? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DCCP_CLOSED</span> <span class="o">&amp;&amp;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_CLOSED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">DCCP_CLOSED</span><span class="p">)</span>
		<span class="n">inet_csk_destroy_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Otherwise, socket is reprieved until protocol close. */</span>

<span class="nl">out:</span>
	<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">local_bh_enable</span><span class="p">();</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_close</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dccp_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">how</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dccp_pr_debug</span><span class="p">(</span><span class="s">&quot;called shutdown(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">how</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_shutdown</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_mib_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snmp_mib_init</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">dccp_statistics</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_mib</span><span class="p">),</span>
			     <span class="n">__alignof__</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_mib</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_mib_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snmp_mib_free</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">dccp_statistics</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">thash_entries</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">thash_entries</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">thash_entries</span><span class="p">,</span> <span class="s">&quot;Number of ehash buckets&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IP_DCCP_DEBUG</span>
<span class="n">bool</span> <span class="n">dccp_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dccp_debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dccp_debug</span><span class="p">,</span> <span class="s">&quot;Enable debug messages&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dccp_debug</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dccp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">goal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ehash_order</span><span class="p">,</span> <span class="n">bhash_order</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_skb_cb</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">FIELD_SIZEOF</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="p">,</span> <span class="n">cb</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_orphan_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">inet_hashinfo_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">);</span>
	<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bind_bucket_cachep</span> <span class="o">=</span>
		<span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;dccp_bind_bucket&quot;</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_bind_bucket</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bind_bucket_cachep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_percpu</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Size and allocate the main established and bind bucket</span>
<span class="cm">	 * hash tables.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The methodology is similar to that of the buffer cache.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">totalram_pages</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">totalram_pages</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">21</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">totalram_pages</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">23</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thash_entries</span><span class="p">)</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="p">(</span><span class="n">thash_entries</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_ehash_bucket</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ehash_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ehash_order</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">goal</span><span class="p">;</span> <span class="n">ehash_order</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ehash_order</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_ehash_bucket</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">hash_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hash_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">hash_size</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash_mask</span> <span class="o">=</span> <span class="n">hash_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet_ehash_bucket</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">__GFP_NOWARN</span><span class="p">,</span> <span class="n">ehash_order</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">ehash_order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DCCP_CRIT</span><span class="p">(</span><span class="s">&quot;Failed to allocate DCCP established hash table&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_bind_bucket_cachep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_HLIST_NULLS_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">INIT_HLIST_NULLS_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">twchain</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inet_ehash_locks_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free_dccp_ehash</span><span class="p">;</span>

	<span class="n">bhash_order</span> <span class="o">=</span> <span class="n">ehash_order</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">bhash_order</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_bind_hashbucket</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bhash_order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet_bind_hashbucket</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">__GFP_NOWARN</span><span class="p">,</span> <span class="n">bhash_order</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">bhash_order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DCCP_CRIT</span><span class="p">(</span><span class="s">&quot;Failed to allocate DCCP bind hash table&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_dccp_locks</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dccp_mib_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_dccp_bhash</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dccp_ackvec_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_dccp_mib</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dccp_sysctl_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_ackvec_exit</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccid_initialize_builtins</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sysctl_exit</span><span class="p">;</span>

	<span class="n">dccp_timestamping_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_sysctl_exit:</span>
	<span class="n">dccp_sysctl_exit</span><span class="p">();</span>
<span class="nl">out_ackvec_exit:</span>
	<span class="n">dccp_ackvec_exit</span><span class="p">();</span>
<span class="nl">out_free_dccp_mib:</span>
	<span class="n">dccp_mib_exit</span><span class="p">();</span>
<span class="nl">out_free_dccp_bhash:</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span><span class="p">,</span> <span class="n">bhash_order</span><span class="p">);</span>
<span class="nl">out_free_dccp_locks:</span>
	<span class="n">inet_ehash_locks_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">);</span>
<span class="nl">out_free_dccp_ehash:</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">,</span> <span class="n">ehash_order</span><span class="p">);</span>
<span class="nl">out_free_bind_bucket_cachep:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bind_bucket_cachep</span><span class="p">);</span>
<span class="nl">out_free_percpu:</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_orphan_count</span><span class="p">);</span>
<span class="nl">out_fail:</span>
	<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bind_bucket_cachep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dccp_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccid_cleanup_builtins</span><span class="p">();</span>
	<span class="n">dccp_mib_exit</span><span class="p">();</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash</span><span class="p">,</span>
		   <span class="n">get_order</span><span class="p">(</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bhash_size</span> <span class="o">*</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_bind_hashbucket</span><span class="p">)));</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">,</span>
		   <span class="n">get_order</span><span class="p">((</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">ehash_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_ehash_bucket</span><span class="p">)));</span>
	<span class="n">inet_ehash_locks_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_hashinfo</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">dccp_hashinfo</span><span class="p">.</span><span class="n">bind_bucket_cachep</span><span class="p">);</span>
	<span class="n">dccp_ackvec_exit</span><span class="p">();</span>
	<span class="n">dccp_sysctl_exit</span><span class="p">();</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dccp_orphan_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dccp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dccp_fini</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DCCP - Datagram Congestion Controlled Protocol&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
