<!DOCTYPE html>
<html><head><title>joekychen/linux » net › dccp › dccp.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dccp.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _DCCP_H</span>
<span class="cp">#define _DCCP_H</span>
<span class="cm">/*</span>
<span class="cm"> *  net/dccp/dccp.h</span>
<span class="cm"> *</span>
<span class="cm"> *  An implementation of the DCCP protocol</span>
<span class="cm"> *  Copyright (c) 2005 Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *  Copyright (c) 2005-6 Ian McDonald &lt;ian.mcdonald@jandi.co.nz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *	under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *	published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dccp.h&gt;</span>
<span class="cp">#include &lt;linux/ktime.h&gt;</span>
<span class="cp">#include &lt;net/snmp.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &quot;ackvec.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * 	DCCP - specific warning and debugging macros.</span>
<span class="cm"> */</span>
<span class="cp">#define DCCP_WARN(fmt, a...) LIMIT_NETDEBUG(KERN_WARNING &quot;%s: &quot; fmt,       \</span>
<span class="cp">							__func__, ##a)</span>
<span class="cp">#define DCCP_CRIT(fmt, a...) printk(KERN_CRIT fmt &quot; at %s:%d/%s()\n&quot;, ##a, \</span>
<span class="cp">					 __FILE__, __LINE__, __func__)</span>
<span class="cp">#define DCCP_BUG(a...)       do { DCCP_CRIT(&quot;BUG: &quot; a); dump_stack(); } while(0)</span>
<span class="cp">#define DCCP_BUG_ON(cond)    do { if (unlikely((cond) != 0))		   \</span>
<span class="cp">				     DCCP_BUG(&quot;\&quot;%s\&quot; holds (exception!)&quot;, \</span>
<span class="cp">					      __stringify(cond));          \</span>
<span class="cp">			     } while (0)</span>

<span class="cp">#define DCCP_PRINTK(enable, fmt, args...)	do { if (enable)	     \</span>
<span class="cp">							printk(fmt, ##args); \</span>
<span class="cp">						} while(0)</span>
<span class="cp">#define DCCP_PR_DEBUG(enable, fmt, a...)	DCCP_PRINTK(enable, KERN_DEBUG \</span>
<span class="cp">						  &quot;%s: &quot; fmt, __func__, ##a)</span>

<span class="cp">#ifdef CONFIG_IP_DCCP_DEBUG</span>
<span class="k">extern</span> <span class="n">bool</span> <span class="n">dccp_debug</span><span class="p">;</span>
<span class="cp">#define dccp_pr_debug(format, a...)	  DCCP_PR_DEBUG(dccp_debug, format, ##a)</span>
<span class="cp">#define dccp_pr_debug_cat(format, a...)   DCCP_PRINTK(dccp_debug, format, ##a)</span>
<span class="cp">#define dccp_debug(fmt, a...)		  dccp_pr_debug_cat(KERN_DEBUG fmt, ##a)</span>
<span class="cp">#else</span>
<span class="cp">#define dccp_pr_debug(format, a...)</span>
<span class="cp">#define dccp_pr_debug_cat(format, a...)</span>
<span class="cp">#define dccp_debug(format, a...)</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">inet_hashinfo</span> <span class="n">dccp_hashinfo</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">percpu_counter</span> <span class="n">dccp_orphan_count</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_time_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeo</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Set safe upper bounds for header and option length. Since Data Offset is 8</span>
<span class="cm"> *  bits (RFC 4340, sec. 5.1), the total header length can never be more than</span>
<span class="cm"> *  4 * 255 = 1020 bytes. The largest possible header length is 28 bytes (X=1):</span>
<span class="cm"> *    - DCCP-Response with ACK Subheader and 4 bytes of Service code      OR</span>
<span class="cm"> *    - DCCP-Reset    with ACK Subheader and 4 bytes of Reset Code fields</span>
<span class="cm"> *  Hence a safe upper bound for the maximum option length is 1020-28 = 992</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_DCCP_SPECIFIC_HEADER (255 * sizeof(uint32_t))</span>
<span class="cp">#define DCCP_MAX_PACKET_HDR 28</span>
<span class="cp">#define DCCP_MAX_OPT_LEN (MAX_DCCP_SPECIFIC_HEADER - DCCP_MAX_PACKET_HDR)</span>
<span class="cp">#define MAX_DCCP_HEADER (MAX_DCCP_SPECIFIC_HEADER + MAX_HEADER)</span>

<span class="cm">/* Upper bound for initial feature-negotiation overhead (padded to 32 bits) */</span>
<span class="cp">#define DCCP_FEATNEG_OVERHEAD	 (32 * sizeof(uint32_t))</span>

<span class="cp">#define DCCP_TIMEWAIT_LEN (60 * HZ) </span><span class="cm">/* how long to wait to destroy TIME-WAIT</span>
<span class="cm">				     * state, about 60 seconds */</span><span class="cp"></span>

<span class="cm">/* RFC 1122, 4.2.3.1 initial RTO value */</span>
<span class="cp">#define DCCP_TIMEOUT_INIT ((unsigned int)(3 * HZ))</span>

<span class="cm">/*</span>
<span class="cm"> * The maximum back-off value for retransmissions. This is needed for</span>
<span class="cm"> *  - retransmitting client-Requests (sec. 8.1.1),</span>
<span class="cm"> *  - retransmitting Close/CloseReq when closing (sec. 8.3),</span>
<span class="cm"> *  - feature-negotiation retransmission (sec. 6.6.3),</span>
<span class="cm"> *  - Acks in client-PARTOPEN state (sec. 8.1.5).</span>
<span class="cm"> */</span>
<span class="cp">#define DCCP_RTO_MAX ((unsigned int)(64 * HZ))</span>

<span class="cm">/*</span>
<span class="cm"> * RTT sampling: sanity bounds and fallback RTT value from RFC 4340, section 3.4</span>
<span class="cm"> */</span>
<span class="cp">#define DCCP_SANE_RTT_MIN	100</span>
<span class="cp">#define DCCP_FALLBACK_RTT	(USEC_PER_SEC / 5)</span>
<span class="cp">#define DCCP_SANE_RTT_MAX	(3 * USEC_PER_SEC)</span>

<span class="cm">/* sysctl variables for DCCP */</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">sysctl_dccp_request_retries</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">sysctl_dccp_retries1</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">sysctl_dccp_retries2</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">sysctl_dccp_tx_qlen</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">sysctl_dccp_sync_ratelimit</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *	48-bit sequence number arithmetic (signed and unsigned)</span>
<span class="cm"> */</span>
<span class="cp">#define INT48_MIN	  0x800000000000LL		</span><span class="cm">/* 2^47	    */</span><span class="cp"></span>
<span class="cp">#define UINT48_MAX	  0xFFFFFFFFFFFFLL		</span><span class="cm">/* 2^48 - 1 */</span><span class="cp"></span>
<span class="cp">#define COMPLEMENT48(x)	 (0x1000000000000LL - (x))	</span><span class="cm">/* 2^48 - x */</span><span class="cp"></span>
<span class="cp">#define TO_SIGNED48(x)	 (((x) &lt; INT48_MIN)? (x) : -COMPLEMENT48( (x)))</span>
<span class="cp">#define TO_UNSIGNED48(x) (((x) &gt;= 0)?	     (x) :  COMPLEMENT48(-(x)))</span>
<span class="cp">#define ADD48(a, b)	 (((a) + (b)) &amp; UINT48_MAX)</span>
<span class="cp">#define SUB48(a, b)	 ADD48((a), COMPLEMENT48(b))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_set_seqno</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">seqno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="n">UINT48_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_inc_seqno</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">ADD48</span><span class="p">(</span><span class="o">*</span><span class="n">seqno</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* signed mod-2^48 distance: pos. if seqno1 &lt; seqno2, neg. if seqno1 &gt; seqno2 */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">s64</span> <span class="nf">dccp_delta_seqno</span><span class="p">(</span><span class="k">const</span> <span class="n">u64</span> <span class="n">seqno1</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">seqno2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">SUB48</span><span class="p">(</span><span class="n">seqno2</span><span class="p">,</span> <span class="n">seqno1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TO_SIGNED48</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* is seq1 &lt; seq2 ? */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">before48</span><span class="p">(</span><span class="k">const</span> <span class="n">u64</span> <span class="n">seq1</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">seq2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">s64</span><span class="p">)((</span><span class="n">seq2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">seq1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* is seq1 &gt; seq2 ? */</span>
<span class="cp">#define after48(seq1, seq2)	before48(seq2, seq1)</span>

<span class="cm">/* is seq2 &lt;= seq1 &lt;= seq3 ? */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">between48</span><span class="p">(</span><span class="k">const</span> <span class="n">u64</span> <span class="n">seq1</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">seq2</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">seq3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">seq3</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">seq2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">seq1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">seq2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">max48</span><span class="p">(</span><span class="k">const</span> <span class="n">u64</span> <span class="n">seq1</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">seq2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">after48</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">)</span> <span class="o">?</span> <span class="n">seq1</span> <span class="o">:</span> <span class="n">seq2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dccp_loss_count - Approximate the number of lost data packets in a burst loss</span>
<span class="cm"> * @s1:  last known sequence number before the loss (&#39;hole&#39;)</span>
<span class="cm"> * @s2:  first sequence number seen after the &#39;hole&#39;</span>
<span class="cm"> * @ndp: NDP count on packet with sequence number @s2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">dccp_loss_count</span><span class="p">(</span><span class="k">const</span> <span class="n">u64</span> <span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">s2</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">ndp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">dccp_delta_seqno</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">delta</span> <span class="o">-=</span> <span class="n">ndp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">delta</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dccp_loss_free - Evaluate condition for data loss from RFC 4340, 7.7.1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">dccp_loss_free</span><span class="p">(</span><span class="k">const</span> <span class="n">u64</span> <span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">s2</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">ndp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dccp_loss_count</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">ndp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DCCP_MIB_NUM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DCCP_MIB_ACTIVEOPENS</span><span class="p">,</span>			<span class="cm">/* ActiveOpens */</span>
	<span class="n">DCCP_MIB_ESTABRESETS</span><span class="p">,</span>			<span class="cm">/* EstabResets */</span>
	<span class="n">DCCP_MIB_CURRESTAB</span><span class="p">,</span>			<span class="cm">/* CurrEstab */</span>
	<span class="n">DCCP_MIB_OUTSEGS</span><span class="p">,</span>			<span class="cm">/* OutSegs */</span>
	<span class="n">DCCP_MIB_OUTRSTS</span><span class="p">,</span>
	<span class="n">DCCP_MIB_ABORTONTIMEOUT</span><span class="p">,</span>
	<span class="n">DCCP_MIB_TIMEOUTS</span><span class="p">,</span>
	<span class="n">DCCP_MIB_ABORTFAILED</span><span class="p">,</span>
	<span class="n">DCCP_MIB_PASSIVEOPENS</span><span class="p">,</span>
	<span class="n">DCCP_MIB_ATTEMPTFAILS</span><span class="p">,</span>
	<span class="n">DCCP_MIB_OUTDATAGRAMS</span><span class="p">,</span>
	<span class="n">DCCP_MIB_INERRS</span><span class="p">,</span>
	<span class="n">DCCP_MIB_OPTMANDATORYERROR</span><span class="p">,</span>
	<span class="n">DCCP_MIB_INVALIDOPT</span><span class="p">,</span>
	<span class="n">__DCCP_MIB_MAX</span>
<span class="p">};</span>

<span class="cp">#define DCCP_MIB_MAX	__DCCP_MIB_MAX</span>
<span class="k">struct</span> <span class="n">dccp_mib</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">mibs</span><span class="p">[</span><span class="n">DCCP_MIB_MAX</span><span class="p">];</span>
<span class="p">};</span>

<span class="n">DECLARE_SNMP_STAT</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_mib</span><span class="p">,</span> <span class="n">dccp_statistics</span><span class="p">);</span>
<span class="cp">#define DCCP_INC_STATS(field)	    SNMP_INC_STATS(dccp_statistics, field)</span>
<span class="cp">#define DCCP_INC_STATS_BH(field)    SNMP_INC_STATS_BH(dccp_statistics, field)</span>
<span class="cp">#define DCCP_DEC_STATS(field)	    SNMP_DEC_STATS(dccp_statistics, field)</span>

<span class="cm">/*</span>
<span class="cm"> * 	Checksumming routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dccp_csum_coverage</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dccp_hdr</span><span class="o">*</span> <span class="n">dh</span> <span class="o">=</span> <span class="n">dccp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_cscov</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_doff</span> <span class="o">+</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_cscov</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_csum_outgoing</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">dccp_csum_coverage</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cov</span> <span class="o">&gt;=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">dccp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccph_cscov</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">skb_checksum</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">cov</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span><span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">cov</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_v4_send_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span>  <span class="n">dccp_retransmit_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_reqsk_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">rsk</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_send_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">seq</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">enum</span> <span class="n">dccp_pkt_type</span> <span class="n">pkt_type</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * TX Packet Dequeueing Interface</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span>		<span class="n">dccp_qpolicy_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">bool</span>		<span class="n">dccp_qpolicy_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>		<span class="n">dccp_qpolicy_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">dccp_qpolicy_top</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">dccp_qpolicy_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">bool</span>		<span class="n">dccp_qpolicy_param_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">param</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * TX Packet Output and TX Timers</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span>   <span class="n">dccp_write_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>   <span class="n">dccp_write_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>   <span class="n">dccp_flush_write_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">time_budget</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_init_xmit_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_clear_xmit_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet_csk_clear_xmit_timers</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dccp_sync_mss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pmtu</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dccp_packet_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span>  <span class="n">dccp_reqsk_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dccp_sock</span> <span class="k">const</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="k">const</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_v4_conn_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">dccp_create_openreq_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_v4_do_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">dccp_v4_request_recv_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">dccp_check_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">**</span><span class="n">prev</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_child_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_rcv_state_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dccp_hdr</span> <span class="o">*</span><span class="n">dh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_rcv_established</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">dccp_hdr</span> <span class="o">*</span><span class="n">dh</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_init_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">ctl_sock_initialized</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_destroy_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span>		<span class="n">dccp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">dccp_make_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">compat_dccp_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">compat_dccp_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addr_len</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>	   <span class="n">dccp_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">how</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">inet_dccp_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dccp_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			     <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_v4_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">addr_len</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dccp_ctl_make_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_send_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dccp_reset_codes</span> <span class="n">code</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>	   <span class="n">dccp_send_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">active</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>	   <span class="n">dccp_invalid_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">u32</span>	   <span class="n">dccp_sample_rtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_bad_service_code</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					<span class="k">const</span> <span class="n">__be32</span> <span class="n">service</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service</span> <span class="o">==</span> <span class="n">service</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">dccp_list_has_service</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_service_list</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dccp_skb_cb  -  DCCP per-packet control information</span>
<span class="cm"> * @dccpd_type: one of %dccp_pkt_type (or unknown)</span>
<span class="cm"> * @dccpd_ccval: CCVal field (5.1), see e.g. RFC 4342, 8.1</span>
<span class="cm"> * @dccpd_reset_code: one of %dccp_reset_codes</span>
<span class="cm"> * @dccpd_reset_data: Data1..3 fields (depend on @dccpd_reset_code)</span>
<span class="cm"> * @dccpd_opt_len: total length of all options (5.8) in the packet</span>
<span class="cm"> * @dccpd_seq: sequence number</span>
<span class="cm"> * @dccpd_ack_seq: acknowledgment number subheader field value</span>
<span class="cm"> * This is used for transmission as well as for reception.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dccp_skb_cb</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet_skb_parm</span>	<span class="n">h4</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
		<span class="k">struct</span> <span class="n">inet6_skb_parm</span>	<span class="n">h6</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">dccpd_type</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">dccpd_ccval</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">dccpd_reset_code</span><span class="p">,</span>
	      <span class="n">dccpd_reset_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__u16</span> <span class="n">dccpd_opt_len</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dccpd_seq</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dccpd_ack_seq</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DCCP_SKB_CB(__skb) ((struct dccp_skb_cb *)&amp;((__skb)-&gt;cb[0]))</span>

<span class="cm">/* RFC 4340, sec. 7.7 */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_non_data_packet</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">DCCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccpd_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_ACK</span>	 <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_CLOSE</span>	 <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_CLOSEREQ</span> <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_RESET</span>	 <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_SYNC</span>	 <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_SYNCACK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* RFC 4340, sec. 7.7 */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_data_packet</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">DCCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccpd_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_DATA</span>	 <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_DATAACK</span>  <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_REQUEST</span>  <span class="o">||</span>
	       <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_RESPONSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_packet_without_ack</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">DCCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccpd_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_DATA</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">DCCP_PKT_REQUEST</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DCCP_PKT_WITHOUT_ACK_SEQ (UINT48_MAX &lt;&lt; 2)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_hdr_set_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_hdr</span> <span class="o">*</span><span class="n">dh</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">gss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_hdr_ext</span> <span class="o">*</span><span class="n">dhx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dccp_hdr_ext</span> <span class="o">*</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dh</span> <span class="o">+</span>
							   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dh</span><span class="p">));</span>
	<span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_seq2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dh</span><span class="o">-&gt;</span><span class="n">dccph_seq</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">gss</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">);</span>
	<span class="n">dhx</span><span class="o">-&gt;</span><span class="n">dccph_seq_low</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">gss</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_hdr_set_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_hdr_ack_bits</span> <span class="o">*</span><span class="n">dhack</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u64</span> <span class="n">gsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dhack</span><span class="o">-&gt;</span><span class="n">dccph_reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dhack</span><span class="o">-&gt;</span><span class="n">dccph_ack_nr_high</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">gsr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">dhack</span><span class="o">-&gt;</span><span class="n">dccph_ack_nr_low</span>  <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">gsr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_update_gsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u64</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">after48</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_gsr</span><span class="p">))</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_gsr</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="cm">/* Sequence validity window depends on remote Sequence Window (7.5.1) */</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_swl</span> <span class="o">=</span> <span class="n">SUB48</span><span class="p">(</span><span class="n">ADD48</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_gsr</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_r_seq_win</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Adjust SWL so that it is not below ISR. In contrast to RFC 4340,</span>
<span class="cm">	 * 7.5.1 we perform this check beyond the initial handshake: W/W&#39; are</span>
<span class="cm">	 * always &gt; 32, so for the first W/W&#39; packets in the lifetime of a</span>
<span class="cm">	 * connection we always have to adjust SWL.</span>
<span class="cm">	 * A second reason why we are doing this is that the window depends on</span>
<span class="cm">	 * the feature-remote value of Sequence Window: nothing stops the peer</span>
<span class="cm">	 * from updating this value while we are busy adjusting SWL for the</span>
<span class="cm">	 * first W packets (we would have to count from scratch again then).</span>
<span class="cm">	 * Therefore it is safer to always make sure that the Sequence Window</span>
<span class="cm">	 * is not artificially extended by a peer who grows SWL downwards by</span>
<span class="cm">	 * continually updating the feature-remote Sequence-Window.</span>
<span class="cm">	 * If sequence numbers wrap it is bad luck. But that will take a while</span>
<span class="cm">	 * (48 bit), and this measure prevents Sequence-number attacks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">before48</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_swl</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_isr</span><span class="p">))</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_swl</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_isr</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_swh</span> <span class="o">=</span> <span class="n">ADD48</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_gsr</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_r_seq_win</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_update_gss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u64</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_gss</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="cm">/* Ack validity window depends on local Sequence Window value (7.5.1) */</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_awl</span> <span class="o">=</span> <span class="n">SUB48</span><span class="p">(</span><span class="n">ADD48</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_gss</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_l_seq_win</span><span class="p">);</span>
	<span class="cm">/* Adjust AWL so that it is not below ISS - see comment above for SWL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">before48</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_awl</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_iss</span><span class="p">))</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_awl</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_iss</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_awh</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dccps_gss</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_ackvec_pending</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ackvec</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">dccp_ackvec_is_empty</span><span class="p">(</span><span class="n">dccp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dccps_hc_rx_ackvec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_ack_pending</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dccp_ackvec_pending</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">||</span> <span class="n">inet_csk_ack_scheduled</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span>  <span class="n">dccp_feat_signal_nn_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">feat</span><span class="p">,</span> <span class="n">u64</span> <span class="n">nn_val</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">dccp_feat_finalise_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_sock</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">dccp_feat_server_ccid_dependencies</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_request_sock</span> <span class="o">*</span><span class="n">dreq</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">dccp_feat_insert_opts</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_sock</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dccp_request_sock</span><span class="o">*</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">dccp_feat_activate_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_feat_list_purge</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fn_list</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_insert_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_insert_options_rsk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dccp_request_sock</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_insert_option_elapsed_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">elapsed</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">u32</span> <span class="n">dccp_timestamp</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_timestamping_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_insert_option</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">option</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">dccp_sysctl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dccp_sysctl_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dccp_sysctl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dccp_sysctl_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* _DCCP_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
