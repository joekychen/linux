<!DOCTYPE html>
<html><head><title>joekychen/linux » net › openvswitch › datapath.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>datapath.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2007-2012 Nicira Networks.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General Public</span>
<span class="cm"> * License as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/jhash.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/genetlink.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_bridge.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/openvswitch.h&gt;</span>
<span class="cp">#include &lt;linux/rculist.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;net/genetlink.h&gt;</span>

<span class="cp">#include &quot;datapath.h&quot;</span>
<span class="cp">#include &quot;flow.h&quot;</span>
<span class="cp">#include &quot;vport-internal_dev.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * DOC: Locking:</span>
<span class="cm"> *</span>
<span class="cm"> * Writes to device state (add/remove datapath, port, set operations on vports,</span>
<span class="cm"> * etc.) are protected by RTNL.</span>
<span class="cm"> *</span>
<span class="cm"> * Writes to other state (flow table modifications, set miscellaneous datapath</span>
<span class="cm"> * parameters, etc.) are protected by genl_mutex.  The RTNL lock nests inside</span>
<span class="cm"> * genl_mutex.</span>
<span class="cm"> *</span>
<span class="cm"> * Reads are protected by RCU.</span>
<span class="cm"> *</span>
<span class="cm"> * There are a few special cases (mostly stats) that have their own</span>
<span class="cm"> * synchronization but they nest under all of above and don&#39;t interact with</span>
<span class="cm"> * each other.</span>
<span class="cm"> */</span>

<span class="cm">/* Global list of datapaths to enable dumping them all out.</span>
<span class="cm"> * Protected by genl_mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dps</span><span class="p">);</span>

<span class="cp">#define REHASH_FLOW_INTERVAL (10 * 60 * HZ)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rehash_flow_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">rehash_flow_wq</span><span class="p">,</span> <span class="n">rehash_flow_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">new_vport</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">vport_parms</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">queue_gso_packets</span><span class="p">(</span><span class="kt">int</span> <span class="n">dp_ifindex</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">dp_upcall_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">queue_userspace_packet</span><span class="p">(</span><span class="kt">int</span> <span class="n">dp_ifindex</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">dp_upcall_info</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* Must be called with rcu_read_lock, genl_mutex, or RTNL lock. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="nf">get_dp</span><span class="p">(</span><span class="kt">int</span> <span class="n">dp_ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">ovs_internal_dev_get_vport</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="p">)</span>
			<span class="n">dp</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">dp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">dp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be called with rcu_read_lock or RTNL lock. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ovs_dp_name</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">rcu_dereference_rtnl</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">OVSP_LOCAL</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dpifindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifindex</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">OVSP_LOCAL</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span>
		<span class="n">ifindex</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_ifindex</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ifindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ifindex</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_dp_rcu</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rcu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="n">ovs_flow_tbl_destroy</span><span class="p">((</span><span class="n">__force</span> <span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">free_percpu</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">stats_percpu</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called with RTNL lock and genl_lock. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="nf">new_vport</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">vport_parms</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="n">ovs_vport_add</span><span class="p">(</span><span class="n">parms</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">parms</span><span class="o">-&gt;</span><span class="n">dp</span><span class="p">;</span>

		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">],</span> <span class="n">vport</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">vport</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with RTNL lock. */</span>
<span class="kt">void</span> <span class="nf">ovs_dp_detach_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="cm">/* First drop references to device. */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Then destroy it. */</span>
	<span class="n">ovs_vport_del</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Must be called with rcu_read_lock. */</span>
<span class="kt">void</span> <span class="nf">ovs_dp_process_received_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dp_stats_percpu</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">stats_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">stats_percpu</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="cm">/* Extract flow from &#39;skb&#39; into &#39;key&#39;. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ovs_flow_extract</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Look up flow. */</span>
	<span class="n">flow</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_lookup</span><span class="p">(</span><span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">flow</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dp_upcall_info</span> <span class="n">upcall</span><span class="p">;</span>

		<span class="n">upcall</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_PACKET_CMD_MISS</span><span class="p">;</span>
		<span class="n">upcall</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">;</span>
		<span class="n">upcall</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">upcall</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">upcall_pid</span><span class="p">;</span>
		<span class="n">ovs_dp_upcall</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upcall</span><span class="p">);</span>
		<span class="n">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">stats_counter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_missed</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">OVS_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="p">;</span>

	<span class="n">stats_counter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_hit</span><span class="p">;</span>
	<span class="n">ovs_flow_used</span><span class="p">(</span><span class="n">OVS_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flow</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">ovs_execute_actions</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="cm">/* Update datapath statistics. */</span>
	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stats_counter</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="n">dp_packet_genl_family</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_GENERATE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">OVS_PACKET_FAMILY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">OVS_PACKET_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxattr</span> <span class="o">=</span> <span class="n">OVS_PACKET_ATTR_MAX</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">ovs_dp_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	      <span class="k">const</span> <span class="k">struct</span> <span class="n">dp_upcall_info</span> <span class="o">*</span><span class="n">upcall_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dp_stats_percpu</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dp_ifindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dp_ifindex</span> <span class="o">=</span> <span class="n">get_dpifindex</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp_ifindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">queue_userspace_packet</span><span class="p">(</span><span class="n">dp_ifindex</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">upcall_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">queue_gso_packets</span><span class="p">(</span><span class="n">dp_ifindex</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">upcall_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">stats_percpu</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_lost</span><span class="o">++</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_gso_packets</span><span class="p">(</span><span class="kt">int</span> <span class="n">dp_ifindex</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">dp_upcall_info</span> <span class="o">*</span><span class="n">upcall_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dp_upcall_info</span> <span class="n">later_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="n">later_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">segs</span><span class="p">,</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">segs</span> <span class="o">=</span> <span class="n">skb_gso_segment</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_HW_CSUM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Queue all of the segments. */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">segs</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">queue_userspace_packet</span><span class="p">(</span><span class="n">dp_ifindex</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">upcall_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="n">segs</span> <span class="o">&amp;&amp;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">&amp;</span> <span class="n">SKB_GSO_UDP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The initial flow key extracted by ovs_flow_extract()</span>
<span class="cm">			 * in this case is for a first fragment, so we need to</span>
<span class="cm">			 * properly mark later fragments.</span>
<span class="cm">			 */</span>
			<span class="n">later_key</span> <span class="o">=</span> <span class="o">*</span><span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
			<span class="n">later_key</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="n">OVS_FRAG_TYPE_LATER</span><span class="p">;</span>

			<span class="n">later_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">upcall_info</span><span class="p">;</span>
			<span class="n">later_info</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">later_key</span><span class="p">;</span>
			<span class="n">upcall_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">later_info</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>

	<span class="cm">/* Free all of the segments. */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">segs</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_userspace_packet</span><span class="p">(</span><span class="kt">int</span> <span class="n">dp_ifindex</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">dp_upcall_info</span> <span class="o">*</span><span class="n">upcall_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">upcall</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">user_skb</span><span class="p">;</span> <span class="cm">/* to be queued to userspace */</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">nskb</span> <span class="o">=</span> <span class="n">__vlan_put_tag</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">nskb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">nskb</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_attr_size</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">FLOW_BUFSIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OVS_PACKET_CMD_ACTION</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

	<span class="n">user_skb</span> <span class="o">=</span> <span class="n">genlmsg_new</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">upcall</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">user_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp_packet_genl_family</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">upcall</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span> <span class="o">=</span> <span class="n">dp_ifindex</span><span class="p">;</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">user_skb</span><span class="p">,</span> <span class="n">OVS_PACKET_ATTR_KEY</span><span class="p">);</span>
	<span class="n">ovs_flow_to_nlattrs</span><span class="p">(</span><span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">user_skb</span><span class="p">);</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">user_skb</span><span class="p">,</span> <span class="n">nla</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">)</span>
		<span class="n">nla_put_u64</span><span class="p">(</span><span class="n">user_skb</span><span class="p">,</span> <span class="n">OVS_PACKET_ATTR_USERDATA</span><span class="p">,</span>
			    <span class="n">nla_get_u64</span><span class="p">(</span><span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">));</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">__nla_reserve</span><span class="p">(</span><span class="n">user_skb</span><span class="p">,</span> <span class="n">OVS_PACKET_ATTR_PACKET</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">skb_copy_and_csum_dev</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">genlmsg_unicast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">user_skb</span><span class="p">,</span> <span class="n">upcall_info</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with genl_mutex. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flush_flows</span><span class="p">(</span><span class="kt">int</span> <span class="n">dp_ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">old_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">new_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">old_table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">new_table</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_alloc</span><span class="p">(</span><span class="n">TBL_MIN_BUCKETS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="n">new_table</span><span class="p">);</span>

	<span class="n">ovs_flow_tbl_deferred_destroy</span><span class="p">(</span><span class="n">old_table</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">validate_actions</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_sample</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[</span><span class="n">OVS_SAMPLE_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">probability</span><span class="p">,</span> <span class="o">*</span><span class="n">actions</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attrs</span><span class="p">));</span>
	<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">nla_type</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span> <span class="o">||</span> <span class="n">type</span> <span class="o">&gt;</span> <span class="n">OVS_SAMPLE_ATTR_MAX</span> <span class="o">||</span> <span class="n">attrs</span><span class="p">[</span><span class="n">type</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">attrs</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">probability</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">OVS_SAMPLE_ATTR_PROBABILITY</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probability</span> <span class="o">||</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">probability</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">actions</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">OVS_SAMPLE_ATTR_ACTIONS</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">actions</span> <span class="o">||</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NLA_HDRLEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">validate_actions</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_tp_port</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="o">*</span><span class="n">flow_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tp</span><span class="p">.</span><span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tp</span><span class="p">.</span><span class="n">dst</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">tp</span><span class="p">.</span><span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">tp</span><span class="p">.</span><span class="n">dst</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_set</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="o">*</span><span class="n">flow_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">ovs_key</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">key_type</span> <span class="o">=</span> <span class="n">nla_type</span><span class="p">(</span><span class="n">ovs_key</span><span class="p">);</span>

	<span class="cm">/* There can be only one key in a action */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_total_size</span><span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">ovs_key</span><span class="p">))</span> <span class="o">!=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">&gt;</span> <span class="n">OVS_KEY_ATTR_MAX</span> <span class="o">||</span>
	    <span class="n">nla_len</span><span class="p">(</span><span class="n">ovs_key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ovs_key_lens</span><span class="p">[</span><span class="n">key_type</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ovs_key_ipv4</span> <span class="o">*</span><span class="n">ipv4_key</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OVS_KEY_ATTR_PRIORITY</span>:
	<span class="k">case</span> <span class="n">OVS_KEY_ATTR_ETHERNET</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OVS_KEY_ATTR_IPV4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">src</span> <span class="o">||</span> <span class="o">!</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">dst</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ipv4_key</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">ovs_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_key</span><span class="o">-&gt;</span><span class="n">ipv4_proto</span> <span class="o">!=</span> <span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">proto</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_key</span><span class="o">-&gt;</span><span class="n">ipv4_frag</span> <span class="o">!=</span> <span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">frag</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OVS_KEY_ATTR_TCP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">validate_tp_port</span><span class="p">(</span><span class="n">flow_key</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">OVS_KEY_ATTR_UDP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">validate_tp_port</span><span class="p">(</span><span class="n">flow_key</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_userspace</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">userspace_policy</span><span class="p">[</span><span class="n">OVS_USERSPACE_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span>
		<span class="p">[</span><span class="n">OVS_USERSPACE_ATTR_PID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">OVS_USERSPACE_ATTR_USERDATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U64</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_USERSPACE_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">OVS_USERSPACE_ATTR_MAX</span><span class="p">,</span>
				 <span class="n">attr</span><span class="p">,</span> <span class="n">userspace_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_USERSPACE_ATTR_PID</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_USERSPACE_ATTR_PID</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_actions</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>  <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">SAMPLE_ACTION_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

	<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Expected argument lengths, (u32)-1 for variable length. */</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">action_lens</span><span class="p">[</span><span class="n">OVS_ACTION_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">OVS_ACTION_ATTR_OUTPUT</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			<span class="p">[</span><span class="n">OVS_ACTION_ATTR_USERSPACE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="p">[</span><span class="n">OVS_ACTION_ATTR_PUSH_VLAN</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_action_push_vlan</span><span class="p">),</span>
			<span class="p">[</span><span class="n">OVS_ACTION_ATTR_POP_VLAN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">[</span><span class="n">OVS_ACTION_ATTR_SET</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="p">[</span><span class="n">OVS_ACTION_ATTR_SAMPLE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
		<span class="p">};</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">ovs_action_push_vlan</span> <span class="o">*</span><span class="n">vlan</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">nla_type</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">OVS_ACTION_ATTR_MAX</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">action_lens</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">action_lens</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OVS_ACTION_ATTR_UNSPEC</span>:
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OVS_ACTION_ATTR_USERSPACE</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">validate_userspace</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OVS_ACTION_ATTR_OUTPUT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">DP_MAX_PORTS</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>


		<span class="k">case</span> <span class="n">OVS_ACTION_ATTR_POP_VLAN</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OVS_ACTION_ATTR_PUSH_VLAN</span>:
			<span class="n">vlan</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vlan</span><span class="o">-&gt;</span><span class="n">vlan_tpid</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vlan</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">htons</span><span class="p">(</span><span class="n">VLAN_TAG_PRESENT</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OVS_ACTION_ATTR_SET</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">validate_set</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OVS_ACTION_ATTR_SAMPLE</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">validate_sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">tcp_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">packet_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_packet_cmd_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow_actions</span> <span class="o">*</span><span class="n">acts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_PACKET</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_KEY</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_ACTIONS</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">nla_len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_PACKET</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_PACKET</span><span class="p">]);</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NET_IP_ALIGN</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_PACKET</span><span class="p">]),</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
	<span class="n">eth</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>

	<span class="cm">/* Normally, setting the skb &#39;protocol&#39; field would be handled by a</span>
<span class="cm">	 * call to eth_type_trans(), but it assumes there&#39;s a sending</span>
<span class="cm">	 * device, which we may not have. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1536</span><span class="p">)</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>

	<span class="cm">/* Build an sw_flow for sending this packet. */</span>
	<span class="n">flow</span> <span class="o">=</span> <span class="n">ovs_flow_alloc</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">flow</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_kfree_skb</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_flow_extract</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_flow_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_flow_metadata_from_nlattrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">priority</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">in_port</span><span class="p">,</span>
					     <span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_KEY</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_flow_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">validate_actions</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_ACTIONS</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_flow_free</span><span class="p">;</span>

	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">ovs_flow_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>

	<span class="n">acts</span> <span class="o">=</span> <span class="n">ovs_flow_actions_alloc</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_ACTIONS</span><span class="p">]);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">acts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">acts</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_flow_free</span><span class="p">;</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">sf_acts</span><span class="p">,</span> <span class="n">acts</span><span class="p">);</span>

	<span class="n">OVS_CB</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">priority</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">local_bh_disable</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_execute_actions</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="n">local_bh_enable</span><span class="p">();</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">ovs_flow_free</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="nl">err_flow_free:</span>
	<span class="n">ovs_flow_free</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
<span class="nl">err_kfree_skb:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">packet_policy</span><span class="p">[</span><span class="n">OVS_PACKET_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OVS_PACKET_ATTR_PACKET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_UNSPEC</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_PACKET_ATTR_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_PACKET_ATTR_ACTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="n">dp_packet_genl_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_PACKET_CMD_EXECUTE</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">packet_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_packet_cmd_execute</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_dp_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ovs_dp_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_flows</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_count</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_hit</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_missed</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_lost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dp_stats_percpu</span> <span class="o">*</span><span class="n">percpu_stats</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dp_stats_percpu</span> <span class="n">local_stats</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

		<span class="n">percpu_stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">stats_percpu</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">percpu_stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
			<span class="n">local_stats</span> <span class="o">=</span> <span class="o">*</span><span class="n">percpu_stats</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">percpu_stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_hit</span> <span class="o">+=</span> <span class="n">local_stats</span><span class="p">.</span><span class="n">n_hit</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_missed</span> <span class="o">+=</span> <span class="n">local_stats</span><span class="p">.</span><span class="n">n_missed</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_lost</span> <span class="o">+=</span> <span class="n">local_stats</span><span class="p">.</span><span class="n">n_lost</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">flow_policy</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_FLOW_ATTR_ACTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_FLOW_ATTR_CLEAR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_FLAG</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="n">dp_flow_genl_family</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_GENERATE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">OVS_FLOW_FAMILY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">OVS_FLOW_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxattr</span> <span class="o">=</span> <span class="n">OVS_FLOW_ATTR_MAX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">ovs_dp_flow_multicast_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">OVS_FLOW_MCGROUP</span>
<span class="p">};</span>

<span class="cm">/* Called with genl_lock. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_flow_cmd_fill_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">,</span> <span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">skb_orig_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sw_flow_actions</span> <span class="o">*</span><span class="n">sf_acts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_flow_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcp_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sf_acts</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">sf_acts</span><span class="p">,</span>
					    <span class="n">lockdep_genl_is_held</span><span class="p">());</span>

	<span class="n">ovs_header</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp_flow_genl_family</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovs_header</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span> <span class="o">=</span> <span class="n">get_dpifindex</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nla</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_flow_to_nlattrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nla</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">flow</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">n_packets</span> <span class="o">=</span> <span class="n">flow</span><span class="o">-&gt;</span><span class="n">packet_count</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="n">flow</span><span class="o">-&gt;</span><span class="n">byte_count</span><span class="p">;</span>
	<span class="n">tcp_flags</span> <span class="o">=</span> <span class="n">flow</span><span class="o">-&gt;</span><span class="n">tcp_flags</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u64</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_FLOW_ATTR_USED</span><span class="p">,</span> <span class="n">ovs_flow_used_time</span><span class="p">(</span><span class="n">used</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">n_packets</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_FLOW_ATTR_STATS</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_flow_stats</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_flags</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_FLOW_ATTR_TCP_FLAGS</span><span class="p">,</span> <span class="n">tcp_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="cm">/* If OVS_FLOW_ATTR_ACTIONS doesn&#39;t fit, skip dumping the actions if</span>
<span class="cm">	 * this is the first flow to be dumped into &#39;skb&#39;.  This is unusual for</span>
<span class="cm">	 * Netlink but individual action lists can be longer than</span>
<span class="cm">	 * NLMSG_GOODSIZE and thus entirely undumpable if we didn&#39;t do this.</span>
<span class="cm">	 * The userspace caller can always fetch the actions separately if it</span>
<span class="cm">	 * really wants them.  (Most userspace callers in fact don&#39;t care.)</span>
<span class="cm">	 *</span>
<span class="cm">	 * This can only fail for dump operations because the skb is always</span>
<span class="cm">	 * properly sized for single flows.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_FLOW_ATTR_ACTIONS</span><span class="p">,</span> <span class="n">sf_acts</span><span class="o">-&gt;</span><span class="n">actions_len</span><span class="p">,</span>
		      <span class="n">sf_acts</span><span class="o">-&gt;</span><span class="n">actions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">skb_orig_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ovs_header</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ovs_header</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ovs_flow_cmd_alloc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sw_flow_actions</span> <span class="o">*</span><span class="n">sf_acts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">sf_acts</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">sf_acts</span><span class="p">,</span>
					    <span class="n">lockdep_genl_is_held</span><span class="p">());</span>

	<span class="cm">/* OVS_FLOW_ATTR_KEY */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">FLOW_BUFSIZE</span><span class="p">);</span>
	<span class="cm">/* OVS_FLOW_ATTR_ACTIONS */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">sf_acts</span><span class="o">-&gt;</span><span class="n">actions_len</span><span class="p">);</span>
	<span class="cm">/* OVS_FLOW_ATTR_STATS */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_flow_stats</span><span class="p">));</span>
	<span class="cm">/* OVS_FLOW_ATTR_TCP_FLAGS */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* OVS_FLOW_ATTR_USED */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">genlmsg_new</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ovs_flow_cmd_build_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_alloc_info</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_fill_info</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_flow_cmd_new_or_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>

	<span class="cm">/* Extract key. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ovs_flow_from_nlattrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Validate actions. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_ACTIONS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">validate_actions</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_ACTIONS</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">genlhdr</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OVS_FLOW_CMD_NEW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">flow</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_lookup</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sw_flow_actions</span> <span class="o">*</span><span class="n">acts</span><span class="p">;</span>

		<span class="cm">/* Bail out if we&#39;re not allowed to create a new flow. */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">genlhdr</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OVS_FLOW_CMD_SET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Expand table, if necessary, to make room. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovs_flow_tbl_need_to_expand</span><span class="p">(</span><span class="n">table</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">new_table</span><span class="p">;</span>

			<span class="n">new_table</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_expand</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new_table</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="n">new_table</span><span class="p">);</span>
				<span class="n">ovs_flow_tbl_deferred_destroy</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
				<span class="n">table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Allocate flow. */</span>
		<span class="n">flow</span> <span class="o">=</span> <span class="n">ovs_flow_alloc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">flow</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">flow</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
		<span class="n">clear_stats</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>

		<span class="cm">/* Obtain actions. */</span>
		<span class="n">acts</span> <span class="o">=</span> <span class="n">ovs_flow_actions_alloc</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_ACTIONS</span><span class="p">]);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">acts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">acts</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_free_flow</span><span class="p">;</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">sf_acts</span><span class="p">,</span> <span class="n">acts</span><span class="p">);</span>

		<span class="cm">/* Put flow in bucket. */</span>
		<span class="n">flow</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">ovs_flow_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
		<span class="n">ovs_flow_tbl_insert</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>

		<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_build_info</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span>
						<span class="n">OVS_FLOW_CMD_NEW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We found a matching flow. */</span>
		<span class="k">struct</span> <span class="n">sw_flow_actions</span> <span class="o">*</span><span class="n">old_acts</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">acts_attrs</span><span class="p">;</span>

		<span class="cm">/* Bail out if we&#39;re not allowed to modify an existing flow.</span>
<span class="cm">		 * We accept NLM_F_CREATE in place of the intended NLM_F_EXCL</span>
<span class="cm">		 * because Generic Netlink treats the latter as a dump</span>
<span class="cm">		 * request.  We also accept NLM_F_EXCL in case that bug ever</span>
<span class="cm">		 * gets fixed.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">genlhdr</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OVS_FLOW_CMD_NEW</span> <span class="o">&amp;&amp;</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NLM_F_CREATE</span> <span class="o">|</span> <span class="n">NLM_F_EXCL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Update actions. */</span>
		<span class="n">old_acts</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">sf_acts</span><span class="p">,</span>
						     <span class="n">lockdep_genl_is_held</span><span class="p">());</span>
		<span class="n">acts_attrs</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_ACTIONS</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acts_attrs</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">old_acts</span><span class="o">-&gt;</span><span class="n">actions_len</span> <span class="o">!=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">acts_attrs</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">memcmp</span><span class="p">(</span><span class="n">old_acts</span><span class="o">-&gt;</span><span class="n">actions</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">acts_attrs</span><span class="p">),</span>
			  <span class="n">old_acts</span><span class="o">-&gt;</span><span class="n">actions_len</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sw_flow_actions</span> <span class="o">*</span><span class="n">new_acts</span><span class="p">;</span>

			<span class="n">new_acts</span> <span class="o">=</span> <span class="n">ovs_flow_actions_alloc</span><span class="p">(</span><span class="n">acts_attrs</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">new_acts</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new_acts</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">sf_acts</span><span class="p">,</span> <span class="n">new_acts</span><span class="p">);</span>
			<span class="n">ovs_flow_deferred_free_acts</span><span class="p">(</span><span class="n">old_acts</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_build_info</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
					       <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="n">OVS_FLOW_CMD_NEW</span><span class="p">);</span>

		<span class="cm">/* Clear stats. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_CLEAR</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">clear_stats</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
		<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
			   <span class="n">ovs_dp_flow_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netlink_set_err</span><span class="p">(</span><span class="n">init_net</span><span class="p">.</span><span class="n">genl_sock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">ovs_dp_flow_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_free_flow:</span>
	<span class="n">ovs_flow_free</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_flow_cmd_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_flow_from_nlattrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">flow</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_lookup</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flow</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_build_info</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="n">OVS_FLOW_CMD_NEW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_flow_cmd_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">flush_flows</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_flow_from_nlattrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_FLOW_ATTR_KEY</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">flow</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_lookup</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flow</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_alloc_info</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ovs_flow_tbl_remove</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_fill_info</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
				     <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OVS_FLOW_CMD_DEL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ovs_flow_deferred_free</span><span class="p">(</span><span class="n">flow</span><span class="p">);</span>

	<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
		    <span class="n">ovs_dp_flow_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_flow_cmd_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">genlmsg_data</span><span class="p">(</span><span class="n">nlmsg_data</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sw_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">obj</span><span class="p">;</span>

		<span class="n">bucket</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">flow</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_next</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bucket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flow</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ovs_flow_cmd_fill_info</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					   <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					   <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
					   <span class="n">OVS_FLOW_CMD_NEW</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">;</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="n">dp_flow_genl_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_FLOW_CMD_NEW</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">flow_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_new_or_set</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_FLOW_CMD_DEL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">flow_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_del</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_FLOW_CMD_GET</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		    <span class="cm">/* OK for unprivileged users. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">flow_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_get</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_dump</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_FLOW_CMD_SET</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">flow_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_flow_cmd_new_or_set</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">datapath_policy</span><span class="p">[</span><span class="n">OVS_DP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OVS_DP_ATTR_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NUL_STRING</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_DP_ATTR_UPCALL_PID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="n">dp_datapath_genl_family</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_GENERATE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">OVS_DATAPATH_FAMILY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">OVS_DATAPATH_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxattr</span> <span class="o">=</span> <span class="n">OVS_DP_ATTR_MAX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">ovs_dp_datapath_multicast_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">OVS_DATAPATH_MCGROUP</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_dp_cmd_fill_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_dp_stats</span> <span class="n">dp_stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ovs_header</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp_datapath_genl_family</span><span class="p">,</span>
				   <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovs_header</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span> <span class="o">=</span> <span class="n">get_dpifindex</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_DP_ATTR_NAME</span><span class="p">,</span> <span class="n">ovs_dp_name</span><span class="p">(</span><span class="n">dp</span><span class="p">));</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">get_dp_stats</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp_stats</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_DP_ATTR_STATS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_dp_stats</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dp_stats</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ovs_header</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ovs_header</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ovs_dp_cmd_build_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_fill_info</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with genl_mutex and optionally with RTNL lock also. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="nf">lookup_datapath</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_DP_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_DP_ATTR_NAME</span><span class="p">])</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">vport</span> <span class="o">=</span> <span class="n">ovs_vport_locate</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_DP_ATTR_NAME</span><span class="p">]));</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">vport</span> <span class="o">&amp;&amp;</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">==</span> <span class="n">OVSP_LOCAL</span> <span class="o">?</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">dp</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dp</span> <span class="o">?</span> <span class="n">dp</span> <span class="o">:</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_dp_cmd_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport_parms</span> <span class="n">parms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_DP_ATTR_NAME</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_DP_ATTR_UPCALL_PID</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_unlock_rtnl</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_module</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>

	<span class="cm">/* Allocate table. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="n">ovs_flow_tbl_alloc</span><span class="p">(</span><span class="n">TBL_MIN_BUCKETS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_dp</span><span class="p">;</span>

	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">stats_percpu</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">dp_stats_percpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">stats_percpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_destroy_table</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up our datapath device. */</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_DP_ATTR_NAME</span><span class="p">]);</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OVS_VPORT_TYPE_INTERNAL</span><span class="p">;</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="p">;</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">port_no</span> <span class="o">=</span> <span class="n">OVSP_LOCAL</span><span class="p">;</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">upcall_pid</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_DP_ATTR_UPCALL_PID</span><span class="p">]);</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="n">new_vport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">err_destroy_percpu</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_build_info</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
				      <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="n">OVS_DP_CMD_NEW</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_destroy_local_port</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dps</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
		    <span class="n">ovs_dp_datapath_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_destroy_local_port:</span>
	<span class="n">ovs_dp_detach_port</span><span class="p">(</span><span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">OVSP_LOCAL</span><span class="p">]));</span>
<span class="nl">err_destroy_percpu:</span>
	<span class="n">free_percpu</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">stats_percpu</span><span class="p">);</span>
<span class="nl">err_destroy_table:</span>
	<span class="n">ovs_flow_tbl_destroy</span><span class="p">(</span><span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">));</span>
<span class="nl">err_free_dp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<span class="nl">err_put_module:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="nl">err_unlock_rtnl:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_dp_cmd_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="o">*</span><span class="n">next_vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">lookup_datapath</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_build_info</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
				      <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="n">OVS_DP_CMD_DEL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">next_vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">!=</span> <span class="n">OVSP_LOCAL</span><span class="p">)</span>
			<span class="n">ovs_dp_detach_port</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">);</span>
	<span class="n">ovs_dp_detach_port</span><span class="p">(</span><span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">OVSP_LOCAL</span><span class="p">]));</span>

	<span class="cm">/* rtnl_unlock() will wait until all the references to devices that</span>
<span class="cm">	 * are pending unregistration have been dropped.  We do it here to</span>
<span class="cm">	 * ensure that any internal devices (which contain DP pointers) are</span>
<span class="cm">	 * fully destroyed before freeing the datapath.</span>
<span class="cm">	 */</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">destroy_dp_rcu</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
		    <span class="n">ovs_dp_datapath_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_dp_cmd_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">lookup_datapath</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_build_info</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
				      <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="n">OVS_DP_CMD_NEW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
		<span class="n">netlink_set_err</span><span class="p">(</span><span class="n">init_net</span><span class="p">.</span><span class="n">genl_sock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">ovs_dp_datapath_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
		    <span class="n">ovs_dp_datapath_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_dp_cmd_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">lookup_datapath</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_build_info</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
				      <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span> <span class="n">OVS_DP_CMD_NEW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_dp_cmd_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dps</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">skip</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ovs_dp_cmd_fill_info</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					 <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
					 <span class="n">OVS_DP_CMD_NEW</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="n">dp_datapath_genl_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_DP_CMD_NEW</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">datapath_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_new</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_DP_CMD_DEL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">datapath_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_del</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_DP_CMD_GET</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		    <span class="cm">/* OK for unprivileged users. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">datapath_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_get</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_dump</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_DP_CMD_SET</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">datapath_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_dp_cmd_set</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">vport_policy</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OVS_VPORT_ATTR_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NUL_STRING</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_VPORT_ATTR_STATS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_vport_stats</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_VPORT_ATTR_PORT_NO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_VPORT_ATTR_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_VPORT_ATTR_UPCALL_PID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">OVS_VPORT_ATTR_OPTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_family</span> <span class="n">dp_vport_genl_family</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">GENL_ID_GENERATE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">OVS_VPORT_FAMILY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">OVS_VPORT_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxattr</span> <span class="o">=</span> <span class="n">OVS_VPORT_ATTR_MAX</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="n">ovs_dp_vport_multicast_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">OVS_VPORT_MCGROUP</span>
<span class="p">};</span>

<span class="cm">/* Called with RTNL lock or RCU read lock. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_vport_cmd_fill_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_vport_stats</span> <span class="n">vport_stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ovs_header</span> <span class="o">=</span> <span class="n">genlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp_vport_genl_family</span><span class="p">,</span>
				 <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovs_header</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span> <span class="o">=</span> <span class="n">get_dpifindex</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">dp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_VPORT_ATTR_PORT_NO</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_VPORT_ATTR_TYPE</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_VPORT_ATTR_NAME</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_VPORT_ATTR_UPCALL_PID</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">upcall_pid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">ovs_vport_get_stats</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport_stats</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">OVS_VPORT_ATTR_STATS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_vport_stats</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">vport_stats</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_vport_get_options</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ovs_header</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">genlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ovs_header</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with RTNL lock or RCU read lock. */</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ovs_vport_cmd_build_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">NLMSG_DEFAULT_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_fill_info</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with RTNL lock or RCU read lock. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="nf">lookup_vport</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_NAME</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vport</span> <span class="o">=</span> <span class="n">ovs_vport_locate</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_NAME</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span> <span class="o">!=</span> <span class="n">get_dpifindex</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">dp</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">vport</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_PORT_NO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">port_no</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_PORT_NO</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_no</span> <span class="o">&gt;=</span> <span class="n">DP_MAX_PORTS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFBIG</span><span class="p">);</span>

		<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

		<span class="n">vport</span> <span class="o">=</span> <span class="n">rcu_dereference_rtnl</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port_no</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">vport</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_vport_cmd_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport_parms</span> <span class="n">parms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_NAME</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_TYPE</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_UPCALL_PID</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_PORT_NO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">port_no</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_PORT_NO</span><span class="p">]);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_no</span> <span class="o">&gt;=</span> <span class="n">DP_MAX_PORTS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

		<span class="n">vport</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port_no</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">port_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_no</span> <span class="o">&gt;=</span> <span class="n">DP_MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vport</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port_no</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">parms</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_NAME</span><span class="p">]);</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_TYPE</span><span class="p">]);</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_OPTIONS</span><span class="p">];</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="p">;</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">port_no</span> <span class="o">=</span> <span class="n">port_no</span><span class="p">;</span>
	<span class="n">parms</span><span class="p">.</span><span class="n">upcall_pid</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_UPCALL_PID</span><span class="p">]);</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="n">new_vport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_build_info</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span>
					 <span class="n">OVS_VPORT_CMD_NEW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
		<span class="n">ovs_dp_detach_port</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
		    <span class="n">ovs_dp_vport_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

<span class="nl">exit_unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_vport_cmd_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">vport</span> <span class="o">=</span> <span class="n">lookup_vport</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_TYPE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_TYPE</span><span class="p">])</span> <span class="o">!=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_OPTIONS</span><span class="p">])</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_vport_set_options</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_OPTIONS</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_UPCALL_PID</span><span class="p">])</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">upcall_pid</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">OVS_VPORT_ATTR_UPCALL_PID</span><span class="p">]);</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_build_info</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span>
					 <span class="n">OVS_VPORT_CMD_NEW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netlink_set_err</span><span class="p">(</span><span class="n">init_net</span><span class="p">.</span><span class="n">genl_sock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">ovs_dp_vport_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
		    <span class="n">ovs_dp_vport_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

<span class="nl">exit_unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_vport_cmd_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">vport</span> <span class="o">=</span> <span class="n">lookup_vport</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">==</span> <span class="n">OVSP_LOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_build_info</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span>
					 <span class="n">OVS_VPORT_CMD_DEL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="n">ovs_dp_detach_port</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">genl_notify</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">genl_info_net</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span>
		    <span class="n">ovs_dp_vport_multicast_group</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nlhdr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

<span class="nl">exit_unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_vport_cmd_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">genl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">a</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">userhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">vport</span> <span class="o">=</span> <span class="n">lookup_vport</span><span class="p">(</span><span class="n">ovs_header</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_build_info</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">,</span>
					 <span class="n">OVS_VPORT_CMD_NEW</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">genlmsg_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

<span class="nl">exit_unlock:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ovs_vport_cmd_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ovs_header</span> <span class="o">*</span><span class="n">ovs_header</span> <span class="o">=</span> <span class="n">genlmsg_data</span><span class="p">(</span><span class="n">nlmsg_data</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">get_dp</span><span class="p">(</span><span class="n">ovs_header</span><span class="o">-&gt;</span><span class="n">dp_ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port_no</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">port_no</span> <span class="o">&lt;</span> <span class="n">DP_MAX_PORTS</span><span class="p">;</span> <span class="n">port_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>

		<span class="n">vport</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port_no</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ovs_vport_cmd_fill_info</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					    <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">,</span>
					    <span class="n">OVS_VPORT_CMD_NEW</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_no</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rehash_flow_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">datapath</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">genl_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dps</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">old_table</span> <span class="o">=</span> <span class="n">genl_dereference</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">flow_table</span> <span class="o">*</span><span class="n">new_table</span><span class="p">;</span>

		<span class="n">new_table</span> <span class="o">=</span> <span class="n">ovs_flow_tbl_rehash</span><span class="p">(</span><span class="n">old_table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="n">new_table</span><span class="p">);</span>
			<span class="n">ovs_flow_tbl_deferred_destroy</span><span class="p">(</span><span class="n">old_table</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">genl_unlock</span><span class="p">();</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rehash_flow_wq</span><span class="p">,</span> <span class="n">REHASH_FLOW_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">genl_ops</span> <span class="n">dp_vport_genl_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_VPORT_CMD_NEW</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">vport_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_new</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_VPORT_CMD_DEL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">vport_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_del</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_VPORT_CMD_GET</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		    <span class="cm">/* OK for unprivileged users. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">vport_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_get</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dumpit</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_dump</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">OVS_VPORT_CMD_SET</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENL_ADMIN_PERM</span><span class="p">,</span> <span class="cm">/* Requires CAP_NET_ADMIN privilege. */</span>
	  <span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">vport_policy</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">doit</span> <span class="o">=</span> <span class="n">ovs_vport_cmd_set</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">genl_family_and_ops</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">genl_family</span> <span class="o">*</span><span class="n">family</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genl_multicast_group</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">genl_family_and_ops</span> <span class="n">dp_genl_families</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">dp_datapath_genl_family</span><span class="p">,</span>
	  <span class="n">dp_datapath_genl_ops</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dp_datapath_genl_ops</span><span class="p">),</span>
	  <span class="o">&amp;</span><span class="n">ovs_dp_datapath_multicast_group</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">dp_vport_genl_family</span><span class="p">,</span>
	  <span class="n">dp_vport_genl_ops</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dp_vport_genl_ops</span><span class="p">),</span>
	  <span class="o">&amp;</span><span class="n">ovs_dp_vport_multicast_group</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">dp_flow_genl_family</span><span class="p">,</span>
	  <span class="n">dp_flow_genl_ops</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dp_flow_genl_ops</span><span class="p">),</span>
	  <span class="o">&amp;</span><span class="n">ovs_dp_flow_multicast_group</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">dp_packet_genl_family</span><span class="p">,</span>
	  <span class="n">dp_packet_genl_ops</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dp_packet_genl_ops</span><span class="p">),</span>
	  <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dp_unregister_genl</span><span class="p">(</span><span class="kt">int</span> <span class="n">n_families</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_families</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">genl_unregister_family</span><span class="p">(</span><span class="n">dp_genl_families</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">family</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dp_register_genl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n_registered</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">n_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dp_genl_families</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">genl_family_and_ops</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dp_genl_families</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_family_with_ops</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span>
						    <span class="n">f</span><span class="o">-&gt;</span><span class="n">n_ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">n_registered</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">genl_register_mc_group</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">dp_unregister_genl</span><span class="p">(</span><span class="n">n_registered</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dummy_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ovs_skb_cb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dummy_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Open vSwitch switching datapath</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_flow_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ovs_vport_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_flow_exit</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ovs_dp_device_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_vport_exit</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dp_register_genl</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_unreg_notifier</span><span class="p">;</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rehash_flow_wq</span><span class="p">,</span> <span class="n">REHASH_FLOW_INTERVAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_unreg_notifier:</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ovs_dp_device_notifier</span><span class="p">);</span>
<span class="nl">error_vport_exit:</span>
	<span class="n">ovs_vport_exit</span><span class="p">();</span>
<span class="nl">error_flow_exit:</span>
	<span class="n">ovs_flow_exit</span><span class="p">();</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dp_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rehash_flow_wq</span><span class="p">);</span>
	<span class="n">rcu_barrier</span><span class="p">();</span>
	<span class="n">dp_unregister_genl</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dp_genl_families</span><span class="p">));</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ovs_dp_device_notifier</span><span class="p">);</span>
	<span class="n">ovs_vport_exit</span><span class="p">();</span>
	<span class="n">ovs_flow_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dp_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Open vSwitch switching datapath&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
