<!DOCTYPE html>
<html><head><title>joekychen/linux » net › key › af_key.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>af_key.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net/key/af_key.c	An implementation of PF_KEYv2 sockets.</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Maxim Giryaev	&lt;gem@asplinux.ru&gt;</span>
<span class="cm"> *		David S. Miller	&lt;davem@redhat.com&gt;</span>
<span class="cm"> *		Alexey Kuznetsov &lt;kuznet@ms2.inr.ac.ru&gt;</span>
<span class="cm"> *		Kunihiro Ishiguro &lt;kunihiro@ipinfusion.com&gt;</span>
<span class="cm"> *		Kazunori MIYAZAWA / USAGI Project &lt;miyazawa@linux-ipv6.org&gt;</span>
<span class="cm"> *		Derek Atkins &lt;derek@ihtfp.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/pfkeyv2.h&gt;</span>
<span class="cp">#include &lt;linux/ipsec.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/netns/generic.h&gt;</span>
<span class="cp">#include &lt;net/xfrm.h&gt;</span>

<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cp">#define _X2KEY(x) ((x) == XFRM_INF ? 0 : (x))</span>
<span class="cp">#define _KEY2X(x) ((x) == 0 ? XFRM_INF : (x))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pfkey_net_id</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="p">{</span>
	<span class="cm">/* List of all pfkey sockets. */</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">table</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">socks_nr</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pfkey_mutex</span><span class="p">);</span>

<span class="cp">#define DUMMY_MARK 0</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_mark</span> <span class="n">dummy_mark</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="p">{</span>
	<span class="cm">/* struct sock must be the first member of struct pfkey_sock */</span>
	<span class="k">struct</span> <span class="n">sock</span>	<span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">registered</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">promisc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">uint8_t</span>		<span class="n">msg_version</span><span class="p">;</span>
		<span class="kt">uint32_t</span>	<span class="n">msg_pid</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">dump</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
		<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfrm_policy_walk</span>	<span class="n">policy</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">xfrm_state_walk</span>	<span class="n">state</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">dump</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="nf">pfkey_sk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_can_dump</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pfkey_terminate_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">done</span><span class="p">(</span><span class="n">pfk</span><span class="p">);</span>
		<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pfkey_sock_destruct</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>

	<span class="n">pfkey_terminate_dump</span><span class="p">(</span><span class="n">pfkey_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Attempt to release alive pfkey socket: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">));</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">socks_nr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">pfkey_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pfkey_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_mutex</span><span class="p">);</span>
	<span class="n">sk_add_node_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pfkey_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_mutex</span><span class="p">);</span>
	<span class="n">sk_del_node_init_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">key_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="s">&quot;KEY&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_RAW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">PF_KEY_V2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_KEY</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pfkey_ops</span><span class="p">;</span>
	<span class="n">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">=</span> <span class="n">PF_KEY</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_destruct</span> <span class="o">=</span> <span class="n">pfkey_sock_destruct</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">socks_nr</span><span class="p">);</span>

	<span class="n">pfkey_insert</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pfkey_remove</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sock_orphan</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">);</span>

	<span class="n">synchronize_rcu</span><span class="p">();</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_broadcast_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb2</span><span class="p">,</span>
			       <span class="n">gfp_t</span> <span class="n">allocation</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">skb2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">allocation</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">skb2</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">skb2</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_orphan</span><span class="p">(</span><span class="o">*</span><span class="n">skb2</span><span class="p">);</span>
			<span class="n">skb_set_owner_r</span><span class="p">(</span><span class="o">*</span><span class="n">skb2</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">skb2</span><span class="p">);</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">skb2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="o">*</span><span class="n">skb2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send SKB to all pfkey sockets matching selected criteria.  */</span>
<span class="cp">#define BROADCAST_ALL		0</span>
<span class="cp">#define BROADCAST_ONE		1</span>
<span class="cp">#define BROADCAST_REGISTERED	2</span>
<span class="cp">#define BROADCAST_PROMISC_ONLY	4</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_broadcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">allocation</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">broadcast_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">one_sk</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="cm">/* XXX Do we need something like netlink_overrun?  I think</span>
<span class="cm">	 * XXX PF_KEY socket apps will not mind current behavior.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sk_for_each_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">pfkey_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">err2</span><span class="p">;</span>

		<span class="cm">/* Yes, it means that if you are meant to receive this</span>
<span class="cm">		 * pfkey message you receive it twice as promiscuous</span>
<span class="cm">		 * socket.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">)</span>
			<span class="n">pfkey_broadcast_one</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb2</span><span class="p">,</span> <span class="n">allocation</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="cm">/* the exact target will be processed later */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="n">one_sk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">broadcast_flags</span> <span class="o">!=</span> <span class="n">BROADCAST_ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">broadcast_flags</span> <span class="o">&amp;</span> <span class="n">BROADCAST_PROMISC_ONLY</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">broadcast_flags</span> <span class="o">&amp;</span> <span class="n">BROADCAST_REGISTERED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">broadcast_flags</span> <span class="o">&amp;</span> <span class="n">BROADCAST_ONE</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err2</span> <span class="o">=</span> <span class="n">pfkey_broadcast_one</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb2</span><span class="p">,</span> <span class="n">allocation</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="cm">/* Error is cleare after succecful sending to at least one</span>
<span class="cm">		 * registered KM */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">broadcast_flags</span> <span class="o">&amp;</span> <span class="n">BROADCAST_REGISTERED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">one_sk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pfkey_broadcast_one</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb2</span><span class="p">,</span> <span class="n">allocation</span><span class="p">,</span> <span class="n">one_sk</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_do_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pfk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfkey_can_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">));</span>
		<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pfkey_terminate_dump</span><span class="p">(</span><span class="n">pfk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pfkey_hdr_dup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="o">*</span><span class="n">orig</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_error</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">orig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="cm">/* Woe be to the platform trying to support PFKEY yet</span>
<span class="cm">	 * having normal errnos outside the 1-255 range, inclusive.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">ERESTARTSYS</span> <span class="o">||</span>
	    <span class="n">err</span> <span class="o">==</span> <span class="n">ERESTARTNOHAND</span> <span class="o">||</span>
	    <span class="n">err</span> <span class="o">==</span> <span class="n">ERESTARTNOINTR</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">EINTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">pfkey_hdr_dup</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">orig</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">/</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">));</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">sadb_ext_min_len</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SADB_EXT_RESERVED</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_EXT_SA</span><span class="p">]</span>			<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_LIFETIME_CURRENT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_LIFETIME_HARD</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_LIFETIME_SOFT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_ADDRESS_PROXY</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_KEY_AUTH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_KEY_ENCRYPT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_IDENTITY_SRC</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_ident</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_IDENTITY_DST</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_ident</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_SENSITIVITY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sens</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_PROPOSAL</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_SUPPORTED_AUTH</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_supported</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_SUPPORTED_ENCRYPT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_supported</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_EXT_SPIRANGE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_spirange</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_KMPRIVATE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_kmprivate</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_SA2</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sa2</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_TYPE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_type</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_SPORT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_DPORT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_OA</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_SEC_CTX</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">),</span>
	<span class="p">[</span><span class="n">SADB_X_EXT_KMADDRESS</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_kmaddress</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Verify sadb_address_{len,prefixlen} against sa_family.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_address_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin6</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sin</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">!=</span> <span class="n">len</span> <span class="o">||</span>
		    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sin6</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">!=</span> <span class="n">len</span> <span class="o">||</span>
		    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="cm">/* It is user using kernel to keep track of security</span>
<span class="cm">		 * associations for another protocol, such as</span>
<span class="cm">		 * OSPF/RSVP/RIPV2/MIP.  It is user&#39;s job to verify</span>
<span class="cm">		 * lengths.</span>
<span class="cm">		 *</span>
<span class="cm">		 * XXX Actually, association/policy database is not yet</span>
<span class="cm">		 * XXX able to cope with arbitrary sockaddr families.</span>
<span class="cm">		 * XXX When it can, remove this -EINVAL.  -DaveM</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pfkey_sec_ctx_len</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_len</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">verify_sec_ctx_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">pfkey_sec_ctx_len</span><span class="p">(</span><span class="n">sec_ctx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_len</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="nf">pfkey_sadb2xfrm_user_sec_ctx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctx_size</span> <span class="o">=</span> <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_len</span><span class="p">;</span>

	<span class="n">uctx</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctx</span><span class="p">)</span><span class="o">+</span><span class="n">ctx_size</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uctx</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">pfkey_sec_ctx_len</span><span class="p">(</span><span class="n">sec_ctx</span><span class="p">);</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">exttype</span> <span class="o">=</span> <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_exttype</span><span class="p">;</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_doi</span> <span class="o">=</span> <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_doi</span><span class="p">;</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_alg</span> <span class="o">=</span> <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_alg</span><span class="p">;</span>
	<span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span> <span class="o">=</span> <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">uctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sec_ctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">uctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uctx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">present_and_same_family</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">s_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">d_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span> <span class="o">||</span> <span class="o">!</span><span class="n">dst</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">src</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">d_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">dst</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">d_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">AF_INET</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">s_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">AF_INET6</span>
<span class="cp">#endif</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_exthdrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_ext</span> <span class="o">*</span><span class="n">ehdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_ext</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">ext_type</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ext_len</span><span class="p">;</span>

		<span class="n">ext_len</span>  <span class="o">=</span> <span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">sadb_ext_len</span><span class="p">;</span>
		<span class="n">ext_len</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">ext_type</span> <span class="o">=</span> <span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">sadb_ext_type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ext_len</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">||</span>
		    <span class="n">ext_type</span> <span class="o">==</span> <span class="n">SADB_EXT_RESERVED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext_type</span> <span class="o">&lt;=</span> <span class="n">SADB_EXT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sadb_ext_min_len</span><span class="p">[</span><span class="n">ext_type</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext_len</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">ext_type</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">SADB_EXT_ADDRESS_SRC</span> <span class="o">||</span>
			    <span class="n">ext_type</span> <span class="o">==</span> <span class="n">SADB_EXT_ADDRESS_DST</span> <span class="o">||</span>
			    <span class="n">ext_type</span> <span class="o">==</span> <span class="n">SADB_EXT_ADDRESS_PROXY</span> <span class="o">||</span>
			    <span class="n">ext_type</span> <span class="o">==</span> <span class="n">SADB_X_EXT_NAT_T_OA</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">verify_address_len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">SADB_X_EXT_SEC_CTX</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">verify_sec_ctx_len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ext_hdrs</span><span class="p">[</span><span class="n">ext_type</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span>   <span class="o">+=</span> <span class="n">ext_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">ext_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint16_t</span>
<span class="nf">pfkey_satype2proto</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">satype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">satype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SADB_SATYPE_UNSPEC</span>:
		<span class="k">return</span> <span class="n">IPSEC_PROTO_ANY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SADB_SATYPE_AH</span>:
		<span class="k">return</span> <span class="n">IPPROTO_AH</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SADB_SATYPE_ESP</span>:
		<span class="k">return</span> <span class="n">IPPROTO_ESP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SADB_X_SATYPE_IPCOMP</span>:
		<span class="k">return</span> <span class="n">IPPROTO_COMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* NOTREACHED */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">pfkey_proto2satype</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPPROTO_AH</span>:
		<span class="k">return</span> <span class="n">SADB_SATYPE_AH</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPPROTO_ESP</span>:
		<span class="k">return</span> <span class="n">SADB_SATYPE_ESP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPPROTO_COMP</span>:
		<span class="k">return</span> <span class="n">SADB_X_SATYPE_IPCOMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* NOTREACHED */</span>
<span class="p">}</span>

<span class="cm">/* BTW, this scheme means that there is no way with PFKEY2 sockets to</span>
<span class="cm"> * say specifically &#39;just raw sockets&#39; as we encode them as 255.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">pfkey_proto_to_xfrm</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">proto</span> <span class="o">==</span> <span class="n">IPSEC_PROTO_ANY</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">proto</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">pfkey_proto_from_xfrm</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">proto</span> <span class="o">?</span> <span class="n">proto</span> <span class="o">:</span> <span class="n">IPSEC_PROTO_ANY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">sa_family_t</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">pfkey_sockaddr_extract</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">xaddr</span><span class="o">-&gt;</span><span class="n">a4</span> <span class="o">=</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">AF_INET</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">xaddr</span><span class="o">-&gt;</span><span class="n">a6</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">AF_INET6</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pfkey_sockaddr_extract</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				      <span class="n">xaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span>  <span class="n">xfrm_state</span> <span class="o">*</span><span class="nf">pfkey_xfrm_state_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_sa</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">proto</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">family</span><span class="p">;</span>
	<span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_SA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_satype2proto</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* sadb_address_len should be checked by caller */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">family</span> <span class="o">=</span> <span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">xaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">xaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">xaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xfrm_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">DUMMY_MARK</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_spi</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">family</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PFKEY_ALIGN8(a) (1 + (((a) - 1) | (8 - 1)))</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pfkey_sockaddr_size</span><span class="p">(</span><span class="n">sa_family_t</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PFKEY_ALIGN8</span><span class="p">(</span><span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">family</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pfkey_mode_from_xfrm</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MODE_TRANSPORT</span>:
		<span class="k">return</span> <span class="n">IPSEC_MODE_TRANSPORT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MODE_TUNNEL</span>:
		<span class="k">return</span> <span class="n">IPSEC_MODE_TUNNEL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MODE_BEET</span>:
		<span class="k">return</span> <span class="n">IPSEC_MODE_BEET</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pfkey_mode_to_xfrm</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPSEC_MODE_ANY</span>:	<span class="cm">/*XXX*/</span>
	<span class="k">case</span> <span class="n">IPSEC_MODE_TRANSPORT</span>:
		<span class="k">return</span> <span class="n">XFRM_MODE_TRANSPORT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPSEC_MODE_TUNNEL</span>:
		<span class="k">return</span> <span class="n">XFRM_MODE_TUNNEL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPSEC_MODE_BEET</span>:
		<span class="k">return</span> <span class="n">XFRM_MODE_BEET</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pfkey_sockaddr_fill</span><span class="p">(</span><span class="k">const</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
	    <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">;</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">xaddr</span><span class="o">-&gt;</span><span class="n">a4</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_zero</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_zero</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">32</span><span class="p">;</span>
	    <span class="p">}</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
	    <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">;</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_flowinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="p">)</span><span class="n">xaddr</span><span class="o">-&gt;</span><span class="n">a6</span><span class="p">;</span>
		<span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">128</span><span class="p">;</span>
	    <span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">__pfkey_xfrm_state2msg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">add_keys</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_sa</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="n">lifetime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sa2</span> <span class="o">*</span><span class="n">sa2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">xfrm_ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctx_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">auth_key_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encrypt_key_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sockaddr_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_encap_tmpl</span> <span class="o">*</span><span class="n">natt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* address family check */</span>
	<span class="n">sockaddr_size</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_size</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sockaddr_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* base, SA, (lifetime (HSC),) address(SD), (address(P),)</span>
<span class="cm">	   key(AE), (identity(SD),) (sensitivity)&gt; */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">hsc</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">hsc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>
				<span class="n">sockaddr_size</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sa2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">xfrm_ctx</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctx_size</span> <span class="o">=</span> <span class="n">PFKEY_ALIGN8</span><span class="p">(</span><span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* identity &amp; sensitivity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_addr_cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">sockaddr_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_keys</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">auth_key_size</span> <span class="o">=</span>
				<span class="n">PFKEY_ALIGN8</span><span class="p">((</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">auth_key_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">encrypt_key_size</span> <span class="o">=</span>
				<span class="n">PFKEY_ALIGN8</span><span class="p">((</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">encrypt_key_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">)</span>
		<span class="n">natt</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">natt</span> <span class="o">&amp;&amp;</span> <span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_type</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span>  <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>

	<span class="cm">/* call should fill header later */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>	<span class="cm">/* XXX do we need this ? */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>

	<span class="cm">/* sa */</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span><span class="p">));</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_SA</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_spi</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_replay</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">replay_window</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_STATE_VALID</span>:
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_state</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">dying</span> <span class="o">?</span>
			<span class="n">SADB_SASTATE_DYING</span> <span class="o">:</span> <span class="n">SADB_SASTATE_MATURE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_STATE_ACQ</span>:
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_state</span> <span class="o">=</span> <span class="n">SADB_SASTATE_LARVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_state</span> <span class="o">=</span> <span class="n">SADB_SASTATE_DEAD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byname</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span> <span class="o">=</span> <span class="n">a</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">xfrm_ealg_get_byname</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span> <span class="o">=</span> <span class="n">a</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* KAME compatible: sadb_sa_encrypt is overloaded with calg id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">xfrm_calg_get_byname</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span> <span class="o">=</span> <span class="n">a</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFRM_STATE_NOECN</span><span class="p">)</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">|=</span> <span class="n">SADB_SAFLAGS_NOECN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFRM_STATE_DECAP_DSCP</span><span class="p">)</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">|=</span> <span class="n">SADB_SAFLAGS_DECAP_DSCP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFRM_STATE_NOPMTUDISC</span><span class="p">)</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">|=</span> <span class="n">SADB_SAFLAGS_NOPMTUDISC</span><span class="p">;</span>

	<span class="cm">/* hard time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lifetime</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
							     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">));</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_len</span> <span class="o">=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_LIFETIME_HARD</span><span class="p">;</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span> <span class="o">=</span>  <span class="n">_X2KEY</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_packet_limit</span><span class="p">);</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span> <span class="o">=</span> <span class="n">_X2KEY</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_byte_limit</span><span class="p">);</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_add_expires_seconds</span><span class="p">;</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_use_expires_seconds</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* soft time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsc</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lifetime</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
							     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">));</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_len</span> <span class="o">=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_LIFETIME_SOFT</span><span class="p">;</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span> <span class="o">=</span>  <span class="n">_X2KEY</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_packet_limit</span><span class="p">);</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span> <span class="o">=</span> <span class="n">_X2KEY</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_byte_limit</span><span class="p">);</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_add_expires_seconds</span><span class="p">;</span>
		<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_use_expires_seconds</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* current time */</span>
	<span class="n">lifetime</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">));</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_LIFETIME_CURRENT</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">add_time</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">use_time</span><span class="p">;</span>
	<span class="cm">/* src address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_SRC</span><span class="p">;</span>
	<span class="cm">/* &quot;if the ports are non-zero, then the sadb_address_proto field,</span>
<span class="cm">	   normally zero, MUST be filled in with the transport</span>
<span class="cm">	   protocol&#39;s number.&quot; - RFC2367 */</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* dst address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_DST</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_addr_cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span>
			  <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_PROXY</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span>
			<span class="n">pfkey_proto_from_xfrm</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">prefixlen_s</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">sport</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* auth key */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add_keys</span> <span class="o">&amp;&amp;</span> <span class="n">auth_key_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">)</span><span class="o">+</span><span class="n">auth_key_size</span><span class="p">);</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">auth_key_size</span><span class="p">)</span> <span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_KEY_AUTH</span><span class="p">;</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="p">;</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* encrypt key */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add_keys</span> <span class="o">&amp;&amp;</span> <span class="n">encrypt_key_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">)</span><span class="o">+</span><span class="n">encrypt_key_size</span><span class="p">);</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">encrypt_key_size</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_KEY_ENCRYPT</span><span class="p">;</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="p">;</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* sa */</span>
	<span class="n">sa2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sa2</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sa2</span><span class="p">));</span>
	<span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sa2</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_SA2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">=</span> <span class="n">pfkey_mode_from_xfrm</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_reqid</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">reqid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">natt</span> <span class="o">&amp;&amp;</span> <span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sadb_x_nat_t_type</span> <span class="o">*</span><span class="n">n_type</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span> <span class="o">*</span><span class="n">n_port</span><span class="p">;</span>

		<span class="cm">/* type */</span>
		<span class="n">n_type</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_type</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n_type</span><span class="p">));</span>
		<span class="n">n_type</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_type_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n_type</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">n_type</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_type_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_NAT_T_TYPE</span><span class="p">;</span>
		<span class="n">n_type</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_type_type</span> <span class="o">=</span> <span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_type</span><span class="p">;</span>
		<span class="n">n_type</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_type_reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n_type</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_type_reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n_type</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_type_reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* source port */</span>
		<span class="n">n_port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">));</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_NAT_T_SPORT</span><span class="p">;</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_port</span> <span class="o">=</span> <span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_sport</span><span class="p">;</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* dest port */</span>
		<span class="n">n_port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">));</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_NAT_T_DPORT</span><span class="p">;</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_port</span> <span class="o">=</span> <span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_dport</span><span class="p">;</span>
		<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* security context */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx_size</span><span class="p">);</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_len</span> <span class="o">=</span>
		  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx_size</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_SEC_CTX</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_doi</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_doi</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_alg</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_alg</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_len</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sec_ctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_str</span><span class="p">,</span>
		       <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">pfkey_xfrm_state2msg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">__pfkey_xfrm_state2msg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">pfkey_xfrm_state2msg_expire</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span>
							  <span class="kt">int</span> <span class="n">hsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__pfkey_xfrm_state2msg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hsc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span> <span class="nf">pfkey_msg2xfrm_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
						<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="n">lifetime</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_sa</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>


	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_SA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sa</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">present_and_same_family</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">==</span> <span class="n">SADB_SATYPE_ESP</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_KEY_ENCRYPT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">==</span> <span class="n">SADB_SATYPE_AH</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_KEY_AUTH</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_LIFETIME_HARD</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span>
	    <span class="o">!!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_LIFETIME_SOFT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_satype2proto</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* default error is no buffer space */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="cm">/* RFC2367:</span>

<span class="cm">   Only SADB_SASTATE_MATURE SAs may be submitted in an SADB_ADD message.</span>
<span class="cm">   SADB_SASTATE_LARVAL SAs are created by SADB_GETSPI and it is not</span>
<span class="cm">   sensible to add a new SA in the DYING or SADB_SASTATE_DEAD state.</span>
<span class="cm">   Therefore, the sadb_sa_state field of all submitted SAs MUST be</span>
<span class="cm">   SADB_SASTATE_MATURE and the kernel MUST return an error if this is</span>
<span class="cm">   not true.</span>

<span class="cm">	   However, KAME setkey always uses SADB_SASTATE_LARVAL.</span>
<span class="cm">	   Hence, we have to _ignore_ sadb_sa_state, which is also reasonable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span> <span class="o">&gt;</span> <span class="n">SADB_AALG_MAX</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">==</span> <span class="n">SADB_X_SATYPE_IPCOMP</span> <span class="o">&amp;&amp;</span>
	     <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span> <span class="o">&gt;</span> <span class="n">SADB_X_CALG_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span> <span class="o">&gt;</span> <span class="n">SADB_EALG_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_KEY_AUTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span> <span class="o">!=</span> <span class="n">SADB_X_AALG_NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_KEY_ENCRYPT</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span> <span class="o">!=</span> <span class="n">SADB_EALG_NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_state_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>

	<span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_spi</span><span class="p">;</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">replay_window</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_replay</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">&amp;</span> <span class="n">SADB_SAFLAGS_NOECN</span><span class="p">)</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XFRM_STATE_NOECN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">&amp;</span> <span class="n">SADB_SAFLAGS_DECAP_DSCP</span><span class="p">)</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XFRM_STATE_DECAP_DSCP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">&amp;</span> <span class="n">SADB_SAFLAGS_NOPMTUDISC</span><span class="p">)</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XFRM_STATE_NOPMTUDISC</span><span class="p">;</span>

	<span class="n">lifetime</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_LIFETIME_HARD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lifetime</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_packet_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_byte_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_add_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_use_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lifetime</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_LIFETIME_SOFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lifetime</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_packet_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_byte_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_add_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_use_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sec_ctx</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_SEC_CTX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span> <span class="o">=</span> <span class="n">pfkey_sadb2xfrm_user_sec_ctx</span><span class="p">(</span><span class="n">sec_ctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uctx</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">security_xfrm_state_alloc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">uctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_KEY_AUTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">keysize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byid</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="n">keysize</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">)</span> <span class="o">+</span> <span class="n">keysize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span> <span class="n">key</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keysize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">alg_trunc_len</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">icv_truncbits</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">aalgo</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span><span class="p">;</span>
		<span class="cm">/* x-&gt;algo.flags = sa-&gt;sadb_sa_flags; */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">==</span> <span class="n">SADB_X_SATYPE_IPCOMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">xfrm_calg_get_byid</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">calg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">calgo</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">keysize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">xfrm_ealg_get_byid</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_key</span><span class="o">*</span><span class="p">)</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_KEY_ENCRYPT</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
				<span class="n">keysize</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">)</span> <span class="o">+</span> <span class="n">keysize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">sadb_key_bits</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">alg_key</span><span class="p">,</span> <span class="n">key</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keysize</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">ealgo</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* x-&gt;algo.flags = sa-&gt;sadb_sa_flags; */</span>

	<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="p">)</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
						    <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="p">)</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				  <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_SA2</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_sa2</span> <span class="o">*</span><span class="n">sa2</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_SA2</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">pfkey_mode_to_xfrm</span><span class="p">(</span><span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_reqid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_PROXY</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_PROXY</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

		<span class="cm">/* Nobody uses this, but we try. */</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">saddr</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">prefixlen_s</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span><span class="p">)</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_TYPE</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_nat_t_type</span><span class="o">*</span> <span class="n">n_type</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">xfrm_encap_tmpl</span> <span class="o">*</span><span class="n">natt</span><span class="p">;</span>

		<span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">natt</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">;</span>
		<span class="n">n_type</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_TYPE</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_type</span> <span class="o">=</span> <span class="n">n_type</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_type_type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_SPORT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span> <span class="o">*</span><span class="n">n_port</span> <span class="o">=</span>
				<span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_SPORT</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_sport</span> <span class="o">=</span> <span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_port</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_DPORT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span> <span class="o">*</span><span class="n">n_port</span> <span class="o">=</span>
				<span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_NAT_T_DPORT</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_dport</span> <span class="o">=</span> <span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_port</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_oa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_oa</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_init_state</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFRM_STATE_DEAD</span><span class="p">;</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_reserved</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_getspi</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">resp_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sa2</span> <span class="o">*</span><span class="n">sa2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="o">*</span><span class="n">daddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">out_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_spirange</span> <span class="o">*</span><span class="n">range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">min_spi</span><span class="p">,</span> <span class="n">max_spi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reqid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">proto</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">family</span><span class="p">;</span>
	<span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">xsaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">xdaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">present_and_same_family</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_satype2proto</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sa2</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_SA2</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">pfkey_mode_to_xfrm</span><span class="p">(</span><span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">reqid</span> <span class="o">=</span> <span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sadb_x_sa2_reqid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reqid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">saddr</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">daddr</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">family</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">saddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">xdaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">daddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
		<span class="n">xsaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">saddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">xdaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)(</span><span class="n">daddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="n">xsaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)(</span><span class="n">saddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_find_acq_byseq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">DUMMY_MARK</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">xfrm_addr_cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">xdaddr</span><span class="p">,</span> <span class="n">family</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
			<span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_find_acq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_mark</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">reqid</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">xdaddr</span><span class="p">,</span> <span class="n">xsaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">family</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">min_spi</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">max_spi</span> <span class="o">=</span> <span class="mh">0x0fffffff</span><span class="p">;</span>

	<span class="n">range</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_SPIRANGE</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">min_spi</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">sadb_spirange_min</span><span class="p">;</span>
		<span class="n">max_spi</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">sadb_spirange_max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_alloc_spi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">min_spi</span><span class="p">,</span> <span class="n">max_spi</span><span class="p">);</span>
	<span class="n">resp_skb</span> <span class="o">=</span> <span class="n">err</span> <span class="o">?</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">:</span> <span class="n">pfkey_xfrm_state2msg</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="k">return</span>  <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">out_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">resp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_GETSPI</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>

	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">resp_skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_find_acq_byseq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">DUMMY_MARK</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">XFRM_STATE_ACQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFRM_STATE_ERROR</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">xfrm</span><span class="p">.</span><span class="n">km_waitq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">event2poltype</span><span class="p">(</span><span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_DELPOLICY</span>:
		<span class="k">return</span> <span class="n">SADB_X_SPDDELETE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWPOLICY</span>:
		<span class="k">return</span> <span class="n">SADB_X_SPDADD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_UPDPOLICY</span>:
		<span class="k">return</span> <span class="n">SADB_X_SPDUPDATE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_POLEXPIRE</span>:</pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>return SADB<em>X</em>SPDEXPIRE;</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pfkey: Unknown policy event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">event2keytype</span><span class="p">(</span><span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_DELSA</span>:
		<span class="k">return</span> <span class="n">SADB_DELETE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWSA</span>:
		<span class="k">return</span> <span class="n">SADB_ADD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_UPDSA</span>:
		<span class="k">return</span> <span class="n">SADB_UPDATE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_EXPIRE</span>:
		<span class="k">return</span> <span class="n">SADB_EXPIRE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pfkey: Unknown SA event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ADD/UPD/DEL */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">key_notify_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">pfkey_xfrm_state2msg</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">event2keytype</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">pfkey_msg2xfrm_state</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext_hdrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="n">xfrm_state_hold</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">==</span> <span class="n">SADB_ADD</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_update</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="n">xfrm_audit_state_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
			     <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFRM_STATE_DEAD</span><span class="p">;</span>
		<span class="n">__xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">==</span> <span class="n">SADB_ADD</span><span class="p">)</span>
		<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_NEWSA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_UPDSA</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">km_state_notify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_SA</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">present_and_same_family</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">pfkey_xfrm_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext_hdrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">security_xfrm_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_state_kern</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_DELSA</span><span class="p">;</span>
	<span class="n">km_state_notify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">xfrm_audit_state_delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
				<span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">out_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_SA</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">present_and_same_family</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">pfkey_xfrm_state_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext_hdrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="n">out_skb</span> <span class="o">=</span> <span class="n">pfkey_xfrm_state2msg</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="n">proto</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">))</span>
		<span class="k">return</span>  <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">);</span>

	<span class="n">out_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">out_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_GET</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">out_skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">compose_sadb_supported</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">orig</span><span class="p">,</span>
					      <span class="n">gfp_t</span> <span class="n">allocation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">auth_len</span><span class="p">,</span> <span class="n">enc_len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">auth_len</span> <span class="o">=</span> <span class="n">xfrm_count_auth_supported</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">auth_len</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_alg</span><span class="p">);</span>
		<span class="n">auth_len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_supported</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">enc_len</span> <span class="o">=</span> <span class="n">xfrm_count_enc_supported</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enc_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enc_len</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_alg</span><span class="p">);</span>
		<span class="n">enc_len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_supported</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">enc_len</span> <span class="o">+</span> <span class="n">auth_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">allocation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_algs</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">pfkey_hdr_dup</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">orig</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auth_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sadb_supported</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sadb_alg</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_supported</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">auth_len</span><span class="p">);</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_alg</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_supported_len</span> <span class="o">=</span> <span class="n">auth_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_supported_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_SUPPORTED_AUTH</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">aalg</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byidx</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aalg</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aalg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span>
				<span class="o">*</span><span class="n">ap</span><span class="o">++</span> <span class="o">=</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enc_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sadb_supported</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sadb_alg</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_supported</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">enc_len</span><span class="p">);</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_alg</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_supported_len</span> <span class="o">=</span> <span class="n">enc_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sadb_supported_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_SUPPORTED_ENCRYPT</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">ealg</span> <span class="o">=</span> <span class="n">xfrm_ealg_get_byidx</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ealg</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ealg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span>
				<span class="o">*</span><span class="n">ap</span><span class="o">++</span> <span class="o">=</span> <span class="n">ealg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out_put_algs:</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">pfkey_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">supp_skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">&gt;</span> <span class="n">SADB_SATYPE_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">!=</span> <span class="n">SADB_SATYPE_UNSPEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">registered</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xfrm_probe_algs</span><span class="p">();</span>

	<span class="n">supp_skb</span> <span class="o">=</span> <span class="n">compose_sadb_supported</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">supp_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">!=</span> <span class="n">SADB_SATYPE_UNSPEC</span><span class="p">)</span>
			<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">supp_skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">BROADCAST_REGISTERED</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">unicast_flush_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">ihdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">ihdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">key_notify_sa_flush</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_FLUSH</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">));</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_audit</span> <span class="n">audit_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_satype2proto</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">audit_info</span><span class="p">.</span><span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">audit_info</span><span class="p">.</span><span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">audit_info</span><span class="p">.</span><span class="n">secid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_state_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_info</span><span class="p">);</span>
	<span class="n">err2</span> <span class="o">=</span> <span class="n">unicast_flush_resp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">err2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="cm">/* empty table - go quietly */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_FLUSHSA</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">km_state_notify</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">out_hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfkey_can_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">out_skb</span> <span class="o">=</span> <span class="n">pfkey_xfrm_state2msg</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">);</span>

	<span class="n">out_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">out_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_version</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_DUMP</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_pid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">));</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">out_skb</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_dump_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfrm_state_walk</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">dump_sa</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pfk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pfkey_dump_sa_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfrm_state_walk_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">pfkey_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_satype2proto</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span><span class="p">;</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">pfkey_dump_sa</span><span class="p">;</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">pfkey_dump_sa_done</span><span class="p">;</span>
	<span class="n">xfrm_state_walk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pfkey_do_dump</span><span class="p">(</span><span class="n">pfk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">pfkey_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">satype</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reset_errno</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">==</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">reset_errno</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">satype</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">satype</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="n">satype</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_errno</span> <span class="o">&amp;&amp;</span> <span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_errno</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">new_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">new_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">BROADCAST_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_reqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reqid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reqid</span> <span class="o">==</span> <span class="n">reqid</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gen_reqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_policy_walk</span> <span class="n">walk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">reqid</span> <span class="o">=</span> <span class="n">IPSEC_MANUAL_REQID_MAX</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">reqid</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">reqid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reqid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">reqid</span> <span class="o">=</span> <span class="n">IPSEC_MANUAL_REQID_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">xfrm_policy_walk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="p">,</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">xfrm_policy_walk</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">walk</span><span class="p">,</span> <span class="n">check_reqid</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reqid</span><span class="p">);</span>
		<span class="n">xfrm_policy_walk_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">reqid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">reqid</span> <span class="o">!=</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_ipsecrequest</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">xp_net</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_vec</span> <span class="o">+</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span> <span class="o">&gt;=</span> <span class="n">XFRM_MAX_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ELOOP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_proto</span><span class="p">;</span> <span class="cm">/* XXX check proto */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">=</span> <span class="n">pfkey_mode_to_xfrm</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_mode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_level</span> <span class="o">==</span> <span class="n">IPSEC_LEVEL_USE</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">optional</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_level</span> <span class="o">==</span> <span class="n">IPSEC_LEVEL_UNIQUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_reqid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">&gt;</span> <span class="n">IPSEC_MANUAL_REQID_MAX</span><span class="p">)</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">gen_reqid</span><span class="p">(</span><span class="n">net</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* addresses present only in tunnel mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XFRM_MODE_TUNNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="n">socklen</span><span class="p">;</span>

		<span class="n">family</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_extract</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">family</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">socklen</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfkey_sockaddr_extract</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span> <span class="o">+</span> <span class="n">socklen</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">family</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">encap_family</span> <span class="o">=</span> <span class="n">family</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">encap_family</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>

	<span class="cm">/* No way to set this via kame pfkey */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">allalgs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_ipsecrequests</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span><span class="o">*</span><span class="mi">8</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="n">pol</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">parse_ipsecrequest</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">rq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">;</span>
		<span class="n">rq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">rq</span> <span class="o">+</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pfkey_xfrm_policy2sec_ctx_size</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">xfrm_ctx</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">PFKEY_ALIGN8</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_xfrm_policy2msg_size</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sockaddr_size</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_size</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">socklen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_vec</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">socklen</span> <span class="o">+=</span> <span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">encap_family</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">sockaddr_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">socklen</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">pfkey_xfrm_policy2sec_ctx_size</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="nf">pfkey_xfrm_policy2msg_prep</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg_size</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span>  <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_xfrm_policy2msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="n">lifetime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">xfrm_ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sockaddr_size</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_size</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">socklen</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg_size</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>

	<span class="cm">/* call should fill header later */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>	<span class="cm">/* XXX do we need this ? */</span>

	<span class="cm">/* src address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_SRC</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="n">pfkey_proto_from_xfrm</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">prefixlen_s</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span>
				 <span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">sport</span><span class="p">,</span>
				 <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				 <span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* dst address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_DST</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="n">pfkey_proto_from_xfrm</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">prefixlen_d</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">dport</span><span class="p">,</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			    <span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>

	<span class="cm">/* hard time */</span>
	<span class="n">lifetime</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">));</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_LIFETIME_HARD</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span> <span class="o">=</span>  <span class="n">_X2KEY</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_packet_limit</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span> <span class="o">=</span> <span class="n">_X2KEY</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_byte_limit</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_add_expires_seconds</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_use_expires_seconds</span><span class="p">;</span>
	<span class="cm">/* soft time */</span>
	<span class="n">lifetime</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">));</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_LIFETIME_SOFT</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span> <span class="o">=</span>  <span class="n">_X2KEY</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_packet_limit</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span> <span class="o">=</span> <span class="n">_X2KEY</span><span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_byte_limit</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_add_expires_seconds</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_use_expires_seconds</span><span class="p">;</span>
	<span class="cm">/* current time */</span>
	<span class="n">lifetime</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">));</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_lifetime</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_LIFETIME_CURRENT</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">add_time</span><span class="p">;</span>
	<span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">use_time</span><span class="p">;</span>

	<span class="n">pol</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">));</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_POLICY</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">=</span> <span class="n">IPSEC_POLICY_DISCARD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">XFRM_POLICY_ALLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">)</span>
			<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">=</span> <span class="n">IPSEC_POLICY_IPSEC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">=</span> <span class="n">IPSEC_POLICY_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_id</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_priority</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_vec</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">req_size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

		<span class="n">req_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XFRM_MODE_TUNNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">socklen</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">encap_family</span><span class="p">);</span>
			<span class="n">req_size</span> <span class="o">+=</span> <span class="n">socklen</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="n">socklen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">req_size</span><span class="p">);</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span> <span class="o">+=</span> <span class="n">req_size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rq</span><span class="p">));</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span> <span class="o">=</span> <span class="n">req_size</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_proto</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">=</span> <span class="n">pfkey_mode_from_xfrm</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_level</span> <span class="o">=</span> <span class="n">IPSEC_LEVEL_REQUIRE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">)</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_level</span> <span class="o">=</span> <span class="n">IPSEC_LEVEL_UNIQUE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">optional</span><span class="p">)</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_level</span> <span class="o">=</span> <span class="n">IPSEC_LEVEL_USE</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_reqid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XFRM_MODE_TUNNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">rq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">,</span>
					    <span class="n">t</span><span class="o">-&gt;</span><span class="n">encap_family</span><span class="p">);</span>
			<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">sa</span> <span class="o">+</span> <span class="n">socklen</span><span class="p">),</span>
					    <span class="n">t</span><span class="o">-&gt;</span><span class="n">encap_family</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* security context */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">xfrm_ctx</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ctx_size</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2sec_ctx_size</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>

		<span class="n">sec_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ctx_size</span><span class="p">);</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_len</span> <span class="o">=</span> <span class="n">ctx_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_SEC_CTX</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_doi</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_doi</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_alg</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_alg</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_len</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sec_ctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_str</span><span class="p">,</span>
		       <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">key_notify_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">out_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">out_skb</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg_prep</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg</span><span class="p">(</span><span class="n">out_skb</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">out_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">out_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">byid</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">XFRM_MSG_DELPOLICY</span><span class="p">)</span>
		<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_X_SPDDELETE2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">event2poltype</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">out_skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">xp_net</span><span class="p">(</span><span class="n">xp</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_spdadd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_lifetime</span> <span class="o">*</span><span class="n">lifetime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">present_and_same_family</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pol</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">&gt;</span> <span class="n">IPSEC_POLICY_IPSEC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">||</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">&gt;=</span> <span class="n">IPSEC_DIR_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">==</span> <span class="n">IPSEC_POLICY_DISCARD</span> <span class="o">?</span>
		      <span class="n">XFRM_POLICY_BLOCK</span> <span class="o">:</span> <span class="n">XFRM_POLICY_ALLOW</span><span class="p">);</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_priority</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">saddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">prefixlen_s</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_proto_to_xfrm</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span><span class="p">);</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">sport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">sport</span><span class="p">)</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">sport_mask</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
	<span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">prefixlen_d</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">;</span>

	<span class="cm">/* Amusing, we set this twice.  KAME apps appear to set same value</span>
<span class="cm">	 * in both addresses.</span>
<span class="cm">	 */</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_proto_to_xfrm</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span><span class="p">);</span>

	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">dport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">dport</span><span class="p">)</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">.</span><span class="n">dport_mask</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">sec_ctx</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_SEC_CTX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span> <span class="o">=</span> <span class="n">pfkey_sadb2xfrm_user_sec_ctx</span><span class="p">(</span><span class="n">sec_ctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">security_xfrm_policy_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">uctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_byte_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_byte_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_packet_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_packet_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lifetime</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_LIFETIME_HARD</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_packet_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span><span class="p">);</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_byte_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span><span class="p">);</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_add_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span><span class="p">;</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_use_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lifetime</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_LIFETIME_SOFT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_packet_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_allocations</span><span class="p">);</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_byte_limit</span> <span class="o">=</span> <span class="n">_KEY2X</span><span class="p">(</span><span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_bytes</span><span class="p">);</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_add_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_addtime</span><span class="p">;</span>
		<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_use_expires_seconds</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">-&gt;</span><span class="n">sadb_lifetime_usetime</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">==</span> <span class="n">IPSEC_POLICY_IPSEC</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">parse_ipsecrequests</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">pol</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_policy_insert</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span>
				 <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">!=</span> <span class="n">SADB_X_SPDUPDATE</span><span class="p">);</span>

	<span class="n">xfrm_audit_policy_add</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
			      <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">==</span> <span class="n">SADB_X_SPDUPDATE</span><span class="p">)</span>
		<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_UPDPOLICY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_NEWPOLICY</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>

	<span class="n">km_policy_notify</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="n">xfrm_pol_put</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xfrm_policy_destroy</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_spddelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="n">sel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">pol_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">present_and_same_family</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pol</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">||</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">&gt;=</span> <span class="n">IPSEC_DIR_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sel</span><span class="p">));</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="p">.</span><span class="n">saddr</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">prefixlen_s</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">;</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_proto_to_xfrm</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">sport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="p">.</span><span class="n">sport</span><span class="p">)</span>
		<span class="n">sel</span><span class="p">.</span><span class="n">sport_mask</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
	<span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="p">.</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">prefixlen_d</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">;</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_proto_to_xfrm</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">dport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="p">.</span><span class="n">dport</span><span class="p">)</span>
		<span class="n">sel</span><span class="p">.</span><span class="n">dport_mask</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">sec_ctx</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_SEC_CTX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span> <span class="o">=</span> <span class="n">pfkey_sadb2xfrm_user_sec_ctx</span><span class="p">(</span><span class="n">sec_ctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uctx</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">security_xfrm_policy_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pol_ctx</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">uctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_bysel_ctx</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">DUMMY_MARK</span><span class="p">,</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">,</span>
				   <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="n">pol_ctx</span><span class="p">,</span>
				   <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">security_xfrm_policy_free</span><span class="p">(</span><span class="n">pol_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">xfrm_audit_policy_delete</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
				 <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">byid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_DELPOLICY</span><span class="p">;</span>
	<span class="n">km_policy_notify</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">xfrm_pol_put</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">key_pol_get_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">out_hdr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">out_skb</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg_prep</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span>  <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg</span><span class="p">(</span><span class="n">out_skb</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">out_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">out_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">out_skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">xp_net</span><span class="p">(</span><span class="n">xp</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_KEY_MIGRATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_sockaddr_pair_size</span><span class="p">(</span><span class="n">sa_family_t</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PFKEY_ALIGN8</span><span class="p">(</span><span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_sockaddr_pair</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ext_len</span><span class="p">,</span>
			       <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="o">*</span><span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="n">socklen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_len</span> <span class="o">&lt;</span> <span class="n">pfkey_sockaddr_pair_size</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">af</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_extract</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">saddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">af</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">socklen</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">af</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfkey_sockaddr_extract</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">)</span> <span class="o">+</span> <span class="n">socklen</span><span class="p">),</span>
				   <span class="n">daddr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">af</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">family</span> <span class="o">=</span> <span class="n">af</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipsecrequests_to_migrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="n">rq1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="n">rq2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">len</span> <span class="o">&lt;</span> <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* old endoints */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_sockaddr_pair</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">rq1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				  <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">old_daddr</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">old_family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rq2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rq1</span> <span class="o">+</span> <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">len</span> <span class="o">&lt;</span> <span class="n">rq2</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* new endpoints */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_sockaddr_pair</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">rq2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				  <span class="n">rq2</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">new_daddr</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">new_family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_proto</span> <span class="o">!=</span> <span class="n">rq2</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_proto</span> <span class="o">||</span>
	    <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_mode</span> <span class="o">!=</span> <span class="n">rq2</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_mode</span> <span class="o">||</span>
	    <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_reqid</span> <span class="o">!=</span> <span class="n">rq2</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_reqid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_proto</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">=</span> <span class="n">pfkey_mode_to_xfrm</span><span class="p">(</span><span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_mode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">=</span> <span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_reqid</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">rq1</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span> <span class="o">+</span>
		      <span class="n">rq2</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_migrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_kmaddress</span> <span class="o">*</span><span class="n">kma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="n">sel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="n">m</span><span class="p">[</span><span class="n">XFRM_MAX_DEPTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">present_and_same_family</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
				     <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kma</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_KMADDRESS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">pol</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">&gt;=</span> <span class="n">IPSEC_DIR_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* convert sadb_x_kmaddress to xfrm_kmaddress */</span>
		<span class="n">k</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">kma</span><span class="o">-&gt;</span><span class="n">sadb_x_kmaddress_reserved</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_sockaddr_pair</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">kma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
					  <span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">kma</span><span class="o">-&gt;</span><span class="n">sadb_x_kmaddress_len</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kma</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">k</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">.</span><span class="n">remote</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sel</span><span class="p">));</span>

	<span class="cm">/* set source address info of selector */</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_SRC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="p">.</span><span class="n">saddr</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">prefixlen_s</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">;</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_proto_to_xfrm</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">sport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="p">.</span><span class="n">sport</span><span class="p">)</span>
		<span class="n">sel</span><span class="p">.</span><span class="n">sport_mask</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* set destination address info of selector */</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_ADDRESS_DST</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
	<span class="n">pfkey_sadb_addr2xfrm_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="p">.</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">prefixlen_d</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">;</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">pfkey_proto_to_xfrm</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span><span class="p">);</span>
	<span class="n">sel</span><span class="p">.</span><span class="n">dport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="p">.</span><span class="n">dport</span><span class="p">)</span>
		<span class="n">sel</span><span class="p">.</span><span class="n">dport_mask</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="p">)(</span><span class="n">pol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* extract ipsecrequests */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XFRM_MAX_DEPTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipsecrequests_to_migrate</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rq</span> <span class="o">+</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xfrm_migrate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			    <span class="n">kma</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">k</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_migrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_spdget</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pol</span> <span class="o">=</span> <span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_X_EXT_POLICY</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">xfrm_policy_id2dir</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;=</span> <span class="n">XFRM_POLICY_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">delete</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">==</span> <span class="n">SADB_X_SPDDELETE2</span><span class="p">);</span>
	<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_byid</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">DUMMY_MARK</span><span class="p">,</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">,</span>
			      <span class="n">dir</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_id</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfrm_audit_policy_delete</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
				<span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">byid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_DELPOLICY</span><span class="p">;</span>
		<span class="n">km_policy_notify</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">key_pol_get_resp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">xfrm_pol_put</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_sp</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">out_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfkey_can_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">out_skb</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg_prep</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pfkey_xfrm_policy2msg</span><span class="p">(</span><span class="n">out_skb</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">out_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">out_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_version</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_X_SPDDUMP</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">SADB_SATYPE_UNSPEC</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_pid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ONE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">));</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">out_skb</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_dump_sp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfrm_policy_walk</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">policy</span><span class="p">,</span> <span class="n">dump_sp</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pfk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pfkey_dump_sp_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfrm_policy_walk_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">policy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_spddump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">pfkey_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span><span class="p">;</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">msg_pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">pfkey_dump_sp</span><span class="p">;</span>
	<span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">pfkey_dump_sp_done</span><span class="p">;</span>
	<span class="n">xfrm_policy_walk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">policy</span><span class="p">,</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pfkey_do_dump</span><span class="p">(</span><span class="n">pfk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">key_notify_policy_flush</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb_out</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb_out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_X_SPDFLUSH</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">));</span>
	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_spdflush</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">km_event</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_audit</span> <span class="n">audit_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">audit_info</span><span class="p">.</span><span class="n">loginuid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">audit_info</span><span class="p">.</span><span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">audit_info</span><span class="p">.</span><span class="n">secid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_policy_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_info</span><span class="p">);</span>
	<span class="n">err2</span> <span class="o">=</span> <span class="n">unicast_flush_resp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">err2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="cm">/* empty table - old silent behavior */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">XFRM_MSG_FLUSHPOLICY</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">km_policy_notify</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pfkey_handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">);</span>
<span class="k">static</span> <span class="n">pfkey_handler</span> <span class="n">pfkey_funcs</span><span class="p">[</span><span class="n">SADB_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SADB_RESERVED</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_reserved</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_GETSPI</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_getspi</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_UPDATE</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_add</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_ADD</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_add</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_DELETE</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_delete</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_GET</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_get</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_ACQUIRE</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_acquire</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_REGISTER</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_register</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_EXPIRE</span><span class="p">]</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_FLUSH</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_flush</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_DUMP</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_dump</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_PROMISC</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_promisc</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_PCHANGE</span><span class="p">]</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDUPDATE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_spdadd</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDADD</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_spdadd</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDDELETE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_spddelete</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDGET</span><span class="p">]</span>		<span class="o">=</span> <span class="n">pfkey_spdget</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDACQUIRE</span><span class="p">]</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDDUMP</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_spddump</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDFLUSH</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_spdflush</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDSETIDX</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_spdadd</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_SPDDELETE2</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_spdget</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SADB_X_MIGRATE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pfkey_migrate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ext_hdrs</span><span class="p">[</span><span class="n">SADB_EXT_MAX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
			<span class="n">BROADCAST_PROMISC_ONLY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ext_hdrs</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_exthdrs</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext_hdrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfkey_funcs</span><span class="p">[</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span><span class="p">])</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pfkey_funcs</span><span class="p">[</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span><span class="p">](</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext_hdrs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="nf">pfkey_get_base_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">!=</span> <span class="n">PF_KEY_V2</span> <span class="o">||</span>
		    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">&lt;=</span> <span class="n">SADB_RESERVED</span> <span class="o">||</span>
		     <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">&gt;</span> <span class="n">SADB_MAX</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">!=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">))</span> <span class="o">||</span>
			   <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">hdr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">aalg_tmpl_set</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">aalgos</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">aalgos</span> <span class="o">&gt;&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ealg_tmpl_set</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ealgos</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ealgos</span> <span class="o">&gt;&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">count_ah_combs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">aalg</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byidx</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aalg</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aalg_tmpl_set</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">aalg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span>
			<span class="n">sz</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sz</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">count_esp_combs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">ealg</span> <span class="o">=</span> <span class="n">xfrm_ealg_get_byidx</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ealg</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ealg_tmpl_set</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ealg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ealg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">aalg</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byidx</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aalg</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">aalg_tmpl_set</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">aalg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span>
				<span class="n">sz</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sz</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_ah_combs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_prop</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_PROPOSAL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_replay</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_reserved</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">aalg</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byidx</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aalg</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aalg_tmpl_set</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">aalg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sadb_comb</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">));</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_auth</span> <span class="o">=</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_auth_minbits</span> <span class="o">=</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_minbits</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_auth_maxbits</span> <span class="o">=</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_maxbits</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_hard_addtime</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_soft_addtime</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_hard_usetime</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_soft_usetime</span> <span class="o">=</span> <span class="mi">7</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_esp_combs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_prop</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_prop</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_PROPOSAL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_replay</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_reserved</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">ealg</span> <span class="o">=</span> <span class="n">xfrm_ealg_get_byidx</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ealg</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ealg_tmpl_set</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ealg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ealg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sadb_comb</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_algo_desc</span> <span class="o">*</span><span class="n">aalg</span> <span class="o">=</span> <span class="n">xfrm_aalg_get_byidx</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aalg</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aalg_tmpl_set</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">aalg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">));</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">sadb_prop_len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_comb</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_auth</span> <span class="o">=</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_auth_minbits</span> <span class="o">=</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_minbits</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_auth_maxbits</span> <span class="o">=</span> <span class="n">aalg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_maxbits</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_encrypt</span> <span class="o">=</span> <span class="n">ealg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_id</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_encrypt_minbits</span> <span class="o">=</span> <span class="n">ealg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_minbits</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_encrypt_maxbits</span> <span class="o">=</span> <span class="n">ealg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">sadb_alg_maxbits</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_hard_addtime</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_soft_addtime</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_hard_usetime</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">sadb_comb_soft_usetime</span> <span class="o">=</span> <span class="mi">7</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">key_notify_policy_expire</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">key_notify_sa_expire</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">out_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">out_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsc</span><span class="p">;</span>

	<span class="n">hard</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">hard</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard</span><span class="p">)</span>
		<span class="n">hsc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hsc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">out_skb</span> <span class="o">=</span> <span class="n">pfkey_xfrm_state2msg_expire</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hsc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">out_skb</span><span class="p">);</span>

	<span class="n">out_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">out_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_EXPIRE</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">out_skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_REGISTERED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_send_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">x</span> <span class="o">?</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">socks_nr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_EXPIRE</span>:
		<span class="k">return</span> <span class="n">key_notify_sa_expire</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_DELSA</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWSA</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_UPDSA</span>:
		<span class="k">return</span> <span class="n">key_notify_sa</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_FLUSHSA</span>:
		<span class="k">return</span> <span class="n">key_notify_sa_flush</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWAE</span>: <span class="cm">/* not yet supported */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pfkey: Unknown SA event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_send_policy_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">km_event</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&amp;&amp;</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_POLEXPIRE</span>:
		<span class="k">return</span> <span class="n">key_notify_policy_expire</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_DELPOLICY</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_NEWPOLICY</span>:
	<span class="k">case</span> <span class="n">XFRM_MSG_UPDPOLICY</span>:
		<span class="k">return</span> <span class="n">key_notify_policy</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFRM_MSG_FLUSHPOLICY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">key_notify_policy_flush</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pfkey: Unknown policy event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_acqseq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">acqseq</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acqseq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_send_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_tmpl</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sockaddr_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfrm_sec_ctx</span> <span class="o">*</span><span class="n">xfrm_ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctx_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sockaddr_size</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_size</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sockaddr_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">sockaddr_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">IPPROTO_AH</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">count_ah_combs</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">IPPROTO_ESP</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">count_esp_combs</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">xfrm_ctx</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctx_size</span> <span class="o">=</span> <span class="n">PFKEY_ALIGN8</span><span class="p">(</span><span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span>  <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_ACQUIRE</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">get_acqseq</span><span class="p">();</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* src address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_SRC</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* dst address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_DST</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">pol</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">));</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_POLICY</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">=</span> <span class="n">IPSEC_POLICY_IPSEC</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_id</span> <span class="o">=</span> <span class="n">xp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Set sadb_comb&#39;s. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">IPPROTO_AH</span><span class="p">)</span>
		<span class="n">dump_ah_combs</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">IPPROTO_ESP</span><span class="p">)</span>
		<span class="n">dump_esp_combs</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="cm">/* security context */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfrm_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx_size</span><span class="p">);</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_len</span> <span class="o">=</span>
		  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx_size</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_SEC_CTX</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_doi</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_doi</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_alg</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_alg</span><span class="p">;</span>
		<span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_ctx_len</span> <span class="o">=</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sec_ctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_str</span><span class="p">,</span>
		       <span class="n">xfrm_ctx</span><span class="o">-&gt;</span><span class="n">ctx_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_REGISTERED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="nf">pfkey_compile_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_policy</span> <span class="o">*</span><span class="n">xp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="n">sec_ctx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">!=</span> <span class="n">IP_IPSEC_POLICY</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">!=</span> <span class="n">IPV6_IPSEC_POLICY</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span><span class="o">*</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">||</span>
	    <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">&gt;</span> <span class="n">IPSEC_POLICY_BYPASS</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">||</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">&gt;</span> <span class="n">IPSEC_DIR_OUTBOUND</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">xp</span> <span class="o">=</span> <span class="n">xfrm_policy_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">==</span> <span class="n">IPSEC_POLICY_DISCARD</span> <span class="o">?</span>
		      <span class="n">XFRM_POLICY_BLOCK</span> <span class="o">:</span> <span class="n">XFRM_POLICY_ALLOW</span><span class="p">);</span>

	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_byte_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_byte_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">soft_packet_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">lft</span><span class="p">.</span><span class="n">hard_packet_limit</span> <span class="o">=</span> <span class="n">XFRM_INF</span><span class="p">;</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">;</span>

	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">xfrm_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">==</span> <span class="n">IPSEC_POLICY_IPSEC</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">parse_ipsecrequests</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">pol</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* security context too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pol</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">xfrm_user_sec_ctx</span> <span class="o">*</span><span class="n">uctx</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">sec_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_sec_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span>
		    <span class="n">sec_ctx</span><span class="o">-&gt;</span><span class="n">sadb_x_sec_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">verify_sec_ctx_len</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">uctx</span> <span class="o">=</span> <span class="n">pfkey_sadb2xfrm_user_sec_ctx</span><span class="p">(</span><span class="n">sec_ctx</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">security_xfrm_policy_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">uctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dir</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xp</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">xp</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xfrm_policy_destroy</span><span class="p">(</span><span class="n">xp</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_send_new_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_sa</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span> <span class="o">*</span><span class="n">n_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sockaddr_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">satype</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">IPPROTO_ESP</span> <span class="o">?</span> <span class="n">SADB_SATYPE_ESP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfrm_encap_tmpl</span> <span class="o">*</span><span class="n">natt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sockaddr_size</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_size</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sockaddr_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">satype</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">natt</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">encap</span><span class="p">;</span>

	<span class="cm">/* Build an SADB_X_NAT_T_NEW_MAPPING message:</span>
<span class="cm">	 *</span>
<span class="cm">	 * HDR | SA | ADDRESS_SRC (old addr) | NAT_T_SPORT (old port) |</span>
<span class="cm">	 * ADDRESS_DST (new addr) | NAT_T_DPORT (new port)</span>
<span class="cm">	 */</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">sockaddr_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span>  <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_X_NAT_T_NEW_MAPPING</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">satype</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">km</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">get_acqseq</span><span class="p">();</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* SA */</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span><span class="p">));</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_sa</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_SA</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_spi</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">spi</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_replay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_auth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_encrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">sadb_sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ADDRESS_SRC (old addr) */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_SRC</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* NAT_T_SPORT (old port) */</span>
	<span class="n">n_port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">));</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_NAT_T_SPORT</span><span class="p">;</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_port</span> <span class="o">=</span> <span class="n">natt</span><span class="o">-&gt;</span><span class="n">encap_sport</span><span class="p">;</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ADDRESS_DST (new addr) */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span><span class="o">+</span><span class="n">sockaddr_size</span><span class="p">)</span><span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">SADB_EXT_ADDRESS_DST</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* NAT_T_DPORT (new port) */</span>
	<span class="n">n_port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_nat_t_port</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">));</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n_port</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_NAT_T_DPORT</span><span class="p">;</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_port</span> <span class="o">=</span> <span class="n">sport</span><span class="p">;</span>
	<span class="n">n_port</span><span class="o">-&gt;</span><span class="n">sadb_x_nat_t_port_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_REGISTERED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">xs_net</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_KEY_MIGRATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_sadb_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sasize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">sasize</span><span class="p">);</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">sasize</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_exttype</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_proto</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SADB_EXT_ADDRESS_SRC</span>:
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">prefixlen_s</span><span class="p">;</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">sel</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SADB_EXT_ADDRESS_DST</span>:
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sadb_address_prefixlen</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">prefixlen_d</span><span class="p">;</span>
		<span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">sel</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_sadb_kmaddress</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_x_kmaddress</span> <span class="o">*</span><span class="n">kma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">family</span> <span class="o">=</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">socklen</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size_req</span><span class="p">;</span>

	<span class="n">size_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_kmaddress</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">pfkey_sockaddr_pair_size</span><span class="p">(</span><span class="n">family</span><span class="p">));</span>

	<span class="n">kma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_kmaddress</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size_req</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">kma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size_req</span><span class="p">);</span>
	<span class="n">kma</span><span class="o">-&gt;</span><span class="n">sadb_x_kmaddress_len</span> <span class="o">=</span> <span class="n">size_req</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">kma</span><span class="o">-&gt;</span><span class="n">sadb_x_kmaddress_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_KMADDRESS</span><span class="p">;</span>
	<span class="n">kma</span><span class="o">-&gt;</span><span class="n">sadb_x_kmaddress_reserved</span> <span class="o">=</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">kma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">,</span> <span class="n">family</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span><span class="o">+</span><span class="n">socklen</span><span class="p">),</span> <span class="n">family</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_ipsecrequest</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="kt">uint8_t</span> <span class="n">proto</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="n">reqid</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">family</span><span class="p">,</span>
			    <span class="k">const</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="n">xfrm_address_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">socklen</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_len</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size_req</span><span class="p">;</span>

	<span class="n">size_req</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">)</span> <span class="o">+</span>
		   <span class="n">pfkey_sockaddr_pair_size</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size_req</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size_req</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_len</span> <span class="o">=</span> <span class="n">size_req</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_proto</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sadb_x_ipsecrequest_reqid</span> <span class="o">=</span> <span class="n">reqid</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">sa</span><span class="p">,</span> <span class="n">family</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">pfkey_sockaddr_fill</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)(</span><span class="n">sa</span> <span class="o">+</span> <span class="n">socklen</span><span class="p">),</span> <span class="n">family</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_NET_KEY_MIGRATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_send_migrate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_bundles</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sasize_sel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size_pol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">XFRM_POLICY_TYPE_MAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_bundles</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num_bundles</span> <span class="o">&gt;</span> <span class="n">XFRM_MAX_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* addresses for KM */</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">PFKEY_ALIGN8</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_kmaddress</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">pfkey_sockaddr_pair_size</span><span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* selector */</span>
	<span class="n">sasize_sel</span> <span class="o">=</span> <span class="n">pfkey_sockaddr_size</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sasize_sel</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">sasize_sel</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* policy info */</span>
	<span class="n">size_pol</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">);</span>

	<span class="cm">/* ipsecrequests */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_bundles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* old locator pair */</span>
		<span class="n">size_pol</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">pfkey_sockaddr_pair_size</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">old_family</span><span class="p">);</span>
		<span class="cm">/* new locator pair */</span>
		<span class="n">size_pol</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_ipsecrequest</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">pfkey_sockaddr_pair_size</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">new_family</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">)</span> <span class="o">+</span> <span class="n">size_pol</span><span class="p">;</span>

	<span class="cm">/* alloc buffer */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_msg</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_version</span> <span class="o">=</span> <span class="n">PF_KEY_V2</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_type</span> <span class="o">=</span> <span class="n">SADB_X_MIGRATE</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_satype</span> <span class="o">=</span> <span class="n">pfkey_proto2satype</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sadb_msg_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Addresses to be used by KM for negotiation, if ext is available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">set_sadb_kmaddress</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* selector src */</span>
	<span class="n">set_sadb_address</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sasize_sel</span><span class="p">,</span> <span class="n">SADB_EXT_ADDRESS_SRC</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>

	<span class="cm">/* selector dst */</span>
	<span class="n">set_sadb_address</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sasize_sel</span><span class="p">,</span> <span class="n">SADB_EXT_ADDRESS_DST</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>

	<span class="cm">/* policy information */</span>
	<span class="n">pol</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sadb_x_policy</span><span class="p">));</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_len</span> <span class="o">=</span> <span class="n">size_pol</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_exttype</span> <span class="o">=</span> <span class="n">SADB_X_EXT_POLICY</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_type</span> <span class="o">=</span> <span class="n">IPSEC_POLICY_IPSEC</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_dir</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pol</span><span class="o">-&gt;</span><span class="n">sadb_x_policy_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_bundles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* old ipsecrequest */</span>
		<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">pfkey_mode_from_xfrm</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_ipsecrequest</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">?</span>  <span class="n">IPSEC_LEVEL_UNIQUE</span> <span class="o">:</span> <span class="n">IPSEC_LEVEL_REQUIRE</span><span class="p">),</span>
				     <span class="n">mp</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">old_family</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">old_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">old_daddr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* new ipsecrequest */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_ipsecrequest</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">?</span> <span class="n">IPSEC_LEVEL_UNIQUE</span> <span class="o">:</span> <span class="n">IPSEC_LEVEL_REQUIRE</span><span class="p">),</span>
				     <span class="n">mp</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">new_family</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">new_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">new_daddr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* broadcast migrate message to sockets */</span>
	<span class="n">pfkey_broadcast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">BROADCAST_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_send_migrate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_selector</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_migrate</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_bundles</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">xfrm_kmaddress</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">kiocb</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sadb_msg</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">pfkey_get_base_msg</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfrm_cfg_mutex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pfkey_process</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfrm_cfg_mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">hdr</span> <span class="o">&amp;&amp;</span> <span class="n">pfkey_error</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">sk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">kiocb</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pfkey_sock</span> <span class="o">*</span><span class="n">pfk</span> <span class="o">=</span> <span class="n">pfkey_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSG_PEEK</span><span class="o">|</span><span class="n">MSG_DONTWAIT</span><span class="o">|</span><span class="n">MSG_TRUNC</span><span class="o">|</span><span class="n">MSG_CMSG_COMPAT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">copied</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">sock_recv_ts_and_drops</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_TRUNC</span><span class="p">)</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">copied</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfk</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">.</span><span class="n">dump</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="mi">3</span> <span class="o">*</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rmem_alloc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">)</span>
		<span class="n">pfkey_do_dump</span><span class="p">(</span><span class="n">pfk</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">pfkey_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span>	<span class="n">PF_KEY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="cm">/* Operations that make no sense on pfkey sockets. */</span>
	<span class="p">.</span><span class="n">bind</span>		<span class="o">=</span>	<span class="n">sock_no_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span>	<span class="n">sock_no_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span>	<span class="o">=</span>	<span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span>		<span class="o">=</span>	<span class="n">sock_no_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span>	<span class="o">=</span>	<span class="n">sock_no_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span>	<span class="n">sock_no_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listen</span>		<span class="o">=</span>	<span class="n">sock_no_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span>	<span class="n">sock_no_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>	<span class="o">=</span>	<span class="n">sock_no_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	<span class="o">=</span>	<span class="n">sock_no_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span>	<span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span>	<span class="o">=</span>	<span class="n">sock_no_sendpage</span><span class="p">,</span>

	<span class="cm">/* Now the operations that really occur. */</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span>	<span class="n">pfkey_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span>	<span class="n">datagram_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span>	<span class="o">=</span>	<span class="n">pfkey_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span>	<span class="o">=</span>	<span class="n">pfkey_recvmsg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">pfkey_family_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>	<span class="o">=</span>	<span class="n">PF_KEY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span>	<span class="o">=</span>	<span class="n">pfkey_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">sk_entry</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span> <span class="p">,</span><span class="s">&quot;sk       RefCnt Rmem   Wmem   User   Inode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%pK %-6d %-6u %-6u %-6u %-6lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">s</span><span class="p">,</span>
			       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sk_refcnt</span><span class="p">),</span>
			       <span class="n">sk_rmem_alloc_get</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
			       <span class="n">sk_wmem_alloc_get</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
			       <span class="n">sock_i_uid</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
			       <span class="n">sock_i_ino</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
			       <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">pfkey_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">seq_hlist_start_head_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">pfkey_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">seq_hlist_next_rcu</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pfkey_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">pfkey_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">pfkey_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">pfkey_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">pfkey_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">pfkey_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pfkey_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfkey_seq_ops</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_net_private</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pfkey_proc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">pfkey_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">pfkey_init_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;pfkey&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfkey_proc_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">pfkey_exit_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;pfkey&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pfkey_init_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pfkey_exit_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xfrm_mgr</span> <span class="n">pfkeyv2_mgr</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="s">&quot;pfkeyv2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify</span>		<span class="o">=</span> <span class="n">pfkey_send_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire</span>	<span class="o">=</span> <span class="n">pfkey_send_acquire</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compile_policy</span>	<span class="o">=</span> <span class="n">pfkey_compile_policy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">new_mapping</span>	<span class="o">=</span> <span class="n">pfkey_send_new_mapping</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify_policy</span>	<span class="o">=</span> <span class="n">pfkey_send_policy_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">migrate</span>	<span class="o">=</span> <span class="n">pfkey_send_migrate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">pfkey_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">socks_nr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">pfkey_init_proc</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">pfkey_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netns_pfkey</span> <span class="o">*</span><span class="n">net_pfkey</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pfkey_net_id</span><span class="p">);</span>

	<span class="n">pfkey_exit_proc</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_pfkey</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">pfkey_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pfkey_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">pfkey_net_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">pfkey_net_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netns_pfkey</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ipsec_pfkey_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfrm_unregister_km</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkeyv2_mgr</span><span class="p">);</span>
	<span class="n">sock_unregister</span><span class="p">(</span><span class="n">PF_KEY</span><span class="p">);</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_net_ops</span><span class="p">);</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ipsec_pfkey_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_key_proto</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_family_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_pernet</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xfrm_register_km</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkeyv2_mgr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sock_unregister</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_sock_unregister:</span>
	<span class="n">sock_unregister</span><span class="p">(</span><span class="n">PF_KEY</span><span class="p">);</span>
<span class="nl">out_unregister_pernet:</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfkey_net_ops</span><span class="p">);</span>
<span class="nl">out_unregister_key_proto:</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_proto</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ipsec_pfkey_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ipsec_pfkey_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NETPROTO</span><span class="p">(</span><span class="n">PF_KEY</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
