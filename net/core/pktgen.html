<!DOCTYPE html>
<html><head><title>joekychen/linux » net › core › pktgen.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pktgen.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Authors:</span>
<span class="cm"> * Copyright 2001, 2002 by Robert Olsson &lt;robert.olsson@its.uu.se&gt;</span>
<span class="cm"> *                             Uppsala University and</span>
<span class="cm"> *                             Swedish University of Agricultural Sciences</span>
<span class="cm"> *</span>
<span class="cm"> * Alexey Kuznetsov  &lt;kuznet@ms2.inr.ac.ru&gt;</span>
<span class="cm"> * Ben Greear &lt;greearb@candelatech.com&gt;</span>
<span class="cm"> * Jens Låås &lt;jens.laas@data.slu.se&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * A tool for loading the network with preconfigurated packets.</span>
<span class="cm"> * The tool is implemented as a linux module.  Parameters are output</span>
<span class="cm"> * device, delay (to hard_xmit), number of packets, and whether</span>
<span class="cm"> * to use multiple SKBs or just the same one.</span>
<span class="cm"> * pktgen uses the installed interface&#39;s output routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Additional hacking by:</span>
<span class="cm"> *</span>
<span class="cm"> * Jens.Laas@data.slu.se</span>
<span class="cm"> * Improved by ANK. 010120.</span>
<span class="cm"> * Improved by ANK even more. 010212.</span>
<span class="cm"> * MAC address typo fixed. 010417 --ro</span>
<span class="cm"> * Integrated.  020301 --DaveM</span>
<span class="cm"> * Added multiskb option 020301 --DaveM</span>
<span class="cm"> * Scaling of results. 020417--sigurdur@linpro.no</span>
<span class="cm"> * Significant re-work of the module:</span>
<span class="cm"> *   *  Convert to threaded model to more efficiently be able to transmit</span>
<span class="cm"> *       and receive on multiple interfaces at once.</span>
<span class="cm"> *   *  Converted many counters to __u64 to allow longer runs.</span>
<span class="cm"> *   *  Allow configuration of ranges, like min/max IP address, MACs,</span>
<span class="cm"> *       and UDP-ports, for both source and destination, and can</span>
<span class="cm"> *       set to use a random distribution or sequentially walk the range.</span>
<span class="cm"> *   *  Can now change most values after starting.</span>
<span class="cm"> *   *  Place 12-byte packet in UDP payload with magic number,</span>
<span class="cm"> *       sequence number, and timestamp.</span>
<span class="cm"> *   *  Add receiver code that detects dropped pkts, re-ordered pkts, and</span>
<span class="cm"> *       latencies (with micro-second) precision.</span>
<span class="cm"> *   *  Add IOCTL interface to easily get counters &amp; configuration.</span>
<span class="cm"> *   --Ben Greear &lt;greearb@candelatech.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Renamed multiskb to clone_skb and cleaned up sending core for two distinct</span>
<span class="cm"> * skb modes. A clone_skb=0 mode for Ben &quot;ranges&quot; work and a clone_skb != 0</span>
<span class="cm"> * as a &quot;fastpath&quot; with a configurable number of clones after alloc&#39;s.</span>
<span class="cm"> * clone_skb=0 means all packets are allocated this also means ranges time</span>
<span class="cm"> * stamps etc can be used. clone_skb=100 means 1 malloc is followed by 100</span>
<span class="cm"> * clones.</span>
<span class="cm"> *</span>
<span class="cm"> * Also moved to /proc/net/pktgen/</span>
<span class="cm"> * --ro</span>
<span class="cm"> *</span>
<span class="cm"> * Sept 10:  Fixed threading/locking.  Lots of bone-headed and more clever</span>
<span class="cm"> *    mistakes.  Also merged in DaveM&#39;s patch in the -pre6 patch.</span>
<span class="cm"> * --Ben Greear &lt;greearb@candelatech.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Integrated to 2.5.x 021029 --Lucio Maciel (luciomaciel@zipmail.com.br)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * 021124 Finished major redesign and rewrite for new functionality.</span>
<span class="cm"> * See Documentation/networking/pktgen.txt for how to use this.</span>
<span class="cm"> *</span>
<span class="cm"> * The new operation:</span>
<span class="cm"> * For each CPU one thread/process is created at start. This process checks</span>
<span class="cm"> * for running devices in the if_list and sends packets until count is 0 it</span>
<span class="cm"> * also the thread checks the thread-&gt;control which is used for inter-process</span>
<span class="cm"> * communication. controlling process &quot;posts&quot; operations to the threads this</span>
<span class="cm"> * way. The if_lock should be possible to remove when add/rem_device is merged</span>
<span class="cm"> * into this too.</span>
<span class="cm"> *</span>
<span class="cm"> * By design there should only be *one* &quot;controlling&quot; process. In practice</span>
<span class="cm"> * multiple write accesses gives unpredictable result. Understood by &quot;write&quot;</span>
<span class="cm"> * to /proc gives result code thats should be read be the &quot;writer&quot;.</span>
<span class="cm"> * For practical use this should be no problem.</span>
<span class="cm"> *</span>
<span class="cm"> * Note when adding devices to a specific CPU there good idea to also assign</span>
<span class="cm"> * /proc/irq/XX/smp_affinity so TX-interrupts gets bound to the same CPU.</span>
<span class="cm"> * --ro</span>
<span class="cm"> *</span>
<span class="cm"> * Fix refcount off by one if first packet fails, potential null deref,</span>
<span class="cm"> * memleak 030710- KJP</span>
<span class="cm"> *</span>
<span class="cm"> * First &quot;ranges&quot; functionality for ipv6 030726 --ro</span>
<span class="cm"> *</span>
<span class="cm"> * Included flow support. 030802 ANK.</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed unaligned access on IA-64 Grant Grundler &lt;grundler@parisc-linux.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Remove if fix from added Harald Welte &lt;laforge@netfilter.org&gt; 040419</span>
<span class="cm"> * ia64 compilation fix from  Aron Griffis &lt;aron@hp.com&gt; 040604</span>
<span class="cm"> *</span>
<span class="cm"> * New xmit() return, do_div and misc clean up by Stephen Hemminger</span>
<span class="cm"> * &lt;shemminger@osdl.org&gt; 040923</span>
<span class="cm"> *</span>
<span class="cm"> * Randy Dunlap fixed u64 printk compiler waring</span>
<span class="cm"> *</span>
<span class="cm"> * Remove FCS from BW calculation.  Lennert Buytenhek &lt;buytenh@wantstofly.org&gt;</span>
<span class="cm"> * New time handling. Lennert Buytenhek &lt;buytenh@wantstofly.org&gt; 041213</span>
<span class="cm"> *</span>
<span class="cm"> * Corrections from Nikolai Malykh (nmalykh@bilim.com)</span>
<span class="cm"> * Removed unused flags F_SET_SRCMAC &amp; F_SET_SRCIP 041230</span>
<span class="cm"> *</span>
<span class="cm"> * interruptible_sleep_on_timeout() replaced Nishanth Aravamudan &lt;nacc@us.ibm.com&gt;</span>
<span class="cm"> * 050103</span>
<span class="cm"> *</span>
<span class="cm"> * MPLS support by Steven Whitehouse &lt;steve@chygwyn.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 802.1Q/Q-in-Q support by Francesco Fondelli (FF) &lt;francesco.fondelli@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed src_mac command to set source mac of packet to value specified in</span>
<span class="cm"> * command by Adit Ranadive &lt;adit.262@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/sys.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/addrconf.h&gt;</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
<span class="cp">#include &lt;net/xfrm.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/timex.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;		</span><span class="cm">/* do_div */</span><span class="cp"></span>

<span class="cp">#define VERSION	&quot;2.74&quot;</span>
<span class="cp">#define IP_NAME_SZ 32</span>
<span class="cp">#define MAX_MPLS_LABELS 16 </span><span class="cm">/* This is the max label stack depth */</span><span class="cp"></span>
<span class="cp">#define MPLS_STACK_BOTTOM htonl(0x00000100)</span>

<span class="cp">#define func_enter() pr_debug(&quot;entering %s\n&quot;, __func__);</span>

<span class="cm">/* Device flag bits */</span>
<span class="cp">#define F_IPSRC_RND   (1&lt;&lt;0)	</span><span class="cm">/* IP-Src Random  */</span><span class="cp"></span>
<span class="cp">#define F_IPDST_RND   (1&lt;&lt;1)	</span><span class="cm">/* IP-Dst Random  */</span><span class="cp"></span>
<span class="cp">#define F_UDPSRC_RND  (1&lt;&lt;2)	</span><span class="cm">/* UDP-Src Random */</span><span class="cp"></span>
<span class="cp">#define F_UDPDST_RND  (1&lt;&lt;3)	</span><span class="cm">/* UDP-Dst Random */</span><span class="cp"></span>
<span class="cp">#define F_MACSRC_RND  (1&lt;&lt;4)	</span><span class="cm">/* MAC-Src Random */</span><span class="cp"></span>
<span class="cp">#define F_MACDST_RND  (1&lt;&lt;5)	</span><span class="cm">/* MAC-Dst Random */</span><span class="cp"></span>
<span class="cp">#define F_TXSIZE_RND  (1&lt;&lt;6)	</span><span class="cm">/* Transmit size is random */</span><span class="cp"></span>
<span class="cp">#define F_IPV6        (1&lt;&lt;7)	</span><span class="cm">/* Interface in IPV6 Mode */</span><span class="cp"></span>
<span class="cp">#define F_MPLS_RND    (1&lt;&lt;8)	</span><span class="cm">/* Random MPLS labels */</span><span class="cp"></span>
<span class="cp">#define F_VID_RND     (1&lt;&lt;9)	</span><span class="cm">/* Random VLAN ID */</span><span class="cp"></span>
<span class="cp">#define F_SVID_RND    (1&lt;&lt;10)	</span><span class="cm">/* Random SVLAN ID */</span><span class="cp"></span>
<span class="cp">#define F_FLOW_SEQ    (1&lt;&lt;11)	</span><span class="cm">/* Sequential flows */</span><span class="cp"></span>
<span class="cp">#define F_IPSEC_ON    (1&lt;&lt;12)	</span><span class="cm">/* ipsec on for flows */</span><span class="cp"></span>
<span class="cp">#define F_QUEUE_MAP_RND (1&lt;&lt;13)	</span><span class="cm">/* queue map Random */</span><span class="cp"></span>
<span class="cp">#define F_QUEUE_MAP_CPU (1&lt;&lt;14)	</span><span class="cm">/* queue map mirrors smp_processor_id() */</span><span class="cp"></span>
<span class="cp">#define F_NODE          (1&lt;&lt;15)	</span><span class="cm">/* Node memory alloc*/</span><span class="cp"></span>

<span class="cm">/* Thread control flag bits */</span>
<span class="cp">#define T_STOP        (1&lt;&lt;0)	</span><span class="cm">/* Stop run */</span><span class="cp"></span>
<span class="cp">#define T_RUN         (1&lt;&lt;1)	</span><span class="cm">/* Start run */</span><span class="cp"></span>
<span class="cp">#define T_REMDEVALL   (1&lt;&lt;2)	</span><span class="cm">/* Remove all devs */</span><span class="cp"></span>
<span class="cp">#define T_REMDEV      (1&lt;&lt;3)	</span><span class="cm">/* Remove one dev */</span><span class="cp"></span>

<span class="cm">/* If lock -- can be removed after some work */</span>
<span class="cp">#define   if_lock(t)           spin_lock(&amp;(t-&gt;if_lock));</span>
<span class="cp">#define   if_unlock(t)           spin_unlock(&amp;(t-&gt;if_lock));</span>

<span class="cm">/* Used to help with determining the pkts on receive */</span>
<span class="cp">#define PKTGEN_MAGIC 0xbe9be955</span>
<span class="cp">#define PG_PROC_DIR &quot;pktgen&quot;</span>
<span class="cp">#define PGCTRL	    &quot;pgctrl&quot;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pg_proc_dir</span><span class="p">;</span>

<span class="cp">#define MAX_CFLOWS  65536</span>

<span class="cp">#define VLAN_TAG_SIZE(x) ((x)-&gt;vlan_id == 0xffff ? 0 : 4)</span>
<span class="cp">#define SVLAN_TAG_SIZE(x) ((x)-&gt;svlan_id == 0xffff ? 0 : 4)</span>

<span class="k">struct</span> <span class="n">flow_state</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">cur_daddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* flow flag bits */</span>
<span class="cp">#define F_INIT   (1&lt;&lt;0)		</span><span class="cm">/* flow has been initialized */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Try to keep frequent/infrequent used vars. separated.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>	<span class="cm">/* proc file */</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">pg_thread</span><span class="p">;</span><span class="cm">/* the owner */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>		<span class="cm">/* chaining in the thread&#39;s run-queue */</span>

	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>		<span class="cm">/* if false, the test will stop */</span>

	<span class="cm">/* If min != max, then we will either do a linear iteration, or</span>
<span class="cm">	 * we will do a random selection from within the range.</span>
<span class="cm">	 */</span>
	<span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">removal_mark</span><span class="p">;</span>	<span class="cm">/* non-zero =&gt; the device is marked for</span>
<span class="cm">				 * removal by worker thread */</span>

	<span class="kt">int</span> <span class="n">min_pkt_size</span><span class="p">;</span>	<span class="cm">/* = ETH_ZLEN; */</span>
	<span class="kt">int</span> <span class="n">max_pkt_size</span><span class="p">;</span>	<span class="cm">/* = ETH_ZLEN; */</span>
	<span class="kt">int</span> <span class="n">pkt_overhead</span><span class="p">;</span>	<span class="cm">/* overhead for MPLS, VLANs, IPSEC etc */</span>
	<span class="kt">int</span> <span class="n">nfrags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">delay</span><span class="p">;</span>		<span class="cm">/* nano-seconds */</span>

	<span class="n">__u64</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* Default No packets to send */</span>
	<span class="n">__u64</span> <span class="n">sofar</span><span class="p">;</span>		<span class="cm">/* How many pkts we&#39;ve sent so far */</span>
	<span class="n">__u64</span> <span class="n">tx_bytes</span><span class="p">;</span>		<span class="cm">/* How many bytes we&#39;ve transmitted */</span>
	<span class="n">__u64</span> <span class="n">errors</span><span class="p">;</span>		<span class="cm">/* Errors when trying to transmit, */</span>

	<span class="cm">/* runtime counters relating to clone_skb */</span>

	<span class="n">__u64</span> <span class="n">allocated_skbs</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">clone_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_ok</span><span class="p">;</span>		<span class="cm">/* Was last skb sent?</span>
<span class="cm">				 * Or a failed transmit of some sort?</span>
<span class="cm">				 * This will keep sequence numbers in order</span>
<span class="cm">				 */</span>
	<span class="n">ktime_t</span> <span class="n">next_tx</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">started_at</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">stopped_at</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">idle_acc</span><span class="p">;</span>	<span class="cm">/* nano-seconds */</span>

	<span class="n">__u32</span> <span class="n">seq_num</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">clone_skb</span><span class="p">;</span>		<span class="cm">/*</span>
<span class="cm">				 * Use multiple SKBs during packet gen.</span>
<span class="cm">				 * If this number is greater than 1, then</span>
<span class="cm">				 * that many copies of the same packet will be</span>
<span class="cm">				 * sent before a new packet is allocated.</span>
<span class="cm">				 * If you want to send 1024 identical packets</span>
<span class="cm">				 * before creating a new packet,</span>
<span class="cm">				 * set clone_skb to 1024.</span>
<span class="cm">				 */</span>

	<span class="kt">char</span> <span class="n">dst_min</span><span class="p">[</span><span class="n">IP_NAME_SZ</span><span class="p">];</span>	<span class="cm">/* IP, ie 1.2.3.4 */</span>
	<span class="kt">char</span> <span class="n">dst_max</span><span class="p">[</span><span class="n">IP_NAME_SZ</span><span class="p">];</span>	<span class="cm">/* IP, ie 1.2.3.4 */</span>
	<span class="kt">char</span> <span class="n">src_min</span><span class="p">[</span><span class="n">IP_NAME_SZ</span><span class="p">];</span>	<span class="cm">/* IP, ie 1.2.3.4 */</span>
	<span class="kt">char</span> <span class="n">src_max</span><span class="p">[</span><span class="n">IP_NAME_SZ</span><span class="p">];</span>	<span class="cm">/* IP, ie 1.2.3.4 */</span>

	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">in6_saddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">in6_daddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">cur_in6_daddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">cur_in6_saddr</span><span class="p">;</span>
	<span class="cm">/* For ranges */</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">min_in6_daddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">max_in6_daddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">min_in6_saddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">max_in6_saddr</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re doing ranges, random or incremental, then this</span>
<span class="cm">	 * defines the min/max for those ranges.</span>
<span class="cm">	 */</span>
	<span class="n">__be32</span> <span class="n">saddr_min</span><span class="p">;</span>	<span class="cm">/* inclusive, source IP address */</span>
	<span class="n">__be32</span> <span class="n">saddr_max</span><span class="p">;</span>	<span class="cm">/* exclusive, source IP address */</span>
	<span class="n">__be32</span> <span class="n">daddr_min</span><span class="p">;</span>	<span class="cm">/* inclusive, dest IP address */</span>
	<span class="n">__be32</span> <span class="n">daddr_max</span><span class="p">;</span>	<span class="cm">/* exclusive, dest IP address */</span>

	<span class="n">__u16</span> <span class="n">udp_src_min</span><span class="p">;</span>	<span class="cm">/* inclusive, source UDP port */</span>
	<span class="n">__u16</span> <span class="n">udp_src_max</span><span class="p">;</span>	<span class="cm">/* exclusive, source UDP port */</span>
	<span class="n">__u16</span> <span class="n">udp_dst_min</span><span class="p">;</span>	<span class="cm">/* inclusive, dest UDP port */</span>
	<span class="n">__u16</span> <span class="n">udp_dst_max</span><span class="p">;</span>	<span class="cm">/* exclusive, dest UDP port */</span>

	<span class="cm">/* DSCP + ECN */</span>
	<span class="n">__u8</span> <span class="n">tos</span><span class="p">;</span>            <span class="cm">/* six MSB of (former) IPv4 TOS</span>
<span class="cm">				are for dscp codepoint */</span>
	<span class="n">__u8</span> <span class="n">traffic_class</span><span class="p">;</span>  <span class="cm">/* ditto for the (former) Traffic Class in IPv6</span>
<span class="cm">				(see RFC 3260, sec. 4) */</span>

	<span class="cm">/* MPLS */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_labels</span><span class="p">;</span>	<span class="cm">/* Depth of stack, 0 = no MPLS */</span>
	<span class="n">__be32</span> <span class="n">labels</span><span class="p">[</span><span class="n">MAX_MPLS_LABELS</span><span class="p">];</span>

	<span class="cm">/* VLAN/SVLAN (802.1Q/Q-in-Q) */</span>
	<span class="n">__u8</span>  <span class="n">vlan_p</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">vlan_cfi</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">vlan_id</span><span class="p">;</span>  <span class="cm">/* 0xffff means no vlan tag */</span>

	<span class="n">__u8</span>  <span class="n">svlan_p</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">svlan_cfi</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">svlan_id</span><span class="p">;</span> <span class="cm">/* 0xffff means no svlan tag */</span>

	<span class="n">__u32</span> <span class="n">src_mac_count</span><span class="p">;</span>	<span class="cm">/* How many MACs to iterate through */</span>
	<span class="n">__u32</span> <span class="n">dst_mac_count</span><span class="p">;</span>	<span class="cm">/* How many MACs to iterate through */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dst_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">__u32</span> <span class="n">cur_dst_mac_offset</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">cur_src_mac_offset</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">cur_saddr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">cur_daddr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">ip_id</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">cur_udp_dst</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">cur_udp_src</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">cur_queue_map</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">cur_pkt_size</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">last_pkt_size</span><span class="p">;</span>

	<span class="n">__u8</span> <span class="n">hh</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="cm">/* = {</span>
<span class="cm">	   0x00, 0x80, 0xC8, 0x79, 0xB3, 0xCB,</span>

<span class="cm">	   We fill in SRC address later</span>
<span class="cm">	   0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span>
<span class="cm">	   0x08, 0x00</span>
<span class="cm">	   };</span>
<span class="cm">	 */</span>
	<span class="n">__u16</span> <span class="n">pad</span><span class="p">;</span>		<span class="cm">/* pad out the hh struct to an even 16 bytes */</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>	<span class="cm">/* skb we are to transmit next, used for when we</span>
<span class="cm">				 * are transmitting the same one multiple times</span>
<span class="cm">				 */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">odev</span><span class="p">;</span> <span class="cm">/* The out-going device.</span>
<span class="cm">				  * Note that the device should have it&#39;s</span>
<span class="cm">				  * pg_info pointer pointing back to this</span>
<span class="cm">				  * device.</span>
<span class="cm">				  * Set when the user specifies the out-going</span>
<span class="cm">				  * device name (not when the inject is</span>
<span class="cm">				  * started as it used to do.)</span>
<span class="cm">				  */</span>
	<span class="kt">char</span> <span class="n">odevname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">flow_state</span> <span class="o">*</span><span class="n">flows</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflows</span><span class="p">;</span>	<span class="cm">/* Concurrent flows (config) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lflow</span><span class="p">;</span>		<span class="cm">/* Flow length  (config) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nflows</span><span class="p">;</span>	<span class="cm">/* accumulated flows (stats) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">curfl</span><span class="p">;</span>		<span class="cm">/* current sequenced flow (state)*/</span>

	<span class="n">u16</span> <span class="n">queue_map_min</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">queue_map_max</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">skb_priority</span><span class="p">;</span>	<span class="cm">/* skb priority field */</span>
	<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>               <span class="cm">/* Memory node */</span>

<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="n">__u8</span>	<span class="n">ipsmode</span><span class="p">;</span>		<span class="cm">/* IPSEC mode (config) */</span>
	<span class="n">__u8</span>	<span class="n">ipsproto</span><span class="p">;</span>		<span class="cm">/* IPSEC type (config) */</span>
<span class="cp">#endif</span>
	<span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pktgen_hdr</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">pgh_magic</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">seq_num</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">tv_usec</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">pktgen_exiting</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">if_lock</span><span class="p">;</span>		<span class="cm">/* for list of devices */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">if_list</span><span class="p">;</span>	<span class="cm">/* All device here */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">th_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>

	<span class="cm">/* Field for thread to receive &quot;posted&quot; events terminate,</span>
<span class="cm">	   stop ifs etc. */</span>

	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">start_done</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define REMOVE 1</span>
<span class="cp">#define FIND   0</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ktime_t</span> <span class="nf">ktime_now</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="n">ktime_get_ts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">timespec_to_ktime</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This works even if 32 bit because of careful byte order choice */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ktime_lt</span><span class="p">(</span><span class="k">const</span> <span class="n">ktime_t</span> <span class="n">cmp1</span><span class="p">,</span> <span class="k">const</span> <span class="n">ktime_t</span> <span class="n">cmp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cmp1</span><span class="p">.</span><span class="n">tv64</span> <span class="o">&lt;</span> <span class="n">cmp2</span><span class="p">.</span><span class="n">tv64</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Packet Generator for packet performance testing. &quot;</span>
	<span class="s">&quot;Version: &quot;</span> <span class="n">VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pktgen_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">i</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pktgen_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pktgen_find_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="n">bool</span> <span class="n">exact</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pktgen_device_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pktgen_run_all_threads</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pktgen_reset_all_threads</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pktgen_stop_all_threads_ifs</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">pktgen_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pktgen_clear_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scan_ip6</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>

<span class="cm">/* Module parameters, defaults. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pg_count_d</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pg_delay_d</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pg_clone_skb_d</span>  <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span>  <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pktgen_threads</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">pktgen_notifier_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">pktgen_device_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * /proc handling functions</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pgctrl_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pgctrl_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Make string */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;stop&quot;</span><span class="p">))</span>
		<span class="n">pktgen_stop_all_threads_ifs</span><span class="p">();</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">))</span>
		<span class="n">pktgen_run_all_threads</span><span class="p">();</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">))</span>
		<span class="n">pktgen_reset_all_threads</span><span class="p">();</span>

	<span class="k">else</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unknown command: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pgctrl_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pgctrl_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pktgen_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">pgctrl_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">pgctrl_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_if_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">stopped</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">idle</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;Params: count %llu  min_pkt_size: %u  max_pkt_size: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;     frags: %d  delay: %llu  clone_skb: %d  ifname: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nfrags</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_skb</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     flows: %u flowlen: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">lflow</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;     queue_map_min: %u  queue_map_max: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb_priority</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     skb_priority: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb_priority</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;     saddr: %pI6c  min_saddr: %pI6c  max_saddr: %pI6c</span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;     daddr: %pI6c  min_daddr: %pI6c  max_daddr: %pI6c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_saddr</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_in6_saddr</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_daddr</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_in6_daddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;     dst_min: %s  dst_max: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;        src_min: %s  src_max: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     src_mac: &quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%pM &quot;</span><span class="p">,</span>
		   <span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">)</span> <span class="o">?</span>
			     <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">:</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;dst_mac: &quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;     udp_src_min: %d  udp_src_max: %d&quot;</span>
		   <span class="s">&quot;  udp_dst_min: %d  udp_dst_max: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;     src_mac_count: %d  dst_mac_count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac_count</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     mpls: &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%08x%s&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				   <span class="n">i</span> <span class="o">==</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     vlan_id: %u  vlan_p: %u  vlan_cfi: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_p</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_cfi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     svlan_id: %u  vlan_p: %u  vlan_cfi: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_p</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_cfi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     tos: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     traffic_class: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     node: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     Flags: &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPV6</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IPV6  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPSRC_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IPSRC_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPDST_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IPDST_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_TXSIZE_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;TXSIZE_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_UDPSRC_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;UDPSRC_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_UDPDST_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;UDPDST_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_MPLS_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>  <span class="s">&quot;MPLS_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_QUEUE_MAP_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>  <span class="s">&quot;QUEUE_MAP_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_QUEUE_MAP_CPU</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>  <span class="s">&quot;QUEUE_MAP_CPU  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_FLOW_SEQ</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>  <span class="s">&quot;FLOW_SEQ  &quot;</span><span class="p">);</span> <span class="cm">/*in sequence flows*/</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>  <span class="s">&quot;FLOW_RND  &quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPSEC_ON</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>  <span class="s">&quot;IPSEC  &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_MACSRC_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;MACSRC_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_MACDST_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;MACDST_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_VID_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;VID_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_SVID_RND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;SVID_RND  &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_NODE</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;NODE_ALLOC  &quot;</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* not really stopped, more like last-running-at */</span>
	<span class="n">stopped</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">?</span> <span class="n">ktime_now</span><span class="p">()</span> <span class="o">:</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">stopped_at</span><span class="p">;</span>
	<span class="n">idle</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">idle_acc</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="n">NSEC_PER_USEC</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;Current:</span><span class="se">\n</span><span class="s">     pkts-sofar: %llu  errors: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">sofar</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;     started: %lluus  stopped: %lluus idle: %lluus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ktime_to_us</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">started_at</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ktime_to_us</span><span class="p">(</span><span class="n">stopped</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">idle</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;     seq_num: %d  cur_dst_mac_offset: %d  cur_src_mac_offset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_dst_mac_offset</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_src_mac_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     cur_saddr: %pI6c  cur_daddr: %pI6c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_saddr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_daddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     cur_saddr: 0x%x  cur_daddr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     cur_udp_dst: %d  cur_udp_src: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     cur_queue_map: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     flows: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nflows</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Result: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Result: Idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hex32_arg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxlen</span><span class="p">,</span>
		     <span class="n">__u32</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="o">*</span><span class="n">num</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">num</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">count_trail_chars</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">user_buffer</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;\&quot;&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;\n&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;\r&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;\t&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39; &#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">num_arg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxlen</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">num</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="o">*</span><span class="n">num</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">strn_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">user_buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;\&quot;&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;\n&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;\r&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;\t&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39; &#39;</span>:
			<span class="k">goto</span> <span class="n">done_str</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done_str:</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">get_labels</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">hex32_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MPLS_STACK_BOTTOM</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_MPLS_RND</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">MAX_MPLS_LABELS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pktgen_if_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">user_buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			       <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">valstr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pg_result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="n">pg_result</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;wrong command format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">count_trail_chars</span><span class="p">(</span><span class="n">user_buffer</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;illegal format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Read variable name */</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">count_trail_chars</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">1023</span><span class="p">);</span>
		<span class="kt">char</span> <span class="n">tb</span><span class="p">[</span><span class="n">copy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">user_buffer</span><span class="p">,</span> <span class="n">copy</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">tb</span><span class="p">[</span><span class="n">copy</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s,%lu  buffer -:%s:-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">,</span> <span class="n">tb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;min_pkt_size&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: min_pkt_size=%u&quot;</span><span class="p">,</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;max_pkt_size&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: max_pkt_size=%u&quot;</span><span class="p">,</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Shortcut for min = max */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;pkt_size&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: pkt_size=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;debug&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">debug</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: debug=%u&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;frags&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nfrags</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: frags=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nfrags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;delay&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0x7FFFFFFF</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: delay=%llu&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rate&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">NSEC_PER_USEC</span><span class="o">/</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Delay set at: %llu ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: rate=%lu&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ratep&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">NSEC_PER_SEC</span><span class="o">/</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Delay set at: %llu ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: rate=%lu&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;udp_src_min&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: udp_src_min=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;udp_dst_min&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: udp_dst_min=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;udp_src_max&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: udp_src_max=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;udp_dst_max&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: udp_dst_max=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;clone_skb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_TX_SKB_SHARING</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_skb</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: clone_skb=%d&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: count=%llu&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;src_mac_count&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac_count</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac_count</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_src_mac_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: src_mac_count=%d&quot;</span><span class="p">,</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst_mac_count&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac_count</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac_count</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_dst_mac_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: dst_mac_count=%d&quot;</span><span class="p">,</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;node&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">node_possible</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: node=%d&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">put_page</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;ERROR: node not possible&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flag&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">f</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;IPSRC_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_IPSRC_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!IPSRC_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_IPSRC_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;TXSIZE_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_TXSIZE_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!TXSIZE_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_TXSIZE_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;IPDST_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_IPDST_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!IPDST_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_IPDST_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;UDPSRC_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_UDPSRC_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!UDPSRC_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_UDPSRC_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;UDPDST_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_UDPDST_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!UDPDST_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_UDPDST_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;MACSRC_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_MACSRC_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!MACSRC_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_MACSRC_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;MACDST_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_MACDST_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!MACDST_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_MACDST_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;MPLS_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_MPLS_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!MPLS_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_MPLS_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;VID_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_VID_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!VID_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_VID_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;SVID_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_SVID_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!SVID_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_SVID_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;FLOW_SEQ&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_FLOW_SEQ</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;QUEUE_MAP_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_QUEUE_MAP_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!QUEUE_MAP_RND&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_QUEUE_MAP_RND</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;QUEUE_MAP_CPU&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_QUEUE_MAP_CPU</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!QUEUE_MAP_CPU&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_QUEUE_MAP_CPU</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;IPSEC&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_IPSEC_ON</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!IPV6&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_IPV6</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;NODE_ALLOC&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_NODE</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;!NODE_ALLOC&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_NODE</span><span class="p">;</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span>
				<span class="s">&quot;Flag -:%s:- unknown</span><span class="se">\n</span><span class="s">Available flags, (prepend ! to un-set flag):</span><span class="se">\n</span><span class="s">%s&quot;</span><span class="p">,</span>
				<span class="n">f</span><span class="p">,</span>
				<span class="s">&quot;IPSRC_RND, IPDST_RND, UDPSRC_RND, UDPDST_RND, &quot;</span>
				<span class="s">&quot;MACSRC_RND, MACDST_RND, TXSIZE_RND, IPV6, MPLS_RND, VID_RND, SVID_RND, FLOW_SEQ, IPSEC, NODE_ALLOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: flags=0x%x&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst_min&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">));</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_min</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_min</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst_min set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: dst_min=%s&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst_max&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">));</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_max</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst_max set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: dst_max=%s&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst6&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_IPV6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">scan_ip6</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_daddr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%pI6c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_daddr</span><span class="p">);</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_daddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst6 set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: dst6=%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst6_min&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_IPV6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">scan_ip6</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%pI6c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">);</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst6_min set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: dst6_min=%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst6_max&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_IPV6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">scan_ip6</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_in6_daddr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%pI6c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_in6_daddr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst6_max set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: dst6_max=%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;src6&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_IPV6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">scan_ip6</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_saddr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%pI6c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_saddr</span><span class="p">);</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_saddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">in6_saddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;src6 set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: src6=%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;src_min&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">));</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;src_min set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: src_min=%s&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;src_max&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">));</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_max</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;src_max set to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: src_max=%s&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dst_mac&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">valstr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_pton</span><span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Set up Dest MAC */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: dstmac %pM&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;src_mac&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">valstr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_pton</span><span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Set up Src MAC */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: srcmac %pM&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;clear_counters&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pktgen_clear_counters</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: Clearing counters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flows&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_CFLOWS</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">MAX_CFLOWS</span><span class="p">;</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: flows=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flowlen&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">lflow</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: flowlen=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">lflow</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;queue_map_min&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: queue_map_min=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;queue_map_max&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: queue_map_max=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mpls&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">get_labels</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pkt_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: mpls=&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">,</span>
				       <span class="s">&quot;%08x%s&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
				       <span class="n">n</span> <span class="o">==</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="cm">/* turn off VLAN/SVLAN */</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;VLAN/SVLAN auto turned off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;vlan_id&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>  <span class="cm">/* turn on VLAN */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;VLAN turned on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MPLS auto turned off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* turn off MPLS */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: vlan_id=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="cm">/* turn off VLAN/SVLAN */</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;VLAN/SVLAN turned off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;vlan_p&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_p</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: vlan_p=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_p</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;ERROR: vlan_p must be 0-7&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;vlan_cfi&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_cfi</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: vlan_cfi=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_cfi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;ERROR: vlan_cfi must be 0-1&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;svlan_id&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>  <span class="cm">/* turn on SVLAN */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SVLAN turned on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MPLS auto turned off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* turn off MPLS */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: svlan_id=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="cm">/* turn off VLAN/SVLAN */</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;VLAN/SVLAN turned off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;svlan_p&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_p</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: svlan_p=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_p</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;ERROR: svlan_p must be 0-7&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;svlan_cfi&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_cfi</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: svlan_cfi=%u&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_cfi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;ERROR: svlan_cfi must be 0-1&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tos&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">tmp_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">hex32_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="n">tmp_value</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: tos=0x%02x&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;ERROR: tos must be 00-ff&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;traffic_class&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">tmp_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">hex32_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="n">tmp_value</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: traffic_class=0x%02x&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;ERROR: traffic_class must be 00-ff&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;skb_priority&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb_priority</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: skb_priority=%i&quot;</span><span class="p">,</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb_priority</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;No such parameter </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_if_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pktgen_if_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pktgen_if_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">pktgen_if_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">pktgen_if_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_thread_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Running: &quot;</span><span class="p">);</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Stopped: &quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Result: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Result: NA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pktgen_thread_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">user_buffer</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pg_result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code> sprintf(pg_result, "Wrong command format");
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">count_trail_chars</span><span class="p">(</span><span class="n">user_buffer</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Read variable name */</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">count_trail_chars</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;t=%s, count=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: No thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pg_result</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;add_device&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">f</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
		<span class="n">pktgen_add_device</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: add_device=%s&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rem_device_all&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">T_REMDEVALL</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">125</span><span class="p">));</span>	<span class="cm">/* Propagate thread-&gt;control  */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: rem_device_all&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;max_before_softirq&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pg_result</span><span class="p">,</span> <span class="s">&quot;OK: Note! max_before_softirq is obsoleted -- Do not use&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_thread_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pktgen_thread_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pktgen_thread_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">pktgen_thread_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">pktgen_thread_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Think find or remove for NN */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="nf">__pktgen_NN_threads</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remove</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">exact</span> <span class="o">=</span> <span class="p">(</span><span class="n">remove</span> <span class="o">==</span> <span class="n">FIND</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="n">th_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">pktgen_find_dev</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">exact</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">remove</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">removal_mark</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">T_REMDEV</span><span class="p">;</span>
				<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pkt_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mark a device for removal</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_mark_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">msec_per_try</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: marking %s for removal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">__pktgen_NN_threads</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* success */</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: waiting for %s to disappear....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">msec_per_try</span><span class="p">));</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">max_tries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: timed out after waiting %d msec for device %s to be removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">msec_per_try</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_change_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="n">th_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">);</span>

			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span>
							  <span class="n">pg_proc_dir</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">pktgen_if_fops</span><span class="p">,</span>
							  <span class="n">pkt_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t move proc entry for &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_device_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">)</span> <span class="o">||</span> <span class="n">pktgen_exiting</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="cm">/* It is OK that we do not hold the group lock right now,</span>
<span class="cm">	 * as we run under the RTNL lock.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_CHANGENAME</span>:
		<span class="n">pktgen_change_name</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_UNREGISTER</span>:
		<span class="n">pktgen_mark_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">pktgen_dev_get_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span>
						 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="o">+</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ifname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IFNAMSIZ</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifname</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Associate pktgen_dev with a device. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_setup_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">odev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Clean old setups */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">odev</span> <span class="o">=</span> <span class="n">pktgen_dev_get_by_name</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no such netdevice: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;not an ethernet device: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">odev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;device is down: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span> <span class="o">=</span> <span class="n">odev</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_put</span><span class="p">(</span><span class="n">odev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read pkt_dev from the interface and set up internal pktgen_dev</span>
<span class="cm"> * structure to have the right information to create/send packets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_setup_inject</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ntxq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: pkt_dev-&gt;odev == NULL in setup_inject</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span>
			<span class="s">&quot;ERROR: pkt_dev-&gt;odev == NULL in setup_inject.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure that we don&#39;t pick a non-existing transmit queue */</span>
	<span class="n">ntxq</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">real_num_tx_queues</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntxq</span> <span class="o">&lt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;WARNING: Requested queue_map_min (zero-based) (%d) exceeds valid range [0 - %d] for (%d) queues on %s, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span><span class="p">,</span> <span class="p">(</span><span class="n">ntxq</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntxq</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntxq</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span> <span class="o">&gt;=</span> <span class="n">ntxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;WARNING: Requested queue_map_max (zero-based) (%d) exceeds valid range [0 - %d] for (%d) queues on %s, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span><span class="p">,</span> <span class="p">(</span><span class="n">ntxq</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntxq</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntxq</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Default to the interface&#39;s mac if not explicitly set. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Set up Dest MAC */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Set up pkt size */</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Skip this automatic address setting until locks or functions</span>
<span class="cm">		 * gets exported</span>
<span class="cm">		 */</span>

<span class="cp">#ifdef NOTNOW</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IN6_ADDR_HSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_saddr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Use linklevel address if unconfigured.</span>
<span class="cm">			 *</span>
<span class="cm">			 * use ipv6_get_lladdr if/when it&#39;s get exported</span>
<span class="cm">			 */</span>

			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>

				<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">addr_list</span><span class="p">;</span> <span class="n">ifp</span><span class="p">;</span>
				     <span class="n">ifp</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_next</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">scope</span> <span class="o">==</span> <span class="n">IFA_LINK</span> <span class="o">&amp;&amp;</span>
					    <span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFA_F_TENTATIVE</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_saddr</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
						<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: IPv6 link address not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>

			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span> <span class="o">=</span>
					    <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">;</span>
					<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_max</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_min</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_max</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_max</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_min</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_min</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_max</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_max</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize current values. */</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_dst_mac_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_src_mac_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_min</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nflows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">spin</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="n">spin_until</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hrtimer_sleeper</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">hrtimer_init_on_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
	<span class="n">hrtimer_set_expires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">spin_until</span><span class="p">);</span>

	<span class="n">remaining</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">hrtimer_expires_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">.</span><span class="n">timer</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">spin_until</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start_time</span> <span class="o">=</span> <span class="n">ktime_now</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for small delays (&lt;100us), just loop until limit is reached */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">end_time</span> <span class="o">=</span> <span class="n">ktime_now</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ktime_lt</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">spin_until</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* see do_nanosleep */</span>
		<span class="n">hrtimer_init_sleeper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">hrtimer_start_expires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hrtimer_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">.</span><span class="n">timer</span><span class="p">))</span>
				<span class="n">t</span><span class="p">.</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">task</span><span class="p">))</span>
				<span class="n">schedule</span><span class="p">();</span>

			<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">task</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">ktime_now</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">idle_acc</span> <span class="o">+=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">start_time</span><span class="p">));</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">spin_until</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pkt_overhead</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span> <span class="o">+=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span> <span class="o">+=</span> <span class="n">VLAN_TAG_SIZE</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span> <span class="o">+=</span> <span class="n">SVLAN_TAG_SIZE</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">f_seen</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_INIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">f_pick</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_FLOW_SEQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">lflow</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset time */</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span> <span class="o">&gt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">)</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/*reset */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flow</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span> <span class="o">=</span> <span class="n">flow</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">lflow</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_XFRM</span>
<span class="cm">/* If there was already an IPSEC SA, we keep it as is, else</span>
<span class="cm"> * we go look for it ...</span>
<span class="cm">*/</span>
<span class="cp">#define DUMMY_MARK 0</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_ipsec_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*slow path: we dont already have xfrm_state*/</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">xfrm_stateonly_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">DUMMY_MARK</span><span class="p">,</span>
					<span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span><span class="p">,</span>
					<span class="p">(</span><span class="n">xfrm_address_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span><span class="p">,</span>
					<span class="n">AF_INET</span><span class="p">,</span>
					<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">ipsmode</span><span class="p">,</span>
					<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">ipsproto</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="n">set_pkt_overhead</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span> <span class="o">+=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">header_len</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_cur_queue_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_QUEUE_MAP_CPU</span><span class="p">)</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span> <span class="o">&lt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u16</span> <span class="n">t</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_QUEUE_MAP_RND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span>
				<span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span> <span class="o">-</span>
				 <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_max</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">queue_map_min</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span>  <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span> <span class="o">%</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">real_num_tx_queues</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Increment/randomize headers according to flags and current values</span>
<span class="cm"> * for IP src/dest, UDP src/dst port, MAC-Addr src/dst</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mod_cur_headers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">imn</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">imx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">)</span>
		<span class="n">flow</span> <span class="o">=</span> <span class="n">f_pick</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>

	<span class="cm">/*  Deal with source MAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">mc</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_MACSRC_RND</span><span class="p">)</span>
			<span class="n">mc</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac_count</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mc</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_src_mac_offset</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_src_mac_offset</span> <span class="o">&gt;=</span>
			    <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac_count</span><span class="p">)</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_src_mac_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">src_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Deal with Destination MAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">mc</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_MACDST_RND</span><span class="p">)</span>
			<span class="n">mc</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac_count</span><span class="p">;</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mc</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_dst_mac_offset</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_dst_mac_offset</span> <span class="o">&gt;=</span>
			    <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_dst_mac_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_MPLS_RND</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MPLS_STACK_BOTTOM</span><span class="p">)</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLS_STACK_BOTTOM</span> <span class="o">|</span>
					     <span class="p">((</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span><span class="n">random32</span><span class="p">()</span> <span class="o">&amp;</span>
						      <span class="n">htonl</span><span class="p">(</span><span class="mh">0x000fffff</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_VID_RND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">4096</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_SVID_RND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_UDPSRC_RND</span><span class="p">)</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span>
				<span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span> <span class="o">-</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span><span class="p">;</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span> <span class="o">&gt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span><span class="p">)</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_UDPDST_RND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span>
				<span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span> <span class="o">-</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span> <span class="o">&gt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span><span class="p">)</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPV6</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">imn</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_min</span><span class="p">);</span>
		<span class="n">imx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">saddr_max</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imn</span> <span class="o">&lt;</span> <span class="n">imx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__u32</span> <span class="n">t</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPSRC_RND</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">imx</span> <span class="o">-</span> <span class="n">imn</span><span class="p">)</span> <span class="o">+</span> <span class="n">imn</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span><span class="p">);</span>
				<span class="n">t</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">imx</span><span class="p">)</span>
					<span class="n">t</span> <span class="o">=</span> <span class="n">imn</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span> <span class="o">&amp;&amp;</span> <span class="n">f_seen</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">flow</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">cur_daddr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">imn</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_min</span><span class="p">);</span>
			<span class="n">imx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">daddr_max</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">imn</span> <span class="o">&lt;</span> <span class="n">imx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__u32</span> <span class="n">t</span><span class="p">;</span>
				<span class="n">__be32</span> <span class="n">s</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPDST_RND</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">t</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">imx</span> <span class="o">-</span> <span class="n">imn</span><span class="p">)</span> <span class="o">+</span> <span class="n">imn</span><span class="p">;</span>
					<span class="n">s</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

					<span class="k">while</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">||</span>
					       <span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">||</span>
					       <span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">||</span>
					       <span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">||</span>
					       <span class="n">ipv4_is_local_multicast</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">t</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">imx</span> <span class="o">-</span> <span class="n">imn</span><span class="p">)</span> <span class="o">+</span> <span class="n">imn</span><span class="p">;</span>
						<span class="n">s</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">t</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span><span class="p">);</span>
					<span class="n">t</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">imx</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">t</span> <span class="o">=</span> <span class="n">imn</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">F_INIT</span><span class="p">;</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">cur_daddr</span> <span class="o">=</span>
				    <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPSEC_ON</span><span class="p">)</span>
					<span class="n">get_ipsec_sa</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nflows</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* IPV6 * */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Only random destinations yet */</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(((</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span><span class="n">random32</span><span class="p">()</span> <span class="o">|</span>
				      <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_in6_daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
				     <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_in6_daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">t</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_TXSIZE_RND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span>
				<span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span> <span class="o">-</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_cur_queue_map</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>

	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">flow</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_XFRM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_output_ipsec</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* XXX: we dont support tunnel mode for now until</span>
<span class="cm">	 * we resolve the dst issue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">XFRM_MODE_TRANSPORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">outer_mode</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">curlft</span><span class="p">.</span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_SAs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* let go of the SAs if we have them */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cflows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfrm_state_put</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_ipsec</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">protocol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPSEC_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfrm_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">curfl</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
			<span class="n">nhead</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">header_len</span> <span class="o">-</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nhead</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nhead</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error expanding ipsec packet %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ret</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* ipsec is not expecting ll header */</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">pktgen_output_ipsec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error creating ipsec packet %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* restore ll */</span>
			<span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">eth</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">eth</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpls_push</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="n">mpls</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mpls</span><span class="o">++</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MPLS_STACK_BOTTOM</span><span class="p">;</span>

	<span class="n">mpls</span><span class="o">--</span><span class="p">;</span>
	<span class="o">*</span><span class="n">mpls</span> <span class="o">|=</span> <span class="n">MPLS_STACK_BOTTOM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be16</span> <span class="nf">build_tci</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfi</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">htons</span><span class="p">(</span><span class="n">id</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfi</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">prio</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_finalize_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">datalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_hdr</span> <span class="o">*</span><span class="n">pgh</span><span class="p">;</span>

	<span class="n">pgh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pgh</span><span class="p">));</span>
	<span class="n">datalen</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pgh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nfrags</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">datalen</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">frags</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nfrags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">frag_len</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&gt;</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">)</span>
			<span class="n">frags</span> <span class="o">=</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">datalen</span> <span class="o">-</span> <span class="n">frags</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">datalen</span> <span class="o">=</span> <span class="n">frags</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">frag_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">datalen</span><span class="o">/</span><span class="n">frags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">?</span>
			   <span class="p">(</span><span class="n">datalen</span><span class="o">/</span><span class="n">frags</span><span class="p">)</span> <span class="o">:</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">node</span> <span class="o">=</span> <span class="n">numa_node_id</span><span class="p">();</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_NODE</span><span class="p">))</span>
					<span class="n">node</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">get_page</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
			<span class="n">skb_frag_set_page</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*last fragment, fill rest of data*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="p">(</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">?</span> <span class="n">datalen</span> <span class="o">:</span> <span class="n">PAGE_SIZE</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">frag_len</span><span class="p">);</span>
			<span class="n">datalen</span> <span class="o">-=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Stamp the time, and sequence number,</span>
<span class="cm">	 * convert them to network byte order</span>
<span class="cm">	 */</span>
	<span class="n">pgh</span><span class="o">-&gt;</span><span class="n">pgh_magic</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">PKTGEN_MAGIC</span><span class="p">);</span>
	<span class="n">pgh</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">);</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timestamp</span><span class="p">);</span>
	<span class="n">pgh</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">pgh</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">fill_packet_ipv4</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">odev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="n">udph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">iplen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">mpls</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                 <span class="cm">/* Encapsulates priority and VLAN ID */</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">vlan_encapsulated_proto</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* packet type ID field (or len) for VLAN tag */</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">svlan_tci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                <span class="cm">/* Encapsulates priority and SVLAN ID */</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">svlan_encapsulated_proto</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* packet type ID field (or len) for SVLAN tag */</span>
	<span class="n">u16</span> <span class="n">queue_map</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">)</span>
		<span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_MPLS_UC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>

	<span class="cm">/* Update any of the values, used when we&#39;re incrementing various</span>
<span class="cm">	 * fields.</span>
<span class="cm">	 */</span>
	<span class="n">mod_cur_headers</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="n">queue_map</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span><span class="p">;</span>

	<span class="n">datalen</span> <span class="o">=</span> <span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_NODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">node</span> <span class="o">=</span>  <span class="n">numa_node_id</span><span class="p">();</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">__alloc_skb</span><span class="p">(</span><span class="n">NET_SKB_PAD</span> <span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">+</span> <span class="mi">64</span>
				  <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_SKB_PAD</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">odev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	  <span class="n">skb</span> <span class="o">=</span> <span class="n">__netdev_alloc_skb</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span>
				   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">+</span> <span class="mi">64</span>
				   <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;No memory&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>

	<span class="cm">/*  Reserve for ethernet and IP header  */</span>
	<span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">mpls</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">)</span>
		<span class="n">mpls_push</span><span class="p">(</span><span class="n">mpls</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">svlan_tci</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
			<span class="o">*</span><span class="n">svlan_tci</span> <span class="o">=</span> <span class="n">build_tci</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span><span class="p">,</span>
					       <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_cfi</span><span class="p">,</span>
					       <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_p</span><span class="p">);</span>
			<span class="n">svlan_encapsulated_proto</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
			<span class="o">*</span><span class="n">svlan_encapsulated_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">vlan_tci</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
		<span class="o">*</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">build_tci</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">,</span>
				      <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_cfi</span><span class="p">,</span>
				      <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_p</span><span class="p">);</span>
		<span class="n">vlan_encapsulated_proto</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
		<span class="o">*</span><span class="n">vlan_encapsulated_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">));</span>
	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">queue_map</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb_priority</span><span class="p">;</span>

	<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">udph</span> <span class="o">=</span> <span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">eth</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">eth</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>

	<span class="cm">/* Eth + IPh + UDPh + mpls */</span>
	<span class="n">datalen</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">-</span> <span class="mi">14</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span>
		  <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_hdr</span><span class="p">))</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_hdr</span><span class="p">);</span>

	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span><span class="p">);</span>
	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span><span class="p">);</span>
	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">datalen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* DATA + udphdr */</span>
	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No checksum */</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">;</span>	<span class="cm">/* UDP */</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_saddr</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_daddr</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">ip_id</span><span class="p">);</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">ip_id</span><span class="o">++</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iplen</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">iplen</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="n">ip_fast_csum</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">-</span> <span class="n">ETH_HLEN</span> <span class="o">-</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">odev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
	<span class="n">pktgen_finalize_skb</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">process_ipsec</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">protocol</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * scan_ip6, fmt_ip taken from dietlibc-0.21</span>
<span class="cm"> * Author Felix von Leitner &lt;felix-dietlibc@fefe.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Slightly modified for kernel.</span>
<span class="cm"> * Should be candidate for net/ipv4/utils.c</span>
<span class="cm"> * --ro</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">scan_ip6</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">suffix</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prefixlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">suffixlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Found &quot;::&quot;, skip to part 2 */</span>
				<span class="n">s</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">len</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">s</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">u</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefixlen</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* the last 4 bytes may be written as IPv4 address */</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="p">)(</span><span class="n">ip</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ip</span><span class="p">[</span><span class="n">prefixlen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ip</span><span class="p">[</span><span class="n">prefixlen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefixlen</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/* part 2, after &quot;::&quot; */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">suffixlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">s</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">suffixlen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">u</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
				<span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">suffixlen</span> <span class="o">+</span> <span class="n">prefixlen</span> <span class="o">&lt;=</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="p">)(</span><span class="n">suffix</span> <span class="o">+</span> <span class="n">suffixlen</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">suffixlen</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">suffix</span><span class="p">[</span><span class="n">suffixlen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">suffix</span><span class="p">[</span><span class="n">suffixlen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefixlen</span> <span class="o">+</span> <span class="n">suffixlen</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">suffixlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ip</span><span class="p">[</span><span class="mi">16</span> <span class="o">-</span> <span class="n">suffixlen</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">fill_packet_ipv6</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">odev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="n">udph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6hdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">mpls</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                 <span class="cm">/* Encapsulates priority and VLAN ID */</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">vlan_encapsulated_proto</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* packet type ID field (or len) for VLAN tag */</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">svlan_tci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                <span class="cm">/* Encapsulates priority and SVLAN ID */</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">svlan_encapsulated_proto</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* packet type ID field (or len) for SVLAN tag */</span>
	<span class="n">u16</span> <span class="n">queue_map</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">)</span>
		<span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_MPLS_UC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>

	<span class="cm">/* Update any of the values, used when we&#39;re incrementing various</span>
<span class="cm">	 * fields.</span>
<span class="cm">	 */</span>
	<span class="n">mod_cur_headers</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="n">queue_map</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_queue_map</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">__netdev_alloc_skb</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span>
				 <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">+</span> <span class="mi">64</span>
				 <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;No memory&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/*  Reserve for ethernet and IP header  */</span>
	<span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">mpls</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nr_labels</span><span class="p">)</span>
		<span class="n">mpls_push</span><span class="p">(</span><span class="n">mpls</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">svlan_tci</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
			<span class="o">*</span><span class="n">svlan_tci</span> <span class="o">=</span> <span class="n">build_tci</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span><span class="p">,</span>
					       <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_cfi</span><span class="p">,</span>
					       <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_p</span><span class="p">);</span>
			<span class="n">svlan_encapsulated_proto</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
			<span class="o">*</span><span class="n">svlan_encapsulated_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">vlan_tci</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
		<span class="o">*</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">build_tci</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">,</span>
				      <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_cfi</span><span class="p">,</span>
				      <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_p</span><span class="p">);</span>
		<span class="n">vlan_encapsulated_proto</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
		<span class="o">*</span><span class="n">vlan_encapsulated_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">));</span>
	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">queue_map</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb_priority</span><span class="p">;</span>
	<span class="n">iph</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">udph</span> <span class="o">=</span> <span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">eth</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">hh</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">eth</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>

	<span class="cm">/* Eth + IPh + UDPh + mpls */</span>
	<span class="n">datalen</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span> <span class="o">-</span> <span class="mi">14</span> <span class="o">-</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">-</span>
		  <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_hdr</span><span class="p">);</span>
		<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;increased datalen to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_src</span><span class="p">);</span>
	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_udp_dst</span><span class="p">);</span>
	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">datalen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">));</span>
	<span class="n">udph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No checksum */</span>

	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">iph</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0x60000000</span><span class="p">);</span>	<span class="cm">/* Version + flow */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Version + traffic class + flow (0) */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0x60000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">hop_limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">payload_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">datalen</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">nexthdr</span> <span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">;</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_daddr</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_in6_saddr</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">-</span> <span class="n">ETH_HLEN</span> <span class="o">-</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pkt_overhead</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">odev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>

	<span class="n">pktgen_finalize_skb</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">fill_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">odev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F_IPV6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fill_packet_ipv6</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">fill_packet_ipv4</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_clear_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">idle_acc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">sofar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set up structure for sending pkts, clear counters */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">func_enter</span><span class="p">();</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * setup odev and create initial packet.</span>
<span class="cm">		 */</span>
		<span class="n">pktgen_setup_inject</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pktgen_clear_counters</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Cranke yeself! */</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">started_at</span> <span class="o">=</span>
				<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="n">ktime_now</span><span class="p">();</span>

			<span class="n">set_pkt_overhead</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>

			<span class="n">strcpy</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;Starting&quot;</span><span class="p">);</span>
			<span class="n">started</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;Error starting&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">started</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">T_STOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_stop_all_threads_ifs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">func_enter</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="n">th_list</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">T_STOP</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">thread_is_running</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_wait_thread_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">thread_is_running</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">signal</span><span class="p">;</span>
		<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">signal:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_wait_all_threads_run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="n">th_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">pktgen_wait_thread_run</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="n">th_list</span><span class="p">)</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">T_STOP</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sig</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_run_all_threads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">func_enter</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="n">th_list</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">T_RUN</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

	<span class="cm">/* Propagate thread-&gt;control  */</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">125</span><span class="p">));</span>

	<span class="n">pktgen_wait_all_threads_run</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_reset_all_threads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">func_enter</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="n">th_list</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">T_REMDEVALL</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

	<span class="cm">/* Propagate thread-&gt;control  */</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">125</span><span class="p">));</span>

	<span class="n">pktgen_wait_all_threads_run</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_results</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_frags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">bps</span><span class="p">,</span> <span class="n">mbps</span><span class="p">,</span> <span class="n">pps</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">ktime_sub</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">stopped_at</span><span class="p">,</span>
				    <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">started_at</span><span class="p">);</span>
	<span class="n">ktime_t</span> <span class="n">idle</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">idle_acc</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;OK: %llu(c%llu+d%llu) usec, %llu (%dbyte,%dfrags)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ktime_to_us</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ktime_to_us</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">idle</span><span class="p">)),</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ktime_to_us</span><span class="p">(</span><span class="n">idle</span><span class="p">),</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">sofar</span><span class="p">,</span>
		     <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">);</span>

	<span class="n">pps</span> <span class="o">=</span> <span class="n">div64_u64</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">sofar</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">,</span>
			<span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">elapsed</span><span class="p">));</span>

	<span class="n">bps</span> <span class="o">=</span> <span class="n">pps</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">cur_pkt_size</span><span class="p">;</span>

	<span class="n">mbps</span> <span class="o">=</span> <span class="n">bps</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">mbps</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;  %llupps %lluMb/sec (%llubps) errors: %llu&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pps</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mbps</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bps</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set stopped-at timer, remove from running list, do counters &amp; statistics */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_stop_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">?</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;interface: %s is already stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">stopped_at</span> <span class="o">=</span> <span class="n">ktime_now</span><span class="p">();</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">show_results</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="nf">next_to_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">best</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">best</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ktime_lt</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">next_tx</span><span class="p">,</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">next_tx</span><span class="p">))</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">best</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">;</span>

	<span class="n">func_enter</span><span class="p">();</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pktgen_stop_device</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * one of our devices needs to be removed - find it</span>
<span class="cm"> * and remove it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_rem_one_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

	<span class="n">func_enter</span><span class="p">();</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_dev</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">removal_mark</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pktgen_remove_device</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_rem_all_ifs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

	<span class="n">func_enter</span><span class="p">();</span>

	<span class="cm">/* Remove all devices, free mem */</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_dev</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pktgen_remove_device</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_rem_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Remove from the thread list */</span>

	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_resched</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">idle_start</span> <span class="o">=</span> <span class="n">ktime_now</span><span class="p">();</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">idle_acc</span> <span class="o">+=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">ktime_now</span><span class="p">(),</span> <span class="n">idle_start</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_wait_for_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">idle_start</span> <span class="o">=</span> <span class="n">ktime_now</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
			<span class="n">pktgen_resched</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">idle_acc</span> <span class="o">+=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">ktime_now</span><span class="p">(),</span> <span class="n">idle_start</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pktgen_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">odev</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">;</span>
	<span class="n">netdev_tx_t</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">=</span> <span class="n">odev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_start_xmit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">queue_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If device is offline, then don&#39;t send */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">odev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">odev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pktgen_stop_device</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is max DELAY, this has special meaning of</span>
<span class="cm">	 * &quot;never transmit&quot;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">==</span> <span class="n">ULLONG_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">ktime_now</span><span class="p">(),</span> <span class="n">ULONG_MAX</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If no skb or clone count exhausted then get new one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">||</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">last_ok</span> <span class="o">&amp;&amp;</span>
			      <span class="o">++</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_count</span> <span class="o">&gt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* build a new pkt */</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">fill_packet</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: couldn&#39;t allocate skb in fill_packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_count</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* back out increment, OOM */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">last_pkt_size</span> <span class="o">=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">allocated_skbs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* reset counter */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">last_ok</span><span class="p">)</span>
		<span class="n">spin</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">next_tx</span><span class="p">);</span>

	<span class="n">queue_map</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span> <span class="n">queue_map</span><span class="p">);</span>

	<span class="n">__netif_tx_lock_bh</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netif_xmit_frozen_or_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">last_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit</span><span class="p">)(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">odev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_TX_OK</span>:
		<span class="n">txq_trans_update</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">last_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">sofar</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">last_pkt_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NET_XMIT_DROP</span>:
	<span class="k">case</span> <span class="n">NET_XMIT_CN</span>:
	<span class="k">case</span> <span class="n">NET_XMIT_POLICED</span>:
		<span class="cm">/* skb has been consumed */</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* Drivers are not supposed to return other values! */</span>
		<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;%s xmit error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">errors</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">NETDEV_TX_LOCKED</span>:
	<span class="k">case</span> <span class="n">NETDEV_TX_BUSY</span>:
		<span class="cm">/* Retry it next time */</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">));</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">last_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">unlock:</span>
	<span class="n">__netif_tx_unlock_bh</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

	<span class="cm">/* If pkt_dev-&gt;count is zero, then run forever */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">sofar</span> <span class="o">&gt;=</span> <span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pktgen_wait_for_skb</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>

		<span class="cm">/* Done with this */</span>
		<span class="n">pktgen_stop_device</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Main loop of the thread goes here</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_thread_worker</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">start_done</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;starting pktgen/%d:  pid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

	<span class="n">set_freezable</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">next_to_run</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pktgen_exiting</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
							 <span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
							 <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">try_to_freeze</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pktgen_xmit</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
				<span class="n">pktgen_resched</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">T_STOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pktgen_stop</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">T_STOP</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">T_RUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pktgen_run</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">T_RUN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">T_REMDEVALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pktgen_rem_all_ifs</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">T_REMDEVALL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">T_REMDEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pktgen_rem_one_if</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">T_REMDEV</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s stopping all device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="n">pktgen_stop</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s removing all device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="n">pktgen_rem_all_ifs</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s removing thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="n">pktgen_rem_thread</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="cm">/* Wait for kthread_stop */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="nf">pktgen_find_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="n">bool</span> <span class="n">exact</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ifname</span><span class="p">);</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">[</span><span class="n">len</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">exact</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;find_dev(%s) returning %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pkt_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adds a dev at front of if_list.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_dev_to_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">if_lock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pg_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: already assigned to a thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">);</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">pg_thread</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">if_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called under thread lock */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">node</span> <span class="o">=</span> <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t allow a device to be on several threads */</span>

	<span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">__pktgen_NN_threads</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">FIND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: interface already used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odevname</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span> <span class="o">=</span> <span class="n">vzalloc_node</span><span class="p">(</span><span class="n">MAX_CFLOWS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flow_state</span><span class="p">),</span>
				      <span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">removal_mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">min_pkt_size</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">nfrags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">pg_delay_d</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">pg_count_d</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">sofar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_min</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>	<span class="cm">/* sink port */</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_src_max</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_min</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">udp_dst_max</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_cfi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_cfi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">svlan_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pktgen_setup_dev</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_TX_SKB_SHARING</span><span class="p">)</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">clone_skb</span> <span class="o">=</span> <span class="n">pg_clone_skb_d</span><span class="p">;</span>

	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">pktgen_if_fops</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot create %s/%s procfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">PG_PROC_DIR</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">ipsmode</span> <span class="o">=</span> <span class="n">XFRM_MODE_TRANSPORT</span><span class="p">;</span>
	<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">ipsproto</span> <span class="o">=</span> <span class="n">IPPROTO_ESP</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">add_dev_to_thread</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">);</span>
<span class="nl">out1:</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="n">free_SAs</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pktgen_create_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
			 <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: out of memory, can&#39;t create new thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">th_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">start_done</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kthread_create_on_node</span><span class="p">(</span><span class="n">pktgen_thread_worker</span><span class="p">,</span>
				   <span class="n">t</span><span class="p">,</span>
				   <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">),</span>
				   <span class="s">&quot;kpktgend_%d&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;kernel_thread() failed for cpu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">th_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kthread_bind</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pktgen_thread_fops</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot create %s/%s procfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">PG_PROC_DIR</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">th_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">start_done</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Removes a device from the thread if_list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rem_dev_from_if_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">if_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_dev</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pkt_dev</span><span class="p">)</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pktgen_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pktgen_dev</span> <span class="o">*</span><span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;remove_device pkt_dev=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;WARNING: trying to remove a running interface, stopping it now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pktgen_stop_device</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Dis-associate from the interface */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span><span class="p">);</span>
		<span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">odev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* And update the thread if_list */</span>

	<span class="n">_rem_dev_from_if_list</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pkt_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="n">free_SAs</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">pkt_dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pg_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">pg_proc_dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">PG_PROC_DIR</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg_proc_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="n">PGCTRL</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktgen_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: cannot create %s procfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PGCTRL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">remove_dir</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_notifier_block</span><span class="p">);</span>

	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pktgen_create_thread</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;WARNING: Cannot create thread for cpu %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">cpu</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERROR: Initialization failed for all threads</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">unregister:</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_notifier_block</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">PGCTRL</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">);</span>
 <span class="nl">remove_dir:</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">PG_PROC_DIR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pg_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktgen_thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* Stop all interfaces &amp; threads */</span>
	<span class="n">pktgen_exiting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_threads</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_thread_lock</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktgen_thread</span><span class="p">,</span> <span class="n">th_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">th_list</span><span class="p">);</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Un-register us from receiving netdevice events */</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktgen_notifier_block</span><span class="p">);</span>

	<span class="cm">/* Clean up proc file system */</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">PGCTRL</span><span class="p">,</span> <span class="n">pg_proc_dir</span><span class="p">);</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">PG_PROC_DIR</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pg_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pg_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Robert Olsson &lt;robert.olsson@its.uu.se&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Packet Generator tool&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">VERSION</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pg_count_d</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pg_count_d</span><span class="p">,</span> <span class="s">&quot;Default number of packets to inject&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pg_delay_d</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pg_delay_d</span><span class="p">,</span> <span class="s">&quot;Default delay between packets (nanoseconds)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pg_clone_skb_d</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pg_clone_skb_d</span><span class="p">,</span> <span class="s">&quot;Default number of copies of the same packet&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable debugging of pktgen module&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
