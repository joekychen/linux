<!DOCTYPE html>
<html><head><title>joekychen/linux » net › core › net-sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>net-sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net-sysfs.c - network device class and attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 Stephen Hemminger &lt;shemminger@osdl.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License</span>
<span class="cm"> *	as published by the Free Software Foundation; either version</span>
<span class="cm"> *	2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;net/wext.h&gt;</span>

<span class="cp">#include &quot;net-sysfs.h&quot;</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fmt_hex</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fmt_long_hex</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fmt_dec</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fmt_udec</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fmt_ulong</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fmt_u64</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dev_isalive</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">&lt;=</span> <span class="n">NETREG_REGISTERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* use same locking rules as GIF* ioctl&#39;s */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">netdev_show</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_isalive</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span><span class="p">)(</span><span class="n">net</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* generate a show function for simple field */</span>
<span class="cp">#define NETDEVICE_SHOW(field, format_string)				\</span>
<span class="cp">static ssize_t format_##field(const struct net_device *net, char *buf)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return sprintf(buf, format_string, net-&gt;field);			\</span>
<span class="cp">}									\</span>
<span class="cp">static ssize_t show_##field(struct device *dev,				\</span>
<span class="cp">			    struct device_attribute *attr, char *buf)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return netdev_show(dev, attr, buf, format_##field);		\</span>
<span class="cp">}</span>


<span class="cm">/* use same locking and permission rules as SIF* ioctl&#39;s */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">netdev_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_isalive</span><span class="p">(</span><span class="n">net</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)(</span><span class="n">net</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
 <span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">fmt_hex</span><span class="p">);</span>
<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">addr_assign_type</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">addr_len</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">iflink</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">link_mode</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>

<span class="cm">/* use same locking rules as GIFHWADDR ioctl&#39;s */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_isalive</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_format_mac</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_broadcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_isalive</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sysfs_format_mac</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">,</span> <span class="o">!!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__ethtool_get_settings</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt_udec</span><span class="p">,</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__ethtool_get_settings</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="p">.</span><span class="n">duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_dormant</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">,</span> <span class="o">!!</span><span class="n">netif_dormant</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">operstates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;notpresent&quot;</span><span class="p">,</span> <span class="cm">/* currently unused */</span>
	<span class="s">&quot;down&quot;</span><span class="p">,</span>
	<span class="s">&quot;lowerlayerdown&quot;</span><span class="p">,</span>
	<span class="s">&quot;testing&quot;</span><span class="p">,</span> <span class="cm">/* currently unused */</span>
	<span class="s">&quot;dormant&quot;</span><span class="p">,</span>
	<span class="s">&quot;up&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_operstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">operstate</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>
	<span class="n">operstate</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">operstate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">operstate</span> <span class="o">=</span> <span class="n">IF_OPER_DOWN</span><span class="p">;</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">operstate</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">operstates</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* should not happen */</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">operstates</span><span class="p">[</span><span class="n">operstate</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* read-write attributes */</span>
<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev_set_mtu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">new_mtu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_store</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">change_mtu</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">fmt_hex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev_change_flags</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">new_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_store</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">change_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">tx_queue_len</span><span class="p">,</span> <span class="n">fmt_ulong</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_tx_queue_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">new_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_tx_queue_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_store</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">change_tx_queue_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_ifalias</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* ignore trailing newline */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="o">--</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_set_alias</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ifalias</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifalias</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ifalias</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NETDEVICE_SHOW</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_set_group</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">new_group</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_store</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">change_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">net_class_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">addr_assign_type</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_addr_assign_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">addr_len</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_addr_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_dev_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ifalias</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_ifalias</span><span class="p">,</span> <span class="n">store_ifalias</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">iflink</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_iflink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_ifindex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">link_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_link_mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_address</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">broadcast</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_broadcast</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_carrier</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_speed</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">duplex</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_duplex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">dormant</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_dormant</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">operstate</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_operstate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_mtu</span><span class="p">,</span> <span class="n">store_mtu</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_flags</span><span class="p">,</span> <span class="n">store_flags</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">tx_queue_len</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_tx_queue_len</span><span class="p">,</span>
	       <span class="n">store_tx_queue_len</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">netdev_group</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_group</span><span class="p">,</span> <span class="n">store_group</span><span class="p">),</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/* Show a given an attribute in the statistics group */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">netstat_show</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtnl_link_stats64</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">offset</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_isalive</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">dev_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt_u64</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">stats</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* generate a read-only statistics attribute */</span>
<span class="cp">#define NETSTAT_ENTRY(name)						\</span>
<span class="cp">static ssize_t show_##name(struct device *d,				\</span>
<span class="cp">			   struct device_attribute *attr, char *buf) 	\</span>
<span class="cp">{									\</span>
<span class="cp">	return netstat_show(d, attr, buf,				\</span>
<span class="cp">			    offsetof(struct rtnl_link_stats64, name));	\</span>
<span class="cp">}									\</span>
<span class="cp">static DEVICE_ATTR(name, S_IRUGO, show_##name, NULL)</span>

<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_packets</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_packets</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_bytes</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_bytes</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_dropped</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_dropped</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">multicast</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">collisions</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_length_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_over_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_crc_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_frame_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_fifo_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_missed_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_aborted_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_carrier_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_fifo_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_heartbeat_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_window_errors</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">rx_compressed</span><span class="p">);</span>
<span class="n">NETSTAT_ENTRY</span><span class="p">(</span><span class="n">tx_compressed</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">netstat_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_packets</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_packets</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_bytes</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_bytes</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_dropped</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_dropped</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_multicast</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_collisions</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_length_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_over_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_crc_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_frame_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_fifo_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_missed_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_aborted_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_carrier_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_fifo_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_heartbeat_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_window_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rx_compressed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_compressed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">netstat_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;statistics&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span>  <span class="o">=</span> <span class="n">netstat_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_WIRELESS_EXT_SYSFS</span>
<span class="cm">/* helper function that does all the locking etc for wireless stats */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wireless_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="p">,</span>
					       <span class="kt">char</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">iw</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_isalive</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iw</span> <span class="o">=</span> <span class="n">get_wireless_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iw</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span><span class="p">)(</span><span class="n">iw</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* show function template for wireless fields */</span>
<span class="cp">#define WIRELESS_SHOW(name, field, format_string)			\</span>
<span class="cp">static ssize_t format_iw_##name(const struct iw_statistics *iw, char *buf) \</span>
<span class="cp">{									\</span>
<span class="cp">	return sprintf(buf, format_string, iw-&gt;field);			\</span>
<span class="cp">}									\</span>
<span class="cp">static ssize_t show_iw_##name(struct device *d,				\</span>
<span class="cp">			      struct device_attribute *attr, char *buf)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return wireless_show(d, buf, format_iw_##name);			\</span>
<span class="cp">}									\</span>
<span class="cp">static DEVICE_ATTR(name, S_IRUGO, show_iw_##name, NULL)</span>

<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">fmt_hex</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">qual</span><span class="p">.</span><span class="n">qual</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">qual</span><span class="p">.</span><span class="n">level</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">qual</span><span class="p">.</span><span class="n">noise</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">nwid</span><span class="p">,</span> <span class="n">discard</span><span class="p">.</span><span class="n">nwid</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">crypt</span><span class="p">,</span> <span class="n">discard</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">fragment</span><span class="p">,</span> <span class="n">discard</span><span class="p">.</span><span class="n">fragment</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">misc</span><span class="p">,</span> <span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">retries</span><span class="p">,</span> <span class="n">discard</span><span class="p">.</span><span class="n">retries</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>
<span class="n">WIRELESS_SHOW</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">miss</span><span class="p">.</span><span class="n">beacon</span><span class="p">,</span> <span class="n">fmt_dec</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">wireless_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_link</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_noise</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_nwid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_crypt</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fragment</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_retries</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_misc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_beacon</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">wireless_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wireless&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">wireless_attrs</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSFS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_RPS</span>
<span class="cm">/*</span>
<span class="cm"> * RX queue sysfs structures and functions.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="p">};</span>
<span class="cp">#define to_rx_queue_attr(_attr) container_of(_attr,		\</span>
<span class="cp">    struct rx_queue_attribute, attr)</span>

<span class="cp">#define to_rx_queue(obj) container_of(obj, struct netdev_rx_queue, kobj)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rx_queue_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">to_rx_queue_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">to_rx_queue</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attribute</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">attribute</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rx_queue_attr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">to_rx_queue_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">to_rx_queue</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attribute</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">attribute</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">rx_queue_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">rx_queue_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">rx_queue_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rps_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rps_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">cpumask_scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_rps_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rps_map</span> <span class="o">*</span><span class="n">old_map</span><span class="p">,</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">rps_map_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_parse</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cpumask_bits</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">nr_cpumask_bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
	    <span class="n">RPS_MAP_SIZE</span><span class="p">(</span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">mask</span><span class="p">)),</span> <span class="n">L1_CACHE_BYTES</span><span class="p">),</span>
	    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_cpu_and</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cpu_online_mask</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
		<span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_map_lock</span><span class="p">);</span>
	<span class="n">old_map</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_map</span><span class="p">,</span>
					    <span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_map_lock</span><span class="p">));</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_map</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_map_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span>
		<span class="n">static_key_slow_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_needed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">old_map</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
		<span class="n">static_key_slow_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_needed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rps_dev_flow_table_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rps_dev_flow_table</span> <span class="o">*</span><span class="n">flow_table</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">flow_table</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_flow_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_table</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">flow_table</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rps_dev_flow_table_release_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rps_dev_flow_table</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">rps_dev_flow_table</span><span class="p">,</span> <span class="n">free_work</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rps_dev_flow_table_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rps_dev_flow_table</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rcu</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">rps_dev_flow_table</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">free_work</span><span class="p">,</span> <span class="n">rps_dev_flow_table_release_work</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">free_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_rps_dev_flow_table_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rps_dev_flow_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">old_table</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">rps_dev_flow_lock</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* mask = roundup_pow_of_two(count) - 1;</span>
<span class="cm">		 * without overflows...</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* On 64 bit arches, must check mask fits in table-&gt;mask (u32),</span>
<span class="cm">		 * and on 32bit arches, must check RPS_DEV_FLOW_TABLE_SIZE(mask + 1)</span>
<span class="cm">		 * doesnt overflow.</span>
<span class="cm">		 */</span>
<span class="cp">#if BITS_PER_LONG &gt; 32</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">u32</span><span class="p">)</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ULONG_MAX</span> <span class="o">-</span> <span class="n">RPS_DEV_FLOW_TABLE_SIZE</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
				<span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rps_dev_flow</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Enforce a limit to prevent overflow */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">RPS_DEV_FLOW_TABLE_SIZE</span><span class="p">(</span><span class="n">mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">table</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">mask</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
			<span class="n">table</span><span class="o">-&gt;</span><span class="n">flows</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">RPS_NO_CPU</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_dev_flow_lock</span><span class="p">);</span>
	<span class="n">old_table</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_flow_table</span><span class="p">,</span>
					      <span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_dev_flow_lock</span><span class="p">));</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_flow_table</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rps_dev_flow_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_table</span><span class="p">)</span>
		<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_table</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">rps_dev_flow_table_release</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="n">rps_cpus_attribute</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rps_cpus</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_rps_map</span><span class="p">,</span> <span class="n">store_rps_map</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">rx_queue_attribute</span> <span class="n">rps_dev_flow_table_cnt_attribute</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rps_flow_cnt</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	    <span class="n">show_rps_dev_flow_table_cnt</span><span class="p">,</span> <span class="n">store_rps_dev_flow_table_cnt</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">rx_queue_default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">rps_cpus_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rps_dev_flow_table_cnt_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_queue_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">to_rx_queue</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rps_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rps_dev_flow_table</span> <span class="o">*</span><span class="n">flow_table</span><span class="p">;</span>


	<span class="n">map</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_map</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">flow_table</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_flow_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rps_flow_table</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flow_table</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">rps_dev_flow_table_release</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kobj</span><span class="p">));</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">rx_queue_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_queue_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">rx_queue_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">rx_queue_default_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_queue_add_kobject</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_rx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">_rx</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kobj</span><span class="o">-&gt;</span><span class="n">kset</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">queues_kset</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_queue_ktype</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	    <span class="s">&quot;rx-%u&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="n">dev_hold</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RPS */</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">net_rx_queue_update_kobjects</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_num</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_RPS</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">old_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">new_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">rx_queue_add_kobject</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_num</span> <span class="o">=</span> <span class="n">old_num</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">new_num</span><span class="p">)</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">_rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kobj</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>
<span class="cm">/*</span>
<span class="cm"> * netdev_queue sysfs structures and functions.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="p">};</span>
<span class="cp">#define to_netdev_queue_attr(_attr) container_of(_attr,		\</span>
<span class="cp">    struct netdev_queue_attribute, attr)</span>

<span class="cp">#define to_netdev_queue(obj) container_of(obj, struct netdev_queue, kobj)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">netdev_queue_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">to_netdev_queue_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">to_netdev_queue</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attribute</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">attribute</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">netdev_queue_attr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">to_netdev_queue_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">to_netdev_queue</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attribute</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">attribute</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">netdev_queue_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">netdev_queue_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">netdev_queue_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_trans_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trans_timeout</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">_xmit_lock</span><span class="p">);</span>
	<span class="n">trans_timeout</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">trans_timeout</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">_xmit_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="n">trans_timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="n">queue_trans_timeout</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">tx_timeout</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_trans_timeout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BQL</span>
<span class="cm">/*</span>
<span class="cm"> * Byte queue limits sysfs structures and functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bql_show</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bql_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pvalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;max&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;max</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">DQL_MAX_LIMIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">DQL_MAX_LIMIT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pvalue</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bql_show_hold_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dql</span> <span class="o">*</span><span class="n">dql</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">dql</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">dql</span><span class="o">-&gt;</span><span class="n">slack_hold_time</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bql_set_hold_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dql</span> <span class="o">*</span><span class="n">dql</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">dql</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dql</span><span class="o">-&gt;</span><span class="n">slack_hold_time</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="n">bql_hold_time_attribute</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hold_time</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bql_show_hold_time</span><span class="p">,</span>
	    <span class="n">bql_set_hold_time</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bql_show_inflight</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dql</span> <span class="o">*</span><span class="n">dql</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">dql</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dql</span><span class="o">-&gt;</span><span class="n">num_queued</span> <span class="o">-</span> <span class="n">dql</span><span class="o">-&gt;</span><span class="n">num_completed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="n">bql_inflight_attribute</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">inflight</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bql_show_inflight</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#define BQL_ATTR(NAME, FIELD)						\</span>
<span class="cp">static ssize_t bql_show_ ## NAME(struct netdev_queue *queue,		\</span>
<span class="cp">				 struct netdev_queue_attribute *attr,	\</span>
<span class="cp">				 char *buf)				\</span>
<span class="cp">{									\</span>
<span class="cp">	return bql_show(buf, queue-&gt;dql.FIELD);				\</span>
<span class="cp">}									\</span>
<span class="cp">									\</span>
<span class="cp">static ssize_t bql_set_ ## NAME(struct netdev_queue *queue,		\</span>
<span class="cp">				struct netdev_queue_attribute *attr,	\</span>
<span class="cp">				const char *buf, size_t len)		\</span>
<span class="cp">{									\</span>
<span class="cp">	return bql_set(buf, len, &amp;queue-&gt;dql.FIELD);			\</span>
<span class="cp">}									\</span>
<span class="cp">									\</span>
<span class="cp">static struct netdev_queue_attribute bql_ ## NAME ## _attribute =	\</span>
<span class="cp">	__ATTR(NAME, S_IRUGO | S_IWUSR, bql_show_ ## NAME,		\</span>
<span class="cp">	    bql_set_ ## NAME);</span>

<span class="n">BQL_ATTR</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
<span class="n">BQL_ATTR</span><span class="p">(</span><span class="n">limit_max</span><span class="p">,</span> <span class="n">max_limit</span><span class="p">)</span>
<span class="n">BQL_ATTR</span><span class="p">(</span><span class="n">limit_min</span><span class="p">,</span> <span class="n">min_limit</span><span class="p">)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dql_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">bql_limit_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bql_limit_max_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bql_limit_min_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bql_hold_time_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bql_inflight_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dql_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;byte_queue_limits&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span>  <span class="o">=</span> <span class="n">dql_attrs</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BQL */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_XPS</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_netdev_queue_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">_tx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_xps_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xps_dev_maps</span> <span class="o">*</span><span class="n">dev_maps</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">get_netdev_queue_index</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dev_maps</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xps_maps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_maps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xps_map</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span>
			    <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">cpumask_scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">xps_map_mutex</span><span class="p">);</span>
<span class="cp">#define xmap_dereference(P)		\</span>
<span class="cp">	rcu_dereference_protected((P), lockdep_is_held(&amp;xps_map_mutex))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xps_queue_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xps_dev_maps</span> <span class="o">*</span><span class="n">dev_maps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xps_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nonempty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">get_netdev_queue_index</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xps_map_mutex</span><span class="p">);</span>
	<span class="n">dev_maps</span> <span class="o">=</span> <span class="n">xmap_dereference</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xps_maps</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_maps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">map</span> <span class="o">=</span> <span class="n">xmap_dereference</span><span class="p">(</span><span class="n">dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="o">--</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">];</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					    <span class="nb">NULL</span><span class="p">);</span>
					<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
					<span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span>
				<span class="n">nonempty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nonempty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xps_maps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">dev_maps</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xps_map_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_xps_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="o">*</span><span class="n">attribute</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">map_len</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="n">need_set</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xps_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="o">*</span><span class="n">new_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xps_dev_maps</span> <span class="o">*</span><span class="n">dev_maps</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dev_maps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nonempty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numa_node_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">get_netdev_queue_index</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_parse</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cpumask_bits</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">nr_cpumask_bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_dev_maps</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
	    <span class="n">XPS_DEV_MAPS_SIZE</span><span class="p">,</span> <span class="n">L1_CACHE_BYTES</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev_maps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xps_map_mutex</span><span class="p">);</span>

	<span class="n">dev_maps</span> <span class="o">=</span> <span class="n">xmap_dereference</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xps_maps</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">map</span> <span class="o">=</span> <span class="n">dev_maps</span> <span class="o">?</span>
			<span class="n">xmap_dereference</span><span class="p">(</span><span class="n">dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">])</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">new_map</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="n">map_len</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">alloc_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">map_len</span> <span class="o">=</span> <span class="n">alloc_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">need_set</span> <span class="o">=</span> <span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NUMA</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">numa_node_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
				<span class="n">numa_node_id</span> <span class="o">=</span> <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">numa_node_id</span> <span class="o">!=</span> <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
				<span class="n">numa_node_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_set</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">map_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Need to add queue to this CPU&#39;s map */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map_len</span> <span class="o">&gt;=</span> <span class="n">alloc_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">alloc_len</span> <span class="o">?</span>
				    <span class="mi">2</span> <span class="o">*</span> <span class="n">alloc_len</span> <span class="o">:</span> <span class="n">XPS_MIN_MAP_ALLOC</span><span class="p">;</span>
				<span class="n">new_map</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="n">XPS_MAP_SIZE</span><span class="p">(</span><span class="n">alloc_len</span><span class="p">),</span>
						       <span class="n">GFP_KERNEL</span><span class="p">,</span>
						       <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_map</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
				<span class="n">new_map</span><span class="o">-&gt;</span><span class="n">alloc_len</span> <span class="o">=</span> <span class="n">alloc_len</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">new_map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">new_map</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">map_len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">new_map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">new_map</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_set</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">map_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Need to remove queue from this CPU&#39;s map */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">new_map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">new_map</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">[</span><span class="o">--</span><span class="n">new_map</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">new_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">new_dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="n">new_map</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Cleanup old maps */</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">map</span> <span class="o">=</span> <span class="n">dev_maps</span> <span class="o">?</span>
			<span class="n">xmap_dereference</span><span class="p">(</span><span class="n">dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">])</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">&amp;&amp;</span> <span class="n">xmap_dereference</span><span class="p">(</span><span class="n">new_dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">])</span> <span class="o">!=</span> <span class="n">map</span><span class="p">)</span>
			<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">])</span>
			<span class="n">nonempty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nonempty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xps_maps</span><span class="p">,</span> <span class="n">new_dev_maps</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new_dev_maps</span><span class="p">);</span>
		<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xps_maps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_maps</span><span class="p">)</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">dev_maps</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="n">netdev_queue_numa_node_write</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="p">(</span><span class="n">numa_node_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">numa_node_id</span> <span class="o">:</span>
					    <span class="n">NUMA_NO_NODE</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xps_map_mutex</span><span class="p">);</span>

	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xps_map_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_dev_maps</span><span class="p">)</span>
		<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rcu_dereference_protected</span><span class="p">(</span>
				<span class="n">new_dev_maps</span><span class="o">-&gt;</span><span class="n">cpu_map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="mi">1</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new_dev_maps</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">netdev_queue_attribute</span> <span class="n">xps_cpus_attribute</span> <span class="o">=</span>
    <span class="n">__ATTR</span><span class="p">(</span><span class="n">xps_cpus</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_xps_map</span><span class="p">,</span> <span class="n">store_xps_map</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_XPS */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">netdev_queue_default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">queue_trans_timeout</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_XPS</span>
	<span class="o">&amp;</span><span class="n">xps_cpus_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_queue_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">to_netdev_queue</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_XPS</span>
	<span class="n">xps_queue_release</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kobj</span><span class="p">));</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">netdev_queue_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_queue_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">netdev_queue_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">netdev_queue_default_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_queue_add_kobject</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">_tx</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kobj</span><span class="o">-&gt;</span><span class="n">kset</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">queues_kset</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev_queue_ktype</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	    <span class="s">&quot;tx-%u&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_BQL</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dql_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="n">dev_hold</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSFS */</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">netdev_queue_update_kobjects</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_num</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">old_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">new_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">netdev_queue_add_kobject</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_num</span> <span class="o">=</span> <span class="n">old_num</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">new_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">_tx</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_BQL</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dql_group</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSFS */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">register_queue_kobjects</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rxq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">real_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">real_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">queues_kset</span> <span class="o">=</span> <span class="n">kset_create_and_add</span><span class="p">(</span><span class="s">&quot;queues&quot;</span><span class="p">,</span>
	    <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">queues_kset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_RPS</span>
	<span class="n">real_rx</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">real_num_rx_queues</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">real_tx</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">real_num_tx_queues</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">net_rx_queue_update_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">real_rx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">rxq</span> <span class="o">=</span> <span class="n">real_rx</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">netdev_queue_update_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">real_tx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="n">real_tx</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">netdev_queue_update_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">net_rx_queue_update_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">rxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_queue_kobjects</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">real_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">real_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_RPS</span>
	<span class="n">real_rx</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">real_num_rx_queues</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">real_tx</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">real_num_tx_queues</span><span class="p">;</span>

	<span class="n">net_rx_queue_update_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">real_rx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netdev_queue_update_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">real_tx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="n">kset_unregister</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">queues_kset</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">net_grab_current_ns</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_NET_NS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">passive</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">net_initial_ns</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">net_netlink_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kobj_ns_type_operations</span> <span class="n">net_ns_type_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">KOBJ_NS_TYPE_NET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">grab_current_ns</span> <span class="o">=</span> <span class="n">net_grab_current_ns</span><span class="p">,</span>
	<span class="p">.</span><span class="n">netlink_ns</span> <span class="o">=</span> <span class="n">net_netlink_ns</span><span class="p">,</span>
	<span class="p">.</span><span class="n">initial_ns</span> <span class="o">=</span> <span class="n">net_initial_ns</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_ns</span> <span class="o">=</span> <span class="n">net_drop_ns</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">net_ns_type_operations</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* pass interface to uevent. */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;INTERFACE=%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* pass ifindex to uevent.</span>
<span class="cm">	 * ifindex is useful as it won&#39;t change (interface name may change)</span>
<span class="cm">	 * and is what RtNetlink uses natively. */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;IFINDEX=%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	netdev_release -- destroy and free a dead device.</span>
<span class="cm"> *	Called when last reference to device kobject is gone.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">!=</span> <span class="n">NETREG_RELEASED</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifalias</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">padded</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">net_namespace</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="n">net_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;net&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_release</span> <span class="o">=</span> <span class="n">netdev_release</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="p">.</span><span class="n">dev_attrs</span> <span class="o">=</span> <span class="n">net_class_attributes</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSFS */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_HOTPLUG</span>
	<span class="p">.</span><span class="n">dev_uevent</span> <span class="o">=</span> <span class="n">netdev_uevent</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ns_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net_ns_type_operations</span><span class="p">,</span>
	<span class="p">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">net_namespace</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Delete sysfs entries but hold kobject reference until after all</span>
<span class="cm"> * netdev references are gone.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">netdev_unregister_kobject</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kobject_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>

	<span class="n">remove_queue_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">device_del</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Create sysfs entries for network device. */</span>
<span class="kt">int</span> <span class="nf">netdev_register_kobject</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">**</span><span class="n">groups</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">sysfs_groups</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net_class</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="cm">/* Allow for a device specific group */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">)</span>
		<span class="n">groups</span><span class="o">++</span><span class="p">;</span>

	<span class="o">*</span><span class="n">groups</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netstat_group</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_WIRELESS_EXT_SYSFS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">)</span>
		<span class="o">*</span><span class="n">groups</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wireless_group</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_WIRELESS_EXT</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span><span class="p">)</span>
		<span class="o">*</span><span class="n">groups</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wireless_group</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSFS */</span><span class="cp"></span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">register_queue_kobjects</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_del</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netdev_class_create_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">class_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">class_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_class</span><span class="p">,</span> <span class="n">class_attr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">netdev_class_create_file</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">netdev_class_remove_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">class_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">class_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_class</span><span class="p">,</span> <span class="n">class_attr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">netdev_class_remove_file</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">netdev_kobject_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kobj_ns_type_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_ns_type_operations</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">class_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_class</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
