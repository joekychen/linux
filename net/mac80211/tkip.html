<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › tkip.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tkip.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2002-2004, Instant802 Networks, Inc.</span>
<span class="cm"> * Copyright 2005, Devicescape Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &quot;driver-ops.h&quot;</span>
<span class="cp">#include &quot;key.h&quot;</span>
<span class="cp">#include &quot;tkip.h&quot;</span>
<span class="cp">#include &quot;wep.h&quot;</span>

<span class="cp">#define PHASE1_LOOP_COUNT 8</span>

<span class="cm">/*</span>
<span class="cm"> * 2-byte by 2-byte subset of the full AES S-box table; second part of this</span>
<span class="cm"> * table is identical to first part but byte-swapped</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">tkip_sbox</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mh">0xC6A5</span><span class="p">,</span> <span class="mh">0xF884</span><span class="p">,</span> <span class="mh">0xEE99</span><span class="p">,</span> <span class="mh">0xF68D</span><span class="p">,</span> <span class="mh">0xFF0D</span><span class="p">,</span> <span class="mh">0xD6BD</span><span class="p">,</span> <span class="mh">0xDEB1</span><span class="p">,</span> <span class="mh">0x9154</span><span class="p">,</span>
	<span class="mh">0x6050</span><span class="p">,</span> <span class="mh">0x0203</span><span class="p">,</span> <span class="mh">0xCEA9</span><span class="p">,</span> <span class="mh">0x567D</span><span class="p">,</span> <span class="mh">0xE719</span><span class="p">,</span> <span class="mh">0xB562</span><span class="p">,</span> <span class="mh">0x4DE6</span><span class="p">,</span> <span class="mh">0xEC9A</span><span class="p">,</span>
	<span class="mh">0x8F45</span><span class="p">,</span> <span class="mh">0x1F9D</span><span class="p">,</span> <span class="mh">0x8940</span><span class="p">,</span> <span class="mh">0xFA87</span><span class="p">,</span> <span class="mh">0xEF15</span><span class="p">,</span> <span class="mh">0xB2EB</span><span class="p">,</span> <span class="mh">0x8EC9</span><span class="p">,</span> <span class="mh">0xFB0B</span><span class="p">,</span>
	<span class="mh">0x41EC</span><span class="p">,</span> <span class="mh">0xB367</span><span class="p">,</span> <span class="mh">0x5FFD</span><span class="p">,</span> <span class="mh">0x45EA</span><span class="p">,</span> <span class="mh">0x23BF</span><span class="p">,</span> <span class="mh">0x53F7</span><span class="p">,</span> <span class="mh">0xE496</span><span class="p">,</span> <span class="mh">0x9B5B</span><span class="p">,</span>
	<span class="mh">0x75C2</span><span class="p">,</span> <span class="mh">0xE11C</span><span class="p">,</span> <span class="mh">0x3DAE</span><span class="p">,</span> <span class="mh">0x4C6A</span><span class="p">,</span> <span class="mh">0x6C5A</span><span class="p">,</span> <span class="mh">0x7E41</span><span class="p">,</span> <span class="mh">0xF502</span><span class="p">,</span> <span class="mh">0x834F</span><span class="p">,</span>
	<span class="mh">0x685C</span><span class="p">,</span> <span class="mh">0x51F4</span><span class="p">,</span> <span class="mh">0xD134</span><span class="p">,</span> <span class="mh">0xF908</span><span class="p">,</span> <span class="mh">0xE293</span><span class="p">,</span> <span class="mh">0xAB73</span><span class="p">,</span> <span class="mh">0x6253</span><span class="p">,</span> <span class="mh">0x2A3F</span><span class="p">,</span>
	<span class="mh">0x080C</span><span class="p">,</span> <span class="mh">0x9552</span><span class="p">,</span> <span class="mh">0x4665</span><span class="p">,</span> <span class="mh">0x9D5E</span><span class="p">,</span> <span class="mh">0x3028</span><span class="p">,</span> <span class="mh">0x37A1</span><span class="p">,</span> <span class="mh">0x0A0F</span><span class="p">,</span> <span class="mh">0x2FB5</span><span class="p">,</span>
	<span class="mh">0x0E09</span><span class="p">,</span> <span class="mh">0x2436</span><span class="p">,</span> <span class="mh">0x1B9B</span><span class="p">,</span> <span class="mh">0xDF3D</span><span class="p">,</span> <span class="mh">0xCD26</span><span class="p">,</span> <span class="mh">0x4E69</span><span class="p">,</span> <span class="mh">0x7FCD</span><span class="p">,</span> <span class="mh">0xEA9F</span><span class="p">,</span>
	<span class="mh">0x121B</span><span class="p">,</span> <span class="mh">0x1D9E</span><span class="p">,</span> <span class="mh">0x5874</span><span class="p">,</span> <span class="mh">0x342E</span><span class="p">,</span> <span class="mh">0x362D</span><span class="p">,</span> <span class="mh">0xDCB2</span><span class="p">,</span> <span class="mh">0xB4EE</span><span class="p">,</span> <span class="mh">0x5BFB</span><span class="p">,</span>
	<span class="mh">0xA4F6</span><span class="p">,</span> <span class="mh">0x764D</span><span class="p">,</span> <span class="mh">0xB761</span><span class="p">,</span> <span class="mh">0x7DCE</span><span class="p">,</span> <span class="mh">0x527B</span><span class="p">,</span> <span class="mh">0xDD3E</span><span class="p">,</span> <span class="mh">0x5E71</span><span class="p">,</span> <span class="mh">0x1397</span><span class="p">,</span>
	<span class="mh">0xA6F5</span><span class="p">,</span> <span class="mh">0xB968</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xC12C</span><span class="p">,</span> <span class="mh">0x4060</span><span class="p">,</span> <span class="mh">0xE31F</span><span class="p">,</span> <span class="mh">0x79C8</span><span class="p">,</span> <span class="mh">0xB6ED</span><span class="p">,</span>
	<span class="mh">0xD4BE</span><span class="p">,</span> <span class="mh">0x8D46</span><span class="p">,</span> <span class="mh">0x67D9</span><span class="p">,</span> <span class="mh">0x724B</span><span class="p">,</span> <span class="mh">0x94DE</span><span class="p">,</span> <span class="mh">0x98D4</span><span class="p">,</span> <span class="mh">0xB0E8</span><span class="p">,</span> <span class="mh">0x854A</span><span class="p">,</span>
	<span class="mh">0xBB6B</span><span class="p">,</span> <span class="mh">0xC52A</span><span class="p">,</span> <span class="mh">0x4FE5</span><span class="p">,</span> <span class="mh">0xED16</span><span class="p">,</span> <span class="mh">0x86C5</span><span class="p">,</span> <span class="mh">0x9AD7</span><span class="p">,</span> <span class="mh">0x6655</span><span class="p">,</span> <span class="mh">0x1194</span><span class="p">,</span>
	<span class="mh">0x8ACF</span><span class="p">,</span> <span class="mh">0xE910</span><span class="p">,</span> <span class="mh">0x0406</span><span class="p">,</span> <span class="mh">0xFE81</span><span class="p">,</span> <span class="mh">0xA0F0</span><span class="p">,</span> <span class="mh">0x7844</span><span class="p">,</span> <span class="mh">0x25BA</span><span class="p">,</span> <span class="mh">0x4BE3</span><span class="p">,</span>
	<span class="mh">0xA2F3</span><span class="p">,</span> <span class="mh">0x5DFE</span><span class="p">,</span> <span class="mh">0x80C0</span><span class="p">,</span> <span class="mh">0x058A</span><span class="p">,</span> <span class="mh">0x3FAD</span><span class="p">,</span> <span class="mh">0x21BC</span><span class="p">,</span> <span class="mh">0x7048</span><span class="p">,</span> <span class="mh">0xF104</span><span class="p">,</span>
	<span class="mh">0x63DF</span><span class="p">,</span> <span class="mh">0x77C1</span><span class="p">,</span> <span class="mh">0xAF75</span><span class="p">,</span> <span class="mh">0x4263</span><span class="p">,</span> <span class="mh">0x2030</span><span class="p">,</span> <span class="mh">0xE51A</span><span class="p">,</span> <span class="mh">0xFD0E</span><span class="p">,</span> <span class="mh">0xBF6D</span><span class="p">,</span>
	<span class="mh">0x814C</span><span class="p">,</span> <span class="mh">0x1814</span><span class="p">,</span> <span class="mh">0x2635</span><span class="p">,</span> <span class="mh">0xC32F</span><span class="p">,</span> <span class="mh">0xBEE1</span><span class="p">,</span> <span class="mh">0x35A2</span><span class="p">,</span> <span class="mh">0x88CC</span><span class="p">,</span> <span class="mh">0x2E39</span><span class="p">,</span>
	<span class="mh">0x9357</span><span class="p">,</span> <span class="mh">0x55F2</span><span class="p">,</span> <span class="mh">0xFC82</span><span class="p">,</span> <span class="mh">0x7A47</span><span class="p">,</span> <span class="mh">0xC8AC</span><span class="p">,</span> <span class="mh">0xBAE7</span><span class="p">,</span> <span class="mh">0x322B</span><span class="p">,</span> <span class="mh">0xE695</span><span class="p">,</span>
	<span class="mh">0xC0A0</span><span class="p">,</span> <span class="mh">0x1998</span><span class="p">,</span> <span class="mh">0x9ED1</span><span class="p">,</span> <span class="mh">0xA37F</span><span class="p">,</span> <span class="mh">0x4466</span><span class="p">,</span> <span class="mh">0x547E</span><span class="p">,</span> <span class="mh">0x3BAB</span><span class="p">,</span> <span class="mh">0x0B83</span><span class="p">,</span>
	<span class="mh">0x8CCA</span><span class="p">,</span> <span class="mh">0xC729</span><span class="p">,</span> <span class="mh">0x6BD3</span><span class="p">,</span> <span class="mh">0x283C</span><span class="p">,</span> <span class="mh">0xA779</span><span class="p">,</span> <span class="mh">0xBCE2</span><span class="p">,</span> <span class="mh">0x161D</span><span class="p">,</span> <span class="mh">0xAD76</span><span class="p">,</span>
	<span class="mh">0xDB3B</span><span class="p">,</span> <span class="mh">0x6456</span><span class="p">,</span> <span class="mh">0x744E</span><span class="p">,</span> <span class="mh">0x141E</span><span class="p">,</span> <span class="mh">0x92DB</span><span class="p">,</span> <span class="mh">0x0C0A</span><span class="p">,</span> <span class="mh">0x486C</span><span class="p">,</span> <span class="mh">0xB8E4</span><span class="p">,</span>
	<span class="mh">0x9F5D</span><span class="p">,</span> <span class="mh">0xBD6E</span><span class="p">,</span> <span class="mh">0x43EF</span><span class="p">,</span> <span class="mh">0xC4A6</span><span class="p">,</span> <span class="mh">0x39A8</span><span class="p">,</span> <span class="mh">0x31A4</span><span class="p">,</span> <span class="mh">0xD337</span><span class="p">,</span> <span class="mh">0xF28B</span><span class="p">,</span>
	<span class="mh">0xD532</span><span class="p">,</span> <span class="mh">0x8B43</span><span class="p">,</span> <span class="mh">0x6E59</span><span class="p">,</span> <span class="mh">0xDAB7</span><span class="p">,</span> <span class="mh">0x018C</span><span class="p">,</span> <span class="mh">0xB164</span><span class="p">,</span> <span class="mh">0x9CD2</span><span class="p">,</span> <span class="mh">0x49E0</span><span class="p">,</span>
	<span class="mh">0xD8B4</span><span class="p">,</span> <span class="mh">0xACFA</span><span class="p">,</span> <span class="mh">0xF307</span><span class="p">,</span> <span class="mh">0xCF25</span><span class="p">,</span> <span class="mh">0xCAAF</span><span class="p">,</span> <span class="mh">0xF48E</span><span class="p">,</span> <span class="mh">0x47E9</span><span class="p">,</span> <span class="mh">0x1018</span><span class="p">,</span>
	<span class="mh">0x6FD5</span><span class="p">,</span> <span class="mh">0xF088</span><span class="p">,</span> <span class="mh">0x4A6F</span><span class="p">,</span> <span class="mh">0x5C72</span><span class="p">,</span> <span class="mh">0x3824</span><span class="p">,</span> <span class="mh">0x57F1</span><span class="p">,</span> <span class="mh">0x73C7</span><span class="p">,</span> <span class="mh">0x9751</span><span class="p">,</span>
	<span class="mh">0xCB23</span><span class="p">,</span> <span class="mh">0xA17C</span><span class="p">,</span> <span class="mh">0xE89C</span><span class="p">,</span> <span class="mh">0x3E21</span><span class="p">,</span> <span class="mh">0x96DD</span><span class="p">,</span> <span class="mh">0x61DC</span><span class="p">,</span> <span class="mh">0x0D86</span><span class="p">,</span> <span class="mh">0x0F85</span><span class="p">,</span>
	<span class="mh">0xE090</span><span class="p">,</span> <span class="mh">0x7C42</span><span class="p">,</span> <span class="mh">0x71C4</span><span class="p">,</span> <span class="mh">0xCCAA</span><span class="p">,</span> <span class="mh">0x90D8</span><span class="p">,</span> <span class="mh">0x0605</span><span class="p">,</span> <span class="mh">0xF701</span><span class="p">,</span> <span class="mh">0x1C12</span><span class="p">,</span>
	<span class="mh">0xC2A3</span><span class="p">,</span> <span class="mh">0x6A5F</span><span class="p">,</span> <span class="mh">0xAEF9</span><span class="p">,</span> <span class="mh">0x69D0</span><span class="p">,</span> <span class="mh">0x1791</span><span class="p">,</span> <span class="mh">0x9958</span><span class="p">,</span> <span class="mh">0x3A27</span><span class="p">,</span> <span class="mh">0x27B9</span><span class="p">,</span>
	<span class="mh">0xD938</span><span class="p">,</span> <span class="mh">0xEB13</span><span class="p">,</span> <span class="mh">0x2BB3</span><span class="p">,</span> <span class="mh">0x2233</span><span class="p">,</span> <span class="mh">0xD2BB</span><span class="p">,</span> <span class="mh">0xA970</span><span class="p">,</span> <span class="mh">0x0789</span><span class="p">,</span> <span class="mh">0x33A7</span><span class="p">,</span>
	<span class="mh">0x2DB6</span><span class="p">,</span> <span class="mh">0x3C22</span><span class="p">,</span> <span class="mh">0x1592</span><span class="p">,</span> <span class="mh">0xC920</span><span class="p">,</span> <span class="mh">0x8749</span><span class="p">,</span> <span class="mh">0xAAFF</span><span class="p">,</span> <span class="mh">0x5078</span><span class="p">,</span> <span class="mh">0xA57A</span><span class="p">,</span>
	<span class="mh">0x038F</span><span class="p">,</span> <span class="mh">0x59F8</span><span class="p">,</span> <span class="mh">0x0980</span><span class="p">,</span> <span class="mh">0x1A17</span><span class="p">,</span> <span class="mh">0x65DA</span><span class="p">,</span> <span class="mh">0xD731</span><span class="p">,</span> <span class="mh">0x84C6</span><span class="p">,</span> <span class="mh">0xD0B8</span><span class="p">,</span>
	<span class="mh">0x82C3</span><span class="p">,</span> <span class="mh">0x29B0</span><span class="p">,</span> <span class="mh">0x5A77</span><span class="p">,</span> <span class="mh">0x1E11</span><span class="p">,</span> <span class="mh">0x7BCB</span><span class="p">,</span> <span class="mh">0xA8FC</span><span class="p">,</span> <span class="mh">0x6DD6</span><span class="p">,</span> <span class="mh">0x2C3A</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">tkipS</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tkip_sbox</span><span class="p">[</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]</span> <span class="o">^</span> <span class="n">swab16</span><span class="p">(</span><span class="n">tkip_sbox</span><span class="p">[</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">write_tkip_iv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iv16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">iv16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">iv16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">iv16</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * P1K := Phase1(TA, TK, TSC)</span>
<span class="cm"> * TA = transmitter address (48 bits)</span>
<span class="cm"> * TK = dot11DefaultKeyValue or dot11KeyMappingValue (128 bits)</span>
<span class="cm"> * TSC = TKIP sequence counter (48 bits, only 32 msb bits used)</span>
<span class="cm"> * P1K: 80 bits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tkip_mixing_phase1</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tkip_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tsc_IV32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p1k</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">p1k</span><span class="p">;</span>

	<span class="n">p1k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsc_IV32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsc_IV32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">ta</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">ta</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">ta</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHASE1_LOOP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">))</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TKIP_STATE_PHASE1_DONE</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">p1k_iv32</span> <span class="o">=</span> <span class="n">tsc_IV32</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tkip_mixing_phase2</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tkip_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">tsc_IV16</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rc4key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ppk</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">p1k</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">p1k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ppk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1k</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1k</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1k</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1k</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">tsc_IV16</span><span class="p">;</span>

	<span class="n">ppk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tkipS</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ror16</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ror16</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span> <span class="o">+</span> <span class="mi">14</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ror16</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ror16</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ror16</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ror16</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rc4key</span> <span class="o">=</span> <span class="n">write_tkip_iv</span><span class="p">(</span><span class="n">rc4key</span><span class="p">,</span> <span class="n">tsc_IV16</span><span class="p">);</span>
	<span class="o">*</span><span class="n">rc4key</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">ppk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tk</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">ppk</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rc4key</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Add TKIP IV and Ext. IV at @pos. @iv0, @iv1, and @iv2 are the first octets</span>
<span class="cm"> * of the IV. Returns pointer to the octet following IVs (i.e., beginning of</span>
<span class="cm"> * the packet payload). */</span>
<span class="n">u8</span> <span class="o">*</span><span class="nf">ieee80211_tkip_add_iv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">txlock</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">write_tkip_iv</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">iv16</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">keyidx</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="cm">/* Ext IV */</span><span class="p">;</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">iv32</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_compute_tkip_p1k</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iv32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tkip_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_ENCR_KEY</span><span class="p">];</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">txlock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the P1K when the IV32 is different from the value it</span>
<span class="cm">	 * had when we last computed it (or when not initialised yet).</span>
<span class="cm">	 * This might flip-flop back and forth if packets are processed</span>
<span class="cm">	 * out-of-order due to the different ACs, but then we have to</span>
<span class="cm">	 * just compute the P1K more often.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">p1k_iv32</span> <span class="o">!=</span> <span class="n">iv32</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TKIP_STATE_NOT_INIT</span><span class="p">)</span>
		<span class="n">tkip_mixing_phase1</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_get_tkip_p1k_iv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">iv32</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">p1k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">keyconf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_key</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tkip_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ieee80211_compute_tkip_p1k</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p1k</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">p1k</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">p1k</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_get_tkip_p1k_iv</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_get_tkip_rx_p1k</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iv32</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">p1k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_ENCR_KEY</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tkip_ctx</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="n">tkip_mixing_phase1</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p1k</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">p1k</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">p1k</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_get_tkip_rx_p1k</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_get_tkip_p2k</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p2k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">keyconf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_key</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_ENCR_KEY</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tkip_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">iv32</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">u16</span> <span class="n">iv16</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ieee80211_compute_tkip_p1k</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
	<span class="n">tkip_mixing_phase2</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">iv16</span><span class="p">,</span> <span class="n">p2k</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_get_tkip_p2k</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Encrypt packet payload with TKIP using @key. @pos is a pointer to the</span>
<span class="cm"> * beginning of the buffer containing payload. This payload must include</span>
<span class="cm"> * the IV/Ext.IV and space for (taildroom) four octets for ICV.</span>
<span class="cm"> * @payload_len is the length of payload (_not_ including IV/ICV length).</span>
<span class="cm"> * @ta is the transmitter addresses.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ieee80211_tkip_encrypt_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_cipher</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">payload_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc4key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">ieee80211_get_tkip_p2k</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ieee80211_wep_encrypt_data</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
					  <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Decrypt packet payload with TKIP using @key. @pos is a pointer to the</span>
<span class="cm"> * beginning of the buffer containing IEEE 802.11 header payload, i.e.,</span>
<span class="cm"> * including IV, Ext. IV, real data, Michael MIC, ICV. @payload_len is the</span>
<span class="cm"> * length of payload, including IV, Ext. IV, MIC, ICV.  */</span>
<span class="kt">int</span> <span class="nf">ieee80211_tkip_decrypt_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_cipher</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">ra</span><span class="p">,</span> <span class="kt">int</span> <span class="n">only_iv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">out_iv32</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">out_iv16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">iv32</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iv16</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc4key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">keyid</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_ENCR_KEY</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">payload_len</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">iv16</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">keyid</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">iv32</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MAC80211_TKIP_DEBUG</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TKIP decrypt: data(len=%zd)&quot;</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">payload_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TKIP decrypt: iv16=%04x iv32=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iv16</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">keyid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">TKIP_DECRYPT_NO_EXT_IV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">keyid</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">keyidx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TKIP_DECRYPT_INVALID_KEYIDX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">TKIP_STATE_NOT_INIT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">iv32</span> <span class="o">&lt;</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">iv32</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">iv32</span> <span class="o">==</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">iv32</span> <span class="o">&amp;&amp;</span>
	      <span class="n">iv16</span> <span class="o">&lt;=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">iv16</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_TKIP_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TKIP replay detected for RX frame from &quot;</span>
		       <span class="s">&quot;%pM (RX IV (%04x,%02x) &lt;= prev. IV (%04x,%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ta</span><span class="p">,</span>
		       <span class="n">iv32</span><span class="p">,</span> <span class="n">iv16</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">iv32</span><span class="p">,</span>
		       <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">iv16</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">TKIP_DECRYPT_REPLAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">only_iv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">TKIP_DECRYPT_OK</span><span class="p">;</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">TKIP_STATE_PHASE1_HW_UPLOADED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">TKIP_STATE_NOT_INIT</span> <span class="o">||</span>
	    <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">iv32</span> <span class="o">!=</span> <span class="n">iv32</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* IV16 wrapped around - perform TKIP phase 1 */</span>
		<span class="n">tkip_mixing_phase1</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">ta</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MAC80211_TKIP_DEBUG</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">key_offset</span> <span class="o">=</span> <span class="n">NL80211_TKIP_DATA_OFFSET_ENCR_KEY</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TKIP decrypt: Phase1 TA=%pM&quot;</span>
			       <span class="s">&quot; TK=&quot;</span><span class="p">,</span> <span class="n">ta</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span>
				       <span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="n">key_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TKIP decrypt: P1K=&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%04x &quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">p1k</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_tkip_key</span> <span class="o">&amp;&amp;</span>
	    <span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KEY_FLAG_UPLOADED_TO_HARDWARE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">TKIP_STATE_PHASE1_HW_UPLOADED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">)</span>
			<span class="n">sdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">drv_update_tkip_key</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span>
				<span class="n">iv32</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">p1k</span><span class="p">);</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">TKIP_STATE_PHASE1_HW_UPLOADED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tkip_mixing_phase2</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">iv16</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MAC80211_TKIP_DEBUG</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TKIP decrypt: Phase2 rc4key=&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ieee80211_wep_decrypt_data</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">payload_len</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TKIP_DECRYPT_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Record previously received IV, will be copied into the</span>
<span class="cm">		 * key information after MIC verification. It is possible</span>
<span class="cm">		 * that we don&#39;t catch replays of fragments but that&#39;s ok</span>
<span class="cm">		 * because the Michael MIC verication will then fail.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">out_iv32</span> <span class="o">=</span> <span class="n">iv32</span><span class="p">;</span>
		<span class="o">*</span><span class="n">out_iv16</span> <span class="o">=</span> <span class="n">iv16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
