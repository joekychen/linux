<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › debugfs_netdev.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>debugfs_netdev.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006	Jiri Benc &lt;jbenc@suse.cz&gt;</span>
<span class="cm"> * Copyright 2007	Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &quot;ieee80211_i.h&quot;</span>
<span class="cp">#include &quot;rate.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;debugfs_netdev.h&quot;</span>
<span class="cp">#include &quot;driver-ops.h&quot;</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_read</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">,</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">70</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">==</span> <span class="n">NETREG_REGISTERED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span><span class="p">)(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_base_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">userbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_write</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">,</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">userbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">==</span> <span class="n">NETREG_REGISTERED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IEEE80211_IF_FMT(name, field, format_string)			\</span>
<span class="cp">static ssize_t ieee80211_if_fmt_##name(					\</span>
<span class="cp">	const struct ieee80211_sub_if_data *sdata, char *buf,		\</span>
<span class="cp">	int buflen)							\</span>
<span class="cp">{									\</span>
<span class="cp">	return scnprintf(buf, buflen, format_string, sdata-&gt;field);	\</span>
<span class="cp">}</span>
<span class="cp">#define IEEE80211_IF_FMT_DEC(name, field)				\</span>
<span class="cp">		IEEE80211_IF_FMT(name, field, &quot;%d\n&quot;)</span>
<span class="cp">#define IEEE80211_IF_FMT_HEX(name, field)				\</span>
<span class="cp">		IEEE80211_IF_FMT(name, field, &quot;%#x\n&quot;)</span>
<span class="cp">#define IEEE80211_IF_FMT_LHEX(name, field)				\</span>
<span class="cp">		IEEE80211_IF_FMT(name, field, &quot;%#lx\n&quot;)</span>
<span class="cp">#define IEEE80211_IF_FMT_SIZE(name, field)				\</span>
<span class="cp">		IEEE80211_IF_FMT(name, field, &quot;%zd\n&quot;)</span>

<span class="cp">#define IEEE80211_IF_FMT_HEXARRAY(name, field)				\</span>
<span class="cp">static ssize_t ieee80211_if_fmt_##name(					\</span>
<span class="cp">	const struct ieee80211_sub_if_data *sdata,			\</span>
<span class="cp">	char *buf, int buflen)						\</span>
<span class="cp">{									\</span>
<span class="cp">	char *p = buf;							\</span>
<span class="cp">	int i;								\</span>
<span class="cp">	for (i = 0; i &lt; sizeof(sdata-&gt;field); i++) {			\</span>
<span class="cp">		p += scnprintf(p, buflen + buf - p, &quot;%.2x &quot;,		\</span>
<span class="cp">				 sdata-&gt;field[i]);			\</span>
<span class="cp">	}								\</span>
<span class="cp">	p += scnprintf(p, buflen + buf - p, &quot;\n&quot;);			\</span>
<span class="cp">	return p - buf;							\</span>
<span class="cp">}</span>

<span class="cp">#define IEEE80211_IF_FMT_ATOMIC(name, field)				\</span>
<span class="cp">static ssize_t ieee80211_if_fmt_##name(					\</span>
<span class="cp">	const struct ieee80211_sub_if_data *sdata,			\</span>
<span class="cp">	char *buf, int buflen)						\</span>
<span class="cp">{									\</span>
<span class="cp">	return scnprintf(buf, buflen, &quot;%d\n&quot;, atomic_read(&amp;sdata-&gt;field));\</span>
<span class="cp">}</span>

<span class="cp">#define IEEE80211_IF_FMT_MAC(name, field)				\</span>
<span class="cp">static ssize_t ieee80211_if_fmt_##name(					\</span>
<span class="cp">	const struct ieee80211_sub_if_data *sdata, char *buf,		\</span>
<span class="cp">	int buflen)							\</span>
<span class="cp">{									\</span>
<span class="cp">	return scnprintf(buf, buflen, &quot;%pM\n&quot;, sdata-&gt;field);		\</span>
<span class="cp">}</span>

<span class="cp">#define IEEE80211_IF_FMT_DEC_DIV_16(name, field)			\</span>
<span class="cp">static ssize_t ieee80211_if_fmt_##name(					\</span>
<span class="cp">	const struct ieee80211_sub_if_data *sdata,			\</span>
<span class="cp">	char *buf, int buflen)						\</span>
<span class="cp">{									\</span>
<span class="cp">	return scnprintf(buf, buflen, &quot;%d\n&quot;, sdata-&gt;field / 16);	\</span>
<span class="cp">}</span>

<span class="cp">#define __IEEE80211_IF_FILE(name, _write)				\</span>
<span class="cp">static ssize_t ieee80211_if_read_##name(struct file *file,		\</span>
<span class="cp">					char __user *userbuf,		\</span>
<span class="cp">					size_t count, loff_t *ppos)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return ieee80211_if_read(file-&gt;private_data,			\</span>
<span class="cp">				 userbuf, count, ppos,			\</span>
<span class="cp">				 ieee80211_if_fmt_##name);		\</span>
<span class="cp">}									\</span>
<span class="cp">static const struct file_operations name##_ops = {			\</span>
<span class="cp">	.read = ieee80211_if_read_##name,				\</span>
<span class="cp">	.write = (_write),						\</span>
<span class="cp">	.open = simple_open,						\</span>
<span class="cp">	.llseek = generic_file_llseek,					\</span>
<span class="cp">}</span>

<span class="cp">#define __IEEE80211_IF_FILE_W(name)					\</span>
<span class="cp">static ssize_t ieee80211_if_write_##name(struct file *file,		\</span>
<span class="cp">					 const char __user *userbuf,	\</span>
<span class="cp">					 size_t count, loff_t *ppos)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return ieee80211_if_write(file-&gt;private_data, userbuf, count,	\</span>
<span class="cp">				  ppos, ieee80211_if_parse_##name);	\</span>
<span class="cp">}									\</span>
<span class="cp">__IEEE80211_IF_FILE(name, ieee80211_if_write_##name)</span>


<span class="cp">#define IEEE80211_IF_FILE(name, field, format)				\</span>
<span class="cp">		IEEE80211_IF_FMT_##format(name, field)			\</span>
<span class="cp">		__IEEE80211_IF_FILE(name, NULL)</span>

<span class="cm">/* common attributes */</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">drop_unencrypted</span><span class="p">,</span> <span class="n">drop_unencrypted</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">rc_rateidx_mask_2ghz</span><span class="p">,</span> <span class="n">rc_rateidx_mask</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">],</span>
		  <span class="n">HEX</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">rc_rateidx_mask_5ghz</span><span class="p">,</span> <span class="n">rc_rateidx_mask</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">],</span>
		  <span class="n">HEX</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">rc_rateidx_mcs_mask_2ghz</span><span class="p">,</span>
		  <span class="n">rc_rateidx_mcs_mask</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">],</span> <span class="n">HEXARRAY</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">rc_rateidx_mcs_mask_5ghz</span><span class="p">,</span>
		  <span class="n">rc_rateidx_mcs_mask</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">],</span> <span class="n">HEXARRAY</span><span class="p">);</span>

<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">LHEX</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">channel_type</span><span class="p">,</span> <span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>

<span class="cm">/* STA attributes */</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">MAC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">aid</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">last_beacon</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">last_beacon_signal</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">ave_beacon</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ave_beacon_signal</span><span class="p">,</span> <span class="n">DEC_DIV_16</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_smps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="n">smps_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SUPPORTS_STATIC_SMPS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">smps_mode</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_STATIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* auto should be dynamic if in PS mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SUPPORTS_DYNAMIC_SMPS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">smps_mode</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span> <span class="o">||</span>
	     <span class="n">smps_mode</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* supported only on managed interfaces for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__ieee80211_request_smps</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">smps_mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">smps_modes</span><span class="p">[</span><span class="n">IEEE80211_SMPS_NUM_MODES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IEEE80211_SMPS_AUTOMATIC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IEEE80211_SMPS_OFF</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IEEE80211_SMPS_STATIC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;static&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IEEE80211_SMPS_DYNAMIC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;dynamic&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_fmt_smps</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;request: %s</span><span class="se">\n</span><span class="s">used: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smps_modes</span><span class="p">[</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">req_smps</span><span class="p">],</span>
			<span class="n">smps_modes</span><span class="p">[</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ap_smps</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_parse_smps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="n">IEEE80211_SMPS_NUM_MODES</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">smps_modes</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span> <span class="n">buflen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_set_smps</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__IEEE80211_IF_FILE_W</span><span class="p">(</span><span class="n">smps</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_fmt_tkip_mic_test</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwaddr_aton</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">txt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

		<span class="n">a</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="o">*</span><span class="n">txt</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="o">*</span><span class="n">txt</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">addr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">txt</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_parse_tkip_mic_test</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assume colon-delimited MAC address with possible white space</span>
<span class="cm">	 * following.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ETH_ALEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwaddr_aton</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_DATA</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">);</span>
		<span class="cm">/* DA BSSID SA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>
		<span class="cm">/* BSSID SA DA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add some length to the test frame to make it look bit more valid.</span>
<span class="cm">	 * The exact contents does not matter since the recipient is required</span>
<span class="cm">	 * to drop this because of the Michael MIC failure.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>

	<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_TKIP_MIC_FAILURE</span><span class="p">;</span>

	<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__IEEE80211_IF_FILE_W</span><span class="p">(</span><span class="n">tkip_mic_test</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_fmt_uapsd_queues</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">uapsd_queues</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_parse_uapsd_queues</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtou8</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IEEE80211_WMM_IE_STA_QOSINFO_AC_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">uapsd_queues</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__IEEE80211_IF_FILE_W</span><span class="p">(</span><span class="n">uapsd_queues</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_fmt_uapsd_max_sp_len</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">uapsd_max_sp_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_parse_uapsd_max_sp_len</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IEEE80211_WMM_IE_STA_QOSINFO_SP_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">uapsd_max_sp_len</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__IEEE80211_IF_FILE_W</span><span class="p">(</span><span class="n">uapsd_max_sp_len</span><span class="p">);</span>

<span class="cm">/* AP attributes */</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">num_mcast_sta</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">num_mcast_sta</span><span class="p">,</span> <span class="n">ATOMIC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">num_sta_ps</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">num_sta_ps</span><span class="p">,</span> <span class="n">ATOMIC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dtim_count</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">dtim_count</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_fmt_num_buffered_multicast</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ps_bc_buf</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">__IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">num_buffered_multicast</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* IBSS attributes */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_fmt_tsf</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>

	<span class="n">tsf</span> <span class="o">=</span> <span class="n">drv_get_tsf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="p">)</span><span class="n">sdata</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tsf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ieee80211_if_parse_tsf</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tsf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tsf_is_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset_tsf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drv_reset_tsf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
			<span class="n">wiphy_info</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;debugfs reset TSF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span>
				<span class="n">tsf_is_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
				<span class="n">tsf_is_delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tsf_is_delta</span><span class="p">)</span>
			<span class="n">tsf</span> <span class="o">=</span> <span class="n">drv_get_tsf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)</span> <span class="o">+</span> <span class="n">tsf_is_delta</span> <span class="o">*</span> <span class="n">tsf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tsf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drv_set_tsf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
			<span class="n">wiphy_info</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span>
				   <span class="s">&quot;debugfs set TSF to %#018llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__IEEE80211_IF_FILE_W</span><span class="p">(</span><span class="n">tsf</span><span class="p">);</span>


<span class="cm">/* WDS attributes */</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">wds</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">MAC</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
<span class="cm">/* Mesh stats attributes */</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">fwded_mcast</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_mcast</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">fwded_unicast</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_unicast</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">fwded_frames</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_frames</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dropped_frames_ttl</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dropped_frames_congestion</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_congestion</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dropped_frames_no_route</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_no_route</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">estab_plinks</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">estab_plinks</span><span class="p">,</span> <span class="n">ATOMIC</span><span class="p">);</span>

<span class="cm">/* Mesh parameters */</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshMaxRetries</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshMaxRetries</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshRetryTimeout</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshRetryTimeout</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshConfirmTimeout</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshConfirmTimeout</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHoldingTimeout</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHoldingTimeout</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshTTL</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshTTL</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">element_ttl</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">element_ttl</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">auto_open_plinks</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">auto_open_plinks</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshMaxPeerLinks</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshMaxPeerLinks</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHWMPactivePathTimeout</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPactivePathTimeout</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHWMPpreqMinInterval</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPpreqMinInterval</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHWMPperrMinInterval</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPperrMinInterval</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHWMPnetDiameterTraversalTime</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPnetDiameterTraversalTime</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHWMPmaxPREQretries</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPmaxPREQretries</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">path_refresh_time</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">path_refresh_time</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">min_discovery_timeout</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">min_discovery_timeout</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHWMPRootMode</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPRootMode</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshGateAnnouncementProtocol</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshGateAnnouncementProtocol</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshHWMPRannInterval</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPRannInterval</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">dot11MeshForwarding</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshForwarding</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">rssi_threshold</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">rssi_threshold</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="n">IEEE80211_IF_FILE</span><span class="p">(</span><span class="n">ht_opmode</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">ht_opmode</span><span class="p">,</span> <span class="n">DEC</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define DEBUGFS_ADD_MODE(name, mode) \</span>
<span class="cp">	debugfs_create_file(#name, mode, sdata-&gt;debugfs.dir, \</span>
<span class="cp">			    sdata, &amp;name##_ops);</span>

<span class="cp">#define DEBUGFS_ADD(name) DEBUGFS_ADD_MODE(name, 0400)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_common_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">drop_unencrypted</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">rc_rateidx_mask_2ghz</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">rc_rateidx_mask_5ghz</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">rc_rateidx_mcs_mask_2ghz</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">rc_rateidx_mcs_mask_5ghz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_sta_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">bssid</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">last_beacon</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">ave_beacon</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD_MODE</span><span class="p">(</span><span class="n">smps</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD_MODE</span><span class="p">(</span><span class="n">tkip_mic_test</span><span class="p">,</span> <span class="mo">0200</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD_MODE</span><span class="p">(</span><span class="n">uapsd_queues</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD_MODE</span><span class="p">(</span><span class="n">uapsd_max_sp_len</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_ap_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">num_mcast_sta</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">num_sta_ps</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">dtim_count</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">num_buffered_multicast</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD_MODE</span><span class="p">(</span><span class="n">tkip_mic_test</span><span class="p">,</span> <span class="mo">0200</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_ibss_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGFS_ADD_MODE</span><span class="p">(</span><span class="n">tsf</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_wds_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_mesh_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGFS_ADD_MODE</span><span class="p">(</span><span class="n">tsf</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_mesh_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;mesh_stats&quot;</span><span class="p">,</span>
						<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>
<span class="cp">#define MESHSTATS_ADD(name)\</span>
<span class="cp">	debugfs_create_file(#name, 0400, dir, sdata, &amp;name##_ops);</span>

	<span class="n">MESHSTATS_ADD</span><span class="p">(</span><span class="n">fwded_mcast</span><span class="p">);</span>
	<span class="n">MESHSTATS_ADD</span><span class="p">(</span><span class="n">fwded_unicast</span><span class="p">);</span>
	<span class="n">MESHSTATS_ADD</span><span class="p">(</span><span class="n">fwded_frames</span><span class="p">);</span>
	<span class="n">MESHSTATS_ADD</span><span class="p">(</span><span class="n">dropped_frames_ttl</span><span class="p">);</span>
	<span class="n">MESHSTATS_ADD</span><span class="p">(</span><span class="n">dropped_frames_no_route</span><span class="p">);</span>
	<span class="n">MESHSTATS_ADD</span><span class="p">(</span><span class="n">dropped_frames_congestion</span><span class="p">);</span>
	<span class="n">MESHSTATS_ADD</span><span class="p">(</span><span class="n">estab_plinks</span><span class="p">);</span>
<span class="cp">#undef MESHSTATS_ADD</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_mesh_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;mesh_config&quot;</span><span class="p">,</span>
						<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>

<span class="cp">#define MESHPARAMS_ADD(name) \</span>
<span class="cp">	debugfs_create_file(#name, 0600, dir, sdata, &amp;name##_ops);</span>

	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshMaxRetries</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshRetryTimeout</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshConfirmTimeout</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHoldingTimeout</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshTTL</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">element_ttl</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">auto_open_plinks</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshMaxPeerLinks</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHWMPactivePathTimeout</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHWMPpreqMinInterval</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHWMPperrMinInterval</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHWMPnetDiameterTraversalTime</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHWMPmaxPREQretries</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">path_refresh_time</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">min_discovery_timeout</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHWMPRootMode</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshHWMPRannInterval</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">dot11MeshGateAnnouncementProtocol</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">rssi_threshold</span><span class="p">);</span>
	<span class="n">MESHPARAMS_ADD</span><span class="p">(</span><span class="n">ht_opmode</span><span class="p">);</span>
<span class="cp">#undef MESHPARAMS_ADD</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">DEBUGFS_ADD</span><span class="p">(</span><span class="n">channel_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span>
		<span class="n">add_common_files</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
		<span class="n">add_mesh_files</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="n">add_mesh_stats</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="n">add_mesh_config</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">add_sta_files</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">add_ibss_files</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">add_ap_files</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
		<span class="n">add_wds_files</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_debugfs_add_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="o">+</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;netdev:%s&quot;</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">debugfsdir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">)</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">subdir_stations</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;stations&quot;</span><span class="p">,</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">add_files</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_debugfs_remove_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_debugfs_rename_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span> <span class="o">+</span> <span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;netdev:%s&quot;</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_rename</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mac80211: debugfs: failed to rename debugfs &quot;</span>
		       <span class="s">&quot;dir to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
