<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › mesh_hwmp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mesh_hwmp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008, 2009 open80211s Ltd.</span>
<span class="cm"> * Author:     Luis Carlos Cobo &lt;luisca@cozybit.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &quot;wme.h&quot;</span>
<span class="cp">#include &quot;mesh.h&quot;</span>

<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_MHWMP_DEBUG</span>
<span class="cp">#define mhwmp_dbg(fmt, args...) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;Mesh HWMP (%s): &quot; fmt &quot;\n&quot;, sdata-&gt;name, ##args)</span>
<span class="cp">#else</span>
<span class="cp">#define mhwmp_dbg(fmt, args...)   do { (void)(0); } while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#define TEST_FRAME_LEN	8192</span>
<span class="cp">#define MAX_METRIC	0xffffffff</span>
<span class="cp">#define ARITH_SHIFT	8</span>

<span class="cm">/* Number of frames buffered per destination for unresolved destinations */</span>
<span class="cp">#define MESH_FRAME_QUEUE_LEN	10</span>
<span class="cp">#define MAX_PREQ_QUEUE_LEN	64</span>

<span class="cm">/* Destination only */</span>
<span class="cp">#define MP_F_DO	0x1</span>
<span class="cm">/* Reply and forward */</span>
<span class="cp">#define MP_F_RF	0x2</span>
<span class="cm">/* Unknown Sequence Number */</span>
<span class="cp">#define MP_F_USN    0x01</span>
<span class="cm">/* Reason code Present */</span>
<span class="cp">#define MP_F_RCODE  0x02</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mesh_queue_preq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">u32_field_get</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">preq_elem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ae</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">preq_elem</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">u16_field_get</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">preq_elem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ae</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">preq_elem</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* HWMP IE processing macros */</span>
<span class="cp">#define AE_F			(1&lt;&lt;6)</span>
<span class="cp">#define AE_F_SET(x)		(*x &amp; AE_F)</span>
<span class="cp">#define PREQ_IE_FLAGS(x)	(*(x))</span>
<span class="cp">#define PREQ_IE_HOPCOUNT(x)	(*(x + 1))</span>
<span class="cp">#define PREQ_IE_TTL(x)		(*(x + 2))</span>
<span class="cp">#define PREQ_IE_PREQ_ID(x)	u32_field_get(x, 3, 0)</span>
<span class="cp">#define PREQ_IE_ORIG_ADDR(x)	(x + 7)</span>
<span class="cp">#define PREQ_IE_ORIG_SN(x)	u32_field_get(x, 13, 0)</span>
<span class="cp">#define PREQ_IE_LIFETIME(x)	u32_field_get(x, 17, AE_F_SET(x))</span>
<span class="cp">#define PREQ_IE_METRIC(x) 	u32_field_get(x, 21, AE_F_SET(x))</span>
<span class="cp">#define PREQ_IE_TARGET_F(x)	(*(AE_F_SET(x) ? x + 32 : x + 26))</span>
<span class="cp">#define PREQ_IE_TARGET_ADDR(x) 	(AE_F_SET(x) ? x + 33 : x + 27)</span>
<span class="cp">#define PREQ_IE_TARGET_SN(x) 	u32_field_get(x, 33, AE_F_SET(x))</span>


<span class="cp">#define PREP_IE_FLAGS(x)	PREQ_IE_FLAGS(x)</span>
<span class="cp">#define PREP_IE_HOPCOUNT(x)	PREQ_IE_HOPCOUNT(x)</span>
<span class="cp">#define PREP_IE_TTL(x)		PREQ_IE_TTL(x)</span>
<span class="cp">#define PREP_IE_ORIG_ADDR(x)	(AE_F_SET(x) ? x + 27 : x + 21)</span>
<span class="cp">#define PREP_IE_ORIG_SN(x)	u32_field_get(x, 27, AE_F_SET(x))</span>
<span class="cp">#define PREP_IE_LIFETIME(x)	u32_field_get(x, 13, AE_F_SET(x))</span>
<span class="cp">#define PREP_IE_METRIC(x)	u32_field_get(x, 17, AE_F_SET(x))</span>
<span class="cp">#define PREP_IE_TARGET_ADDR(x)	(x + 3)</span>
<span class="cp">#define PREP_IE_TARGET_SN(x)	u32_field_get(x, 9, 0)</span>

<span class="cp">#define PERR_IE_TTL(x)		(*(x))</span>
<span class="cp">#define PERR_IE_TARGET_FLAGS(x)	(*(x + 2))</span>
<span class="cp">#define PERR_IE_TARGET_ADDR(x)	(x + 3)</span>
<span class="cp">#define PERR_IE_TARGET_SN(x)	u32_field_get(x, 9, 0)</span>
<span class="cp">#define PERR_IE_TARGET_RCODE(x)	u16_field_get(x, 13, 0)</span>

<span class="cp">#define MSEC_TO_TU(x) (x*1000/1024)</span>
<span class="cp">#define SN_GT(x, y) ((s32)(y - x) &lt; 0)</span>
<span class="cp">#define SN_LT(x, y) ((s32)(x - y) &lt; 0)</span>

<span class="cp">#define net_traversal_jiffies(s) \</span>
<span class="cp">	msecs_to_jiffies(s-&gt;u.mesh.mshcfg.dot11MeshHWMPnetDiameterTraversalTime)</span>
<span class="cp">#define default_lifetime(s) \</span>
<span class="cp">	MSEC_TO_TU(s-&gt;u.mesh.mshcfg.dot11MeshHWMPactivePathTimeout)</span>
<span class="cp">#define min_preq_int_jiff(s) \</span>
<span class="cp">	(msecs_to_jiffies(s-&gt;u.mesh.mshcfg.dot11MeshHWMPpreqMinInterval))</span>
<span class="cp">#define max_preq_retries(s) (s-&gt;u.mesh.mshcfg.dot11MeshHWMPmaxPREQretries)</span>
<span class="cp">#define disc_timeout_jiff(s) \</span>
<span class="cp">	msecs_to_jiffies(sdata-&gt;u.mesh.mshcfg.min_discovery_timeout)</span>

<span class="k">enum</span> <span class="n">mpath_frame_type</span> <span class="p">{</span>
	<span class="n">MPATH_PREQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MPATH_PREP</span><span class="p">,</span>
	<span class="n">MPATH_PERR</span><span class="p">,</span>
	<span class="n">MPATH_RANN</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">broadcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mesh_path_sel_frame_tx</span><span class="p">(</span><span class="k">enum</span> <span class="n">mpath_frame_type</span> <span class="n">action</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">orig_sn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">target_flags</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		<span class="n">__le32</span> <span class="n">target_sn</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hop_count</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ttl</span><span class="p">,</span>
		<span class="n">__le32</span> <span class="n">lifetime</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">metric</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">preq_id</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">)</span> <span class="o">+</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span>
			    <span class="n">hdr_len</span> <span class="o">+</span>
			    <span class="mi">2</span> <span class="o">+</span> <span class="mi">37</span><span class="p">);</span> <span class="cm">/* max HWMP IE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					  <span class="n">IEEE80211_STYPE_ACTION</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="cm">/* BSSID == SA */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_MESH_ACTION</span><span class="p">;</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">.</span><span class="n">action_code</span> <span class="o">=</span>
					<span class="n">WLAN_MESH_ACTION_HWMP_PATH_SELECTION</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPATH_PREQ</span>:
		<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;sending PREQ to %pM&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="mi">37</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_PREQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPATH_PREP</span>:
		<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;sending PREP to %pM&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_PREP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPATH_RANN</span>:
		<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;sending RANN from %pM&quot;</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rann_ie</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_RANN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">hop_count</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ttl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">MPATH_PREP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_sn</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">MPATH_PREQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">preq_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_sn</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lifetime</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* interval for RANN */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">metric</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">MPATH_PREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* destination count */</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">target_flags</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_sn</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">MPATH_PREP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_sn</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*  Headroom is not adjusted.  Caller should ensure that skb has sufficient</span>
<span class="cm"> *  headroom in case the frame is encrypted. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_frame_for_deferred_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">skb_set_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Send all internal mgmt frames on VO. Accordingly set TID to 7. */</span>
	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IEEE80211_AC_VO</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
	<span class="n">ieee80211_set_qos_hdr</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mesh_send_path error - Sends a PERR mesh management frame</span>
<span class="cm"> *</span>
<span class="cm"> * @target: broken destination</span>
<span class="cm"> * @target_sn: SN of the broken destination</span>
<span class="cm"> * @target_rcode: reason code for this PERR</span>
<span class="cm"> * @ra: node this frame is addressed to</span>
<span class="cm"> *</span>
<span class="cm"> * Note: This function may be called with driver locks taken that the driver</span>
<span class="cm"> * also acquires in the TX path.  To avoid a deadlock we don&#39;t transmit the</span>
<span class="cm"> * frame directly but add it to the pending queue instead.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mesh_path_error_tx</span><span class="p">(</span><span class="n">u8</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">target_sn</span><span class="p">,</span>
		       <span class="n">__le16</span> <span class="n">target_rcode</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ra</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">)</span> <span class="o">+</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">next_perr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span>
			    <span class="n">hdr_len</span> <span class="o">+</span>
			    <span class="mi">2</span> <span class="o">+</span> <span class="mi">15</span> <span class="cm">/* PERR IE */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					  <span class="n">IEEE80211_STYPE_ACTION</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="cm">/* BSSID == SA */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_MESH_ACTION</span><span class="p">;</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">.</span><span class="n">action_code</span> <span class="o">=</span>
					<span class="n">WLAN_MESH_ACTION_HWMP_PATH_SELECTION</span><span class="p">;</span>
	<span class="n">ie_len</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_PERR</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="cm">/* ttl */</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ttl</span><span class="p">;</span>
	<span class="cm">/* number of destinations */</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * flags bit, bit 1 is unset if we know the sequence number and</span>
<span class="cm">	 * bit 2 is set if we have a reason code</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_sn</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">MP_F_USN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rcode</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">MP_F_RCODE</span><span class="p">;</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_sn</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_rcode</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* see note in function header */</span>
	<span class="n">prepare_frame_for_deferred_tx</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">next_perr</span> <span class="o">=</span> <span class="n">TU_TO_EXP_TIME</span><span class="p">(</span>
				   <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPperrMinInterval</span><span class="p">);</span>
	<span class="n">ieee80211_add_pending_skb</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211s_update_metric</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">stainfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">failed</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">);</span>

	<span class="cm">/* moving average, scaled to 100 */</span>
	<span class="n">stainfo</span><span class="o">-&gt;</span><span class="n">fail_avg</span> <span class="o">=</span> <span class="p">((</span><span class="mi">80</span> <span class="o">*</span> <span class="n">stainfo</span><span class="o">-&gt;</span><span class="n">fail_avg</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">failed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stainfo</span><span class="o">-&gt;</span><span class="n">fail_avg</span> <span class="o">&gt;</span> <span class="mi">95</span><span class="p">)</span>
		<span class="n">mesh_plink_broken</span><span class="p">(</span><span class="n">stainfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">airtime_link_metric_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rate_info</span> <span class="n">rinfo</span><span class="p">;</span>
	<span class="cm">/* This should be adjusted for each device */</span>
	<span class="kt">int</span> <span class="n">device_constant</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ARITH_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">test_frame_len</span> <span class="o">=</span> <span class="n">TEST_FRAME_LEN</span> <span class="o">&lt;&lt;</span> <span class="n">ARITH_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s_unit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ARITH_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_time</span><span class="p">,</span> <span class="n">estimated_retx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">fail_avg</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MAX_METRIC</span><span class="p">;</span>

	<span class="n">sta_set_rate_info_tx</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_tx_rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">cfg80211_calculate_bitrate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rate</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MAX_METRIC</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">fail_avg</span> <span class="o">&lt;&lt;</span> <span class="n">ARITH_SHIFT</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* bitrate is in units of 100 Kbps, while we need rate in units of</span>
<span class="cm">	 * 1Mbps. This will be corrected on tx_time computation.</span>
<span class="cm">	 */</span>
	<span class="n">tx_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_constant</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">test_frame_len</span> <span class="o">/</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">estimated_retx</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ARITH_SHIFT</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">s_unit</span> <span class="o">-</span> <span class="n">err</span><span class="p">));</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_time</span> <span class="o">*</span> <span class="n">estimated_retx</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ARITH_SHIFT</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hwmp_route_info_get - Update routing info to originator and transmitter</span>
<span class="cm"> *</span>
<span class="cm"> * @sdata: local mesh subif</span>
<span class="cm"> * @mgmt: mesh management frame</span>
<span class="cm"> * @hwmp_ie: hwmp information element (PREP or PREQ)</span>
<span class="cm"> *</span>
<span class="cm"> * This function updates the path routing information to the originator and the</span>
<span class="cm"> * transmitter of a HWMP PREQ or PREP frame.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: metric to frame originator or 0 if the frame should not be further</span>
<span class="cm"> * processed</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: this function is the only place (besides user-provided info) where</span>
<span class="cm"> * path routing information is updated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">hwmp_route_info_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">hwmp_ie</span><span class="p">,</span> <span class="k">enum</span> <span class="n">mpath_frame_type</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fresh_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">orig_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">ta</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_sn</span><span class="p">,</span> <span class="n">orig_metric</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_lifetime</span><span class="p">,</span> <span class="n">exp_time</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_hop_metric</span><span class="p">,</span> <span class="n">new_metric</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">process</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">last_hop_metric</span> <span class="o">=</span> <span class="n">airtime_link_metric_get</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="cm">/* Update and check originator routing info */</span>
	<span class="n">fresh_info</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPATH_PREQ</span>:
		<span class="n">orig_addr</span> <span class="o">=</span> <span class="n">PREQ_IE_ORIG_ADDR</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="n">orig_sn</span> <span class="o">=</span> <span class="n">PREQ_IE_ORIG_SN</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="n">orig_lifetime</span> <span class="o">=</span> <span class="n">PREQ_IE_LIFETIME</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="n">orig_metric</span> <span class="o">=</span> <span class="n">PREQ_IE_METRIC</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPATH_PREP</span>:
		<span class="cm">/* Originator here refers to the MP that was the target in the</span>
<span class="cm">		 * Path Request. We divert from the nomenclature in the draft</span>
<span class="cm">		 * so that we can easily use a single function to gather path</span>
<span class="cm">		 * information from both PREQ and PREP frames.</span>
<span class="cm">		 */</span>
		<span class="n">orig_addr</span> <span class="o">=</span> <span class="n">PREP_IE_TARGET_ADDR</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="n">orig_sn</span> <span class="o">=</span> <span class="n">PREP_IE_TARGET_SN</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="n">orig_lifetime</span> <span class="o">=</span> <span class="n">PREP_IE_LIFETIME</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="n">orig_metric</span> <span class="o">=</span> <span class="n">PREP_IE_METRIC</span><span class="p">(</span><span class="n">hwmp_ie</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_metric</span> <span class="o">=</span> <span class="n">orig_metric</span> <span class="o">+</span> <span class="n">last_hop_metric</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_metric</span> <span class="o">&lt;</span> <span class="n">orig_metric</span><span class="p">)</span>
		<span class="n">new_metric</span> <span class="o">=</span> <span class="n">MAX_METRIC</span><span class="p">;</span>
	<span class="n">exp_time</span> <span class="o">=</span> <span class="n">TU_TO_EXP_TIME</span><span class="p">(</span><span class="n">orig_lifetime</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This MP is the originator, we are not interested in this</span>
<span class="cm">		 * frame, except for updating transmitter&#39;s path info.</span>
<span class="cm">		 */</span>
		<span class="n">process</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">fresh_info</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_FIXED</span><span class="p">)</span>
				<span class="n">fresh_info</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_SN_VALID</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">SN_GT</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">,</span> <span class="n">orig_sn</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span> <span class="o">==</span> <span class="n">orig_sn</span> <span class="o">&amp;&amp;</span>
				     <span class="n">new_metric</span> <span class="o">&gt;=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">metric</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">process</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">fresh_info</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mesh_path_add</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
			<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fresh_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mesh_path_assign_nexthop</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MESH_PATH_SN_VALID</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">metric</span> <span class="o">=</span> <span class="n">new_metric</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span> <span class="o">=</span> <span class="n">orig_sn</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span><span class="p">,</span> <span class="n">exp_time</span><span class="p">)</span>
					  <span class="o">?</span>  <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">:</span> <span class="n">exp_time</span><span class="p">;</span>
			<span class="n">mesh_path_activate</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="n">mesh_path_tx_pending</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>
			<span class="cm">/* draft says preq_id should be saved to, but there does</span>
<span class="cm">			 * not seem to be any use for it, skipping by now</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update and check transmitter routing info */</span>
	<span class="n">ta</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">ta</span><span class="p">))</span>
		<span class="n">fresh_info</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fresh_info</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_FIXED</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">last_hop_metric</span> <span class="o">&gt;</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">metric</span><span class="p">)))</span>
				<span class="n">fresh_info</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mesh_path_add</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
			<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fresh_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mesh_path_assign_nexthop</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">metric</span> <span class="o">=</span> <span class="n">last_hop_metric</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span><span class="p">,</span> <span class="n">exp_time</span><span class="p">)</span>
					  <span class="o">?</span>  <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">:</span> <span class="n">exp_time</span><span class="p">;</span>
			<span class="n">mesh_path_activate</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="n">mesh_path_tx_pending</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">process</span> <span class="o">?</span> <span class="n">new_metric</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwmp_preq_frame_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">preq_elem</span><span class="p">,</span> <span class="n">u32</span> <span class="n">metric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">target_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">orig_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">da</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">target_flags</span><span class="p">,</span> <span class="n">ttl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_sn</span><span class="p">,</span> <span class="n">target_sn</span><span class="p">,</span> <span class="n">lifetime</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reply</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">forward</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Update target SN, if present */</span>
	<span class="n">target_addr</span> <span class="o">=</span> <span class="n">PREQ_IE_TARGET_ADDR</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
	<span class="n">orig_addr</span> <span class="o">=</span> <span class="n">PREQ_IE_ORIG_ADDR</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
	<span class="n">target_sn</span> <span class="o">=</span> <span class="n">PREQ_IE_TARGET_SN</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
	<span class="n">orig_sn</span> <span class="o">=</span> <span class="n">PREQ_IE_ORIG_SN</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
	<span class="n">target_flags</span> <span class="o">=</span> <span class="n">PREQ_IE_TARGET_F</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>

	<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;received PREQ from %pM&quot;</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;PREQ is for us&quot;</span><span class="p">);</span>
		<span class="n">forward</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">metric</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_sn_update</span> <span class="o">+</span>
					<span class="n">net_traversal_jiffies</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_sn_update</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">target_sn</span> <span class="o">=</span> <span class="o">++</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">;</span>
			<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_sn_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_SN_VALID</span><span class="p">))</span> <span class="o">||</span>
					<span class="n">SN_LT</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">,</span> <span class="n">target_sn</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span> <span class="o">=</span> <span class="n">target_sn</span><span class="p">;</span>
				<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MESH_PATH_SN_VALID</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">target_flags</span> <span class="o">&amp;</span> <span class="n">MP_F_DO</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">reply</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">metric</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">metric</span><span class="p">;</span>
				<span class="n">target_sn</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">target_flags</span> <span class="o">&amp;</span> <span class="n">MP_F_RF</span><span class="p">)</span>
					<span class="n">target_flags</span> <span class="o">|=</span> <span class="n">MP_F_DO</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">forward</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lifetime</span> <span class="o">=</span> <span class="n">PREQ_IE_LIFETIME</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
		<span class="n">ttl</span> <span class="o">=</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">element_ttl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;replying to the PREQ&quot;</span><span class="p">);</span>
			<span class="n">mesh_path_sel_frame_tx</span><span class="p">(</span><span class="n">MPATH_PREP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">,</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">orig_sn</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">,</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">target_sn</span><span class="p">),</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lifetime</span><span class="p">),</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forward</span> <span class="o">&amp;&amp;</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshForwarding</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">preq_id</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">ttl</span> <span class="o">=</span> <span class="n">PREQ_IE_TTL</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
		<span class="n">lifetime</span> <span class="o">=</span> <span class="n">PREQ_IE_LIFETIME</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;forwarding the PREQ from %pM&quot;</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">);</span>
		<span class="o">--</span><span class="n">ttl</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">PREQ_IE_FLAGS</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
		<span class="n">preq_id</span> <span class="o">=</span> <span class="n">PREQ_IE_PREQ_ID</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">);</span>
		<span class="n">hopcount</span> <span class="o">=</span> <span class="n">PREQ_IE_HOPCOUNT</span><span class="p">(</span><span class="n">preq_elem</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpath</span> <span class="o">&amp;&amp;</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">is_root</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">rann_snd_addr</span> <span class="o">:</span> <span class="n">broadcast_addr</span><span class="p">;</span>
		<span class="n">mesh_path_sel_frame_tx</span><span class="p">(</span><span class="n">MPATH_PREQ</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">,</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">orig_sn</span><span class="p">),</span> <span class="n">target_flags</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">,</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">target_sn</span><span class="p">),</span> <span class="n">da</span><span class="p">,</span>
				<span class="n">hopcount</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lifetime</span><span class="p">),</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">preq_id</span><span class="p">),</span>
				<span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">da</span><span class="p">))</span>
			<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_unicast</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_mcast</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_frames</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span>
<span class="nf">next_hop_deref_protected</span><span class="p">(</span><span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">,</span>
					 <span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwmp_prep_frame_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">prep_elem</span><span class="p">,</span> <span class="n">u32</span> <span class="n">metric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">target_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">orig_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">next_hop</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">target_sn</span><span class="p">,</span> <span class="n">orig_sn</span><span class="p">,</span> <span class="n">lifetime</span><span class="p">;</span>

	<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;received PREP from %pM&quot;</span><span class="p">,</span> <span class="n">PREP_IE_ORIG_ADDR</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">));</span>

	<span class="n">orig_addr</span> <span class="o">=</span> <span class="n">PREP_IE_ORIG_ADDR</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span>
		<span class="cm">/* destination, no forwarding required */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshForwarding</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ttl</span> <span class="o">=</span> <span class="n">PREP_IE_TTL</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="p">)</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">next_hop</span><span class="p">,</span> <span class="n">next_hop_deref_protected</span><span class="p">(</span><span class="n">mpath</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="o">--</span><span class="n">ttl</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">PREP_IE_FLAGS</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">);</span>
	<span class="n">lifetime</span> <span class="o">=</span> <span class="n">PREP_IE_LIFETIME</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">);</span>
	<span class="n">hopcount</span> <span class="o">=</span> <span class="n">PREP_IE_HOPCOUNT</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">target_addr</span> <span class="o">=</span> <span class="n">PREP_IE_TARGET_ADDR</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">);</span>
	<span class="n">target_sn</span> <span class="o">=</span> <span class="n">PREP_IE_TARGET_SN</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">);</span>
	<span class="n">orig_sn</span> <span class="o">=</span> <span class="n">PREP_IE_ORIG_SN</span><span class="p">(</span><span class="n">prep_elem</span><span class="p">);</span>

	<span class="n">mesh_path_sel_frame_tx</span><span class="p">(</span><span class="n">MPATH_PREP</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">,</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">orig_sn</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">,</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">target_sn</span><span class="p">),</span> <span class="n">next_hop</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
		<span class="n">ttl</span><span class="p">,</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lifetime</span><span class="p">),</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_unicast</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">fwded_frames</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_no_route</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwmp_perr_frame_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">perr_elem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ttl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span> <span class="o">*</span><span class="n">target_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">target_sn</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">target_rcode</span><span class="p">;</span>

	<span class="n">ta</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">;</span>
	<span class="n">ttl</span> <span class="o">=</span> <span class="n">PERR_IE_TTL</span><span class="p">(</span><span class="n">perr_elem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ttl</span><span class="o">--</span><span class="p">;</span>
	<span class="n">target_addr</span> <span class="o">=</span> <span class="n">PERR_IE_TARGET_ADDR</span><span class="p">(</span><span class="n">perr_elem</span><span class="p">);</span>
	<span class="n">target_sn</span> <span class="o">=</span> <span class="n">PERR_IE_TARGET_SN</span><span class="p">(</span><span class="n">perr_elem</span><span class="p">);</span>
	<span class="n">target_rcode</span> <span class="o">=</span> <span class="n">PERR_IE_TARGET_RCODE</span><span class="p">(</span><span class="n">perr_elem</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">next_hop_deref_protected</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_ACTIVE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_SN_VALID</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">SN_GT</span><span class="p">(</span><span class="n">target_sn</span><span class="p">,</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MESH_PATH_ACTIVE</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span> <span class="o">=</span> <span class="n">target_sn</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshForwarding</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">endperr</span><span class="p">;</span>
			<span class="n">mesh_path_error_tx</span><span class="p">(</span><span class="n">ttl</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">,</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">target_sn</span><span class="p">),</span>
					   <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">target_rcode</span><span class="p">),</span>
					   <span class="n">broadcast_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">endperr:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwmp_rann_frame_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_rann_ie</span> <span class="o">*</span><span class="n">rann</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">orig_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_sn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_txsta</span><span class="p">,</span> <span class="n">interval</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">root_is_gate</span><span class="p">;</span>

	<span class="n">ttl</span> <span class="o">=</span> <span class="n">rann</span><span class="o">-&gt;</span><span class="n">rann_ttl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ttl</span><span class="o">--</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">rann</span><span class="o">-&gt;</span><span class="n">rann_flags</span><span class="p">;</span>
	<span class="n">root_is_gate</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RANN_FLAG_IS_GATE</span><span class="p">);</span>
	<span class="n">orig_addr</span> <span class="o">=</span> <span class="n">rann</span><span class="o">-&gt;</span><span class="n">rann_addr</span><span class="p">;</span>
	<span class="n">orig_sn</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rann</span><span class="o">-&gt;</span><span class="n">rann_seq</span><span class="p">);</span>
	<span class="n">interval</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rann</span><span class="o">-&gt;</span><span class="n">rann_interval</span><span class="p">);</span>
	<span class="n">hopcount</span> <span class="o">=</span> <span class="n">rann</span><span class="o">-&gt;</span><span class="n">rann_hopcount</span><span class="p">;</span>
	<span class="n">hopcount</span><span class="o">++</span><span class="p">;</span>
	<span class="n">metric</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rann</span><span class="o">-&gt;</span><span class="n">rann_metric</span><span class="p">);</span>

	<span class="cm">/*  Ignore our own RANNs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;received RANN from %pM via neighbour %pM (is_gate=%d)&quot;</span><span class="p">,</span>
			<span class="n">orig_addr</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">root_is_gate</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">metric_txsta</span> <span class="o">=</span> <span class="n">airtime_link_metric_get</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mesh_path_add</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">orig_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_no_route</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MESH_PATH_ACTIVE</span> <span class="o">|</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">))</span> <span class="o">||</span>
	     <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_FIXED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;%s time to refresh root mpath %pM&quot;</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
							       <span class="n">orig_addr</span><span class="p">);</span>
		<span class="n">mesh_queue_preq</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">PREQ_Q_F_START</span> <span class="o">|</span> <span class="n">PREQ_Q_F_REFRESH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SN_LT</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">,</span> <span class="n">orig_sn</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span> <span class="o">==</span> <span class="n">orig_sn</span> <span class="o">&amp;&amp;</span>
	   <span class="n">metric</span> <span class="o">&lt;</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">rann_metric</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshForwarding</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mesh_path_sel_frame_tx</span><span class="p">(</span><span class="n">MPATH_RANN</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">orig_addr</span><span class="p">,</span>
				       <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">orig_sn</span><span class="p">),</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">broadcast_addr</span><span class="p">,</span>
				       <span class="n">hopcount</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">interval</span><span class="p">),</span>
				       <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">metric</span> <span class="o">+</span> <span class="n">metric_txsta</span><span class="p">),</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span> <span class="o">=</span> <span class="n">orig_sn</span><span class="p">;</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">rann_metric</span> <span class="o">=</span> <span class="n">metric</span> <span class="o">+</span> <span class="n">metric_txsta</span><span class="p">;</span>
		<span class="cm">/* Recording RANNs sender address to send individually</span>
<span class="cm">		 * addressed PREQs destined for root mesh STA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">rann_snd_addr</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">is_root</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">root_is_gate</span><span class="p">)</span>
		<span class="n">mesh_path_add_gate</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">mesh_rx_path_sel_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee802_11_elems</span> <span class="n">elems</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">baselen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_hop_metric</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="cm">/* need action_code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span> <span class="o">||</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">plink_state</span> <span class="o">!=</span> <span class="n">NL80211_PLINK_ESTAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">baselen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">.</span><span class="n">variable</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">mgmt</span><span class="p">;</span>
	<span class="n">ieee802_11_parse_elems</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mesh_action</span><span class="p">.</span><span class="n">variable</span><span class="p">,</span>
			<span class="n">len</span> <span class="o">-</span> <span class="n">baselen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elems</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="p">.</span><span class="n">preq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="p">.</span><span class="n">preq_len</span> <span class="o">!=</span> <span class="mi">37</span><span class="p">)</span>
			<span class="cm">/* Right now we support just 1 destination and no AE */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">last_hop_metric</span> <span class="o">=</span> <span class="n">hwmp_route_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">elems</span><span class="p">.</span><span class="n">preq</span><span class="p">,</span>
						      <span class="n">MPATH_PREQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_hop_metric</span><span class="p">)</span>
			<span class="n">hwmp_preq_frame_process</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">elems</span><span class="p">.</span><span class="n">preq</span><span class="p">,</span>
						<span class="n">last_hop_metric</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="p">.</span><span class="n">prep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="p">.</span><span class="n">prep_len</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">)</span>
			<span class="cm">/* Right now we support no AE */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">last_hop_metric</span> <span class="o">=</span> <span class="n">hwmp_route_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">elems</span><span class="p">.</span><span class="n">prep</span><span class="p">,</span>
						      <span class="n">MPATH_PREP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_hop_metric</span><span class="p">)</span>
			<span class="n">hwmp_prep_frame_process</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">elems</span><span class="p">.</span><span class="n">prep</span><span class="p">,</span>
						<span class="n">last_hop_metric</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="p">.</span><span class="n">perr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="p">.</span><span class="n">perr_len</span> <span class="o">!=</span> <span class="mi">15</span><span class="p">)</span>
			<span class="cm">/* Right now we support only one destination per PERR */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">hwmp_perr_frame_process</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">elems</span><span class="p">.</span><span class="n">perr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="p">.</span><span class="n">rann</span><span class="p">)</span>
		<span class="n">hwmp_rann_frame_process</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">elems</span><span class="p">.</span><span class="n">rann</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mesh_queue_preq - queue a PREQ to a given destination</span>
<span class="cm"> *</span>
<span class="cm"> * @mpath: mesh path to discover</span>
<span class="cm"> * @flags: special attributes of the PREQ to be sent</span>
<span class="cm"> *</span>
<span class="cm"> * Locking: the function must be called from within a rcu read lock block.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mesh_queue_preq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_preq_queue</span> <span class="o">*</span><span class="n">preq_node</span><span class="p">;</span>

	<span class="n">preq_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mesh_preq_queue</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preq_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;could not allocate PREQ node&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_preq_queue_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">preq_queue_len</span> <span class="o">==</span> <span class="n">MAX_PREQ_QUEUE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_preq_queue_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">preq_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;PREQ node queue full&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_REQ_QUEUED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_preq_queue_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">preq_node</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">preq_node</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">preq_node</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MESH_PATH_REQ_QUEUED</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preq_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">preq_queue</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="o">++</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">preq_queue_len</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_preq_queue_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_preq</span> <span class="o">+</span> <span class="n">min_preq_int_jiff</span><span class="p">(</span><span class="n">sdata</span><span class="p">)))</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_preq</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* avoid long wait if did not send preqs for a long time</span>
<span class="cm">		 * and jiffies wrapped around</span>
<span class="cm">		 */</span>
		<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_preq</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">min_preq_int_jiff</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_path_timer</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_preq</span> <span class="o">+</span>
						<span class="n">min_preq_int_jiff</span><span class="p">(</span><span class="n">sdata</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mesh_path_start_discovery - launch a path discovery from the PREQ queue</span>
<span class="cm"> *</span>
<span class="cm"> * @sdata: local mesh subif</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mesh_path_start_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_preq_queue</span> <span class="o">*</span><span class="n">preq_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">target_flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">da</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lifetime</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_preq_queue_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">preq_queue_len</span> <span class="o">||</span>
		<span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_preq</span> <span class="o">+</span>
				<span class="n">min_preq_int_jiff</span><span class="p">(</span><span class="n">sdata</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_preq_queue_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">preq_node</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">preq_queue</span><span class="p">.</span><span class="n">list</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">mesh_preq_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preq_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="o">--</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">preq_queue_len</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_preq_queue_lock</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">preq_node</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">enddiscovery</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MESH_PATH_REQ_QUEUED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">preq_node</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PREQ_Q_F_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">enddiscovery</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MESH_PATH_RESOLVED</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_timeout</span> <span class="o">=</span> <span class="n">disc_timeout_jiff</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MESH_PATH_RESOLVING</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">enddiscovery</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_preq</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_sn_update</span> <span class="o">+</span>
				<span class="n">net_traversal_jiffies</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">last_sn_update</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">;</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">last_sn_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lifetime</span> <span class="o">=</span> <span class="n">default_lifetime</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
	<span class="n">ttl</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">element_ttl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">enddiscovery</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">preq_node</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PREQ_Q_F_REFRESH</span><span class="p">)</span>
		<span class="n">target_flags</span> <span class="o">=</span> <span class="n">MP_F_DO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">target_flags</span> <span class="o">=</span> <span class="n">MP_F_RF</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">is_root</span><span class="p">)</span> <span class="o">?</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">rann_snd_addr</span> <span class="o">:</span> <span class="n">broadcast_addr</span><span class="p">;</span>
	<span class="n">mesh_path_sel_frame_tx</span><span class="p">(</span><span class="n">MPATH_PREQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">),</span> <span class="n">target_flags</span><span class="p">,</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">),</span> <span class="n">da</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ttl</span><span class="p">,</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lifetime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">preq_id</span><span class="o">++</span><span class="p">),</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_timeout</span><span class="p">);</span>

<span class="nl">enddiscovery:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">preq_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* mesh_nexthop_resolve - lookup next hop for given skb and start path</span>
<span class="cm"> * discovery if no forwarding information is found.</span>
<span class="cm"> *</span>
<span class="cm"> * @skb: 802.11 frame to be sent</span>
<span class="cm"> * @sdata: network subif the frame will be sent through</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if the next hop was found and -ENOENT if the frame was queued.</span>
<span class="cm"> * skb is freeed here if no mpath could be allocated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mesh_nexthop_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_to_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">target_addr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mesh_nexthop_lookup</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">endlookup</span><span class="p">;</span>

	<span class="cm">/* no nexthop found, start resolving */</span>
	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mesh_path_add</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mesh_path_discard_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">endlookup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">))</span>
		<span class="n">mesh_queue_preq</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">PREQ_Q_F_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MESH_FRAME_QUEUE_LEN</span><span class="p">)</span>
		<span class="n">skb_to_free</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_NEED_TXPROCESSING</span><span class="p">;</span>
	<span class="n">ieee80211_set_qos_hdr</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_to_free</span><span class="p">)</span>
		<span class="n">mesh_path_discard_frame</span><span class="p">(</span><span class="n">skb_to_free</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>

<span class="nl">endlookup:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * mesh_nexthop_lookup - put the appropriate next hop on a mesh frame. Calling</span>
<span class="cm"> * this function is considered &quot;using&quot; the associated mpath, so preempt a path</span>
<span class="cm"> * refresh if this mpath expires soon.</span>
<span class="cm"> *</span>
<span class="cm"> * @skb: 802.11 frame to be sent</span>
<span class="cm"> * @sdata: network subif the frame will be sent through</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if the next hop was found. Nonzero otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mesh_nexthop_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">next_hop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">target_addr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_ACTIVE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">endlookup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
		       <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">-</span>
		       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">path_refresh_time</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_FIXED</span><span class="p">))</span>
		<span class="n">mesh_queue_preq</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">PREQ_Q_F_START</span> <span class="o">|</span> <span class="n">PREQ_Q_F_REFRESH</span><span class="p">);</span>

	<span class="n">next_hop</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_hop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">next_hop</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">endlookup:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mesh_path_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">quiescing</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVED</span> <span class="o">||</span>
			<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MESH_PATH_RESOLVING</span> <span class="o">|</span> <span class="n">MESH_PATH_RESOLVED</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_retries</span> <span class="o">&lt;</span> <span class="n">max_preq_retries</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_retries</span><span class="p">;</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_timeout</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MESH_PATH_REQ_QUEUED</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="n">mesh_queue_preq</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">is_gate</span> <span class="o">&amp;&amp;</span> <span class="n">mesh_gate_num</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mesh_path_send_to_gates</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">mhwmp_dbg</span><span class="p">(</span><span class="s">&quot;no gate was reachable&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mesh_path_flush_pending</span><span class="p">(</span><span class="n">mpath</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">mesh_path_tx_root_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshHWMPRannInterval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshGateAnnouncementProtocol</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">RANN_FLAG_IS_GATE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mesh_path_sel_frame_tx</span><span class="p">(</span><span class="n">MPATH_RANN</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			       <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">++</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">),</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">broadcast_addr</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">element_ttl</span><span class="p">,</span>
			       <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">interval</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
