<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › tx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2002-2005, Instant802 Networks, Inc.</span>
<span class="cm"> * Copyright 2005-2006, Devicescape Software, Inc.</span>
<span class="cm"> * Copyright 2006-2007	Jiri Benc &lt;jbenc@suse.cz&gt;</span>
<span class="cm"> * Copyright 2007	Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Transmit and frame generation functions.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/ieee80211_radiotap.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;ieee80211_i.h&quot;</span>
<span class="cp">#include &quot;driver-ops.h&quot;</span>
<span class="cp">#include &quot;led.h&quot;</span>
<span class="cp">#include &quot;mesh.h&quot;</span>
<span class="cp">#include &quot;wep.h&quot;</span>
<span class="cp">#include &quot;wpa.h&quot;</span>
<span class="cp">#include &quot;wme.h&quot;</span>
<span class="cp">#include &quot;rate.h&quot;</span>

<span class="cm">/* misc utils */</span>

<span class="k">static</span> <span class="n">__le16</span> <span class="nf">ieee80211_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group_addr</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">next_frag_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">mrate</span><span class="p">,</span> <span class="n">erp</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">txrate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* assume HW handles this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* uh huh? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="n">txrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">erp</span> <span class="o">=</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_ERP_G</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * data and mgmt (except PS Poll):</span>
<span class="cm">	 * - during CFP: 32768</span>
<span class="cm">	 * - during contention period:</span>
<span class="cm">	 *   if addr1 is group address: 0</span>
<span class="cm">	 *   if more fragments = 0 and addr1 is individual address: time to</span>
<span class="cm">	 *      transmit one ACK plus SIFS</span>
<span class="cm">	 *   if more fragments = 1 and addr1 is individual address: time to</span>
<span class="cm">	 *      transmit next fragment plus 2 x ACK plus 3 x SIFS</span>
<span class="cm">	 *</span>
<span class="cm">	 * IEEE 802.11, 9.6:</span>
<span class="cm">	 * - control response frame (CTS or ACK) shall be transmitted using the</span>
<span class="cm">	 *   same rate as the immediately previous frame in the frame exchange</span>
<span class="cm">	 *   sequence, if this rate belongs to the PHY mandatory rates, or else</span>
<span class="cm">	 *   at the highest possible rate belonging to the PHY rates in the</span>
<span class="cm">	 *   BSSBasicRateSet</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TODO: These control frames are not currently sent by</span>
<span class="cm">		 * mac80211, but should they be implemented, this function</span>
<span class="cm">		 * needs to be updated to support duration field calculation.</span>
<span class="cm">		 *</span>
<span class="cm">		 * RTS: time needed to transmit pending data/mgmt frame plus</span>
<span class="cm">		 *    one CTS frame plus one ACK frame plus 3 x SIFS</span>
<span class="cm">		 * CTS: duration of immediately previous RTS minus time</span>
<span class="cm">		 *    required to transmit CTS and its SIFS</span>
<span class="cm">		 * ACK: 0 if immediately previous directed data/mgmt had</span>
<span class="cm">		 *    more=0, with more=1 duration in ACK frame is duration</span>
<span class="cm">		 *    from previous frame minus time needed to transmit ACK</span>
<span class="cm">		 *    and its SIFS</span>
<span class="cm">		 * PS Poll: BIT(15) | BIT(14) | aid</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* data/mgmt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/* FIX: data/mgmt during CFP */</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">32768</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">group_addr</span><span class="p">)</span> <span class="cm">/* Group address as the destination - no ACK */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Individual destination address:</span>
<span class="cm">	 * IEEE 802.11, Ch. 9.6 (after IEEE 802.11g changes)</span>
<span class="cm">	 * CTS and ACK frames shall be transmitted using the highest rate in</span>
<span class="cm">	 * basic rate set that is less than or equal to the rate of the</span>
<span class="cm">	 * immediately previous frame and that is using the same modulation</span>
<span class="cm">	 * (CCK or OFDM). If no basic rate set matches with these requirements,</span>
<span class="cm">	 * the highest mandatory rate of the PHY that is less than or equal to</span>
<span class="cm">	 * the rate of the previous frame is used.</span>
<span class="cm">	 * Mandatory rates for IEEE 802.11g PHY: 1, 2, 5.5, 11, 6, 12, 24 Mbps</span>
<span class="cm">	 */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* use lowest available if everything fails */</span>
	<span class="n">mrate</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bitrate</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">&gt;</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>: <span class="p">{</span>
			<span class="n">u32</span> <span class="n">flag</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SDATA_OPERATING_GMODE</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_MANDATORY_G</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_MANDATORY_B</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span>
				<span class="n">mrate</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_MANDATORY_A</span><span class="p">)</span>
				<span class="n">mrate</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE80211_NUM_BANDS</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No matching basic rate found; use highest suitable mandatory</span>
<span class="cm">		 * PHY rate */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">mrate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t calculate ACKs for QoS Frames with NoAck Policy set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_ACK_POLICY_NOACK</span><span class="p">)</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Time needed to transmit ACK</span>
<span class="cm">		 * (10 bytes + 4-byte FCS = 112 bits) plus SIFS; rounded up</span>
<span class="cm">		 * to closest integer */</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">erp</span><span class="p">,</span>
				<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_frag_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Frame is fragmented: duration increases with time needed to</span>
<span class="cm">		 * transmit next fragment plus ACK and 2 x SIFS. */</span>
		<span class="n">dur</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* ACK + SIFS */</span>
		<span class="cm">/* next fragment */</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">next_frag_len</span><span class="p">,</span>
				<span class="n">txrate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span> <span class="n">erp</span><span class="p">,</span>
				<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dur</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_ieee80211_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">local</span> <span class="o">==</span> <span class="n">wdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tx handlers */</span>
<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_dynamic_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span><span class="p">;</span>

	<span class="cm">/* driver doesn&#39;t support power save */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SUPPORTS_PS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* hardware does dynamic power save */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SUPPORTS_DYNAMIC_PS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* dynamic power save disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">dynamic_ps_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* we are scanning, don&#39;t enable power save */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ps_sdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* No point if we&#39;re going to suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">quiescing</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* dynamic ps is supported only in managed mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t wakeup from power save if u-apsd is enabled, voip ac has</span>
<span class="cm">	 * u-apsd enabled and the frame is in voip class. This effectively</span>
<span class="cm">	 * means that even if all access categories have u-apsd enabled, in</span>
<span class="cm">	 * practise u-apsd is only used with the voip ac. This is a</span>
<span class="cm">	 * workaround for the case when received voip class packets do not</span>
<span class="cm">	 * have correct qos tag for some reason, due the network or the</span>
<span class="cm">	 * peer application.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: ifmgd-&gt;uapsd_queues access is racy here. If the value is</span>
<span class="cm">	 * changed via debugfs, user needs to reassociate manually to have</span>
<span class="cm">	 * everything in sync.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_STA_UAPSD_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">uapsd_queues</span> <span class="o">&amp;</span> <span class="n">IEEE80211_WMM_IE_STA_QOSINFO_AC_VO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_AC_VO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_stop_queues_by_reason</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">IEEE80211_QUEUE_STOP_REASON_PS</span><span class="p">);</span>
		<span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_STA_NULLFUNC_ACKED</span><span class="p">;</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dynamic_ps_disable_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t restart the timer if we&#39;re not disassociated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dynamic_ps_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">dynamic_ps_timeout</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_check_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">assoc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_INJECTED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_SW_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">SDATA_STATE_OFFCHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_is_probe_req</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_is_nullfunc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * When software scanning only nullfunc frames (to notify</span>
<span class="cm">		 * the sleep state to the AP) and probe requests (for the</span>
<span class="cm">		 * active scan) are allowed, all other frames should not be</span>
<span class="cm">		 * sent and we should not get here, but if we do</span>
<span class="cm">		 * nonetheless, drop them to avoid sending them</span>
<span class="cm">		 * off-channel. See the link below and</span>
<span class="cm">		 * ieee80211_start_scan() for more.</span>
<span class="cm">		 *</span>
<span class="cm">		 * http://article.gmane.org/gmane.linux.kernel.wireless.general/30089</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_PS_BUFFERED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">assoc</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_UNICAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">assoc</span> <span class="o">&amp;&amp;</span>
			     <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dropped data frame to not &quot;</span>
			       <span class="s">&quot;associated station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAC80211_VERBOSE_DEBUG */</span><span class="cp"></span>
			<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_handlers_drop_not_assoc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">num_mcast_sta</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No associated STAs - no need to send multicast</span>
<span class="cm">		 * frames.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function is called whenever the AP is about to exceed the maximum limit</span>
<span class="cm"> * of buffered frames for power saving STAs. This situation should not really</span>
<span class="cm"> * happen often during normal operation, so dropping the oldest buffered packet</span>
<span class="cm"> * from each queue should be OK to make some room for new frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">purge_old_ps_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">purged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * virtual interfaces are protected by RCU</span>
<span class="cm">	 */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_if_ap</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">purged</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drop one frame from each station from the lowest-priority</span>
<span class="cm">	 * AC that has frames at all.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ac</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="n">IEEE80211_AC_BK</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_AC_VO</span><span class="p">;</span> <span class="n">ac</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ps_tx_buf</span><span class="p">[</span><span class="n">ac</span><span class="p">]);</span>
			<span class="n">total</span> <span class="o">+=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ps_tx_buf</span><span class="p">[</span><span class="n">ac</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">purged</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">total_ps_buffered</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
	<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;PS buffers full - purged %d frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">purged</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span>
<span class="nf">ieee80211_tx_h_multicast_ps_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * broadcast/multicast frame</span>
<span class="cm">	 *</span>
<span class="cm">	 * If any of the associated stations is in power save mode,</span>
<span class="cm">	 * the frame is buffered to be sent after DTIM beacon frame.</span>
<span class="cm">	 * This is done either by the hardware or us.</span>
<span class="cm">	 */</span>

	<span class="cm">/* powersaving STAs only in AP/VLAN mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* no buffering for ordered frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_order</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* no stations in PS mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">num_sta_ps</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_SEND_AFTER_DTIM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_QUEUE_CONTROL</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">cab_queue</span><span class="p">;</span>

	<span class="cm">/* device releases frame after DTIM beacon */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* buffered in mac80211 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">total_ps_buffered</span> <span class="o">&gt;=</span> <span class="n">TOTAL_MAX_TX_BUFFER</span><span class="p">)</span>
		<span class="n">purge_old_ps_buffers</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">AP_MAX_BC_BUFFER</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;%s: BC TX buffer full - dropping the oldest frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">total_ps_buffered</span><span class="o">++</span><span class="p">;</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">,</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TX_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_use_mfp</span><span class="p">(</span><span class="n">__le16</span> <span class="n">fc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_MFP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_robust_mgmt_frame</span><span class="p">((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span>
					    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span>
<span class="nf">ieee80211_tx_h_unicast_ps_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_STA</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_DRIVER</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_PS_BUFFER</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ac</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="cm">/* only deauth, disassoc and action are bufferable MMPDUs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ieee80211_is_deauth</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ieee80211_is_disassoc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_NO_PS_BUFFER</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;STA %pM aid %d: PS buffer for AC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">aid</span><span class="p">,</span> <span class="n">ac</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAC80211_VERBOSE_PS_DEBUG */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">total_ps_buffered</span> <span class="o">&gt;=</span> <span class="n">TOTAL_MAX_TX_BUFFER</span><span class="p">)</span>
			<span class="n">purge_old_ps_buffers</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ps_tx_buf</span><span class="p">[</span><span class="n">ac</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">STA_MAX_TX_BUFFER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ps_tx_buf</span><span class="p">[</span><span class="n">ac</span><span class="p">]);</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
			<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;%s: STA %pM TX buffer for AC %d full - dropping oldest frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ac</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">total_ps_buffered</span><span class="o">++</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_NEED_TXPROCESSING</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ps_tx_buf</span><span class="p">[</span><span class="n">ac</span><span class="p">],</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_cleanup</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_cleanup</span><span class="p">,</span>
				  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span>
						<span class="n">STA_INFO_CLEANUP_INTERVAL</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * We queued up some frames, so the TIM bit might</span>
<span class="cm">		 * need to be set, recalculate it.</span>
<span class="cm">		 */</span>
		<span class="n">sta_info_recalc_tim</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">TX_QUEUED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_STA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s: STA %pM in PS mode, but polling/in SP -&gt; send frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAC80211_VERBOSE_PS_DEBUG */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_ps_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_PS_BUFFERED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_UNICAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ieee80211_tx_h_unicast_ps_buf</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ieee80211_tx_h_multicast_ps_buf</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_check_control_port_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span> <span class="o">==</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		     <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_no_encrypt</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_select_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span><span class="p">))</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ptk</span><span class="p">)))</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">ieee80211_is_robust_mgmt_frame</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">default_mgmt_key</span><span class="p">)))</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">default_multicast_key</span><span class="p">)))</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">default_unicast_key</span><span class="p">)))</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_INJECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_robust_mgmt_frame</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_MFP</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_handlers_drop_unencrypted</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">skip_hw</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">tx_rx_count</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* TODO: add threshold stuff again */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data_present</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data_present</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">ieee80211_use_mfp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">,</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span>
					       <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span>
				<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">skip_hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
					   <span class="n">IEEE80211_KEY_FLAG_SW_MGMT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KEY_FLAG_TAINTED</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skip_hw</span> <span class="o">&amp;&amp;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KEY_FLAG_UPLOADED_TO_HARDWARE</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_rate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">inval</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">rts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">short_preamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate_control</span> <span class="n">txrc</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">assoc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txrc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txrc</span><span class="p">));</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">,</span>
			 <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>

	<span class="cm">/* set up the tx rate control struct we give the RC algo */</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">sband</span> <span class="o">=</span> <span class="n">sband</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">reported_rate</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mask</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">rc_rateidx_mask</span><span class="p">[</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mask</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">txrc</span><span class="p">.</span><span class="n">max_rate_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">txrc</span><span class="p">.</span><span class="n">max_rate_idx</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mcs_mask</span><span class="p">,</span>
	       <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">rc_rateidx_mcs_mask</span><span class="p">[</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">],</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mcs_mask</span><span class="p">));</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">bss</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
		    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">||</span>
		    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>

	<span class="cm">/* set up RTS protection if desired */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txrc</span><span class="p">.</span><span class="n">rts</span> <span class="o">=</span> <span class="n">rts</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use short preamble if the BSS can handle it, but not for</span>
<span class="cm">	 * management frames unless we know the receiver can handle</span>
<span class="cm">	 * that -- the management frame might be to a station that</span>
<span class="cm">	 * just wants a probe response.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_SHORT_PREAMBLE</span><span class="p">))))</span>
		<span class="n">txrc</span><span class="p">.</span><span class="n">short_preamble</span> <span class="o">=</span> <span class="n">short_preamble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">assoc</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lets not bother rate control if we&#39;re associated and cannot</span>
<span class="cm">	 * talk to the sta. This should not happen.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_SW_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">assoc</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="n">rate_usable_index_exists</span><span class="p">(</span><span class="n">sband</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">),</span>
		 <span class="s">&quot;%s: Dropped data frame as no usable bitrate found while &quot;</span>
		 <span class="s">&quot;scanning and associated. Target station: &quot;</span>
		 <span class="s">&quot;%pM on %d GHz band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span>
		 <span class="n">tx</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re associated with the sta at this point we know we can at</span>
<span class="cm">	 * least send the frame at the lowest bit rate.</span>
<span class="cm">	 */</span>
	<span class="n">rate_control_get_rate</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txrc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">reported_rate</span><span class="p">.</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txrc</span><span class="p">.</span><span class="n">reported_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_tx_rate</span> <span class="o">=</span> <span class="n">txrc</span><span class="p">.</span><span class="n">reported_rate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_tx_rate</span> <span class="o">=</span> <span class="n">txrc</span><span class="p">.</span><span class="n">reported_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX: verify the rate is in the basic rateset</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up the RTS/CTS rate as the fastest basic rate</span>
<span class="cm">	 * that is not faster than the data rate</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX: Should this check all retry rates?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">baserate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* must be a basic rate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* must not be faster than the data rate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">&gt;</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* maximum */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">baserate</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">&lt;</span>
			     <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span><span class="p">)</span>
				<span class="n">baserate</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rts_cts_rate_idx</span> <span class="o">=</span> <span class="n">baserate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_TX_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * make sure there&#39;s no valid rate following</span>
<span class="cm">		 * an invalid one, just in case drivers don&#39;t</span>
<span class="cm">		 * take the API seriously to stop at -1.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inval</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For now assume MCS is already set up correctly, this</span>
<span class="cm">		 * needs to be fixed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">76</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set up RTS protection if desired */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">;</span>

		<span class="cm">/* RC is busted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&gt;=</span>
				 <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">];</span>

		<span class="cm">/* set up short preamble */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">short_preamble</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">;</span>

		<span class="cm">/* set up G protection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rts</span> <span class="o">&amp;&amp;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_cts_prot</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_ERP_G</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Packet injection may want to control the sequence</span>
<span class="cm">	 * number, if we have no matching interface then we</span>
<span class="cm">	 * neither assign one ourselves nor ask the driver to.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_qos_nullfunc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Anything but QoS data that has a sequence number field</span>
<span class="cm">	 * (is long enough) gets a sequence number from the global</span>
<span class="cm">	 * counter.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* driver should assign sequence number */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span><span class="p">;</span>
		<span class="cm">/* for pure STA mode without beacons, we can do it */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">sequence_number</span><span class="p">);</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">sequence_number</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This should be true for injected/management frames only, for</span>
<span class="cm">	 * management frames we have set the IEEE80211_TX_CTL_ASSIGN_SEQ</span>
<span class="cm">	 * above since they are not QoS-data frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* include per-STA, per-TID sequence counter */</span>

	<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">qc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tid_seq</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">seq</span><span class="p">);</span>

	<span class="cm">/* Increase the sequence number. */</span>
	<span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">seq</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hdrlen</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">frag_threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">per_fragm</span> <span class="o">=</span> <span class="n">frag_threshold</span> <span class="o">-</span> <span class="n">hdrlen</span> <span class="o">-</span> <span class="n">FCS_LEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">per_fragm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdrlen</span> <span class="o">-</span> <span class="n">per_fragm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">rem</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* first fragment was already added to queue by caller */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fraglen</span> <span class="o">=</span> <span class="n">per_fragm</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fraglen</span> <span class="o">&gt;</span> <span class="n">rem</span><span class="p">)</span>
			<span class="n">fraglen</span> <span class="o">=</span> <span class="n">rem</span><span class="p">;</span>
		<span class="n">rem</span> <span class="o">-=</span> <span class="n">fraglen</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span>
				    <span class="n">frag_threshold</span> <span class="o">+</span>
				    <span class="n">IEEE80211_ENCRYPT_HEADROOM</span> <span class="o">+</span>
				    <span class="n">IEEE80211_ENCRYPT_TAILROOM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span>
				 <span class="n">IEEE80211_ENCRYPT_HEADROOM</span><span class="p">);</span>
		<span class="cm">/* copy control information */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span> <span class="o">|</span>
				 <span class="n">IEEE80211_TX_CTL_FIRST_FRAGMENT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_MORE_FRAMES</span><span class="p">;</span>

		<span class="n">skb_copy_queue_mapping</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="cm">/* copy header and data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">fraglen</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">fraglen</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="n">fraglen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* adjust first fragment&#39;s length */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">per_fragm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fragnum</span><span class="p">;</span>

	<span class="cm">/* no matter what happens, tx-&gt;skb moves to tx-&gt;skbs */</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_DONTFRAG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_frag_threshold</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Warn when submitting a fragmented A-MPDU frame and drop it.</span>
<span class="cm">	 * This scenario is handled in ieee80211_tx_prepare but extra</span>
<span class="cm">	 * caution taken here as fragmented ampdu may cause Tx stop.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>

	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="cm">/* internal error, why isn&#39;t DONTFRAG set? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span> <span class="o">&lt;=</span> <span class="n">frag_threshold</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now fragment the frame. This will allocate all the fragments and</span>
<span class="cm">	 * chain them (using skb as the first fragment) to skb-&gt;next.</span>
<span class="cm">	 * During transmission, we will remove the successfully transmitted</span>
<span class="cm">	 * fragments from this list. When the low-level driver rejects one</span>
<span class="cm">	 * of the fragments then we will simply pretend to accept the skb</span>
<span class="cm">	 * but store it away as pending.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_fragment</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">frag_threshold</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>

	<span class="cm">/* update duration/seq/flags of fragments */</span>
	<span class="n">fragnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">next_len</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">__le16</span> <span class="n">morefrags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">);</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span> <span class="n">morefrags</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * No multi-rate retries for fragmented frames, that</span>
<span class="cm">			 * would completely throw off the NAV at other STAs.</span>
<span class="cm">			 */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">IEEE80211_TX_MAX_RATES</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_CTL_RATE_CTRL_PROBE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">morefrags</span><span class="p">;</span>
			<span class="n">next_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fragnum</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">);</span>
		<span class="n">fragnum</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_fragments</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">return</span> <span class="n">ieee80211_crypto_wep_encrypt</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="k">return</span> <span class="n">ieee80211_crypto_tkip_encrypt</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="k">return</span> <span class="n">ieee80211_crypto_ccmp_encrypt</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
		<span class="k">return</span> <span class="n">ieee80211_crypto_aes_cmac_encrypt</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ieee80211_crypto_hw_encrypt</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_tx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_tx_h_calculate_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">group_addr</span><span class="p">;</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* must not overwrite AID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">skb_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">next_len</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">next_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">group_addr</span> <span class="o">=</span> <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span>
			<span class="n">ieee80211_duration</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">group_addr</span><span class="p">,</span> <span class="n">next_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* actual transmit path */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_tx_prep_agg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">tid_ampdu_tx</span> <span class="o">*</span><span class="n">tid_tx</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">queued</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reset_agg_timer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">purge_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HT_AGG_STATE_OPERATIONAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">;</span>
		<span class="n">reset_agg_timer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HT_AGG_STATE_WANT_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * nothing -- this aggregation session is being started</span>
<span class="cm">		 * but that might still fail with the driver</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Need to re-check now, because we may get here</span>
<span class="cm">		 *</span>
<span class="cm">		 *  1) in the window during which the setup is actually</span>
<span class="cm">		 *     already done, but not marked yet because not all</span>
<span class="cm">		 *     packets are spliced over to the driver pending</span>
<span class="cm">		 *     queue yet -- if this happened we acquire the lock</span>
<span class="cm">		 *     either before or after the splice happens, but</span>
<span class="cm">		 *     need to recheck which of these cases happened.</span>
<span class="cm">		 *</span>
<span class="cm">		 *  2) during session teardown, if the OPERATIONAL bit</span>
<span class="cm">		 *     was cleared due to the teardown but the pointer</span>
<span class="cm">		 *     hasn&#39;t been assigned NULL yet (or we loaded it</span>
<span class="cm">		 *     before it was assigned) -- in this case it may</span>
<span class="cm">		 *     now be NULL which means we should just let the</span>
<span class="cm">		 *     packet pass through because splicing the frames</span>
<span class="cm">		 *     back is already done.</span>
<span class="cm">		 */</span>
		<span class="n">tid_tx</span> <span class="o">=</span> <span class="n">rcu_dereference_protected_tid_tx</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* do nothing, let packet pass through */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HT_AGG_STATE_OPERATIONAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">;</span>
			<span class="n">reset_agg_timer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">queued</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_NEED_TXPROCESSING</span><span class="p">;</span>
			<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">STA_MAX_TX_BUFFER</span><span class="p">)</span>
				<span class="n">purge_skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">purge_skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">purge_skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset session timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_agg_timer</span> <span class="o">&amp;&amp;</span> <span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">queued</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialises @tx</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ieee80211_tx_result</span>
<span class="nf">ieee80211_tx_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx</span><span class="p">));</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this flag is set to true anywhere, and we get here,</span>
<span class="cm">	 * we are doing the needed processing, so remove the flag</span>
<span class="cm">	 * now.</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_INTFL_NEED_TXPROCESSING</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">use_4addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TX_DROP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_INJECTED</span> <span class="o">||</span>
		   <span class="n">tx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span> <span class="o">==</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_is_qos_nullfunc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_TX_AMPDU_SETUP_IN_HW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tid_ampdu_tx</span> <span class="o">*</span><span class="n">tid_tx</span><span class="p">;</span>

		<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">qc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>

		<span class="n">tid_tx</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_tx</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">queued</span><span class="p">;</span>

			<span class="n">queued</span> <span class="o">=</span> <span class="n">ieee80211_tx_prep_agg</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
						       <span class="n">tid_tx</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">queued</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">TX_QUEUED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_UNICAST</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_UNICAST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_DONTFRAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_UNICAST</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span> <span class="o">&lt;=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">||</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_DONTFRAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_sta_flag</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_CLEAR_PS_FILT</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_FIRST_FRAGMENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_tx_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">skbs</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">txpending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">q</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">q</span> <span class="o">&gt;=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">queues</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skbs</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">txpending</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">q</span><span class="p">])))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Since queue is stopped, queue up frames for later</span>
<span class="cm">			 * transmission from the tx-pending tasklet when the</span>
<span class="cm">			 * queue is woken again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txpending</span><span class="p">)</span>
				<span class="n">skb_queue_splice_init</span><span class="p">(</span><span class="n">skbs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">q</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">skb_queue_splice_tail_init</span><span class="p">(</span><span class="n">skbs</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">q</span><span class="p">]);</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span>
					       <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>

		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skbs</span><span class="p">);</span>
		<span class="n">drv_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns false if the frame couldn&#39;t be transmitted but was queued instead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">__ieee80211_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">skbs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">led_len</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">bool</span> <span class="n">txpending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">pubsta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="n">skbs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="n">skbs</span><span class="p">);</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">uploaded</span><span class="p">)</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">pubsta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pubsta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span> <span class="o">=</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">[</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_QUEUE_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_frags</span><span class="p">)</span>
		<span class="n">drv_tx_frags</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">pubsta</span><span class="p">,</span> <span class="n">skbs</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ieee80211_tx_frags</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">pubsta</span><span class="p">,</span> <span class="n">skbs</span><span class="p">,</span>
					    <span class="n">txpending</span><span class="p">);</span>

	<span class="n">ieee80211_tpt_led_trig_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">led_len</span><span class="p">);</span>
	<span class="n">ieee80211_led_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="n">skbs</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Invoke TX handlers, return 0 on success and non-zero if the</span>
<span class="cm"> * frame was dropped or queued.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">invoke_tx_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ieee80211_tx_result</span> <span class="n">res</span> <span class="o">=</span> <span class="n">TX_DROP</span><span class="p">;</span>

<span class="cp">#define CALL_TXH(txh) \</span>
<span class="cp">	do {				\</span>
<span class="cp">		res = txh(tx);		\</span>
<span class="cp">		if (res != TX_CONTINUE)	\</span>
<span class="cp">			goto txh_done;	\</span>
<span class="cp">	} while (0)</span>

	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_dynamic_ps</span><span class="p">);</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_check_assoc</span><span class="p">);</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_ps_buf</span><span class="p">);</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_check_control_port_protocol</span><span class="p">);</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_select_key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_HAS_RATE_CONTROL</span><span class="p">))</span>
		<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_rate_ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_INTFL_RETRANSMISSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">txh_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_michael_mic_add</span><span class="p">);</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_sequence</span><span class="p">);</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_fragment</span><span class="p">);</span>
	<span class="cm">/* handlers after fragment must be aware of tx info fragmentation! */</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_stats</span><span class="p">);</span>
	<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_encrypt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_HAS_RATE_CONTROL</span><span class="p">))</span>
		<span class="n">CALL_TXH</span><span class="p">(</span><span class="n">ieee80211_tx_h_calculate_duration</span><span class="p">);</span>
<span class="cp">#undef CALL_TXH</span>

 <span class="nl">txh_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TX_DROP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_handlers_drop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TX_QUEUED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_handlers_queued</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns false if the frame couldn&#39;t be transmitted but was queued instead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">txpending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="n">tx</span><span class="p">;</span>
	<span class="n">ieee80211_tx_result</span> <span class="n">res_prepare</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">led_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="cm">/* initialises tx */</span>
	<span class="n">led_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">res_prepare</span> <span class="o">=</span> <span class="n">ieee80211_tx_prepare</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res_prepare</span> <span class="o">==</span> <span class="n">TX_DROP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res_prepare</span> <span class="o">==</span> <span class="n">TX_QUEUED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>

	<span class="cm">/* set up hw_queue value early */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_TX_OFFCHAN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_QUEUE_CONTROL</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span> <span class="o">=</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">hw_queue</span><span class="p">[</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">invoke_tx_handlers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">__ieee80211_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="p">.</span><span class="n">skbs</span><span class="p">,</span> <span class="n">led_len</span><span class="p">,</span>
					<span class="n">tx</span><span class="p">.</span><span class="n">sta</span><span class="p">,</span> <span class="n">txpending</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* device xmit handlers */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_skb_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">head_need</span><span class="p">,</span> <span class="n">bool</span> <span class="n">may_encrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tail_need</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">may_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">crypto_tx_tailroom_needed_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tail_need</span> <span class="o">=</span> <span class="n">IEEE80211_ENCRYPT_TAILROOM</span><span class="p">;</span>
		<span class="n">tail_need</span> <span class="o">-=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">tail_need</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">tail_need</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_expand_skb_head_cloned</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">head_need</span> <span class="o">||</span> <span class="n">tail_need</span><span class="p">)</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_expand_skb_head</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">head_need</span><span class="p">,</span> <span class="n">tail_need</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="s">&quot;failed to reallocate TX buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">headroom</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">may_encrypt</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">may_encrypt</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span><span class="p">);</span>

	<span class="n">headroom</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">may_encrypt</span><span class="p">)</span>
		<span class="n">headroom</span> <span class="o">+=</span> <span class="n">IEEE80211_ENCRYPT_HEADROOM</span><span class="p">;</span>
	<span class="n">headroom</span> <span class="o">-=</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">headroom</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">headroom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_skb_resize</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">headroom</span><span class="p">,</span> <span class="n">may_encrypt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mesh_nexthop_resolve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* skb queued: don&#39;t free */</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_set_qos_hdr</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">ieee80211_tx</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_parse_tx_radiotap</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_radiotap_iterator</span> <span class="n">iterator</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="o">*</span><span class="n">rthdr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_radiotap_iterator_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iterator</span><span class="p">,</span> <span class="n">rthdr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">txflags</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span> <span class="o">|</span>
		       <span class="n">IEEE80211_TX_CTL_DONTFRAG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * for every radiotap entry that is present</span>
<span class="cm">	 * (ieee80211_radiotap_iterator_next returns -ENOENT when no more</span>
<span class="cm">	 * entries present, or -EINVAL on error)</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_radiotap_iterator_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iterator</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* see if this argument is something we can use */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">this_arg_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * You must take care when dereferencing iterator.this_arg</span>
<span class="cm">		 * for multibyte types... the pointer is not aligned.  Use</span>
<span class="cm">		 * get_unaligned((type *)iterator.this_arg) to dereference</span>
<span class="cm">		 * iterator.this_arg for type &quot;type&quot; safely on all arches.</span>
<span class="cm">		*/</span>
		<span class="k">case</span> <span class="n">IEEE80211_RADIOTAP_FLAGS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iterator</span><span class="p">.</span><span class="n">this_arg</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RADIOTAP_F_FCS</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * this indicates that the skb we have been</span>
<span class="cm">				 * handed has the 32-bit FCS CRC at the end...</span>
<span class="cm">				 * we should react to that by snipping it off</span>
<span class="cm">				 * because it will be recomputed and added</span>
<span class="cm">				 * on transmission</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">_max_length</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">))</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

				<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">FCS_LEN</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iterator</span><span class="p">.</span><span class="n">this_arg</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RADIOTAP_F_WEP</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iterator</span><span class="p">.</span><span class="n">this_arg</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RADIOTAP_F_FRAG</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_CTL_DONTFRAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IEEE80211_RADIOTAP_TX_FLAGS</span>:
			<span class="n">txflags</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">this_arg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txflags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RADIOTAP_F_TX_NOACK</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Please update the file</span>
<span class="cm">		 * Documentation/networking/mac80211-injection.txt</span>
<span class="cm">		 * when parsing new fields here.</span>
<span class="cm">		 */</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="cm">/* ie, if we didn&#39;t simply run out of fields */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * remove the radiotap header</span>
<span class="cm">	 * iterator-&gt;_max_length was sanity-checked against</span>
<span class="cm">	 * skb-&gt;len by iterator init</span>
<span class="cm">	 */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iterator</span><span class="p">.</span><span class="n">_max_length</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">netdev_tx_t</span> <span class="nf">ieee80211_monitor_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="o">*</span><span class="n">prthdr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">tmp_sdata</span><span class="p">,</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len_rthdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Frame injection is not allowed if beaconing is not allowed</span>
<span class="cm">	 * or if we need radar detection. Beaconing is usually not allowed when</span>
<span class="cm">	 * the mode or operation (Adhoc, AP, Mesh) does not support DFS.</span>
<span class="cm">	 * Passive scan is also used in world regulatory domains where</span>
<span class="cm">	 * your country is not known and as such it should be treated as</span>
<span class="cm">	 * NO TX unless the channel is explicitly allowed in which case</span>
<span class="cm">	 * your current regulatory domain would not have the passive scan</span>
<span class="cm">	 * flag.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since AP mode uses monitor interfaces to inject/TX management</span>
<span class="cm">	 * frames we can make AP mode the exception to this rule once it</span>
<span class="cm">	 * supports radar detection as its implementation can deal with</span>
<span class="cm">	 * radar detection by itself. We can do that later by adding a</span>
<span class="cm">	 * monitor flag interfaces used for AP support.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span>
	     <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* check for not even having the fixed radiotap header part */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span> <span class="cm">/* too short to be possibly valid */</span>

	<span class="cm">/* is it a header version we can trust to find length from? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">prthdr</span><span class="o">-&gt;</span><span class="n">it_version</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span> <span class="cm">/* only version 0 is supported */</span>

	<span class="cm">/* then there must be a radiotap header with a length we can use */</span>
	<span class="n">len_rthdr</span> <span class="o">=</span> <span class="n">ieee80211_get_radiotap_len</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* does the skb contain enough to deliver on the alleged length? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">len_rthdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span> <span class="cm">/* skb too short for claimed rt header extent */</span>

	<span class="cm">/*</span>
<span class="cm">	 * fix up the pointers accounting for the radiotap</span>
<span class="cm">	 * header still being in there.  We are being given</span>
<span class="cm">	 * a precooked IEEE80211 header so no need for</span>
<span class="cm">	 * normal processing</span>
<span class="cm">	 */</span>
	<span class="n">skb_set_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len_rthdr</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * these are just fixed to the end of the rt area since we</span>
<span class="cm">	 * don&#39;t have any better information and at this point, nobody cares</span>
<span class="cm">	 */</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len_rthdr</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len_rthdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">len_rthdr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">len_rthdr</span><span class="p">);</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">len_rthdr</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize skb-&gt;protocol if the injected frame is a data frame</span>
<span class="cm">	 * carrying a rfc1042 header</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">len_rthdr</span> <span class="o">+</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc1042_header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">rfc1042_header</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">((</span><span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
						    <span class="n">payload</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_TX_CTL_REQ_TX_STATUS</span> <span class="o">|</span>
		      <span class="n">IEEE80211_TX_CTL_INJECTED</span><span class="p">;</span>

	<span class="cm">/* process and remove the injection radiotap header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_parse_tx_radiotap</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * We process outgoing injected frames that have a local address</span>
<span class="cm">	 * we handle as though they are non-injected frames.</span>
<span class="cm">	 * This code here isn&#39;t entirely correct, the local MAC address</span>
<span class="cm">	 * isn&#39;t always enough to find the interface to use; for proper</span>
<span class="cm">	 * VLAN/WDS support we will need a different mechanism (which</span>
<span class="cm">	 * likely isn&#39;t going to be monitor interfaces).</span>
<span class="cm">	 */</span>
	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">tmp_sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">tmp_sdata</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">||</span>
		    <span class="n">tmp_sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">||</span>
		    <span class="n">tmp_sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">tmp_sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sdata</span> <span class="o">=</span> <span class="n">tmp_sdata</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ieee80211_xmit</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span> <span class="cm">/* meaning, we dealt with the skb */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ieee80211_subif_start_xmit - netif start_xmit function for Ethernet-type</span>
<span class="cm"> * subinterfaces (wlan#, WDS, and VLAN interfaces)</span>
<span class="cm"> * @skb: packet to be sent</span>
<span class="cm"> * @dev: incoming interface</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success (and frees skb in this case) or 1 on failure (skb will</span>
<span class="cm"> * not be freed, and caller is responsible for either retrying later or freeing</span>
<span class="cm"> * skb).</span>
<span class="cm"> *</span>
<span class="cm"> * This function takes in an Ethernet header and encapsulates it with suitable</span>
<span class="cm"> * IEEE 802.11 header based on which interface the packet is coming in. The</span>
<span class="cm"> * encapsulated packet will then be passed to master interface, wlan#.11, for</span>
<span class="cm"> * transmission (through low-level driver).</span>
<span class="cm"> */</span>
<span class="n">netdev_tx_t</span> <span class="nf">ieee80211_subif_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">,</span> <span class="n">head_need</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ethertype</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span>  <span class="n">meshhdrlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211s_hdr</span> <span class="n">mesh_hdr</span> <span class="n">__maybe_unused</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="n">__maybe_unused</span> <span class="o">*</span><span class="n">mppath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">mpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">encaps_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encaps_len</span><span class="p">,</span> <span class="n">skip_header_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nh_pos</span><span class="p">,</span> <span class="n">h_pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wme_sta</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">authorized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">tdls_auth</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tdls_direct</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">multicast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">info_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* convert Ethernet header to proper 802.11 header (based on</span>
<span class="cm">	 * operation mode) */</span>
	<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_DATA</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>
			<span class="cm">/* RA TA DA SA */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr4</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
			<span class="n">authorized</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">);</span>
			<span class="n">wme_sta</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_WME</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">);</span>
		<span class="cm">/* DA BSSID SA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>
		<span class="cm">/* RA TA DA SA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wds</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr4</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshTTL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Do not send frames with mesh_ttl == 0 */</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshstats</span><span class="p">.</span><span class="n">dropped_frames_ttl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span>
				<span class="n">mppath</span> <span class="o">=</span> <span class="n">mpp_path_lookup</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use address extension if it is a packet from</span>
<span class="cm">		 * another interface or if we know the destination</span>
<span class="cm">		 * is being proxied by a portal (i.e. portal address</span>
<span class="cm">		 * differs from proxied address)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">mppath</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mppath</span><span class="o">-&gt;</span><span class="n">mpp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_fill_mesh_addresses</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="n">meshhdrlen</span> <span class="o">=</span> <span class="n">ieee80211_new_mesh_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesh_hdr</span><span class="p">,</span>
					<span class="n">sdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">is_mesh_mcast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mesh_da</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
				<span class="cm">/* DA TA mSA AE:SA */</span>
				<span class="n">mesh_da</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mppath</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* RA TA mDA mSA AE:DA SA */</span>
					<span class="n">mesh_da</span> <span class="o">=</span> <span class="n">mppath</span><span class="o">-&gt;</span><span class="n">mpp</span><span class="p">;</span>
					<span class="n">is_mesh_mcast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* DA TA mSA AE:SA */</span>
					<span class="n">mesh_da</span> <span class="o">=</span> <span class="n">bcast</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_fill_mesh_addresses</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="p">,</span>
					<span class="n">mesh_da</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_mesh_mcast</span><span class="p">)</span>
				<span class="n">meshhdrlen</span> <span class="o">=</span>
					<span class="n">ieee80211_new_mesh_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesh_hdr</span><span class="p">,</span>
							<span class="n">sdata</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span>
							<span class="nb">NULL</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">meshhdrlen</span> <span class="o">=</span>
					<span class="n">ieee80211_new_mesh_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesh_hdr</span><span class="p">,</span>
							<span class="n">sdata</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">tdls_peer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">authorized</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span>
							<span class="n">WLAN_STA_AUTHORIZED</span><span class="p">);</span>
				<span class="n">wme_sta</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_WME</span><span class="p">);</span>
				<span class="n">tdls_peer</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span>
							 <span class="n">WLAN_STA_TDLS_PEER</span><span class="p">);</span>
				<span class="n">tdls_auth</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span>
						<span class="n">WLAN_STA_TDLS_PEER_AUTH</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>

			<span class="cm">/*</span>
<span class="cm">			 * If the TDLS link is enabled, send everything</span>
<span class="cm">			 * directly. Otherwise, allow TDLS setup frames</span>
<span class="cm">			 * to be transmitted indirectly.</span>
<span class="cm">			 */</span>
			<span class="n">tdls_direct</span> <span class="o">=</span> <span class="n">tdls_peer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tdls_auth</span> <span class="o">||</span>
				 <span class="o">!</span><span class="p">(</span><span class="n">ethertype</span> <span class="o">==</span> <span class="n">ETH_P_TDLS</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">14</span> <span class="o">&amp;&amp;</span>
				   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_TDLS_SNAP_RFTYPE</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tdls_direct</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* link during setup - throw out frames to peer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tdls_auth</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* DA SA BSSID */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">use_4addr</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ethertype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span>
					  <span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>
			<span class="cm">/* RA TA DA SA */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr4</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>
			<span class="cm">/* BSSID SA DA */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="cm">/* DA SA BSSID */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * There&#39;s no need to try to look up the destination</span>
<span class="cm">	 * if it is a multicast address (which can only happen</span>
<span class="cm">	 * in AP mode)</span>
<span class="cm">	 */</span>
	<span class="n">multicast</span> <span class="o">=</span> <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">multicast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">authorized</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">);</span>
			<span class="n">wme_sta</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_WME</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* For mesh, the use of the QoS header is mandatory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
		<span class="n">wme_sta</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* receiver and we are QoS enabled, use a QoS type frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wme_sta</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">queues</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_QOS_DATA</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drop unicast frames to unauthorised stations unless they are</span>
<span class="cm">	 * EAPOL frames from the local station.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">authorized</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ethertype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span> <span class="o">||</span>
		      <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">))))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_DEBUG</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;%s: dropped frame to %pM (unauthorized port)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_handlers_drop_unauth_port</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">multicast</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">&amp;&amp;</span>
		     <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">SKBTX_WIFI_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">orig_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ack_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">idr_get_new_above</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ack_status_frames</span><span class="p">,</span>
					      <span class="n">orig_skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ack_status_frames</span><span class="p">,</span>
					    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">idr_get_new_above</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ack_status_frames</span><span class="p">,</span>
						      <span class="n">orig_skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ack_status_frames</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ack_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
				<span class="n">info_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_REQ_TX_STATUS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">orig_skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">orig_skb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* couldn&#39;t clone -- lose tx status ... */</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">orig_skb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the skb is shared we need to obtain our own copy.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* can&#39;t happen -- skb is a clone if info_id != 0 */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">info_id</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">tmp_skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skip_header_bytes</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethertype</span> <span class="o">==</span> <span class="n">ETH_P_AARP</span> <span class="o">||</span> <span class="n">ethertype</span> <span class="o">==</span> <span class="n">ETH_P_IPX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encaps_data</span> <span class="o">=</span> <span class="n">bridge_tunnel_header</span><span class="p">;</span>
		<span class="n">encaps_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bridge_tunnel_header</span><span class="p">);</span>
		<span class="n">skip_header_bytes</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ethertype</span> <span class="o">&gt;=</span> <span class="mh">0x600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encaps_data</span> <span class="o">=</span> <span class="n">rfc1042_header</span><span class="p">;</span>
		<span class="n">encaps_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc1042_header</span><span class="p">);</span>
		<span class="n">skip_header_bytes</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">encaps_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">encaps_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nh_pos</span> <span class="o">=</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">h_pos</span> <span class="o">=</span> <span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skip_header_bytes</span><span class="p">);</span>
	<span class="n">nh_pos</span> <span class="o">-=</span> <span class="n">skip_header_bytes</span><span class="p">;</span>
	<span class="n">h_pos</span> <span class="o">-=</span> <span class="n">skip_header_bytes</span><span class="p">;</span>

	<span class="n">head_need</span> <span class="o">=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">encaps_len</span> <span class="o">+</span> <span class="n">meshhdrlen</span> <span class="o">-</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * So we need to modify the skb header and hence need a copy of</span>
<span class="cm">	 * that. The head_need variable above doesn&#39;t, so far, include</span>
<span class="cm">	 * the needed header space that we don&#39;t need right away. If we</span>
<span class="cm">	 * can, then we don&#39;t reallocate right now but only after the</span>
<span class="cm">	 * frame arrives at the master device (if it does...)</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we cannot, however, then we will reallocate to include all</span>
<span class="cm">	 * the ever needed space. Also, if we need to reallocate it anyway,</span>
<span class="cm">	 * make it big enough for everything we may ever need.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head_need</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">head_need</span> <span class="o">+=</span> <span class="n">IEEE80211_ENCRYPT_HEADROOM</span><span class="p">;</span>
		<span class="n">head_need</span> <span class="o">+=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>
		<span class="n">head_need</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">head_need</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_skb_resize</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">head_need</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encaps_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">encaps_len</span><span class="p">),</span> <span class="n">encaps_data</span><span class="p">,</span> <span class="n">encaps_len</span><span class="p">);</span>
		<span class="n">nh_pos</span> <span class="o">+=</span> <span class="n">encaps_len</span><span class="p">;</span>
		<span class="n">h_pos</span> <span class="o">+=</span> <span class="n">encaps_len</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meshhdrlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">meshhdrlen</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mesh_hdr</span><span class="p">,</span> <span class="n">meshhdrlen</span><span class="p">);</span>
		<span class="n">nh_pos</span> <span class="o">+=</span> <span class="n">meshhdrlen</span><span class="p">;</span>
		<span class="n">h_pos</span> <span class="o">+=</span> <span class="n">meshhdrlen</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="o">*</span><span class="n">qos_control</span><span class="p">;</span>

		<span class="n">qos_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Maybe we could actually set some fields here, for now just</span>
<span class="cm">		 * initialise to zero to indicate no special operation.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">qos_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>

	<span class="n">nh_pos</span> <span class="o">+=</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">h_pos</span> <span class="o">+=</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Update skb pointers to various headers since this modified frame</span>
<span class="cm">	 * is going to go through Linux networking code that may potentially</span>
<span class="cm">	 * need things like pointer to IP header. */</span>
	<span class="n">skb_set_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nh_pos</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">h_pos</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info_flags</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ack_frame_id</span> <span class="o">=</span> <span class="n">info_id</span><span class="p">;</span>

	<span class="n">ieee80211_xmit</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">NETDEV_TX_OK</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ieee80211_clear_tx_pending may not be called in a context where</span>
<span class="cm"> * it is possible that it packets could come in again.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ieee80211_clear_tx_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns false if the frame couldn&#39;t be transmitted but was queued instead,</span>
<span class="cm"> * which in this case means re-queued -- take as an indication to stop sending</span>
<span class="cm"> * more pending frames.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_tx_pending_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_INTFL_NEED_TXPROCESSING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ieee80211_tx</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">skbs</span><span class="p">;</span>

		<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbs</span><span class="p">);</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">__ieee80211_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transmit all pending packets. Called from tasklet.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ieee80211_tx_pending</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">txok</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If queue is stopped by something other than due to pending</span>
<span class="cm">		 * frames, or we have no pending frames, proceed to next queue.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span>
						<span class="n">flags</span><span class="p">);</span>

			<span class="n">txok</span> <span class="o">=</span> <span class="n">ieee80211_tx_pending_skb</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span>
					  <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txok</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">ieee80211_propagate_queue_wake</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* functions for drivers to get certain frames */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_beacon_add_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_if_ap</span> <span class="o">*</span><span class="n">bss</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">beacon_data</span> <span class="o">*</span><span class="n">beacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aid0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">have_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">;</span>

	<span class="cm">/* Generate bitmap for TIM only if there are any STAs in power save</span>
<span class="cm">	 * mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">num_sta_ps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* in the hope that this is faster than</span>
<span class="cm">		 * checking byte-for-byte */</span>
		<span class="n">have_bits</span> <span class="o">=</span> <span class="o">!</span><span class="n">bitmap_empty</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">,</span>
					  <span class="n">IEEE80211_MAX_AID</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_count</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">tim</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_TIM</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_count</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">dtim_period</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">))</span>
		<span class="n">aid0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_bc_mc</span> <span class="o">=</span> <span class="n">aid0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">have_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Find largest even number N1 so that bits numbered 1 through</span>
<span class="cm">		 * (N1 x 8) - 1 in the bitmap are 0 and number N2 so that bits</span>
<span class="cm">		 * (N2 + 1) x 8 through 2007 are 0. */</span>
		<span class="n">n1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MAX_TIM_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">n1</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">n2</span> <span class="o">=</span> <span class="n">n1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_TIM_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">n2</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Bitmap control */</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">|</span> <span class="n">aid0</span><span class="p">;</span>
		<span class="cm">/* Part Virt Bitmap */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">n2</span> <span class="o">-</span> <span class="n">n1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">tim</span> <span class="o">+</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">-</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n2</span> <span class="o">-</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">aid0</span><span class="p">;</span> <span class="cm">/* Bitmap control */</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Part Virt Bitmap */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_beacon_get_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="o">*</span><span class="n">tim_offset</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">tim_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_ap</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beacon_data</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate_control</span> <span class="n">txrc</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tim_offset</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tim_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tim_length</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tim_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">;</span>
		<span class="n">beacon</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * headroom, head length,</span>
<span class="cm">			 * tail length and maximum TIM length</span>
<span class="cm">			 */</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span>
					    <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">head_len</span> <span class="o">+</span>
					    <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail_len</span> <span class="o">+</span> <span class="mi">256</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">head_len</span><span class="p">),</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
			       <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">head_len</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Not very nice, but we want to allow the driver to call</span>
<span class="cm">			 * ieee80211_beacon_get() as a response to the set_tim()</span>
<span class="cm">			 * callback. That, however, is already invoked under the</span>
<span class="cm">			 * sta_lock to guarantee consistent and race-free update</span>
<span class="cm">			 * of the tim bitmap in mac80211 and the driver.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tim_in_locked_section</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ieee80211_beacon_add_tim</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
							 <span class="n">beacon</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">ieee80211_beacon_add_tim</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
							 <span class="n">beacon</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tim_offset</span><span class="p">)</span>
				<span class="o">*</span><span class="n">tim_offset</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">head_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tim_length</span><span class="p">)</span>
				<span class="o">*</span><span class="n">tim_length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">head_len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail_len</span><span class="p">),</span>
				       <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_if_ibss</span> <span class="o">*</span><span class="n">ifibss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ibss</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">presp</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">ifibss</span><span class="o">-&gt;</span><span class="n">presp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">presp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">presp</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
						 <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">)</span> <span class="o">+</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mesh_id_len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">sync_ops</span><span class="p">)</span>
			<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">sync_ops</span><span class="o">-&gt;</span><span class="n">adjust_tbtt</span><span class="p">(</span>
						<span class="n">sdata</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span>
				    <span class="n">hdr_len</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="cm">/* NULL SSID */</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="cm">/* supported rates */</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="cm">/* DS params */</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">IEEE80211_MAX_SUPP_RATES</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span><span class="p">)</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span><span class="p">)</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mesh_id_len</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_meshconf_ie</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">ie_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
		<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">beacon_int</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">);</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">capab_info</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">security</span> <span class="o">?</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_add_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mesh_add_ds_params_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ieee80211_add_ext_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mesh_add_rsn_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mesh_add_ht_cap_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mesh_add_ht_oper_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mesh_add_meshid_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mesh_add_meshconf_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mesh_add_vendor_ies</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;o11s: couldn&#39;t add ies!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txrc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txrc</span><span class="p">));</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">sband</span> <span class="o">=</span> <span class="n">sband</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">reported_rate</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mask</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">rc_rateidx_mask</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mask</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">txrc</span><span class="p">.</span><span class="n">max_rate_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">txrc</span><span class="p">.</span><span class="n">max_rate_idx</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mcs_mask</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">rc_rateidx_mcs_mask</span><span class="p">[</span><span class="n">band</span><span class="p">],</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">txrc</span><span class="p">.</span><span class="n">rate_idx_mcs_mask</span><span class="p">));</span>
	<span class="n">txrc</span><span class="p">.</span><span class="n">bss</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rate_control_get_rate</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txrc</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span> <span class="o">|</span>
			<span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span> <span class="o">|</span>
			<span class="n">IEEE80211_TX_CTL_FIRST_FRAGMENT</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_beacon_get_tim</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_proberesp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_ap</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">presp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">presp</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">probe_resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">presp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">presp</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">));</span>

<span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_proberesp_get</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_pspoll_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_pspoll</span> <span class="o">*</span><span class="n">pspoll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pspoll</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="n">pspoll</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_pspoll</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pspoll</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pspoll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pspoll</span><span class="p">));</span>
	<span class="n">pspoll</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">|</span>
					    <span class="n">IEEE80211_STYPE_PSPOLL</span><span class="p">);</span>
	<span class="n">pspoll</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>

	<span class="cm">/* aid in PS-Poll has its two MSBs each set to 1 */</span>
	<span class="n">pspoll</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pspoll</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pspoll</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_pspoll_get</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_nullfunc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">nullfunc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nullfunc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="n">nullfunc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
							  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nullfunc</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nullfunc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nullfunc</span><span class="p">));</span>
	<span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
					      <span class="n">IEEE80211_STYPE_NULLFUNC</span> <span class="o">|</span>
					      <span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_nullfunc_get</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_probereq_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ssid_len</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ie_ssid_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">ie_ssid_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ssid_len</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">ie_ssid_len</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					 <span class="n">IEEE80211_STYPE_PROBE_REQ</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ie_ssid_len</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">ssid_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_probereq_get</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_rts_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">frame_len</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">frame_txctl</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_rts</span> <span class="o">*</span><span class="n">rts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_RTS</span><span class="p">);</span>
	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">ieee80211_rts_duration</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">,</span>
					       <span class="n">frame_txctl</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_rts_get</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_ctstoself_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">frame_len</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">frame_txctl</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_cts</span> <span class="o">*</span><span class="n">cts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

	<span class="n">cts</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_CTS</span><span class="p">);</span>
	<span class="n">cts</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">ieee80211_ctstoself_duration</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span>
						     <span class="n">frame_len</span><span class="p">,</span> <span class="n">frame_txctl</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cts</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cts</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_ctstoself_get</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">ieee80211_get_buffered_bc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_ap</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beacon_data</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">beacon</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span> <span class="o">!</span><span class="n">beacon</span> <span class="o">||</span> <span class="o">!</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">dtim_bc_mc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* send buffered bc/mc only after DTIM beacon */</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">total_ps_buffered</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ps_bc_buf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="cm">/* more buffered multicast/broadcast frames ==&gt; set</span>
<span class="cm">			 * MoreData flag in IEEE 802.11 header to inform PS</span>
<span class="cm">			 * STAs */</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_MOREDATA</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_tx_prepare</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_PS_BUFFERED</span><span class="p">;</span>
	<span class="n">tx</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invoke_tx_handlers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="p">))</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_get_buffered_bc</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_tx_skb_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ac</span> <span class="o">=</span> <span class="n">ieee802_1d_to_ac</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="n">skb_set_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ac</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The other path calling ieee80211_xmit is from the tasklet,</span>
<span class="cm">	 * and while we can handle concurrent transmissions locking</span>
<span class="cm">	 * requirements are that we do not come into tx with bhs on.</span>
<span class="cm">	 */</span>
	<span class="n">local_bh_disable</span><span class="p">();</span>
	<span class="n">ieee80211_xmit</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">local_bh_enable</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
