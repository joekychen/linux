<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › rx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2002-2005, Instant802 Networks, Inc.</span>
<span class="cm"> * Copyright 2005-2006, Devicescape Software, Inc.</span>
<span class="cm"> * Copyright 2006-2007	Jiri Benc &lt;jbenc@suse.cz&gt;</span>
<span class="cm"> * Copyright 2007-2010	Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;net/ieee80211_radiotap.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;ieee80211_i.h&quot;</span>
<span class="cp">#include &quot;driver-ops.h&quot;</span>
<span class="cp">#include &quot;led.h&quot;</span>
<span class="cp">#include &quot;mesh.h&quot;</span>
<span class="cp">#include &quot;wep.h&quot;</span>
<span class="cp">#include &quot;wpa.h&quot;</span>
<span class="cp">#include &quot;tkip.h&quot;</span>
<span class="cp">#include &quot;wme.h&quot;</span>
<span class="cp">#include &quot;rate.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * monitor mode reception</span>
<span class="cm"> *</span>
<span class="cm"> * This function cleans up the SKB, i.e. it removes all the stuff</span>
<span class="cm"> * only useful for monitoring.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">remove_monitor_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">FCS_LEN</span><span class="p">))</span>
			<span class="n">__pskb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">FCS_LEN</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* driver bug */</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">should_drop_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">present_fcs_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_FLAG_FAILED_FCS_CRC</span> <span class="o">|</span> <span class="n">RX_FLAG_FAILED_PLCP_CRC</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">present_fcs_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_radiotap_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* always present fields */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_MACTIME_MPDU</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* padding for RX_FLAGS if necessary */</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">)</span> <span class="cm">/* HT info */</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ieee80211_add_rx_radiotap_header - add radiotap header</span>
<span class="cm"> *</span>
<span class="cm"> * add a radiotap header containing all the fields which the hardware provided.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ieee80211_add_rx_radiotap_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">rtap_len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">has_fcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="o">*</span><span class="n">rthdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rtap_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rthdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rtap_len</span><span class="p">);</span>

	<span class="cm">/* radiotap header, set always present flags */</span>
	<span class="n">rthdr</span><span class="o">-&gt;</span><span class="n">it_present</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_FLAGS</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_CHANNEL</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_ANTENNA</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_RX_FLAGS</span><span class="p">));</span>
	<span class="n">rthdr</span><span class="o">-&gt;</span><span class="n">it_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rtap_len</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">rthdr</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* the order of the following fields is important */</span>

	<span class="cm">/* IEEE80211_RADIOTAP_TSFT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_MACTIME_MPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_unaligned_le64</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">mactime</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="n">rthdr</span><span class="o">-&gt;</span><span class="n">it_present</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_TSFT</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* IEEE80211_RADIOTAP_FLAGS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_fcs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_F_FCS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_FLAG_FAILED_FCS_CRC</span> <span class="o">|</span> <span class="n">RX_FLAG_FAILED_PLCP_CRC</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_F_BADFCS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_F_SHORTPRE</span><span class="p">;</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* IEEE80211_RADIOTAP_RATE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span> <span class="o">||</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Without rate information don&#39;t add it. If we have,</span>
<span class="cm">		 * MCS information is a separate field in radiotap,</span>
<span class="cm">		 * added below. The byte here is needed as padding</span>
<span class="cm">		 * for the channel though, so initialise it to 0.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rthdr</span><span class="o">-&gt;</span><span class="n">it_present</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_RATE</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* IEEE80211_RADIOTAP_CHANNEL */</span>
	<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_5GHZ</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_DYN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_ERP_G</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_CCK</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* IEEE80211_RADIOTAP_DBM_ANTSIGNAL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_NO_SIGNAL_VAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>
		<span class="n">rthdr</span><span class="o">-&gt;</span><span class="n">it_present</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTSIGNAL</span><span class="p">);</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* IEEE80211_RADIOTAP_LOCK_QUALITY is missing */</span>

	<span class="cm">/* IEEE80211_RADIOTAP_ANTENNA */</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">antenna</span><span class="p">;</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* IEEE80211_RADIOTAP_DB_ANTNOISE is not used */</span>

	<span class="cm">/* IEEE80211_RADIOTAP_RX_FLAGS */</span>
	<span class="cm">/* ensure 2 byte alignment for the 2 byte field as required */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rthdr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_FAILED_PLCP_CRC</span><span class="p">)</span>
		<span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_F_RX_BADPLCP</span><span class="p">;</span>
	<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">rx_flags</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rthdr</span><span class="o">-&gt;</span><span class="n">it_present</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_MCS</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">radiotap_mcs_details</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_MCS_SGI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_MCS_BW_40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT_GF</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pos</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_MCS_FMT_GF</span><span class="p">;</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function copies a received frame to all monitor interfaces and</span>
<span class="cm"> * returns a cleaned-up SKB that no longer includes the FCS nor the</span>
<span class="cm"> * radiotap header the driver might have added.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">ieee80211_rx_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">origskb</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">origskb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needed_headroom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">prev_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">present_fcs_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, we may need to make a copy of the skb because</span>
<span class="cm">	 *  (1) we need to modify it for radiotap (if not present), and</span>
<span class="cm">	 *  (2) the other RX handlers will modify the skb we got.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We don&#39;t need to, of course, if we aren&#39;t going to return</span>
<span class="cm">	 * the SKB because it has a bad FCS/PLCP checksum.</span>
<span class="cm">	 */</span>

	<span class="cm">/* room for the radiotap header based on driver features */</span>
	<span class="n">needed_headroom</span> <span class="o">=</span> <span class="n">ieee80211_rx_radiotap_len</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span><span class="p">)</span>
		<span class="n">present_fcs_len</span> <span class="o">=</span> <span class="n">FCS_LEN</span><span class="p">;</span>

	<span class="cm">/* make sure hdr-&gt;frame_control is on the linear part */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">origskb</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">origskb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitors</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">should_drop_frame</span><span class="p">(</span><span class="n">origskb</span><span class="p">,</span> <span class="n">present_fcs_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">origskb</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">remove_monitor_info</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">origskb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">should_drop_frame</span><span class="p">(</span><span class="n">origskb</span><span class="p">,</span> <span class="n">present_fcs_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* only need to expand headroom if necessary */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">origskb</span><span class="p">;</span>
		<span class="n">origskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This shouldn&#39;t trigger often because most devices have an</span>
<span class="cm">		 * RX header they pull before we get here, and that should</span>
<span class="cm">		 * be big enough for our radiotap information. We should</span>
<span class="cm">		 * probably export the length to drivers so that we can have</span>
<span class="cm">		 * them allocate enough headroom to start with.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">needed_headroom</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">needed_headroom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Need to make a copy and possibly remove radiotap header</span>
<span class="cm">		 * and FCS from the original.</span>
<span class="cm">		 */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_copy_expand</span><span class="p">(</span><span class="n">origskb</span><span class="p">,</span> <span class="n">needed_headroom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="n">origskb</span> <span class="o">=</span> <span class="n">remove_monitor_info</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">origskb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">origskb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepend radiotap information */</span>
	<span class="n">ieee80211_add_rx_radiotap_header</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">needed_headroom</span><span class="p">,</span>
					 <span class="nb">true</span><span class="p">);</span>

	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mntr_flags</span> <span class="o">&amp;</span> <span class="n">MONITOR_FLAG_COOK_FRAMES</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb2</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">prev_dev</span><span class="p">;</span>
				<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">prev_dev</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">prev_dev</span><span class="p">;</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">origskb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_parse_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">seqno_idx</span><span class="p">,</span> <span class="n">security_idx</span><span class="p">;</span>

	<span class="cm">/* does the frame have a qos control field? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="cm">/* frame has qos control */</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">qc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">qc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_A_MSDU_PRESENT</span><span class="p">)</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_AMSDU</span><span class="p">;</span>

		<span class="n">seqno_idx</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
		<span class="n">security_idx</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * IEEE 802.11-2007, 7.1.3.4.1 (&quot;Sequence Number field&quot;):</span>
<span class="cm">		 *</span>
<span class="cm">		 *	Sequence numbers for management frames, QoS data</span>
<span class="cm">		 *	frames with a broadcast/multicast address in the</span>
<span class="cm">		 *	Address 1 field, and all non-QoS data frames sent</span>
<span class="cm">		 *	by QoS STAs are assigned using an additional single</span>
<span class="cm">		 *	modulo-4096 counter, [...]</span>
<span class="cm">		 *</span>
<span class="cm">		 * We also use that counter for non-QoS STAs.</span>
<span class="cm">		 */</span>
		<span class="n">seqno_idx</span> <span class="o">=</span> <span class="n">NUM_RX_DATA_QUEUES</span><span class="p">;</span>
		<span class="n">security_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="n">security_idx</span> <span class="o">=</span> <span class="n">NUM_RX_DATA_QUEUES</span><span class="p">;</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">seqno_idx</span> <span class="o">=</span> <span class="n">seqno_idx</span><span class="p">;</span>
	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">security_idx</span> <span class="o">=</span> <span class="n">security_idx</span><span class="p">;</span>
	<span class="cm">/* Set skb-&gt;priority to 1d tag if highest order bit of TID is not set.</span>
<span class="cm">	 * For now, set skb-&gt;priority to 0 for other cases. */</span>
	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * DOC: Packet alignment</span>
<span class="cm"> *</span>
<span class="cm"> * Drivers always need to pass packets that are aligned to two-byte boundaries</span>
<span class="cm"> * to the stack.</span>
<span class="cm"> *</span>
<span class="cm"> * Additionally, should, if possible, align the payload data in a way that</span>
<span class="cm"> * guarantees that the contained IP header is aligned to a four-byte</span>
<span class="cm"> * boundary. In the case of regular frames, this simply means aligning the</span>
<span class="cm"> * payload to a four-byte boundary (because either the IP header is directly</span>
<span class="cm"> * contained, or IV/RFC1042 headers that have a length divisible by four are</span>
<span class="cm"> * in front of it).  If the payload data is not properly aligned and the</span>
<span class="cm"> * architecture doesn&#39;t support efficient unaligned operations, mac80211</span>
<span class="cm"> * will align the data.</span>
<span class="cm"> *</span>
<span class="cm"> * With A-MSDU frames, however, the payload data address must yield two modulo</span>
<span class="cm"> * four because there are 14-byte 802.3 headers within the A-MSDU frames that</span>
<span class="cm"> * push the IP header further back to a multiple of four again. Thankfully, the</span>
<span class="cm"> * specs were sane enough this time around to require padding each A-MSDU</span>
<span class="cm"> * subframe to a length that is a multiple of four.</span>
<span class="cm"> *</span>
<span class="cm"> * Padding like Atheros hardware adds which is between the 802.11 header and</span>
<span class="cm"> * the payload is not supported, the driver is required to move the 802.11</span>
<span class="cm"> * header to be directly in front of the payload in that case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_verify_alignment</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_DEBUG</span>
	<span class="n">WARN_ONCE</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
		  <span class="s">&quot;unaligned packet at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/* rx handlers */</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_passive_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_IN_SCAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sched_scanning</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_HW_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_SW_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_ONCHANNEL_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">sched_scanning</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ieee80211_scan_rx</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* scanning finished during invoking of handlers */</span>
	<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_drop_passive_scan</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_is_unicast_robust_mgmt_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">||</span> <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ieee80211_is_robust_mgmt_frame</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_is_multicast_robust_mgmt_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ieee80211_is_robust_mgmt_frame</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Get the BIP key index from MMIE; return -1 if this is not a BIP frame */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_mmie_keyidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mmie</span> <span class="o">*</span><span class="n">mmie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mmie</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_robust_mgmt_frame</span><span class="p">((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* not a robust management frame */</span>

	<span class="n">mmie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mmie</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mmie</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmie</span><span class="o">-&gt;</span><span class="n">element_id</span> <span class="o">!=</span> <span class="n">WLAN_EID_MMIE</span> <span class="o">||</span>
	    <span class="n">mmie</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mmie</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mmie</span><span class="o">-&gt;</span><span class="n">key_id</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">ieee80211_rx_result</span>
<span class="nf">ieee80211_rx_mesh_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_tods</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">ieee80211_has_fromds</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If there is not an established peer link and this is not a peer link</span>
<span class="cm">	 * establisment frame, beacon or probe, drop the frame.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">||</span> <span class="n">sta_plink_state</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NL80211_PLINK_ESTAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">category</span><span class="p">;</span>
			<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
			<span class="n">category</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">category</span> <span class="o">!=</span> <span class="n">WLAN_CATEGORY_MESH_ACTION</span> <span class="o">&amp;&amp;</span>
				<span class="n">category</span> <span class="o">!=</span> <span class="n">WLAN_CATEGORY_SELF_PROTECTED</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_req</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SEQ_MODULO 0x1000</span>
<span class="cp">#define SEQ_MASK   0xfff</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">seq_less</span><span class="p">(</span><span class="n">u16</span> <span class="n">sq1</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sq2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">sq1</span> <span class="o">-</span> <span class="n">sq2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEQ_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">SEQ_MODULO</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">seq_inc</span><span class="p">(</span><span class="n">u16</span> <span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEQ_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">seq_sub</span><span class="p">(</span><span class="n">u16</span> <span class="n">sq1</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sq2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sq1</span> <span class="o">-</span> <span class="n">sq2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEQ_MASK</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_release_reorder_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">tid_ampdu_rx</span> <span class="o">*</span><span class="n">tid_agg_rx</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_frame</span><span class="p">;</span>

	<span class="cm">/* release the frame from the reorder ring buffer */</span>
	<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">stored_mpdu_num</span><span class="o">--</span><span class="p">;</span>
	<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_DEFERRED_RELEASE</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_skb_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="nl">no_frame:</span>
	<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span> <span class="o">=</span> <span class="n">seq_inc</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_release_reorder_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">tid_ampdu_rx</span> <span class="o">*</span><span class="n">tid_agg_rx</span><span class="p">,</span>
					     <span class="n">u16</span> <span class="n">head_seq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">seq_less</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">,</span> <span class="n">head_seq_num</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">seq_sub</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">)</span> <span class="o">%</span>
							<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
		<span class="n">ieee80211_release_reorder_frame</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Timeout (in jiffies) for skb&#39;s that are waiting in the RX reorder buffer. If</span>
<span class="cm"> * the skb was added to the buffer longer than this time ago, the earlier</span>
<span class="cm"> * frames that have not yet been received are assumed to be lost and the skb</span>
<span class="cm"> * can be released for processing. This may also release other skb&#39;s from the</span>
<span class="cm"> * reorder buffer if there are no additional gaps between the frames.</span>
<span class="cm"> *</span>
<span class="cm"> * Callers must hold tid_agg_rx-&gt;reorder_lock.</span>
<span class="cm"> */</span>
<span class="cp">#define HT_RX_REORDER_BUF_TIMEOUT (HZ / 10)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_sta_reorder_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">tid_ampdu_rx</span> <span class="o">*</span><span class="n">tid_agg_rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>

	<span class="cm">/* release the buffer until next missing frame */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">seq_sub</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">)</span> <span class="o">%</span>
						<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">stored_mpdu_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No buffers ready to be released, but check whether any</span>
<span class="cm">		 * frames in the reorder buffer have timed out.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">index</span><span class="p">;</span>
		     <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">skipped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skipped</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_time</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
					<span class="n">HT_RX_REORDER_BUF_TIMEOUT</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">set_release_timer</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC80211_HT_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					    <span class="s">&quot;release an RX reorder frame due to timeout on earlier frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ieee80211_release_reorder_frame</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Increment the head seq# also for the skipped slots.</span>
<span class="cm">			 */</span>
			<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span> <span class="o">+</span> <span class="n">skipped</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEQ_MASK</span><span class="p">;</span>
			<span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">while</span> <span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ieee80211_release_reorder_frame</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">=</span>	<span class="n">seq_sub</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">)</span> <span class="o">%</span>
							<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">stored_mpdu_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">index</span> <span class="o">=</span> <span class="n">seq_sub</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">,</span>
				    <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">)</span> <span class="o">%</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">!=</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
		     <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

 <span class="nl">set_release_timer:</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_timer</span><span class="p">,</span>
			  <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_time</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
			  <span class="n">HT_RX_REORDER_BUF_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_timer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * As this function belongs to the RX path it must be under</span>
<span class="cm"> * rcu_read_lock protection. It returns false if the frame</span>
<span class="cm"> * can be processed immediately, true if it was consumed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_sta_manage_reorder_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">tid_ampdu_rx</span> <span class="o">*</span><span class="n">tid_agg_rx</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mpdu_seq_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">head_seq_num</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>

	<span class="n">buf_size</span> <span class="o">=</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="n">head_seq_num</span> <span class="o">=</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">;</span>

	<span class="cm">/* frame with out of date sequence number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq_less</span><span class="p">(</span><span class="n">mpdu_seq_num</span><span class="p">,</span> <span class="n">head_seq_num</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If frame the sequence number exceeds our buffering window</span>
<span class="cm">	 * size release some previous frames to make room for this one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seq_less</span><span class="p">(</span><span class="n">mpdu_seq_num</span><span class="p">,</span> <span class="n">head_seq_num</span> <span class="o">+</span> <span class="n">buf_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">head_seq_num</span> <span class="o">=</span> <span class="n">seq_inc</span><span class="p">(</span><span class="n">seq_sub</span><span class="p">(</span><span class="n">mpdu_seq_num</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">));</span>
		<span class="cm">/* release stored frames up to new head to stack */</span>
		<span class="n">ieee80211_release_reorder_frames</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">,</span> <span class="n">head_seq_num</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now the new frame is always in the range of the reordering buffer */</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">seq_sub</span><span class="p">(</span><span class="n">mpdu_seq_num</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">)</span> <span class="o">%</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>

	<span class="cm">/* check if we already stored this frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the current MPDU is in the right order and nothing else</span>
<span class="cm">	 * is stored we can process it directly, no need to buffer it.</span>
<span class="cm">	 * If it is first but there&#39;s something stored, we may be able</span>
<span class="cm">	 * to release frames after this one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpdu_seq_num</span> <span class="o">==</span> <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">stored_mpdu_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span> <span class="o">=</span> <span class="n">seq_inc</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">head_seq_num</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* put the frame in the reordering buffer */</span>
	<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_time</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">stored_mpdu_num</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ieee80211_sta_reorder_release</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reorder MPDUs from A-MPDUs, keeping them on a buffer. Returns</span>
<span class="cm"> * true if the MPDU was buffered, false if it should be processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_rx_reorder_ampdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tid_ampdu_rx</span> <span class="o">*</span><span class="n">tid_agg_rx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ack_policy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">dont_reorder</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * filter the QoS data rx stream according to</span>
<span class="cm">	 * STA/TID and check if this STA/TID is on aggregation</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">dont_reorder</span><span class="p">;</span>

	<span class="n">ack_policy</span> <span class="o">=</span> <span class="o">*</span><span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">IEEE80211_QOS_CTL_ACK_POLICY_MASK</span><span class="p">;</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>

	<span class="n">tid_agg_rx</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_rx</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid_agg_rx</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">dont_reorder</span><span class="p">;</span>

	<span class="cm">/* qos null data frames are excluded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">dont_reorder</span><span class="p">;</span>

	<span class="cm">/* not part of a BA session */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack_policy</span> <span class="o">!=</span> <span class="n">IEEE80211_QOS_CTL_ACK_POLICY_BLOCKACK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ack_policy</span> <span class="o">!=</span> <span class="n">IEEE80211_QOS_CTL_ACK_POLICY_NORMAL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">dont_reorder</span><span class="p">;</span>

	<span class="cm">/* not actually part of this BA session */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">dont_reorder</span><span class="p">;</span>

	<span class="cm">/* new, potentially un-ordered, ampdu frame - process it */</span>

	<span class="cm">/* reset session timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* if this mpdu is fragmented - terminate rx aggregation session */</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">IEEE80211_SDATA_QUEUE_TYPE_FRAME</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * No locking needed -- we will only ever process one</span>
<span class="cm">	 * RX packet at a time, and thus own tid_agg_rx. All</span>
<span class="cm">	 * other code manipulating it needs to (and does) make</span>
<span class="cm">	 * sure that we cannot get to it any more before doing</span>
<span class="cm">	 * anything with it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_sta_manage_reorder_buf</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

 <span class="nl">dont_reorder:</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_skb_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Drop duplicate 802.11 retransmissions (IEEE 802.11 Chap. 9.2.9) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_has_retry</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_seq_ctrl</span><span class="p">[</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">seqno_idx</span><span class="p">]</span> <span class="o">==</span>
			     <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dot11FrameDuplicateCount</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">num_duplicates</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_seq_ctrl</span><span class="p">[</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">seqno_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_drop_short</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Drop disallowed frame classes based on STA auth/assoc state;</span>
<span class="cm">	 * IEEE 802.11, Chap 5.5.</span>
<span class="cm">	 *</span>
<span class="cm">	 * mac80211 filters only based on association state, i.e. it drops</span>
<span class="cm">	 * Class 3 frames from not associated stations. hostapd sends</span>
<span class="cm">	 * deauth/disassoc frames when needed. In addition, hostapd is</span>
<span class="cm">	 * responsible for filtering on both auth and assoc states.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ieee80211_rx_mesh_check</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		     <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
		     <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_WDS</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * accept port control frames from the AP even when it&#39;s not</span>
<span class="cm">		 * yet marked ASSOC to prevent a race where we don&#39;t set the</span>
<span class="cm">		 * assoc bit quickly enough before it sends the first frame</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ieee80211_is_data_present</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">ethertype</span><span class="p">;</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>

			<span class="n">payload</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
			<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">payload</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ethertype</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cfg80211_rx_spurious_frame</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
					       <span class="n">GFP_ATOMIC</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyidx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">ieee80211_rx_result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">sta_ptk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mmie_keyidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Key selection 101</span>
<span class="cm">	 *</span>
<span class="cm">	 * There are four types of keys:</span>
<span class="cm">	 *  - GTK (group keys)</span>
<span class="cm">	 *  - IGTK (group keys for management frames)</span>
<span class="cm">	 *  - PTK (pairwise keys)</span>
<span class="cm">	 *  - STK (station-to-station pairwise keys)</span>
<span class="cm">	 *</span>
<span class="cm">	 * When selecting a key, we have to distinguish between multicast</span>
<span class="cm">	 * (including broadcast) and unicast frames, the latter can only</span>
<span class="cm">	 * use PTKs and STKs while the former always use GTKs and IGTKs.</span>
<span class="cm">	 * Unless, of course, actual WEP keys (&quot;pre-RSNA&quot;) are used, then</span>
<span class="cm">	 * unicast frames can also use key indices like GTKs. Hence, if we</span>
<span class="cm">	 * don&#39;t have a PTK/STK we check the key index for a WEP key.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that in a regular BSS, multicast frames are sent by the</span>
<span class="cm">	 * AP only, associated stations unicast the frame to the AP first</span>
<span class="cm">	 * which then multicasts it on their behalf.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There is also a slight problem in IBSS mode: GTKs are negotiated</span>
<span class="cm">	 * with each station, that is something we don&#39;t currently handle.</span>
<span class="cm">	 * The spec seems to expect that one negotiates the same key with</span>
<span class="cm">	 * every station but there&#39;s no such requirement; VLANs could be</span>
<span class="cm">	 * possible.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * No point in finding a key and decrypting if the frame is neither</span>
<span class="cm">	 * addressed to us nor a multicast frame.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* start without a key */</span>
	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">sta_ptk</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ptk</span><span class="p">);</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">mmie_keyidx</span> <span class="o">=</span> <span class="n">ieee80211_get_mmie_keyidx</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sta_ptk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">sta_ptk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_IV_STRIPPED</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
		<span class="cm">/* Skip decryption if the frame is not protected. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmie_keyidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Broadcast/multicast robust management frame / BIP */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_IV_STRIPPED</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mmie_keyidx</span> <span class="o">&lt;</span> <span class="n">NUM_DEFAULT_KEYS</span> <span class="o">||</span>
		    <span class="n">mmie_keyidx</span> <span class="o">&gt;=</span> <span class="n">NUM_DEFAULT_KEYS</span> <span class="o">+</span> <span class="n">NUM_DEFAULT_MGMT_KEYS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span> <span class="cm">/* unexpected BIP keyidx */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">gtk</span><span class="p">[</span><span class="n">mmie_keyidx</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">mmie_keyidx</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The frame was not protected, so skip decryption. However, we</span>
<span class="cm">		 * need to set rx-&gt;key if there is a key that could have been</span>
<span class="cm">		 * used so that the frame may be dropped if encryption would</span>
<span class="cm">		 * have been expected.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">default_mgmt_key</span><span class="p">)))</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_DEFAULT_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">gtk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_DEFAULT_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
				<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">keyid</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The device doesn&#39;t give us the IV so we won&#39;t be</span>
<span class="cm">		 * able to look up the key. That&#39;s ok though, we</span>
<span class="cm">		 * don&#39;t need to decrypt the frame, we just won&#39;t</span>
<span class="cm">		 * be able to keep statistics accurate.</span>
<span class="cm">		 * Except for key threshold notifications, should</span>
<span class="cm">		 * we somehow allow the driver to tell us which key</span>
<span class="cm">		 * the hardware used if this flag is set?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_IV_STRIPPED</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

		<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span> <span class="cm">/* TODO: count this? */</span>

		<span class="cm">/*</span>
<span class="cm">		 * no need to call ieee80211_wep_get_keyidx,</span>
<span class="cm">		 * it verifies a bunch of things we&#39;ve done already</span>
<span class="cm">		 */</span>
		<span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keyid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">keyidx</span> <span class="o">=</span> <span class="n">keyid</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>

		<span class="cm">/* check per-station GTK first, if multicast packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">gtk</span><span class="p">[</span><span class="n">keyidx</span><span class="p">]);</span>

		<span class="cm">/* if not found, try default key */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">keyidx</span><span class="p">]);</span>

			<span class="cm">/*</span>
<span class="cm">			 * RSNA-protected unicast frames should always be</span>
<span class="cm">			 * sent with pairwise or station-to-station keys,</span>
<span class="cm">			 * but for WEP we allow using a key index as well.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
				<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KEY_FLAG_TAINTED</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">tx_rx_count</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* TODO: add threshold stuff again */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">ieee80211_crypto_wep_decrypt</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">ieee80211_crypto_tkip_decrypt</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">ieee80211_crypto_ccmp_decrypt</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">ieee80211_crypto_aes_cmac_decrypt</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can reach here only with HW-only algorithms</span>
<span class="cm">		 * but why didn&#39;t it decrypt the frame?!</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the hdr variable is invalid after the decrypt handlers */</span>

	<span class="cm">/* either the frame has been decrypted or will be dropped */</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_check_more_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pspolling</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_fromds</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="cm">/* this is not from AP */</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_moredata</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* AP has no more frames buffered for us */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">pspolling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* more data bit is set, let&#39;s request a new frame from the AP */</span>
	<span class="n">ieee80211_send_pspoll</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_sta_ps_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">num_sta_ps</span><span class="p">);</span>
	<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_STA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_AP_LINK_PS</span><span class="p">))</span>
		<span class="n">drv_sta_notify</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">STA_NOTIFY_SLEEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: STA %pM aid %d enters power save mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">aid</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAC80211_VERBOSE_PS_DEBUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_sta_ps_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: STA %pM aid %d exits power save mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">aid</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAC80211_VERBOSE_PS_DEBUG */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_DRIVER</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_PS_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: STA %pM aid %d driver-ps-blocked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">aid</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAC80211_VERBOSE_PS_DEBUG */</span><span class="cp"></span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_sta_ps_deliver_wakeup</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_sta_ps_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">bool</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta_inf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">in_ps</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta_inf</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_AP_LINK_PS</span><span class="p">));</span>

	<span class="cm">/* Don&#39;t let the same PS state be set twice */</span>
	<span class="n">in_ps</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta_inf</span><span class="p">,</span> <span class="n">WLAN_STA_PS_STA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">in_ps</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_ps</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span>
		<span class="n">ap_sta_ps_start</span><span class="p">(</span><span class="n">sta_inf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ap_sta_ps_end</span><span class="p">(</span><span class="n">sta_inf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_sta_ps_transition</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_uapsd_and_pspoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The device handles station powersave, so don&#39;t do anything about</span>
<span class="cm">	 * uAPSD and PS-Poll frames (the latter shouldn&#39;t even come up from</span>
<span class="cm">	 * it to mac80211 since they&#39;re handled.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_AP_LINK_PS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t do anything if the station isn&#39;t already asleep. In</span>
<span class="cm">	 * the uAPSD case, the station will probably be marked asleep,</span>
<span class="cm">	 * in the PS-Poll case the station must be confused ...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_STA</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_SP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_DRIVER</span><span class="p">))</span>
				<span class="n">ieee80211_sta_ps_deliver_poll_response</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PSPOLL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Free PS Poll skb here instead of returning RX_DROP that would</span>
<span class="cm">		 * count as an dropped frame. */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_DEFERRED_RELEASE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">ieee80211_has_pm</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ieee80211_is_qos_nullfunc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
		<span class="n">ac</span> <span class="o">=</span> <span class="n">ieee802_1d_to_ac</span><span class="p">[</span><span class="n">tid</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this AC is not trigger-enabled do nothing.</span>
<span class="cm">		 *</span>
<span class="cm">		 * NB: This could/should check a separate bitmap of trigger-</span>
<span class="cm">		 * enabled queues, but for now we only implement uAPSD w/o</span>
<span class="cm">		 * TSPEC changes to the ACs, so they&#39;re always the same.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">uapsd_queues</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">ac</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

		<span class="cm">/* if we are in a service period, do nothing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_SP</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_DRIVER</span><span class="p">))</span>
			<span class="n">ieee80211_sta_ps_deliver_uapsd</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_UAPSD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_sta_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update last_rx only for IBSS packets which are for the current</span>
<span class="cm">	 * BSSID to avoid keeping the current IBSS network alive in cases</span>
<span class="cm">	 * where other STAs start using different BSSID.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">ieee80211_get_bssid</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_idx</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">;</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_flag</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Mesh beacons will update last_rx when if they are found to</span>
<span class="cm">		 * match the current local configuration when processed.</span>
<span class="cm">		 */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_idx</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_flag</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="n">ieee80211_sta_rx_notify</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_fragments</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_NO_SIGNAL_VAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_signal</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>
		<span class="n">ewma_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">avg_signal</span><span class="p">,</span> <span class="o">-</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change STA power saving mode only at the end of a frame</span>
<span class="cm">	 * exchange sequence.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_AP_LINK_PS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_DEFERRED_RELEASE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	     <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_PS_STA</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Ignore doze-&gt;wake transitions that are</span>
<span class="cm">			 * indicated by non-data frames, the standard</span>
<span class="cm">			 * is unclear here, but for example going to</span>
<span class="cm">			 * PS mode and then scanning would cause a</span>
<span class="cm">			 * doze-&gt;wake transition for the probe request,</span>
<span class="cm">			 * and that is clearly undesirable.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">ieee80211_has_pm</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="n">ap_sta_ps_end</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_pm</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="n">ap_sta_ps_start</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drop (qos-)data::nullfunc frames silently, since they</span>
<span class="cm">	 * are used only to control station power saving mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_nullfunc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ieee80211_is_qos_nullfunc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_drop_nullfunc</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we receive a 4-addr nullfunc frame from a STA</span>
<span class="cm">		 * that was not moved to a 4-addr STA vlan yet send</span>
<span class="cm">		 * the event to userspace and for older hostapd drop</span>
<span class="cm">		 * the frame to the monitor interface.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
		      <span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_4ADDR_EVENT</span><span class="p">))</span>
				<span class="n">cfg80211_rx_unexpected_4addr_frame</span><span class="p">(</span>
					<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Update counter and free packet here to avoid</span>
<span class="cm">		 * counting this as a dropped packed.</span>
<span class="cm">		 */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ieee80211_rx_h_sta_process */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ieee80211_fragment_entry</span> <span class="o">*</span>
<span class="nf">ieee80211_reassemble_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_queue</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_fragment_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">fragment_next</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">fragment_next</span><span class="o">++</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">fragment_next</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_FRAGMENT_MAX</span><span class="p">)</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">fragment_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_DEBUG</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">.</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX reassembly removed oldest &quot;</span>
		       <span class="s">&quot;fragment entry (idx=%d age=%lu seq=%d last_frag=%d &quot;</span>
		       <span class="s">&quot;addr1=%pM addr2=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		       <span class="n">jiffies</span> <span class="o">-</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span>
		       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">,</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span> <span class="cm">/* no need for locking */</span>
	<span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">rx_queue</span> <span class="o">=</span> <span class="n">rx_queue</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ccmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">extra_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ieee80211_fragment_entry</span> <span class="o">*</span>
<span class="nf">ieee80211_reassemble_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">rx_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_fragment_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">fragment_next</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_FRAGMENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">f_hdr</span><span class="p">;</span>

		<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">IEEE80211_FRAGMENT_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">)</span> <span class="o">||</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">!=</span> <span class="n">seq</span> <span class="o">||</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rx_queue</span> <span class="o">!=</span> <span class="n">rx_queue</span> <span class="o">||</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">frag</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">f_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">.</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check ftype and addresses are equal, else check next fragment</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">^</span> <span class="n">f_hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">f_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">f_hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_defragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_fragment_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">||</span>
		   <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* not fragmented */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_fragments</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_linearize</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  skb_linearize() might change the skb-&gt;data and</span>
<span class="cm">	 *  previously cached variables (in this case, hdr) need to</span>
<span class="cm">	 *  be refreshed with the new data.</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the first fragment of a new frame. */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">ieee80211_reassemble_add</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span>
						 <span class="n">rx</span><span class="o">-&gt;</span><span class="n">seqno_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">security_idx</span><span class="p">;</span>
			<span class="cm">/* Store CCMP PN so that we can verify that the next</span>
<span class="cm">			 * fragment has a sequential PN value. */</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ccmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_pn</span><span class="p">,</span>
			       <span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ccmp</span><span class="p">.</span><span class="n">rx_pn</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span>
			       <span class="n">CCMP_PN_LEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is a fragment for a frame that should already be pending in</span>
<span class="cm">	 * fragment cache. Add this fragment to the end of the pending entry.</span>
<span class="cm">	 */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">ieee80211_reassemble_find</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span>
					  <span class="n">rx</span><span class="o">-&gt;</span><span class="n">seqno_idx</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_drop_defrag</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify that MPDUs within one MSDU have sequential PN values.</span>
<span class="cm">	 * (IEEE 802.11i, 8.3.3.4.5) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ccmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">pn</span><span class="p">[</span><span class="n">CCMP_PN_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">rpn</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">queue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">||</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_pn</span><span class="p">,</span> <span class="n">CCMP_PN_LEN</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CCMP_PN_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">security_idx</span><span class="p">;</span>
		<span class="n">rpn</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ccmp</span><span class="p">.</span><span class="n">rx_pn</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="n">rpn</span><span class="p">,</span> <span class="n">CCMP_PN_LEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_pn</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="n">CCMP_PN_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">));</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">extra_len</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">extra_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_expand_skb_head2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">extra_len</span><span class="p">,</span>
					      <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_drop_defrag</span><span class="p">);</span>
			<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Complete frame has been reassembled - process it now */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_FRAGMENTED</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dot11MulticastReceivedFrameCount</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ieee80211_led_rx</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_802_1x_port_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_drop_unencrypted</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pass through unencrypted frames if the hardware has</span>
<span class="cm">	 * decrypted them already.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Drop unencrypted frames if key is set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">ieee80211_is_nullfunc</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">||</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_drop_unencrypted_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pass through unencrypted frames if the hardware has</span>
<span class="cm">	 * decrypted them already.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_MFP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">ieee80211_is_unicast_robust_mgmt_frame</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_deauth</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
				<span class="n">cfg80211_send_unprot_deauth</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_disassoc</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
				<span class="n">cfg80211_send_unprot_disassoc</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							      <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							      <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* BIP does not use Protected field, so need to check MMIE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_multicast_robust_mgmt_frame</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">ieee80211_get_mmie_keyidx</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_deauth</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
				<span class="n">cfg80211_send_unprot_deauth</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_disassoc</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
				<span class="n">cfg80211_send_unprot_disassoc</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							      <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							      <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * When using MFP, Action frames are not allowed prior to</span>
<span class="cm">		 * having configured keys.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span>
			     <span class="n">ieee80211_is_robust_mgmt_frame</span><span class="p">(</span>
				     <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__ieee80211_data_to_8023</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">port_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">check_port_control</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ehdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">port_control</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">use_4addr</span> <span class="o">!=</span> <span class="o">!!</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">use_4addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">check_port_control</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_data_to_8023</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ehdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">==</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span><span class="p">)</span>
		<span class="o">*</span><span class="n">port_control</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_port_control</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * requires that rx-&gt;skb is a frame with ethernet header</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_frame_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pae_group_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
		<span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ehdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow EAPOL frames to us/the PAE group address regardless</span>
<span class="cm">	 * of whether the frame was encrypted or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">==</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">pae_group_addr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_802_1x_port_control</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ieee80211_drop_unencrypted</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * requires that rx-&gt;skb is a frame with ethernet header</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ieee80211_deliver_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">xmit_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ehdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">dsta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">xmit_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	     <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SDATA_DONT_BRIDGE_PACKETS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">||</span> <span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * send multicast frames both to higher layers in</span>
<span class="cm">			 * local net stack and back to the wireless medium</span>
<span class="cm">			 */</span>
			<span class="n">xmit_skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xmit_skb</span><span class="p">)</span>
				<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;%s: failed to clone multicast frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dsta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsta</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The destination station is associated to</span>
<span class="cm">				 * this AP (in this VLAN), so send the frame</span>
<span class="cm">				 * directly to it and do not pass it to local</span>
<span class="cm">				 * net stack.</span>
<span class="cm">				 */</span>
				<span class="n">xmit_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">align</span> <span class="n">__maybe_unused</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS</span>
		<span class="cm">/*</span>
<span class="cm">		 * &#39;align&#39; will only take the values 0 or 2 here</span>
<span class="cm">		 * since all frames are required to be aligned</span>
<span class="cm">		 * to 2-byte boundaries when being passed to</span>
<span class="cm">		 * mac80211. That also explains the __skb_push()</span>
<span class="cm">		 * below.</span>
<span class="cm">		 */</span>
		<span class="n">align</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">align</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-=</span> <span class="n">align</span><span class="p">;</span>
				<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">skb_set_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* deliver to local stack */</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
			<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xmit_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send to wireless media and increase priority by 256 to</span>
<span class="cm">		 * keep the received priority instead of reclassifying</span>
<span class="cm">		 * the frame (see cfg80211_classify8021d).</span>
<span class="cm">		 */</span>
		<span class="n">xmit_skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">xmit_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_3</span><span class="p">);</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">xmit_skb</span><span class="p">);</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">xmit_skb</span><span class="p">);</span>
		<span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">xmit_skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_amsdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">frame_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data_present</span><span class="p">(</span><span class="n">fc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_AMSDU</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	      <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	      <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">use_4addr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_linearize</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="n">ieee80211_amsdu_to_8023s</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame_list</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				 <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				 <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_frame_allowed</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">ieee80211_deliver_skb</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
<span class="k">static</span> <span class="n">ieee80211_rx_result</span>
<span class="nf">ieee80211_rx_h_mesh_fwding</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">fwd_hdr</span><span class="p">,</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211s_hdr</span> <span class="o">*</span><span class="n">mesh_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">fwd_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_MESH_PATH_NOFORWARD</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">q</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">mesh_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211s_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">);</span>

	<span class="cm">/* frame is in RMC, don&#39;t forward */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mesh_rmc_check</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">mesh_hdr</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mesh_hdr</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesh_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_FLAGS_AE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mppath</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">proxied_addr</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">mpp_addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mpp_addr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">;</span>
			<span class="n">proxied_addr</span> <span class="o">=</span> <span class="n">mesh_hdr</span><span class="o">-&gt;</span><span class="n">eaddr1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpp_addr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">;</span>
			<span class="n">proxied_addr</span> <span class="o">=</span> <span class="n">mesh_hdr</span><span class="o">-&gt;</span><span class="n">eaddr2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">mppath</span> <span class="o">=</span> <span class="n">mpp_path_lookup</span><span class="p">(</span><span class="n">proxied_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mppath</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpp_path_add</span><span class="p">(</span><span class="n">proxied_addr</span><span class="p">,</span> <span class="n">mpp_addr</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mppath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mppath</span><span class="o">-&gt;</span><span class="n">mpp</span><span class="p">,</span> <span class="n">mpp_addr</span><span class="p">))</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">mppath</span><span class="o">-&gt;</span><span class="n">mpp</span><span class="p">,</span> <span class="n">mpp_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mppath</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Frame has reached destination.  Don&#39;t forward */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">ieee80211_select_queue_80211</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_queue_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_IFSTA_MESH_CTR_INC</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span> <span class="n">dropped_frames_congestion</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">mesh_hdr</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IEEE80211_IFSTA_MESH_CTR_INC</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span> <span class="n">dropped_frames_ttl</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">dot11MeshForwarding</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fwd_skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fwd_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;%s: failed to clone mesh frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fwd_hdr</span> <span class="o">=</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">fwd_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">fwd_skb</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_NEED_TXPROCESSING</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">fwd_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_IFSTA_MESH_CTR_INC</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span> <span class="n">fwded_mcast</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fwd_hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mesh_nexthop_lookup</span><span class="p">(</span><span class="n">fwd_skb</span><span class="p">,</span> <span class="n">sdata</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_IFSTA_MESH_CTR_INC</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span> <span class="n">fwded_unicast</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* unable to resolve next hop */</span>
		<span class="n">mesh_path_error_tx</span><span class="p">(</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">.</span><span class="n">element_ttl</span><span class="p">,</span> <span class="n">fwd_hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span>
				    <span class="mi">0</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">fwd_hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="n">IEEE80211_IFSTA_MESH_CTR_INC</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span> <span class="n">dropped_frames_no_route</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fwd_skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IEEE80211_IFSTA_MESH_CTR_INC</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span> <span class="n">fwded_frames</span><span class="p">);</span>
	<span class="n">ieee80211_add_pending_skb</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">fwd_skb</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">port_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data_present</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send unexpected-4addr-frame event to hostapd. For older versions,</span>
<span class="cm">	 * also drop the frame to cooked monitor interfaces.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_and_set_sta_flag</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_4ADDR_EVENT</span><span class="p">))</span>
			<span class="n">cfg80211_rx_unexpected_4addr_frame</span><span class="p">(</span>
				<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__ieee80211_data_to_8023</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_frame_allowed</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">unlikely</span><span class="p">(</span><span class="n">port_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span><span class="p">,</span>
				     <span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ps_sdata</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">dynamic_ps_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span>
		    <span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDATA_STATE_OFFCHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dynamic_ps_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">dynamic_ps_timeout</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ieee80211_deliver_skb</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_bar</span> <span class="o">*</span><span class="n">bar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_bar</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tid_ampdu_rx</span> <span class="o">*</span><span class="n">tid_agg_rx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">start_seq_num</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">bar</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">bar</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le16</span> <span class="n">control</span><span class="p">,</span> <span class="n">start_seq_num</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">bar_data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_bar</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span>
				  <span class="o">&amp;</span><span class="n">bar_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bar_data</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

		<span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bar_data</span><span class="p">.</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>

		<span class="n">tid_agg_rx</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_rx</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid_agg_rx</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

		<span class="n">start_seq_num</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bar_data</span><span class="p">.</span><span class="n">start_seq_num</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* reset session timer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">session_timer</span><span class="p">,</span>
				  <span class="n">TU_TO_EXP_TIME</span><span class="p">(</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">));</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>
		<span class="cm">/* release stored frames up to start of BAR */</span>
		<span class="n">ieee80211_release_reorder_frames</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">,</span> <span class="n">start_seq_num</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * After this point, we only want management frames,</span>
<span class="cm">	 * so we can drop all remaining control frames to</span>
<span class="cm">	 * cooked monitor interfaces.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_process_sa_query_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span>
					   <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not to own unicast address */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not from the current AP or not associated yet. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sa_query</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too short SA Query request frame */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					  <span class="n">IEEE80211_STYPE_ACTION</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sa_query</span><span class="p">));</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_SA_QUERY</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sa_query</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">WLAN_ACTION_SA_QUERY_RESPONSE</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sa_query</span><span class="p">.</span><span class="n">trans_id</span><span class="p">,</span>
	       <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sa_query</span><span class="p">.</span><span class="n">trans_id</span><span class="p">,</span>
	       <span class="n">WLAN_SA_QUERY_TR_ID_LEN</span><span class="p">);</span>

	<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_mgmt_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * From here on, look only at management frames.</span>
<span class="cm">	 * Data and control frames are already handled,</span>
<span class="cm">	 * and unknown (reserved) frames are useless.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_BEACON_REPORTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span><span class="p">)</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>

		<span class="n">cfg80211_report_obss_beacon</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span>
					    <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					    <span class="n">status</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_BEACON_REPORTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_drop_unencrypted_mgmt</span><span class="p">(</span><span class="n">rx</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* drop too small frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MIN_ACTION_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">!=</span> <span class="n">WLAN_CATEGORY_PUBLIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CATEGORY_HT</span>:
		<span class="cm">/* reject HT action frames from stations not supporting HT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* verify action &amp; smps_control are present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ht_smps</span><span class="p">.</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_HT_ACTION_SMPS</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">smps</span><span class="p">;</span>

			<span class="cm">/* convert to HT capability */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ht_smps</span><span class="p">.</span><span class="n">smps_control</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WLAN_HT_SMPS_CONTROL_DISABLED</span>:
				<span class="n">smps</span> <span class="o">=</span> <span class="n">WLAN_HT_CAP_SM_PS_DISABLED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WLAN_HT_SMPS_CONTROL_STATIC</span>:
				<span class="n">smps</span> <span class="o">=</span> <span class="n">WLAN_HT_CAP_SM_PS_STATIC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WLAN_HT_SMPS_CONTROL_DYNAMIC</span>:
				<span class="n">smps</span> <span class="o">=</span> <span class="n">WLAN_HT_CAP_SM_PS_DYNAMIC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">smps</span> <span class="o">&lt;&lt;=</span> <span class="n">IEEE80211_HT_CAP_SM_PS_SHIFT</span><span class="p">;</span>

			<span class="cm">/* if no change do nothing */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span>
					<span class="n">IEEE80211_HT_CAP_SM_PS</span><span class="p">)</span> <span class="o">==</span> <span class="n">smps</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>

			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_HT_CAP_SM_PS</span><span class="p">;</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">smps</span><span class="p">;</span>

			<span class="n">sband</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

			<span class="n">rate_control_rate_update</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sband</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span>
						 <span class="n">IEEE80211_RC_SMPS_CHANGED</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CATEGORY_BACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* verify action_code is present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">addba_req</span><span class="p">.</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_ACTION_ADDBA_REQ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">addba_req</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_ACTION_ADDBA_RESP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">addba_resp</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_ACTION_DELBA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delba</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CATEGORY_SPECTRUM_MGMT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">!=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* verify action_code is present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">measurement</span><span class="p">.</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_ACTION_SPCT_MSR_REQ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">measurement</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ieee80211_process_measurement_req</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_ACTION_SPCT_CHL_SWITCH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">chan_switch</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">queue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CATEGORY_SA_QUERY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IEEE80211_MIN_ACTION_SIZE</span> <span class="o">+</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sa_query</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sa_query</span><span class="p">.</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_ACTION_SA_QUERY_REQUEST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ieee80211_process_sa_query_req</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CATEGORY_SELF_PROTECTED</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">self_prot</span><span class="p">.</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_SP_MESH_PEERING_OPEN</span>:
		<span class="k">case</span> <span class="n">WLAN_SP_MESH_PEERING_CLOSE</span>:
		<span class="k">case</span> <span class="n">WLAN_SP_MESH_PEERING_CONFIRM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">security</span> <span class="o">!=</span> <span class="n">IEEE80211_MESH_SEC_NONE</span><span class="p">)</span>
				<span class="cm">/* userspace handles this frame */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">queue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_SP_MGK_INFORM</span>:
		<span class="k">case</span> <span class="n">WLAN_SP_MGK_ACK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CATEGORY_MESH_ACTION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mesh_action_is_path_sel</span><span class="p">(</span><span class="n">mgmt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="o">!</span><span class="n">mesh_path_sel_is_hwmp</span><span class="p">(</span><span class="n">sdata</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">queue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

 <span class="nl">invalid:</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_MALFORMED_ACTION_FRM</span><span class="p">;</span>
	<span class="cm">/* will return in the next handlers */</span>
	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

 <span class="nl">handled:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>

 <span class="nl">queue:</span>
	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">IEEE80211_SDATA_QUEUE_TYPE_FRAME</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_userspace_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* skip known-bad action frames and return them in the next handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_MALFORMED_ACTION_FRM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Getting here means the kernel doesn&#39;t know how to handle</span>
<span class="cm">	 * it, but maybe userspace does ... include returned frames</span>
<span class="cm">	 * so userspace can register for those to know whether ones</span>
<span class="cm">	 * it transmitted were processed or returned.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span><span class="p">)</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg80211_rx_mgmt</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span>
			     <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			     <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_action_return</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_CONTINUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For AP mode, hostapd is responsible for handling any action</span>
<span class="cm">	 * frames that we didn&#39;t handle, including returning unknown</span>
<span class="cm">	 * ones. For all other modes we will return them to the sender,</span>
<span class="cm">	 * setting the 0x80 bit in the action category, as required by</span>
<span class="cm">	 * 802.11-2012 9.24.4.</span>
<span class="cm">	 * Newer versions of hostapd shall also use the management frame</span>
<span class="cm">	 * registration mechanisms, but older ones still use cooked</span>
<span class="cm">	 * monitor interfaces so push all frames there.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_MALFORMED_ACTION_FRM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	     <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="cm">/* do not return rejected action frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_DROP_UNUSABLE</span><span class="p">;</span>

	<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_copy_expand</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">nmgmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">nskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">nmgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nmgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">nmgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nmgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">nskb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nskb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>

		<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee80211_rx_result</span> <span class="n">debug_noinline</span>
<span class="nf">ieee80211_rx_h_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">stype</span><span class="p">;</span>

	<span class="n">stype</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_STYPE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_AUTH</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">)</span>:
		<span class="cm">/* process for all: mesh, mlme, ibss */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ASSOC_RESP</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_REASSOC_RESP</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_DEAUTH</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_DISASSOC</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

		<span class="cm">/* process only for station */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_REQ</span><span class="p">)</span>:
		<span class="cm">/* process only for ibss */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* queue up frame and kick off work to process it */</span>
	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">IEEE80211_SDATA_QUEUE_TYPE_FRAME</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">RX_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: use IEEE80211_RX_FRAGMENTED */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_rx_cooked_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">prev_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">needed_headroom</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If cooked monitor has been processed already, then</span>
<span class="cm">	 * don&#39;t do it again. If not, set the flag.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_CMNTR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_skb</span><span class="p">;</span>
	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_CMNTR</span><span class="p">;</span>

	<span class="cm">/* If there are no cooked monitor interfaces, just free the SKB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cooked_mntrs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_skb</span><span class="p">;</span>

	<span class="cm">/* room for the radiotap header based on driver features */</span>
	<span class="n">needed_headroom</span> <span class="o">=</span> <span class="n">ieee80211_rx_radiotap_len</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">needed_headroom</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">needed_headroom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_skb</span><span class="p">;</span>

	<span class="cm">/* prepend radiotap information */</span>
	<span class="n">ieee80211_add_rx_radiotap_header</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">needed_headroom</span><span class="p">,</span>
					 <span class="nb">false</span><span class="p">);</span>

	<span class="n">skb_set_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mntr_flags</span> <span class="o">&amp;</span> <span class="n">MONITOR_FLAG_COOK_FRAMES</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb2</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">prev_dev</span><span class="p">;</span>
				<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">prev_dev</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">prev_dev</span><span class="p">;</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out_free_skb:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_rx_handlers_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span>
					 <span class="n">ieee80211_rx_result</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RX_DROP_MONITOR</span>:
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_drop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">RX_CONTINUE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">((</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">));</span>

		<span class="n">sband</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">))</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">];</span>

		<span class="n">ieee80211_rx_cooked_monitor</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RX_DROP_UNUSABLE</span>:
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_drop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_QUEUED</span>:
		<span class="n">I802_DEBUG_INC</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_handlers_queued</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_rx_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_rx_result</span> <span class="n">res</span> <span class="o">=</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

<span class="cp">#define CALL_RXH(rxh)			\</span>
<span class="cp">	do {				\</span>
<span class="cp">		res = rxh(rx);		\</span>
<span class="cp">		if (res != RX_CONTINUE)	\</span>
<span class="cp">			goto rxh_next;  \</span>
<span class="cp">	} while (0);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_skb_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">running_rx_handler</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">running_rx_handler</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_skb_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_skb_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * all the other fields are valid across frames</span>
<span class="cm">		 * that belong to an aMPDU since they are on the</span>
<span class="cm">		 * same TID from the same station</span>
<span class="cm">		 */</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_decrypt</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_check_more_data</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_uapsd_and_pspoll</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_sta_process</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_defragment</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_michael_mic_verify</span><span class="p">)</span>
		<span class="cm">/* must be after MMIC verify so header is counted in MPDU mic */</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
			<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_mesh_fwding</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_amsdu</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_data</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_ctrl</span><span class="p">);</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_mgmt_check</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_action</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_userspace_mgmt</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_action_return</span><span class="p">)</span>
		<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_mgmt</span><span class="p">)</span>

 <span class="nl">rxh_next:</span>
		<span class="n">ieee80211_rx_handlers_result</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_skb_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#undef CALL_RXH</span>
	<span class="p">}</span>

	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">running_rx_handler</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

 <span class="nl">unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_skb_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_invoke_rx_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_rx_result</span> <span class="n">res</span> <span class="o">=</span> <span class="n">RX_DROP_MONITOR</span><span class="p">;</span>

<span class="cp">#define CALL_RXH(rxh)			\</span>
<span class="cp">	do {				\</span>
<span class="cp">		res = rxh(rx);		\</span>
<span class="cp">		if (res != RX_CONTINUE)	\</span>
<span class="cp">			goto rxh_next;  \</span>
<span class="cp">	} while (0);</span>

	<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_passive_scan</span><span class="p">)</span>
	<span class="n">CALL_RXH</span><span class="p">(</span><span class="n">ieee80211_rx_h_check</span><span class="p">)</span>

	<span class="n">ieee80211_rx_reorder_ampdu</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>

	<span class="n">ieee80211_rx_handlers</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">rxh_next:</span>
	<span class="n">ieee80211_rx_handlers_result</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

<span class="cp">#undef CALL_RXH</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function makes calls into the RX path, therefore</span>
<span class="cm"> * it has to be invoked under RCU read lock.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ieee80211_release_reorder_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="n">rx</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span>
		<span class="p">.</span><span class="n">local</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span>
		<span class="cm">/* This is OK -- must be QoS data frame */</span>
		<span class="p">.</span><span class="n">security_idx</span> <span class="o">=</span> <span class="n">tid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">seqno_idx</span> <span class="o">=</span> <span class="n">tid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">tid_ampdu_rx</span> <span class="o">*</span><span class="n">tid_agg_rx</span><span class="p">;</span>

	<span class="n">tid_agg_rx</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_rx</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid_agg_rx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>
	<span class="n">ieee80211_sta_reorder_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid_agg_rx</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_agg_rx</span><span class="o">-&gt;</span><span class="n">reorder_lock</span><span class="p">);</span>

	<span class="n">ieee80211_rx_handlers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* main receive path */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prepare_for_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">ieee80211_get_bssid</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">multicast</span> <span class="o">=</span> <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bssid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">use_4addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">multicast</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">use_4addr</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bssid</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_bssid_match</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_IN_SCAN</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">multicast</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rate_idx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">)</span>
				<span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO: HT rates */</span>
			<span class="k">else</span>
				<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">;</span>
			<span class="n">ieee80211_ibss_rx_no_sta</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
						 <span class="n">BIT</span><span class="p">(</span><span class="n">rate_idx</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">multicast</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bssid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_bssid_match</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span>
					<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Accept public action frames even when the</span>
<span class="cm">			 * BSSID doesn&#39;t match, this is used for P2P</span>
<span class="cm">			 * and location updates. Note that mac80211</span>
<span class="cm">			 * itself never looks at these frames.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_IN_SCAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ieee80211_is_public_action</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RX_IN_SCAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span> <span class="o">||</span> <span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wds</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* should never get here */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function returns whether or not the SKB</span>
<span class="cm"> * was destined for RX processing or not, which,</span>
<span class="cm"> * if consume is true, is equivalent to whether</span>
<span class="cm"> * or not the skb was consumed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_prepare_and_rx_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">consume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prepares</span><span class="p">;</span>

	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_RA_MATCH</span><span class="p">;</span>
	<span class="n">prepares</span> <span class="o">=</span> <span class="n">prepare_for_handlers</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prepares</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">consume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="s">&quot;failed to copy skb for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_invoke_rx_handlers</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the actual Rx frames handler. as it blongs to Rx path it must</span>
<span class="cm"> * be called with rcu_read_lock protection.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ieee80211_rx_handle_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_data</span> <span class="n">rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">));</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">local</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span> <span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">dot11ReceivedFragmentCount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_HW_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_ONCHANNEL_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">test_bit</span><span class="p">(</span><span class="n">SCAN_SW_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)))</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RX_IN_SCAN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">skb_linearize</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ieee80211_parse_qos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">);</span>
	<span class="n">ieee80211_verify_alignment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prev_sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">for_each_sta_info</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_sta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prev_sta</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rx</span><span class="p">.</span><span class="n">sta</span> <span class="o">=</span> <span class="n">prev_sta</span><span class="p">;</span>
			<span class="n">rx</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">prev_sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
			<span class="n">ieee80211_prepare_and_rx_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

			<span class="n">prev_sta</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx</span><span class="p">.</span><span class="n">sta</span> <span class="o">=</span> <span class="n">prev_sta</span><span class="p">;</span>
			<span class="n">rx</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">prev_sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_prepare_and_rx_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">||</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * frame is destined for this interface, but if it&#39;s</span>
<span class="cm">		 * not also for the previous one we handle that after</span>
<span class="cm">		 * the loop to avoid copying the SKB once too much</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rx</span><span class="p">.</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="n">rx</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="n">ieee80211_prepare_and_rx_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">prev</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx</span><span class="p">.</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="n">rx</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_prepare_and_rx_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the receive path handler. It is called by a low level driver when an</span>
<span class="cm"> * 802.11 MPDU is received from the hardware.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ieee80211_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">softirq_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re suspending, it is possible although not too likely</span>
<span class="cm">	 * that we&#39;d be receiving frames after having already partially</span>
<span class="cm">	 * quiesced the stack. We can&#39;t process such frames then since</span>
<span class="cm">	 * that might, for example, cause stations to be added or other</span>
<span class="cm">	 * driver callbacks be invoked.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">quiescing</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The same happens when we&#39;re not even started,</span>
<span class="cm">	 * but that&#39;s worth a warning.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_FAILED_PLCP_CRC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Validate the rate, unless a PLCP error means that</span>
<span class="cm">		 * we probably can&#39;t have a valid rate here anyway.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rate_idx is MCS index, which can be [0-76]</span>
<span class="cm">			 * as documented on:</span>
<span class="cm">			 *</span>
<span class="cm">			 * http://wireless.kernel.org/en/developers/Documentation/ieee80211/802.11n</span>
<span class="cm">			 *</span>
<span class="cm">			 * Anything else would be some sort of driver or</span>
<span class="cm">			 * hardware error. The driver should catch hardware</span>
<span class="cm">			 * errors.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">((</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				 <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&gt;</span> <span class="mi">76</span><span class="p">),</span>
				 <span class="s">&quot;Rate marked as an HT rate but passed &quot;</span>
				 <span class="s">&quot;status-&gt;rate_idx is not &quot;</span>
				 <span class="s">&quot;an MCS index [0-76]: %d (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">,</span>
				 <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&gt;=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * key references and virtual interfaces are protected using RCU</span>
<span class="cm">	 * and this requires that we are in a read-side RCU section during</span>
<span class="cm">	 * receive processing</span>
<span class="cm">	 */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Frames with failed FCS/PLCP checksum are not returned,</span>
<span class="cm">	 * all other frames are returned without radiotap header</span>
<span class="cm">	 * if it was previously present.</span>
<span class="cm">	 * Also, frames with less than 16 bytes are dropped.</span>
<span class="cm">	 */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_rx_monitor</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_tpt_led_trig_rx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">__ieee80211_rx_handle_packet</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span><span class="p">;</span>
 <span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_rx</span><span class="p">);</span>

<span class="cm">/* This is a version of the rx handler that can be called from hard irq</span>
<span class="cm"> * context. Post the skb on the queue and schedule the tasklet */</span>
<span class="kt">void</span> <span class="nf">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_status</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">IEEE80211_RX_MSG</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_rx_irqsafe</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
