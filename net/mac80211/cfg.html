<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › cfg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cfg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * mac80211 configuration hooks for cfg80211</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006-2010	Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is GPLv2 as found in COPYING.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/nl80211.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &quot;ieee80211_i.h&quot;</span>
<span class="cp">#include &quot;driver-ops.h&quot;</span>
<span class="cp">#include &quot;cfg.h&quot;</span>
<span class="cp">#include &quot;rate.h&quot;</span>
<span class="cp">#include &quot;mesh.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">ieee80211_add_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					      <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_if_add</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mntr_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_del_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_if_remove</span><span class="p">(</span><span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_change_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_if_change_type</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">params</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">use_4addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
		 <span class="n">params</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">use_4addr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">use_4addr</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">use_4addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Prohibit MONITOR_FLAG_COOK_FRAMES to be</span>
<span class="cm">			 * changed while the interface is up.</span>
<span class="cm">			 * Else we would need to add a lot of cruft</span>
<span class="cm">			 * to update everything:</span>
<span class="cm">			 *	cooked_mntrs, monitor and all fif_* counters</span>
<span class="cm">			 *	reconfigure hardware</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MONITOR_FLAG_COOK_FRAMES</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mntr_flags</span> <span class="o">&amp;</span> <span class="n">MONITOR_FLAG_COOK_FRAMES</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

			<span class="n">ieee80211_adjust_monitor_flags</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mntr_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">ieee80211_adjust_monitor_flags</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">ieee80211_configure_filter</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Because the interface is down, ieee80211_do_stop</span>
<span class="cm">			 * and ieee80211_do_open take care of &quot;everything&quot;</span>
<span class="cm">			 * mentioned in the comment above.</span>
<span class="cm">			 */</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mntr_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">flags</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_noack_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">noack_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">noack_map</span> <span class="o">=</span> <span class="n">noack_map</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_add_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>

	<span class="cm">/* reject WEP and TKIP keys if WEP failed to initialize */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wep_tx_tfm</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">ieee80211_key_alloc</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span>
				  <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span><span class="p">)</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
			<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee80211_key_free</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_key_link</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">ieee80211_key_free</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_del_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">key_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

		<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span><span class="p">)</span>
			<span class="n">key</span> <span class="o">=</span> <span class="n">key_mtx_dereference</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ptk</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">key</span> <span class="o">=</span> <span class="n">key_mtx_dereference</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">gtk</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">key_mtx_dereference</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__ieee80211_key_free</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">key_mtx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">seq</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">key_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pn64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iv32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">iv16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span><span class="p">)</span>
			<span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ptk</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key_idx</span> <span class="o">&lt;</span> <span class="n">NUM_DEFAULT_KEYS</span><span class="p">)</span>
			<span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">gtk</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">params</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">iv32</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">iv32</span><span class="p">;</span>
		<span class="n">iv16</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">iv16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KEY_FLAG_UPLOADED_TO_HARDWARE</span><span class="p">)</span>
			<span class="n">drv_get_tkip_seq</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span>
					 <span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">hw_key_idx</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">iv32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iv16</span><span class="p">);</span>

		<span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv32</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">pn64</span> <span class="o">=</span> <span class="n">atomic64_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ccmp</span><span class="p">.</span><span class="n">tx_pn</span><span class="p">);</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
		<span class="n">pn64</span> <span class="o">=</span> <span class="n">atomic64_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aes_cmac</span><span class="p">.</span><span class="n">tx_pn</span><span class="p">);</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn64</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">params</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">key</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">keylen</span><span class="p">;</span>

	<span class="n">callback</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_config_default_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">uni</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">multi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ieee80211_set_default_key</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">uni</span><span class="p">,</span> <span class="n">multi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_config_default_mgmt_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="n">key_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ieee80211_set_default_mgmt_key</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rate_idx_to_bitrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rate_info</span> <span class="o">*</span><span class="n">rate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RATE_INFO_FLAGS_MCS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bitrate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sta_set_rate_info_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">rate_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_MCS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_40_MHZ_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_SHORT_GI</span><span class="p">;</span>
	<span class="n">rate_idx_to_bitrate</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sta_set_sinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">uptime</span><span class="p">;</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_generation</span><span class="p">;</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">STATION_INFO_INACTIVE_TIME</span> <span class="o">|</span>
			<span class="n">STATION_INFO_RX_BYTES</span> <span class="o">|</span>
			<span class="n">STATION_INFO_TX_BYTES</span> <span class="o">|</span>
			<span class="n">STATION_INFO_RX_PACKETS</span> <span class="o">|</span>
			<span class="n">STATION_INFO_TX_PACKETS</span> <span class="o">|</span>
			<span class="n">STATION_INFO_TX_RETRIES</span> <span class="o">|</span>
			<span class="n">STATION_INFO_TX_FAILED</span> <span class="o">|</span>
			<span class="n">STATION_INFO_TX_BITRATE</span> <span class="o">|</span>
			<span class="n">STATION_INFO_RX_BITRATE</span> <span class="o">|</span>
			<span class="n">STATION_INFO_RX_DROP_MISC</span> <span class="o">|</span>
			<span class="n">STATION_INFO_BSS_PARAM</span> <span class="o">|</span>
			<span class="n">STATION_INFO_CONNECTED_TIME</span> <span class="o">|</span>
			<span class="n">STATION_INFO_STA_FLAGS</span> <span class="o">|</span>
			<span class="n">STATION_INFO_BEACON_LOSS_COUNT</span><span class="p">;</span>

	<span class="n">do_posix_clock_monotonic_gettime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uptime</span><span class="p">);</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">connected_time</span> <span class="o">=</span> <span class="n">uptime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_connected</span><span class="p">;</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">inactive_time</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">);</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_retries</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_retry_count</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_failed</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_retry_failed</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_dropped_misc</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">beacon_loss_count</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">beacon_loss_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SIGNAL_UNSPEC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_SIGNAL</span> <span class="o">|</span> <span class="n">STATION_INFO_SIGNAL_AVG</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_signal</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="o">-</span><span class="n">ewma_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">avg_signal</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sta_set_rate_info_tx</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_tx_rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">);</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rxrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">)</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rxrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_MCS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">)</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rxrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_40_MHZ_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">)</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rxrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_SHORT_GI</span><span class="p">;</span>
	<span class="n">rate_idx_to_bitrate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rxrate</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_LLID</span> <span class="o">|</span>
				 <span class="n">STATION_INFO_PLID</span> <span class="o">|</span>
				 <span class="n">STATION_INFO_PLINK_STATE</span><span class="p">;</span>

		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">llid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">llid</span><span class="p">);</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">plid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">plid</span><span class="p">);</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">plink_state</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">plink_state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TOFFSET_KNOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_T_OFFSET</span><span class="p">;</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">t_offset</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">t_offset</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_cts_prot</span><span class="p">)</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BSS_PARAM_FLAGS_CTS_PROT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">)</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BSS_PARAM_FLAGS_SHORT_PREAMBLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span><span class="p">)</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BSS_PARAM_FLAGS_SHORT_SLOT_TIME</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">ps_dtim_period</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">;</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">))</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">set</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_SHORT_PREAMBLE</span><span class="p">))</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">set</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_SHORT_PREAMBLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_WME</span><span class="p">))</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">set</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_MFP</span><span class="p">))</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">set</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTH</span><span class="p">))</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">set</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TDLS_PEER</span><span class="p">))</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">sta_flags</span><span class="p">.</span><span class="n">set</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ieee80211_gstrings_sta_stats</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;rx_packets&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bytes&quot;</span><span class="p">,</span> <span class="s">&quot;wep_weak_iv_count&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_duplicates&quot;</span><span class="p">,</span> <span class="s">&quot;rx_fragments&quot;</span><span class="p">,</span> <span class="s">&quot;rx_dropped&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_packets&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bytes&quot;</span><span class="p">,</span> <span class="s">&quot;tx_fragments&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_filtered&quot;</span><span class="p">,</span> <span class="s">&quot;tx_retry_failed&quot;</span><span class="p">,</span> <span class="s">&quot;tx_retries&quot;</span><span class="p">,</span>
	<span class="s">&quot;beacon_loss&quot;</span><span class="p">,</span> <span class="s">&quot;sta_state&quot;</span><span class="p">,</span> <span class="s">&quot;txrate&quot;</span><span class="p">,</span> <span class="s">&quot;rxrate&quot;</span><span class="p">,</span> <span class="s">&quot;signal&quot;</span><span class="p">,</span>
	<span class="s">&quot;channel&quot;</span><span class="p">,</span> <span class="s">&quot;noise&quot;</span><span class="p">,</span> <span class="s">&quot;ch_time&quot;</span><span class="p">,</span> <span class="s">&quot;ch_time_busy&quot;</span><span class="p">,</span>
	<span class="s">&quot;ch_time_ext_busy&quot;</span><span class="p">,</span> <span class="s">&quot;ch_time_rx&quot;</span><span class="p">,</span> <span class="s">&quot;ch_time_tx&quot;</span>
<span class="p">};</span>
<span class="cp">#define STA_STATS_LEN	ARRAY_SIZE(ieee80211_gstrings_sta_stats)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_et_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">+=</span> <span class="n">STA_STATS_LEN</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">+=</span> <span class="n">drv_get_et_sset_count</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">sset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_get_et_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">station_info</span> <span class="n">sinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">survey_info</span> <span class="n">survey</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
<span class="cp">#define STA_STATS_SURVEY_LEN 7</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">STA_STATS_LEN</span><span class="p">);</span>

<span class="cp">#define ADD_STA_STATS(sta)				\</span>
<span class="cp">	do {						\</span>
<span class="cp">		data[i++] += sta-&gt;rx_packets;		\</span>
<span class="cp">		data[i++] += sta-&gt;rx_bytes;		\</span>
<span class="cp">		data[i++] += sta-&gt;wep_weak_iv_count;	\</span>
<span class="cp">		data[i++] += sta-&gt;num_duplicates;	\</span>
<span class="cp">		data[i++] += sta-&gt;rx_fragments;		\</span>
<span class="cp">		data[i++] += sta-&gt;rx_dropped;		\</span>
<span class="cp">							\</span>
<span class="cp">		data[i++] += sta-&gt;tx_packets;		\</span>
<span class="cp">		data[i++] += sta-&gt;tx_bytes;		\</span>
<span class="cp">		data[i++] += sta-&gt;tx_fragments;		\</span>
<span class="cp">		data[i++] += sta-&gt;tx_filtered_count;	\</span>
<span class="cp">		data[i++] += sta-&gt;tx_retry_failed;	\</span>
<span class="cp">		data[i++] += sta-&gt;tx_retry_count;	\</span>
<span class="cp">		data[i++] += sta-&gt;beacon_loss_count;	\</span>
<span class="cp">	} while (0)</span>

	<span class="cm">/* For Managed stations, find the single station based on BSSID</span>
<span class="cm">	 * and use that.  For interface types, iterate through all available</span>
<span class="cm">	 * stations and add stats for any station that is assigned to this</span>
<span class="cm">	 * network device.</span>
<span class="cm">	 */</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">do_survey</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ADD_STA_STATS</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta_state</span><span class="p">;</span>

		<span class="n">sinfo</span><span class="p">.</span><span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta_set_sinfo</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_TX_BITRATE</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span> <span class="o">*</span>
				<span class="n">cfg80211_calculate_bitrate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sinfo</span><span class="p">.</span><span class="n">txrate</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_RX_BITRATE</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span> <span class="o">*</span>
				<span class="n">cfg80211_calculate_bitrate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sinfo</span><span class="p">.</span><span class="n">rxrate</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sinfo</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">STATION_INFO_SIGNAL_AVG</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">sinfo</span><span class="p">.</span><span class="n">signal_avg</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Make sure this station belongs to the proper dev */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ADD_STA_STATS</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">do_survey:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">STA_STATS_LEN</span> <span class="o">-</span> <span class="n">STA_STATS_SURVEY_LEN</span><span class="p">;</span>
	<span class="cm">/* Get survey stats for current channel */</span>
	<span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drv_get_survey</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">survey</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">channel</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">==</span>
		     <span class="n">survey</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">q</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">filled</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">survey</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey</span><span class="p">.</span><span class="n">channel_time</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_BUSY</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey</span><span class="p">.</span><span class="n">channel_time_busy</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_EXT_BUSY</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey</span><span class="p">.</span><span class="n">channel_time_ext_busy</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_RX</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey</span><span class="p">.</span><span class="n">channel_time_rx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_CHANNEL_TIME_TX</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey</span><span class="p">.</span><span class="n">channel_time_tx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">STA_STATS_LEN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">drv_get_et_stats</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">STA_STATS_LEN</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_get_et_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">sset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sz_sta_stats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz_sta_stats</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ieee80211_gstrings_sta_stats</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">ieee80211_gstrings_sta_stats</span><span class="p">,</span> <span class="n">sz_sta_stats</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drv_get_et_strings</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">sset</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">sz_sta_stats</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_dump_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_by_idx</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">sta_set_sinfo</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_dump_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drv_get_survey</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">survey</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta_set_sinfo</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_probe_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">resp_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span> <span class="o">||</span> <span class="o">!</span><span class="n">resp_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">);</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">resp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">resp_len</span><span class="p">),</span> <span class="n">resp</span><span class="p">,</span> <span class="n">resp_len</span><span class="p">);</span>

	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: use call_rcu() */</span>
		<span class="n">synchronize_rcu</span><span class="p">();</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_assign_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_beacon_data</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beacon_data</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_head_len</span><span class="p">,</span> <span class="n">new_tail_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon</span><span class="p">);</span>

	<span class="cm">/* Need to have a beacon head if we don&#39;t have one yet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">old</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* new or old head? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
		<span class="n">new_head_len</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">head_len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_head_len</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">head_len</span><span class="p">;</span>

	<span class="cm">/* new or old tail? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">||</span> <span class="o">!</span><span class="n">old</span><span class="p">)</span>
		<span class="cm">/* params-&gt;tail_len will be zero for !params-&gt;tail */</span>
		<span class="n">new_tail_len</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">tail_len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_tail_len</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">tail_len</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_head_len</span> <span class="o">+</span> <span class="n">new_tail_len</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* start filling the new info now */</span>

	<span class="cm">/*</span>
<span class="cm">	 * pointers go into the block we allocated,</span>
<span class="cm">	 * memory is | beacon_data | head | tail |</span>
<span class="cm">	 */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">new</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span> <span class="n">new_head_len</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">head_len</span> <span class="o">=</span> <span class="n">new_head_len</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">tail_len</span> <span class="o">=</span> <span class="n">new_tail_len</span><span class="p">;</span>

	<span class="cm">/* copy in head */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">new_head_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">new_head_len</span><span class="p">);</span>

	<span class="cm">/* copy in optional tail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">new_tail_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">new_tail_len</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_set_probe_resp</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">probe_resp</span><span class="p">,</span>
				       <span class="n">params</span><span class="o">-&gt;</span><span class="n">probe_resp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_AP_PROBE_RESP</span><span class="p">;</span>

	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">rcu_head</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_start_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cfg80211_ap_settings</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">beacon_data</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">vlan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">BSS_CHANGED_BEACON_INT</span> <span class="o">|</span>
		      <span class="n">BSS_CHANGED_BEACON_ENABLED</span> <span class="o">|</span>
		      <span class="n">BSS_CHANGED_BEACON</span> <span class="o">|</span>
		      <span class="n">BSS_CHANGED_SSID</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Apply control port protocol, this allows us to</span>
<span class="cm">	 * not encrypt dynamic WEP control frames.</span>
<span class="cm">	 */</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">control_port_ethertype</span><span class="p">;</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">control_port_no_encrypt</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">control_port_no_encrypt</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vlan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">vlans</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vlan</span><span class="o">-&gt;</span><span class="n">control_port_protocol</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">control_port_ethertype</span><span class="p">;</span>
		<span class="n">vlan</span><span class="o">-&gt;</span><span class="n">control_port_no_encrypt</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">control_port_no_encrypt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">;</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
		       <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">hidden_ssid</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hidden_ssid</span> <span class="o">!=</span> <span class="n">NL80211_HIDDEN_SSID_NOT_IN_USE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_assign_beacon</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">|=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vlan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">vlans</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">list</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">vlan</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_change_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_beacon_data</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beacon_data</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_assign_beacon</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_stop_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="o">*</span><span class="n">vlan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beacon_data</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vlan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">vlans</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">list</span><span class="p">)</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">vlan</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">rcu_head</span><span class="p">);</span>

	<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Layer 2 Update frame (802.2 Type 1 LLC XID Update response) */</span>
<span class="k">struct</span> <span class="n">iapp_layer2_update</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">da</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* broadcast */</span>
	<span class="n">u8</span> <span class="n">sa</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* STA addr */</span>
	<span class="n">__be16</span> <span class="n">len</span><span class="p">;</span>		<span class="cm">/* 6 */</span>
	<span class="n">u8</span> <span class="n">dsap</span><span class="p">;</span>		<span class="cm">/* 0 */</span>
	<span class="n">u8</span> <span class="n">ssap</span><span class="p">;</span>		<span class="cm">/* 0 */</span>
	<span class="n">u8</span> <span class="n">control</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">xid_info</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_send_layer2_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iapp_layer2_update</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Send Level 2 Update Frame to update forwarding tables in layer 2</span>
<span class="cm">	 * bridge devices */</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iapp_layer2_update</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">));</span>

	<span class="cm">/* 802.2 Type 1 Logical Link Control (LLC) Exchange Identifier (XID)</span>
<span class="cm">	 * Update response frame; IEEE Std 802.2-1998, 5.4.1.2.1 */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">ssap</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* NULL LSAP, CR Bit: Response */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mh">0xaf</span><span class="p">;</span>	<span class="cm">/* XID response lsb.1111F101.</span>
<span class="cm">				 * F=0 (no poll command; unsolicited frame) */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">xid_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>	<span class="cm">/* XID format identifier */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">xid_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* LLC types/classes: Type 1 LLC */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">xid_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* XID sender&#39;s receive window size (RW) */</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="n">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sta_apply_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">station_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_set</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In mesh mode, we can clear AUTHENTICATED flag but must</span>
<span class="cm">	 * also make ASSOCIATED follow appropriately for the driver</span>
<span class="cm">	 * API. See also below, after AUTHORIZED changes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* cfg80211 should not allow this in non-mesh modes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sta_info_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_AUTH</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sta_info_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_ASSOC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sta_info_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_AUTHORIZED</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sta_info_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_ASSOC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* cfg80211 should not allow this in non-mesh modes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHENTICATED</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_AUTH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sta_info_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_AUTH</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sta_info_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_NONE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_SHORT_PREAMBLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_SHORT_PREAMBLE</span><span class="p">))</span>
			<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_SHORT_PREAMBLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_SHORT_PREAMBLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_WME</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_WME</span><span class="p">);</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">wme</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_WME</span><span class="p">);</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">wme</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_MFP</span><span class="p">))</span>
			<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_MFP</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_MFP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_TDLS_PEER</span><span class="p">))</span>
			<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TDLS_PEER</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TDLS_PEER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_modify_mask</span> <span class="o">&amp;</span> <span class="n">STATION_PARAM_APPLY_UAPSD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">uapsd_queues</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">uapsd_queues</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">max_sp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">max_sp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * cfg80211 validates this (1-2007) and allows setting the AID</span>
<span class="cm">	 * only when creating a new station entry</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">aid</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: updating the following information is racy when this</span>
<span class="cm">	 *	  function is called from ieee80211_change_station().</span>
<span class="cm">	 *	  However, all this information should be static so</span>
<span class="cm">	 *	  maybe we should just reject attemps to change it.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">supported_rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span>
					<span class="n">rates</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">rates</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ht_capa</span><span class="p">)</span>
		<span class="n">ieee80211_ht_cap_ie_to_sta_ht_cap</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">sband</span><span class="p">,</span>
						  <span class="n">params</span><span class="o">-&gt;</span><span class="n">ht_capa</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_vif_is_mesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">security</span> <span class="o">&amp;</span> <span class="n">IEEE80211_MESH_SEC_SECURED</span><span class="p">)</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">plink_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">NL80211_PLINK_LISTEN</span>:
			<span class="k">case</span> <span class="n">NL80211_PLINK_ESTAB</span>:
			<span class="k">case</span> <span class="n">NL80211_PLINK_BLOCKED</span>:
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">plink_state</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">plink_state</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/*  nothing  */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">else</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">plink_action</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PLINK_ACTION_OPEN</span>:
				<span class="n">mesh_plink_open</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PLINK_ACTION_BLOCK</span>:
				<span class="n">mesh_plink_block</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_add_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">layer2_update</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_alloc</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sta_info_pre_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_AUTH</span><span class="p">);</span>
	<span class="n">sta_info_pre_move_state</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">IEEE80211_STA_ASSOC</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sta_apply_parameters</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_info_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * for TDLS, rate control should be initialized only when supported</span>
<span class="cm">	 * rates are known.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TDLS_PEER</span><span class="p">))</span>
		<span class="n">rate_control_rate_init</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="n">layer2_update</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">||</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sta_info_insert_rcu</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">layer2_update</span><span class="p">)</span>
		<span class="n">ieee80211_send_layer2_update</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_del_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sta_info_destroy_addr_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>

	<span class="n">sta_info_flush</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_change_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">station_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">vlansdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get_bss</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* in station mode, supported rates are only valid with TDLS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">params</span><span class="o">-&gt;</span><span class="n">supported_rates</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TDLS_PEER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">!=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">prev_4addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">new_4addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">vlansdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vlansdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vlansdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="o">-&gt;</span><span class="n">use_4addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vlansdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">vlansdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
			<span class="n">new_4addr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vlan</span><span class="p">.</span><span class="n">sta</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">prev_4addr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vlansdata</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_AUTHORIZED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">prev_4addr</span> <span class="o">!=</span> <span class="n">new_4addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_4addr</span><span class="p">)</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">num_mcast_sta</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">num_mcast_sta</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ieee80211_send_layer2_update</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sta_apply_parameters</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TDLS_PEER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">)</span>
		<span class="n">rate_control_rate_init</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">))</span>
		<span class="n">ieee80211_recalc_ps</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_add_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mesh_path_add</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mesh_path_fix_nexthop</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_del_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mesh_path_del</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>

	<span class="n">mesh_path_flush_by_iface</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_change_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mesh_path_fix_nexthop</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpath_set_pinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mpath_info</span> <span class="o">*</span><span class="n">pinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">next_hop_sta</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_hop_sta</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">next_hop</span><span class="p">,</span> <span class="n">next_hop_sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">next_hop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">mesh_paths_generation</span><span class="p">;</span>

	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">MPATH_INFO_FRAME_QLEN</span> <span class="o">|</span>
			<span class="n">MPATH_INFO_SN</span> <span class="o">|</span>
			<span class="n">MPATH_INFO_METRIC</span> <span class="o">|</span>
			<span class="n">MPATH_INFO_EXPTIME</span> <span class="o">|</span>
			<span class="n">MPATH_INFO_DISCOVERY_TIMEOUT</span> <span class="o">|</span>
			<span class="n">MPATH_INFO_DISCOVERY_RETRIES</span> <span class="o">|</span>
			<span class="n">MPATH_INFO_FLAGS</span><span class="p">;</span>

	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">frame_qlen</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">sn</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">;</span>
	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">metric</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">metric</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span><span class="p">))</span>
		<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">exptime</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">exp_time</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">discovery_timeout</span> <span class="o">=</span>
			<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_timeout</span><span class="p">);</span>
	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">discovery_retries</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">discovery_retries</span><span class="p">;</span>
	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_ACTIVE</span><span class="p">)</span>
		<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NL80211_MPATH_FLAG_ACTIVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">)</span>
		<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NL80211_MPATH_FLAG_RESOLVING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_SN_VALID</span><span class="p">)</span>
		<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NL80211_MPATH_FLAG_SN_VALID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_FIXED</span><span class="p">)</span>
		<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NL80211_MPATH_FLAG_FIXED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MESH_PATH_RESOLVING</span><span class="p">)</span>
		<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NL80211_MPATH_FLAG_RESOLVING</span><span class="p">;</span>

	<span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpath_info</span> <span class="o">*</span><span class="n">pinfo</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mpath_set_pinfo</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_dump_mpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_hop</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mpath_info</span> <span class="o">*</span><span class="n">pinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mesh_path</span> <span class="o">*</span><span class="n">mpath</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">mpath</span> <span class="o">=</span> <span class="n">mesh_path_lookup_by_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">mpath</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mpath_set_pinfo</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">next_hop</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_mesh_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mesh_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mesh_config</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">_chg_mesh_attr</span><span class="p">(</span><span class="k">enum</span> <span class="n">nl80211_meshconf_params</span> <span class="n">parm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">parm</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_mesh_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">mesh_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">new_ie</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">old_ie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">);</span>

	<span class="cm">/* allocate information elements */</span>
	<span class="n">new_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">old_ie</span> <span class="o">=</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_ie</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_ie</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">;</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">=</span> <span class="n">new_ie</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">old_ie</span><span class="p">);</span>

	<span class="cm">/* now copy the rest of the setup parameters */</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_id_len</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">mesh_id_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_id</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">mesh_id</span><span class="p">,</span> <span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_id_len</span><span class="p">);</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_sp_id</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">sync_method</span><span class="p">;</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_pp_id</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">path_sel_proto</span><span class="p">;</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mesh_pm_id</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">path_metric</span><span class="p">;</span>
	<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="n">IEEE80211_MESH_SEC_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">is_authenticated</span><span class="p">)</span>
		<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">|=</span> <span class="n">IEEE80211_MESH_SEC_AUTHED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">is_secure</span><span class="p">)</span>
		<span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">|=</span> <span class="n">IEEE80211_MESH_SEC_SECURED</span><span class="p">;</span>

	<span class="cm">/* mcast rate setting in Mesh Node */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">mcast_rate</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">mcast_rate</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">mcast_rate</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_update_mesh_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">mesh_config</span> <span class="o">*</span><span class="n">nconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mesh_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>

	<span class="cm">/* Set the config options which we are interested in setting */</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">mshcfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_RETRY_TIMEOUT</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshRetryTimeout</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshRetryTimeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_CONFIRM_TIMEOUT</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshConfirmTimeout</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshConfirmTimeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HOLDING_TIMEOUT</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHoldingTimeout</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHoldingTimeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_MAX_PEER_LINKS</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshMaxPeerLinks</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshMaxPeerLinks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_MAX_RETRIES</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshMaxRetries</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshMaxRetries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_TTL</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshTTL</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshTTL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_ELEMENT_TTL</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshTTL</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">element_ttl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_AUTO_OPEN_PLINKS</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">auto_open_plinks</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">auto_open_plinks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_SYNC_OFFSET_MAX_NEIGHBOR</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshNbrOffsetMaxNeighbor</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshNbrOffsetMaxNeighbor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HWMP_MAX_PREQ_RETRIES</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPmaxPREQretries</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPmaxPREQretries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_PATH_REFRESH_TIME</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">path_refresh_time</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">path_refresh_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_MIN_DISCOVERY_TIMEOUT</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">min_discovery_timeout</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">min_discovery_timeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HWMP_ACTIVE_PATH_TIMEOUT</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPactivePathTimeout</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPactivePathTimeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HWMP_PREQ_MIN_INTERVAL</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPpreqMinInterval</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPpreqMinInterval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HWMP_PERR_MIN_INTERVAL</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPperrMinInterval</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPperrMinInterval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HWMP_NET_DIAM_TRVS_TIME</span><span class="p">,</span>
			   <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPnetDiameterTraversalTime</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPnetDiameterTraversalTime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HWMP_ROOTMODE</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPRootMode</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPRootMode</span><span class="p">;</span>
		<span class="n">ieee80211_mesh_root_setup</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_GATE_ANNOUNCEMENTS</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* our current gate announcement implementation rides on root</span>
<span class="cm">		 * announcements, so require this ifmsh to also be a root node</span>
<span class="cm">		 * */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshGateAnnouncementProtocol</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPRootMode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPRootMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ieee80211_mesh_root_setup</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshGateAnnouncementProtocol</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshGateAnnouncementProtocol</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HWMP_RANN_INTERVAL</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPRannInterval</span> <span class="o">=</span>
			<span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshHWMPRannInterval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_FORWARDING</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dot11MeshForwarding</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">dot11MeshForwarding</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_RSSI_THRESHOLD</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* our RSSI threshold implementation is supported only for</span>
<span class="cm">		 * devices that report signal in dBm.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">rssi_threshold</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">rssi_threshold</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chg_mesh_attr</span><span class="p">(</span><span class="n">NL80211_MESHCONF_HT_OPMODE</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">ht_opmode</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">ht_opmode</span><span class="p">;</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">ht_operation_mode</span> <span class="o">=</span> <span class="n">nconf</span><span class="o">-&gt;</span><span class="n">ht_opmode</span><span class="p">;</span>
		<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">BSS_CHANGED_HT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_join_mesh</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">mesh_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">mesh_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_mesh</span> <span class="o">*</span><span class="n">ifmsh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mesh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifmsh</span><span class="o">-&gt;</span><span class="n">mshcfg</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mesh_config</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_mesh_setup</span><span class="p">(</span><span class="n">ifmsh</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ieee80211_start_mesh</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_leave_mesh</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ieee80211_stop_mesh</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_change_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bss_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">use_cts_prot</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_cts_prot</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">use_cts_prot</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_ERP_CTS_PROT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">use_short_slot_time</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">use_short_slot_time</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span> <span class="o">=</span>
			<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">basic_rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span>
					<span class="n">rates</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="n">rates</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ap_isolate</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ap_isolate</span><span class="p">)</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_SDATA_DONT_BRIDGE_PACKETS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_SDATA_DONT_BRIDGE_PACKETS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ht_opmode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">ht_operation_mode</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ht_opmode</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_HT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_txq_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_txq_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">conf_tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">queues</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">p</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cwmax</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cwmin</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setting tx queue params disables u-apsd because it&#39;s only</span>
<span class="cm">	 * called in master mode.</span>
<span class="cm">	 */</span>
	<span class="n">p</span><span class="p">.</span><span class="n">uapsd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">tx_conf</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_conf_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="s">&quot;failed to set TX queue parameters for AC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">params</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">old_oper</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">old_oper_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">old_vif_oper_type</span><span class="o">=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="p">)</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee80211_get_channel_mode</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_HOPPING</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_FIXED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span> <span class="o">!=</span> <span class="n">chan</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">_oper_channel_type</span> <span class="o">==</span> <span class="n">channel_type</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_UNDEFINED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="p">)</span>
		<span class="n">old_vif_oper_type</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">;</span>
	<span class="n">old_oper_type</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">_oper_channel_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_set_channel_type</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">old_oper</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="cm">/* Update driver if changes were actually made. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_oper</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">old_oper_type</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">_oper_channel_type</span><span class="p">))</span>
		<span class="n">ieee80211_hw_config</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span> <span class="o">&amp;&amp;</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">old_vif_oper_type</span> <span class="o">!=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">)</span>
		<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">BSS_CHANGED_HT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wowlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__ieee80211_suspend</span><span class="p">(</span><span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">wowlan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__ieee80211_resume</span><span class="p">(</span><span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ieee80211_suspend NULL</span>
<span class="cp">#define ieee80211_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee80211_vif_type_p2p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_scan</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: implement NoA while scanning in software,</span>
<span class="cm">		 * for now fall through to allow scanning only when</span>
<span class="cm">		 * beaconing hasn&#39;t been configured yet</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ieee80211_request_scan</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_sched_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cfg80211_sched_scan_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sched_scan_start</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ieee80211_request_sched_scan_start</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_sched_scan_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sched_scan_stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ieee80211_request_sched_scan_stop</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cfg80211_auth_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee80211_mgd_auth</span><span class="p">(</span><span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cfg80211_assoc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee80211_get_channel_mode</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_HOPPING</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_FIXED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_UNDEFINED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ieee80211_mgd_assoc</span><span class="p">(</span><span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_deauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_deauth_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee80211_mgd_deauth</span><span class="p">(</span><span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_disassoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cfg80211_disassoc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee80211_mgd_disassoc</span><span class="p">(</span><span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_join_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee80211_get_channel_mode</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_HOPPING</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_FIXED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">channel_fixed</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span> <span class="o">==</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHAN_MODE_UNDEFINED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ieee80211_ibss_join</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_leave_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ieee80211_ibss_leave</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_wiphy_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_FRAG_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drv_set_frag_threshold</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_COVERAGE_CLASS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drv_set_coverage_class</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">coverage_class</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RTS_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drv_set_rts_threshold</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RETRY_SHORT</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">short_frame_max_tx_count</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">retry_short</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RETRY_LONG</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">long_frame_max_tx_count</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">retry_long</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">WIPHY_PARAM_RETRY_SHORT</span> <span class="o">|</span> <span class="n">WIPHY_PARAM_RETRY_LONG</span><span class="p">))</span>
		<span class="n">ieee80211_hw_config</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">nl80211_tx_power_setting</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_AUTOMATIC</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">user_power_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_LIMITED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mbm</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">mbm</span> <span class="o">%</span> <span class="mi">100</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">user_power_level</span> <span class="o">=</span> <span class="n">MBM_TO_DBM</span><span class="p">(</span><span class="n">mbm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_FIXED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mbm</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">mbm</span> <span class="o">%</span> <span class="mi">100</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="cm">/* TODO: move to cfg80211 when it knows the channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MBM_TO_DBM</span><span class="p">(</span><span class="n">mbm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">max_power</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">user_power_level</span> <span class="o">=</span> <span class="n">MBM_TO_DBM</span><span class="p">(</span><span class="n">mbm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_hw_config</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">changes</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="o">*</span><span class="n">dbm</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">power_level</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_wds_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wds</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">drv_rfkill_poll</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NL80211_TESTMODE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_testmode_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_testmode_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_dump</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">testmode_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">__ieee80211_request_smps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="n">smps_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="n">old_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">old_req</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">req_smps</span><span class="p">;</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">req_smps</span> <span class="o">=</span> <span class="n">smps_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_req</span> <span class="o">==</span> <span class="n">smps_mode</span> <span class="o">&amp;&amp;</span>
	    <span class="n">smps_mode</span> <span class="o">!=</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If not associated, or current association is not an HT</span>
<span class="cm">	 * association, there&#39;s no need to send an action frame.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">associated</span> <span class="o">||</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iflist_mtx</span><span class="p">);</span>
		<span class="n">ieee80211_recalc_smps</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iflist_mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">associated</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smps_mode</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">powersave</span><span class="p">)</span>
			<span class="n">smps_mode</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">smps_mode</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send SM PS frame to AP */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_send_smps_action</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">smps_mode</span><span class="p">,</span>
					 <span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">req_smps</span> <span class="o">=</span> <span class="n">old_req</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_power_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">bool</span> <span class="n">enabled</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SUPPORTS_PS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">==</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">powersave</span> <span class="o">&amp;&amp;</span>
	    <span class="n">timeout</span> <span class="o">==</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dynamic_ps_forced_timeout</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">powersave</span> <span class="o">=</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dynamic_ps_forced_timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* no change, but if automatic follow powersave */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">__ieee80211_request_smps</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">req_smps</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_SUPPORTS_DYNAMIC_PS</span><span class="p">)</span>
		<span class="n">ieee80211_hw_config</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">);</span>

	<span class="n">ieee80211_recalc_ps</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_cqm_rssi_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">s32</span> <span class="n">rssi_thold</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rssi_hyst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rssi_thold</span> <span class="o">==</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rssi_hyst</span> <span class="o">==</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_hyst</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span> <span class="o">=</span> <span class="n">rssi_thold</span><span class="p">;</span>
	<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_hyst</span> <span class="o">=</span> <span class="n">rssi_hyst</span><span class="p">;</span>

	<span class="cm">/* tell the driver upon association, unless already associated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">associated</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_VIF_SUPPORTS_CQM_RSSI</span><span class="p">)</span>
		<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">BSS_CHANGED_CQM</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_bitrate_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">cfg80211_bitrate_mask</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_HAS_RATE_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv_set_bitrate_mask</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">rc_rateidx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">legacy</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">rc_rateidx_mcs_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mcs</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mcs</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_remain_on_channel_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">chantype</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">random_cookie</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_cookie</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/* must be nonzero */</span>
	<span class="n">random_cookie</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">random_cookie</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_cookie</span> <span class="o">=</span> <span class="n">random_cookie</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_channel_type</span> <span class="o">=</span> <span class="n">chantype</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_duration</span> <span class="o">=</span> <span class="n">duration</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drv_remain_on_channel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">chantype</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_remain_on_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">,</span>
				       <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">remain_on_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_remain_on_channel_hw</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						     <span class="n">chan</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">,</span>
						     <span class="n">duration</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_for_tx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ieee80211_wk_remain_on_channel</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">,</span>
					      <span class="n">duration</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_cancel_remain_on_channel_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
						 <span class="n">u64</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_cookie</span> <span class="o">!=</span> <span class="n">cookie</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drv_cancel_remain_on_channel</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ieee80211_recalc_idle</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_cancel_remain_on_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">u64</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cancel_remain_on_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_cancel_remain_on_channel_hw</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ieee80211_wk_cancel_remain_on_channel</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">work_done_result</span>
<span class="nf">ieee80211_offchan_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_work</span> <span class="o">*</span><span class="n">wk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use the data embedded in the work struct for reporting</span>
<span class="cm">	 * here so if the driver mangled the SKB before dropping</span>
<span class="cm">	 * it (which is the only way we really should get here)</span>
<span class="cm">	 * then we don&#39;t report mangled data.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If there was no wait time, then by the time we get here</span>
<span class="cm">	 * the driver will likely not have reported the status yet,</span>
<span class="cm">	 * so in that case userspace will have to deal with it.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wk</span><span class="o">-&gt;</span><span class="n">offchan_tx</span><span class="p">.</span><span class="n">wait</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wk</span><span class="o">-&gt;</span><span class="n">offchan_tx</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
		<span class="n">cfg80211_mgmt_tx_status</span><span class="p">(</span><span class="n">wk</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wk</span><span class="o">-&gt;</span><span class="n">offchan_tx</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span>
					<span class="n">wk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">wk</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">WORK_DONE_DESTROY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_mgmt_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">bool</span> <span class="n">offchan</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">channel_type_valid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_cck</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">dont_wait_for_ack</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_work</span> <span class="o">*</span><span class="n">wk</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_offchan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dont_wait_for_ack</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_TX_INTFL_NL80211_FRAME_TX</span> <span class="o">|</span>
			<span class="n">IEEE80211_TX_CTL_REQ_TX_STATUS</span><span class="p">;</span>

	<span class="cm">/* Check that we are on the requested channel for transmission */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tmp_channel</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chan</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="p">)</span>
		<span class="n">is_offchan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel_type_valid</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">channel_type</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tmp_channel_type</span> <span class="o">&amp;&amp;</span>
	     <span class="n">channel_type</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">_oper_channel_type</span><span class="p">))</span>
		<span class="n">is_offchan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: check channel type? */</span>
		<span class="n">is_offchan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_TX_OFFCHAN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_cck</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_NO_CCK_RATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_offchan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">offchan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">WLAN_CATEGORY_PUBLIC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_TX_OFFCHAN</span><span class="p">)</span>
		<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_queue</span> <span class="o">=</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">offchannel_tx_hw_queue</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_offchan</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">remain_on_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the duration is zero, then the driver</span>
<span class="cm">		 * wouldn&#39;t actually do anything. Set it to</span>
<span class="cm">		 * 100 for now.</span>
<span class="cm">		 *</span>
<span class="cm">		 * TODO: cancel the off-channel operation</span>
<span class="cm">		 *       when we get the SKB&#39;s TX status and</span>
<span class="cm">		 *       the wait time was zero before.</span>
<span class="cm">		 */</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
			<span class="n">duration</span> <span class="o">=</span> <span class="n">wait</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_remain_on_channel_hw</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						     <span class="n">channel_type</span><span class="p">,</span>
						     <span class="n">duration</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_for_tx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_duration</span> <span class="o">=</span> <span class="n">wait</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * queue up frame for transmission after</span>
<span class="cm">		 * ieee80211_ready_on_channel call</span>
<span class="cm">		 */</span>

		<span class="cm">/* modify cookie to prevent API mismatches */</span>
		<span class="o">*</span><span class="n">cookie</span> <span class="o">^=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_TX_OFFCHAN</span><span class="p">;</span>
		<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_queue</span> <span class="o">=</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">offchannel_tx_hw_queue</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_skb_for_status</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Can transmit right away if the channel was the</span>
<span class="cm">	 * right one and there&#39;s no wait involved... If a</span>
<span class="cm">	 * wait is involved, we might otherwise not be on</span>
<span class="cm">	 * the right channel for long enough!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_offchan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wait</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wk</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IEEE80211_WORK_OFFCHANNEL_TX</span><span class="p">;</span>
	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">=</span> <span class="n">channel_type</span><span class="p">;</span>
	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">;</span>
	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ieee80211_offchan_tx_done</span><span class="p">;</span>
	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">offchan_tx</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">offchan_tx</span><span class="p">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait</span><span class="p">;</span>
	<span class="n">wk</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ieee80211_add_work</span><span class="p">(</span><span class="n">wk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_mgmt_tx_cancel_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">u64</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_work</span> <span class="o">*</span><span class="n">wk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cancel_remain_on_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cookie</span> <span class="o">^=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_cancel_remain_on_channel_hw</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_skb</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_roc_skb_for_status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">wk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wk</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">!=</span> <span class="n">sdata</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IEEE80211_WORK_OFFCHANNEL_TX</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wk</span><span class="o">-&gt;</span><span class="n">offchan_tx</span><span class="p">.</span><span class="n">frame</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">wk</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">work_work</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_mgmt_frame_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">u16</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_PROBE_REQ</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">probe_req_reg</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">probe_req_reg</span><span class="o">--</span><span class="p">;</span>

	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reconfig_filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">drv_set_antenna</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">rx_ant</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_get_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drv_get_antenna</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">rx_ant</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drv_set_ringparam</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_max</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">drv_get_ringparam</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">tx_max</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rx_max</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_set_rekey_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cfg80211_gtk_rekey_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rekey_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">drv_set_rekey_data</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_tdls_add_ext_capab</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_EXT_CAPABILITY</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* len */</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EXT_CAPA5_TDLS_ENABLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">ieee80211_get_tdls_sta_capab</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">capab</span><span class="p">;</span>

	<span class="n">capab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">!=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">capab</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_2GHZ_SHORT_SLOT_INCAPABLE</span><span class="p">))</span>
		<span class="n">capab</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_2GHZ_SHORT_PREAMBLE_INCAPABLE</span><span class="p">))</span>
		<span class="n">capab</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">capab</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_tdls_add_link_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src_addr</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tdls_lnkie</span> <span class="o">*</span><span class="n">lnkid</span><span class="p">;</span>

	<span class="n">lnkid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tdls_lnkie</span><span class="p">));</span>

	<span class="n">lnkid</span><span class="o">-&gt;</span><span class="n">ie_type</span> <span class="o">=</span> <span class="n">WLAN_EID_LINK_ID</span><span class="p">;</span>
	<span class="n">lnkid</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tdls_lnkie</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">lnkid</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lnkid</span><span class="o">-&gt;</span><span class="n">init_sta</span><span class="p">,</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lnkid</span><span class="o">-&gt;</span><span class="n">resp_sta</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_prep_tdls_encap_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">action_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dialog_token</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">status_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_tdls_data</span> <span class="o">*</span><span class="n">tf</span><span class="p">;</span>

	<span class="n">tf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tdls_data</span><span class="p">,</span> <span class="n">u</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">ether_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_TDLS</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">payload_type</span> <span class="o">=</span> <span class="n">WLAN_TDLS_SNAP_RFTYPE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_REQUEST</span>:
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_TDLS</span><span class="p">;</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">action_code</span> <span class="o">=</span> <span class="n">WLAN_TDLS_SETUP_REQUEST</span><span class="p">;</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_req</span><span class="p">));</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_req</span><span class="p">.</span><span class="n">dialog_token</span> <span class="o">=</span> <span class="n">dialog_token</span><span class="p">;</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_req</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee80211_get_tdls_sta_capab</span><span class="p">(</span><span class="n">sdata</span><span class="p">));</span>

		<span class="n">ieee80211_add_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ieee80211_add_ext_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ieee80211_tdls_add_ext_capab</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_RESPONSE</span>:
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_TDLS</span><span class="p">;</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">action_code</span> <span class="o">=</span> <span class="n">WLAN_TDLS_SETUP_RESPONSE</span><span class="p">;</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_resp</span><span class="p">));</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_resp</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status_code</span><span class="p">);</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_resp</span><span class="p">.</span><span class="n">dialog_token</span> <span class="o">=</span> <span class="n">dialog_token</span><span class="p">;</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_resp</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee80211_get_tdls_sta_capab</span><span class="p">(</span><span class="n">sdata</span><span class="p">));</span>

		<span class="n">ieee80211_add_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ieee80211_add_ext_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ieee80211_tdls_add_ext_capab</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_CONFIRM</span>:
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_TDLS</span><span class="p">;</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">action_code</span> <span class="o">=</span> <span class="n">WLAN_TDLS_SETUP_CONFIRM</span><span class="p">;</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_cfm</span><span class="p">));</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_cfm</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status_code</span><span class="p">);</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup_cfm</span><span class="p">.</span><span class="n">dialog_token</span> <span class="o">=</span> <span class="n">dialog_token</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_TEARDOWN</span>:
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_TDLS</span><span class="p">;</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">action_code</span> <span class="o">=</span> <span class="n">WLAN_TDLS_TEARDOWN</span><span class="p">;</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">teardown</span><span class="p">));</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">teardown</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_DISCOVERY_REQUEST</span>:
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_TDLS</span><span class="p">;</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">action_code</span> <span class="o">=</span> <span class="n">WLAN_TDLS_DISCOVERY_REQUEST</span><span class="p">;</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">discover_req</span><span class="p">));</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">discover_req</span><span class="p">.</span><span class="n">dialog_token</span> <span class="o">=</span> <span class="n">dialog_token</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_prep_tdls_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">action_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dialog_token</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">status_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>

	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					  <span class="n">IEEE80211_STYPE_ACTION</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_PUB_ACTION_TDLS_DISCOVER_RES</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tdls_discover_resp</span><span class="p">));</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_PUBLIC</span><span class="p">;</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tdls_discover_resp</span><span class="p">.</span><span class="n">action_code</span> <span class="o">=</span>
			<span class="n">WLAN_PUB_ACTION_TDLS_DISCOVER_RES</span><span class="p">;</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tdls_discover_resp</span><span class="p">.</span><span class="n">dialog_token</span> <span class="o">=</span>
			<span class="n">dialog_token</span><span class="p">;</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tdls_discover_resp</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee80211_get_tdls_sta_capab</span><span class="p">(</span><span class="n">sdata</span><span class="p">));</span>

		<span class="n">ieee80211_add_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ieee80211_add_ext_srates_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ieee80211_tdls_add_ext_capab</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_tdls_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">action_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dialog_token</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">status_code</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">extra_ies</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">extra_ies_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">send_direct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="cm">/* make sure we are in managed mode, and associated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">associated</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_TDLS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TDLS mgmt action %d peer %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">action_code</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span>
			    <span class="n">max</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tdls_data</span><span class="p">))</span> <span class="o">+</span>
			    <span class="mi">50</span> <span class="o">+</span> <span class="cm">/* supported rates */</span>
			    <span class="mi">7</span> <span class="o">+</span> <span class="cm">/* ext capab */</span>
			    <span class="n">extra_ies_len</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tdls_lnkie</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_REQUEST</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_RESPONSE</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_CONFIRM</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_TEARDOWN</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_DISCOVERY_REQUEST</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_prep_tdls_encap_data</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span>
						     <span class="n">action_code</span><span class="p">,</span> <span class="n">dialog_token</span><span class="p">,</span>
						     <span class="n">status_code</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">send_direct</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_PUB_ACTION_TDLS_DISCOVER_RES</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_prep_tdls_direct</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">action_code</span><span class="p">,</span>
						 <span class="n">dialog_token</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span>
						 <span class="n">skb</span><span class="p">);</span>
		<span class="n">send_direct</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extra_ies_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">extra_ies_len</span><span class="p">),</span> <span class="n">extra_ies</span><span class="p">,</span> <span class="n">extra_ies_len</span><span class="p">);</span>

	<span class="cm">/* the TDLS link IE is always added last */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_REQUEST</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_CONFIRM</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_TEARDOWN</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_DISCOVERY_REQUEST</span>:
		<span class="cm">/* we are the initiator */</span>
		<span class="n">ieee80211_tdls_add_link_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span>
					   <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_RESPONSE</span>:
	<span class="k">case</span> <span class="n">WLAN_PUB_ACTION_TDLS_DISCOVER_RES</span>:
		<span class="cm">/* we are the responder */</span>
		<span class="n">ieee80211_tdls_add_link_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
					   <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_direct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * According to 802.11z: Setup req/resp are sent in AC_BK, otherwise</span>
<span class="cm">	 * we should default to AC_VI.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_REQUEST</span>:
	<span class="k">case</span> <span class="n">WLAN_TDLS_SETUP_RESPONSE</span>:
		<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IEEE80211_AC_BK</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IEEE80211_AC_VI</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable bottom halves when entering the Tx path */</span>
	<span class="n">local_bh_disable</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_subif_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">local_bh_enable</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_tdls_oper</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nl80211_tdls_operation</span> <span class="n">oper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC80211_VERBOSE_TDLS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TDLS oper %d peer %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oper</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">oper</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_TDLS_ENABLE_LINK</span>:
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">set_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_TDLS_PEER_AUTH</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_TDLS_DISABLE_LINK</span>:
		<span class="k">return</span> <span class="n">sta_info_destroy_addr</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">NL80211_TDLS_TEARDOWN</span>:
	<span class="k">case</span> <span class="n">NL80211_TDLS_SETUP</span>:
	<span class="k">case</span> <span class="n">NL80211_TDLS_DISCOVERY_REQ</span>:
		<span class="cm">/* We don&#39;t support in-driver setup/teardown/discovery */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_probe_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">IEEE80211_DEV_TO_SUB_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_qos_hdr</span> <span class="o">*</span><span class="n">nullfunc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nullfunc</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">qos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">sta_info_get</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qos</span> <span class="o">=</span> <span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_WME</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
				 <span class="n">IEEE80211_STYPE_QOS_NULLFUNC</span> <span class="o">|</span>
				 <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
				 <span class="n">IEEE80211_STYPE_NULLFUNC</span> <span class="o">|</span>
				 <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="n">nullfunc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_REQ_TX_STATUS</span> <span class="o">|</span>
		       <span class="n">IEEE80211_TX_INTFL_NL80211_FRAME_TX</span><span class="p">;</span>

	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IEEE80211_AC_VO</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="p">)</span>
		<span class="n">nullfunc</span><span class="o">-&gt;</span><span class="n">qos_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

	<span class="n">local_bh_disable</span><span class="p">();</span>
	<span class="n">ieee80211_xmit</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">local_bh_enable</span><span class="p">();</span>

	<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span>
<span class="nf">ieee80211_wiphy_get_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">_oper_channel_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">oper_channel</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ieee80211_set_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drv_set_wakeup</span><span class="p">(</span><span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">cfg80211_ops</span> <span class="n">mac80211_config_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">add_virtual_intf</span> <span class="o">=</span> <span class="n">ieee80211_add_iface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_virtual_intf</span> <span class="o">=</span> <span class="n">ieee80211_del_iface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_virtual_intf</span> <span class="o">=</span> <span class="n">ieee80211_change_iface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_key</span> <span class="o">=</span> <span class="n">ieee80211_add_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_key</span> <span class="o">=</span> <span class="n">ieee80211_del_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">ieee80211_get_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_key</span> <span class="o">=</span> <span class="n">ieee80211_config_default_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_mgmt_key</span> <span class="o">=</span> <span class="n">ieee80211_config_default_mgmt_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_ap</span> <span class="o">=</span> <span class="n">ieee80211_start_ap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_beacon</span> <span class="o">=</span> <span class="n">ieee80211_change_beacon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_ap</span> <span class="o">=</span> <span class="n">ieee80211_stop_ap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_station</span> <span class="o">=</span> <span class="n">ieee80211_add_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_station</span> <span class="o">=</span> <span class="n">ieee80211_del_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_station</span> <span class="o">=</span> <span class="n">ieee80211_change_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_station</span> <span class="o">=</span> <span class="n">ieee80211_get_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_station</span> <span class="o">=</span> <span class="n">ieee80211_dump_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_survey</span> <span class="o">=</span> <span class="n">ieee80211_dump_survey</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
	<span class="p">.</span><span class="n">add_mpath</span> <span class="o">=</span> <span class="n">ieee80211_add_mpath</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_mpath</span> <span class="o">=</span> <span class="n">ieee80211_del_mpath</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_mpath</span> <span class="o">=</span> <span class="n">ieee80211_change_mpath</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mpath</span> <span class="o">=</span> <span class="n">ieee80211_get_mpath</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_mpath</span> <span class="o">=</span> <span class="n">ieee80211_dump_mpath</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_mesh_config</span> <span class="o">=</span> <span class="n">ieee80211_update_mesh_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mesh_config</span> <span class="o">=</span> <span class="n">ieee80211_get_mesh_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">join_mesh</span> <span class="o">=</span> <span class="n">ieee80211_join_mesh</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_mesh</span> <span class="o">=</span> <span class="n">ieee80211_leave_mesh</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">change_bss</span> <span class="o">=</span> <span class="n">ieee80211_change_bss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_txq_params</span> <span class="o">=</span> <span class="n">ieee80211_set_txq_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channel</span> <span class="o">=</span> <span class="n">ieee80211_set_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ieee80211_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ieee80211_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">ieee80211_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sched_scan_start</span> <span class="o">=</span> <span class="n">ieee80211_sched_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sched_scan_stop</span> <span class="o">=</span> <span class="n">ieee80211_sched_scan_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">ieee80211_auth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">assoc</span> <span class="o">=</span> <span class="n">ieee80211_assoc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deauth</span> <span class="o">=</span> <span class="n">ieee80211_deauth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disassoc</span> <span class="o">=</span> <span class="n">ieee80211_disassoc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">join_ibss</span> <span class="o">=</span> <span class="n">ieee80211_join_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_ibss</span> <span class="o">=</span> <span class="n">ieee80211_leave_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wiphy_params</span> <span class="o">=</span> <span class="n">ieee80211_set_wiphy_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tx_power</span> <span class="o">=</span> <span class="n">ieee80211_set_tx_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tx_power</span> <span class="o">=</span> <span class="n">ieee80211_get_tx_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wds_peer</span> <span class="o">=</span> <span class="n">ieee80211_set_wds_peer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rfkill_poll</span> <span class="o">=</span> <span class="n">ieee80211_rfkill_poll</span><span class="p">,</span>
	<span class="n">CFG80211_TESTMODE_CMD</span><span class="p">(</span><span class="n">ieee80211_testmode_cmd</span><span class="p">)</span>
	<span class="n">CFG80211_TESTMODE_DUMP</span><span class="p">(</span><span class="n">ieee80211_testmode_dump</span><span class="p">)</span>
	<span class="p">.</span><span class="n">set_power_mgmt</span> <span class="o">=</span> <span class="n">ieee80211_set_power_mgmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bitrate_mask</span> <span class="o">=</span> <span class="n">ieee80211_set_bitrate_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remain_on_channel</span> <span class="o">=</span> <span class="n">ieee80211_remain_on_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel_remain_on_channel</span> <span class="o">=</span> <span class="n">ieee80211_cancel_remain_on_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mgmt_tx</span> <span class="o">=</span> <span class="n">ieee80211_mgmt_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mgmt_tx_cancel_wait</span> <span class="o">=</span> <span class="n">ieee80211_mgmt_tx_cancel_wait</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_cqm_rssi_config</span> <span class="o">=</span> <span class="n">ieee80211_set_cqm_rssi_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mgmt_frame_register</span> <span class="o">=</span> <span class="n">ieee80211_mgmt_frame_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_antenna</span> <span class="o">=</span> <span class="n">ieee80211_set_antenna</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_antenna</span> <span class="o">=</span> <span class="n">ieee80211_get_antenna</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span> <span class="o">=</span> <span class="n">ieee80211_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span> <span class="o">=</span> <span class="n">ieee80211_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rekey_data</span> <span class="o">=</span> <span class="n">ieee80211_set_rekey_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tdls_oper</span> <span class="o">=</span> <span class="n">ieee80211_tdls_oper</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tdls_mgmt</span> <span class="o">=</span> <span class="n">ieee80211_tdls_mgmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe_client</span> <span class="o">=</span> <span class="n">ieee80211_probe_client</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_channel</span> <span class="o">=</span> <span class="n">ieee80211_wiphy_get_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_noack_map</span> <span class="o">=</span> <span class="n">ieee80211_set_noack_map</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">set_wakeup</span> <span class="o">=</span> <span class="n">ieee80211_set_wakeup</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">get_et_sset_count</span> <span class="o">=</span> <span class="n">ieee80211_get_et_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_et_stats</span> <span class="o">=</span> <span class="n">ieee80211_get_et_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_et_strings</span> <span class="o">=</span> <span class="n">ieee80211_get_et_strings</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
