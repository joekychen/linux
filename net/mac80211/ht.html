<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › ht.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ht.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HT handling</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2003, Jouni Malinen &lt;jkmaline@cc.hut.fi&gt;</span>
<span class="cm"> * Copyright 2002-2005, Instant802 Networks, Inc.</span>
<span class="cm"> * Copyright 2005-2006, Devicescape Software, Inc.</span>
<span class="cm"> * Copyright 2006-2007	Jiri Benc &lt;jbenc@suse.cz&gt;</span>
<span class="cm"> * Copyright 2007, Michael Wu &lt;flamingice@sourmilk.net&gt;</span>
<span class="cm"> * Copyright 2007-2010, Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &quot;ieee80211_i.h&quot;</span>
<span class="cp">#include &quot;rate.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__check_htcap_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">le_flag</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa_mask</span><span class="p">.</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">le_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">.</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">le_flag</span><span class="p">))</span>
			<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flag</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_apply_htcap_overrides</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">scaps</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">smask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa_mask</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AP interfaces call this code when adding new stations,</span>
<span class="cm">		 * so just silently ignore non station interfaces.</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE:  If you add more over-rides here, update register_hw</span>
<span class="cm">	 * ht_capa_mod_msk logic in main.c as well.</span>
<span class="cm">	 * And, if this method can ever change ht_cap.ht_supported, fix</span>
<span class="cm">	 * the check in ieee80211_add_ht_ie.</span>
<span class="cm">	 */</span>

	<span class="cm">/* check for HT over-rides, MCS rates first. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_HT_MCS_MASK_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">m</span> <span class="o">=</span> <span class="n">smask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">m</span><span class="p">;</span> <span class="cm">/* turn off all masked bits */</span>
		<span class="cm">/* Add back rates that are supported */</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">scaps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Force removal of HT-40 capabilities? */</span>
	<span class="n">__check_htcap_disable</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">ht_cap</span><span class="p">,</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">);</span>
	<span class="n">__check_htcap_disable</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">ht_cap</span><span class="p">,</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">);</span>

	<span class="cm">/* Allow user to disable the max-AMSDU bit. */</span>
	<span class="n">__check_htcap_disable</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">ht_cap</span><span class="p">,</span> <span class="n">IEEE80211_HT_CAP_MAX_AMSDU</span><span class="p">);</span>

	<span class="cm">/* Allow user to decrease AMPDU factor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa_mask</span><span class="p">.</span><span class="n">ampdu_params_info</span> <span class="o">&amp;</span>
	    <span class="n">IEEE80211_HT_AMPDU_PARM_FACTOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">.</span><span class="n">ampdu_params_info</span>
			<span class="o">&amp;</span> <span class="n">IEEE80211_HT_AMPDU_PARM_FACTOR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span><span class="p">)</span>
			<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allow the user to increase AMPDU density. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa_mask</span><span class="p">.</span><span class="n">ampdu_params_info</span> <span class="o">&amp;</span>
	    <span class="n">IEEE80211_HT_AMPDU_PARM_DENSITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">ht_capa</span><span class="p">.</span><span class="n">ampdu_params_info</span> <span class="o">&amp;</span>
			<span class="n">IEEE80211_HT_AMPDU_PARM_DENSITY</span><span class="p">)</span>
			<span class="o">&gt;&gt;</span> <span class="n">IEEE80211_HT_AMPDU_PARM_DENSITY_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_density</span><span class="p">)</span>
			<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_ht_cap_ie_to_sta_ht_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="n">ht_cap_ie</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ampdu_info</span><span class="p">,</span> <span class="n">tx_mcs_set_cap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_tx_streams</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ht_cap</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ht_cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ht_cap</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ht_cap_ie</span> <span class="o">||</span> <span class="o">!</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The bits listed in this expression should be</span>
<span class="cm">	 * the same for the peer and us, if the station</span>
<span class="cm">	 * advertises more then we can&#39;t use those thus</span>
<span class="cm">	 * we mask them out.</span>
<span class="cm">	 */</span>
	<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ht_cap_ie</span><span class="o">-&gt;</span><span class="n">cap_info</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|</span>
		 <span class="o">~</span><span class="p">(</span><span class="n">IEEE80211_HT_CAP_LDPC_CODING</span> <span class="o">|</span>
		   <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span> <span class="o">|</span>
		   <span class="n">IEEE80211_HT_CAP_GRN_FLD</span> <span class="o">|</span>
		   <span class="n">IEEE80211_HT_CAP_SGI_20</span> <span class="o">|</span>
		   <span class="n">IEEE80211_HT_CAP_SGI_40</span> <span class="o">|</span>
		   <span class="n">IEEE80211_HT_CAP_DSSSCCK40</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * The STBC bits are asymmetric -- if we don&#39;t have</span>
<span class="cm">	 * TX then mask out the peer&#39;s RX and vice versa.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_TX_STBC</span><span class="p">))</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_HT_CAP_RX_STBC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_RX_STBC</span><span class="p">))</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_HT_CAP_TX_STBC</span><span class="p">;</span>

	<span class="n">ampdu_info</span> <span class="o">=</span> <span class="n">ht_cap_ie</span><span class="o">-&gt;</span><span class="n">ampdu_params_info</span><span class="p">;</span>
	<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span>
		<span class="n">ampdu_info</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_AMPDU_PARM_FACTOR</span><span class="p">;</span>
	<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ampdu_info</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_AMPDU_PARM_DENSITY</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* own MCS TX capabilities */</span>
	<span class="n">tx_mcs_set_cap</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span><span class="p">;</span>

	<span class="cm">/* Copy peer MCS TX capabilities, the driver might need them. */</span>
	<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">=</span> <span class="n">ht_cap_ie</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span><span class="p">;</span>

	<span class="cm">/* can we TX with MCS rates? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_mcs_set_cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_MCS_TX_DEFINED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Counting from 0, therefore +1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_mcs_set_cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_MCS_TX_RX_DIFF</span><span class="p">)</span>
		<span class="n">max_tx_streams</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">tx_mcs_set_cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_MASK</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_tx_streams</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 802.11n-2009 20.3.5 / 20.6 says:</span>
<span class="cm">	 * - indices 0 to 7 and 32 are single spatial stream</span>
<span class="cm">	 * - 8 to 31 are multiple spatial streams using equal modulation</span>
<span class="cm">	 *   [8..15 for two streams, 16..23 for three and 24..31 for four]</span>
<span class="cm">	 * - remainder are multiple spatial streams using unequal modulation</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_tx_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ht_cap_ie</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_mcs_set_cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_MCS_TX_UNEQUAL_MODULATION</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MCS_UNEQUAL_MODULATION_START_BYTE</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_HT_MCS_MASK_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="n">ht_cap_ie</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* handle MCS rate 32 too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">32</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ht_cap_ie</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">32</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">32</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If user has specified capability over-rides, take care</span>
<span class="cm">	 * of that here.</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_apply_htcap_overrides</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">ht_cap</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_sta_tear_down_BA_sessions</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">bool</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">STA_TID_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ieee80211_stop_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">WLAN_BACK_INITIATOR</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
		<span class="n">__ieee80211_stop_rx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">WLAN_BACK_RECIPIENT</span><span class="p">,</span>
					       <span class="n">WLAN_REASON_QSTA_LEAVE_QBSS</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_ba_session_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span><span class="p">,</span> <span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_ampdu_tx</span> <span class="o">*</span><span class="n">tid_tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When this flag is set, new sessions should be</span>
<span class="cm">	 * blocked, and existing sessions will be torn</span>
<span class="cm">	 * down by the code that set the flag, so this</span>
<span class="cm">	 * need not run.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_BLOCK_BA</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="n">STA_TID_NUM</span><span class="p">;</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_rx_timer_expired</span><span class="p">))</span>
			<span class="n">___ieee80211_stop_rx_ba_session</span><span class="p">(</span>
				<span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">WLAN_BACK_RECIPIENT</span><span class="p">,</span>
				<span class="n">WLAN_REASON_QSTA_TIMEOUT</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span>
				       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_rx_stop_requested</span><span class="p">))</span>
			<span class="n">___ieee80211_stop_rx_ba_session</span><span class="p">(</span>
				<span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">WLAN_BACK_RECIPIENT</span><span class="p">,</span>
				<span class="n">WLAN_REASON_UNSPECIFIED</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="n">tid_tx</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_start_tx</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Assign it over to the normal tid_tx array</span>
<span class="cm">			 * where it &quot;goes live&quot;.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_start_tx</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* could there be a race? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">tid_tx</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">tid_tx</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ieee80211_assign_tid_tx</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">tid_tx</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">ieee80211_tx_ba_session_handle_start</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tid_tx</span> <span class="o">=</span> <span class="n">rcu_dereference_protected_tid_tx</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_tx</span> <span class="o">&amp;&amp;</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HT_AGG_STATE_WANT_STOP</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">tid_tx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">___ieee80211_stop_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
							<span class="n">WLAN_BACK_INITIATOR</span><span class="p">,</span>
							<span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ampdu_mlme</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_send_delba</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mgmt</span><span class="p">)</span> <span class="o">+</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">||</span>
	    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					  <span class="n">IEEE80211_STYPE_ACTION</span><span class="p">);</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delba</span><span class="p">));</span>

	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_BACK</span><span class="p">;</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delba</span><span class="p">.</span><span class="n">action_code</span> <span class="o">=</span> <span class="n">WLAN_ACTION_DELBA</span><span class="p">;</span>
	<span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">initiator</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span> 	<span class="cm">/* bit 11 initiator */</span>
	<span class="n">params</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">tid</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> 		<span class="cm">/* bit 15:12 TID number */</span>

	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delba</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delba</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">reason_code</span><span class="p">);</span>

	<span class="n">ieee80211_tx_skb_tid</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_process_delba</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">initiator</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delba</span><span class="p">.</span><span class="n">params</span><span class="p">);</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span> <span class="o">&amp;</span> <span class="n">IEEE80211_DELBA_PARAM_TID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">initiator</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span> <span class="o">&amp;</span> <span class="n">IEEE80211_DELBA_PARAM_INITIATOR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC80211_HT_DEBUG</span>
	<span class="n">net_dbg_ratelimited</span><span class="p">(</span><span class="s">&quot;delba from %pM (%s) tid %d reason code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">initiator</span> <span class="o">?</span> <span class="s">&quot;initiator&quot;</span> <span class="o">:</span> <span class="s">&quot;recipient&quot;</span><span class="p">,</span>
			    <span class="n">tid</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delba</span><span class="p">.</span><span class="n">reason_code</span><span class="p">));</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAC80211_HT_DEBUG */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initiator</span> <span class="o">==</span> <span class="n">WLAN_BACK_INITIATOR</span><span class="p">)</span>
		<span class="n">__ieee80211_stop_rx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">WLAN_BACK_INITIATOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__ieee80211_stop_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">WLAN_BACK_RECIPIENT</span><span class="p">,</span>
					       <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_send_smps_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="n">smps</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">action_frame</span><span class="p">;</span>

	<span class="cm">/* 27 = header + category + action + smps mode */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">27</span> <span class="o">+</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="n">action_frame</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
						  <span class="n">IEEE80211_STYPE_ACTION</span><span class="p">);</span>
	<span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">WLAN_CATEGORY_HT</span><span class="p">;</span>
	<span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ht_smps</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">WLAN_HT_ACTION_SMPS</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">smps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span>:
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_NUM_MODES</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_OFF</span>:
		<span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ht_smps</span><span class="p">.</span><span class="n">smps_control</span> <span class="o">=</span>
				<span class="n">WLAN_HT_SMPS_CONTROL_DISABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_STATIC</span>:
		<span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ht_smps</span><span class="p">.</span><span class="n">smps_control</span> <span class="o">=</span>
				<span class="n">WLAN_HT_SMPS_CONTROL_STATIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span>:
		<span class="n">action_frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ht_smps</span><span class="p">.</span><span class="n">smps_control</span> <span class="o">=</span>
				<span class="n">WLAN_HT_SMPS_CONTROL_DYNAMIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we&#39;ll do more on status of this frame */</span>
	<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_REQ_TX_STATUS</span><span class="p">;</span>
	<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_request_smps_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span><span class="p">,</span>
			     <span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">request_smps_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">__ieee80211_request_smps</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">driver_smps_mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_request_smps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="n">smps_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">smps_mode</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_OFF</span><span class="p">))</span>
		<span class="n">smps_mode</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span><span class="p">;</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">driver_smps_mode</span> <span class="o">=</span> <span class="n">smps_mode</span><span class="p">;</span>

	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">request_smps_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* this might change ... don&#39;t want non-open drivers using it */</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ieee80211_request_smps</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
