<!DOCTYPE html>
<html><head><title>joekychen/linux » net › mac80211 › util.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>util.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2002-2005, Instant802 Networks, Inc.</span>
<span class="cm"> * Copyright 2005-2006, Devicescape Software, Inc.</span>
<span class="cm"> * Copyright 2006-2007	Jiri Benc &lt;jbenc@suse.cz&gt;</span>
<span class="cm"> * Copyright 2007	Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * utilities for mac80211</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &lt;net/rtnetlink.h&gt;</span>

<span class="cp">#include &quot;ieee80211_i.h&quot;</span>
<span class="cp">#include &quot;driver-ops.h&quot;</span>
<span class="cp">#include &quot;rate.h&quot;</span>
<span class="cp">#include &quot;mesh.h&quot;</span>
<span class="cp">#include &quot;wme.h&quot;</span>
<span class="cp">#include &quot;led.h&quot;</span>
<span class="cp">#include &quot;wep.h&quot;</span>

<span class="cm">/* privid for wiphys to determine whether they belong to us or not */</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">mac80211_wiphy_privid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac80211_wiphy_privid</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="nf">wiphy_to_ieee80211_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wiphy_to_ieee80211_hw</span><span class="p">);</span>

<span class="n">u8</span> <span class="o">*</span><span class="nf">ieee80211_get_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	 <span class="cm">/* drop ACK/CTS frames and incorrect hdr len (ctrl) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="cm">/* drop incorrect hdr len (data) */</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_tods</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_fromds</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="cm">/* drop incorrect hdr len (mgmt) */</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
				<span class="k">return</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
			<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
				<span class="k">return</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* fall through to the return */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_tx_set_protected</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_frame_duration</span><span class="p">(</span><span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">short_preamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dur</span><span class="p">;</span>

	<span class="cm">/* calculate duration (in microseconds, rounded up to next higher</span>
<span class="cm">	 * integer if it includes a fractional microsecond) to send frame of</span>
<span class="cm">	 * len bytes (does not include FCS) at the given rate. Duration will</span>
<span class="cm">	 * also include SIFS.</span>
<span class="cm">	 *</span>
<span class="cm">	 * rate is in 100 kbps, so divident is multiplied by 10 in the</span>
<span class="cm">	 * DIV_ROUND_UP() operations.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span> <span class="o">||</span> <span class="n">erp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * OFDM:</span>
<span class="cm">		 *</span>
<span class="cm">		 * N_DBPS = DATARATE x 4</span>
<span class="cm">		 * N_SYM = Ceiling((16+8xLENGTH+6) / N_DBPS)</span>
<span class="cm">		 *	(16 = SIGNAL time, 6 = tail bits)</span>
<span class="cm">		 * TXTIME = T_PREAMBLE + T_SIGNAL + T_SYM x N_SYM + Signal Ext</span>
<span class="cm">		 *</span>
<span class="cm">		 * T_SYM = 4 usec</span>
<span class="cm">		 * 802.11a - 17.5.2: aSIFSTime = 16 usec</span>
<span class="cm">		 * 802.11g - 19.8.4: aSIFSTime = 10 usec +</span>
<span class="cm">		 *	signal ext = 6 usec</span>
<span class="cm">		 */</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* SIFS + signal ext */</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* 17.3.2.3: T_PREAMBLE = 16 usec */</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 17.3.2.3: T_SIGNAL = 4 usec */</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">DIV_ROUND_UP</span><span class="p">((</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
					<span class="mi">4</span> <span class="o">*</span> <span class="n">rate</span><span class="p">);</span> <span class="cm">/* T_SYM x N_SYM */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 802.11b or 802.11g with 802.11b compatibility:</span>
<span class="cm">		 * 18.3.4: TXTIME = PreambleLength + PLCPHeaderTime +</span>
<span class="cm">		 * Ceiling(((LENGTH+PBCC)x8)/DATARATE). PBCC=0.</span>
<span class="cm">		 *</span>
<span class="cm">		 * 802.11 (DS): 15.3.3, 802.11b: 18.3.4</span>
<span class="cm">		 * aSIFSTime = 10 usec</span>
<span class="cm">		 * aPreambleLength = 144 usec or 72 usec with short preamble</span>
<span class="cm">		 * aPLCPHeaderLength = 48 usec or 24 usec with short preamble</span>
<span class="cm">		 */</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* aSIFSTime = 10 usec */</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="n">short_preamble</span> <span class="o">?</span> <span class="p">(</span><span class="mi">72</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">144</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>

		<span class="n">dur</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dur</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Exported duration function for driver use */</span>
<span class="n">__le16</span> <span class="nf">ieee80211_generic_frame_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">frame_len</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">erp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">short_preamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">erp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
		<span class="n">short_preamble</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SDATA_OPERATING_GMODE</span><span class="p">)</span>
			<span class="n">erp</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_ERP_G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dur</span> <span class="o">=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span> <span class="n">erp</span><span class="p">,</span>
				       <span class="n">short_preamble</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dur</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_generic_frame_duration</span><span class="p">);</span>

<span class="n">__le16</span> <span class="nf">ieee80211_rts_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">frame_len</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">frame_txctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">short_preamble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">erp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">frame_txctl</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="n">short_preamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">frame_txctl</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rts_cts_rate_idx</span><span class="p">];</span>

	<span class="n">erp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
		<span class="n">short_preamble</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SDATA_OPERATING_GMODE</span><span class="p">)</span>
			<span class="n">erp</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_ERP_G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CTS duration */</span>
	<span class="n">dur</span> <span class="o">=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span>
				       <span class="n">erp</span><span class="p">,</span> <span class="n">short_preamble</span><span class="p">);</span>
	<span class="cm">/* Data frame duration */</span>
	<span class="n">dur</span> <span class="o">+=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span>
					<span class="n">erp</span><span class="p">,</span> <span class="n">short_preamble</span><span class="p">);</span>
	<span class="cm">/* ACK duration */</span>
	<span class="n">dur</span> <span class="o">+=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span>
					<span class="n">erp</span><span class="p">,</span> <span class="n">short_preamble</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dur</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_rts_duration</span><span class="p">);</span>

<span class="n">__le16</span> <span class="nf">ieee80211_ctstoself_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">frame_len</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">frame_txctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">short_preamble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">erp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">frame_txctl</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="n">short_preamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">frame_txctl</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rts_cts_rate_idx</span><span class="p">];</span>
	<span class="n">erp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
		<span class="n">short_preamble</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SDATA_OPERATING_GMODE</span><span class="p">)</span>
			<span class="n">erp</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_ERP_G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data frame duration */</span>
	<span class="n">dur</span> <span class="o">=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span>
				       <span class="n">erp</span><span class="p">,</span> <span class="n">short_preamble</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">frame_txctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ACK duration */</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="n">ieee80211_frame_duration</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span>
						<span class="n">erp</span><span class="p">,</span> <span class="n">short_preamble</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dur</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_ctstoself_duration</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_propagate_queue_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ac</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDATA_STATE_OFFCHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">cab_queue</span> <span class="o">!=</span> <span class="n">IEEE80211_INVAL_HW_QUEUE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">cab_queue</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ac_queue</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">hw_queue</span><span class="p">[</span><span class="n">ac</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ac_queue</span> <span class="o">==</span> <span class="n">queue</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">cab_queue</span> <span class="o">==</span> <span class="n">queue</span> <span class="o">&amp;&amp;</span>
			     <span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">ac_queue</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			     <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">ac_queue</span><span class="p">])))</span>
				<span class="n">netif_wake_subqueue</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ac</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ieee80211_wake_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">queue_stop_reason</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">trace_wake_queue</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">queue</span><span class="p">]))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">queue</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">queue</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* someone still has this queue stopped */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">queue</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">ieee80211_propagate_queue_wake</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_pending_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_wake_queue_by_reason</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">queue_stop_reason</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__ieee80211_wake_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_wake_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_wake_queue_by_reason</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>
				       <span class="n">IEEE80211_QUEUE_STOP_REASON_DRIVER</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_wake_queue</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ieee80211_stop_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">queue_stop_reason</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>

	<span class="n">trace_stop_queue</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">queue</span><span class="p">]))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">queue</span><span class="p">]);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ac</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">hw_queue</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">==</span> <span class="n">queue</span> <span class="o">||</span>
			    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">cab_queue</span> <span class="o">==</span> <span class="n">queue</span><span class="p">)</span>
				<span class="n">netif_stop_subqueue</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ac</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_stop_queue_by_reason</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">queue_stop_reason</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__ieee80211_stop_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_stop_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_stop_queue_by_reason</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>
				       <span class="n">IEEE80211_QUEUE_STOP_REASON_DRIVER</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_stop_queue</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_add_pending_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__ieee80211_stop_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">IEEE80211_QUEUE_STOP_REASON_SKB_ADD</span><span class="p">);</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">__ieee80211_wake_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">IEEE80211_QUEUE_STOP_REASON_SKB_ADD</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_add_pending_skbs_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">skbs</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="n">skbs</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">queue</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">;</span>

		<span class="n">__ieee80211_stop_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>
				<span class="n">IEEE80211_QUEUE_STOP_REASON_SKB_ADD</span><span class="p">);</span>

		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span>
		<span class="n">fn</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__ieee80211_wake_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">IEEE80211_QUEUE_STOP_REASON_SKB_ADD</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_stop_queues_by_reason</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">queue_stop_reason</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__ieee80211_stop_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_stop_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_stop_queues_by_reason</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">IEEE80211_QUEUE_STOP_REASON_DRIVER</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_stop_queues</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ieee80211_queue_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">!!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reasons</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_queue_stopped</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_wake_queues_by_reason</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">queue_stop_reason</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__ieee80211_wake_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">queue_stop_reason_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_wake_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_wake_queues_by_reason</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IEEE80211_QUEUE_STOP_REASON_DRIVER</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_wake_queues</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_iterate_active_interfaces</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">iterator</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">),</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iflist_mtx</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="n">iterator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iflist_mtx</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ieee80211_iterate_active_interfaces</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">iterator</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">),</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="n">iterator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Nothing should have been stuffed into the workqueue during</span>
<span class="cm"> * the suspend-&gt;resume cycle. If this WARN is seen then there</span>
<span class="cm"> * is a bug with either the driver suspend or something in</span>
<span class="cm"> * mac80211 stuffing into the workqueue which we haven&#39;t yet</span>
<span class="cm"> * cleared during mac80211&#39;s suspend cycle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_can_queue_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">resuming</span><span class="p">,</span>
		 <span class="s">&quot;queueing ieee80211 work while going to suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_queue_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_can_queue_work</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_queue_work</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">hw_to_local</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_can_queue_work</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="n">dwork</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_queue_delayed_work</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">ieee802_11_parse_elems_crc</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee802_11_elems</span> <span class="o">*</span><span class="n">elems</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">filter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">crc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">left</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">calc_crc</span> <span class="o">=</span> <span class="n">filter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">seen_elems</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">seen_elems</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">elems</span><span class="p">));</span>
	<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ie_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">elems</span><span class="o">-&gt;</span><span class="n">total_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">elen</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">elem_parse_failed</span><span class="p">;</span>

		<span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="n">elen</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">parse_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span> <span class="o">&amp;&amp;</span>
		    <span class="n">id</span> <span class="o">!=</span> <span class="n">WLAN_EID_QUIET</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">seen_elems</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">parse_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">calc_crc</span> <span class="o">&amp;&amp;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">id</span><span class="p">)))</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_be</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">elen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">elem_parse_failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_EID_SSID</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_SUPP_RATES</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">supp_rates</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">supp_rates_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_FH_PARAMS</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">fh_params</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">fh_params_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_DS_PARAMS</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ds_params</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ds_params_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_CF_PARAMS</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">cf_params</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">cf_params_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_TIM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tim_ie</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">tim</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">;</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">tim_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">elem_parse_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_IBSS_PARAMS</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ibss_params</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ibss_params_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_CHALLENGE</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">challenge</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">challenge_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Microsoft OUI (00:50:F2) */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">calc_crc</span><span class="p">)</span>
					<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_be</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">elen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* OUI Type 1 - WPA IE */</span>
					<span class="n">elems</span><span class="o">-&gt;</span><span class="n">wpa</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
					<span class="n">elems</span><span class="o">-&gt;</span><span class="n">wpa_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* OUI Type 2 - WMM IE */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">elems</span><span class="o">-&gt;</span><span class="n">wmm_info</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
						<span class="n">elems</span><span class="o">-&gt;</span><span class="n">wmm_info_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">elems</span><span class="o">-&gt;</span><span class="n">wmm_param</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
						<span class="n">elems</span><span class="o">-&gt;</span><span class="n">wmm_param_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_RSN</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">rsn</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">rsn_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_ERP_INFO</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">erp_info</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">erp_info_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_EXT_SUPP_RATES</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ext_supp_rates</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ext_supp_rates_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_HT_CAPABILITY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span><span class="p">))</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ht_cap_elem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">elem_parse_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_HT_OPERATION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span><span class="p">))</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ht_operation</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">elem_parse_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_MESH_ID</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">mesh_id</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">mesh_id_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_MESH_CONFIG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_meshconf_ie</span><span class="p">))</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">mesh_config</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">elem_parse_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_PEER_MGMT</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">peering</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">peering_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_PREQ</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">preq</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">preq_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_PREP</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">prep</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">prep_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_PERR</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">perr</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">perr_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_RANN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rann_ie</span><span class="p">))</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">rann</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">elem_parse_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_CHANNEL_SWITCH</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ch_switch_elem</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">ch_switch_elem_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_QUIET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elems</span><span class="o">-&gt;</span><span class="n">quiet_elem</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">quiet_elem</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
				<span class="n">elems</span><span class="o">-&gt;</span><span class="n">quiet_elem_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">num_of_quiet_elem</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_COUNTRY</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">country_elem</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">country_elem_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_PWR_CONSTRAINT</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">pwr_constr_elem</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">pwr_constr_elem_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_TIMEOUT_INTERVAL</span>:
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">timeout_int</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">timeout_int_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">elem_parse_failed</span><span class="p">)</span>
			<span class="n">elems</span><span class="o">-&gt;</span><span class="n">parse_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">seen_elems</span><span class="p">);</span>

		<span class="n">left</span> <span class="o">-=</span> <span class="n">elen</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">elen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">elems</span><span class="o">-&gt;</span><span class="n">parse_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee802_11_parse_elems</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee802_11_elems</span> <span class="o">*</span><span class="n">elems</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee802_11_parse_elems_crc</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">elems</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_set_wmm_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">bss_notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="n">qparam</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_11b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aCWmin</span><span class="p">,</span> <span class="n">aCWmax</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">conf_tx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">queues</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qparam</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qparam</span><span class="p">));</span>

	<span class="n">use_11b</span> <span class="o">=</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SDATA_OPERATING_GMODE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set defaults according to 802.11-2007 Table 7-37 */</span>
		<span class="n">aCWmax</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_11b</span><span class="p">)</span>
			<span class="n">aCWmin</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">aCWmin</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ac</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEEE80211_AC_BK</span>:
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">aCWmax</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="n">aCWmin</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* never happens but let&#39;s not leave undefined */</span>
		<span class="k">case</span> <span class="n">IEEE80211_AC_BE</span>:
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">aCWmax</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="n">aCWmin</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE80211_AC_VI</span>:
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">aCWmin</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">aCWmin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_11b</span><span class="p">)</span>
				<span class="n">qparam</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">6016</span><span class="o">/</span><span class="mi">32</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">qparam</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">3008</span><span class="o">/</span><span class="mi">32</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE80211_AC_VO</span>:
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">aCWmin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">aCWmin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_11b</span><span class="p">)</span>
				<span class="n">qparam</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">3264</span><span class="o">/</span><span class="mi">32</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">qparam</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">1504</span><span class="o">/</span><span class="mi">32</span><span class="p">;</span>
			<span class="n">qparam</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qparam</span><span class="p">.</span><span class="n">uapsd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">tx_conf</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span> <span class="n">qparam</span><span class="p">;</span>
		<span class="n">drv_conf_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qparam</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* after reinitialize QoS TX queues setting to default,</span>
<span class="cm">	 * disable QoS at all */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">qos</span> <span class="o">=</span>
			<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_notify</span><span class="p">)</span>
			<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span>
							 <span class="n">BSS_CHANGED_QOS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_sta_def_wmm_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">supp_rates_len</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">supp_rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">have_higher_than_11mbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* cf. IEEE 802.11 9.2.12 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">supp_rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">110</span><span class="p">)</span>
			<span class="n">have_higher_than_11mbit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">have_higher_than_11mbit</span><span class="p">)</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_SDATA_OPERATING_GMODE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_SDATA_OPERATING_GMODE</span><span class="p">;</span>

	<span class="n">ieee80211_set_wmm_default</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ieee80211_mandatory_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">bitrates</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mandatory_rates</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_rate_flags</span> <span class="n">mandatory_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">mandatory_flag</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_MANDATORY_B</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mandatory_flag</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_MANDATORY_A</span><span class="p">;</span>

	<span class="n">bitrates</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">;</span>
	<span class="n">mandatory_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">mandatory_flag</span><span class="p">)</span>
			<span class="n">mandatory_rates</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mandatory_rates</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_send_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">u16</span> <span class="n">auth_alg</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="o">*</span><span class="n">extra</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">extra_len</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mgmt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					  <span class="n">IEEE80211_STYPE_AUTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">auth_alg</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">auth_alg</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">auth_transaction</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extra</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">extra_len</span><span class="p">),</span> <span class="n">extra</span><span class="p">,</span> <span class="n">extra_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span> <span class="o">&amp;&amp;</span> <span class="n">transaction</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_wep_encrypt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span><span class="p">;</span>
	<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_build_preq_ies</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate_mask</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">noffset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">supp_rates_len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ext_rates_len</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">num_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rate_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* skip rate */</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">supp_rates_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">num_rates</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">supp_rates_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">supp_rates_len</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">supp_rates_len</span><span class="p">;</span>

	<span class="cm">/* insert &quot;request information&quot; if in custom IEs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">&amp;&amp;</span> <span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">before_extrates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">WLAN_EID_SSID</span><span class="p">,</span>
			<span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span>
			<span class="n">WLAN_EID_REQUEST</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">noffset</span> <span class="o">=</span> <span class="n">ieee80211_ie_split</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span>
					     <span class="n">before_extrates</span><span class="p">,</span>
					     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">before_extrates</span><span class="p">),</span>
					     <span class="n">offset</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">noffset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">noffset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">noffset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext_rates_len</span> <span class="o">=</span> <span class="n">num_rates</span> <span class="o">-</span> <span class="n">supp_rates_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_rates_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_EXT_SUPP_RATES</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ext_rates_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rates</span> <span class="o">+</span> <span class="n">supp_rates_len</span><span class="p">,</span> <span class="n">ext_rates_len</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ext_rates_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;&amp;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_DS_PARAMS</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* insert custom IEs that go before HT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">&amp;&amp;</span> <span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">before_ht</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">WLAN_EID_SSID</span><span class="p">,</span>
			<span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span>
			<span class="n">WLAN_EID_REQUEST</span><span class="p">,</span>
			<span class="n">WLAN_EID_EXT_SUPP_RATES</span><span class="p">,</span>
			<span class="n">WLAN_EID_DS_PARAMS</span><span class="p">,</span>
			<span class="n">WLAN_EID_SUPPORTED_REGULATORY_CLASSES</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">noffset</span> <span class="o">=</span> <span class="n">ieee80211_ie_split</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span>
					     <span class="n">before_ht</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">before_ht</span><span class="p">),</span>
					     <span class="n">offset</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">noffset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">noffset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">noffset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ieee80211_ie_build_ht_cap</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">,</span>
						<span class="n">sband</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If adding more here, adjust code in main.c</span>
<span class="cm">	 * that calculates local-&gt;scan_ies_len.</span>
<span class="cm">	 */</span>

	<span class="cm">/* add any remaining custom IEs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">&amp;&amp;</span> <span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">noffset</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">noffset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">noffset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_build_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratemask</span><span class="p">,</span>
					  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ssid_len</span><span class="p">,</span>
					  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">directed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chan</span><span class="p">;</span>

	<span class="cm">/* FIXME: come up with a proper value */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">200</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not send DS Channel parameter for directed probe requests</span>
<span class="cm">	 * in order to maximize the chance that we get a response.  Some</span>
<span class="cm">	 * badly-behaved APs don&#39;t respond when this parameter is included.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">directed</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">ieee80211_build_preq_ies</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span>
					   <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
					   <span class="n">ratemask</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_probereq_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span>
				     <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span>
				     <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_INTFL_DONT_ENCRYPT</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_send_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ssid_len</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">ratemask</span><span class="p">,</span> <span class="n">bool</span> <span class="n">directed</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_cck</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_build_probe_req</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ratemask</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span>
					<span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">directed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">no_cck</span><span class="p">)</span>
			<span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">IEEE80211_TX_CTL_NO_CCK_RATE</span><span class="p">;</span>
		<span class="n">ieee80211_tx_skb</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ieee80211_sta_get_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee802_11_elems</span> <span class="o">*</span><span class="n">elems</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">basic_rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">bitrates</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">supp_rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bitrates</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">;</span>
	<span class="n">num_rates</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span>
	<span class="n">supp_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">elems</span><span class="o">-&gt;</span><span class="n">supp_rates_len</span> <span class="o">+</span>
		     <span class="n">elems</span><span class="o">-&gt;</span><span class="n">ext_supp_rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">own_rate</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">is_basic</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">elems</span><span class="o">-&gt;</span><span class="n">supp_rates_len</span><span class="p">)</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">elems</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">elems</span><span class="o">-&gt;</span><span class="n">ext_supp_rates</span><span class="p">)</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">elems</span><span class="o">-&gt;</span><span class="n">ext_supp_rates</span>
				<span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">elems</span><span class="o">-&gt;</span><span class="n">supp_rates_len</span><span class="p">];</span>
		<span class="n">own_rate</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">is_basic</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_basic</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="n">BSS_MEMBERSHIP_SELECTOR_HT_PHY</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_rates</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bitrates</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">own_rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">supp_rates</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">basic_rates</span> <span class="o">&amp;&amp;</span> <span class="n">is_basic</span><span class="p">)</span>
					<span class="o">*</span><span class="n">basic_rates</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">supp_rates</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_stop_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_led_radio</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ieee80211_mod_tpt_led_trig</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IEEE80211_TPT_LEDTRIG_FL_RADIO</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reconfig_filter</span><span class="p">);</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">drv_stop</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_reconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wowlan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">drv_resume</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">wake_up</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * res is 1, which means the driver requested</span>
<span class="cm">		 * to go through a regular reset on wakeup.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* everything else happens only if HW was up &amp; running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">wake_up</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Upon resume hardware can sometimes be goofy due to</span>
<span class="cm">	 * various platform / driver / bus issues, so restarting</span>
<span class="cm">	 * the device may at times not work immediately. Propagate</span>
<span class="cm">	 * the error.</span>
<span class="cm">	 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">drv_start</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">,</span> <span class="s">&quot;Hardware became unavailable &quot;</span>
		     <span class="s">&quot;upon resume. This could be a software issue &quot;</span>
		     <span class="s">&quot;prior to suspend or a hardware issue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup fragmentation threshold */</span>
	<span class="n">drv_set_frag_threshold</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>

	<span class="cm">/* setup RTS threshold */</span>
	<span class="n">drv_set_rts_threshold</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>

	<span class="cm">/* reset coverage class */</span>
	<span class="n">drv_set_coverage_class</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">coverage_class</span><span class="p">);</span>

	<span class="n">ieee80211_led_radio</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">ieee80211_mod_tpt_led_trig</span><span class="p">(</span><span class="n">local</span><span class="p">,</span>
				   <span class="n">IEEE80211_TPT_LEDTRIG_FL_RADIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* add interfaces */</span>
	<span class="n">sdata</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_sdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">drv_add_interface</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_sdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">synchronize_net</span><span class="p">();</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">drv_add_interface</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* add STAs back */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">uploaded</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">ieee80211_sta_state</span> <span class="n">state</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_STA_NOTEXIST</span><span class="p">;</span>
			     <span class="n">state</span> <span class="o">&lt;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta_state</span><span class="p">;</span> <span class="n">state</span><span class="o">++</span><span class="p">)</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="n">drv_sta_state</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						      <span class="n">state</span><span class="p">,</span> <span class="n">state</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>

	<span class="cm">/* reconfigure tx conf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span> <span class="o">||</span>
			    <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">drv_conf_tx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">tx_conf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* reconfigure hardware */</span>
	<span class="n">ieee80211_hw_config</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ieee80211_configure_filter</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="cm">/* Finally also reconfigure all the BSS information */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">changed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* common change flags for all interface types */</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">BSS_CHANGED_ERP_CTS_PROT</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_ERP_PREAMBLE</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_ERP_SLOT</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_HT</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_BASIC_RATES</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_BEACON_INT</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_BSSID</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_CQM</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_QOS</span> <span class="o">|</span>
			  <span class="n">BSS_CHANGED_IDLE</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
			<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_ASSOC</span> <span class="o">|</span>
				   <span class="n">BSS_CHANGED_ARP_FILTER</span><span class="p">;</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
			<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
			<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_IBSS</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
			<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_SSID</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
				<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_AP_PROBE_RESP</span><span class="p">;</span>

			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
			<span class="n">changed</span> <span class="o">|=</span> <span class="n">BSS_CHANGED_BEACON</span> <span class="o">|</span>
				   <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">;</span>
			<span class="n">ieee80211_bss_info_change_notify</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
			<span class="cm">/* ignore virtual */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span>:
		<span class="k">case</span> <span class="n">NUM_NL80211_IFTYPES</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ieee80211_recalc_ps</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The sta might be in psm against the ap (e.g. because</span>
<span class="cm">	 * this was the state before a hw restart), so we</span>
<span class="cm">	 * explicitly send a null packet in order to make sure</span>
<span class="cm">	 * it&#39;ll sync against the ap (and get out of psm).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ieee80211_send_nullfunc</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* add back keys */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="n">ieee80211_enable_keys</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>

 <span class="nl">wake_up:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear the WLAN_STA_BLOCK_BA flag so new aggregation</span>
<span class="cm">	 * sessions can be established after a resume.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also tear down aggregation sessions since reconfiguring</span>
<span class="cm">	 * them in a hardware restart scenario is not easily done</span>
<span class="cm">	 * right now, and the hardware will have lost information</span>
<span class="cm">	 * about the sessions, but we and the AP still think they</span>
<span class="cm">	 * are active. This is really a workaround though.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee80211_sta_tear_down_BA_sessions</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">clear_sta_flag</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">WLAN_STA_BLOCK_BA</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ieee80211_wake_queues_by_reason</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">IEEE80211_QUEUE_STOP_REASON_SUSPEND</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is for hw restart things are still running.</span>
<span class="cm">	 * We may want to change that later, however.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="cm">/* first set suspended false, then resuming */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
			<span class="n">ieee80211_sta_restart</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
			<span class="n">ieee80211_ibss_restart</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
			<span class="n">ieee80211_mesh_restart</span><span class="p">(</span><span class="n">sdata</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_cleanup</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">mesh_plink_restart</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_mtx</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_resume_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">resuming</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_SDATA_DISCONNECT_RESUME</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">key_mtx</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">key_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KEY_FLAG_TAINTED</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">key_mtx</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ieee80211_resume_disconnect</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_mgd_smps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="o">*</span><span class="n">smps_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">smps_mode</span> <span class="o">=</span> <span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">ap_smps</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">smps_mode</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">powersave</span><span class="p">)</span>
				<span class="o">*</span><span class="n">smps_mode</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">smps_mode</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_OFF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* must hold iflist_mtx */</span>
<span class="kt">void</span> <span class="nf">ieee80211_recalc_smps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_smps_mode</span> <span class="n">smps_mode</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_OFF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iflist_mtx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This function could be improved to handle multiple</span>
<span class="cm">	 * interfaces better, but right now it makes any</span>
<span class="cm">	 * non-station interfaces force SM PS to be turned</span>
<span class="cm">	 * off. If there are multiple station interfaces it</span>
<span class="cm">	 * could also use the best possible mode, e.g. if</span>
<span class="cm">	 * one is in static and the other in dynamic then</span>
<span class="cm">	 * dynamic is ok.</span>
<span class="cm">	 */</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_sdata_running</span><span class="p">(</span><span class="n">sdata</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">set</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">+=</span> <span class="n">check_mgd_smps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smps_mode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smps_mode</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_OFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smps_mode</span> <span class="o">==</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">smps_mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

 <span class="nl">set:</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">smps_mode</span> <span class="o">=</span> <span class="n">smps_mode</span><span class="p">;</span>
	<span class="cm">/* changed flag is auto-detected for this */</span>
	<span class="n">ieee80211_hw_config</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ieee80211_id_in_list</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_ids</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ieee80211_ie_split - split an IE buffer according to ordering</span>
<span class="cm"> *</span>
<span class="cm"> * @ies: the IE buffer</span>
<span class="cm"> * @ielen: the length of the IE buffer</span>
<span class="cm"> * @ids: an array with element IDs that are allowed before</span>
<span class="cm"> *	the split</span>
<span class="cm"> * @n_ids: the size of the element ID array</span>
<span class="cm"> * @offset: offset where to start splitting in the buffer</span>
<span class="cm"> *</span>
<span class="cm"> * This function splits an IE buffer by updating the @offset</span>
<span class="cm"> * variable to point to the location where the buffer should be</span>
<span class="cm"> * split.</span>
<span class="cm"> *</span>
<span class="cm"> * It assumes that the given IE buffer is well-formed, this</span>
<span class="cm"> * has to be guaranteed by the caller!</span>
<span class="cm"> *</span>
<span class="cm"> * It also assumes that the IEs in the buffer are ordered</span>
<span class="cm"> * correctly, if not the result of using this function will not</span>
<span class="cm"> * be ordered correctly either, i.e. it does no reordering.</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns the offset where the next part of the</span>
<span class="cm"> * buffer starts, which may be @ielen if the entire (remainder)</span>
<span class="cm"> * of the buffer should be used.</span>
<span class="cm"> */</span>
<span class="kt">size_t</span> <span class="nf">ieee80211_ie_split</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ies</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ielen</span><span class="p">,</span>
			  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_ids</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ielen</span> <span class="o">&amp;&amp;</span> <span class="n">ieee80211_id_in_list</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">n_ids</span><span class="p">,</span> <span class="n">ies</span><span class="p">[</span><span class="n">pos</span><span class="p">]))</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ies</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">ieee80211_ie_split_vendor</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ies</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ielen</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ielen</span> <span class="o">&amp;&amp;</span> <span class="n">ies</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ies</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ieee80211_enable_rssi_reports</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">rssi_min_thold</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">rssi_max_thold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">trace_api_enable_rssi_reports</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">rssi_min_thold</span><span class="p">,</span> <span class="n">rssi_max_thold</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scale up threshold values before storing it, as the RSSI averaging</span>
<span class="cm">	 * algorithm uses a scaled up value as well. Change this scaling</span>
<span class="cm">	 * factor if the RSSI averaging algorithm changes.</span>
<span class="cm">	 */</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">rssi_min_thold</span> <span class="o">=</span> <span class="n">rssi_min_thold</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">.</span><span class="n">rssi_max_thold</span> <span class="o">=</span> <span class="n">rssi_max_thold</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_enable_rssi_reports</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rssi_min_thold</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rssi_max_thold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rssi_min_thold</span> <span class="o">==</span> <span class="n">rssi_max_thold</span> <span class="o">||</span>
		<span class="n">rssi_min_thold</span> <span class="o">&gt;</span> <span class="n">rssi_max_thold</span><span class="p">);</span>

	<span class="n">_ieee80211_enable_rssi_reports</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">rssi_min_thold</span><span class="p">,</span>
				       <span class="n">rssi_max_thold</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_enable_rssi_reports</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ieee80211_disable_rssi_reports</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">_ieee80211_enable_rssi_reports</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_disable_rssi_reports</span><span class="p">);</span>

<span class="n">u8</span> <span class="o">*</span><span class="nf">ieee80211_ie_build_ht_cap</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_HT_CAPABILITY</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span><span class="p">));</span>

	<span class="cm">/* capability flags */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

	<span class="cm">/* AMPDU parameters */</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">&lt;&lt;</span>
			<span class="n">IEEE80211_HT_AMPDU_PARM_DENSITY_SHIFT</span><span class="p">);</span>

	<span class="cm">/* MCS set */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">));</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">);</span>

	<span class="cm">/* extended capabilities */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">);</span>

	<span class="cm">/* BF capabilities */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">);</span>

	<span class="cm">/* antenna selection */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="o">*</span><span class="nf">ieee80211_ie_build_ht_oper</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">prot_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_ht_operation</span> <span class="o">*</span><span class="n">ht_oper</span><span class="p">;</span>
	<span class="cm">/* Build HT Information */</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_HT_OPERATION</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span><span class="p">);</span>
	<span class="n">ht_oper</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">primary_chan</span> <span class="o">=</span>
			<span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_CHAN_HT40MINUS</span>:
		<span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">ht_param</span> <span class="o">=</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_BELOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_CHAN_HT40PLUS</span>:
		<span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">ht_param</span> <span class="o">=</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_CHAN_HT20</span>:
	<span class="nl">default:</span>
		<span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">ht_param</span> <span class="o">=</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span> <span class="o">&amp;&amp;</span>
	    <span class="n">channel_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">channel_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_HT20</span><span class="p">)</span>
		<span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">ht_param</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_PARAM_CHAN_WIDTH_ANY</span><span class="p">;</span>

	<span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prot_mode</span><span class="p">);</span>
	<span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">stbc_param</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="cm">/* It seems that Basic MCS set and Supported MCS set</span>
<span class="cm">	   are identical for the first 10 bytes */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">basic_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">basic_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pos</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">nl80211_channel_type</span>
<span class="nf">ieee80211_ht_oper_to_channel_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span> <span class="o">*</span><span class="n">ht_oper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ht_oper</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ht_oper</span><span class="o">-&gt;</span><span class="n">ht_param</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_OFFSET</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_NONE</span>:
		<span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_HT20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span>:
		<span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_HT40PLUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_BELOW</span>:
		<span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_HT40MINUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">channel_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_add_srates_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">need_basic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">basic_rates</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">basic_rates</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="n">rates</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rates</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rates</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rates</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">rates</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">basic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_basic</span> <span class="o">&amp;&amp;</span> <span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="n">basic</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">basic</span> <span class="o">|</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_add_ext_srates_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">need_basic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_local</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">exrates</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">basic_rates</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">basic_rates</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="n">exrates</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exrates</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">exrates</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">exrates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">exrates</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exrates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">exrates</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_EXT_SUPP_RATES</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">exrates</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">basic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">need_basic</span> <span class="o">&amp;&amp;</span> <span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
				<span class="n">basic</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">basic</span> <span class="o">|</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_ave_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sub_if_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">vif_to_sdata</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_if_managed</span> <span class="o">*</span><span class="n">ifmgd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mgd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">sdata</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* non-managed type inferfaces */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ifmgd</span><span class="o">-&gt;</span><span class="n">ave_beacon_signal</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ieee80211_ave_rssi</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
