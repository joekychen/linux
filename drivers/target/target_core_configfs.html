<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › target › target_core_configfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>target_core_configfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>
<span class="cm"> * Filename:  target_core_configfs.c</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains ConfigFS logic for the Generic Target Engine project.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008-2011 Rising Tide Systems</span>
<span class="cm"> * Copyright (c) 2008-2011 Linux-iSCSI.org</span>
<span class="cm"> *</span>
<span class="cm"> * Nicholas A. Bellinger &lt;nab@kernel.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * based on configfs Copyright (C) 2005 Oracle.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;generated/utsrelease.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/configfs.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;target/target_core_base.h&gt;</span>
<span class="cp">#include &lt;target/target_core_backend.h&gt;</span>
<span class="cp">#include &lt;target/target_core_fabric.h&gt;</span>
<span class="cp">#include &lt;target/target_core_fabric_configfs.h&gt;</span>
<span class="cp">#include &lt;target/target_core_configfs.h&gt;</span>
<span class="cp">#include &lt;target/configfs_macros.h&gt;</span>

<span class="cp">#include &quot;target_core_internal.h&quot;</span>
<span class="cp">#include &quot;target_core_alua.h&quot;</span>
<span class="cp">#include &quot;target_core_pr.h&quot;</span>
<span class="cp">#include &quot;target_core_rd.h&quot;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">default_lu_gp</span><span class="p">;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">g_tf_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">g_tf_lock</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="n">target_core_hbagroup</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="n">alua_group</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="n">alua_lu_gps_group</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span>
<span class="nf">item_to_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="k">struct</span> <span class="n">se_hba</span><span class="p">,</span> <span class="n">hba_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attributes for /sys/kernel/config/target/</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Target Engine Core ConfigFS Infrastructure %s&quot;</span>
		<span class="s">&quot; on %s/%s on &quot;</span><span class="n">UTS_RELEASE</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TARGET_CORE_CONFIGFS_VERSION</span><span class="p">,</span>
		<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">machine</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_fabric_item_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show_attribute</span> <span class="o">=</span> <span class="n">target_core_attr_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="n">target_core_item_attr_version</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ca_owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ca_name</span>	<span class="o">=</span> <span class="s">&quot;version&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ca_mode</span>	<span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="nf">target_core_get_fabric</span><span class="p">(</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_tf_list</span><span class="p">,</span> <span class="n">tf_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_access_cnt</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from struct target_core_group_ops-&gt;make_group()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="nf">target_core_register_fabric</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: REGISTER -&gt; group: %p name:&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Below are some hardcoded request_module() calls to automatically</span>
<span class="cm">	 * local fabric modules when the following is called:</span>
<span class="cm">	 *</span>
<span class="cm">	 * mkdir -p /sys/kernel/config/target/$MODULE_NAME</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that this does not limit which TCM fabric module can be</span>
<span class="cm">	 * registered, but simply provids auto loading logic for modules with</span>
<span class="cm">	 * mkdir(2) system calls with known TCM fabric modules.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;iscsi&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Automatically load the LIO Target fabric module when the</span>
<span class="cm">		 * following is called:</span>
<span class="cm">		 *</span>
<span class="cm">		 * mkdir -p $CONFIGFS/target/iscsi</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_module</span><span class="p">(</span><span class="s">&quot;iscsi_target_mod&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;request_module() failed for&quot;</span>
				<span class="s">&quot; iscsi_target_mod.ko: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;loopback&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Automatically load the tcm_loop fabric module when the</span>
<span class="cm">		 * following is called:</span>
<span class="cm">		 *</span>
<span class="cm">		 * mkdir -p $CONFIGFS/target/loopback</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_module</span><span class="p">(</span><span class="s">&quot;tcm_loop&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;request_module() failed for&quot;</span>
				<span class="s">&quot; tcm_loop.ko: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tf</span> <span class="o">=</span> <span class="n">target_core_get_fabric</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;target_core_get_fabric() failed for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: REGISTER -&gt; Located fabric:&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * On a successful target_core_get_fabric() look, the returned</span>
<span class="cm">	 * struct target_fabric_configfs *tf will contain a usage reference.</span>
<span class="cm">	 */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: REGISTER tfc_wwn_cit -&gt; %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_wwn_cit</span><span class="p">);</span>

	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">.</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_default_groups</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">.</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_disc_group</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">.</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_wwn_cit</span><span class="p">);</span>
	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_disc_group</span><span class="p">,</span> <span class="s">&quot;discovery_auth&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_discovery_cit</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: REGISTER -&gt; Allocated Fabric:&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">.</span><span class="n">ci_name</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Setup tf_ops.tf_subsys pointer for usage with configfs_depend_item()</span>
<span class="cm">	 */</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_ops</span><span class="p">.</span><span class="n">tf_subsys</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_fabric</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: REGISTER -&gt; Set tf-&gt;tf_fabric&quot;</span>
			<span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from struct target_core_group_ops-&gt;drop_item()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_deregister_fabric</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span>
		<span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="k">struct</span> <span class="n">target_fabric_configfs</span><span class="p">,</span> <span class="n">tf_group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">tf_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">df_item</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: DEREGISTER -&gt; Looking up %s in&quot;</span>
		<span class="s">&quot; tf list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config_item_name</span><span class="p">(</span><span class="n">item</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: DEREGISTER -&gt; located fabric:&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_access_cnt</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: DEREGISTER -&gt; Releasing&quot;</span>
			<span class="s">&quot; tf-&gt;tf_fabric for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_fabric</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: DEREGISTER -&gt; Releasing ci&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config_item_name</span><span class="p">(</span><span class="n">item</span><span class="p">));</span>

	<span class="n">tf_group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_group</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tf_group</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">df_item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tf_group</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">tf_group</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">config_item_put</span><span class="p">(</span><span class="n">df_item</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_group_operations</span> <span class="n">target_core_fabric_group_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">make_group</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_register_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_item</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_deregister_fabric</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * All item attributes appearing in /sys/kernel/target/ appear here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">target_core_fabric_item_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_item_attr_version</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Provides Fabrics Groups and Item Attributes for /sys/kernel/config/target/</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_fabrics_item</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_fabric_item_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_group_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_fabric_group_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>	<span class="o">=</span> <span class="n">target_core_fabric_item_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_subsystem</span> <span class="n">target_core_fabrics</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">su_group</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cg_item</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">ci_namebuf</span> <span class="o">=</span> <span class="s">&quot;target&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ci_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_fabrics_item</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_subsystem</span> <span class="o">*</span><span class="n">target_core_subsystem</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_fabrics</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*##############################################################################</span>

<span class="cm">//DIVIDER</span>

<span class="cm">/*</span>
<span class="cm"> * First function called by fabric modules to:</span>
<span class="cm"> *</span>
<span class="cm"> * 1) Allocate a struct target_fabric_configfs and save the *fabric_cit pointer.</span>
<span class="cm"> * 2) Add struct target_fabric_configfs to g_tf_list</span>
<span class="cm"> * 3) Return struct target_fabric_configfs to fabric module to be passed</span>
<span class="cm"> *    into target_fabric_configfs_register().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="nf">target_fabric_configfs_init</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">fabric_mod</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate passed fabric name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TARGET_FABRIC_NAME_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Passed name: %s exceeds TARGET_FABRIC&quot;</span>
			<span class="s">&quot;_NAME_SIZE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">target_fabric_configfs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_list</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_access_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Setup the default generic struct config_item_type&#39;s (cits) in</span>
<span class="cm">	 * struct target_fabric_configfs-&gt;tf_cit_tmpl</span>
<span class="cm">	 */</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_module</span> <span class="o">=</span> <span class="n">fabric_mod</span><span class="p">;</span>
	<span class="n">target_fabric_setup_cits</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>

	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_subsys</span> <span class="o">=</span> <span class="n">target_core_subsystem</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">TARGET_FABRIC_NAME_SIZE</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_tf_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; BEGIN FABRIC API &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>
			<span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Initialized struct target_fabric_configfs: %p for&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">target_fabric_configfs_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Called by fabric plugins after FAILED target_fabric_configfs_register() call.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">target_fabric_configfs_free</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">target_fabric_configfs_free</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Perform a sanity check of the passed tf-&gt;tf_ops before completing</span>
<span class="cm"> * TCM fabric module registration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">target_fabric_tf_ops_check</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;get_fabric_name()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_proto_ident</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;get_fabric_proto_ident()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_wwn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_get_wwn()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_get_tag()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_default_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_get_default_depth()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_pr_transport_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_get_pr_transport_id()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_pr_transport_id_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_get_pr_transport_id_len()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_check_demo_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_check_demo_mode()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_check_demo_mode_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_check_demo_mode_cache()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_check_demo_mode_write_protect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_check_demo_mode_write_protect()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_check_prod_mode_write_protect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_check_prod_mode_write_protect()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_alloc_fabric_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_alloc_fabric_acl()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_release_fabric_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_release_fabric_acl()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_inst_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;tpg_get_inst_index()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">release_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;release_cmd()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">shutdown_session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;shutdown_session()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">close_session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;close_session()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">sess_get_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;sess_get_index()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">write_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;write_pending()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">write_pending_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;write_pending_status()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">set_default_node_attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;set_default_node_attributes()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_task_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;get_task_tag()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_cmd_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;get_cmd_state()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">queue_data_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;queue_data_in()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">queue_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;queue_status()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">queue_tm_rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;queue_tm_rsp()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">set_fabric_sense_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;set_fabric_sense_len()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_sense_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;get_fabric_sense_len()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We at least require tfo-&gt;fabric_make_wwn(), tfo-&gt;fabric_drop_wwn()</span>
<span class="cm">	 * tfo-&gt;fabric_make_tpg() and tfo-&gt;fabric_drop_tpg() in</span>
<span class="cm">	 * target_core_fabric_configfs.c WWN+TPG group context code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">fabric_make_wwn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;fabric_make_wwn()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">fabric_drop_wwn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;fabric_drop_wwn()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">fabric_make_tpg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;fabric_make_tpg()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tfo</span><span class="o">-&gt;</span><span class="n">fabric_drop_tpg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing tfo-&gt;fabric_drop_tpg()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called 2nd from fabric module with returned parameter of</span>
<span class="cm"> * struct target_fabric_configfs * from target_fabric_configfs_init().</span>
<span class="cm"> *</span>
<span class="cm"> * Upon a successful registration, the new fabric&#39;s struct config_item is</span>
<span class="cm"> * return.  Also, a pointer to this struct is set in the passed</span>
<span class="cm"> * struct target_fabric_configfs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">target_fabric_configfs_register</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate target_fabric_configfs&quot;</span>
			<span class="s">&quot; pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to target struct config_subsystem&quot;</span>
			<span class="s">&quot; pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">target_fabric_tf_ops_check</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; END FABRIC API &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>
		<span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">target_fabric_configfs_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">target_fabric_configfs_deregister</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">configfs_subsystem</span> <span class="o">*</span><span class="n">su</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate passed target_fabric_&quot;</span>
			<span class="s">&quot;configfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">su</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">su</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate passed tf-&gt;tf_subsys&quot;</span>
			<span class="s">&quot; pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; BEGIN FABRIC API &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>
			<span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_access_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Non zero tf-&gt;tf_access_cnt for fabric %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_tf_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: DEREGISTER -&gt; Releasing tf:&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_name</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_subsys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; END FABRIC API &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>
			<span class="s">&quot;&gt;&gt;&gt;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">target_fabric_configfs_deregister</span><span class="p">);</span>

<span class="cm">/*##############################################################################</span>

<span class="cm">//DIVIDER</span>

<span class="cm">/* Start functions for struct config_item_type target_core_dev_attrib_cit */</span>

<span class="cp">#define DEF_DEV_ATTRIB_SHOW(_name)					\</span>
<span class="cp">static ssize_t target_core_dev_show_attr_##_name(			\</span>
<span class="cp">	struct se_dev_attrib *da,					\</span>
<span class="cp">	char *page)							\</span>
<span class="cp">{									\</span>
<span class="cp">	struct se_device *dev;						\</span>
<span class="cp">	struct se_subsystem_dev *se_dev = da-&gt;da_sub_dev;			\</span>
<span class="cp">	ssize_t rb;							\</span>
<span class="cp">									\</span>
<span class="cp">	spin_lock(&amp;se_dev-&gt;se_dev_lock);				\</span>
<span class="cp">	dev = se_dev-&gt;se_dev_ptr;					\</span>
<span class="cp">	if (!dev) {							\</span>
<span class="cp">		spin_unlock(&amp;se_dev-&gt;se_dev_lock); 			\</span>
<span class="cp">		return -ENODEV;						\</span>
<span class="cp">	}								\</span>
<span class="cp">	rb = snprintf(page, PAGE_SIZE, &quot;%u\n&quot;,				\</span>
<span class="cp">		(u32)dev-&gt;se_sub_dev-&gt;se_dev_attrib._name);		\</span>
<span class="cp">	spin_unlock(&amp;se_dev-&gt;se_dev_lock);				\</span>
<span class="cp">									\</span>
<span class="cp">	return rb;							\</span>
<span class="cp">}</span>

<span class="cp">#define DEF_DEV_ATTRIB_STORE(_name)					\</span>
<span class="cp">static ssize_t target_core_dev_store_attr_##_name(			\</span>
<span class="cp">	struct se_dev_attrib *da,					\</span>
<span class="cp">	const char *page,						\</span>
<span class="cp">	size_t count)							\</span>
<span class="cp">{									\</span>
<span class="cp">	struct se_device *dev;						\</span>
<span class="cp">	struct se_subsystem_dev *se_dev = da-&gt;da_sub_dev;			\</span>
<span class="cp">	unsigned long val;						\</span>
<span class="cp">	int ret;							\</span>
<span class="cp">									\</span>
<span class="cp">	spin_lock(&amp;se_dev-&gt;se_dev_lock);				\</span>
<span class="cp">	dev = se_dev-&gt;se_dev_ptr;					\</span>
<span class="cp">	if (!dev) {							\</span>
<span class="cp">		spin_unlock(&amp;se_dev-&gt;se_dev_lock);			\</span>
<span class="cp">		return -ENODEV;						\</span>
<span class="cp">	}								\</span>
<span class="cp">	ret = strict_strtoul(page, 0, &amp;val);				\</span>
<span class="cp">	if (ret &lt; 0) {							\</span>
<span class="cp">		spin_unlock(&amp;se_dev-&gt;se_dev_lock);                      \</span>
<span class="cp">		pr_err(&quot;strict_strtoul() failed with&quot;		\</span>
<span class="cp">			&quot; ret: %d\n&quot;, ret);				\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">	}								\</span>
<span class="cp">	ret = se_dev_set_##_name(dev, (u32)val);			\</span>
<span class="cp">	spin_unlock(&amp;se_dev-&gt;se_dev_lock);				\</span>
<span class="cp">									\</span>
<span class="cp">	return (!ret) ? count : -EINVAL;				\</span>
<span class="cp">}</span>

<span class="cp">#define DEF_DEV_ATTRIB(_name)						\</span>
<span class="cp">DEF_DEV_ATTRIB_SHOW(_name);						\</span>
<span class="cp">DEF_DEV_ATTRIB_STORE(_name);</span>

<span class="cp">#define DEF_DEV_ATTRIB_RO(_name)					\</span>
<span class="cp">DEF_DEV_ATTRIB_SHOW(_name);</span>

<span class="n">CONFIGFS_EATTR_STRUCT</span><span class="p">(</span><span class="n">target_core_dev_attrib</span><span class="p">,</span> <span class="n">se_dev_attrib</span><span class="p">);</span>
<span class="cp">#define SE_DEV_ATTR(_name, _mode)					\</span>
<span class="cp">static struct target_core_dev_attrib_attribute				\</span>
<span class="cp">			target_core_dev_attrib_##_name =		\</span>
<span class="cp">		__CONFIGFS_EATTR(_name, _mode,				\</span>
<span class="cp">		target_core_dev_show_attr_##_name,			\</span>
<span class="cp">		target_core_dev_store_attr_##_name);</span>

<span class="cp">#define SE_DEV_ATTR_RO(_name);						\</span>
<span class="cp">static struct target_core_dev_attrib_attribute				\</span>
<span class="cp">			target_core_dev_attrib_##_name =		\</span>
<span class="cp">	__CONFIGFS_EATTR_RO(_name,					\</span>
<span class="cp">	target_core_dev_show_attr_##_name);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_dpo</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_dpo</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_fua_write</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_fua_write</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_fua_read</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_fua_read</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_write_cache</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_write_cache</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_ua_intlck_ctrl</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_ua_intlck_ctrl</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_tas</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_tas</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_tpu</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_tpu</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_tpws</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_tpws</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">enforce_pr_isids</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">enforce_pr_isids</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">is_nonrot</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">is_nonrot</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">emulate_rest_reord</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">emulate_rest_reord</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB_RO</span><span class="p">(</span><span class="n">hw_block_size</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR_RO</span><span class="p">(</span><span class="n">hw_block_size</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">block_size</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB_RO</span><span class="p">(</span><span class="n">hw_max_sectors</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR_RO</span><span class="p">(</span><span class="n">hw_max_sectors</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">fabric_max_sectors</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">fabric_max_sectors</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">optimal_sectors</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">optimal_sectors</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB_RO</span><span class="p">(</span><span class="n">hw_queue_depth</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR_RO</span><span class="p">(</span><span class="n">hw_queue_depth</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">queue_depth</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">queue_depth</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">max_unmap_lba_count</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">max_unmap_lba_count</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">max_unmap_block_desc_count</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">max_unmap_block_desc_count</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">unmap_granularity</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">unmap_granularity</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">DEF_DEV_ATTRIB</span><span class="p">(</span><span class="n">unmap_granularity_alignment</span><span class="p">);</span>
<span class="n">SE_DEV_ATTR</span><span class="p">(</span><span class="n">unmap_granularity_alignment</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">CONFIGFS_EATTR_OPS</span><span class="p">(</span><span class="n">target_core_dev_attrib</span><span class="p">,</span> <span class="n">se_dev_attrib</span><span class="p">,</span> <span class="n">da_group</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">target_core_dev_attrib_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_dpo</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_fua_write</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_fua_read</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_write_cache</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_ua_intlck_ctrl</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_tas</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_tpu</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_tpws</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_enforce_pr_isids</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_is_nonrot</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_emulate_rest_reord</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_hw_block_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_block_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_hw_max_sectors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_fabric_max_sectors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_optimal_sectors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_hw_queue_depth</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_queue_depth</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_max_unmap_lba_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_max_unmap_block_desc_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_unmap_granularity</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_attrib_unmap_granularity_alignment</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_dev_attrib_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show_attribute</span>		<span class="o">=</span> <span class="n">target_core_dev_attrib_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_attribute</span>	<span class="o">=</span> <span class="n">target_core_dev_attrib_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_dev_attrib_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_dev_attrib_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="n">target_core_dev_attrib_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_dev_attrib_cit */</span>

<span class="cm">/*  Start functions for struct config_item_type target_core_dev_wwn_cit */</span>

<span class="n">CONFIGFS_EATTR_STRUCT</span><span class="p">(</span><span class="n">target_core_dev_wwn</span><span class="p">,</span> <span class="n">t10_wwn</span><span class="p">);</span>
<span class="cp">#define SE_DEV_WWN_ATTR(_name, _mode)					\</span>
<span class="cp">static struct target_core_dev_wwn_attribute target_core_dev_wwn_##_name = \</span>
<span class="cp">		__CONFIGFS_EATTR(_name, _mode,				\</span>
<span class="cp">		target_core_dev_wwn_show_attr_##_name,			\</span>
<span class="cp">		target_core_dev_wwn_store_attr_##_name);</span>

<span class="cp">#define SE_DEV_WWN_ATTR_RO(_name);					\</span>
<span class="cp">do {									\</span>
<span class="cp">	static struct target_core_dev_wwn_attribute			\</span>
<span class="cp">			target_core_dev_wwn_##_name =			\</span>
<span class="cp">		__CONFIGFS_EATTR_RO(_name,				\</span>
<span class="cp">		target_core_dev_wwn_show_attr_##_name);			\</span>
<span class="cp">} while (0);</span>

<span class="cm">/*</span>
<span class="cm"> * VPD page 0x80 Unit serial</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_wwn_show_attr_vpd_unit_serial</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">t10_wwn</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">t10_wwn</span><span class="o">-&gt;</span><span class="n">t10_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;T10 VPD Unit Serial Number: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">t10_wwn</span><span class="o">-&gt;</span><span class="n">unit_serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_wwn_store_attr_vpd_unit_serial</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">t10_wwn</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">t10_wwn</span><span class="o">-&gt;</span><span class="n">t10_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">INQUIRY_VPD_SERIAL_LEN</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * If Linux/SCSI subsystem_api_t plugin got a VPD Unit Serial</span>
<span class="cm">	 * from the struct scsi_device level firmware, do not allow</span>
<span class="cm">	 * VPD Unit Serial to be emulated.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note this struct scsi_device could also be emulating VPD</span>
<span class="cm">	 * information from its drivers/scsi LLD.  But for now we assume</span>
<span class="cm">	 * it is doing &#39;the right thing&#39; wrt a world wide unique</span>
<span class="cm">	 * VPD Unit Serial Number that OS dependent multipath can depend on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">su_dev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_FIRMWARE_VPD_UNIT_SERIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Underlying SCSI device firmware provided VPD&quot;</span>
			<span class="s">&quot; Unit Serial, ignoring request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">INQUIRY_VPD_SERIAL_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Emulated VPD Unit Serial exceeds&quot;</span>
		<span class="s">&quot; INQUIRY_VPD_SERIAL_LEN: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">INQUIRY_VPD_SERIAL_LEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check to see if any active $FABRIC_MOD exports exist.  If they</span>
<span class="cm">	 * do exist, fail here as changing this information on the fly</span>
<span class="cm">	 * (underneath the initiator side OS dependent multipath code)</span>
<span class="cm">	 * could cause negative effects.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to set VPD Unit Serial while&quot;</span>
				<span class="s">&quot; active %d $FABRIC_MOD exports exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * This currently assumes ASCII encoding for emulated VPD Unit Serial.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also, strip any newline added from the userspace</span>
<span class="cm">	 * echo $UUID &gt; $TARGET/$HBA/$STORAGE_OBJECT/wwn/vpd_unit_serial</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INQUIRY_VPD_SERIAL_LEN</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">INQUIRY_VPD_SERIAL_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">unit_serial</span><span class="p">,</span> <span class="n">INQUIRY_VPD_SERIAL_LEN</span><span class="p">,</span>
			<span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">strstrip</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">su_dev_flags</span> <span class="o">|=</span> <span class="n">SDF_EMULATED_VPD_UNIT_SERIAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Set emulated VPD Unit Serial:&quot;</span>
			<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">unit_serial</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_WWN_ATTR</span><span class="p">(</span><span class="n">vpd_unit_serial</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * VPD page 0x83 Protocol Identifier</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_wwn_show_attr_vpd_protocol_identifier</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">t10_wwn</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">t10_wwn</span><span class="o">-&gt;</span><span class="n">t10_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_vpd</span> <span class="o">*</span><span class="n">vpd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">VPD_TMP_BUF_SIZE</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VPD_TMP_BUF_SIZE</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t10_wwn</span><span class="o">-&gt;</span><span class="n">t10_vpd_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vpd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t10_wwn</span><span class="o">-&gt;</span><span class="n">t10_vpd_list</span><span class="p">,</span> <span class="n">vpd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">protocol_identifier_set</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">transport_dump_vpd_proto_id</span><span class="p">(</span><span class="n">vpd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">VPD_TMP_BUF_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t10_wwn</span><span class="o">-&gt;</span><span class="n">t10_vpd_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_wwn_store_attr_vpd_protocol_identifier</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">t10_wwn</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_WWN_ATTR</span><span class="p">(</span><span class="n">vpd_protocol_identifier</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Generic wrapper for dumping VPD identifiers by association.</span>
<span class="cm"> */</span>
<span class="cp">#define DEF_DEV_WWN_ASSOC_SHOW(_name, _assoc)				\</span>
<span class="cp">static ssize_t target_core_dev_wwn_show_attr_##_name(			\</span>
<span class="cp">	struct t10_wwn *t10_wwn,					\</span>
<span class="cp">	char *page)							\</span>
<span class="cp">{									\</span>
<span class="cp">	struct se_subsystem_dev *se_dev = t10_wwn-&gt;t10_sub_dev;		\</span>
<span class="cp">	struct se_device *dev;						\</span>
<span class="cp">	struct t10_vpd *vpd;							\</span>
<span class="cp">	unsigned char buf[VPD_TMP_BUF_SIZE];				\</span>
<span class="cp">	ssize_t len = 0;						\</span>
<span class="cp">									\</span>
<span class="cp">	dev = se_dev-&gt;se_dev_ptr;					\</span>
<span class="cp">	if (!dev)							\</span>
<span class="cp">		return -ENODEV;						\</span>
<span class="cp">									\</span>
<span class="cp">	spin_lock(&amp;t10_wwn-&gt;t10_vpd_lock);				\</span>
<span class="cp">	list_for_each_entry(vpd, &amp;t10_wwn-&gt;t10_vpd_list, vpd_list) {	\</span>
<span class="cp">		if (vpd-&gt;association != _assoc)				\</span>
<span class="cp">			continue;					\</span>
<span class="cp">									\</span>
<span class="cp">		memset(buf, 0, VPD_TMP_BUF_SIZE);			\</span>
<span class="cp">		transport_dump_vpd_assoc(vpd, buf, VPD_TMP_BUF_SIZE);	\</span>
<span class="cp">		if (len + strlen(buf) &gt;= PAGE_SIZE)			\</span>
<span class="cp">			break;						\</span>
<span class="cp">		len += sprintf(page+len, &quot;%s&quot;, buf);			\</span>
<span class="cp">									\</span>
<span class="cp">		memset(buf, 0, VPD_TMP_BUF_SIZE);			\</span>
<span class="cp">		transport_dump_vpd_ident_type(vpd, buf, VPD_TMP_BUF_SIZE); \</span>
<span class="cp">		if (len + strlen(buf) &gt;= PAGE_SIZE)			\</span>
<span class="cp">			break;						\</span>
<span class="cp">		len += sprintf(page+len, &quot;%s&quot;, buf);			\</span>
<span class="cp">									\</span>
<span class="cp">		memset(buf, 0, VPD_TMP_BUF_SIZE);			\</span>
<span class="cp">		transport_dump_vpd_ident(vpd, buf, VPD_TMP_BUF_SIZE); \</span>
<span class="cp">		if (len + strlen(buf) &gt;= PAGE_SIZE)			\</span>
<span class="cp">			break;						\</span>
<span class="cp">		len += sprintf(page+len, &quot;%s&quot;, buf);			\</span>
<span class="cp">	}								\</span>
<span class="cp">	spin_unlock(&amp;t10_wwn-&gt;t10_vpd_lock);				\</span>
<span class="cp">									\</span>
<span class="cp">	return len;							\</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm"> * VPD page 0x83 Association: Logical Unit</span>
<span class="cm"> */</span>
<span class="n">DEF_DEV_WWN_ASSOC_SHOW</span><span class="p">(</span><span class="n">vpd_assoc_logical_unit</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_wwn_store_attr_vpd_assoc_logical_unit</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">t10_wwn</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_WWN_ATTR</span><span class="p">(</span><span class="n">vpd_assoc_logical_unit</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * VPD page 0x83 Association: Target Port</span>
<span class="cm"> */</span>
<span class="n">DEF_DEV_WWN_ASSOC_SHOW</span><span class="p">(</span><span class="n">vpd_assoc_target_port</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_wwn_store_attr_vpd_assoc_target_port</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">t10_wwn</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_WWN_ATTR</span><span class="p">(</span><span class="n">vpd_assoc_target_port</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * VPD page 0x83 Association: SCSI Target Device</span>
<span class="cm"> */</span>
<span class="n">DEF_DEV_WWN_ASSOC_SHOW</span><span class="p">(</span><span class="n">vpd_assoc_scsi_target_device</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_wwn_store_attr_vpd_assoc_scsi_target_device</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">t10_wwn</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_WWN_ATTR</span><span class="p">(</span><span class="n">vpd_assoc_scsi_target_device</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">CONFIGFS_EATTR_OPS</span><span class="p">(</span><span class="n">target_core_dev_wwn</span><span class="p">,</span> <span class="n">t10_wwn</span><span class="p">,</span> <span class="n">t10_wwn_group</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">target_core_dev_wwn_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_wwn_vpd_unit_serial</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_wwn_vpd_protocol_identifier</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_wwn_vpd_assoc_logical_unit</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_wwn_vpd_assoc_target_port</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_wwn_vpd_assoc_scsi_target_device</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_dev_wwn_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show_attribute</span>		<span class="o">=</span> <span class="n">target_core_dev_wwn_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_attribute</span>	<span class="o">=</span> <span class="n">target_core_dev_wwn_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_dev_wwn_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_dev_wwn_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="n">target_core_dev_wwn_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*  End functions for struct config_item_type target_core_dev_wwn_cit */</span>

<span class="cm">/*  Start functions for struct config_item_type target_core_dev_pr_cit */</span>

<span class="n">CONFIGFS_EATTR_STRUCT</span><span class="p">(</span><span class="n">target_core_dev_pr</span><span class="p">,</span> <span class="n">se_subsystem_dev</span><span class="p">);</span>
<span class="cp">#define SE_DEV_PR_ATTR(_name, _mode)					\</span>
<span class="cp">static struct target_core_dev_pr_attribute target_core_dev_pr_##_name = \</span>
<span class="cp">	__CONFIGFS_EATTR(_name, _mode,					\</span>
<span class="cp">	target_core_dev_pr_show_attr_##_name,				\</span>
<span class="cp">	target_core_dev_pr_store_attr_##_name);</span>

<span class="cp">#define SE_DEV_PR_ATTR_RO(_name);					\</span>
<span class="cp">static struct target_core_dev_pr_attribute target_core_dev_pr_##_name =	\</span>
<span class="cp">	__CONFIGFS_EATTR_RO(_name,					\</span>
<span class="cp">	target_core_dev_pr_show_attr_##_name);</span>

<span class="cm">/*</span>
<span class="cm"> * res_holder</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_spc3_res</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">ssize_t</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;No SPC-3 Reservation holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">*</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">se_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

	<span class="o">*</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SPC-3 Reservation: %s Initiator: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_spc2_res</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">ssize_t</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">se_nacl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_nacl</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;No SPC-2 Reservation holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">*</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SPC-2 Reservation: %s Initiator: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_holder</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span>:
		<span class="n">target_core_dev_pr_show_spc3_res</span><span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">,</span>
				<span class="n">page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPC2_RESERVATIONS</span>:
		<span class="n">target_core_dev_pr_show_spc2_res</span><span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">,</span>
				<span class="n">page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPC_PASSTHROUGH</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Passthrough</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_holder</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_pr_all_tgt_pts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_pr_all_tgt_pts</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;No SPC-3 Reservation holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * See All Target Ports (ALL_TG_PT) bit in spcr17, section 6.14.3</span>
<span class="cm">	 * Basic PERSISTENT RESERVER OUT parameter list, page 290</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;SPC-3 Reservation: All Target&quot;</span>
			<span class="s">&quot; Ports registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;SPC-3 Reservation: Single&quot;</span>
			<span class="s">&quot; Target Port registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_pr_all_tgt_pts</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_pr_generation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_pr_generation</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_pr_generation</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_pr_holder_tg_port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_pr_holder_tg_port</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;No SPC-3 Reservation holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">se_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="n">se_tpg</span> <span class="o">=</span> <span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tg_pt_lun</span><span class="p">;</span>
	<span class="n">tfo</span> <span class="o">=</span> <span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SPC-3 Reservation: %s&quot;</span>
		<span class="s">&quot; Target Node Endpoint: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_wwn</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SPC-3 Reservation: Relative Port&quot;</span>
		<span class="s">&quot; Identifer Tag: %hu %s Portal Group Tag: %hu&quot;</span>
		<span class="s">&quot; %s Logical Unit: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span><span class="p">,</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">),</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_pr_holder_tg_port</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_pr_registered_i_pts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_pr_registered_i_pts</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">384</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SPC-3 PR Registrations:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_list</span><span class="p">,</span>
			<span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">384</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
		<span class="n">tfo</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
		<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s Node: %s%s Key: 0x%016Lx PRgen: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">,</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">reg_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg_count</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;None</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_pr_registered_i_pts</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_pr_type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_pr_type</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;No SPC-3 Reservation holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;SPC-3 Reservation Type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_pr_type</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_type</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;SPC3_PERSISTENT_RESERVATIONS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPC2_RESERVATIONS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;SPC2_RESERVATIONS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPC_PASSTHROUGH</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;SPC_PASSTHROUGH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_type</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_aptpl_active</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_aptpl_active</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;APTPL Bit Status: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_aptpl_active</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Activated&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR_RO</span><span class="p">(</span><span class="n">res_aptpl_active</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * res_aptpl_metadata</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_show_attr_res_aptpl_metadata</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Ready to process PR APTPL metadata..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_initiator_fabric</span><span class="p">,</span> <span class="n">Opt_initiator_node</span><span class="p">,</span> <span class="n">Opt_initiator_sid</span><span class="p">,</span>
	<span class="n">Opt_sa_res_key</span><span class="p">,</span> <span class="n">Opt_res_holder</span><span class="p">,</span> <span class="n">Opt_res_type</span><span class="p">,</span> <span class="n">Opt_res_scope</span><span class="p">,</span>
	<span class="n">Opt_res_all_tg_pt</span><span class="p">,</span> <span class="n">Opt_mapped_lun</span><span class="p">,</span> <span class="n">Opt_target_fabric</span><span class="p">,</span>
	<span class="n">Opt_target_node</span><span class="p">,</span> <span class="n">Opt_tpgt</span><span class="p">,</span> <span class="n">Opt_port_rtpi</span><span class="p">,</span> <span class="n">Opt_target_lun</span><span class="p">,</span> <span class="n">Opt_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_initiator_fabric</span><span class="p">,</span> <span class="s">&quot;initiator_fabric=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_initiator_node</span><span class="p">,</span> <span class="s">&quot;initiator_node=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_initiator_sid</span><span class="p">,</span> <span class="s">&quot;initiator_sid=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_sa_res_key</span><span class="p">,</span> <span class="s">&quot;sa_res_key=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_res_holder</span><span class="p">,</span> <span class="s">&quot;res_holder=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_res_type</span><span class="p">,</span> <span class="s">&quot;res_type=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_res_scope</span><span class="p">,</span> <span class="s">&quot;res_scope=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_res_all_tg_pt</span><span class="p">,</span> <span class="s">&quot;res_all_tg_pt=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_mapped_lun</span><span class="p">,</span> <span class="s">&quot;mapped_lun=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_target_fabric</span><span class="p">,</span> <span class="s">&quot;target_fabric=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_target_node</span><span class="p">,</span> <span class="s">&quot;target_node=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_tpgt</span><span class="p">,</span> <span class="s">&quot;tpgt=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_port_rtpi</span><span class="p">,</span> <span class="s">&quot;port_rtpi=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_target_lun</span><span class="p">,</span> <span class="s">&quot;target_lun=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_pr_store_attr_res_aptpl_metadata</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">i_fabric</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">i_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">isid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t_fabric</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">t_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">orig</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">arg_p</span><span class="p">,</span> <span class="o">*</span><span class="n">opts</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tmp_ll</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mapped_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">res_holder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">all_tg_pt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">token</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port_rpti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tpgt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scope</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Unable to process APTPL metadata while&quot;</span>
			<span class="s">&quot; active fabric exports exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opts</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opts</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">orig</span> <span class="o">=</span> <span class="n">opts</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">ptr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_initiator_fabric</span>:
			<span class="n">i_fabric</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_fabric</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_initiator_node</span>:
			<span class="n">i_port</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_port</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">i_port</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PR_APTPL_MAX_IPORT_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;APTPL metadata initiator_node=&quot;</span>
					<span class="s">&quot; exceeds PR_APTPL_MAX_IPORT_LEN: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">PR_APTPL_MAX_IPORT_LEN</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_initiator_sid</span>:
			<span class="n">isid</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">isid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PR_REG_ISID_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;APTPL metadata initiator_isid&quot;</span>
					<span class="s">&quot;= exceeds PR_REG_ISID_LEN: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">PR_REG_ISID_LEN</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sa_res_key</span>:
			<span class="n">arg_p</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg_p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoull</span><span class="p">(</span><span class="n">arg_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_ll</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;strict_strtoull() failed for&quot;</span>
					<span class="s">&quot; sa_res_key=</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sa_res_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">tmp_ll</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * PR APTPL Metadata for Reservation</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">Opt_res_holder</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">res_holder</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_res_type</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_res_scope</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">scope</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_res_all_tg_pt</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">all_tg_pt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mapped_lun</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">mapped_lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * PR APTPL Metadata for Target Port</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">Opt_target_fabric</span>:
			<span class="n">t_fabric</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t_fabric</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_target_node</span>:
			<span class="n">t_port</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t_port</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">t_port</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PR_APTPL_MAX_TPORT_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;APTPL metadata target_node=&quot;</span>
					<span class="s">&quot; exceeds PR_APTPL_MAX_TPORT_LEN: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">PR_APTPL_MAX_TPORT_LEN</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_tpgt</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">tpgt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_port_rtpi</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">port_rpti</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_target_lun</span>:
			<span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">target_lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_port</span> <span class="o">||</span> <span class="o">!</span><span class="n">t_port</span> <span class="o">||</span> <span class="o">!</span><span class="n">sa_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal parameters for APTPL registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_holder</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal PR type: 0x%02x for reservation&quot;</span>
				<span class="s">&quot; holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_alloc_aptpl_registration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">,</span>
			<span class="n">i_port</span><span class="p">,</span> <span class="n">isid</span><span class="p">,</span> <span class="n">mapped_lun</span><span class="p">,</span> <span class="n">t_port</span><span class="p">,</span> <span class="n">tpgt</span><span class="p">,</span> <span class="n">target_lun</span><span class="p">,</span>
			<span class="n">res_holder</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">i_fabric</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">i_port</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isid</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">t_fabric</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">t_port</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_PR_ATTR</span><span class="p">(</span><span class="n">res_aptpl_metadata</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">CONFIGFS_EATTR_OPS</span><span class="p">(</span><span class="n">target_core_dev_pr</span><span class="p">,</span> <span class="n">se_subsystem_dev</span><span class="p">,</span> <span class="n">se_dev_pr_group</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">target_core_dev_pr_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_holder</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_pr_all_tgt_pts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_pr_generation</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_pr_holder_tg_port</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_pr_registered_i_pts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_pr_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_aptpl_active</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_dev_pr_res_aptpl_metadata</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_dev_pr_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show_attribute</span>		<span class="o">=</span> <span class="n">target_core_dev_pr_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_attribute</span>	<span class="o">=</span> <span class="n">target_core_dev_pr_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_dev_pr_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_dev_pr_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="n">target_core_dev_pr_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*  End functions for struct config_item_type target_core_dev_pr_cit */</span>

<span class="cm">/*  Start functions for struct config_item_type target_core_dev_cit */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_show_dev_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_api</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">read_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">transport_dump_dev_state</span><span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bl</span><span class="p">);</span>
	<span class="n">read_bytes</span> <span class="o">+=</span> <span class="n">bl</span><span class="p">;</span>
	<span class="n">read_bytes</span> <span class="o">+=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">show_configfs_dev_params</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">,</span> <span class="n">page</span><span class="o">+</span><span class="n">read_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">read_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="n">target_core_attr_dev_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ca_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_name</span> <span class="o">=</span> <span class="s">&quot;info&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">target_core_show_dev_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_store_dev_control</span><span class="p">(</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_api</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate struct se_subsystem_dev&gt;se&quot;</span>
				<span class="s">&quot;_dev_su_ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">set_configfs_dev_params</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="n">target_core_attr_dev_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ca_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_name</span> <span class="o">=</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_mode</span> <span class="o">=</span> <span class="n">S_IWUSR</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">target_core_store_dev_control</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_show_dev_alias</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">su_dev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_USING_ALIAS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_alias</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_store_dev_alias</span><span class="p">(</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">read_bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">SE_DEV_ALIAS_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;alias count: %d exceeds&quot;</span>
			<span class="s">&quot; SE_DEV_ALIAS_LEN-1: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">,</span>
			<span class="n">SE_DEV_ALIAS_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">read_bytes</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_alias</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SE_DEV_ALIAS_LEN</span><span class="p">,</span>
			<span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_alias</span><span class="p">[</span><span class="n">read_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_alias</span><span class="p">[</span><span class="n">read_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">su_dev_flags</span> <span class="o">|=</span> <span class="n">SDF_USING_ALIAS</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: %s/%s set alias: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_alias</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">read_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="n">target_core_attr_dev_alias</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ca_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_name</span> <span class="o">=</span> <span class="s">&quot;alias&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_mode</span> <span class="o">=</span>  <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">target_core_show_dev_alias</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">target_core_store_dev_alias</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_show_dev_udev_path</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">su_dev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_USING_UDEV_PATH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_udev_path</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_store_dev_udev_path</span><span class="p">(</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">read_bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">SE_UDEV_PATH_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;udev_path count: %d exceeds&quot;</span>
			<span class="s">&quot; SE_UDEV_PATH_LEN-1: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">,</span>
			<span class="n">SE_UDEV_PATH_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">read_bytes</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_udev_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SE_UDEV_PATH_LEN</span><span class="p">,</span>
			<span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_udev_path</span><span class="p">[</span><span class="n">read_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_udev_path</span><span class="p">[</span><span class="n">read_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">su_dev_flags</span> <span class="o">|=</span> <span class="n">SDF_USING_UDEV_PATH</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: %s/%s set udev_path: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_udev_path</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">read_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="n">target_core_attr_dev_udev_path</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ca_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_name</span> <span class="o">=</span> <span class="s">&quot;udev_path&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_mode</span> <span class="o">=</span>  <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">target_core_show_dev_udev_path</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">target_core_store_dev_udev_path</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_store_dev_enable</span><span class="p">(</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_api</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;For dev_enable ops, only valid value&quot;</span>
				<span class="s">&quot; is </span><span class="se">\&quot;</span><span class="s">1</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;se_dev-&gt;se_dev_ptr already set for storage&quot;</span>
				<span class="s">&quot; object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">check_configfs_dev_params</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">create_virtdevice</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">,</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Registered se_dev-&gt;se_dev_ptr:&quot;</span>
		<span class="s">&quot; %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="n">target_core_attr_dev_enable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ca_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_name</span> <span class="o">=</span> <span class="s">&quot;enable&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_mode</span> <span class="o">=</span> <span class="n">S_IWUSR</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">target_core_store_dev_enable</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_show_alua_lu_gp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">lu_ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp_member</span> <span class="o">*</span><span class="n">lu_gp_mem</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">alua_type</span> <span class="o">!=</span> <span class="n">SPC3_ALUA_EMULATED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">lu_gp_mem</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_alua_lu_gp_mem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lu_gp_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;NULL struct se_device-&gt;dev_alua_lu_gp_mem&quot;</span>
				<span class="s">&quot; pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp_mem_lock</span><span class="p">);</span>
	<span class="n">lu_gp</span> <span class="o">=</span> <span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lu_gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lu_ci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;LU Group Alias: %s</span><span class="se">\n</span><span class="s">LU Group ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">config_item_name</span><span class="p">(</span><span class="n">lu_ci</span><span class="p">),</span> <span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp_mem_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_store_alua_lu_gp</span><span class="p">(</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">lu_gp_new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp_member</span> <span class="o">*</span><span class="n">lu_gp_mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LU_GROUP_NAME_BUF</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">move</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">alua_type</span> <span class="o">!=</span> <span class="n">SPC3_ALUA_EMULATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC3_ALUA_EMULATED not enabled for %s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
			<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">LU_GROUP_NAME_BUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ALUA LU Group Alias too large!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LU_GROUP_NAME_BUF</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Any ALUA logical unit alias besides &quot;NULL&quot; means we will be</span>
<span class="cm">	 * making a new group association.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">strstrip</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;NULL&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * core_alua_get_lu_gp_by_name() will increment reference to</span>
<span class="cm">		 * struct t10_alua_lu_gp.  This reference is released with</span>
<span class="cm">		 * core_alua_get_lu_gp_by_name below().</span>
<span class="cm">		 */</span>
		<span class="n">lu_gp_new</span> <span class="o">=</span> <span class="n">core_alua_get_lu_gp_by_name</span><span class="p">(</span><span class="n">strstrip</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lu_gp_new</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lu_gp_mem</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_alua_lu_gp_mem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lu_gp_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lu_gp_new</span><span class="p">)</span>
			<span class="n">core_alua_put_lu_gp_from_name</span><span class="p">(</span><span class="n">lu_gp_new</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;NULL struct se_device-&gt;dev_alua_lu_gp_mem&quot;</span>
				<span class="s">&quot; pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp_mem_lock</span><span class="p">);</span>
	<span class="n">lu_gp</span> <span class="o">=</span> <span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lu_gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clearing an existing lu_gp association, and replacing</span>
<span class="cm">		 * with NULL</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lu_gp_new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Releasing %s/%s&quot;</span>
				<span class="s">&quot; from ALUA LU Group: core/alua/lu_gps/%s, ID:&quot;</span>
				<span class="s">&quot; %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
				<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
				<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
				<span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_id</span><span class="p">);</span>

			<span class="n">__core_alua_drop_lu_gp_mem</span><span class="p">(</span><span class="n">lu_gp_mem</span><span class="p">,</span> <span class="n">lu_gp</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp_mem_lock</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Removing existing association of lu_gp_mem with lu_gp</span>
<span class="cm">		 */</span>
		<span class="n">__core_alua_drop_lu_gp_mem</span><span class="p">(</span><span class="n">lu_gp_mem</span><span class="p">,</span> <span class="n">lu_gp</span><span class="p">);</span>
		<span class="n">move</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Associate lu_gp_mem with lu_gp_new.</span>
<span class="cm">	 */</span>
	<span class="n">__core_alua_attach_lu_gp_mem</span><span class="p">(</span><span class="n">lu_gp_mem</span><span class="p">,</span> <span class="n">lu_gp_new</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp_mem_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: %s %s/%s to ALUA LU Group:&quot;</span>
		<span class="s">&quot; core/alua/lu_gps/%s, ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">move</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Moving&quot;</span> <span class="o">:</span> <span class="s">&quot;Adding&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp_new</span><span class="o">-&gt;</span><span class="n">lu_gp_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">lu_gp_new</span><span class="o">-&gt;</span><span class="n">lu_gp_id</span><span class="p">);</span>

	<span class="n">core_alua_put_lu_gp_from_name</span><span class="p">(</span><span class="n">lu_gp_new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="n">target_core_attr_dev_alua_lu_gp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ca_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_name</span> <span class="o">=</span> <span class="s">&quot;alua_lu_gp&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ca_mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">target_core_show_alua_lu_gp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">target_core_store_alua_lu_gp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">lio_core_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_attr_dev_info</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_attr_dev_control</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_attr_dev_alias</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_attr_dev_udev_path</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_attr_dev_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_attr_dev_alua_lu_gp</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
				<span class="k">struct</span> <span class="n">se_subsystem_dev</span><span class="p">,</span> <span class="n">se_dev_group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">item_to_hba</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">se_subsystem_api</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">dev_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * This pointer will set when the storage is enabled with:</span>
<span class="cm">	 *`echo 1 &gt; $CONFIGFS/core/$HBA/$DEV/dev_enable`</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Calling se_free_&quot;</span>
			<span class="s">&quot;virtual_device() for se_dev_ptr: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">);</span>

		<span class="n">se_free_virtual_device</span><span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">,</span> <span class="n">hba</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Release struct se_subsystem_dev-&gt;se_dev_su_ptr..</span>
<span class="cm">		 */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Calling t-&gt;free_&quot;</span>
			<span class="s">&quot;device() for se_dev_su_ptr: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">);</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">free_device</span><span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Deallocating se_subsystem&quot;</span>
			<span class="s">&quot;_dev_t: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">se_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span>
			<span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="k">struct</span> <span class="n">se_subsystem_dev</span><span class="p">,</span>
			<span class="n">se_dev_group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="o">*</span><span class="n">tc_attr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span>
			<span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc_attr</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tc_attr</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_dev_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span>
			<span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="k">struct</span> <span class="n">se_subsystem_dev</span><span class="p">,</span>
			<span class="n">se_dev_group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">target_core_configfs_attribute</span> <span class="o">*</span><span class="n">tc_attr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span>
			<span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">target_core_configfs_attribute</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc_attr</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tc_attr</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_dev_item_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">target_core_dev_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_attribute</span>		<span class="o">=</span> <span class="n">target_core_dev_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_attribute</span>	<span class="o">=</span> <span class="n">target_core_dev_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_dev_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_dev_item_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="n">lio_core_dev_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_dev_cit */</span>

<span class="cm">/* Start functions for struct config_item_type target_core_alua_lu_gp_cit */</span>

<span class="n">CONFIGFS_EATTR_STRUCT</span><span class="p">(</span><span class="n">target_core_alua_lu_gp</span><span class="p">,</span> <span class="n">t10_alua_lu_gp</span><span class="p">);</span>
<span class="cp">#define SE_DEV_ALUA_LU_ATTR(_name, _mode)				\</span>
<span class="cp">static struct target_core_alua_lu_gp_attribute				\</span>
<span class="cp">			target_core_alua_lu_gp_##_name =		\</span>
<span class="cp">	__CONFIGFS_EATTR(_name, _mode,					\</span>
<span class="cp">	target_core_alua_lu_gp_show_attr_##_name,			\</span>
<span class="cp">	target_core_alua_lu_gp_store_attr_##_name);</span>

<span class="cp">#define SE_DEV_ALUA_LU_ATTR_RO(_name)					\</span>
<span class="cp">static struct target_core_alua_lu_gp_attribute				\</span>
<span class="cp">			target_core_alua_lu_gp_##_name =		\</span>
<span class="cp">	__CONFIGFS_EATTR_RO(_name,					\</span>
<span class="cp">	target_core_alua_lu_gp_show_attr_##_name);</span>

<span class="cm">/*</span>
<span class="cm"> * lu_gp_id</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_lu_gp_show_attr_lu_gp_id</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_valid_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_lu_gp_store_attr_lu_gp_id</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">alua_lu_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_group</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lu_gp_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lu_gp_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;strict_strtoul() returned %d for&quot;</span>
			<span class="s">&quot; lu_gp_id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lu_gp_id</span> <span class="o">&gt;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ALUA lu_gp_id: %lu exceeds maximum:&quot;</span>
			<span class="s">&quot; 0x0000ffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lu_gp_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_alua_set_lu_gp_id</span><span class="p">(</span><span class="n">lu_gp</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">lu_gp_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Set ALUA Logical Unit&quot;</span>
		<span class="s">&quot; Group: core/alua/lu_gps/%s to ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alua_lu_gp_cg</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_LU_ATTR</span><span class="p">(</span><span class="n">lu_gp_id</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * members</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_lu_gp_show_attr_members</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp_member</span> <span class="o">*</span><span class="n">lu_gp_mem</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LU_GROUP_NAME_BUF</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LU_GROUP_NAME_BUF</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lu_gp_mem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_mem_list</span><span class="p">,</span> <span class="n">lu_gp_mem_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">lu_gp_mem</span><span class="o">-&gt;</span><span class="n">lu_gp_mem_dev</span><span class="p">;</span>
		<span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
		<span class="n">hba</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="p">;</span>

		<span class="n">cur_len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">LU_GROUP_NAME_BUF</span><span class="p">,</span> <span class="s">&quot;%s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">),</span>
			<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">));</span>
		<span class="n">cur_len</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Extra byte for NULL terminator */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cur_len</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Ran out of lu_gp_show_attr&quot;</span>
				<span class="s">&quot;_members buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">cur_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_LU_ATTR_RO</span><span class="p">(</span><span class="n">members</span><span class="p">);</span>

<span class="n">CONFIGFS_EATTR_OPS</span><span class="p">(</span><span class="n">target_core_alua_lu_gp</span><span class="p">,</span> <span class="n">t10_alua_lu_gp</span><span class="p">,</span> <span class="n">lu_gp_group</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">target_core_alua_lu_gp_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_lu_gp_lu_gp_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_lu_gp_members</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_alua_lu_gp_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
			<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span><span class="p">,</span> <span class="n">lu_gp_group</span><span class="p">);</span>

	<span class="n">core_alua_free_lu_gp</span><span class="p">(</span><span class="n">lu_gp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_alua_lu_gp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">target_core_alua_lu_gp_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_attribute</span>		<span class="o">=</span> <span class="n">target_core_alua_lu_gp_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_attribute</span>	<span class="o">=</span> <span class="n">target_core_alua_lu_gp_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_alua_lu_gp_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_lu_gp_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="n">target_core_alua_lu_gp_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_alua_lu_gp_cit */</span>

<span class="cm">/* Start functions for struct config_item_type target_core_alua_lu_gps_cit */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="nf">target_core_alua_create_lu_gp</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">alua_lu_gp_cg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">alua_lu_gp_ci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lu_gp</span> <span class="o">=</span> <span class="n">core_alua_allocate_lu_gp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lu_gp</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">alua_lu_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_group</span><span class="p">;</span>
	<span class="n">alua_lu_gp_ci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_lu_gp_cg</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="n">alua_lu_gp_cg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_core_alua_lu_gp_cit</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Allocated ALUA Logical Unit&quot;</span>
		<span class="s">&quot; Group: core/alua/lu_gps/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="n">alua_lu_gp_ci</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">alua_lu_gp_cg</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_alua_drop_lu_gp</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
			<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span><span class="p">,</span> <span class="n">lu_gp_group</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Releasing ALUA Logical Unit&quot;</span>
		<span class="s">&quot; Group: core/alua/lu_gps/%s, ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_id</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * core_alua_free_lu_gp() is called from target_core_alua_lu_gp_ops-&gt;release()</span>
<span class="cm">	 * -&gt; target_core_alua_lu_gp_release()</span>
<span class="cm">	 */</span>
	<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_group_operations</span> <span class="n">target_core_alua_lu_gps_group_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">make_group</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_create_lu_gp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_item</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_drop_lu_gp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_alua_lu_gps_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_group_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_lu_gps_group_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_alua_lu_gps_cit */</span>

<span class="cm">/* Start functions for struct config_item_type target_core_alua_tg_pt_gp_cit */</span>

<span class="n">CONFIGFS_EATTR_STRUCT</span><span class="p">(</span><span class="n">target_core_alua_tg_pt_gp</span><span class="p">,</span> <span class="n">t10_alua_tg_pt_gp</span><span class="p">);</span>
<span class="cp">#define SE_DEV_ALUA_TG_PT_ATTR(_name, _mode)				\</span>
<span class="cp">static struct target_core_alua_tg_pt_gp_attribute			\</span>
<span class="cp">			target_core_alua_tg_pt_gp_##_name =		\</span>
<span class="cp">	__CONFIGFS_EATTR(_name, _mode,					\</span>
<span class="cp">	target_core_alua_tg_pt_gp_show_attr_##_name,			\</span>
<span class="cp">	target_core_alua_tg_pt_gp_store_attr_##_name);</span>

<span class="cp">#define SE_DEV_ALUA_TG_PT_ATTR_RO(_name)				\</span>
<span class="cp">static struct target_core_alua_tg_pt_gp_attribute			\</span>
<span class="cp">			target_core_alua_tg_pt_gp_##_name =		\</span>
<span class="cp">	__CONFIGFS_EATTR_RO(_name,					\</span>
<span class="cp">	target_core_alua_tg_pt_gp_show_attr_##_name);</span>

<span class="cm">/*</span>
<span class="cm"> * alua_access_state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_alua_access_state</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_alua_access_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_alua_access_state</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_su_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_valid_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to do implict ALUA on non valid&quot;</span>
			<span class="s">&quot; tg_pt_gp ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_valid_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to extract new ALUA access state from&quot;</span>
				<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_state</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_alua_access_type</span> <span class="o">&amp;</span> <span class="n">TPGS_IMPLICT_ALUA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to process implict configfs ALUA&quot;</span>
			<span class="s">&quot; transition while TPGS_IMPLICT_ALUA is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_alua_do_port_transition</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">alua_access_state</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * alua_access_status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_alua_access_status</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">core_alua_dump_status</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_alua_access_status</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_alua_access_status</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_status</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_valid_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to do set ALUA access status on non&quot;</span>
			<span class="s">&quot; valid tg_pt_gp ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_valid_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to extract new ALUA access status&quot;</span>
				<span class="s">&quot; from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_status</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_status</span> <span class="o">!=</span> <span class="n">ALUA_STATUS_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">new_status</span> <span class="o">!=</span> <span class="n">ALUA_STATUS_ALTERED_BY_EXPLICT_STPG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">new_status</span> <span class="o">!=</span> <span class="n">ALUA_STATUS_ALTERED_BY_IMPLICT_ALUA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal ALUA access status: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">new_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_alua_access_status</span> <span class="o">=</span> <span class="n">new_status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">alua_access_status</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * alua_access_type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_alua_access_type</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_show_access_type</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_alua_access_type</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_store_access_type</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">alua_access_type</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * alua_write_metadata</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_alua_write_metadata</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_write_metadata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_alua_write_metadata</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to extract alua_write_metadata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value for alua_write_metadata:&quot;</span>
			<span class="s">&quot; %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_write_metadata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">alua_write_metadata</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>



<span class="cm">/*</span>
<span class="cm"> * nonop_delay_msecs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_nonop_delay_msecs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_show_nonop_delay_msecs</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_nonop_delay_msecs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_store_nonop_delay_msecs</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">nonop_delay_msecs</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * trans_delay_msecs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_trans_delay_msecs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_show_trans_delay_msecs</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_trans_delay_msecs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_store_trans_delay_msecs</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">trans_delay_msecs</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * implict_trans_secs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_implict_trans_secs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_show_implict_trans_secs</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_implict_trans_secs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_store_implict_trans_secs</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">implict_trans_secs</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * preferred</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_preferred</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_show_preferred_bit</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_preferred</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">core_alua_store_preferred_bit</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">preferred</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tg_pt_gp_id</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_tg_pt_gp_id</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_valid_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_store_attr_tg_pt_gp_id</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">alua_tg_pt_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_group</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tg_pt_gp_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tg_pt_gp_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;strict_strtoul() returned %d for&quot;</span>
			<span class="s">&quot; tg_pt_gp_id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg_pt_gp_id</span> <span class="o">&gt;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ALUA tg_pt_gp_id: %lu exceeds maximum:&quot;</span>
			<span class="s">&quot; 0x0000ffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tg_pt_gp_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_alua_set_tg_pt_gp_id</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">tg_pt_gp_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Set ALUA Target Port Group: &quot;</span>
		<span class="s">&quot;core/alua/tg_pt_gps/%s to ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alua_tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">),</span>
		<span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR</span><span class="p">(</span><span class="n">tg_pt_gp_id</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * members</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_alua_tg_pt_gp_show_attr_members</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp_member</span> <span class="o">*</span><span class="n">tg_pt_gp_mem</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">TG_PT_GROUP_NAME_BUF</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG_PT_GROUP_NAME_BUF</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tg_pt_gp_mem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_mem_list</span><span class="p">,</span>
			<span class="n">tg_pt_gp_mem_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">tg_pt_gp_mem</span><span class="o">-&gt;</span><span class="n">tg_pt</span><span class="p">;</span>
		<span class="n">tpg</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tpg</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_lun</span><span class="p">;</span>

		<span class="n">cur_len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">TG_PT_GROUP_NAME_BUF</span><span class="p">,</span> <span class="s">&quot;%s/%s/tpgt_%hu&quot;</span>
			<span class="s">&quot;/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_wwn</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span>
			<span class="n">config_item_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">));</span>
		<span class="n">cur_len</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Extra byte for NULL terminator */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cur_len</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Ran out of lu_gp_show_attr&quot;</span>
				<span class="s">&quot;_members buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">cur_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_DEV_ALUA_TG_PT_ATTR_RO</span><span class="p">(</span><span class="n">members</span><span class="p">);</span>

<span class="n">CONFIGFS_EATTR_OPS</span><span class="p">(</span><span class="n">target_core_alua_tg_pt_gp</span><span class="p">,</span> <span class="n">t10_alua_tg_pt_gp</span><span class="p">,</span>
			<span class="n">tg_pt_gp_group</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">target_core_alua_tg_pt_gp_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_alua_access_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_alua_access_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_alua_access_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_alua_write_metadata</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_nonop_delay_msecs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_trans_delay_msecs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_implict_trans_secs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_preferred</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_tg_pt_gp_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_members</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_alua_tg_pt_gp_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
			<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span><span class="p">,</span> <span class="n">tg_pt_gp_group</span><span class="p">);</span>

	<span class="n">core_alua_free_tg_pt_gp</span><span class="p">(</span><span class="n">tg_pt_gp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_alua_tg_pt_gp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">target_core_alua_tg_pt_gp_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_attribute</span>		<span class="o">=</span> <span class="n">target_core_alua_tg_pt_gp_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_attribute</span>	<span class="o">=</span> <span class="n">target_core_alua_tg_pt_gp_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_alua_tg_pt_gp_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="n">target_core_alua_tg_pt_gp_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_alua_tg_pt_gp_cit */</span>

<span class="cm">/* Start functions for struct config_item_type target_core_alua_tg_pt_gps_cit */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="nf">target_core_alua_create_tg_pt_gp</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_alua</span> <span class="o">*</span><span class="n">alua</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t10_alua</span><span class="p">,</span>
					<span class="n">alua_tg_pt_gps_group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">alua</span><span class="o">-&gt;</span><span class="n">t10_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">alua_tg_pt_gp_cg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">alua_tg_pt_gp_ci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tg_pt_gp</span> <span class="o">=</span> <span class="n">core_alua_allocate_tg_pt_gp</span><span class="p">(</span><span class="n">su_dev</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg_pt_gp</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">alua_tg_pt_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_group</span><span class="p">;</span>
	<span class="n">alua_tg_pt_gp_ci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="n">alua_tg_pt_gp_cg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_cit</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Allocated ALUA Target Port&quot;</span>
		<span class="s">&quot; Group: alua/tg_pt_gps/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="n">alua_tg_pt_gp_ci</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">alua_tg_pt_gp_cg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_alua_drop_tg_pt_gp</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
			<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span><span class="p">,</span> <span class="n">tg_pt_gp_group</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Releasing ALUA Target Port&quot;</span>
		<span class="s">&quot; Group: alua/tg_pt_gps/%s, ID: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">config_item_name</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_id</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * core_alua_free_tg_pt_gp() is called from target_core_alua_tg_pt_gp_ops-&gt;release()</span>
<span class="cm">	 * -&gt; target_core_alua_tg_pt_gp_release().</span>
<span class="cm">	 */</span>
	<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_group_operations</span> <span class="n">target_core_alua_tg_pt_gps_group_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">make_group</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_create_tg_pt_gp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_item</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_drop_tg_pt_gp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_alua_tg_pt_gps_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_group_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gps_group_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_alua_tg_pt_gps_cit */</span>

<span class="cm">/* Start functions for struct config_item_type target_core_alua_cit */</span>

<span class="cm">/*</span>
<span class="cm"> * target_core_alua_cit is a ConfigFS group that lives under</span>
<span class="cm"> * /sys/kernel/config/target/core/alua.  There are default groups</span>
<span class="cm"> * core/alua/lu_gps and core/alua/tg_pt_gps that are attached to</span>
<span class="cm"> * target_core_alua_cit in target_core_init_configfs() below.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_alua_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_alua_cit */</span>

<span class="cm">/* Start functions for struct config_item_type target_core_stat_cit */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="nf">target_core_stat_mkdir</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_stat_rmdir</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_group_operations</span> <span class="n">target_core_stat_group_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">make_group</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_stat_mkdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_item</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_stat_rmdir</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_stat_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_group_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_stat_group_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* End functions for struct config_item_type target_core_stat_cit */</span>

<span class="cm">/* Start functions for struct config_item_type target_core_hba_cit */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="nf">target_core_make_subdev</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp</span> <span class="o">*</span><span class="n">tg_pt_gp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_api</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">hba_ci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">item_to_hba</span><span class="p">(</span><span class="n">hba_ci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">dev_cg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tg_pt_gp_cg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">dev_stat_grp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_access_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Locate the struct se_subsystem_api from parent&#39;s struct se_hba.</span>
<span class="cm">	 */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="p">;</span>

	<span class="n">se_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_subsystem_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for&quot;</span>
				<span class="s">&quot; struct se_subsystem_dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_vpd_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_vpd_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">aptpl_reg_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">tg_pt_gps_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">tg_pt_gps_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_lock</span><span class="p">);</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_aptpl_buf_len</span> <span class="o">=</span> <span class="n">PR_APTPL_BUF_LEN</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_sub_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">t10_sub_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">da_sub_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="p">;</span>

	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>
	<span class="n">dev_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">;</span>

	<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_group</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set se_dev_su_ptr from struct se_subsystem_api returned void ptr</span>
<span class="cm">	 * for -&gt;allocate_virtdevice()</span>
<span class="cm">	 *</span>
<span class="cm">	 * se_dev-&gt;se_dev_ptr will be set after -&gt;create_virtdev()</span>
<span class="cm">	 * has been called successfully in the next level up in the</span>
<span class="cm">	 * configfs tree for device object&#39;s struct config_group.</span>
<span class="cm">	 */</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">allocate_virtdevice</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate subsystem dependent pointer&quot;</span>
			<span class="s">&quot; from allocate_virtdevice()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_core_dev_cit</span><span class="p">);</span>
	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">da_group</span><span class="p">,</span> <span class="s">&quot;attrib&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_core_dev_attrib_cit</span><span class="p">);</span>
	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_pr_group</span><span class="p">,</span> <span class="s">&quot;pr&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_core_dev_pr_cit</span><span class="p">);</span>
	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_wwn_group</span><span class="p">,</span> <span class="s">&quot;wwn&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_core_dev_wwn_cit</span><span class="p">);</span>
	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">alua_tg_pt_gps_group</span><span class="p">,</span>
			<span class="s">&quot;alua&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gps_cit</span><span class="p">);</span>
	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_stat_grps</span><span class="p">.</span><span class="n">stat_group</span><span class="p">,</span>
			<span class="s">&quot;statistics&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_core_stat_cit</span><span class="p">);</span>

	<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">da_group</span><span class="p">;</span>
	<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_pr_group</span><span class="p">;</span>
	<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_wwn_group</span><span class="p">;</span>
	<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">alua_tg_pt_gps_group</span><span class="p">;</span>
	<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_stat_grps</span><span class="p">.</span><span class="n">stat_group</span><span class="p">;</span>
	<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Add core/$HBA/$DEV/alua/default_tg_pt_gp</span>
<span class="cm">	 */</span>
	<span class="n">tg_pt_gp</span> <span class="o">=</span> <span class="n">core_alua_allocate_tg_pt_gp</span><span class="p">(</span><span class="n">se_dev</span><span class="p">,</span> <span class="s">&quot;default_tg_pt_gp&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg_pt_gp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tg_pt_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">alua_tg_pt_gps_group</span><span class="p">;</span>
	<span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_group</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate tg_pt_gp_cg-&gt;&quot;</span>
				<span class="s">&quot;default_groups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_group</span><span class="p">,</span>
			<span class="s">&quot;default_tg_pt_gp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_core_alua_tg_pt_gp_cit</span><span class="p">);</span>
	<span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg_pt_gp</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_group</span><span class="p">;</span>
	<span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">default_tg_pt_gp</span> <span class="o">=</span> <span class="n">tg_pt_gp</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Add core/$HBA/$DEV/statistics/ default groups</span>
<span class="cm">	 */</span>
	<span class="n">dev_stat_grp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_stat_grps</span><span class="p">.</span><span class="n">stat_group</span><span class="p">;</span>
	<span class="n">dev_stat_grp</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_group</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_stat_grp</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate dev_stat_grp-&gt;default_groups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">target_stat_setup_dev_default_groups</span><span class="p">(</span><span class="n">se_dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Target_Core_ConfigFS: Allocated struct se_subsystem_dev:&quot;</span>
		<span class="s">&quot; %p se_dev_su_ptr: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">,</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_access_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">default_tg_pt_gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core_alua_free_tg_pt_gp</span><span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">default_tg_pt_gp</span><span class="p">);</span>
		<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">default_tg_pt_gp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_stat_grp</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev_stat_grp</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg_pt_gp_cg</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_cg</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">free_device</span><span class="p">(</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">se_dev</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_access_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">errno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_drop_subdev</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
				<span class="k">struct</span> <span class="n">se_subsystem_dev</span><span class="p">,</span> <span class="n">se_dev_group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">df_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">dev_cg</span><span class="p">,</span> <span class="o">*</span><span class="n">tg_pt_gp_cg</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_stat_grp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">item_to_hba</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_access_mutex</span><span class="p">);</span>

	<span class="n">dev_stat_grp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_stat_grps</span><span class="p">.</span><span class="n">stat_group</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dev_stat_grp</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">df_item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_stat_grp</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">dev_stat_grp</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">config_item_put</span><span class="p">(</span><span class="n">df_item</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_stat_grp</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>

	<span class="n">tg_pt_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">alua_tg_pt_gps_group</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">df_item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">config_item_put</span><span class="p">(</span><span class="n">df_item</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tg_pt_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * core_alua_free_tg_pt_gp() is called from -&gt;default_tg_pt_gp</span>
<span class="cm">	 * directly from target_core_alua_tg_pt_gp_release().</span>
<span class="cm">	 */</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">default_tg_pt_gp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_group</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">df_item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">dev_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">config_item_put</span><span class="p">(</span><span class="n">df_item</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The releasing of se_dev and associated se_dev-&gt;se_dev_ptr is done</span>
<span class="cm">	 * from target_core_dev_item_ops-&gt;release() -&gt;target_core_dev_release().</span>
<span class="cm">	 */</span>
	<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_access_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_group_operations</span> <span class="n">target_core_hba_group_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">make_group</span>		<span class="o">=</span> <span class="n">target_core_make_subdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_item</span>		<span class="o">=</span> <span class="n">target_core_drop_subdev</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">CONFIGFS_EATTR_STRUCT</span><span class="p">(</span><span class="n">target_core_hba</span><span class="p">,</span> <span class="n">se_hba</span><span class="p">);</span>
<span class="cp">#define SE_HBA_ATTR(_name, _mode)				\</span>
<span class="cp">static struct target_core_hba_attribute				\</span>
<span class="cp">		target_core_hba_##_name =			\</span>
<span class="cp">		__CONFIGFS_EATTR(_name, _mode,			\</span>
<span class="cp">		target_core_hba_show_attr_##_name,		\</span>
<span class="cp">		target_core_hba_store_attr_##_name);</span>

<span class="cp">#define SE_HBA_ATTR_RO(_name)					\</span>
<span class="cp">static struct target_core_hba_attribute				\</span>
<span class="cp">		target_core_hba_##_name =			\</span>
<span class="cp">		__CONFIGFS_EATTR_RO(_name,			\</span>
<span class="cp">		target_core_hba_show_attr_##_name);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_hba_show_attr_hba_info</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;HBA Index: %d plugin: %s version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_id</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">TARGET_CORE_CONFIGFS_VERSION</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SE_HBA_ATTR_RO</span><span class="p">(</span><span class="n">hba_info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_hba_show_attr_hba_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hba_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_flags</span> <span class="o">&amp;</span> <span class="n">HBA_FLAGS_PSCSI_MODE</span><span class="p">)</span>
		<span class="n">hba_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hba_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">target_core_hba_store_attr_hba_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_api</span> <span class="o">*</span><span class="n">transport</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">pmode_enable_hba</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to extract hba mode flag: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_dev_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to set hba_mode with active devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">transport</span><span class="o">-&gt;</span><span class="n">pmode_enable_hba</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">mode_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_flags</span> <span class="o">|=</span> <span class="n">HBA_FLAGS_PSCSI_MODE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HBA_FLAGS_PSCSI_MODE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SE_HBA_ATTR</span><span class="p">(</span><span class="n">hba_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">CONFIGFS_EATTR_OPS</span><span class="p">(</span><span class="n">target_core_hba</span><span class="p">,</span> <span class="n">se_hba</span><span class="p">,</span> <span class="n">hba_group</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_hba_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_config_group</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
				<span class="k">struct</span> <span class="n">se_hba</span><span class="p">,</span> <span class="n">hba_group</span><span class="p">);</span>
	<span class="n">core_delete_hba</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">target_core_hba_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">target_core_hba_hba_info</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">target_core_hba_hba_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_item_operations</span> <span class="n">target_core_hba_item_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">target_core_hba_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_attribute</span>		<span class="o">=</span> <span class="n">target_core_hba_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_attribute</span>	<span class="o">=</span> <span class="n">target_core_hba_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_hba_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_hba_item_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_group_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_hba_group_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>		<span class="o">=</span> <span class="n">target_core_hba_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="nf">target_core_call_addhbatotarget</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">se_plugin_str</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">str2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">TARGET_CORE_NAME_MAX_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">plugin_dep_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TARGET_CORE_NAME_MAX_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TARGET_CORE_NAME_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Passed *name strlen(): %d exceeds&quot;</span>
			<span class="s">&quot; TARGET_CORE_NAME_MAX_LEN: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
			<span class="n">TARGET_CORE_NAME_MAX_LEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">TARGET_CORE_NAME_MAX_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate </span><span class="se">\&quot;</span><span class="s">_</span><span class="se">\&quot;</span><span class="s"> for $SUBSYSTEM_PLUGIN_$HOST_ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">se_plugin_str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Special case for subsystem plugins that have &quot;_&quot; in their names.</span>
<span class="cm">	 * Namely rd_direct and rd_mcp..</span>
<span class="cm">	 */</span>
	<span class="n">str2</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">str</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">str2</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* Terminate for *se_plugin_str */</span>
		<span class="n">str2</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Skip to start of plugin dependent ID */</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">str2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* Terminate for *se_plugin_str */</span>
		<span class="n">str</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Skip to start of plugin dependent ID */</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plugin_dep_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;strict_strtoul() returned %d for&quot;</span>
				<span class="s">&quot; plugin_dep_id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Load up TCM subsystem plugins if they have not already been loaded.</span>
<span class="cm">	 */</span>
	<span class="n">transport_subsystem_check_init</span><span class="p">();</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">core_alloc_hba</span><span class="p">(</span><span class="n">se_plugin_str</span><span class="p">,</span> <span class="n">plugin_dep_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_core_hba_cit</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_group</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">target_core_call_delhbafromtarget</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * core_delete_hba() is called from target_core_hba_item_ops-&gt;release()</span>
<span class="cm">	 * -&gt; target_core_hba_release()</span>
<span class="cm">	 */</span>
	<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_group_operations</span> <span class="n">target_core_group_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">make_group</span>	<span class="o">=</span> <span class="n">target_core_call_addhbatotarget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_item</span>	<span class="o">=</span> <span class="n">target_core_call_delhbafromtarget</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">config_item_type</span> <span class="n">target_core_cit</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_item_ops</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_group_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_group_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_attrs</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Stop functions for struct config_item_type target_core_hba_cit */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">target_core_init_configfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">target_cg</span><span class="p">,</span> <span class="o">*</span><span class="n">hba_cg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">alua_cg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">lu_gp_cg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">configfs_subsystem</span> <span class="o">*</span><span class="n">subsys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_lu_gp</span> <span class="o">*</span><span class="n">lu_gp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TARGET_CORE[0]: Loading Generic Kernel Storage&quot;</span>
		<span class="s">&quot; Engine: %s on %s/%s on &quot;</span><span class="n">UTS_RELEASE</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">TARGET_CORE_VERSION</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">machine</span><span class="p">);</span>

	<span class="n">subsys</span> <span class="o">=</span> <span class="n">target_core_subsystem</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">config_group_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">su_group</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">su_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_se_kmem_caches</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Create $CONFIGFS/target/core default group for HBA &lt;-&gt; Storage Object</span>
<span class="cm">	 * and ALUA Logical Unit Group and Target Port Group infrastructure.</span>
<span class="cm">	 */</span>
	<span class="n">target_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">su_group</span><span class="p">;</span>
	<span class="n">target_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_group</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate target_cg-&gt;default_groups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_global</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target_core_hbagroup</span><span class="p">,</span>
			<span class="s">&quot;core&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_core_cit</span><span class="p">);</span>
	<span class="n">target_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_hbagroup</span><span class="p">;</span>
	<span class="n">target_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Create ALUA infrastructure under /sys/kernel/config/target/core/alua/</span>
<span class="cm">	 */</span>
	<span class="n">hba_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_hbagroup</span><span class="p">;</span>
	<span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_group</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate hba_cg-&gt;default_groups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_global</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alua_group</span><span class="p">,</span>
			<span class="s">&quot;alua&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_core_alua_cit</span><span class="p">);</span>
	<span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_group</span><span class="p">;</span>
	<span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Add ALUA Logical Unit Group and Target Port Group ConfigFS</span>
<span class="cm">	 * groups under /sys/kernel/config/target/core/alua/</span>
<span class="cm">	 */</span>
	<span class="n">alua_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_group</span><span class="p">;</span>
	<span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_group</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate alua_cg-&gt;default_groups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_global</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alua_lu_gps_group</span><span class="p">,</span>
			<span class="s">&quot;lu_gps&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_core_alua_lu_gps_cit</span><span class="p">);</span>
	<span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_lu_gps_group</span><span class="p">;</span>
	<span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Add core/alua/lu_gps/default_lu_gp</span>
<span class="cm">	 */</span>
	<span class="n">lu_gp</span> <span class="o">=</span> <span class="n">core_alua_allocate_lu_gp</span><span class="p">(</span><span class="s">&quot;default_lu_gp&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lu_gp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_global</span><span class="p">;</span>

	<span class="n">lu_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_lu_gps_group</span><span class="p">;</span>
	<span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_group</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate lu_gp_cg-&gt;default_groups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_global</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config_group_init_type_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_group</span><span class="p">,</span> <span class="s">&quot;default_lu_gp&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">target_core_alua_lu_gp_cit</span><span class="p">);</span>
	<span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lu_gp</span><span class="o">-&gt;</span><span class="n">lu_gp_group</span><span class="p">;</span>
	<span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">default_lu_gp</span> <span class="o">=</span> <span class="n">lu_gp</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Register the target_core_mod subsystem with configfs.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">configfs_register_subsystem</span><span class="p">(</span><span class="n">subsys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error %d while registering subsystem %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">,</span> <span class="n">subsys</span><span class="o">-&gt;</span><span class="n">su_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">.</span><span class="n">ci_namebuf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_global</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TARGET_CORE[0]: Initialized ConfigFS Fabric&quot;</span>
		<span class="s">&quot; Infrastructure: &quot;</span><span class="n">TARGET_CORE_CONFIGFS_VERSION</span><span class="s">&quot; on %s/%s&quot;</span>
		<span class="s">&quot; on &quot;</span><span class="n">UTS_RELEASE</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">machine</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Register built-in RAMDISK subsystem logic for virtual LUN 0</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rd_module_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core_dev_setup_virtual_lun0</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">configfs_unregister_subsystem</span><span class="p">(</span><span class="n">subsys</span><span class="p">);</span>
	<span class="n">core_dev_release_virtual_lun0</span><span class="p">();</span>
	<span class="n">rd_module_exit</span><span class="p">();</span>
<span class="nl">out_global:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_lu_gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core_alua_free_lu_gp</span><span class="p">(</span><span class="n">default_lu_gp</span><span class="p">);</span>
		<span class="n">default_lu_gp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lu_gp_cg</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alua_cg</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba_cg</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">target_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="n">release_se_kmem_caches</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">target_core_exit_configfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">configfs_subsystem</span> <span class="o">*</span><span class="n">subsys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">hba_cg</span><span class="p">,</span> <span class="o">*</span><span class="n">alua_cg</span><span class="p">,</span> <span class="o">*</span><span class="n">lu_gp_cg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">subsys</span> <span class="o">=</span> <span class="n">target_core_subsystem</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">lu_gp_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_lu_gps_group</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="n">lu_gp_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">alua_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_group</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="n">alua_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hba_cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_core_hbagroup</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cg_item</span><span class="p">;</span>
		<span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">config_item_put</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span><span class="p">);</span>
	<span class="n">hba_cg</span><span class="o">-&gt;</span><span class="n">default_groups</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We expect subsys-&gt;su_group.default_groups to be released</span>
<span class="cm">	 * by configfs subsystem provider logic..</span>
<span class="cm">	 */</span>
	<span class="n">configfs_unregister_subsystem</span><span class="p">(</span><span class="n">subsys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">su_group</span><span class="p">.</span><span class="n">default_groups</span><span class="p">);</span>

	<span class="n">core_alua_free_lu_gp</span><span class="p">(</span><span class="n">default_lu_gp</span><span class="p">);</span>
	<span class="n">default_lu_gp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TARGET_CORE[0]: Released ConfigFS Fabric&quot;</span>
			<span class="s">&quot; Infrastructure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">core_dev_release_virtual_lun0</span><span class="p">();</span>
	<span class="n">rd_module_exit</span><span class="p">();</span>
	<span class="n">release_se_kmem_caches</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Target_Core_Mod/ConfigFS&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;nab@Linux-iSCSI.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">target_core_init_configfs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">target_core_exit_configfs</span><span class="p">);</span>

</pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Start functions called by external Target Fabrics Modules</p>

<h6>######################################################################*/</h6></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Stop functions called by external Target Fabrics Modules</p>

<h6>######################################################################*/</h6></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
