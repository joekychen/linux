<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › target › iscsi › iscsi_target_core.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>iscsi_target_core.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef ISCSI_TARGET_CORE_H</span>
<span class="cp">#define ISCSI_TARGET_CORE_H</span>

<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/configfs.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/iscsi_proto.h&gt;</span>
<span class="cp">#include &lt;target/target_core_base.h&gt;</span>

<span class="cp">#define ISCSIT_VERSION			&quot;v4.1.0-rc2&quot;</span>
<span class="cp">#define ISCSI_MAX_DATASN_MISSING_COUNT	16</span>
<span class="cp">#define ISCSI_TX_THREAD_TCP_TIMEOUT	2</span>
<span class="cp">#define ISCSI_RX_THREAD_TCP_TIMEOUT	2</span>
<span class="cp">#define SECONDS_FOR_ASYNC_LOGOUT	10</span>
<span class="cp">#define SECONDS_FOR_ASYNC_TEXT		10</span>
<span class="cp">#define SECONDS_FOR_LOGOUT_COMP		15</span>
<span class="cp">#define WHITE_SPACE			&quot; \t\v\f\n\r&quot;</span>

<span class="cm">/* struct iscsi_node_attrib sanity values */</span>
<span class="cp">#define NA_DATAOUT_TIMEOUT		3</span>
<span class="cp">#define NA_DATAOUT_TIMEOUT_MAX		60</span>
<span class="cp">#define NA_DATAOUT_TIMEOUT_MIX		2</span>
<span class="cp">#define NA_DATAOUT_TIMEOUT_RETRIES	5</span>
<span class="cp">#define NA_DATAOUT_TIMEOUT_RETRIES_MAX	15</span>
<span class="cp">#define NA_DATAOUT_TIMEOUT_RETRIES_MIN	1</span>
<span class="cp">#define NA_NOPIN_TIMEOUT		5</span>
<span class="cp">#define NA_NOPIN_TIMEOUT_MAX		60</span>
<span class="cp">#define NA_NOPIN_TIMEOUT_MIN		3</span>
<span class="cp">#define NA_NOPIN_RESPONSE_TIMEOUT	5</span>
<span class="cp">#define NA_NOPIN_RESPONSE_TIMEOUT_MAX	60</span>
<span class="cp">#define NA_NOPIN_RESPONSE_TIMEOUT_MIN	3</span>
<span class="cp">#define NA_RANDOM_DATAIN_PDU_OFFSETS	0</span>
<span class="cp">#define NA_RANDOM_DATAIN_SEQ_OFFSETS	0</span>
<span class="cp">#define NA_RANDOM_R2T_OFFSETS		0</span>
<span class="cp">#define NA_DEFAULT_ERL			0</span>
<span class="cp">#define NA_DEFAULT_ERL_MAX		2</span>
<span class="cp">#define NA_DEFAULT_ERL_MIN		0</span>

<span class="cm">/* struct iscsi_tpg_attrib sanity values */</span>
<span class="cp">#define TA_AUTHENTICATION		1</span>
<span class="cp">#define TA_LOGIN_TIMEOUT		15</span>
<span class="cp">#define TA_LOGIN_TIMEOUT_MAX		30</span>
<span class="cp">#define TA_LOGIN_TIMEOUT_MIN		5</span>
<span class="cp">#define TA_NETIF_TIMEOUT		2</span>
<span class="cp">#define TA_NETIF_TIMEOUT_MAX		15</span>
<span class="cp">#define TA_NETIF_TIMEOUT_MIN		2</span>
<span class="cp">#define TA_GENERATE_NODE_ACLS		0</span>
<span class="cp">#define TA_DEFAULT_CMDSN_DEPTH		16</span>
<span class="cp">#define TA_DEFAULT_CMDSN_DEPTH_MAX	512</span>
<span class="cp">#define TA_DEFAULT_CMDSN_DEPTH_MIN	1</span>
<span class="cp">#define TA_CACHE_DYNAMIC_ACLS		0</span>
<span class="cm">/* Enabled by default in demo mode (generic_node_acls=1) */</span>
<span class="cp">#define TA_DEMO_MODE_WRITE_PROTECT	1</span>
<span class="cm">/* Disabled by default in production mode w/ explict ACLs */</span>
<span class="cp">#define TA_PROD_MODE_WRITE_PROTECT	0</span>
<span class="cp">#define TA_CACHE_CORE_NPS		0</span>


<span class="cp">#define ISCSI_IOV_DATA_BUFFER		5</span>

<span class="k">enum</span> <span class="n">tpg_np_network_transport_table</span> <span class="p">{</span>
	<span class="n">ISCSI_TCP</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ISCSI_SCTP_TCP</span>				<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ISCSI_SCTP_UDP</span>				<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ISCSI_IWARP_TCP</span>				<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ISCSI_IWARP_SCTP</span>			<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ISCSI_INFINIBAND</span>			<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* RFC-3720 7.1.4  Standard Connection State Diagram for a Target */</span>
<span class="k">enum</span> <span class="n">target_conn_state_table</span> <span class="p">{</span>
	<span class="n">TARG_CONN_STATE_FREE</span>			<span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">TARG_CONN_STATE_XPT_UP</span>			<span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="n">TARG_CONN_STATE_IN_LOGIN</span>		<span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">TARG_CONN_STATE_LOGGED_IN</span>		<span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span>
	<span class="n">TARG_CONN_STATE_IN_LOGOUT</span>		<span class="o">=</span> <span class="mh">0x6</span><span class="p">,</span>
	<span class="n">TARG_CONN_STATE_LOGOUT_REQUESTED</span>	<span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
	<span class="n">TARG_CONN_STATE_CLEANUP_WAIT</span>		<span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* RFC-3720 7.3.2  Session State Diagram for a Target */</span>
<span class="k">enum</span> <span class="n">target_sess_state_table</span> <span class="p">{</span>
	<span class="n">TARG_SESS_STATE_FREE</span>			<span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">TARG_SESS_STATE_ACTIVE</span>			<span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">TARG_SESS_STATE_LOGGED_IN</span>		<span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="n">TARG_SESS_STATE_FAILED</span>			<span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">TARG_SESS_STATE_IN_CONTINUE</span>		<span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* struct iscsi_data_count-&gt;type */</span>
<span class="k">enum</span> <span class="n">data_count_type</span> <span class="p">{</span>
	<span class="n">ISCSI_RX_DATA</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ISCSI_TX_DATA</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* struct iscsi_datain_req-&gt;dr_complete */</span>
<span class="k">enum</span> <span class="n">datain_req_comp_table</span> <span class="p">{</span>
	<span class="n">DATAIN_COMPLETE_NORMAL</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">DATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">DATAIN_COMPLETE_CONNECTION_RECOVERY</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* struct iscsi_datain_req-&gt;recovery */</span>
<span class="k">enum</span> <span class="n">datain_req_rec_table</span> <span class="p">{</span>
	<span class="n">DATAIN_WITHIN_COMMAND_RECOVERY</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">DATAIN_CONNECTION_RECOVERY</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* struct iscsi_portal_group-&gt;state */</span>
<span class="k">enum</span> <span class="n">tpg_state_table</span> <span class="p">{</span>
	<span class="n">TPG_STATE_FREE</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPG_STATE_ACTIVE</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">TPG_STATE_INACTIVE</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">TPG_STATE_COLD_RESET</span>			<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* struct iscsi_tiqn-&gt;tiqn_state */</span>
<span class="k">enum</span> <span class="n">tiqn_state_table</span> <span class="p">{</span>
	<span class="n">TIQN_STATE_ACTIVE</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">TIQN_STATE_SHUTDOWN</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* struct iscsi_cmd-&gt;cmd_flags */</span>
<span class="k">enum</span> <span class="n">cmd_flags_table</span> <span class="p">{</span>
	<span class="n">ICF_GOT_LAST_DATAOUT</span>			<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>
	<span class="n">ICF_GOT_DATACK_SNACK</span>			<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>
	<span class="n">ICF_NON_IMMEDIATE_UNSOLICITED_DATA</span>	<span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>
	<span class="n">ICF_SENT_LAST_R2T</span>			<span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>
	<span class="n">ICF_WITHIN_COMMAND_RECOVERY</span>		<span class="o">=</span> <span class="mh">0x00000010</span><span class="p">,</span>
	<span class="n">ICF_CONTIG_MEMORY</span>			<span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>
	<span class="n">ICF_ATTACHED_TO_RQUEUE</span>			<span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>
	<span class="n">ICF_OOO_CMDSN</span>				<span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>
	<span class="n">ICF_REJECT_FAIL_CONN</span>			<span class="o">=</span> <span class="mh">0x00000100</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* struct iscsi_cmd-&gt;i_state */</span>
<span class="k">enum</span> <span class="n">cmd_i_state_table</span> <span class="p">{</span>
	<span class="n">ISTATE_NO_STATE</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ISTATE_NEW_CMD</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ISTATE_DEFERRED_CMD</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ISTATE_UNSOLICITED_DATA</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ISTATE_RECEIVE_DATAOUT</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ISTATE_RECEIVE_DATAOUT_RECOVERY</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">ISTATE_RECEIVED_LAST_DATAOUT</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">ISTATE_WITHIN_DATAOUT_RECOVERY</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">ISTATE_IN_CONNECTION_RECOVERY</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">ISTATE_RECEIVED_TASKMGT</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_ASYNCMSG</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_ASYNCMSG</span>		<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_DATAIN</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_LAST_DATAIN</span>		<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_LAST_DATAIN</span>		<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_LOGOUTRSP</span>		<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_LOGOUTRSP</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_NOPIN</span>		<span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_NOPIN</span>		<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_REJECT</span>		<span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_REJECT</span>		<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_R2T</span>			<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_R2T</span>			<span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_R2T_RECOVERY</span>	<span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_R2T_RECOVERY</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_LAST_R2T</span>		<span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_LAST_R2T</span>		<span class="o">=</span> <span class="mi">26</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_LAST_R2T_RECOVERY</span>	<span class="o">=</span> <span class="mi">27</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_LAST_R2T_RECOVERY</span>	<span class="o">=</span> <span class="mi">28</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_STATUS</span>		<span class="o">=</span> <span class="mi">29</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_STATUS_BROKEN_PC</span>	<span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_STATUS</span>		<span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_STATUS_RECOVERY</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_STATUS_RECOVERY</span>	<span class="o">=</span> <span class="mi">33</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_TASKMGTRSP</span>		<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_TASKMGTRSP</span>		<span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_TEXTRSP</span>		<span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_TEXTRSP</span>		<span class="o">=</span> <span class="mi">37</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_NOPIN_WANT_RESPONSE</span>	<span class="o">=</span> <span class="mi">38</span><span class="p">,</span>
	<span class="n">ISTATE_SENT_NOPIN_WANT_RESPONSE</span>	<span class="o">=</span> <span class="mi">39</span><span class="p">,</span>
	<span class="n">ISTATE_SEND_NOPIN_NO_RESPONSE</span>	<span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
	<span class="n">ISTATE_REMOVE</span>			<span class="o">=</span> <span class="mi">41</span><span class="p">,</span>
	<span class="n">ISTATE_FREE</span>			<span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Used for iscsi_recover_cmdsn() return values */</span>
<span class="k">enum</span> <span class="n">recover_cmdsn_ret_table</span> <span class="p">{</span>
	<span class="n">CMDSN_ERROR_CANNOT_RECOVER</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">CMDSN_NORMAL_OPERATION</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CMDSN_LOWER_THAN_EXP</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CMDSN_HIGHER_THAN_EXP</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Used for iscsi_handle_immediate_data() return values */</span>
<span class="k">enum</span> <span class="n">immedate_data_ret_table</span> <span class="p">{</span>
	<span class="n">IMMEDIATE_DATA_CANNOT_RECOVER</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">IMMEDIATE_DATA_NORMAL_OPERATION</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">IMMEDIATE_DATA_ERL1_CRC_FAILURE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Used for iscsi_decide_dataout_action() return values */</span>
<span class="k">enum</span> <span class="n">dataout_action_ret_table</span> <span class="p">{</span>
	<span class="n">DATAOUT_CANNOT_RECOVER</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">DATAOUT_NORMAL</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DATAOUT_SEND_R2T</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">DATAOUT_SEND_TO_TRANSPORT</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">DATAOUT_WITHIN_COMMAND_RECOVERY</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Used for struct iscsi_node_auth-&gt;naf_flags */</span>
<span class="k">enum</span> <span class="n">naf_flags_table</span> <span class="p">{</span>
	<span class="n">NAF_USERID_SET</span>			<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">NAF_PASSWORD_SET</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">NAF_USERID_IN_SET</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">NAF_PASSWORD_IN_SET</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Used by various struct timer_list to manage iSCSI specific state */</span>
<span class="k">enum</span> <span class="n">iscsi_timer_flags_table</span> <span class="p">{</span>
	<span class="n">ISCSI_TF_RUNNING</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">ISCSI_TF_STOP</span>			<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">ISCSI_TF_EXPIRED</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Used for struct iscsi_np-&gt;np_flags */</span>
<span class="k">enum</span> <span class="n">np_flags_table</span> <span class="p">{</span>
	<span class="n">NPF_IP_NETWORK</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">NPF_SCTP_STRUCT_FILE</span>	<span class="o">=</span> <span class="mh">0x01</span> <span class="cm">/* Bugfix */</span>
<span class="p">};</span>

<span class="cm">/* Used for struct iscsi_np-&gt;np_thread_state */</span>
<span class="k">enum</span> <span class="n">np_thread_state_table</span> <span class="p">{</span>
	<span class="n">ISCSI_NP_THREAD_ACTIVE</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ISCSI_NP_THREAD_INACTIVE</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ISCSI_NP_THREAD_RESET</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ISCSI_NP_THREAD_SHUTDOWN</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ISCSI_NP_THREAD_EXIT</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_conn_ops</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">HeaderDigest</span><span class="p">;</span>			<span class="cm">/* [0,1] == [None,CRC32C] */</span>
	<span class="n">u8</span>	<span class="n">DataDigest</span><span class="p">;</span>			<span class="cm">/* [0,1] == [None,CRC32C] */</span>
	<span class="n">u32</span>	<span class="n">MaxRecvDataSegmentLength</span><span class="p">;</span>	<span class="cm">/* [512..2**24-1] */</span>
	<span class="n">u8</span>	<span class="n">OFMarker</span><span class="p">;</span>			<span class="cm">/* [0,1] == [No,Yes] */</span>
	<span class="n">u8</span>	<span class="n">IFMarker</span><span class="p">;</span>			<span class="cm">/* [0,1] == [No,Yes] */</span>
	<span class="n">u32</span>	<span class="n">OFMarkInt</span><span class="p">;</span>			<span class="cm">/* [1..65535] */</span>
	<span class="n">u32</span>	<span class="n">IFMarkInt</span><span class="p">;</span>			<span class="cm">/* [1..65535] */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_sess_ops</span> <span class="p">{</span>
	<span class="kt">char</span>	<span class="n">InitiatorName</span><span class="p">[</span><span class="mi">224</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">InitiatorAlias</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">TargetName</span><span class="p">[</span><span class="mi">224</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">TargetAlias</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">TargetAddress</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">u16</span>	<span class="n">TargetPortalGroupTag</span><span class="p">;</span>		<span class="cm">/* [0..65535] */</span>
	<span class="n">u16</span>	<span class="n">MaxConnections</span><span class="p">;</span>			<span class="cm">/* [1..65535] */</span>
	<span class="n">u8</span>	<span class="n">InitialR2T</span><span class="p">;</span>			<span class="cm">/* [0,1] == [No,Yes] */</span>
	<span class="n">u8</span>	<span class="n">ImmediateData</span><span class="p">;</span>			<span class="cm">/* [0,1] == [No,Yes] */</span>
	<span class="n">u32</span>	<span class="n">MaxBurstLength</span><span class="p">;</span>			<span class="cm">/* [512..2**24-1] */</span>
	<span class="n">u32</span>	<span class="n">FirstBurstLength</span><span class="p">;</span>		<span class="cm">/* [512..2**24-1] */</span>
	<span class="n">u16</span>	<span class="n">DefaultTime2Wait</span><span class="p">;</span>		<span class="cm">/* [0..3600] */</span>
	<span class="n">u16</span>	<span class="n">DefaultTime2Retain</span><span class="p">;</span>		<span class="cm">/* [0..3600] */</span>
	<span class="n">u16</span>	<span class="n">MaxOutstandingR2T</span><span class="p">;</span>		<span class="cm">/* [1..65535] */</span>
	<span class="n">u8</span>	<span class="n">DataPDUInOrder</span><span class="p">;</span>			<span class="cm">/* [0,1] == [No,Yes] */</span>
	<span class="n">u8</span>	<span class="n">DataSequenceInOrder</span><span class="p">;</span>		<span class="cm">/* [0,1] == [No,Yes] */</span>
	<span class="n">u8</span>	<span class="n">ErrorRecoveryLevel</span><span class="p">;</span>		<span class="cm">/* [0..2] */</span>
	<span class="n">u8</span>	<span class="n">SessionType</span><span class="p">;</span>			<span class="cm">/* [0,1] == [Normal,Discovery]*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_queue_req</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cmd</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">qr_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_data_count</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">data_length</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">sync_and_steering</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">data_count_type</span>	<span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">iov_count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ss_iov_count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ss_marker_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span>		<span class="o">*</span><span class="n">iov</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_param_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">param_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">extra_response_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_datain_req</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">datain_req_comp_table</span> <span class="n">dr_complete</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">generate_recovery_values</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">datain_req_rec_table</span> <span class="n">recovery</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">begrun</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">runlength</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">data_length</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">data_sn</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">next_burst_len</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">read_data_done</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">seq_send_order</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">cmd_datain_node</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_ooo_cmdsn</span> <span class="p">{</span>
	<span class="n">u16</span>			<span class="n">cid</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">batch_count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cmdsn</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">exp_cmdsn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cmd</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">ooo_list</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_datain</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">data_sn</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_r2t</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">seq_complete</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">recovery_r2t</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">sent_r2t</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">r2t_sn</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">targ_xfer_tag</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">xfer_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">r2t_list</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_cmd</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">iscsi_timer_flags_table</span> <span class="n">dataout_timer_flags</span><span class="p">;</span>
	<span class="cm">/* DataOUT timeout retries */</span>
	<span class="n">u8</span>			<span class="n">dataout_timeout_retries</span><span class="p">;</span>
	<span class="cm">/* Within command recovery count */</span>
	<span class="n">u8</span>			<span class="n">error_recovery_count</span><span class="p">;</span>
	<span class="cm">/* iSCSI dependent state for out or order CmdSNs */</span>
	<span class="k">enum</span> <span class="n">cmd_i_state_table</span>	<span class="n">deferred_i_state</span><span class="p">;</span>
	<span class="cm">/* iSCSI dependent state */</span>
	<span class="k">enum</span> <span class="n">cmd_i_state_table</span>	<span class="n">i_state</span><span class="p">;</span>
	<span class="cm">/* Command is an immediate command (ISCSI_OP_IMMEDIATE set) */</span>
	<span class="n">u8</span>			<span class="n">immediate_cmd</span><span class="p">;</span>
	<span class="cm">/* Immediate data present */</span>
	<span class="n">u8</span>			<span class="n">immediate_data</span><span class="p">;</span>
	<span class="cm">/* iSCSI Opcode */</span>
	<span class="n">u8</span>			<span class="n">iscsi_opcode</span><span class="p">;</span>
	<span class="cm">/* iSCSI Response Code */</span>
	<span class="n">u8</span>			<span class="n">iscsi_response</span><span class="p">;</span>
	<span class="cm">/* Logout reason when iscsi_opcode == ISCSI_INIT_LOGOUT_CMND */</span>
	<span class="n">u8</span>			<span class="n">logout_reason</span><span class="p">;</span>
	<span class="cm">/* Logout response code when iscsi_opcode == ISCSI_INIT_LOGOUT_CMND */</span>
	<span class="n">u8</span>			<span class="n">logout_response</span><span class="p">;</span>
	<span class="cm">/* MaxCmdSN has been incremented */</span>
	<span class="n">u8</span>			<span class="n">maxcmdsn_inc</span><span class="p">;</span>
	<span class="cm">/* Immediate Unsolicited Dataout */</span>
	<span class="n">u8</span>			<span class="n">unsolicited_data</span><span class="p">;</span>
	<span class="cm">/* CID contained in logout PDU when opcode == ISCSI_INIT_LOGOUT_CMND */</span>
	<span class="n">u16</span>			<span class="n">logout_cid</span><span class="p">;</span>
	<span class="cm">/* Command flags */</span>
	<span class="k">enum</span> <span class="n">cmd_flags_table</span>	<span class="n">cmd_flags</span><span class="p">;</span>
	<span class="cm">/* Initiator Task Tag assigned from Initiator */</span>
	<span class="n">u32</span>			<span class="n">init_task_tag</span><span class="p">;</span>
	<span class="cm">/* Target Transfer Tag assigned from Target */</span>
	<span class="n">u32</span>			<span class="n">targ_xfer_tag</span><span class="p">;</span>
	<span class="cm">/* CmdSN assigned from Initiator */</span>
	<span class="n">u32</span>			<span class="n">cmd_sn</span><span class="p">;</span>
	<span class="cm">/* ExpStatSN assigned from Initiator */</span>
	<span class="n">u32</span>			<span class="n">exp_stat_sn</span><span class="p">;</span>
	<span class="cm">/* StatSN assigned to this ITT */</span>
	<span class="n">u32</span>			<span class="n">stat_sn</span><span class="p">;</span>
	<span class="cm">/* DataSN Counter */</span>
	<span class="n">u32</span>			<span class="n">data_sn</span><span class="p">;</span>
	<span class="cm">/* R2TSN Counter */</span>
	<span class="n">u32</span>			<span class="n">r2t_sn</span><span class="p">;</span>
	<span class="cm">/* Last DataSN acknowledged via DataAck SNACK */</span>
	<span class="n">u32</span>			<span class="n">acked_data_sn</span><span class="p">;</span>
	<span class="cm">/* Used for echoing NOPOUT ping data */</span>
	<span class="n">u32</span>			<span class="n">buf_ptr_size</span><span class="p">;</span>
	<span class="cm">/* Used to store DataDigest */</span>
	<span class="n">u32</span>			<span class="n">data_crc</span><span class="p">;</span>
	<span class="cm">/* Counter for MaxOutstandingR2T */</span>
	<span class="n">u32</span>			<span class="n">outstanding_r2ts</span><span class="p">;</span>
	<span class="cm">/* Next R2T Offset when DataSequenceInOrder=Yes */</span>
	<span class="n">u32</span>			<span class="n">r2t_offset</span><span class="p">;</span>
	<span class="cm">/* Iovec current and orig count for iscsi_cmd-&gt;iov_data */</span>
	<span class="n">u32</span>			<span class="n">iov_data_count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">orig_iov_data_count</span><span class="p">;</span>
	<span class="cm">/* Number of miscellaneous iovecs used for IP stack calls */</span>
	<span class="n">u32</span>			<span class="n">iov_misc_count</span><span class="p">;</span>
	<span class="cm">/* Number of struct iscsi_pdu in struct iscsi_cmd-&gt;pdu_list */</span>
	<span class="n">u32</span>			<span class="n">pdu_count</span><span class="p">;</span>
	<span class="cm">/* Next struct iscsi_pdu to send in struct iscsi_cmd-&gt;pdu_list */</span>
	<span class="n">u32</span>			<span class="n">pdu_send_order</span><span class="p">;</span>
	<span class="cm">/* Current struct iscsi_pdu in struct iscsi_cmd-&gt;pdu_list */</span>
	<span class="n">u32</span>			<span class="n">pdu_start</span><span class="p">;</span>
	<span class="cm">/* Next struct iscsi_seq to send in struct iscsi_cmd-&gt;seq_list */</span>
	<span class="n">u32</span>			<span class="n">seq_send_order</span><span class="p">;</span>
	<span class="cm">/* Number of struct iscsi_seq in struct iscsi_cmd-&gt;seq_list */</span>
	<span class="n">u32</span>			<span class="n">seq_count</span><span class="p">;</span>
	<span class="cm">/* Current struct iscsi_seq in struct iscsi_cmd-&gt;seq_list */</span>
	<span class="n">u32</span>			<span class="n">seq_no</span><span class="p">;</span>
	<span class="cm">/* Lowest offset in current DataOUT sequence */</span>
	<span class="n">u32</span>			<span class="n">seq_start_offset</span><span class="p">;</span>
	<span class="cm">/* Highest offset in current DataOUT sequence */</span>
	<span class="n">u32</span>			<span class="n">seq_end_offset</span><span class="p">;</span>
	<span class="cm">/* Total size in bytes received so far of READ data */</span>
	<span class="n">u32</span>			<span class="n">read_data_done</span><span class="p">;</span>
	<span class="cm">/* Total size in bytes received so far of WRITE data */</span>
	<span class="n">u32</span>			<span class="n">write_data_done</span><span class="p">;</span>
	<span class="cm">/* Counter for FirstBurstLength key */</span>
	<span class="n">u32</span>			<span class="n">first_burst_len</span><span class="p">;</span>
	<span class="cm">/* Counter for MaxBurstLength key */</span>
	<span class="n">u32</span>			<span class="n">next_burst_len</span><span class="p">;</span>
	<span class="cm">/* Transfer size used for IP stack calls */</span>
	<span class="n">u32</span>			<span class="n">tx_size</span><span class="p">;</span>
	<span class="cm">/* Buffer used for various purposes */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">buf_ptr</span><span class="p">;</span>
	<span class="cm">/* See include/linux/dma-mapping.h */</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span>	<span class="n">data_direction</span><span class="p">;</span>
	<span class="cm">/* iSCSI PDU Header + CRC */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">pdu</span><span class="p">[</span><span class="n">ISCSI_HDR_LEN</span> <span class="o">+</span> <span class="n">ISCSI_CRC_LEN</span><span class="p">];</span>
	<span class="cm">/* Number of times struct iscsi_cmd is present in immediate queue */</span>
	<span class="n">atomic_t</span>		<span class="n">immed_queue_count</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">response_queue_count</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">datain_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">dataout_timeout_lock</span><span class="p">;</span>
	<span class="cm">/* spinlock for protecting struct iscsi_cmd-&gt;i_state */</span>
	<span class="n">spinlock_t</span>		<span class="n">istate_lock</span><span class="p">;</span>
	<span class="cm">/* spinlock for adding within command recovery entries */</span>
	<span class="n">spinlock_t</span>		<span class="n">error_lock</span><span class="p">;</span>
	<span class="cm">/* spinlock for adding R2Ts */</span>
	<span class="n">spinlock_t</span>		<span class="n">r2t_lock</span><span class="p">;</span>
	<span class="cm">/* DataIN List */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">datain_list</span><span class="p">;</span>
	<span class="cm">/* R2T List */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">cmd_r2t_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">reject_comp</span><span class="p">;</span>
	<span class="cm">/* Timer for DataOUT */</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">dataout_timer</span><span class="p">;</span>
	<span class="cm">/* Iovecs for SCSI data payload RX/TX w/ kernel level sockets */</span>
	<span class="k">struct</span> <span class="n">kvec</span>		<span class="o">*</span><span class="n">iov_data</span><span class="p">;</span>
	<span class="cm">/* Iovecs for miscellaneous purposes */</span>
<span class="cp">#define ISCSI_MISC_IOVECS			5</span>
	<span class="k">struct</span> <span class="n">kvec</span>		<span class="n">iov_misc</span><span class="p">[</span><span class="n">ISCSI_MISC_IOVECS</span><span class="p">];</span>
	<span class="cm">/* Array of struct iscsi_pdu used for DataPDUInOrder=No */</span>
	<span class="k">struct</span> <span class="n">iscsi_pdu</span>	<span class="o">*</span><span class="n">pdu_list</span><span class="p">;</span>
	<span class="cm">/* Current struct iscsi_pdu used for DataPDUInOrder=No */</span>
	<span class="k">struct</span> <span class="n">iscsi_pdu</span>	<span class="o">*</span><span class="n">pdu_ptr</span><span class="p">;</span>
	<span class="cm">/* Array of struct iscsi_seq used for DataSequenceInOrder=No */</span>
	<span class="k">struct</span> <span class="n">iscsi_seq</span>	<span class="o">*</span><span class="n">seq_list</span><span class="p">;</span>
	<span class="cm">/* Current struct iscsi_seq used for DataSequenceInOrder=No */</span>
	<span class="k">struct</span> <span class="n">iscsi_seq</span>	<span class="o">*</span><span class="n">seq_ptr</span><span class="p">;</span>
	<span class="cm">/* TMR Request when iscsi_opcode == ISCSI_OP_SCSI_TMFUNC */</span>
	<span class="k">struct</span> <span class="n">iscsi_tmr_req</span>	<span class="o">*</span><span class="n">tmr_req</span><span class="p">;</span>
	<span class="cm">/* Connection this command is alligient to */</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span>	<span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="cm">/* Pointer to connection recovery entry */</span>
	<span class="k">struct</span> <span class="n">iscsi_conn_recovery</span> <span class="o">*</span><span class="n">cr</span><span class="p">;</span>
	<span class="cm">/* Session the command is part of,  used for connection recovery */</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span>	<span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="cm">/* list_head for connection list */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">i_conn_node</span><span class="p">;</span>
	<span class="cm">/* The TCM I/O descriptor that is accessed via container_of() */</span>
	<span class="k">struct</span> <span class="n">se_cmd</span>		<span class="n">se_cmd</span><span class="p">;</span>
	<span class="cm">/* Sense buffer that will be mapped into outgoing status */</span>
<span class="cp">#define ISCSI_SENSE_BUFFER_LEN          (TRANSPORT_SENSE_BUFFER + 2)</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">sense_buffer</span><span class="p">[</span><span class="n">ISCSI_SENSE_BUFFER_LEN</span><span class="p">];</span>

	<span class="n">u32</span>			<span class="n">padding</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">pad_bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">first_data_sg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">first_data_sg_off</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">kmapped_nents</span><span class="p">;</span>

<span class="p">}</span>  <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_tmr_req</span> <span class="p">{</span>
	<span class="n">bool</span>			<span class="n">task_reassign</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ref_cmd_sn</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">exp_data_sn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn_recovery</span> <span class="o">*</span><span class="n">conn_recovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_tmr_req</span>	<span class="o">*</span><span class="n">se_tmr_req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="p">{</span>
	<span class="cm">/* Authentication Successful for this connection */</span>
	<span class="n">u8</span>			<span class="n">auth_complete</span><span class="p">;</span>
	<span class="cm">/* State connection is currently in */</span>
	<span class="n">u8</span>			<span class="n">conn_state</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">conn_logout_reason</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">network_transport</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iscsi_timer_flags_table</span> <span class="n">nopin_timer_flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iscsi_timer_flags_table</span> <span class="n">nopin_response_timer_flags</span><span class="p">;</span>
	<span class="cm">/* Used to know what thread encountered a transport failure */</span>
	<span class="n">u8</span>			<span class="n">which_thread</span><span class="p">;</span>
	<span class="cm">/* connection id assigned by the Initiator */</span>
	<span class="n">u16</span>			<span class="n">cid</span><span class="p">;</span>
	<span class="cm">/* Remote TCP Port */</span>
	<span class="n">u16</span>			<span class="n">login_port</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">local_port</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">net_size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">auth_id</span><span class="p">;</span>
<span class="cp">#define CONNFLAG_SCTP_STRUCT_FILE			0x01</span>
	<span class="n">u32</span>			<span class="n">conn_flags</span><span class="p">;</span>
	<span class="cm">/* Used for iscsi_tx_login_rsp() */</span>
	<span class="n">u32</span>			<span class="n">login_itt</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">exp_statsn</span><span class="p">;</span>
	<span class="cm">/* Per connection status sequence number */</span>
	<span class="n">u32</span>			<span class="n">stat_sn</span><span class="p">;</span>
	<span class="cm">/* IFMarkInt&#39;s Current Value */</span>
	<span class="n">u32</span>			<span class="n">if_marker</span><span class="p">;</span>
	<span class="cm">/* OFMarkInt&#39;s Current Value */</span>
	<span class="n">u32</span>			<span class="n">of_marker</span><span class="p">;</span>
	<span class="cm">/* Used for calculating OFMarker offset to next PDU */</span>
	<span class="n">u32</span>			<span class="n">of_marker_offset</span><span class="p">;</span>
	<span class="cm">/* Complete Bad PDU for sending reject */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">bad_hdr</span><span class="p">[</span><span class="n">ISCSI_HDR_LEN</span><span class="p">];</span>
<span class="cp">#define IPV6_ADDRESS_SPACE				48</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">login_ip</span><span class="p">[</span><span class="n">IPV6_ADDRESS_SPACE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">local_ip</span><span class="p">[</span><span class="n">IPV6_ADDRESS_SPACE</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">conn_usage_count</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">conn_waiting_on_uc</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">check_immediate_queue</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">conn_logout_remove</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">connection_exit</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">connection_recovery</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">connection_reinstatement</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">connection_wait_rcfr</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">sleep_on_conn_wait_comp</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">transport_failed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">conn_post_wait_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">conn_wait_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">conn_wait_rcfr_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">conn_waiting_on_uc_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">conn_logout_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">tx_half_close_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">rx_half_close_comp</span><span class="p">;</span>
	<span class="cm">/* socket used by this connection */</span>
	<span class="k">struct</span> <span class="n">socket</span>		<span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">nopin_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">nopin_response_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">transport_timer</span><span class="p">;</span>
	<span class="cm">/* Spinlock used for add/deleting cmd&#39;s from conn_cmd_list */</span>
	<span class="n">spinlock_t</span>		<span class="n">cmd_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">conn_usage_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">immed_queue_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">nopin_timer_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">response_queue_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">state_lock</span><span class="p">;</span>
	<span class="cm">/* libcrypto RX and TX contexts for crc32c */</span>
	<span class="k">struct</span> <span class="n">hash_desc</span>	<span class="n">conn_rx_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_desc</span>	<span class="n">conn_tx_hash</span><span class="p">;</span>
	<span class="cm">/* Used for scheduling TX and RX connection kthreads */</span>
	<span class="n">cpumask_var_t</span>		<span class="n">conn_cpumask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">conn_rx_reset_cpumask</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">conn_tx_reset_cpumask</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* list_head of struct iscsi_cmd for this connection */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">conn_cmd_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">immed_queue_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">response_queue_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn_ops</span>	<span class="o">*</span><span class="n">conn_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_param_list</span>	<span class="o">*</span><span class="n">param_list</span><span class="p">;</span>
	<span class="cm">/* Used for per connection auth state machine */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">auth_protocol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_login_thread_s</span> <span class="o">*</span><span class="n">login_thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="cm">/* Pointer to parent session */</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span>	<span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="cm">/* Pointer to thread_set in use for this conn&#39;s threads */</span>
	<span class="k">struct</span> <span class="n">iscsi_thread_set</span>	<span class="o">*</span><span class="n">thread_set</span><span class="p">;</span>
	<span class="cm">/* list_head for session connection list */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">conn_list</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_conn_recovery</span> <span class="p">{</span>
	<span class="n">u16</span>			<span class="n">cid</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cmd_count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">maxrecvdatasegmentlength</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ready_for_reallegiance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">conn_recovery_cmd_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">conn_recovery_cmd_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">time2retain_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span>	<span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">cr_list</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">initiator_vendor</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">isid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">iscsi_timer_flags_table</span> <span class="n">time2retain_timer_flags</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">version_active</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">cid_called</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">conn_recovery_count</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">tsih</span><span class="p">;</span>
	<span class="cm">/* state session is currently in */</span>
	<span class="n">u32</span>			<span class="n">session_state</span><span class="p">;</span>
	<span class="cm">/* session wide counter: initiator assigned task tag */</span>
	<span class="n">u32</span>			<span class="n">init_task_tag</span><span class="p">;</span>
	<span class="cm">/* session wide counter: target assigned task tag */</span>
	<span class="n">u32</span>			<span class="n">targ_xfer_tag</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cmdsn_window</span><span class="p">;</span>

	<span class="cm">/* protects cmdsn values */</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">cmdsn_mutex</span><span class="p">;</span>
	<span class="cm">/* session wide counter: expected command sequence number */</span>
	<span class="n">u32</span>			<span class="n">exp_cmd_sn</span><span class="p">;</span>
	<span class="cm">/* session wide counter: maximum allowed command sequence number */</span>
	<span class="n">u32</span>			<span class="n">max_cmd_sn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">sess_ooo_cmdsn_list</span><span class="p">;</span>

	<span class="cm">/* LIO specific session ID */</span>
	<span class="n">u32</span>			<span class="n">sid</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">auth_type</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="cm">/* unique within the target */</span>
	<span class="kt">int</span>			<span class="n">session_index</span><span class="p">;</span>
	<span class="cm">/* Used for session reference counting */</span>
	<span class="kt">int</span>			<span class="n">session_usage_count</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">session_waiting_on_uc</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cmd_pdus</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rsp_pdus</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">tx_data_octets</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">rx_data_octets</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">conn_digest_errors</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">conn_timeout_errors</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">creation_time</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">session_stats_lock</span><span class="p">;</span>
	<span class="cm">/* Number of active connections */</span>
	<span class="n">atomic_t</span>		<span class="n">nconn</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">session_continuation</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">session_fall_back_to_erl0</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">session_logout</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">session_reinstatement</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">session_stop_active</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">sleep_on_sess_wait_comp</span><span class="p">;</span>
	<span class="cm">/* connection list */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">sess_conn_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">cr_active_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">cr_inactive_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">conn_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">cr_a_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">cr_i_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">session_usage_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">ttt_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">async_msg_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">reinstatement_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">session_wait_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">session_waiting_on_uc_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">time2retain_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_sess_ops</span>	<span class="o">*</span><span class="n">sess_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span>	<span class="o">*</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_login</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">auth_complete</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">checked_for_existing</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_stage</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">leading_connection</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">first_request</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">version_min</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">version_max</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">isid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">cmd_sn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">init_task_tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">initial_exp_statsn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rsp_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tsih</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">req_buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rsp_buf</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_node_attrib</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">dataout_timeout</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">dataout_timeout_retries</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">default_erl</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">nopin_timeout</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">nopin_response_timeout</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">random_datain_pdu_offsets</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">random_datain_seq_offsets</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">random_r2t_offsets</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmr_cold_reset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmr_warm_reset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">se_dev_entry_s</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_node_auth</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">naf_flags_table</span>	<span class="n">naf_flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">authenticate_target</span><span class="p">;</span>
	<span class="cm">/* Used for iscsit_global-&gt;discovery_auth,</span>
<span class="cm">	 * set to zero (auth disabled) by default */</span>
	<span class="kt">int</span>			<span class="n">enforce_discovery_auth</span><span class="p">;</span>
<span class="cp">#define MAX_USER_LEN				256</span>
<span class="cp">#define MAX_PASS_LEN				256</span>
	<span class="kt">char</span>			<span class="n">userid</span><span class="p">[</span><span class="n">MAX_USER_LEN</span><span class="p">];</span>
	<span class="kt">char</span>			<span class="n">password</span><span class="p">[</span><span class="n">MAX_PASS_LEN</span><span class="p">];</span>
	<span class="kt">char</span>			<span class="n">userid_mutual</span><span class="p">[</span><span class="n">MAX_USER_LEN</span><span class="p">];</span>
	<span class="kt">char</span>			<span class="n">password_mutual</span><span class="p">[</span><span class="n">MAX_PASS_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#include &quot;iscsi_target_stat.h&quot;</span>

<span class="k">struct</span> <span class="n">iscsi_node_stat_grps</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_sess_stats_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_conn_stats_group</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_node_acl</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_node_attrib</span> <span class="n">node_attrib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_node_auth</span>	<span class="n">node_auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_node_stat_grps</span> <span class="n">node_stat_grps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span>	<span class="n">se_node_acl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define NODE_STAT_GRPS(nacl)	(&amp;(nacl)-&gt;node_stat_grps)</span>

<span class="cp">#define ISCSI_NODE_ATTRIB(t)	(&amp;(t)-&gt;node_attrib)</span>
<span class="cp">#define ISCSI_NODE_AUTH(t)	(&amp;(t)-&gt;node_auth)</span>

<span class="k">struct</span> <span class="n">iscsi_tpg_attrib</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">authentication</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">login_timeout</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">netif_timeout</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">generate_node_acls</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cache_dynamic_acls</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">default_cmdsn_depth</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">demo_mode_write_protect</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">prod_mode_write_protect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_np</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">np_network_transport</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">np_ip_proto</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">np_sock_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">np_thread_state_table</span> <span class="n">np_thread_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iscsi_timer_flags_table</span> <span class="n">np_login_timer_flags</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">np_exports</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">np_flags_table</span>	<span class="n">np_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">np_ip</span><span class="p">[</span><span class="n">IPV6_ADDRESS_SPACE</span><span class="p">];</span>
	<span class="n">u16</span>			<span class="n">np_port</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">np_thread_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">np_restart_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span>		<span class="o">*</span><span class="n">np_socket</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__kernel_sockaddr_storage</span> <span class="n">np_sockaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">np_thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">np_login_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_portal_group</span> <span class="o">*</span><span class="n">np_login_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">np_list</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iscsi_tpg_np</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_np</span>		<span class="o">*</span><span class="n">tpg_np</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tpg_np</span>	<span class="o">*</span><span class="n">tpg_np_parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">tpg_np_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">tpg_np_child_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">tpg_np_parent_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_tpg_np</span>	<span class="n">se_tpg_np</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">tpg_np_parent_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_portal_group</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">tpg_chap_id</span><span class="p">;</span>
	<span class="cm">/* TPG State */</span>
	<span class="k">enum</span> <span class="n">tpg_state_table</span>	<span class="n">tpg_state</span><span class="p">;</span>
	<span class="cm">/* Target Portal Group Tag */</span>
	<span class="n">u16</span>			<span class="n">tpgt</span><span class="p">;</span>
	<span class="cm">/* Id assigned to target sessions */</span>
	<span class="n">u16</span>			<span class="n">ntsih</span><span class="p">;</span>
	<span class="cm">/* Number of active sessions */</span>
	<span class="n">u32</span>			<span class="n">nsessions</span><span class="p">;</span>
	<span class="cm">/* Number of Network Portals available for this TPG */</span>
	<span class="n">u32</span>			<span class="n">num_tpg_nps</span><span class="p">;</span>
	<span class="cm">/* Per TPG LIO specific session ID. */</span>
	<span class="n">u32</span>			<span class="n">sid</span><span class="p">;</span>
	<span class="cm">/* Spinlock for adding/removing Network Portals */</span>
	<span class="n">spinlock_t</span>		<span class="n">tpg_np_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">tpg_state_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="n">tpg_se_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">tpg_access_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">np_login_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tpg_attrib</span>	<span class="n">tpg_attrib</span><span class="p">;</span>
	<span class="cm">/* Pointer to default list of iSCSI parameters for TPG */</span>
	<span class="k">struct</span> <span class="n">iscsi_param_list</span>	<span class="o">*</span><span class="n">param_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tiqn</span>	<span class="o">*</span><span class="n">tpg_tiqn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">tpg_gnp_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">tpg_list</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="cp">#define ISCSI_TPG_C(c)		((struct iscsi_portal_group *)(c)-&gt;tpg)</span>
<span class="cp">#define ISCSI_TPG_LUN(c, l)  ((iscsi_tpg_list_t *)(c)-&gt;tpg-&gt;tpg_lun_list_t[l])</span>
<span class="cp">#define ISCSI_TPG_S(s)		((struct iscsi_portal_group *)(s)-&gt;tpg)</span>
<span class="cp">#define ISCSI_TPG_ATTRIB(t)	(&amp;(t)-&gt;tpg_attrib)</span>
<span class="cp">#define SE_TPG(tpg)		(&amp;(tpg)-&gt;tpg_se_tpg)</span>

<span class="k">struct</span> <span class="n">iscsi_wwn_stat_grps</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_stat_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_instance_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_sess_err_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_tgt_attr_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_login_stats_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_group</span>	<span class="n">iscsi_logout_stats_group</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_tiqn</span> <span class="p">{</span>
<span class="cp">#define ISCSI_IQN_LEN				224</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">tiqn</span><span class="p">[</span><span class="n">ISCSI_IQN_LEN</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">tiqn_state_table</span>	<span class="n">tiqn_state</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tiqn_access_count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tiqn_active_tpgs</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tiqn_ntpgs</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tiqn_num_tpg_nps</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tiqn_nsessions</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">tiqn_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">tiqn_tpg_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">tiqn_state_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">tiqn_tpg_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_wwn</span>		<span class="n">tiqn_wwn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_wwn_stat_grps</span> <span class="n">tiqn_stat_grps</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tiqn_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_sess_err_stats</span>  <span class="n">sess_err_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_login_stats</span>     <span class="n">login_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_logout_stats</span>    <span class="n">logout_stats</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="cp">#define WWN_STAT_GRPS(tiqn)	(&amp;(tiqn)-&gt;tiqn_stat_grps)</span>

<span class="k">struct</span> <span class="n">iscsit_global</span> <span class="p">{</span>
	<span class="cm">/* In core shutdown */</span>
	<span class="n">u32</span>			<span class="n">in_shutdown</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">active_ts</span><span class="p">;</span>
	<span class="cm">/* Unique identifier used for the authentication daemon */</span>
	<span class="n">u32</span>			<span class="n">auth_id</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">inactive_ts</span><span class="p">;</span>
	<span class="cm">/* Thread Set bitmap count */</span>
	<span class="kt">int</span>			<span class="n">ts_bitmap_count</span><span class="p">;</span>
	<span class="cm">/* Thread Set bitmap pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="o">*</span><span class="n">ts_bitmap</span><span class="p">;</span>
	<span class="cm">/* Used for iSCSI discovery session authentication */</span>
	<span class="k">struct</span> <span class="n">iscsi_node_acl</span>	<span class="n">discovery_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_portal_group</span>	<span class="o">*</span><span class="n">discovery_tpg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* ISCSI_TARGET_CORE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
