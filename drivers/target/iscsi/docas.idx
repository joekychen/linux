f | iscsi_target_configfs.c | s | 50K | 1592 | Andy Grover | agrover@redhat.com | 1334450435 |  | target/iscsi: Misc cleanups from Agrover (round 2)  This patch includes the handful of squashed patches for target/iscsi from Andy's original series into lio-core/master code:  *) Make iscsit_add_reject static *) Remove unused data_offset_end from iscsi_datain_req *) Remove "#if 0" stubs *) Rename iscsi_datain_req to cmd_datain_node *) Cleanups for built_r2ts_for_cmd() *) Cleanups for Cleanup build_sendtargets_response()  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_erl2.c | s | 12K | 370 | Andy Grover | agrover@redhat.com | 1334450433 |  | target/iscsi: Rename iscsi_cmd.i_list to iscsi_cmd.i_conn_node  The name change makes it clear this list_head is so the cmd can be an item in the connection's conn_cmd_list.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_login.c | s | 35K | 1099 | Linus Torvalds | torvalds@linux-foundation.org | 1332445084 |  | Merge branch 'for-next' of git://git.kernel.org/pub/scm/linux/kernel/git/nab/target-pending  Pull SCSI target updates from Nicholas Bellinger:  "This contains the usual set of updates and bugfixes to target-core +   existing fabric module code, along with a handful of the patches   destined for v3.3 stable.    It also contains the necessary target-core infrastructure pieces   required to run using tcm_qla2xxx.ko WWPNs with the new Qlogic Fibre   Channel fabric module currently queued in target-pending/for-next-merge,   and coming for round 2.    The highlights for this series include:     - Add target_submit_tmr() helper function for fabric task management      (andy)    - Convert tcm_fc to use target_submit_tmr() (andy)    - Replace target core various cmd flags with a transport state (hch)    - Convert loopback to use workqueue submission (hch)    - Convert target core to use array_zalloc for tpg_lun_list (joern)    - Convert target core to use array_zalloc for device_list (joern)    - Add target core support for TMR_ABORT_TASK (nab)    - Add target core se_sess->sess_kref + get/put helpers (nab)    - Add target core se_node_acl->acl_kref for ->acl_free_comp usage      (nab)    - Convert iscsi-target to use target_put_session + sess_kref (nab)    - Fix tcm_fc fc_exch memory leak in ft_send_resp_status (nab)    - Fix ib_srpt srpt_handle_cmd send_ioctx->ioctx_kref leak on      exception (nab)    - Fix target core up handling of short INQUIRY buffers (roland)    - Untangle target-core front-end and back-end meanings of max_sectors      attribute (roland)    - Set loopback residual field for SCSI commands (roland)    - Fix target-core 16-bit target ports for SET TARGET PORT GROUPS      emulation (roland)    Thanks again to Andy, Christoph, Joern, Roland, and everyone who has   contributed this round!"  * 'for-next' of git://git.kernel.org/pub/scm/linux/kernel/git/nab/target-pending: (64 commits)   ib_srpt: Fix srpt_handle_cmd send_ioctx->ioctx_kref leak on exception   loopback: Fix transport_generic_allocate_tasks error handling   iscsi-target: remove improper externs   iscsi-target: Remove unused variables in iscsi_target_parameters.c   target: remove obvious warnings   target: Use array_zalloc for device_list   target: Use array_zalloc for tpg_lun_list   target: Fix sense code for unsupported SERVICE ACTION IN   target: Remove hack to make READ CAPACITY(10) lie if thin provisioning is enabled   target: Bump core version to v4.1.0-rc2-ml + fabric versions   tcm_fc: Fix fc_exch memory leak in ft_send_resp_status   target: Drop unused legacy target_core_fabric_ops API callers   iscsi-target: Convert to use target_put_session + sess_kref   target: Convert se_node_acl->acl_group removal to use ->acl_kref   target: Add se_node_acl->acl_kref for ->acl_free_comp usage   target: Add se_node_acl->acl_free_comp for NodeACL release path   target: Add se_sess->sess_kref + get/put helpers   target: Convert session_lock to irqsave   target: Fix typo in drivers/target   iscsi-target: Fix dynamic -> explict NodeACL pointer reference   ...
f | Makefile | g | 562B |  | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_auth.c | s | 11K | 420 | Nicholas Bellinger | nab@linux-iscsi.org | 1323862089 |  | iscsi-target: fix chap identifier simple_strtoul usage  This patch makes chap_server_compute_md5() use proper unsigned long usage for the CHAP_I (identifier) and check for values beyond 255 as per RFC-1994.  Reported-by: Joern Engel <joern@logfs.org> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_erl0.h | s | 805B | 13 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_nego.h | s | 569B | 14 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_nodeattrib.h | s | 757B | 12 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_nodeattrib.c | s | 7.6K | 222 | Dan Carpenter | dan.carpenter@oracle.com | 1332032824 |  | iscsi-target: remove improper externs  These externs aren't needed and Sparse complains about them.  drivers/target/iscsi/iscsi_target_nodeattrib.c:52:12: warning: 	function 'iscsit_na_dataout_timeout' with external linkage has 	definition  Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_device.h | s | 243B | 5 | Andy Grover | agrover@redhat.com | 1330209467 |  | target/iscsi: Remove unneeded wrapper functions  iscsit_get_lun_for_{cmd,tmr} are unnecessary.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_parameters.h | s | 9.2K | 243 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_tq.h | s | 3.0K | 80 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_parameters.c | s | 50K | 1670 | Dan Carpenter | dan.carpenter@oracle.com | 1337281493 |  | iscsi-target: remove dead code in iscsi_check_valuelist_for_support  Neither "acceptor_values" nor "proposer_values" can be NULL here when scanning the value lists for incoming iSCSI login parameters such as HeaderDigest=CRC32C,None.  Smatch complains because we are not allowed to pass NULL pointers to strchr().  Also I removed a second later check for "!acceptor_values" because it gets checked on the next line in the do while condition.  Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_tpg.c | s | 19K | 635 | Jörn Engel | joern@logfs.org | 1323862087 |  | target: remove useless casts  A reader should spend an extra moment whenever noticing a cast, because either something special is going on that deserves extra attention or, as is all too often the case, the code is wrong.  These casts, afaics, have all been useless.  They cast a foo* to a foo*, cast a void* to the assigned type, cast a foo* to void*, before assigning it to a void* variable, etc.  In a few cases I also removed an additional &...[0], which is equally useless.  Lastly I added three FIXMEs where, to the best of my judgement, the code appears to have a bug.  It would be good if someone could check these.  Signed-off-by: Joern Engel <joern@logfs.org> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_nego.c | s | 26K | 919 | Jörn Engel | joern@logfs.org | 1331864169 |  | target: remove obvious warnings  Get rid of a bunch of write-only variables.  In a number of cases I suspect actual bugs to be present, so I left all of those for a second look.  (nab: fix lio-core patch fuzz)  Signed-off-by: Joern Engel <joern@logfs.org> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_erl1.h | s | 1.4K | 24 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_util.c | s | 36K | 1219 | Andy Grover | agrover@redhat.com | 1334450439 |  | target/iscsi: Go back to core allocating data buffer for cmd  We originally changed iscsi to allocate its own buffers just as an intermediate step to clean up some core buffer allocation mechanisms. Now we can put it back.  Also had to change allocate_iovecs to use data_length instead of t_data_nents because iovecs are now allocated before the data buffer, thus t_data_nents is not yet initialized.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_tmr.c | s | 23K | 737 | Andy Grover | agrover@redhat.com | 1334450438 |  | target/iscsi: Eliminate iscsi_cmd.data_length  Redundant, just use iscsi_cmd->se_cmd.data_length once se_cmd is initialized, or hdr->data_length before then.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_tpg.h | s | 2.3K | 39 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_datain_values.h | s | 598B | 10 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_seq_pdu_list.c | s | 17K | 614 | Dan Carpenter | dan.carpenter@oracle.com | 1336341753 |  | target/iscsi: cleanup some allocation style issues  We can use kcalloc() here instead of kzalloc().  It's better style and it has overflow checking built in.  Also -ENOMEM is the correct error code for allocation errors.  -1 means -EPERM.  None of the callers preserve the error codes so it doesn't matter except as a cleanup.  Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_util.h | s | 3.6K | 55 | Andy Grover | agrover@redhat.com | 1334450438 |  | target/iscsi: Fold _decide_list_to_build into _build_pdu_and_seq_lists  Rename iscsit_build_pdu_and_seq_list to iscsit_do_build_pdu_and_seq_lists  Rename iscsit_do_build_list to iscsit_build_pdu_and_seq_lists  Move code from iscsit_decide_list_to_build into _seq_pdu_list.c, seems a better fit.  Also update some comments in pdu/seq code for correctness and whitespace.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_seq_pdu_list.h | s | 2.1K | 73 | Andy Grover | agrover@redhat.com | 1334450438 |  | target/iscsi: Fold _decide_list_to_build into _build_pdu_and_seq_lists  Rename iscsit_build_pdu_and_seq_list to iscsit_do_build_pdu_and_seq_lists  Rename iscsit_do_build_list to iscsit_build_pdu_and_seq_lists  Move code from iscsit_decide_list_to_build into _seq_pdu_list.c, seems a better fit.  Also update some comments in pdu/seq code for correctness and whitespace.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_configfs.h | s | 204B | 5 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_erl1.c | s | 32K | 1110 | Andy Grover | agrover@redhat.com | 1334450438 |  | target/iscsi: Eliminate iscsi_cmd.data_length  Redundant, just use iscsi_cmd->se_cmd.data_length once se_cmd is initialized, or hdr->data_length before then.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_erl0.c | s | 28K | 876 | Andy Grover | agrover@redhat.com | 1334450438 |  | target/iscsi: Eliminate iscsi_cmd.data_length  Redundant, just use iscsi_cmd->se_cmd.data_length once se_cmd is initialized, or hdr->data_length before then.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_device.c | s | 2.3K | 58 | Andy Grover | agrover@redhat.com | 1330209467 |  | target/iscsi: Remove unneeded wrapper functions  iscsit_get_lun_for_{cmd,tmr} are unnecessary.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_auth.h | s | 831B | 24 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target.c | s | 122K | 3894 | Nicholas Bellinger | nab@linux-iscsi.org | 1337559924 |  | iscsi-target: Fix iov_count calculation bug in iscsit_allocate_iovecs  This patch fixes a bug in iscsit_allocate_iovecs() where iov_count was incorrectly calculated using min(1UL, data_length / PAGE_SIZE) instead of max(1UL, data_length / PAGE_SIZE), that ends up triggering an OOPs for large block I/O when the SGL <-> iovec mapping exceeds the bogus iov_count allocation size.  This is a regression introduced during the iscsi-target conversion back to using core memory allocation here:  commit bfb79eac2026b411df9e253a9c350039b4b04bb7 Author: Andy Grover <agrover@redhat.com> Date:   Tue Apr 3 15:51:29 2012 -0700      target/iscsi: Go back to core allocating data buffer for cmd  Cc: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_tq.c | s | 13K | 454 | Roland Dreier | roland@purestorage.com | 1330209466 |  | target: Use LIST_HEAD()/DEFINE_MUTEX() for static objects  Instead of     static struct list_head foo;    static struct mutex bar;     ...     INIT_LIST_HEAD(&foo);    mutex_init(&bar);  just do     static LIST_HEAD(foo);    static DEFINE_MUTEX(bar);  Also remove some superfluous struct list_head and spinlock_t initialization calls where the variables are already defined using macros that initialize them.  This saves a decent amount of compiled code too:      add/remove: 0/0 grow/shrink: 0/3 up/down: 0/-178 (-178)     function                                     old     new   delta     target_core_init_configfs                    898     850     -48     core_scsi3_emulate_pro_preempt              1742    1683     -59     iscsi_thread_set_init                        159      88     -71  Signed-off-by: Roland Dreier <roland@purestorage.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | Kconfig | g | 251B |  | Randy Dunlap | rdunlap@xenotime.net | 1311884178 |  | target: iscsi_target depends on NET  iscsi target code uses lots on network interface functions, so it should depend on NET.  Fixes many build errors when NET is not enabled:  ERROR: "kernel_sendmsg" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "in_aton" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "sock_release" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "kernel_listen" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "kernel_setsockopt" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "kernel_recvmsg" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "kernel_accept" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "sock_create" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "kernel_bind" [drivers/target/iscsi/iscsi_target_mod.ko] undefined! ERROR: "in6_pton" [drivers/target/iscsi/iscsi_target_mod.ko] undefined!  Signed-off-by: Randy Dunlap <rdunlap@xenotime.net> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_stat.h | s | 1.7K | 56 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_datain_values.c | s | 14K | 441 | Andy Grover | agrover@redhat.com | 1334450438 |  | target/iscsi: Eliminate iscsi_cmd.data_length  Redundant, just use iscsi_cmd->se_cmd.data_length once se_cmd is initialized, or hdr->data_length before then.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_core.h | s | 24K | 791 | Andy Grover | agrover@redhat.com | 1334450439 |  | target/iscsi: Go back to core allocating data buffer for cmd  We originally changed iscsi to allocate its own buffers just as an intermediate step to clean up some core buffer allocation mechanisms. Now we can put it back.  Also had to change allocate_iovecs to use data_length instead of t_data_nents because iovecs are now allocated before the data buffer, thus t_data_nents is not yet initialized.  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_erl2.h | s | 974B | 16 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target_login.h | s | 546B | 10 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
f | iscsi_target.h | s | 2.1K | 37 | Andy Grover | agrover@redhat.com | 1334450435 |  | target/iscsi: Misc cleanups from Agrover (round 2)  This patch includes the handful of squashed patches for target/iscsi from Andy's original series into lio-core/master code:  *) Make iscsit_add_reject static *) Remove unused data_offset_end from iscsi_datain_req *) Remove "#if 0" stubs *) Rename iscsi_datain_req to cmd_datain_node *) Cleanups for built_r2ts_for_cmd() *) Cleanups for Cleanup build_sendtargets_response()  Signed-off-by: Andy Grover <agrover@redhat.com> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_stat.c | s | 27K | 803 | Jörn Engel | joern@logfs.org | 1323862087 |  | target: remove useless casts  A reader should spend an extra moment whenever noticing a cast, because either something special is going on that deserves extra attention or, as is all too often the case, the code is wrong.  These casts, afaics, have all been useless.  They cast a foo* to a foo*, cast a void* to the assigned type, cast a foo* to void*, before assigning it to a void* variable, etc.  In a few cases I also removed an additional &...[0], which is equally useless.  Lastly I added three FIXMEs where, to the best of my judgement, the code appears to have a bug.  It would be good if someone could check these.  Signed-off-by: Joern Engel <joern@logfs.org> Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
f | iscsi_target_tmr.h | s | 613B | 12 | Nicholas Bellinger | nab@linux-iscsi.org | 1311671803 |  | iscsi-target: Add iSCSI fabric support for target v4.1  The Linux-iSCSI.org target module is a full featured in-kernel software implementation of iSCSI target mode (RFC-3720) for the current WIP mainline target v4.1 infrastructure code for the v3.1 kernel.  More information can be found here:  http://linux-iscsi.org/wiki/ISCSI  This includes support for:     * RFC-3720 defined request / response state machines and support for      all defined iSCSI operation codes from Section 10.2.1.2 using libiscsi      include/scsi/iscsi_proto.h PDU definitions    * Target v4.1 compatible control plane using the generic layout in      target_core_fabric_configfs.c and fabric dependent attributes      within /sys/kernel/config/target/iscsi/ subdirectories.    * Target v4.1 compatible iSCSI statistics based on RFC-4544 (iSCSI MIBS)    * Support for IPv6 and IPv4 network portals in M:N mapping to TPGs    * iSCSI Error Recovery Hierarchy support    * Per iSCSI connection RX/TX thread pair scheduling affinity    * crc32c + crc32c_intel SSEv4 instruction offload support using libcrypto    * CHAP Authentication support using libcrypto    * Conversion to use internal SGl allocation with iscsit_alloc_buffs() ->      transport_generic_map_mem_to_cmd()  (nab: Fix iscsi_proto.h struct scsi_lun usage from linux-next in commit:       iscsi: Use struct scsi_lun in iscsi structs instead of u8[8]) (nab: Fix 32-bit compile warnings)  Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Andy Grover <agrover@redhat.com> Acked-by: Roland Dreier <roland@kernel.org> Signed-off-by: Nicholas A. Bellinger <nab@linux-iscsi.org>
