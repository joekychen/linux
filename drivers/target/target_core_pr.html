<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › target › target_core_pr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>target_core_pr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>
<span class="cm"> * Filename:  target_core_pr.c</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains SPC-3 compliant persistent reservations and</span>
<span class="cm"> * legacy SPC-2 reservations with compatible reservation handling (CRH=1)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009, 2010 Rising Tide Systems</span>
<span class="cm"> * Copyright (c) 2009, 2010 Linux-iSCSI.org</span>
<span class="cm"> *</span>
<span class="cm"> * Nicholas A. Bellinger &lt;nab@kernel.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;target/target_core_base.h&gt;</span>
<span class="cp">#include &lt;target/target_core_backend.h&gt;</span>
<span class="cp">#include &lt;target/target_core_fabric.h&gt;</span>
<span class="cp">#include &lt;target/target_core_configfs.h&gt;</span>

<span class="cp">#include &quot;target_core_internal.h&quot;</span>
<span class="cp">#include &quot;target_core_pr.h&quot;</span>
<span class="cp">#include &quot;target_core_ua.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Used for Specify Initiator Ports Capable Bit (SPEC_I_PT)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pr_transport_id_holder</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest_local_nexus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">dest_pr_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">dest_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">dest_node_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">dest_se_deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dest_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">core_pr_dump_initiator_port</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">isid_present_at_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;,i,0x%s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_isid</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi2_reservation_seq_non_holder</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">pr_reg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:
	<span class="k">case</span> <span class="n">RELEASE</span>:
	<span class="k">case</span> <span class="n">RELEASE_10</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi2_reservation_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pr_reg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">||</span> <span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">!=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DF_SPC2_RESERVATIONS_WITH_ISID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_res_bin_isid</span> <span class="o">==</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">sess_bin_isid</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">target_check_scsi2_reservation_conflict</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crh</span> <span class="o">=</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">==</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">conflict</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crh</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span>
			<span class="n">se_sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * From spc4r17 5.7.3 Exceptions to SPC-2 RESERVE and RELEASE</span>
<span class="cm">		 * behavior</span>
<span class="cm">		 *</span>
<span class="cm">		 * A RESERVE(6) or RESERVE(10) command shall complete with GOOD</span>
<span class="cm">		 * status, but no reservation shall be established and the</span>
<span class="cm">		 * persistent reservation shall not be changed, if the command</span>
<span class="cm">		 * is received from a) and b) below.</span>
<span class="cm">		 *</span>
<span class="cm">		 * A RELEASE(6) or RELEASE(10) command shall complete with GOOD</span>
<span class="cm">		 * status, but the persistent reservation shall not be released,</span>
<span class="cm">		 * if the command is received from a) and b)</span>
<span class="cm">		 *</span>
<span class="cm">		 * a) An I_T nexus that is a persistent reservation holder; or</span>
<span class="cm">		 * b) An I_T nexus that is registered if a registrants only or</span>
<span class="cm">		 *    all registrants type persistent reservation is present.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In all other cases, a RESERVE(6) command, RESERVE(10) command,</span>
<span class="cm">		 * RELEASE(6) command, or RELEASE(10) command shall be processed</span>
<span class="cm">		 * as defined in SPC-2.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_REGONLY</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_REGONLY</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">conflict</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Following spc2r20 5.5.1 Reservations overview:</span>
<span class="cm">		 *</span>
<span class="cm">		 * If a logical unit has executed a PERSISTENT RESERVE OUT</span>
<span class="cm">		 * command with the REGISTER or the REGISTER AND IGNORE</span>
<span class="cm">		 * EXISTING KEY service action and is still registered by any</span>
<span class="cm">		 * initiator, all RESERVE commands and all RELEASE commands</span>
<span class="cm">		 * regardless of initiator shall conflict and shall terminate</span>
<span class="cm">		 * with a RESERVATION CONFLICT status.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="n">conflict</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Received legacy SPC-2 RESERVE/RELEASE&quot;</span>
			<span class="s">&quot; while active SPC-3 registrations exist,&quot;</span>
			<span class="s">&quot; returning RESERVATION_CONFLICT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">target_scsi2_reservation_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span> <span class="o">||</span> <span class="o">!</span><span class="n">tpg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">target_check_scsi2_reservation_conflict</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">||</span> <span class="o">!</span><span class="n">sess</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">!=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_res_bin_isid</span> <span class="o">!=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">sess_bin_isid</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DF_SPC2_RESERVATIONS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DF_SPC2_RESERVATIONS_WITH_ISID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_res_bin_isid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DF_SPC2_RESERVATIONS_WITH_ISID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCSI-2 Released reservation for %s LUN: %u -&gt;&quot;</span>
		<span class="s">&quot; MAPPED LUN: %u for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">target_complete_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">GOOD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">target_scsi2_reservation_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;LongIO and Obselete Bits set, returning&quot;</span>
				<span class="s">&quot; ILLEGAL_REQUEST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_UNSUPPORTED_SCSI_OPCODE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is currently the case for target_core_mod passthrough struct se_cmd</span>
<span class="cm">	 * ops</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span> <span class="o">||</span> <span class="o">!</span><span class="n">tpg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">target_check_scsi2_reservation_conflict</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">!=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SCSI-2 RESERVATION CONFLIFT for %s fabric</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Original reserver LUN: %u %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Current attempt - LUN: %u -&gt; MAPPED LUN: %u&quot;</span>
			<span class="s">&quot; from %s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span>
			<span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reserved_node_acl</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">DF_SPC2_RESERVATIONS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">sess_bin_isid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_res_bin_isid</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">sess_bin_isid</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">DF_SPC2_RESERVATIONS_WITH_ISID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCSI-2 Reserved %s LUN: %u -&gt; MAPPED LUN: %u&quot;</span>
		<span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">target_complete_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">GOOD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Begin SPC-3/SPC-4 Persistent Reservations emulation support</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called by those initiator ports who are *NOT*</span>
<span class="cm"> * the active PR reservation holder when a reservation is present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pr_seq_non_holder</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">pr_reg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">se_deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">other_cdb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ignore_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">registered_nexus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Conflict by default */</span>
	<span class="kt">int</span> <span class="n">all_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ALL_REG, REG_ONLY */</span>
	<span class="kt">int</span> <span class="n">we</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Write Exclusive */</span>
	<span class="kt">int</span> <span class="n">legacy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Act like a legacy device and return</span>
<span class="cm">			 * RESERVATION CONFLICT on some CDBs */</span>
	<span class="cm">/*</span>
<span class="cm">	 * A legacy SPC-2 reservation is being held.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DF_SPC2_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">core_scsi2_reservation_seq_non_holder</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
					<span class="n">cdb</span><span class="p">,</span> <span class="n">pr_reg_type</span><span class="p">);</span>

	<span class="n">se_deve</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">orig_fe_lun</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * Determine if the registration should be ignored due to</span>
<span class="cm">	 * non-matching ISIDs in core_scsi3_pr_reservation_check().</span>
<span class="cm">	 */</span>
	<span class="n">ignore_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg_type</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_reg</span><span class="p">)</span>
		<span class="n">pr_reg_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80000000</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr_reg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE</span>:
		<span class="n">we</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Some commands are only allowed for the persistent reservation</span>
<span class="cm">		 * holder.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">def_pr_registered</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ignore_reg</span><span class="p">))</span>
			<span class="n">registered_nexus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_REGONLY</span>:
		<span class="n">we</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_REGONLY</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Some commands are only allowed for registered I_T Nexuses.</span>
<span class="cm">		 */</span>
		<span class="n">reg_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">def_pr_registered</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ignore_reg</span><span class="p">))</span>
			<span class="n">registered_nexus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span>:
		<span class="n">we</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Each registered I_T Nexus is a reservation holder.</span>
<span class="cm">		 */</span>
		<span class="n">all_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">def_pr_registered</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ignore_reg</span><span class="p">))</span>
			<span class="n">registered_nexus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Referenced from spc4r17 table 45 for *NON* PR holder access</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SECURITY_PROTOCOL_IN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">we</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>:
	<span class="k">case</span> <span class="n">READ_ATTRIBUTE</span>:
	<span class="k">case</span> <span class="n">READ_BUFFER</span>:
	<span class="k">case</span> <span class="n">RECEIVE_DIAGNOSTIC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">legacy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">we</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Allowed Write Exclusive */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERSISTENT_RESERVE_OUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This follows PERSISTENT_RESERVE_OUT service actions that</span>
<span class="cm">		 * are allowed in the presence of various reservations.</span>
<span class="cm">		 * See spc4r17, table 46</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PRO_CLEAR</span>:
		<span class="k">case</span> <span class="n">PRO_PREEMPT</span>:
		<span class="k">case</span> <span class="n">PRO_PREEMPT_AND_ABORT</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PRO_REGISTER</span>:
		<span class="k">case</span> <span class="n">PRO_REGISTER_AND_IGNORE_EXISTING_KEY</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PRO_REGISTER_AND_MOVE</span>:
		<span class="k">case</span> <span class="n">PRO_RESERVE</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PRO_RELEASE</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown PERSISTENT_RESERVE_OUT service&quot;</span>
				<span class="s">&quot; action: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RELEASE</span>:
	<span class="k">case</span> <span class="n">RELEASE_10</span>:
		<span class="cm">/* Handled by CRH=1 in target_scsi2_reservation_release() */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESERVE</span>:
	<span class="k">case</span> <span class="n">RESERVE_10</span>:
		<span class="cm">/* Handled by CRH=1 in target_scsi2_reservation_reserve() */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">legacy</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Conflict for legacy */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAINTENANCE_IN</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MI_MANAGEMENT_PROTOCOL_IN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">we</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Allowed Write Exclusive */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MI_REPORT_SUPPORTED_OPERATION_CODES</span>:
		<span class="k">case</span> <span class="n">MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">legacy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">we</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Allowed Write Exclusive */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MI_REPORT_ALIASES</span>:
		<span class="k">case</span> <span class="n">MI_REPORT_IDENTIFYING_INFORMATION</span>:
		<span class="k">case</span> <span class="n">MI_REPORT_PRIORITY</span>:
		<span class="k">case</span> <span class="n">MI_REPORT_TARGET_PGS</span>:
		<span class="k">case</span> <span class="n">MI_REPORT_TIMESTAMP</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Allowed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown MI Service Action: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACCESS_CONTROL_IN</span>:
	<span class="k">case</span> <span class="n">ACCESS_CONTROL_OUT</span>:
	<span class="k">case</span> <span class="n">INQUIRY</span>:
	<span class="k">case</span> <span class="n">LOG_SENSE</span>:
	<span class="k">case</span> <span class="n">READ_MEDIA_SERIAL_NUMBER</span>:
	<span class="k">case</span> <span class="n">REPORT_LUNS</span>:
	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
	<span class="k">case</span> <span class="n">PERSISTENT_RESERVE_IN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/*/ Allowed CDBs */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">other_cdb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Case where the CDB is explicitly allowed in the above switch</span>
<span class="cm">	 * statement.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">other_cdb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Allowing explict CDB: 0x%02x for %s&quot;</span>
			<span class="s">&quot; reservation holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg_type</span><span class="p">));</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if write exclusive initiator ports *NOT* holding the</span>
<span class="cm">	 * WRITE_EXCLUSIVE_* reservation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">we</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">registered_nexus</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Conflict for write exclusive</span>
<span class="cm">			 */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s Conflict for unregistered nexus&quot;</span>
				<span class="s">&quot; %s CDB: 0x%02x to %s reservation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">transport_dump_cmd_direction</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
				<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg_type</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Allow non WRITE CDBs for all Write Exclusive</span>
<span class="cm">			 * PR TYPEs to pass for registered and</span>
<span class="cm">			 * non-registered_nexuxes NOT holding the reservation.</span>
<span class="cm">			 *</span>
<span class="cm">			 * We only make noise for the unregisterd nexuses,</span>
<span class="cm">			 * as we expect registered non-reservation holding</span>
<span class="cm">			 * nexuses to issue CDBs.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Allowing implict CDB: 0x%02x&quot;</span>
					<span class="s">&quot; for %s reservation on unregistered&quot;</span>
					<span class="s">&quot; nexus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg_type</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">reg_only</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">all_reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For PR_*_REG_ONLY and PR_*_ALL_REG reservations,</span>
<span class="cm">			 * allow commands from registered nexuses.</span>
<span class="cm">			 */</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Allowing implict CDB: 0x%02x for %s&quot;</span>
				<span class="s">&quot; reservation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg_type</span><span class="p">));</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s Conflict for %sregistered nexus %s CDB: 0x%2x&quot;</span>
		<span class="s">&quot; for %s reservation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">transport_dump_cmd_direction</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
		<span class="p">(</span><span class="n">registered_nexus</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">,</span>
		<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg_type</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Conflict by default */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">core_scsi3_pr_generation</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * PRGeneration field shall contain the value of a 32-bit wrapping</span>
<span class="cm">	 * counter mainted by the device server.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that this is done regardless of Active Persist across</span>
<span class="cm">	 * Target PowerLoss (APTPL)</span>
<span class="cm">	 *</span>
<span class="cm">	 * See spc4r17 section 6.3.12 READ_KEYS service action</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">prg</span> <span class="o">=</span> <span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">prg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pr_reservation_check</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pr_reg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * A legacy SPC-2 reservation is being held.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DF_SPC2_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">core_scsi2_reservation_check</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pr_reg_type</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pr_reg_type</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">!=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="o">-&gt;</span><span class="n">isid_present_at_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_bin_isid</span> <span class="o">==</span>
	       <span class="n">sess</span><span class="o">-&gt;</span><span class="n">sess_bin_isid</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use bit in *pr_reg_type to notify ISID mismatch in</span>
<span class="cm">	 * core_scsi3_pr_seq_non_holder().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pr_reg_type</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="nf">__core_scsi3_do_alloc_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isid</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">all_tg_pt</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">aptpl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>

	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate struct t10_pr_registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_aptpl_buf_len</span><span class="p">,</span>
					<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate pr_reg-&gt;pr_aptpl_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_abort_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_mem_list</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="n">nacl</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span> <span class="o">=</span> <span class="n">deve</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_target_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">=</span> <span class="n">sa_res_key</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span> <span class="o">=</span> <span class="n">all_tg_pt</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl</span> <span class="o">=</span> <span class="n">aptpl</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tg_pt_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If an ISID value for this SCSI Initiator Port exists,</span>
<span class="cm">	 * save it to the registration now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_bin_isid</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">isid</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_isid</span><span class="p">,</span> <span class="n">PR_REG_ISID_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">isid</span><span class="p">);</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">isid_present_at_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pr_reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">core_scsi3_lunacl_depend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function used for handling PR registrations for ALL_TG_PT=1 and ALL_TG_PT=0</span>
<span class="cm"> * modes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="nf">__core_scsi3_alloc_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isid</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">all_tg_pt</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">aptpl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">port_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_atp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp_safe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Create a registration for the I_T Nexus upon which the</span>
<span class="cm">	 * PROUT REGISTER was received.</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">__core_scsi3_do_alloc_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">deve</span><span class="p">,</span> <span class="n">isid</span><span class="p">,</span>
			<span class="n">sa_res_key</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Return pointer to pr_reg for ALL_TG_PT=0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all_tg_pt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pr_reg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Create list of matching SCSI Initiator Port registrations</span>
<span class="cm">	 * for ALL_TG_PT=1</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_sep_list</span><span class="p">,</span> <span class="n">sep_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tg_pt_ref_cnt</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">deve_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_list</span><span class="p">,</span>
					<span class="n">alua_port_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This pointer will be NULL for demo mode MappedLUNs</span>
<span class="cm">			 * that have not been make explict via a ConfigFS</span>
<span class="cm">			 * MappedLUN group for the SCSI Initiator Node ACL.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deve_tmp</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">nacl_tmp</span> <span class="o">=</span> <span class="n">deve_tmp</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span><span class="o">-&gt;</span><span class="n">se_lun_nacl</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Skip the matching struct se_node_acl that is allocated</span>
<span class="cm">			 * above..</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nacl</span> <span class="o">==</span> <span class="n">nacl_tmp</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Only perform PR registrations for target ports on</span>
<span class="cm">			 * the same fabric module as the REGISTER w/ ALL_TG_PT=1</span>
<span class="cm">			 * arrived.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tfo</span> <span class="o">!=</span> <span class="n">nacl_tmp</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Look for a matching Initiator Node ACL in ASCII format</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">nacl_tmp</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deve_tmp</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
			<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Grab a configfs group dependency that is released</span>
<span class="cm">			 * for the exception path at label out: below, or upon</span>
<span class="cm">			 * completion of adding ALL_TG_PT=1 registrations in</span>
<span class="cm">			 * __core_scsi3_add_registration()</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_lunacl_depend_item</span><span class="p">(</span><span class="n">deve_tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;core_scsi3_lunacl_depend&quot;</span>
						<span class="s">&quot;_item() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tg_pt_ref_cnt</span><span class="p">);</span>
				<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deve_tmp</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
				<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Located a matching SCSI Initiator Port on a different</span>
<span class="cm">			 * port, allocate the pr_reg_atp and attach it to the</span>
<span class="cm">			 * pr_reg-&gt;pr_reg_atp_list that will be processed once</span>
<span class="cm">			 * the original *pr_reg is processed in</span>
<span class="cm">			 * __core_scsi3_add_registration()</span>
<span class="cm">			 */</span>
			<span class="n">pr_reg_atp</span> <span class="o">=</span> <span class="n">__core_scsi3_do_alloc_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">nacl_tmp</span><span class="p">,</span> <span class="n">deve_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">sa_res_key</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg_atp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tg_pt_ref_cnt</span><span class="p">);</span>
				<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deve_tmp</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
				<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
				<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">deve_tmp</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg_atp</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_mem_list</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_list</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tg_pt_ref_cnt</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pr_reg</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="n">pr_reg_tmp_safe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_list</span><span class="p">,</span> <span class="n">pr_reg_atp_mem_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_mem_list</span><span class="p">);</span>
		<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">core_scsi3_alloc_aptpl_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">i_port</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isid</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">mapped_lun</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t_port</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">tpgt</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">target_lun</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">res_holder</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">all_tg_pt</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_port</span> <span class="o">||</span> <span class="o">!</span><span class="n">t_port</span> <span class="o">||</span> <span class="o">!</span><span class="n">sa_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal parameters for APTPL registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate struct t10_pr_registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_abort_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_mem_list</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="n">mapped_lun</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_target_lun</span> <span class="o">=</span> <span class="n">target_lun</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">=</span> <span class="n">sa_res_key</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span> <span class="o">=</span> <span class="n">all_tg_pt</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tg_pt_lun</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Always LUN_SCOPE */</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If an ISID value had been saved in APTPL metadata for this</span>
<span class="cm">	 * SCSI Initiator Port, restore it now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_bin_isid</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">isid</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_isid</span><span class="p">,</span> <span class="n">PR_REG_ISID_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">isid</span><span class="p">);</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">isid_present_at_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Copy the i_port and t_port information from caller.</span>
<span class="cm">	 */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_iport</span><span class="p">,</span> <span class="n">PR_APTPL_MAX_IPORT_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">i_port</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_tport</span><span class="p">,</span> <span class="n">PR_APTPL_MAX_TPORT_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">t_port</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tpgt</span> <span class="o">=</span> <span class="n">tpgt</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set pr_res_holder from caller, the pr_reg who is the reservation</span>
<span class="cm">	 * holder will get it&#39;s pointer set in core_scsi3_aptpl_reserve() once</span>
<span class="cm">	 * the Initiator Node LUN ACL from the fabric module is created for</span>
<span class="cm">	 * this registration.</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">res_holder</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_list</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR APTPL Successfully added registration%s from&quot;</span>
			<span class="s">&quot; metadata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">res_holder</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;+reservation&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_scsi3_aptpl_reserve</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">node_acl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: APTPL RESERVE created&quot;</span>
		<span class="s">&quot; new reservation holder TYPE: %s ALL_TG_PT: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">),</span>
		<span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] RESERVE Node: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
		<span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__core_scsi3_add_registration</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__core_scsi3_check_aptpl_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">target_lun</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i_port</span><span class="p">[</span><span class="n">PR_APTPL_MAX_IPORT_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">t_port</span><span class="p">[</span><span class="n">PR_APTPL_MAX_TPORT_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">tpgt</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">i_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_APTPL_MAX_IPORT_LEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">t_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_APTPL_MAX_TPORT_LEN</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Copy Initiator Port information from struct se_node_acl</span>
<span class="cm">	 */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">i_port</span><span class="p">,</span> <span class="n">PR_APTPL_MAX_IPORT_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">t_port</span><span class="p">,</span> <span class="n">PR_APTPL_MAX_TPORT_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_wwn</span><span class="p">(</span><span class="n">tpg</span><span class="p">));</span>
	<span class="n">tpgt</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Look for the matching registrations+reservation from those</span>
<span class="cm">	 * created from APTPL metadata.  Note that multiple registrations</span>
<span class="cm">	 * may exist for fabrics that use ISIDs in their SCSI Initiator Port</span>
<span class="cm">	 * TransportIDs.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_list</span><span class="p">,</span>
				<span class="n">pr_reg_aptpl_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_iport</span><span class="p">,</span> <span class="n">i_port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span> <span class="o">==</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_tport</span><span class="p">,</span> <span class="n">t_port</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tpgt</span> <span class="o">==</span> <span class="n">tpgt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_target_lun</span> <span class="o">==</span> <span class="n">target_lun</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="n">nacl</span><span class="p">;</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span> <span class="o">=</span> <span class="n">deve</span><span class="p">;</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tg_pt_lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl_list</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * At this point all of the pointers in *pr_reg will</span>
<span class="cm">			 * be setup, so go ahead and add the registration.</span>
<span class="cm">			 */</span>

			<span class="n">__core_scsi3_add_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If this registration is the reservation holder,</span>
<span class="cm">			 * make that happen now..</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span><span class="p">)</span>
				<span class="n">core_scsi3_aptpl_reserve</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span>
						<span class="n">nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Reenable pr_aptpl_active to accept new metadata</span>
<span class="cm">			 * updates once the SCSI device is active again..</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>
			<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">core_scsi3_check_aptpl_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lun_acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span> <span class="o">=</span> <span class="n">lun_acl</span><span class="o">-&gt;</span><span class="n">se_lun_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">lun_acl</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">res_type</span> <span class="o">!=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__core_scsi3_check_aptpl_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				<span class="n">lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">deve</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__core_scsi3_dump_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">register_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: REGISTER%s Initiator&quot;</span>
		<span class="s">&quot; Node: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="p">(</span><span class="n">register_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;_AND_MOVE&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">register_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;_AND_IGNORE_EXISTING_KEY&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
		<span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="n">i_buf</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] registration on Target Port: %s,0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_wwn</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">),</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] for %s TCM Subsystem %s Object Target&quot;</span>
		<span class="s">&quot; Port(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ALL&quot;</span> <span class="o">:</span> <span class="s">&quot;SINGLE&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] SA Res Key: 0x%016Lx PRgeneration:&quot;</span>
		<span class="s">&quot; 0x%08x  APTPL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span><span class="p">,</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this function can be called with struct se_device-&gt;dev_reservation_lock</span>
<span class="cm"> * when register_move = 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__core_scsi3_add_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">register_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">register_move</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp_safe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Increment PRgeneration counter for struct se_device upon a successful</span>
<span class="cm">	 * REGISTER, see spc4r17 section 6.3.2 READ_KEYS service action</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also, when register_move = 1 for PROUT REGISTER_AND_MOVE service</span>
<span class="cm">	 * action, the struct se_device-&gt;dev_reservation_lock will already be held,</span>
<span class="cm">	 * so we do not call core_scsi3_pr_generation() which grabs the lock</span>
<span class="cm">	 * for the REGISTER.</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span> <span class="o">=</span> <span class="p">(</span><span class="n">register_move</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span><span class="o">++</span> <span class="o">:</span>
			<span class="n">core_scsi3_pr_generation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span><span class="o">-&gt;</span><span class="n">def_pr_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">__core_scsi3_dump_registration</span><span class="p">(</span><span class="n">tfo</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="n">register_type</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Skip extra processing for ALL_TG_PT=0 or REGISTER_AND_MOVE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span> <span class="o">||</span> <span class="n">register_move</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Walk pr_reg-&gt;pr_reg_atp_list and add registrations for ALL_TG_PT=1</span>
<span class="cm">	 * allocated in __core_scsi3_alloc_registration()</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="n">pr_reg_tmp_safe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_list</span><span class="p">,</span> <span class="n">pr_reg_atp_mem_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_mem_list</span><span class="p">);</span>

		<span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span> <span class="o">=</span> <span class="n">core_scsi3_pr_generation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_list</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">);</span>
		<span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span><span class="o">-&gt;</span><span class="n">def_pr_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">__core_scsi3_dump_registration</span><span class="p">(</span><span class="n">tfo</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				<span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
				<span class="n">register_type</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Drop configfs group dependency reference from</span>
<span class="cm">		 * __core_scsi3_alloc_registration()</span>
<span class="cm">		 */</span>
		<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_alloc_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isid</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">all_tg_pt</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">aptpl</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">register_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">register_move</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>

	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">__core_scsi3_alloc_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">deve</span><span class="p">,</span> <span class="n">isid</span><span class="p">,</span>
			<span class="n">sa_res_key</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">__core_scsi3_add_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span>
			<span class="n">register_type</span><span class="p">,</span> <span class="n">register_move</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="nf">__core_scsi3_locate_pr_reg</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * First look for a matching struct se_node_acl</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">!=</span> <span class="n">nacl</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tpg</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If this registration does NOT contain a fabric provided</span>
<span class="cm">		 * ISID, then we have found a match.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">isid_present_at_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Determine if this SCSI device server requires that</span>
<span class="cm">			 * SCSI Intiatior TransportID w/ ISIDs is enforced</span>
<span class="cm">			 * for fabric modules (iSCSI) requiring them.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">sess_get_initiator_sid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">enforce_pr_isids</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">);</span>
			<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">pr_reg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the *pr_reg contains a fabric defined ISID for multi-value</span>
<span class="cm">		 * SCSI Initiator Port TransportIDs, then we expect a valid</span>
<span class="cm">		 * matching ISID to be provided by the local SCSI Initiator Port.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">isid</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_isid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">pr_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="nf">core_scsi3_locate_pr_reg</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PR_REG_ISID_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">isid_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">sess_get_initiator_sid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_LEN</span><span class="p">);</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">sess_get_initiator_sid</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">PR_REG_ISID_LEN</span><span class="p">);</span>
		<span class="n">isid_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">__core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">isid_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_check_implict_release</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_res_holder</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Perform an implict RELEASE if the registration that</span>
<span class="cm">		 * is being released is holding the reservation.</span>
<span class="cm">		 *</span>
<span class="cm">		 * From spc4r17, section 5.7.11.1:</span>
<span class="cm">		 *</span>
<span class="cm">		 * e) If the I_T nexus is the persistent reservation holder</span>
<span class="cm">		 *    and the persistent reservation is not an all registrants</span>
<span class="cm">		 *    type, then a PERSISTENT RESERVE OUT command with REGISTER</span>
<span class="cm">		 *    service action or REGISTER AND  IGNORE EXISTING KEY</span>
<span class="cm">		 *    service action with the SERVICE ACTION RESERVATION KEY</span>
<span class="cm">		 *    field set to zero (see 5.7.11.3).</span>
<span class="cm">		 */</span>
		<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * For &#39;All Registrants&#39; reservation types, all existing</span>
<span class="cm">		 * registrations are still processed as reservation holders</span>
<span class="cm">		 * in core_scsi3_pr_seq_non_holder() after the initial</span>
<span class="cm">		 * reservation holder is implictly released here.</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
			  <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unable to perform ALL_TG_PT=1&quot;</span>
			<span class="s">&quot; UNREGISTER while existing reservation with matching&quot;</span>
			<span class="s">&quot; key 0x%016Lx is present from another SCSI Initiator&quot;</span>
			<span class="s">&quot; Port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called with struct t10_reservation-&gt;registration_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__core_scsi3_free_registration</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">preempt_and_abort_list</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dec_holders</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span> <span class="o">=</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span><span class="o">-&gt;</span><span class="n">def_pr_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_list</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Caller accessing *pr_reg using core_scsi3_locate_pr_reg(),</span>
<span class="cm">	 * so call core_scsi3_put_pr_reg() to decrement our reference.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dec_holders</span><span class="p">)</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait until all reference from any other I_T nexuses for this</span>
<span class="cm">	 * *pr_reg have been released.  Because list_del() is called above,</span>
<span class="cm">	 * the last core_scsi3_put_pr_reg(pr_reg) will release this reference</span>
<span class="cm">	 * count back to zero, and we release *pr_reg.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] waiting for pr_res_holders</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: UNREGISTER Initiator&quot;</span>
		<span class="s">&quot; Node: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
		<span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] for %s TCM Subsystem %s Object Target&quot;</span>
		<span class="s">&quot; Port(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ALL&quot;</span> <span class="o">:</span> <span class="s">&quot;SINGLE&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] SA Res Key: 0x%016Lx PRgeneration:&quot;</span>
		<span class="s">&quot; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">,</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preempt_and_abort_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * For PREEMPT_AND_ABORT, the list of *pr_reg in preempt_and_abort_list</span>
<span class="cm">	 * are released once the ABORT_TASK_SET has completed..</span>
<span class="cm">	 */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_abort_list</span><span class="p">,</span> <span class="n">preempt_and_abort_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">core_scsi3_free_pr_reg_from_nacl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the passed se_node_acl matches the reservation holder,</span>
<span class="cm">	 * release the reservation.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pr_res_holder</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">==</span> <span class="n">nacl</span><span class="p">))</span>
		<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">pr_res_holder</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Release any registration associated with the struct se_node_acl.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">!=</span> <span class="n">nacl</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">core_scsi3_free_all_registrations</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_res_holder</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_res_nacl</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
		<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_res_nacl</span><span class="p">,</span>
				<span class="n">pr_res_holder</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_list</span><span class="p">,</span>
				<span class="n">pr_reg_aptpl_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_aptpl_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_tpg_depend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">configfs_depend_item</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">configfs_undepend_item</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_pr_ref_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_nodeacl_depend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">dynamic_node_acl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">configfs_depend_item</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">acl_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">dynamic_node_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">acl_pr_ref_count</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">configfs_undepend_item</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">acl_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">acl_pr_ref_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_lunacl_depend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">se_deve</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lun_acl</span> <span class="o">=</span> <span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * For nacl-&gt;dynamic_node_acl=1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lun_acl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nacl</span> <span class="o">=</span> <span class="n">lun_acl</span><span class="o">-&gt;</span><span class="n">se_lun_nacl</span><span class="p">;</span>
	<span class="n">tpg</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">configfs_depend_item</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lun_acl</span><span class="o">-&gt;</span><span class="n">se_lun_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">se_deve</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lun_acl</span> <span class="o">=</span> <span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * For nacl-&gt;dynamic_node_acl=1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lun_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nacl</span> <span class="o">=</span> <span class="n">lun_acl</span><span class="o">-&gt;</span><span class="n">se_lun_nacl</span><span class="p">;</span>
	<span class="n">tpg</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>

	<span class="n">configfs_undepend_item</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tf_subsys</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lun_acl</span><span class="o">-&gt;</span><span class="n">se_lun_group</span><span class="p">.</span><span class="n">cg_item</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_decode_spec_i_port</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">l_isid</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">all_tg_pt</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">aptpl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">tmp_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">dest_tpg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">dest_node_acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">dest_se_deve</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">local_se_deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">dest_pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">local_pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp_safe</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tid_dest_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pr_transport_id_holder</span> <span class="o">*</span><span class="n">tidh_new</span><span class="p">,</span> <span class="o">*</span><span class="n">tidh</span><span class="p">,</span> <span class="o">*</span><span class="n">tidh_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tmp_tf_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">i_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">proto_ident</span><span class="p">,</span> <span class="n">tmp_proto_ident</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">iport_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dest_iport</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">tpdl</span><span class="p">,</span> <span class="n">tid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dest_local_nexus</span><span class="p">,</span> <span class="n">prf_isid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dest_rtpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dest_iport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">local_se_deve</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">orig_fe_lun</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocate a struct pr_transport_id_holder and setup the</span>
<span class="cm">	 * local_node_acl and local_se_deve pointers and add to</span>
<span class="cm">	 * struct list_head tid_dest_list for add registration</span>
<span class="cm">	 * processing in the loop of tid_dest_list below.</span>
<span class="cm">	 */</span>
	<span class="n">tidh_new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pr_transport_id_holder</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tidh_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate tidh_new</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_list</span><span class="p">);</span>
	<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_tpg</span> <span class="o">=</span> <span class="n">tpg</span><span class="p">;</span>
	<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_node_acl</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">;</span>
	<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_se_deve</span> <span class="o">=</span> <span class="n">local_se_deve</span><span class="p">;</span>

	<span class="n">local_pr_reg</span> <span class="o">=</span> <span class="n">__core_scsi3_alloc_registration</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span> <span class="n">local_se_deve</span><span class="p">,</span> <span class="n">l_isid</span><span class="p">,</span>
				<span class="n">sa_res_key</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local_pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tidh_new</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_pr_reg</span> <span class="o">=</span> <span class="n">local_pr_reg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The local I_T nexus does not hold any configfs dependances,</span>
<span class="cm">	 * so we set tid_h-&gt;dest_local_nexus=1 to prevent the</span>
<span class="cm">	 * configfs_undepend_item() calls in the tid_dest_list loops below.</span>
<span class="cm">	 */</span>
	<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_local_nexus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_dest_list</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * For a PERSISTENT RESERVE OUT specify initiator ports payload,</span>
<span class="cm">	 * first extract TransportID Parameter Data Length, and make sure</span>
<span class="cm">	 * the value matches up to the SCSI expected data transfer length.</span>
<span class="cm">	 */</span>
	<span class="n">tpdl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">tpdl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">tpdl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tpdl</span> <span class="o">|=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tpdl</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Illegal tpdl: %u + 28 byte header&quot;</span>
			<span class="s">&quot; does not equal CDB data_length: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpdl</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Start processing the received transport IDs using the</span>
<span class="cm">	 * receiving I_T Nexus portal&#39;s fabric dependent methods to</span>
<span class="cm">	 * obtain the SCSI Initiator Port/Device Identifiers.</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tpdl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proto_ident</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">dest_tpg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_sep_list</span><span class="p">,</span> <span class="n">sep_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_tpg</span> <span class="o">=</span> <span class="n">tmp_port</span><span class="o">-&gt;</span><span class="n">sep_tpg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_tpg</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">tmp_tf_ops</span> <span class="o">=</span> <span class="n">tmp_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_tf_ops</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_proto_ident</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">tmp_tf_ops</span><span class="o">-&gt;</span><span class="n">tpg_parse_pr_out_transport_id</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Look for the matching proto_ident provided by</span>
<span class="cm">			 * the received TransportID</span>
<span class="cm">			 */</span>
			<span class="n">tmp_proto_ident</span> <span class="o">=</span> <span class="n">tmp_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_proto_ident</span><span class="p">(</span><span class="n">tmp_tpg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_proto_ident</span> <span class="o">!=</span> <span class="n">proto_ident</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">dest_rtpi</span> <span class="o">=</span> <span class="n">tmp_port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span><span class="p">;</span>

			<span class="n">i_str</span> <span class="o">=</span> <span class="n">tmp_tf_ops</span><span class="o">-&gt;</span><span class="n">tpg_parse_pr_out_transport_id</span><span class="p">(</span>
					<span class="n">tmp_tpg</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_len</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">iport_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_str</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_tpg</span><span class="o">-&gt;</span><span class="n">tpg_pr_ref_count</span><span class="p">);</span>
			<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_tpg_depend_item</span><span class="p">(</span><span class="n">tmp_tpg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; core_scsi3_tpg_depend_item()&quot;</span>
					<span class="s">&quot; for tmp_tpg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_tpg</span><span class="o">-&gt;</span><span class="n">tpg_pr_ref_count</span><span class="p">);</span>
				<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span>
					<span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Locate the desination initiator ACL to be registered</span>
<span class="cm">			 * from the decoded fabric module specific TransportID</span>
<span class="cm">			 * at *i_str.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
			<span class="n">dest_node_acl</span> <span class="o">=</span> <span class="n">__core_tpg_get_initiator_node_acl</span><span class="p">(</span>
						<span class="n">tmp_tpg</span><span class="p">,</span> <span class="n">i_str</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dest_node_acl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">acl_pr_ref_count</span><span class="p">);</span>
				<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_node_acl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">tmp_tpg</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_nodeacl_depend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;configfs_depend_item() failed&quot;</span>
					<span class="s">&quot; for dest_node_acl-&gt;acl_group</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">acl_pr_ref_count</span><span class="p">);</span>
				<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
				<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">tmp_tpg</span><span class="p">);</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span>
					<span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dest_tpg</span> <span class="o">=</span> <span class="n">tmp_tpg</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR SPEC_I_PT: Located %s Node:&quot;</span>
				<span class="s">&quot; %s Port RTPI: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dest_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">dest_rtpi</span><span class="p">);</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_tpg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR SPEC_I_PT: Unable to locate&quot;</span>
					<span class="s">&quot; dest_tpg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR SPEC_I_PT: Got %s data_length: %u tpdl: %u&quot;</span>
			<span class="s">&quot; tid_len: %d for %s + %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dest_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">,</span>
			<span class="n">tpdl</span><span class="p">,</span> <span class="n">tid_len</span><span class="p">,</span> <span class="n">i_str</span><span class="p">,</span> <span class="n">iport_ptr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tid_len</span> <span class="o">&gt;</span> <span class="n">tpdl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR SPEC_I_PT: Illegal tid_len:&quot;</span>
				<span class="s">&quot; %u for Transport ID: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid_len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
			<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Locate the desintation struct se_dev_entry pointer for matching</span>
<span class="cm">		 * RELATIVE TARGET PORT IDENTIFIER on the receiving I_T Nexus</span>
<span class="cm">		 * Target Port.</span>
<span class="cm">		 */</span>
		<span class="n">dest_se_deve</span> <span class="o">=</span> <span class="n">core_get_se_deve_from_rtpi</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">,</span>
					<span class="n">dest_rtpi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_se_deve</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate %s dest_se_deve&quot;</span>
				<span class="s">&quot; from destination RTPI: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dest_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">dest_rtpi</span><span class="p">);</span>

			<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
			<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_lunacl_depend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;core_scsi3_lunacl_depend_item()&quot;</span>
					<span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_se_deve</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
			<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
			<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
			<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span>
				<span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR SPEC_I_PT: Located %s Node: %s&quot;</span>
			<span class="s">&quot; dest_se_deve mapped_lun: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dest_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">dest_se_deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Skip any TransportIDs that already have a registration for</span>
<span class="cm">		 * this target port.</span>
<span class="cm">		 */</span>
		<span class="n">pr_reg_e</span> <span class="o">=</span> <span class="n">__core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dest_node_acl</span><span class="p">,</span>
					<span class="n">iport_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg_e</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_e</span><span class="p">);</span>
			<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
			<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
			<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">tid_len</span><span class="p">;</span>
			<span class="n">tpdl</span> <span class="o">-=</span> <span class="n">tid_len</span><span class="p">;</span>
			<span class="n">tid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate a struct pr_transport_id_holder and setup</span>
<span class="cm">		 * the dest_node_acl and dest_se_deve pointers for the</span>
<span class="cm">		 * loop below.</span>
<span class="cm">		 */</span>
		<span class="n">tidh_new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pr_transport_id_holder</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tidh_new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate tidh_new</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
			<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
			<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span>
				<span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_list</span><span class="p">);</span>
		<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_tpg</span> <span class="o">=</span> <span class="n">dest_tpg</span><span class="p">;</span>
		<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_node_acl</span> <span class="o">=</span> <span class="n">dest_node_acl</span><span class="p">;</span>
		<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_se_deve</span> <span class="o">=</span> <span class="n">dest_se_deve</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Allocate, but do NOT add the registration for the</span>
<span class="cm">		 * TransportID referenced SCSI Initiator port.  This</span>
<span class="cm">		 * done because of the following from spc4r17 in section</span>
<span class="cm">		 * 6.14.3 wrt SPEC_I_PT:</span>
<span class="cm">		 *</span>
<span class="cm">		 * &quot;If a registration fails for any initiator port (e.g., if th</span>
<span class="cm">		 * logical unit does not have enough resources available to</span>
<span class="cm">		 * hold the registration information), no registrations shall be</span>
<span class="cm">		 * made, and the command shall be terminated with</span>
<span class="cm">		 * CHECK CONDITION status.&quot;</span>
<span class="cm">		 *</span>
<span class="cm">		 * That means we call __core_scsi3_alloc_registration() here,</span>
<span class="cm">		 * and then call __core_scsi3_add_registration() in the</span>
<span class="cm">		 * 2nd loop which will never fail.</span>
<span class="cm">		 */</span>
		<span class="n">dest_pr_reg</span> <span class="o">=</span> <span class="n">__core_scsi3_alloc_registration</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="n">dest_node_acl</span><span class="p">,</span> <span class="n">dest_se_deve</span><span class="p">,</span> <span class="n">iport_ptr</span><span class="p">,</span>
				<span class="n">sa_res_key</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_pr_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
			<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
			<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tidh_new</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_pr_reg</span> <span class="o">=</span> <span class="n">dest_pr_reg</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tidh_new</span><span class="o">-&gt;</span><span class="n">dest_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_dest_list</span><span class="p">);</span>

		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">tid_len</span><span class="p">;</span>
		<span class="n">tpdl</span> <span class="o">-=</span> <span class="n">tid_len</span><span class="p">;</span>
		<span class="n">tid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go ahead and create a registrations from tid_dest_list for the</span>
<span class="cm">	 * SPEC_I_PT provided TransportID for the *tidh referenced dest_node_acl</span>
<span class="cm">	 * and dest_se_deve.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The SA Reservation Key from the PROUT is set for the</span>
<span class="cm">	 * registration, and ALL_TG_PT is also passed.  ALL_TG_PT=1</span>
<span class="cm">	 * means that the TransportID Initiator port will be</span>
<span class="cm">	 * registered on all of the target ports in the SCSI target device</span>
<span class="cm">	 * ALL_TG_PT=0 means the registration will only be for the</span>
<span class="cm">	 * SCSI target port the PROUT REGISTER with SPEC_I_PT=1</span>
<span class="cm">	 * was received.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tidh</span><span class="p">,</span> <span class="n">tidh_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_dest_list</span><span class="p">,</span> <span class="n">dest_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dest_tpg</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_tpg</span><span class="p">;</span>
		<span class="n">dest_node_acl</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_node_acl</span><span class="p">;</span>
		<span class="n">dest_se_deve</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_se_deve</span><span class="p">;</span>
		<span class="n">dest_pr_reg</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_pr_reg</span><span class="p">;</span>
		<span class="n">dest_local_nexus</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_local_nexus</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tidh</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
		<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">dest_pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

		<span class="n">__core_scsi3_add_registration</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">dest_node_acl</span><span class="p">,</span>
					<span class="n">dest_pr_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] SPEC_I_PT: Successfully&quot;</span>
			<span class="s">&quot; registered Transport ID for Node: %s%s Mapped LUN:&quot;</span>
			<span class="s">&quot; %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">dest_se_deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dest_local_nexus</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
		<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
		<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * For the failure case, release everything from tid_dest_list</span>
<span class="cm">	 * including *dest_pr_reg and the configfs dependances..</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tidh</span><span class="p">,</span> <span class="n">tidh_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_dest_list</span><span class="p">,</span> <span class="n">dest_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dest_tpg</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_tpg</span><span class="p">;</span>
		<span class="n">dest_node_acl</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_node_acl</span><span class="p">;</span>
		<span class="n">dest_se_deve</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_se_deve</span><span class="p">;</span>
		<span class="n">dest_pr_reg</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_pr_reg</span><span class="p">;</span>
		<span class="n">dest_local_nexus</span> <span class="o">=</span> <span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_local_nexus</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tidh</span><span class="o">-&gt;</span><span class="n">dest_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tidh</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Release any extra ALL_TG_PT=1 registrations for</span>
<span class="cm">		 * the SPEC_I_PT=1 case.</span>
<span class="cm">		 */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="n">pr_reg_tmp_safe</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dest_pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_list</span><span class="p">,</span>
				<span class="n">pr_reg_atp_mem_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_atp_mem_list</span><span class="p">);</span>
			<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">pr_reg_tmp</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span><span class="p">);</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">dest_pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">dest_pr_reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dest_local_nexus</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
		<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
		<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_tpg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called with struct se_device-&gt;dev_reservation_lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__core_scsi3_update_aptpl_buf</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">pr_aptpl_buf_len</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">clear_aptpl_metadata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">512</span><span class="p">],</span> <span class="n">isid_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Called to clear metadata once APTPL has been deactivated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear_aptpl_metadata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pr_aptpl_buf_len</span><span class="p">,</span>
				<span class="s">&quot;No Registrations or Reservations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Walk the registration list..</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_list</span><span class="p">,</span>
			<span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">isid_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">tpg</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tg_pt_lun</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Write out any ISID value to APTPL metadata that was included</span>
<span class="cm">		 * in the original registration.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">isid_present_at_reg</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">isid_buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;initiator_sid=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_isid</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Include special metadata if the pr_reg matches the</span>
<span class="cm">		 * reservation holder.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s">&quot;PR_REG_START: %d&quot;</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">initiator_fabric=%s</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;initiator_node=%s</span><span class="se">\n</span><span class="s">%s&quot;</span>
				<span class="s">&quot;sa_res_key=%llu</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;res_holder=1</span><span class="se">\n</span><span class="s">res_type=%02x</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;res_scope=%02x</span><span class="se">\n</span><span class="s">res_all_tg_pt=%d</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;mapped_lun=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg_count</span><span class="p">,</span>
				<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">isid_buf</span><span class="p">,</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">,</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">,</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s">&quot;PR_REG_START: %d</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;initiator_fabric=%s</span><span class="se">\n</span><span class="s">initiator_node=%s</span><span class="se">\n</span><span class="s">%s&quot;</span>
				<span class="s">&quot;sa_res_key=%llu</span><span class="se">\n</span><span class="s">res_holder=0</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;res_all_tg_pt=%d</span><span class="se">\n</span><span class="s">mapped_lun=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">reg_count</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">isid_buf</span><span class="p">,</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">,</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pr_aptpl_buf_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to update renaming&quot;</span>
				<span class="s">&quot; APTPL metadata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Include information about the associated SCSI target port.</span>
<span class="cm">		 */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s">&quot;target_fabric=%s</span><span class="se">\n</span><span class="s">target_node=%s</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;tpgt=%hu</span><span class="se">\n</span><span class="s">port_rtpi=%hu</span><span class="se">\n</span><span class="s">target_lun=%u</span><span class="se">\n</span><span class="s">PR_REG_END:&quot;</span>
			<span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_wwn</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span>
			<span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span><span class="p">,</span> <span class="n">lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">reg_count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pr_aptpl_buf_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to update renaming&quot;</span>
				<span class="s">&quot; APTPL metadata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">reg_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg_count</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;No Registrations or Reservations&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_update_aptpl_buf</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">pr_aptpl_buf_len</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">clear_aptpl_metadata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__core_scsi3_update_aptpl_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pr_aptpl_buf_len</span><span class="p">,</span>
				<span class="n">clear_aptpl_metadata</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called with struct se_device-&gt;aptpl_file_mutex held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__core_scsi3_write_aptpl_to_file</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">pr_aptpl_buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_wwn</span> <span class="o">*</span><span class="n">wwn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_TRUNC</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wwn</span><span class="o">-&gt;</span><span class="n">unit_serial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;WWN value for struct se_device does not fit&quot;</span>
			<span class="s">&quot; into path buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s">&quot;/var/target/pr/aptpl_%s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wwn</span><span class="o">-&gt;</span><span class="n">unit_serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">file</span> <span class="o">=</span> <span class="n">filp_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">file</span> <span class="o">||</span> <span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;filp_open(%s) for APTPL metadata&quot;</span>
			<span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_aptpl_buf_len</span><span class="p">)</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Add extra for NULL */</span>
	<span class="k">else</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">pr_aptpl_buf_len</span><span class="p">;</span>

	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vfs_writev</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Error writing APTPL metadata file: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="n">filp_close</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">filp_close</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_update_and_write_aptpl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">in_pr_aptpl_buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">null_buf</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pr_aptpl_buf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">clear_aptpl_metadata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Can be called with a NULL pointer from PROUT service action CLEAR</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">null_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">null_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * This will clear the APTPL metadata to:</span>
<span class="cm">		 * &quot;No Registrations or Reservations&quot; status</span>
<span class="cm">		 */</span>
		<span class="n">pr_aptpl_buf_len</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">clear_aptpl_metadata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">in_buf</span><span class="p">;</span>
		<span class="n">pr_aptpl_buf_len</span> <span class="o">=</span> <span class="n">in_pr_aptpl_buf_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_aptpl_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pr_aptpl_buf_len</span><span class="p">,</span>
				<span class="n">clear_aptpl_metadata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * __core_scsi3_write_aptpl_to_file() will call strlen()</span>
<span class="cm">	 * on the passed buf to determine pr_aptpl_buf_len.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__core_scsi3_write_aptpl_to_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_emulate_pro_register</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">aptpl</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">all_tg_pt</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">spec_i_pt</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">ignore_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">se_deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_p</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="cm">/* Used for APTPL metadata w/ UNREGISTER */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pr_aptpl_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">isid_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">isid_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pr_holder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_sess</span> <span class="o">||</span> <span class="o">!</span><span class="n">se_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: se_sess || struct se_lun is NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">se_tpg</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="n">se_deve</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">orig_fe_lun</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">sess_get_initiator_sid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isid_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_LEN</span><span class="p">);</span>
		<span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">sess_get_initiator_sid</span><span class="p">(</span><span class="n">se_sess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isid_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_LEN</span><span class="p">);</span>
		<span class="n">isid_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isid_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Follow logic from spc4r17 Section 5.7.7, Register Behaviors Table 47</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg_e</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span> <span class="n">se_sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg_e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Reservation Key non-zero&quot;</span>
				<span class="s">&quot; for SA REGISTER, returning CONFLICT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do nothing but return GOOD status.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sa_res_key</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec_i_pt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Perform the Service Action REGISTER on the Initiator</span>
<span class="cm">			 * Port Endpoint that the PRO was received from on the</span>
<span class="cm">			 * Logical Unit of the SCSI device server.</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_alloc_registration</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
					<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span> <span class="n">se_deve</span><span class="p">,</span> <span class="n">isid_ptr</span><span class="p">,</span>
					<span class="n">sa_res_key</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">,</span>
					<span class="n">ignore_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate&quot;</span>
					<span class="s">&quot; struct t10_pr_registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Register both the Initiator port that received</span>
<span class="cm">			 * PROUT SA REGISTER + SPEC_I_PT=1 and extract SCSI</span>
<span class="cm">			 * TransportID from Parameter list and loop through</span>
<span class="cm">			 * fabric dependent parameter list while calling</span>
<span class="cm">			 * logic from of core_scsi3_alloc_registration() for</span>
<span class="cm">			 * each TransportID provided SCSI Initiator Port/Device</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_decode_spec_i_port</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">,</span>
					<span class="n">isid_ptr</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Nothing left to do for the APTPL=0 case.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aptpl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Deactivated for&quot;</span>
					<span class="s">&quot; REGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Locate the newly allocated local I_T Nexus *pr_reg, and</span>
<span class="cm">		 * update the APTPL metadata information using its</span>
<span class="cm">		 * preallocated *pr_reg-&gt;pr_aptpl_buf.</span>
<span class="cm">		 */</span>
		<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span> <span class="n">se_sess</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Activated for REGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Locate the existing *pr_reg via struct se_node_acl pointers</span>
<span class="cm">		 */</span>
		<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">pr_reg_e</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_key</span> <span class="o">!=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER: Received&quot;</span>
					<span class="s">&quot; res_key: 0x%016Lx does not match&quot;</span>
					<span class="s">&quot; existing SA REGISTER res_key:&quot;</span>
					<span class="s">&quot; 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_key</span><span class="p">,</span>
					<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">);</span>
				<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec_i_pt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR UNREGISTER: SPEC_I_PT&quot;</span>
				<span class="s">&quot; set while sa_res_key=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * An existing ALL_TG_PT=1 registration being released</span>
<span class="cm">		 * must also set ALL_TG_PT=1 in the incoming PROUT.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">all_tg_pt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR UNREGISTER: ALL_TG_PT=1&quot;</span>
				<span class="s">&quot; registration exists, but ALL_TG_PT=1 bit not&quot;</span>
				<span class="s">&quot; present in received PROUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate APTPL metadata buffer used for UNREGISTER ops</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aptpl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_aptpl_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_aptpl_buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate&quot;</span>
					<span class="s">&quot; pr_aptpl_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span>
					<span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * sa_res_key=0 Unregister Reservation Key for registered I_T</span>
<span class="cm">		 * Nexus sa_res_key=1 Change Reservation Key for registered I_T</span>
<span class="cm">		 * Nexus.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sa_res_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_holder</span> <span class="o">=</span> <span class="n">core_scsi3_check_implict_release</span><span class="p">(</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr_holder</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pr_aptpl_buf</span><span class="p">);</span>
				<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Release all ALL_TG_PT=1 for the matching SCSI Initiator Port</span>
<span class="cm">			 * and matching pr_res_key.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg_p</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span>
						<span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg_p</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg_p</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">!=</span> <span class="n">res_key</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span> <span class="o">==</span> <span class="n">pr_reg_p</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
						   <span class="n">pr_reg_p</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">pr_reg_p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Release the calling I_T Nexus registration now..</span>
<span class="cm">			 */</span>
			<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span>
							<span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * From spc4r17, section 5.7.11.3 Unregistering</span>
<span class="cm">			 *</span>
<span class="cm">			 * If the persistent reservation is a registrants only</span>
<span class="cm">			 * type, the device server shall establish a unit</span>
<span class="cm">			 * attention condition for the initiator port associated</span>
<span class="cm">			 * with every registered I_T nexus except for the I_T</span>
<span class="cm">			 * nexus on which the PERSISTENT RESERVE OUT command was</span>
<span class="cm">			 * received, with the additional sense code set to</span>
<span class="cm">			 * RESERVATIONS RELEASED.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr_holder</span> <span class="o">&amp;&amp;</span>
			   <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_REGONLY</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_REGONLY</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pr_reg_p</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span>
						<span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">core_scsi3_ua_allocate</span><span class="p">(</span>
						<span class="n">pr_reg_p</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">,</span>
						<span class="n">pr_reg_p</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">,</span>
						<span class="mh">0x2A</span><span class="p">,</span>
						<span class="n">ASCQ_2AH_RESERVATIONS_RELEASED</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aptpl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Deactivated&quot;</span>
						<span class="s">&quot; for UNREGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Activated&quot;</span>
						<span class="s">&quot; for UNREGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">pr_aptpl_buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Increment PRgeneration counter for struct se_device&quot;</span>
<span class="cm">			 * upon a successful REGISTER, see spc4r17 section 6.3.2</span>
<span class="cm">			 * READ_KEYS service action.</span>
<span class="cm">			 */</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span> <span class="o">=</span> <span class="n">core_scsi3_pr_generation</span><span class="p">(</span>
							<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">);</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">=</span> <span class="n">sa_res_key</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] REGISTER%s: Changed Reservation&quot;</span>
				<span class="s">&quot; Key for %s to: 0x%016Lx PRgeneration:&quot;</span>
				<span class="s">&quot; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="p">(</span><span class="n">ignore_key</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;_AND_IGNORE_EXISTING_KEY&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
				<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aptpl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Deactivated&quot;</span>
						<span class="s">&quot; for REGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Activated&quot;</span>
						<span class="s">&quot; for REGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">pr_aptpl_buf</span><span class="p">);</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE</span>:
		<span class="k">return</span> <span class="s">&quot;Write Exclusive Access&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS</span>:
		<span class="k">return</span> <span class="s">&quot;Exclusive Access&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_REGONLY</span>:
		<span class="k">return</span> <span class="s">&quot;Write Exclusive Access, Registrants Only&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_REGONLY</span>:
		<span class="k">return</span> <span class="s">&quot;Exclusive Access, Registrants Only&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span>:
		<span class="k">return</span> <span class="s">&quot;Write Exclusive Access, All Registrants&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span>:
		<span class="k">return</span> <span class="s">&quot;Exclusive Access, All Registrants&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;Unknown SPC-3 PR Type&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pro_reserve</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">scope</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_sess</span> <span class="o">||</span> <span class="o">!</span><span class="n">se_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: se_sess || struct se_lun is NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Locate the existing *pr_reg via struct se_node_acl pointers</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span>
				<span class="n">se_sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unable to locate&quot;</span>
			<span class="s">&quot; PR_REGISTERED *pr_reg for RESERVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 Section 5.7.9: Reserving:</span>
<span class="cm">	 *</span>
<span class="cm">	 * An application client creates a persistent reservation by issuing</span>
<span class="cm">	 * a PERSISTENT RESERVE OUT command with RESERVE service action through</span>
<span class="cm">	 * a registered I_T nexus with the following parameters:</span>
<span class="cm">	 *    a) RESERVATION KEY set to the value of the reservation key that is</span>
<span class="cm">	 * 	 registered with the logical unit for the I_T nexus; and</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_key</span> <span class="o">!=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR RESERVE: Received res_key: 0x%016Lx&quot;</span>
			<span class="s">&quot; does not match existing SA REGISTER res_key:&quot;</span>
			<span class="s">&quot; 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_key</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 Section 5.7.9: Reserving:</span>
<span class="cm">	 *</span>
<span class="cm">	 * From above:</span>
<span class="cm">	 *  b) TYPE field and SCOPE field set to the persistent reservation</span>
<span class="cm">	 *     being created.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Only one persistent reservation is allowed at a time per logical unit</span>
<span class="cm">	 * and that persistent reservation has a scope of LU_SCOPE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scope</span> <span class="o">!=</span> <span class="n">PR_SCOPE_LU_SCOPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Illegal SCOPE: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * See if we have an existing PR reservation holder pointer at</span>
<span class="cm">	 * struct se_device-&gt;dev_pr_res_holder in the form struct t10_pr_registration</span>
<span class="cm">	 * *pr_res_holder.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pr_res_holder</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * From spc4r17 Section 5.7.9: Reserving:</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the device server receives a PERSISTENT RESERVE OUT</span>
<span class="cm">		 * command from an I_T nexus other than a persistent reservation</span>
<span class="cm">		 * holder (see 5.7.10) that attempts to create a persistent</span>
<span class="cm">		 * reservation when a persistent reservation already exists for</span>
<span class="cm">		 * the logical unit, then the command shall be completed with</span>
<span class="cm">		 * RESERVATION CONFLICT status.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_res_holder</span> <span class="o">!=</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_res_nacl</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Attempted RESERVE from&quot;</span>
				<span class="s">&quot; [%s]: %s while reservation already held by&quot;</span>
				<span class="s">&quot; [%s]: %s, returning RESERVATION_CONFLICT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
				<span class="n">pr_res_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * From spc4r17 Section 5.7.9: Reserving:</span>
<span class="cm">		 *</span>
<span class="cm">		 * If a persistent reservation holder attempts to modify the</span>
<span class="cm">		 * type or scope of an existing persistent reservation, the</span>
<span class="cm">		 * command shall be completed with RESERVATION CONFLICT status.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">!=</span> <span class="n">scope</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_res_nacl</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Attempted RESERVE from&quot;</span>
				<span class="s">&quot; [%s]: %s trying to change TYPE and/or SCOPE,&quot;</span>
				<span class="s">&quot; while reservation already held by [%s]: %s,&quot;</span>
				<span class="s">&quot; returning RESERVATION_CONFLICT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
				<span class="n">pr_res_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * From spc4r17 Section 5.7.9: Reserving:</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the device server receives a PERSISTENT RESERVE OUT</span>
<span class="cm">		 * command with RESERVE service action where the TYPE field and</span>
<span class="cm">		 * the SCOPE field contain the same values as the existing type</span>
<span class="cm">		 * and scope from a persistent reservation holder, it shall not</span>
<span class="cm">		 * make any change to the existing persistent reservation and</span>
<span class="cm">		 * shall completethe command with GOOD status.</span>
<span class="cm">		 */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Otherwise, our *pr_reg becomes the PR reservation holder for said</span>
<span class="cm">	 * TYPE/SCOPE.  Also set the received scope and type in *pr_reg.</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="p">;</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: RESERVE created new&quot;</span>
		<span class="s">&quot; reservation holder TYPE: %s ALL_TG_PT: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">type</span><span class="p">),</span>
		<span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] RESERVE Node: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
			<span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Updated APTPL metadata&quot;</span>
					<span class="s">&quot; for RESERVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_emulate_pro_reserve</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">scope</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_REGONLY</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_REGONLY</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_pro_reserve</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">res_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unknown Service Action RESERVE Type:&quot;</span>
			<span class="s">&quot; 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called with struct se_device-&gt;dev_reservation_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__core_scsi3_complete_pro_release</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">explict</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span> <span class="o">=</span> <span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Go ahead and release the current PR reservation holder.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: %s RELEASE cleared&quot;</span>
		<span class="s">&quot; reservation holder TYPE: %s ALL_TG_PT: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="p">(</span><span class="n">explict</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;explict&quot;</span> <span class="o">:</span> <span class="s">&quot;implict&quot;</span><span class="p">,</span>
		<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">),</span>
		<span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] RELEASE Node: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
		<span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear TYPE and SCOPE for the next PROUT Service Action: RESERVE</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_emulate_pro_release</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">scope</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_p</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">all_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_sess</span> <span class="o">||</span> <span class="o">!</span><span class="n">se_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: se_sess || struct se_lun is NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Locate the existing *pr_reg via struct se_node_acl pointers</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span> <span class="n">se_sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unable to locate&quot;</span>
			<span class="s">&quot; PR_REGISTERED *pr_reg for RELEASE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 Section 5.7.11.2 Releasing:</span>
<span class="cm">	 *</span>
<span class="cm">	 * If there is no persistent reservation or in response to a persistent</span>
<span class="cm">	 * reservation release request from a registered I_T nexus that is not a</span>
<span class="cm">	 * persistent reservation holder (see 5.7.10), the device server shall</span>
<span class="cm">	 * do the following:</span>
<span class="cm">	 *</span>
<span class="cm">	 *     a) Not release the persistent reservation, if any;</span>
<span class="cm">	 *     b) Not remove any registrations; and</span>
<span class="cm">	 *     c) Complete the command with GOOD status.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No persistent reservation, return GOOD status.</span>
<span class="cm">		 */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span><span class="p">))</span>
		<span class="n">all_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">all_reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pr_res_holder</span> <span class="o">!=</span> <span class="n">pr_reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Non &#39;All Registrants&#39; PR Type cases..</span>
<span class="cm">		 * Release request from a registered I_T nexus that is not a</span>
<span class="cm">		 * persistent reservation holder. return GOOD status.</span>
<span class="cm">		 */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 Section 5.7.11.2 Releasing:</span>
<span class="cm">	 *</span>
<span class="cm">	 * Only the persistent reservation holder (see 5.7.10) is allowed to</span>
<span class="cm">	 * release a persistent reservation.</span>
<span class="cm">	 *</span>
<span class="cm">	 * An application client releases the persistent reservation by issuing</span>
<span class="cm">	 * a PERSISTENT RESERVE OUT command with RELEASE service action through</span>
<span class="cm">	 * an I_T nexus that is a persistent reservation holder with the</span>
<span class="cm">	 * following parameters:</span>
<span class="cm">	 *</span>
<span class="cm">	 *     a) RESERVATION KEY field set to the value of the reservation key</span>
<span class="cm">	 *	  that is registered with the logical unit for the I_T nexus;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_key</span> <span class="o">!=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR RELEASE: Received res_key: 0x%016Lx&quot;</span>
			<span class="s">&quot; does not match existing SA REGISTER res_key:&quot;</span>
			<span class="s">&quot; 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_key</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 Section 5.7.11.2 Releasing and above:</span>
<span class="cm">	 *</span>
<span class="cm">	 * b) TYPE field and SCOPE field set to match the persistent</span>
<span class="cm">	 *    reservation being released.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">!=</span> <span class="n">scope</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_res_nacl</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR RELEASE: Attempted to release&quot;</span>
			<span class="s">&quot; reservation from [%s]: %s with different TYPE &quot;</span>
			<span class="s">&quot;and/or SCOPE  while reservation already held by&quot;</span>
			<span class="s">&quot; [%s]: %s, returning RESERVATION_CONFLICT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
			<span class="n">pr_res_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * In response to a persistent reservation release request from the</span>
<span class="cm">	 * persistent reservation holder the device server shall perform a</span>
<span class="cm">	 * release by doing the following as an uninterrupted series of actions:</span>
<span class="cm">	 * a) Release the persistent reservation;</span>
<span class="cm">	 * b) Not remove any registration(s);</span>
<span class="cm">	 * c) If the released persistent reservation is a registrants only type</span>
<span class="cm">	 * or all registrants type persistent reservation,</span>
<span class="cm">	 *    the device server shall establish a unit attention condition for</span>
<span class="cm">	 *    the initiator port associated with every regis-</span>
<span class="cm">	 *    tered I_T nexus other than I_T nexus on which the PERSISTENT</span>
<span class="cm">	 *    RESERVE OUT command with RELEASE service action was received,</span>
<span class="cm">	 *    with the additional sense code set to RESERVATIONS RELEASED; and</span>
<span class="cm">	 * d) If the persistent reservation is of any other type, the device</span>
<span class="cm">	 *    server shall not establish a unit attention condition.</span>
<span class="cm">	 */</span>
	<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span>
			<span class="n">pr_reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_REGONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_REGONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If no UNIT ATTENTION conditions will be established for</span>
<span class="cm">		 * PR_TYPE_WRITE_EXCLUSIVE or PR_TYPE_EXCLUSIVE_ACCESS</span>
<span class="cm">		 * go ahead and check for APTPL=1 update+write below</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">write_aptpl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pr_reg_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span>
			<span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do not establish a UNIT ATTENTION condition</span>
<span class="cm">		 * for the calling I_T Nexus</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg_p</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">core_scsi3_ua_allocate</span><span class="p">(</span><span class="n">pr_reg_p</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">,</span>
				<span class="n">pr_reg_p</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">,</span>
				<span class="mh">0x2A</span><span class="p">,</span> <span class="n">ASCQ_2AH_RESERVATIONS_RELEASED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>

<span class="nl">write_aptpl:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Updated APTPL metadata for RELEASE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_emulate_pro_clear</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_n</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">calling_it_nexus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Locate the existing *pr_reg via struct se_node_acl pointers</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg_n</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
			<span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span> <span class="n">se_sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unable to locate&quot;</span>
			<span class="s">&quot; PR_REGISTERED *pr_reg for CLEAR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 section 5.7.11.6, Clearing:</span>
<span class="cm">	 *</span>
<span class="cm">	 * Any application client may release the persistent reservation and</span>
<span class="cm">	 * remove all registrations from a device server by issuing a</span>
<span class="cm">	 * PERSISTENT RESERVE OUT command with CLEAR service action through a</span>
<span class="cm">	 * registered I_T nexus with the following parameter:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	a) RESERVATION KEY field set to the value of the reservation key</span>
<span class="cm">	 * 	   that is registered with the logical unit for the I_T nexus.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_key</span> <span class="o">!=</span> <span class="n">pr_reg_n</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER: Received&quot;</span>
			<span class="s">&quot; res_key: 0x%016Lx does not match&quot;</span>
			<span class="s">&quot; existing SA REGISTER res_key:&quot;</span>
			<span class="s">&quot; 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_key</span><span class="p">,</span> <span class="n">pr_reg_n</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_n</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * a) Release the persistent reservation, if any;</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_res_nacl</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
		<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_res_nacl</span><span class="p">,</span>
			<span class="n">pr_res_holder</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * b) Remove all registration(s) (see spc4r17 5.7.7);</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">calling_it_nexus</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg_n</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
		<span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">;</span>
		<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">calling_it_nexus</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * e) Establish a unit attention condition for the initiator</span>
<span class="cm">		 *    port associated with every registered I_T nexus other</span>
<span class="cm">		 *    than the I_T nexus on which the PERSISTENT RESERVE OUT</span>
<span class="cm">		 *    command with CLEAR service action was received, with the</span>
<span class="cm">		 *    additional sense code set to RESERVATIONS PREEMPTED.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">calling_it_nexus</span><span class="p">)</span>
			<span class="n">core_scsi3_ua_allocate</span><span class="p">(</span><span class="n">pr_reg_nacl</span><span class="p">,</span> <span class="n">pr_res_mapped_lun</span><span class="p">,</span>
				<span class="mh">0x2A</span><span class="p">,</span> <span class="n">ASCQ_2AH_RESERVATIONS_PREEMPTED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: CLEAR complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Updated APTPL metadata&quot;</span>
				<span class="s">&quot; for CLEAR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">core_scsi3_pr_generation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called with struct se_device-&gt;dev_reservation_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__core_scsi3_complete_pro_preempt</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">preempt_and_abort_list</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">scope</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">abort</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prf_isid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do an implict RELEASE of the existing reservation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">)</span>
		<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: PREEMPT%s created new&quot;</span>
		<span class="s">&quot; reservation holder TYPE: %s ALL_TG_PT: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;_AND_ABORT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">type</span><span class="p">),</span>
		<span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] PREEMPT%s from Node: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;_AND_ABORT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * For PREEMPT_AND_ABORT, add the preempting reservation&#39;s</span>
<span class="cm">	 * struct t10_pr_registration to the list that will be compared</span>
<span class="cm">	 * against received CDBs..</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">preempt_and_abort_list</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_abort_list</span><span class="p">,</span>
				<span class="n">preempt_and_abort_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_scsi3_release_preempt_and_abort</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">preempt_and_abort_list</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg_holder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="n">preempt_and_abort_list</span><span class="p">,</span>
				<span class="n">pr_reg_abort_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_abort_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg_holder</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;pr_reg-&gt;pr_res_holder still set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_deve</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">t10_pr_reg_cache</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pro_preempt</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">scope</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">abort</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">preempt_and_abort_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_n</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">all_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">calling_it_nexus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">released_regs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prh_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prh_scope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_reg_n</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span>
				<span class="n">se_sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unable to locate&quot;</span>
			<span class="s">&quot; PR_REGISTERED *pr_reg for PREEMPT%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;_AND_ABORT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg_n</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">!=</span> <span class="n">res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_n</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scope</span> <span class="o">!=</span> <span class="n">PR_SCOPE_LU_SCOPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Illegal SCOPE: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_n</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_res_holder</span> <span class="o">&amp;&amp;</span>
	   <span class="p">((</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span><span class="p">)))</span>
		<span class="n">all_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all_reg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sa_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_n</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17, section 5.7.11.4.4 Removing Registrations:</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the SERVICE ACTION RESERVATION KEY field does not identify a</span>
<span class="cm">	 * persistent reservation holder or there is no persistent reservation</span>
<span class="cm">	 * holder (i.e., there is no persistent reservation), then the device</span>
<span class="cm">	 * server shall perform a preempt by doing the following in an</span>
<span class="cm">	 * uninterrupted series of actions. (See below..)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_res_holder</span> <span class="o">||</span> <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">!=</span> <span class="n">sa_res_key</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No existing or SA Reservation Key matching reservations..</span>
<span class="cm">		 *</span>
<span class="cm">		 * PROUT SA PREEMPT with All Registrant type reservations are</span>
<span class="cm">		 * allowed to be processed without a matching SA Reservation Key</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Removing of registrations in non all registrants</span>
<span class="cm">			 * type reservations without a matching SA reservation</span>
<span class="cm">			 * key.</span>
<span class="cm">			 *</span>
<span class="cm">			 * a) Remove the registrations for all I_T nexuses</span>
<span class="cm">			 *    specified by the SERVICE ACTION RESERVATION KEY</span>
<span class="cm">			 *    field;</span>
<span class="cm">			 * b) Ignore the contents of the SCOPE and TYPE fields;</span>
<span class="cm">			 * c) Process tasks as defined in 5.7.1; and</span>
<span class="cm">			 * d) Establish a unit attention condition for the</span>
<span class="cm">			 *    initiator port associated with every I_T nexus</span>
<span class="cm">			 *    that lost its registration other than the I_T</span>
<span class="cm">			 *    nexus on which the PERSISTENT RESERVE OUT command</span>
<span class="cm">			 *    was received, with the additional sense code set</span>
<span class="cm">			 *    to REGISTRATIONS PREEMPTED.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all_reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">!=</span> <span class="n">sa_res_key</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">calling_it_nexus</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg_n</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
				<span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">;</span>
				<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span>
					<span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">preempt_and_abort_list</span> <span class="o">:</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="n">calling_it_nexus</span><span class="p">);</span>
				<span class="n">released_regs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Case for any existing all registrants type</span>
<span class="cm">				 * reservation, follow logic in spc4r17 section</span>
<span class="cm">				 * 5.7.11.4 Preempting, Table 52 and Figure 7.</span>
<span class="cm">				 *</span>
<span class="cm">				 * For a ZERO SA Reservation key, release</span>
<span class="cm">				 * all other registrations and do an implict</span>
<span class="cm">				 * release of active persistent reservation.</span>
<span class="cm">				 *</span>
<span class="cm">				 * For a non-ZERO SA Reservation key, only</span>
<span class="cm">				 * release the matching reservation key from</span>
<span class="cm">				 * registrations.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sa_res_key</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				     <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">!=</span> <span class="n">sa_res_key</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">calling_it_nexus</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg_n</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">calling_it_nexus</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
				<span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">;</span>
				<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span>
					<span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">preempt_and_abort_list</span> <span class="o">:</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">released_regs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">calling_it_nexus</span><span class="p">)</span>
				<span class="n">core_scsi3_ua_allocate</span><span class="p">(</span><span class="n">pr_reg_nacl</span><span class="p">,</span>
					<span class="n">pr_res_mapped_lun</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span>
					<span class="n">ASCQ_2AH_REGISTRATIONS_PREEMPTED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If a PERSISTENT RESERVE OUT with a PREEMPT service action or</span>
<span class="cm">		 * a PREEMPT AND ABORT service action sets the SERVICE ACTION</span>
<span class="cm">		 * RESERVATION KEY field to a value that does not match any</span>
<span class="cm">		 * registered reservation key, then the device server shall</span>
<span class="cm">		 * complete the command with RESERVATION CONFLICT status.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">released_regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_n</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * For an existing all registrants type reservation</span>
<span class="cm">		 * with a zero SA rservation key, preempt the existing</span>
<span class="cm">		 * reservation with the new PR type and scope.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_res_holder</span> <span class="o">&amp;&amp;</span> <span class="n">all_reg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sa_res_key</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__core_scsi3_complete_pro_preempt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg_n</span><span class="p">,</span>
				<span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">preempt_and_abort_list</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">abort</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span>
				<span class="n">core_scsi3_release_preempt_and_abort</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">preempt_and_abort_list</span><span class="p">,</span> <span class="n">pr_reg_n</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pr_reg_n</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Updated APTPL&quot;</span>
					<span class="s">&quot; metadata for  PREEMPT%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;_AND_ABORT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_n</span><span class="p">);</span>
		<span class="n">core_scsi3_pr_generation</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The PREEMPTing SA reservation key matches that of the</span>
<span class="cm">	 * existing persistent reservation, first, we check if</span>
<span class="cm">	 * we are preempting our own reservation.</span>
<span class="cm">	 * From spc4r17, section 5.7.11.4.3 Preempting</span>
<span class="cm">	 * persistent reservations and registration handling</span>
<span class="cm">	 *</span>
<span class="cm">	 * If an all registrants persistent reservation is not</span>
<span class="cm">	 * present, it is not an error for the persistent</span>
<span class="cm">	 * reservation holder to preempt itself (i.e., a</span>
<span class="cm">	 * PERSISTENT RESERVE OUT with a PREEMPT service action</span>
<span class="cm">	 * or a PREEMPT AND ABORT service action with the</span>
<span class="cm">	 * SERVICE ACTION RESERVATION KEY value equal to the</span>
<span class="cm">	 * persistent reservation holder&#39;s reservation key that</span>
<span class="cm">	 * is received from the persistent reservation holder).</span>
<span class="cm">	 * In that case, the device server shall establish the</span>
<span class="cm">	 * new persistent reservation and maintain the</span>
<span class="cm">	 * registration.</span>
<span class="cm">	 */</span>
	<span class="n">prh_type</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">;</span>
	<span class="n">prh_scope</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the SERVICE ACTION RESERVATION KEY field identifies a</span>
<span class="cm">	 * persistent reservation holder (see 5.7.10), the device</span>
<span class="cm">	 * server shall perform a preempt by doing the following as</span>
<span class="cm">	 * an uninterrupted series of actions:</span>
<span class="cm">	 *</span>
<span class="cm">	 * a) Release the persistent reservation for the holder</span>
<span class="cm">	 *    identified by the SERVICE ACTION RESERVATION KEY field;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg_n</span> <span class="o">!=</span> <span class="n">pr_res_holder</span><span class="p">)</span>
		<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * b) Remove the registrations for all I_T nexuses identified</span>
<span class="cm">	 *    by the SERVICE ACTION RESERVATION KEY field, except the</span>
<span class="cm">	 *    I_T nexus that is being used for the PERSISTENT RESERVE</span>
<span class="cm">	 *    OUT command. If an all registrants persistent reservation</span>
<span class="cm">	 *    is present and the SERVICE ACTION RESERVATION KEY field</span>
<span class="cm">	 *    is set to zero, then all registrations shall be removed</span>
<span class="cm">	 *    except for that of the I_T nexus that is being used for</span>
<span class="cm">	 *    the PERSISTENT RESERVE OUT command;</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">calling_it_nexus</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg_n</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">calling_it_nexus</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">!=</span> <span class="n">sa_res_key</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
		<span class="n">pr_res_mapped_lun</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">;</span>
		<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span>
				<span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">preempt_and_abort_list</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">calling_it_nexus</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * e) Establish a unit attention condition for the initiator</span>
<span class="cm">		 *    port associated with every I_T nexus that lost its</span>
<span class="cm">		 *    persistent reservation and/or registration, with the</span>
<span class="cm">		 *    additional sense code set to REGISTRATIONS PREEMPTED;</span>
<span class="cm">		 */</span>
		<span class="n">core_scsi3_ua_allocate</span><span class="p">(</span><span class="n">pr_reg_nacl</span><span class="p">,</span> <span class="n">pr_res_mapped_lun</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span>
				<span class="n">ASCQ_2AH_REGISTRATIONS_PREEMPTED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * c) Establish a persistent reservation for the preempting</span>
<span class="cm">	 *    I_T nexus using the contents of the SCOPE and TYPE fields;</span>
<span class="cm">	 */</span>
	<span class="n">__core_scsi3_complete_pro_preempt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg_n</span><span class="p">,</span>
			<span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">preempt_and_abort_list</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">abort</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * d) Process tasks as defined in 5.7.1;</span>
<span class="cm">	 * e) See above..</span>
<span class="cm">	 * f) If the type or scope has changed, then for every I_T nexus</span>
<span class="cm">	 *    whose reservation key was not removed, except for the I_T</span>
<span class="cm">	 *    nexus on which the PERSISTENT RESERVE OUT command was</span>
<span class="cm">	 *    received, the device server shall establish a unit</span>
<span class="cm">	 *    attention condition for the initiator port associated with</span>
<span class="cm">	 *    that I_T nexus, with the additional sense code set to</span>
<span class="cm">	 *    RESERVATIONS RELEASED. If the type or scope have not</span>
<span class="cm">	 *    changed, then no unit attention condition(s) shall be</span>
<span class="cm">	 *    established for this reason.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">prh_type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">prh_scope</span> <span class="o">!=</span> <span class="n">scope</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">calling_it_nexus</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg_n</span> <span class="o">==</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">calling_it_nexus</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">core_scsi3_ua_allocate</span><span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">,</span>
					<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_mapped_lun</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span>
					<span class="n">ASCQ_2AH_RESERVATIONS_RELEASED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Call LUN_RESET logic upon list of struct t10_pr_registration,</span>
<span class="cm">	 * All received CDBs for the matching existing reservation and</span>
<span class="cm">	 * registrations undergo ABORT_TASK logic.</span>
<span class="cm">	 *</span>
<span class="cm">	 * From there, core_scsi3_release_preempt_and_abort() will</span>
<span class="cm">	 * release every registration in the list (which have already</span>
<span class="cm">	 * been removed from the primary pr_reg list), except the</span>
<span class="cm">	 * new persistent reservation holder, the calling Initiator Port.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core_tmr_lun_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">preempt_and_abort_list</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">core_scsi3_release_preempt_and_abort</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preempt_and_abort_list</span><span class="p">,</span>
						<span class="n">pr_reg_n</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pr_reg_n</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Updated APTPL metadata for PREEMPT&quot;</span>
				<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;_AND_ABORT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg_n</span><span class="p">);</span>
	<span class="n">core_scsi3_pr_generation</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_emulate_pro_preempt</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">scope</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">abort</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_REGONLY</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_REGONLY</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span>:
	<span class="k">case</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_pro_preempt</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span>
				<span class="n">res_key</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">,</span> <span class="n">abort</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unknown Service Action PREEMPT%s&quot;</span>
			<span class="s">&quot; Type: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;_AND_ABORT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_emulate_pro_register_and_move</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sa_res_key</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">aptpl</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">unreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">dest_se_deve</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">pr_res_nacl</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_nacl</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_node_acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">se_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_se_tpg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">dest_tf_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tf_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_res_holder</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_pr_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">initiator_str</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">iport_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dest_iport</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">i_buf</span><span class="p">[</span><span class="n">PR_REG_ISID_ID_LEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">tid_len</span><span class="p">,</span> <span class="n">tmp_tid_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">matching_iname</span><span class="p">,</span> <span class="n">prf_isid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rtpi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">proto_ident</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_sess</span> <span class="o">||</span> <span class="o">!</span><span class="n">se_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: se_sess || struct se_lun is NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dest_iport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">i_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="n">se_tpg</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="n">tf_ops</span> <span class="o">=</span> <span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Follow logic from spc4r17 Section 5.7.8, Table 50 --</span>
<span class="cm">	 *	Register behaviors for a REGISTER AND MOVE service action</span>
<span class="cm">	 *</span>
<span class="cm">	 * Locate the existing *pr_reg via struct se_node_acl pointers</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span>
				<span class="n">se_sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Unable to locate PR_REGISTERED&quot;</span>
			<span class="s">&quot; *pr_reg for REGISTER_AND_MOVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The provided reservation key much match the existing reservation key</span>
<span class="cm">	 * provided during this initiator&#39;s I_T nexus registration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_key</span> <span class="o">!=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Received&quot;</span>
			<span class="s">&quot; res_key: 0x%016Lx does not match existing SA REGISTER&quot;</span>
			<span class="s">&quot; res_key: 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_key</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The service active reservation key needs to be non zero</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sa_res_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Received zero&quot;</span>
			<span class="s">&quot; sa_res_key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine the Relative Target Port Identifier where the reservation</span>
<span class="cm">	 * will be moved to for the TransportID containing SCSI initiator WWN</span>
<span class="cm">	 * information.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">rtpi</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rtpi</span> <span class="o">|=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tid_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">tid_len</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">tid_len</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tid_len</span> <span class="o">|=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tid_len</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Illegal tid_len: %u + 24 byte header&quot;</span>
			<span class="s">&quot; does not equal CDB data_length: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid_len</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">se_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_sep_list</span><span class="p">,</span> <span class="n">sep_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">se_port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span> <span class="o">!=</span> <span class="n">rtpi</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dest_se_tpg</span> <span class="o">=</span> <span class="n">se_port</span><span class="o">-&gt;</span><span class="n">sep_tpg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_se_tpg</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dest_tf_ops</span> <span class="o">=</span> <span class="n">dest_se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_tf_ops</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_se_tpg</span><span class="o">-&gt;</span><span class="n">tpg_pr_ref_count</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_tpg_depend_item</span><span class="p">(</span><span class="n">dest_se_tpg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;core_scsi3_tpg_depend_item() failed&quot;</span>
				<span class="s">&quot; for dest_se_tpg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_se_tpg</span><span class="o">-&gt;</span><span class="n">tpg_pr_ref_count</span><span class="p">);</span>
			<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
			<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_se_tpg</span> <span class="o">||</span> <span class="o">!</span><span class="n">dest_tf_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Unable to locate&quot;</span>
			<span class="s">&quot; fabric ops from Relative Target Port Identifier:&quot;</span>
			<span class="s">&quot; %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtpi</span><span class="p">);</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">proto_ident</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Extracted Protocol Identifier:&quot;</span>
			<span class="s">&quot; 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proto_ident</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">proto_ident</span> <span class="o">!=</span> <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_proto_ident</span><span class="p">(</span><span class="n">dest_se_tpg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Received&quot;</span>
			<span class="s">&quot; proto_ident: 0x%02x does not match ident: 0x%02x&quot;</span>
			<span class="s">&quot; from fabric: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proto_ident</span><span class="p">,</span>
			<span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_proto_ident</span><span class="p">(</span><span class="n">dest_se_tpg</span><span class="p">),</span>
			<span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">tpg_parse_pr_out_transport_id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Fabric does not&quot;</span>
			<span class="s">&quot; containg a valid tpg_parse_pr_out_transport_id&quot;</span>
			<span class="s">&quot; function pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">initiator_str</span> <span class="o">=</span> <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">tpg_parse_pr_out_transport_id</span><span class="p">(</span><span class="n">dest_se_tpg</span><span class="p">,</span>
			<span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tmp_tid_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iport_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initiator_str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Unable to locate&quot;</span>
			<span class="s">&quot; initiator_str from Transport ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Extracted initiator %s identifier: %s&quot;</span>
		<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="p">(</span><span class="n">iport_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;port&quot;</span> <span class="o">:</span> <span class="s">&quot;device&quot;</span><span class="p">,</span> <span class="n">initiator_str</span><span class="p">,</span> <span class="p">(</span><span class="n">iport_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">iport_ptr</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If a PERSISTENT RESERVE OUT command with a REGISTER AND MOVE service</span>
<span class="cm">	 * action specifies a TransportID that is the same as the initiator port</span>
<span class="cm">	 * of the I_T nexus for the command received, then the command shall</span>
<span class="cm">	 * be terminated with CHECK CONDITION status, with the sense key set to</span>
<span class="cm">	 * ILLEGAL REQUEST, and the additional sense code set to INVALID FIELD</span>
<span class="cm">	 * IN PARAMETER LIST.</span>
<span class="cm">	 */</span>
	<span class="n">pr_reg_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="n">matching_iname</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">initiator_str</span><span class="p">,</span>
				  <span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">matching_iname</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">after_iport_check</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iport_ptr</span> <span class="o">||</span> <span class="o">!</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">isid_present_at_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: TransportID: %s&quot;</span>
			<span class="s">&quot; matches: %s on received I_T Nexus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">initiator_str</span><span class="p">,</span>
			<span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">iport_ptr</span><span class="p">,</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_isid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: TransportID: %s %s&quot;</span>
			<span class="s">&quot; matches: %s %s on received I_T Nexus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">initiator_str</span><span class="p">,</span> <span class="n">iport_ptr</span><span class="p">,</span> <span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
			<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_isid</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">after_iport_check:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Locate the destination struct se_node_acl from the received Transport ID</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_se_tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
	<span class="n">dest_node_acl</span> <span class="o">=</span> <span class="n">__core_tpg_get_initiator_node_acl</span><span class="p">(</span><span class="n">dest_se_tpg</span><span class="p">,</span>
				<span class="n">initiator_str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_node_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">acl_pr_ref_count</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_se_tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_node_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate %s dest_node_acl for&quot;</span>
			<span class="s">&quot; TransportID%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">initiator_str</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_nodeacl_depend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;core_scsi3_nodeacl_depend_item() for&quot;</span>
			<span class="s">&quot; dest_node_acl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">acl_pr_ref_count</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
		<span class="n">dest_node_acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Found %s dest_node_acl:&quot;</span>
		<span class="s">&quot; %s from TransportID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Locate the struct se_dev_entry pointer for the matching RELATIVE TARGET</span>
<span class="cm">	 * PORT IDENTIFIER.</span>
<span class="cm">	 */</span>
	<span class="n">dest_se_deve</span> <span class="o">=</span> <span class="n">core_get_se_deve_from_rtpi</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">,</span> <span class="n">rtpi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_se_deve</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate %s dest_se_deve from RTPI:&quot;</span>
			<span class="s">&quot; %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">rtpi</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_lunacl_depend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;core_scsi3_lunacl_depend_item() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_se_deve</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
		<span class="n">dest_se_deve</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Located %s node %s LUN&quot;</span>
		<span class="s">&quot; ACL for dest_se_deve-&gt;mapped_lun: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
		<span class="n">dest_se_deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * A persistent reservation needs to already existing in order to</span>
<span class="cm">	 * successfully complete the REGISTER_AND_MOVE service action..</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_res_holder</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: No reservation&quot;</span>
			<span class="s">&quot; currently held</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The received on I_T Nexus must be the reservation holder.</span>
<span class="cm">	 *</span>
<span class="cm">	 * From spc4r17 section 5.7.8  Table 50 --</span>
<span class="cm">	 * 	Register behaviors for a REGISTER AND MOVE service action</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_res_holder</span> <span class="o">!=</span> <span class="n">pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Calling I_T&quot;</span>
			<span class="s">&quot; Nexus is not reservation holder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 section 5.7.8: registering and moving reservation</span>
<span class="cm">	 *</span>
<span class="cm">	 * If a PERSISTENT RESERVE OUT command with a REGISTER AND MOVE service</span>
<span class="cm">	 * action is received and the established persistent reservation is a</span>
<span class="cm">	 * Write Exclusive - All Registrants type or Exclusive Access -</span>
<span class="cm">	 * All Registrants type reservation, then the command shall be completed</span>
<span class="cm">	 * with RESERVATION CONFLICT status.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-3 PR REGISTER_AND_MOVE: Unable to move&quot;</span>
			<span class="s">&quot; reservation for type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_res_nacl</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * b) Ignore the contents of the (received) SCOPE and TYPE fields;</span>
<span class="cm">	 */</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">;</span>
	<span class="n">scope</span> <span class="o">=</span> <span class="n">pr_res_holder</span><span class="o">-&gt;</span><span class="n">pr_res_type</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * c) Associate the reservation key specified in the SERVICE ACTION</span>
<span class="cm">	 *    RESERVATION KEY field with the I_T nexus specified as the</span>
<span class="cm">	 *    destination of the register and move, where:</span>
<span class="cm">	 *    A) The I_T nexus is specified by the TransportID and the</span>
<span class="cm">	 *	 RELATIVE TARGET PORT IDENTIFIER field (see 6.14.4); and</span>
<span class="cm">	 *    B) Regardless of the TransportID format used, the association for</span>
<span class="cm">	 *       the initiator port is based on either the initiator port name</span>
<span class="cm">	 *       (see 3.1.71) on SCSI transport protocols where port names are</span>
<span class="cm">	 *       required or the initiator port identifier (see 3.1.70) on SCSI</span>
<span class="cm">	 *       transport protocols where port names are not required;</span>
<span class="cm">	 * d) Register the reservation key specified in the SERVICE ACTION</span>
<span class="cm">	 *    RESERVATION KEY field;</span>
<span class="cm">	 * e) Retain the reservation key specified in the SERVICE ACTION</span>
<span class="cm">	 *    RESERVATION KEY field and associated information;</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also, It is not an error for a REGISTER AND MOVE service action to</span>
<span class="cm">	 * register an I_T nexus that is already registered with the same</span>
<span class="cm">	 * reservation key or a different reservation key.</span>
<span class="cm">	 */</span>
	<span class="n">dest_pr_reg</span> <span class="o">=</span> <span class="n">__core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dest_node_acl</span><span class="p">,</span>
					<span class="n">iport_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest_pr_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_alloc_registration</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="n">dest_node_acl</span><span class="p">,</span> <span class="n">dest_se_deve</span><span class="p">,</span> <span class="n">iport_ptr</span><span class="p">,</span>
				<span class="n">sa_res_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dest_pr_reg</span> <span class="o">=</span> <span class="n">__core_scsi3_locate_pr_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dest_node_acl</span><span class="p">,</span>
						<span class="n">iport_ptr</span><span class="p">);</span>
		<span class="n">new_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * f) Release the persistent reservation for the persistent reservation</span>
<span class="cm">	 *    holder (i.e., the I_T nexus on which the</span>
<span class="cm">	 */</span>
	<span class="n">__core_scsi3_complete_pro_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_res_nacl</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * g) Move the persistent reservation to the specified I_T nexus using</span>
<span class="cm">	 *    the same scope and type as the persistent reservation released in</span>
<span class="cm">	 *    item f); and</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span> <span class="o">=</span> <span class="n">dest_pr_reg</span><span class="p">;</span>
	<span class="n">dest_pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dest_pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">;</span>
	<span class="n">prf_isid</span> <span class="o">=</span> <span class="n">core_pr_dump_initiator_port</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">PR_REG_ISID_ID_LEN</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Increment PRGeneration for existing registrations..</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_reg</span><span class="p">)</span>
		<span class="n">dest_pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span> <span class="o">=</span> <span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_generation</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR [%s] Service Action: REGISTER_AND_MOVE&quot;</span>
		<span class="s">&quot; created new reservation holder TYPE: %s on object RTPI:&quot;</span>
		<span class="s">&quot; %hu  PRGeneration: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">core_scsi3_pr_dump_type</span><span class="p">(</span><span class="n">type</span><span class="p">),</span> <span class="n">rtpi</span><span class="p">,</span>
		<span class="n">dest_pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_generation</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR Successfully moved reservation from&quot;</span>
		<span class="s">&quot; %s Fabric Node: %s%s -&gt; %s Fabric Node: %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span>
		<span class="p">(</span><span class="n">prf_isid</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">i_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">dest_tf_ops</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">dest_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="p">(</span><span class="n">iport_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">iport_ptr</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is now safe to release configfs group dependencies for destination</span>
<span class="cm">	 * of Transport ID Initiator Device/Port Identifier</span>
<span class="cm">	 */</span>
	<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
	<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
	<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_se_tpg</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * h) If the UNREG bit is set to one, unregister (see 5.7.11.3) the I_T</span>
<span class="cm">	 * nexus on which PERSISTENT RESERVE OUT command was received.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unreg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="n">__core_scsi3_free_registration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the APTPL metadata if APTPL has been disabled, otherwise</span>
<span class="cm">	 * write out the updated metadata to struct file for this SCSI device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aptpl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Deactivated for&quot;</span>
				<span class="s">&quot; REGISTER_AND_MOVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_update_and_write_aptpl</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dest_pr_reg</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SPC-3 PR: Set APTPL Bit Activated for&quot;</span>
					<span class="s">&quot; REGISTER_AND_MOVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">dest_pr_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_se_deve</span><span class="p">)</span>
		<span class="n">core_scsi3_lunacl_undepend_item</span><span class="p">(</span><span class="n">dest_se_deve</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_node_acl</span><span class="p">)</span>
		<span class="n">core_scsi3_nodeacl_undepend_item</span><span class="p">(</span><span class="n">dest_node_acl</span><span class="p">);</span>
	<span class="n">core_scsi3_tpg_undepend_item</span><span class="p">(</span><span class="n">dest_se_tpg</span><span class="p">);</span>
	<span class="n">core_scsi3_put_pr_reg</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">core_scsi3_extract_reservation_key</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__v1</span><span class="p">,</span> <span class="n">__v2</span><span class="p">;</span>

	<span class="n">__v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">__v2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">__v1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * See spc4r17 section 6.14 Table 170</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">target_scsi3_emulate_pr_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">res_key</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sa</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spec_i_pt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">all_tg_pt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Following spc2r20 5.5.1 Reservations overview:</span>
<span class="cm">	 *</span>
<span class="cm">	 * If a logical unit has been reserved by any RESERVE command and is</span>
<span class="cm">	 * still reserved by any initiator, all PERSISTENT RESERVE IN and all</span>
<span class="cm">	 * PERSISTENT RESERVE OUT commands shall conflict regardless of</span>
<span class="cm">	 * initiator or service action and shall terminate with a RESERVATION</span>
<span class="cm">	 * CONFLICT status.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DF_SPC2_RESERVATIONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Received PERSISTENT_RESERVE CDB while legacy&quot;</span>
			<span class="s">&quot; SPC-2 reservation is held, returning&quot;</span>
			<span class="s">&quot; RESERVATION_CONFLICT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: A NULL struct se_session pointer means an this is not coming from</span>
<span class="cm">	 * a $FABRIC_MOD&#39;s nexus, but from internal passthrough ops.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-PR: Received PR OUT parameter list&quot;</span>
			<span class="s">&quot; length too small: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From the PERSISTENT_RESERVE_OUT command descriptor block (CDB)</span>
<span class="cm">	 */</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">scope</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * From PERSISTENT_RESERVE_OUT parameter list (payload)</span>
<span class="cm">	 */</span>
	<span class="n">res_key</span> <span class="o">=</span> <span class="n">core_scsi3_extract_reservation_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">sa_res_key</span> <span class="o">=</span> <span class="n">core_scsi3_extract_reservation_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="cm">/*</span>
<span class="cm">	 * REGISTER_AND_MOVE uses a different SA parameter list containing</span>
<span class="cm">	 * SCSI TransportIDs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span> <span class="o">!=</span> <span class="n">PRO_REGISTER_AND_MOVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec_i_pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">all_tg_pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">aptpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aptpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">unreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SPEC_I_PT=1 is only valid for Service action: REGISTER</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec_i_pt</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PRO_REGISTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * From spc4r17 section 6.14:</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the SPEC_I_PT bit is set to zero, the service action is not</span>
<span class="cm">	 * REGISTER AND MOVE, and the parameter list length is not 24, then</span>
<span class="cm">	 * the command shall be terminated with CHECK CONDITION status, with</span>
<span class="cm">	 * the sense key set to ILLEGAL REQUEST, and the additional sense</span>
<span class="cm">	 * code set to PARAMETER LIST LENGTH ERROR.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec_i_pt</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PRO_REGISTER_AND_MOVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-PR: Received PR OUT illegal parameter&quot;</span>
			<span class="s">&quot; list length: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_PARAMETER_LIST</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * (core_scsi3_emulate_pro_* function parameters</span>
<span class="cm">	 * are defined by spc4r17 Table 174:</span>
<span class="cm">	 * PERSISTENT_RESERVE_OUT service actions and valid parameters.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sa</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRO_REGISTER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_register</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
			<span class="n">res_key</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">spec_i_pt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRO_RESERVE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_reserve</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">res_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRO_RELEASE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_release</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">res_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRO_CLEAR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_clear</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">res_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRO_PREEMPT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_preempt</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span>
					<span class="n">res_key</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRO_PREEMPT_AND_ABORT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_preempt</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span>
					<span class="n">res_key</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRO_REGISTER_AND_IGNORE_EXISTING_KEY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_register</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">sa_res_key</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">,</span> <span class="n">all_tg_pt</span><span class="p">,</span> <span class="n">spec_i_pt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRO_REGISTER_AND_MOVE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_emulate_pro_register_and_move</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">res_key</span><span class="p">,</span>
				<span class="n">sa_res_key</span><span class="p">,</span> <span class="n">aptpl</span><span class="p">,</span> <span class="n">unreg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown PERSISTENT_RESERVE_OUT service&quot;</span>
			<span class="s">&quot; action: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">target_complete_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">GOOD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PERSISTENT_RESERVE_IN Service Action READ_KEYS</span>
<span class="cm"> *</span>
<span class="cm"> * See spc4r17 section 5.7.6.2 and section 6.13.2, Table 160</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pri_read_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">add_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PRIN SA READ_KEYS SCSI Data Length: %u&quot;</span>
			<span class="s">&quot; too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_list</span><span class="p">,</span>
			<span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check for overflow of 8byte PRI READ_KEYS payload and</span>
<span class="cm">		 * next reservation key list descriptor.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">-</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="n">add_len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">add_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PERSISTENT_RESERVE_IN Service Action READ_RESERVATION</span>
<span class="cm"> *</span>
<span class="cm"> * See spc4r17 section 5.7.6.3 and section 6.13.3.2 Table 161 and 162</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pri_read_reservation</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pr_res_key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">add_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* Hardcoded to 16 when a reservation is held. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PRIN SA READ_RESERVATIONS SCSI Data Length: %u&quot;</span>
			<span class="s">&quot; too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">pr_reg</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_pr_res_holder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pr_reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the hardcoded Additional Length</span>
<span class="cm">		 */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">add_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set the Reservation key.</span>
<span class="cm">		 *</span>
<span class="cm">		 * From spc4r17, section 5.7.10:</span>
<span class="cm">		 * A persistent reservation holder has its reservation key</span>
<span class="cm">		 * returned in the parameter data from a PERSISTENT</span>
<span class="cm">		 * RESERVE IN command with READ RESERVATION service action as</span>
<span class="cm">		 * follows:</span>
<span class="cm">		 * a) For a persistent reservation of the type Write Exclusive</span>
<span class="cm">		 *    - All Registrants or Exclusive Access ­ All Regitrants,</span>
<span class="cm">		 *      the reservation key shall be set to zero; or</span>
<span class="cm">		 * b) For all other persistent reservation types, the</span>
<span class="cm">		 *    reservation key shall be set to the registered</span>
<span class="cm">		 *    reservation key for the I_T nexus that holds the</span>
<span class="cm">		 *    persistent reservation.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_WRITE_EXCLUSIVE_ALLREG</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">==</span> <span class="n">PR_TYPE_EXCLUSIVE_ACCESS_ALLREG</span><span class="p">))</span>
			<span class="n">pr_res_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pr_res_key</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_res_key</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the SCOPE and TYPE</span>
<span class="cm">		 */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_reservation_lock</span><span class="p">);</span>
	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PERSISTENT_RESERVE_IN Service Action REPORT_CAPABILITIES</span>
<span class="cm"> *</span>
<span class="cm"> * See spc4r17 section 6.13.4 Table 165</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pri_report_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">add_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* Hardcoded to 8. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PRIN SA REPORT_CAPABILITIES SCSI Data Length:&quot;</span>
			<span class="s">&quot; %u too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">add_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* CRH: Compatible Reservation Hanlding bit. */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* SIP_C: Specify Initiator Ports Capable bit */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* ATP_C: All Target Ports Capable bit */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* PTPL_C: Persistence across Target Power Loss bit */</span>
	<span class="cm">/*</span>
<span class="cm">	 * We are filling in the PERSISTENT RESERVATION TYPE MASK below, so</span>
<span class="cm">	 * set the TMV: Task Mask Valid bit.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Change ALLOW COMMANDs to 0x20 or 0x40 later from Table 166</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* ALLOW COMMANDs field 001b */</span>
	<span class="cm">/*</span>
<span class="cm">	 * PTPL_A: Persistence across Target Power Loss Active bit</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">pr_aptpl_active</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Setup the PERSISTENT RESERVATION TYPE MASK from Table 167</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* PR_TYPE_EXCLUSIVE_ACCESS_ALLREG */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* PR_TYPE_EXCLUSIVE_ACCESS_REGONLY */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* PR_TYPE_WRITE_EXCLUSIVE_REGONLY */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* PR_TYPE_EXCLUSIVE_ACCESS */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* PR_TYPE_WRITE_EXCLUSIVE */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* PR_TYPE_EXCLUSIVE_ACCESS_ALLREG */</span>

	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PERSISTENT_RESERVE_IN Service Action READ_FULL_STATUS</span>
<span class="cm"> *</span>
<span class="cm"> * See spc4r17 section 6.13.5 Table 168 and 169</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_scsi3_pri_read_full_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pr_reg_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">pr_tmpl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">add_desc_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">add_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">desc_len</span><span class="p">,</span> <span class="n">exp_desc_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* off into first Full Status descriptor */</span>
	<span class="kt">int</span> <span class="n">format_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PRIN SA READ_FULL_STATUS SCSI Data Length: %u&quot;</span>
			<span class="s">&quot; too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_generation</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pr_reg</span><span class="p">,</span> <span class="n">pr_reg_tmp</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_list</span><span class="p">,</span> <span class="n">pr_reg_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">se_nacl</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="p">;</span>
		<span class="n">se_tpg</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
		<span class="n">add_desc_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Determine expected length of $FABRIC_MOD specific</span>
<span class="cm">		 * TransportID full status descriptor..</span>
<span class="cm">		 */</span>
		<span class="n">exp_desc_len</span> <span class="o">=</span> <span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_pr_transport_id_len</span><span class="p">(</span>
				<span class="n">se_tpg</span><span class="p">,</span> <span class="n">se_nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_code</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">exp_desc_len</span> <span class="o">+</span> <span class="n">add_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SPC-3 PRIN READ_FULL_STATUS ran&quot;</span>
				<span class="s">&quot; out of buffer: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">);</span>
			<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set RESERVATION KEY</span>
<span class="cm">		 */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Skip Over Reserved area */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set ALL_TG_PT bit if PROUT SA REGISTER had this set.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The struct se_lun pointer will be present for the</span>
<span class="cm">		 * reservation holder for PR_HOLDER bit.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Also, if this registration is the reservation</span>
<span class="cm">		 * holder, fill in SCOPE and TYPE in the next byte.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holder</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_scope</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_type</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">off</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Skip over reserved area */</span>
		<span class="cm">/*</span>
<span class="cm">		 * From spc4r17 6.3.15:</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the ALL_TG_PT bit set to zero, the RELATIVE TARGET PORT</span>
<span class="cm">		 * IDENTIFIER field contains the relative port identifier (see</span>
<span class="cm">		 * 3.1.120) of the target port that is part of the I_T nexus</span>
<span class="cm">		 * described by this full status descriptor. If the ALL_TG_PT</span>
<span class="cm">		 * bit is set to one, the contents of the RELATIVE TARGET PORT</span>
<span class="cm">		 * IDENTIFIER field are not defined by this standard.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_all_tg_pt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_reg_tg_pt_lun</span><span class="o">-&gt;</span><span class="n">lun_sep</span><span class="p">;</span>

			<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Skip over RELATIVE TARGET PORT IDENTIFER */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now, have the $FABRIC_MOD fill in the protocol identifier</span>
<span class="cm">		 */</span>
		<span class="n">desc_len</span> <span class="o">=</span> <span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_pr_transport_id</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="n">se_nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">+</span><span class="mi">4</span><span class="p">]);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_reg</span><span class="o">-&gt;</span><span class="n">pr_res_holders</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the ADDITIONAL DESCRIPTOR LENGTH</span>
<span class="cm">		 */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">desc_len</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">desc_len</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">desc_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Size of full desctipor header minus TransportID</span>
<span class="cm">		 * containing $FABRIC_MOD specific) initiator device/port</span>
<span class="cm">		 * WWN information.</span>
<span class="cm">		 *</span>
<span class="cm">		 *  See spc4r17 Section 6.13.5 Table 169</span>
<span class="cm">		 */</span>
		<span class="n">add_desc_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span> <span class="o">+</span> <span class="n">desc_len</span><span class="p">);</span>

		<span class="n">off</span> <span class="o">+=</span> <span class="n">desc_len</span><span class="p">;</span>
		<span class="n">add_len</span> <span class="o">+=</span> <span class="n">add_desc_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr_tmpl</span><span class="o">-&gt;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set ADDITIONAL_LENGTH</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">add_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">add_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">target_scsi3_emulate_pr_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Following spc2r20 5.5.1 Reservations overview:</span>
<span class="cm">	 *</span>
<span class="cm">	 * If a logical unit has been reserved by any RESERVE command and is</span>
<span class="cm">	 * still reserved by any initiator, all PERSISTENT RESERVE IN and all</span>
<span class="cm">	 * PERSISTENT RESERVE OUT commands shall conflict regardless of</span>
<span class="cm">	 * initiator or service action and shall terminate with a RESERVATION</span>
<span class="cm">	 * CONFLICT status.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DF_SPC2_RESERVATIONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Received PERSISTENT_RESERVE CDB while legacy&quot;</span>
			<span class="s">&quot; SPC-2 reservation is held, returning&quot;</span>
			<span class="s">&quot; RESERVATION_CONFLICT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_RESERVATION_CONFLICT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRI_READ_KEYS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_pri_read_keys</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRI_READ_RESERVATION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_pri_read_reservation</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRI_REPORT_CAPABILITIES</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_pri_report_capabilities</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRI_READ_FULL_STATUS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">core_scsi3_pri_read_full_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown PERSISTENT_RESERVE_IN service&quot;</span>
			<span class="s">&quot; action: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_INVALID_CDB_FIELD</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">target_complete_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">GOOD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_pt_reservation_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pr_res_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_pt_seq_non_holder</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">pr_reg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">core_setup_reservations</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_reservation</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If this device is from Target_Core_Mod/pSCSI, use the reservations</span>
<span class="cm">	 * of the Underlying SCSI hardware.  In Linux/SCSI terms, this can</span>
<span class="cm">	 * cause a problem because libata and some SATA RAID HBAs appear</span>
<span class="cm">	 * under Linux/SCSI, but to emulate reservations themselves.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">transport_type</span> <span class="o">==</span> <span class="n">TRANSPORT_PLUGIN_PHBA_PDEV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_reservations</span><span class="p">))</span> <span class="o">||</span> <span class="n">force_pt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">SPC_PASSTHROUGH</span><span class="p">;</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">pr_ops</span><span class="p">.</span><span class="n">t10_reservation_check</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core_pt_reservation_check</span><span class="p">;</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">pr_ops</span><span class="p">.</span><span class="n">t10_seq_non_holder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core_pt_seq_non_holder</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Using SPC_PASSTHROUGH, no reservation&quot;</span>
			<span class="s">&quot; emulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If SPC-3 or above is reported by real or emulated struct se_device,</span>
<span class="cm">	 * use emulated Persistent Reservations.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">get_device_rev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SCSI_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">SPC3_PERSISTENT_RESERVATIONS</span><span class="p">;</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">pr_ops</span><span class="p">.</span><span class="n">t10_reservation_check</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core_scsi3_pr_reservation_check</span><span class="p">;</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">pr_ops</span><span class="p">.</span><span class="n">t10_seq_non_holder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core_scsi3_pr_seq_non_holder</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Using SPC3_PERSISTENT_RESERVATIONS&quot;</span>
			<span class="s">&quot; emulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">SPC2_RESERVATIONS</span><span class="p">;</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">pr_ops</span><span class="p">.</span><span class="n">t10_reservation_check</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core_scsi2_reservation_check</span><span class="p">;</span>
		<span class="n">rest</span><span class="o">-&gt;</span><span class="n">pr_ops</span><span class="p">.</span><span class="n">t10_seq_non_holder</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">core_scsi2_reservation_seq_non_holder</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Using SPC2_RESERVATIONS emulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
